name: CI

on:
  push:
  pull_request:

permissions:
  contents: read

jobs:
  lint:
    name: Python lint (ruff)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install ruff
        run: |
          python -m pip install --upgrade pip
          pip install ruff

      - name: Ruff version
        run: ruff --version

      - name: Ruff check
        run: ruff check .

  test:
    name: Python tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          pip install pytest

      - name: Show tree (debug)
        run: |
          ls -la
          ls -la store/ai_shared || true
          ls -la tests || true

      - name: Run tests
        run: |
          pytest -q || (echo "::error::pytest failed" && exit 1)

  sanity:
    name: Repo sanity checks
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Required files exist
        run: |
          test -f .env.example
          test -f docs/AI_PROJECT_HUB_COLLAB.md
          echo "OK"

  pwsh:
    name: PowerShell scripts (lint/sanity)
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install PSScriptAnalyzer
        shell: pwsh
        run: |
          Set-PSRepository PSGallery -InstallationPolicy Trusted
          Install-Module PSScriptAnalyzer -Force -Scope CurrentUser

      - name: Analyze scripts folder
        shell: pwsh
        run: |
          if (Test-Path "scripts") {
            Write-Host "Analyzing PowerShell scripts in 'scripts'..."
            $results = Invoke-ScriptAnalyzer -Path scripts -Recurse -Severity Error,Warning
            if ($results) {
              $results | Format-Table
              # Fail only on Errors; allow Warnings to pass for now
              if ($results | Where-Object { $_.Severity -eq 'Error' }) {
                throw "PSScriptAnalyzer found errors."
              }
            } else {
              Write-Host "No issues found by PSScriptAnalyzer."
            }
          } else {
            Write-Host "No 'scripts' directory present; skipping PowerShell analysis."
          }

      - name: Parse-check with tokenizer (extra safety)
        shell: pwsh
        run: |
          if (Test-Path "scripts") {
            $errors = 0
            Get-ChildItem scripts -Recurse -Filter *.ps1 | ForEach-Object {
              Write-Host "Parsing $($_.FullName)"
              try {
                $null = [System.Management.Automation.PSParser]::Tokenize([IO.File]::ReadAllText($_.FullName), [ref]([System.Collections.ArrayList]@()))
              } catch {
                Write-Error "Parser error in $($_.FullName): $($_.Exception.Message)"
                $errors++
              }
            }
            if ($errors -gt 0) { throw "$errors PowerShell parse errors." }
          }
