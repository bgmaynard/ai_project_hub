<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IBKR Professional Trading Platform</title>
    <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #0a0a0a;
            color: #e0e0e0;
            font-size: 15px;
            overflow: hidden;
        }

        /* Top Bar */
        .top-bar {
            background: #1e1e1e;
            border-bottom: 2px solid #007acc;
            padding: 8px 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 40px;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 10000;
        }

        .top-bar-left h1 {
            font-size: 18px;
            font-weight: 600;
            color: #007acc;
            letter-spacing: 1px;
        }

        .top-bar-right {
            display: flex;
            gap: 15px;
            align-items: center;
            font-size: 14px;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            background: #252525;
            border: 1px solid #404040;
            border-radius: 3px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #ef4444;
            animation: pulse 2s infinite;
        }

        .status-dot.connected {
            background: #22c55e;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Configuration Dialog Styles */
        .config-dialog-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 99999;
        }

        .config-dialog-overlay.show {
            display: flex;
        }

        .config-dialog {
            background: #1a1a1a;
            border: 2px solid #007acc;
            border-radius: 4px;
            padding: 20px;
            min-width: 400px;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.9);
        }

        .config-dialog-header {
            font-size: 18px;
            font-weight: 700;
            color: #007acc;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #333;
        }

        .config-dialog-body {
            margin-bottom: 20px;
        }

        .config-dialog-footer {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .config-input {
            width: 100%;
            padding: 10px;
            background: #252525;
            border: 1px solid #404040;
            color: #fff;
            font-size: 14px;
            border-radius: 3px;
            margin-bottom: 10px;
        }

        .config-input:focus {
            outline: none;
            border-color: #007acc;
        }

        .config-list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: #252525;
            border: 1px solid #333;
            border-radius: 3px;
            margin-bottom: 8px;
        }

        .config-list-item:hover {
            background: #2d2d2d;
        }

        .config-list-item-name {
            font-weight: 600;
            color: #fff;
            flex: 1;
        }

        .config-list-item-date {
            font-size: 11px;
            color: #888;
            margin-right: 10px;
        }

        .config-list-item-actions {
            display: flex;
            gap: 5px;
        }

        .config-btn-small {
            padding: 4px 8px;
            font-size: 12px;
            border: none;
            border-radius: 2px;
            cursor: pointer;
            font-weight: 600;
        }

        .config-btn-load {
            background: #22c55e;
            color: #000;
        }

        .config-btn-rename {
            background: #60a5fa;
            color: #000;
        }

        .config-btn-delete {
            background: #ef4444;
            color: #fff;
        }

        .config-btn-small:hover {
            opacity: 0.8;
        }

        /* Menu Bar */
        .menu-bar {
            background: #252525;
            border-bottom: 1px solid #404040;
            padding: 0 12px;
            display: flex;
            gap: 0;
            height: 28px;
            position: fixed;
            top: 40px;
            left: 0;
            right: 0;
            z-index: 9999;
        }

        .menu-item {
            padding: 6px 12px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            color: #b0b0b0;
            border-right: 1px solid #404040;
            transition: all 0.2s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            position: relative;
        }

        .menu-item:hover {
            background: #007acc;
            color: #ffffff;
        }

        /* Dropdown Menu */
        .dropdown {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            background: #2d2d2d;
            border: 1px solid #404040;
            min-width: 220px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
            z-index: 10000;
        }

        .dropdown.show {
            display: block;
        }

        .dropdown a {
            display: block;
            padding: 10px 15px;
            color: #e0e0e0;
            text-decoration: none;
            font-size: 14px;
            border-bottom: 1px solid #404040;
            transition: background 0.2s;
            text-transform: none;
            letter-spacing: normal;
        }

        .dropdown a:hover {
            background: #007acc;
            color: #ffffff;
        }

        .dropdown strong {
            display: block;
            padding: 8px 15px;
            color: #007acc;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .dropdown hr {
            border: none;
            border-top: 1px solid #404040;
            margin: 0;
        }

        /* Workspace */
        .workspace {
            position: fixed;
            top: 68px;
            left: 0;
            right: 0;
            bottom: 0;
            background: #0a0a0a;
            overflow: hidden;
        }

        /* Draggable Window */
        .window {
            position: absolute;
            background: #1a1a1a;
            border: 1px solid #333;
            display: flex;
            flex-direction: column;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.7);
            min-width: 200px;
            min-height: 150px;
        }

        .window.active {
            border-color: #007acc;
            box-shadow: 0 8px 32px rgba(0, 122, 204, 0.4);
        }

        .window-header {
            background: #2d2d2d;
            padding: 6px 10px;
            border-bottom: 1px solid #404040;
            font-size: 14px;
            font-weight: 700;
            color: #ffffff;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: move;
            user-select: none;
        }

        .window.active .window-header {
            background: #007acc;
        }

        .window-controls {
            display: flex;
            gap: 6px;
        }

        .window-btn {
            width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 16px;
            border-radius: 2px;
            transition: background 0.2s;
            font-weight: bold;
        }

        .window-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .window-btn.minimize { color: #fbbf24; }
        .window-btn.maximize { color: #22c55e; }
        .window-btn.close { color: #ef4444; }

        .window-content {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            background: #1a1a1a;
        }

        /* Resize Handles */
        .resize-handle {
            position: absolute;
            background: transparent;
            z-index: 10;
        }

        .resize-handle.n { top: 0; left: 0; right: 0; height: 5px; cursor: ns-resize; }
        .resize-handle.s { bottom: 0; left: 0; right: 0; height: 5px; cursor: ns-resize; }
        .resize-handle.e { top: 0; right: 0; bottom: 0; width: 5px; cursor: ew-resize; }
        .resize-handle.w { top: 0; left: 0; bottom: 0; width: 5px; cursor: ew-resize; }
        .resize-handle.ne { top: 0; right: 0; width: 10px; height: 10px; cursor: nesw-resize; }
        .resize-handle.nw { top: 0; left: 0; width: 10px; height: 10px; cursor: nwse-resize; }
        .resize-handle.se { bottom: 0; right: 0; width: 10px; height: 10px; cursor: nwse-resize; }
        .resize-handle.sw { bottom: 0; left: 0; width: 10px; height: 10px; cursor: nesw-resize; }

        /* Layout Controls */
        .layout-controls {
            position: fixed;
            bottom: 10px;
            right: 10px;
            display: flex;
            gap: 6px;
            z-index: 9998;
        }

        .layout-btn {
            padding: 8px 12px;
            background: #2d2d2d;
            border: 1px solid #007acc;
            color: #ffffff;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            border-radius: 3px;
            transition: all 0.2s;
            text-transform: uppercase;
        }

        .layout-btn:hover {
            background: #007acc;
        }

        /* Data Table Styles */
        .data-table {
            width: 100%;
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }

        .data-table thead {
            background: #2d2d2d;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .data-table th {
            padding: 6px 8px;
            text-align: left;
            font-weight: 700;
            color: #888;
            border-bottom: 1px solid #404040;
            text-transform: uppercase;
            font-size: 13px;
            letter-spacing: 0.5px;
        }

        .data-table td {
            padding: 5px 8px;
            border-bottom: 1px solid #252525;
        }

        .data-table tr:hover {
            background: #252525;
        }

        .data-table .clickable {
            cursor: pointer;
        }

        .data-table .clickable:hover {
            background: #007acc;
        }

        /* Module Specific Styles */
        .module-content {
            padding: 8px;
        }

        /* Quote Display */
        .quote-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 6px;
            padding: 8px;
            background: #1e1e1e;
        }

        .quote-stat {
            padding: 6px 8px;
            background: #252525;
            border: 1px solid #333;
            border-radius: 2px;
        }

        .quote-stat-label {
            font-size: 13px;
            color: #888;
            text-transform: uppercase;
            margin-bottom: 3px;
        }

        .quote-stat-value {
            font-size: 17px;
            font-weight: 700;
            font-family: 'Courier New', monospace;
        }

        .positive { color: #22c55e !important; }
        .negative { color: #ef4444 !important; }
        .neutral { color: #888 !important; }

        /* Level 2 */
        .level2-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1px;
            background: #404040;
            font-family: 'Courier New', monospace;
            height: 100%;
        }

        .level2-column {
            background: #1a1a1a;
            overflow-y: auto;
        }

        .level2-header {
            display: grid;
            grid-template-columns: 50px 70px 70px 50px;
            padding: 6px 4px;
            font-size: 13px;
            font-weight: 700;
            background: #2d2d2d;
            border-bottom: 1px solid #404040;
            position: sticky;
            top: 0;
            z-index: 5;
        }

        .level2-header div {
            text-align: center;
            color: #888;
        }

        .level2-row {
            display: grid;
            grid-template-columns: 50px 70px 70px 50px;
            padding: 3px 4px;
            font-size: 14px;
            border-bottom: 1px solid #222;
            position: relative;
        }

        .level2-row:hover {
            background: #252525;
        }

        .level2-row div {
            text-align: center;
            padding: 2px;
        }

        .level2-row.clickable {
            cursor: pointer;
        }

        .level2-price {
            font-weight: 700;
        }

        /* Order Entry */
        .order-entry-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-bottom: 8px;
        }

        .order-field {
            margin-bottom: 10px;
        }

        .order-field label {
            display: block;
            font-size: 13px;
            color: #888;
            margin-bottom: 4px;
            text-transform: uppercase;
            font-weight: 600;
        }

        .order-field input,
        .order-field select {
            width: 100%;
            padding: 6px 8px;
            background: #252525;
            border: 1px solid #404040;
            color: #fff;
            font-size: 15px;
            border-radius: 2px;
            font-family: 'Courier New', monospace;
        }

        .order-field input:focus,
        .order-field select:focus {
            outline: none;
            border-color: #007acc;
        }

        .quantity-buttons {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 4px;
            margin-bottom: 8px;
        }

        .qty-btn {
            padding: 6px;
            background: #252525;
            border: 1px solid #404040;
            color: #888;
            font-size: 14px;
            cursor: pointer;
            border-radius: 2px;
            transition: all 0.2s;
            font-weight: 600;
        }

        .qty-btn:hover {
            background: #404040;
            color: #fff;
        }

        .price-controls {
            display: grid;
            grid-template-columns: 40px 1fr 40px;
            gap: 4px;
            margin-bottom: 8px;
        }

        .price-btn {
            padding: 6px;
            background: #252525;
            border: 1px solid #404040;
            color: #007acc;
            font-size: 20px;
            font-weight: bold;
            cursor: pointer;
            border-radius: 2px;
        }

        .price-btn:hover {
            background: #007acc;
            color: #fff;
        }

        .order-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-top: 12px;
        }

        .btn {
            padding: 10px;
            border: none;
            cursor: pointer;
            font-size: 15px;
            font-weight: 700;
            border-radius: 3px;
            transition: all 0.2s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-buy {
            background: #22c55e;
            color: #000;
        }

        .btn-buy:hover {
            background: #16a34a;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(34, 197, 94, 0.3);
        }

        .btn-sell {
            background: #ef4444;
            color: #fff;
        }

        .btn-sell:hover {
            background: #dc2626;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(239, 68, 68, 0.3);
        }

        .btn-secondary {
            background: #404040;
            color: #fff;
        }

        .btn-secondary:hover {
            background: #525252;
        }

        .btn-danger {
            background: #991b1b;
            color: #fff;
        }

        .btn-danger:hover {
            background: #7f1d1d;
        }

        /* Watchlist */
        .watchlist-item {
            display: grid;
            grid-template-columns: 60px 1fr 60px;
            padding: 6px 8px;
            border-bottom: 1px solid #252525;
            cursor: pointer;
            transition: background 0.2s;
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }

        .watchlist-item:hover {
            background: #252525;
        }

        .watchlist-item.active {
            background: #007acc;
        }

        .watchlist-symbol {
            font-weight: 700;
            font-size: 15px;
        }

        .watchlist-price {
            text-align: right;
        }

        .watchlist-change {
            text-align: right;
            font-size: 13px;
        }

        /* Account */
        .account-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 6px;
            padding: 8px;
        }

        .account-stat {
            padding: 6px 8px;
            background: #252525;
            border: 1px solid #333;
            border-radius: 2px;
        }

        .account-stat-label {
            font-size: 13px;
            color: #888;
            margin-bottom: 3px;
            text-transform: uppercase;
        }

        .account-stat-value {
            font-size: 16px;
            font-weight: 700;
            font-family: 'Courier New', monospace;
        }

        /* Time & Sales */
        .timesales-row {
            display: grid;
            grid-template-columns: 70px 80px 60px 40px;
            padding: 4px 8px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            border-bottom: 1px solid #222;
        }

        .timesales-row:hover {
            background: #252525;
        }

        .timesales-time { color: #666; }
        .timesales-price { text-align: right; font-weight: 700; }
        .timesales-size { text-align: right; color: #888; }
        .timesales-side { text-align: center; font-size: 13px; }

        .empty-state {
            padding: 30px 20px;
            text-align: center;
            color: #555;
            font-style: italic;
            font-size: 15px;
        }

        /* Chart */
        .chart-container {
            width: 100%;
            height: 100%;
            min-height: 300px;
            background: #1a1a1a;
        }

        /* Position Badge */
        .pos-badge {
            padding: 2px 6px;
            border-radius: 2px;
            font-size: 13px;
            font-weight: 700;
        }

        .pos-badge.long {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
        }

        .pos-badge.short {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        /* Action Button */
        .action-btn {
            padding: 4px 8px;
            font-size: 13px;
            background: #404040;
            border: 1px solid #555;
            color: #fff;
            cursor: pointer;
            border-radius: 2px;
            transition: all 0.2s;
        }

        .action-btn:hover {
            background: #007acc;
            border-color: #007acc;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #1a1a1a;
        }

        ::-webkit-scrollbar-thumb {
            background: #404040;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
    </style>
</head>
<body>
    <!-- Top Bar -->
    <div class="top-bar">
        <div class="top-bar-left">
            <h1>âš¡ IBKR PROFESSIONAL TRADING PLATFORM</h1>
        </div>
        <div class="top-bar-right">
            <div class="status-item">
                <div class="status-dot" id="ibkrStatus"></div>
                <span>IBKR: <strong id="ibkrStatusText">Disconnected</strong></span>
            </div>
            <div class="status-item">
                <div class="status-dot" id="aiStatus"></div>
                <span>AI: <strong id="aiStatusText">Offline</strong></span>
            </div>
            <div class="status-item">
                <span>Current: <strong id="currentSymbolDisplay">AAPL</strong></span>
            </div>
        </div>
    </div>

    <!-- Menu Bar -->
    <div class="menu-bar">
        <div class="menu-item" onclick="toggleDropdown('layouts-dropdown')">
            ğŸ“ LAYOUTS
            <div class="dropdown" id="layouts-dropdown">
                <strong>Preset Layouts</strong>
                <a href="#" onclick="event.preventDefault(); loadLayout('default')">ğŸ“Š Default</a>
                <a href="#" onclick="event.preventDefault(); loadLayout('trading')">âš¡ Trading</a>
                <a href="#" onclick="event.preventDefault(); loadLayout('analysis')">ğŸ“ˆ Analysis</a>
                <a href="#" onclick="event.preventDefault(); loadLayout('scalping')">ğŸ¯ Scalping</a>
                <hr>
                <a href="#" onclick="event.preventDefault(); resetLayout()">ğŸ”„ Reset to Default</a>
            </div>
        </div>
        <div class="menu-item" onclick="toggleDropdown('configs-dropdown')" style="background: #1e3a8a;">
            ğŸ’¾ CONFIGURATIONS
            <div class="dropdown" id="configs-dropdown">
                <strong>Saved Configurations</strong>
                <div id="savedConfigsList" style="max-height: 300px; overflow-y: auto;">
                    <!-- Dynamically populated -->
                </div>
                <hr>
                <a href="#" onclick="event.preventDefault(); showSaveConfigDialog()">ğŸ’¾ Save Current As...</a>
                <a href="#" onclick="event.preventDefault(); showManageConfigsDialog()">âš™ï¸ Manage Configurations</a>
            </div>
        </div>
        <div class="menu-item" onclick="toggleDropdown('switch-ui-dropdown')">
            ğŸ–¥ï¸ Switch UI
            <div class="dropdown" id="switch-ui-dropdown">
                <strong>Available Dashboards</strong>
                <a href="http://localhost:8000/ui/monitor.html" target="_blank">ğŸ›ï¸ Monitor Dashboard</a>
                <a href="platform.html" target="_blank">ğŸ“Š Trading Platform</a>
                <a href="complete_platform.html">ğŸ–¥ï¸ Complete Platform (Current)</a>
            </div>
        </div>
        <div class="menu-item" onclick="toggleDropdown('charts-dropdown')">
            ğŸ“Š CHARTS
            <div class="dropdown" id="charts-dropdown">
                <strong>Add Chart</strong>
                <a href="#" onclick="event.preventDefault(); addChart('1')">ğŸ“Š 1 Minute</a>
                <a href="#" onclick="event.preventDefault(); addChart('5')">ğŸ“Š 5 Minutes</a>
                <a href="#" onclick="event.preventDefault(); addChart('15')">ğŸ“Š 15 Minutes</a>
                <a href="#" onclick="event.preventDefault(); addChart('60')">ğŸ“Š 1 Hour</a>
                <a href="#" onclick="event.preventDefault(); addChart('240')">ğŸ“Š 4 Hours</a>
                <a href="#" onclick="event.preventDefault(); addChart('D')">ğŸ“Š Daily</a>
                <a href="#" onclick="event.preventDefault(); addChart('W')">ğŸ“Š Weekly</a>
                <hr>
                <a href="#" onclick="event.preventDefault(); showAddChartDialog()">âš™ï¸ Custom Chart...</a>
            </div>
        </div>
        <div class="menu-item" onclick="toggleDropdown('tradingview-dropdown')" style="background: #2563eb;">
            ğŸ“º TRADINGVIEW
            <div class="dropdown" id="tradingview-dropdown">
                <strong>Open in TradingView Desktop</strong>
                <a href="#" onclick="event.preventDefault(); openInTradingView(currentSymbol)">ğŸ“º Open Current Symbol</a>
                <a href="#" onclick="event.preventDefault(); copySymbolToClipboard()">ğŸ“‹ Copy Symbol to Clipboard</a>
                <hr>
                <strong>Webhook Integration</strong>
                <a href="#" onclick="event.preventDefault(); showWebhookInfo()">âš¡ Webhook URL & Setup</a>
                <a href="#" onclick="event.preventDefault(); showWebhookLogs()">ğŸ“Š View Webhook Logs</a>
                <a href="#" onclick="event.preventDefault(); testWebhook()">ğŸ§ª Test Webhook</a>
                <hr>
                <strong>Watchlist Sync</strong>
                <a href="#" onclick="event.preventDefault(); exportWatchlist()">â¬‡ï¸ Export Watchlist</a>
                <a href="#" onclick="event.preventDefault(); showSetupGuide()">ğŸ“š Setup Guide</a>
            </div>
        </div>
        <div class="menu-item" onclick="connectToIBKR()">ğŸ”Œ Connect IBKR</div>
        <div class="menu-item" onclick="openAIControlPanel()" style="background: #1e40af;">ğŸ¤– AI Control</div>
    </div>

    <!-- Workspace -->
    <div class="workspace" id="workspace"></div>

    <!-- Configuration Dialogs -->
    <div class="config-dialog-overlay" id="saveConfigDialog">
        <div class="config-dialog">
            <div class="config-dialog-header">ğŸ’¾ Save Configuration</div>
            <div class="config-dialog-body">
                <label style="display: block; margin-bottom: 8px; color: #888; font-size: 14px;">Configuration Name:</label>
                <input type="text" class="config-input" id="configNameInput" placeholder="e.g., My Trading Setup" />
                <div style="font-size: 12px; color: #666; margin-top: 5px;">
                    This will save the current window layout and watchlist.
                </div>
            </div>
            <div class="config-dialog-footer">
                <button class="btn btn-secondary" onclick="closeSaveConfigDialog()">Cancel</button>
                <button class="btn btn-buy" onclick="saveConfiguration()">ğŸ’¾ Save</button>
            </div>
        </div>
    </div>

    <div class="config-dialog-overlay" id="manageConfigsDialog">
        <div class="config-dialog">
            <div class="config-dialog-header">âš™ï¸ Manage Configurations</div>
            <div class="config-dialog-body">
                <div id="manageConfigsList">
                    <!-- Dynamically populated -->
                </div>
                <div id="noConfigsMessage" style="text-align: center; padding: 40px 20px; color: #666;">
                    No saved configurations yet.<br>
                    <small>Save your first configuration from the CONFIGURATIONS menu!</small>
                </div>
            </div>
            <div class="config-dialog-footer">
                <button class="btn btn-secondary" onclick="closeManageConfigsDialog()">Close</button>
            </div>
        </div>
    </div>

    <div class="config-dialog-overlay" id="addChartDialog">
        <div class="config-dialog">
            <div class="config-dialog-header">ğŸ“Š Add Chart</div>
            <div class="config-dialog-body">
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 8px; color: #888; font-size: 14px;">Timeframe:</label>
                    <select class="config-input" id="chartTimeframe">
                        <option value="1">1 Minute</option>
                        <option value="5" selected>5 Minutes</option>
                        <option value="15">15 Minutes</option>
                        <option value="30">30 Minutes</option>
                        <option value="60">1 Hour</option>
                        <option value="240">4 Hours</option>
                        <option value="D">Daily</option>
                        <option value="W">Weekly</option>
                        <option value="M">Monthly</option>
                    </select>
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 8px; color: #888; font-size: 14px;">Chart Style:</label>
                    <select class="config-input" id="chartStyle">
                        <option value="1" selected>Candles</option>
                        <option value="0">Bars</option>
                        <option value="9">Heikin Ashi</option>
                        <option value="3">Line</option>
                        <option value="8">Area</option>
                    </select>
                </div>
                <div style="font-size: 12px; color: #666; margin-top: 10px;">
                    Chart will be created for current symbol: <span id="chartSymbolPreview" style="color: #007acc; font-weight: 700;">AAPL</span>
                </div>
            </div>
            <div class="config-dialog-footer">
                <button class="btn btn-secondary" onclick="closeAddChartDialog()">Cancel</button>
                <button class="btn btn-buy" onclick="createCustomChart()">ğŸ“Š Add Chart</button>
            </div>
        </div>
    </div>

    <!-- TradingView Webhook Info Dialog -->
    <div class="config-dialog-overlay" id="webhookInfoDialog">
        <div class="config-dialog" style="max-width: 700px;">
            <div class="config-dialog-header">âš¡ TradingView Webhook Setup</div>
            <div class="config-dialog-body">
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 8px; color: #007acc; font-size: 14px; font-weight: 700;">Webhook URL:</label>
                    <div style="display: flex; gap: 5px;">
                        <input type="text" class="config-input" id="webhookUrl" readonly value="http://127.0.0.1:9101/api/tradingview/webhook" style="flex: 1; font-family: monospace; font-size: 13px;">
                        <button class="btn btn-secondary" onclick="copyWebhookUrl()" style="padding: 10px 15px;">ğŸ“‹ Copy</button>
                    </div>
                </div>
                <div style="background: #1a1a1a; border: 1px solid #333; border-radius: 4px; padding: 15px; margin-bottom: 15px;">
                    <div style="font-size: 13px; color: #888; font-weight: 700; margin-bottom: 10px;">ALERT MESSAGE FORMAT:</div>
                    <pre style="background: #252525; padding: 10px; border-radius: 3px; font-size: 12px; color: #22c55e; overflow-x: auto; margin: 0;">{
  "action": "{{strategy.order.action}}",
  "symbol": "{{ticker}}",
  "price": {{close}},
  "confidence": 0.85,
  "target": {{close}} * 1.05,
  "stop": {{close}} * 0.98
}</pre>
                </div>
                <div style="font-size: 12px; color: #666;">
                    <strong style="color: #007acc;">Setup Steps:</strong><br>
                    1. Open TradingView Desktop<br>
                    2. Create an alert on your chart<br>
                    3. Set "Webhook URL" to the URL above<br>
                    4. Paste the alert message format<br>
                    5. Test with the "Test Webhook" button below
                </div>
            </div>
            <div class="config-dialog-footer">
                <button class="btn btn-secondary" onclick="closeWebhookInfoDialog()">Close</button>
                <button class="btn btn-buy" onclick="openTradingViewSetupGuide()">ğŸ“š Full Guide</button>
            </div>
        </div>
    </div>

    <!-- TradingView Webhook Logs Dialog -->
    <div class="config-dialog-overlay" id="webhookLogsDialog">
        <div class="config-dialog" style="max-width: 800px;">
            <div class="config-dialog-header">ğŸ“Š Webhook Activity Logs</div>
            <div class="config-dialog-body">
                <div id="webhookLogsList" style="max-height: 400px; overflow-y: auto; font-family: monospace; font-size: 12px;">
                    <div style="text-align: center; padding: 40px; color: #666;">
                        Loading webhook logs...
                    </div>
                </div>
            </div>
            <div class="config-dialog-footer">
                <button class="btn btn-danger" onclick="clearWebhookLogs()">ğŸ—‘ï¸ Clear Logs</button>
                <button class="btn btn-secondary" onclick="closeWebhookLogsDialog()">Close</button>
                <button class="btn btn-buy" onclick="refreshWebhookLogs()">ğŸ”„ Refresh</button>
            </div>
        </div>
    </div>

    <!-- Halt Indicator (DISABLED - Now in quote window) -->
    <div id="haltIndicator" style="display: none;"></div>

    <style>
        @keyframes pulse {
            0%, 100% { opacity: 1; transform: translateX(-50%) scale(1); }
            50% { opacity: 0.85; transform: translateX(-50%) scale(1.02); }
        }
    </style>

    <!-- Layout Controls -->
    <div class="layout-controls">
        <button class="layout-btn" onclick="tileWindows()">âŠ Tile</button>
        <button class="layout-btn" onclick="cascadeWindows()">â§‰ Cascade</button>
        <button class="layout-btn" onclick="minimizeAll()">â–¼ Min All</button>
        <button class="layout-btn" onclick="restoreAll()">â–² Restore</button>
    </div>

    <script>
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        //                     GLOBAL STATE
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        let windows = [];
        let activeWindow = null;
        let zIndexCounter = 100;
        let currentSymbol = 'AAPL';
        let watchlist = ['AAPL', 'MSFT', 'GOOGL', 'TSLA', 'NVDA', 'SPY', 'QQQ'];
        let marketDataCache = {};
        let positionsCache = [];
        let ordersCache = [];
        let apiAvailable = null; // null = unknown, true = available, false = demo mode
        let demoModeLogged = false;
        const API_BASE_URL = 'http://127.0.0.1:9101'; // API server base URL

        // Halt Detection State
        let haltState = {
            isHalted: false,
            haltTime: null,
            haltPrice: null,
            resumeTime: null,
            lastUpdateTime: null,
            symbol: null
        };

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        //                     WINDOW MANAGEMENT
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        class DraggableWindow {
            constructor(id, title, content, x, y, width, height) {
                this.id = id;
                this.title = title;
                this.x = x;
                this.y = y;
                this.width = width;
                this.height = height;
                this.minimized = false;
                this.maximized = false;
                this.savedState = null;
                this.element = null;
                this.create(content);
            }

            create(content) {
                const win = document.createElement('div');
                win.className = 'window';
                win.id = `window-${this.id}`;
                win.style.left = this.x + 'px';
                win.style.top = this.y + 'px';
                win.style.width = this.width + 'px';
                win.style.height = this.height + 'px';
                win.style.zIndex = ++zIndexCounter;

                win.innerHTML = `
                    <div class="window-header">
                        <span>${this.title}</span>
                        <div class="window-controls">
                            <div class="window-btn minimize" onclick="minimizeWindow('${this.id}')">âˆ’</div>
                            <div class="window-btn maximize" onclick="maximizeWindow('${this.id}')">â–¡</div>
                            <div class="window-btn close" onclick="closeWindow('${this.id}')">Ã—</div>
                        </div>
                    </div>
                    <div class="window-content">${content}</div>
                    <div class="resize-handle n"></div>
                    <div class="resize-handle s"></div>
                    <div class="resize-handle e"></div>
                    <div class="resize-handle w"></div>
                    <div class="resize-handle ne"></div>
                    <div class="resize-handle nw"></div>
                    <div class="resize-handle se"></div>
                    <div class="resize-handle sw"></div>
                `;

                this.element = win;
                document.getElementById('workspace').appendChild(win);
                this.setupDrag();
                this.setupResize();
                win.addEventListener('mousedown', () => this.activate());
            }

            setupDrag() {
                const header = this.element.querySelector('.window-header');
                let isDragging = false;
                let startX, startY, startLeft, startTop;

                header.addEventListener('mousedown', (e) => {
                    if (e.target.classList.contains('window-btn')) return;
                    isDragging = true;
                    startX = e.clientX;
                    startY = e.clientY;
                    startLeft = this.x;
                    startTop = this.y;
                    this.activate();
                });

                document.addEventListener('mousemove', (e) => {
                    if (!isDragging) return;
                    this.x = startLeft + e.clientX - startX;
                    this.y = startTop + e.clientY - startY;
                    this.element.style.left = this.x + 'px';
                    this.element.style.top = this.y + 'px';
                });

                document.addEventListener('mouseup', () => isDragging = false);
            }

            setupResize() {
                const handles = this.element.querySelectorAll('.resize-handle');
                handles.forEach(handle => {
                    let isResizing = false;
                    let startX, startY, startWidth, startHeight, startLeft, startTop;
                    const direction = handle.className.split(' ')[1];

                    handle.addEventListener('mousedown', (e) => {
                        e.stopPropagation();
                        isResizing = true;
                        startX = e.clientX;
                        startY = e.clientY;
                        startWidth = this.width;
                        startHeight = this.height;
                        startLeft = this.x;
                        startTop = this.y;
                        this.activate();
                    });

                    document.addEventListener('mousemove', (e) => {
                        if (!isResizing) return;
                        const dx = e.clientX - startX;
                        const dy = e.clientY - startY;

                        if (direction.includes('e')) this.width = Math.max(200, startWidth + dx);
                        if (direction.includes('w')) {
                            const newWidth = Math.max(200, startWidth - dx);
                            if (newWidth > 200) {
                                this.width = newWidth;
                                this.x = startLeft + dx;
                            }
                        }
                        if (direction.includes('s')) this.height = Math.max(150, startHeight + dy);
                        if (direction.includes('n')) {
                            const newHeight = Math.max(150, startHeight - dy);
                            if (newHeight > 150) {
                                this.height = newHeight;
                                this.y = startTop + dy;
                            }
                        }

                        this.updatePosition();
                    });

                    document.addEventListener('mouseup', () => isResizing = false);
                });
            }

            updatePosition() {
                this.element.style.left = this.x + 'px';
                this.element.style.top = this.y + 'px';
                this.element.style.width = this.width + 'px';
                this.element.style.height = this.height + 'px';
            }

            activate() {
                windows.forEach(w => w.element.classList.remove('active'));
                this.element.classList.add('active');
                this.element.style.zIndex = ++zIndexCounter;
                activeWindow = this;
            }

            minimize() {
                if (!this.minimized) {
                    this.element.style.display = 'none';
                    this.minimized = true;
                }
            }

            restore() {
                if (this.minimized) {
                    this.element.style.display = 'flex';
                    this.minimized = false;
                    this.activate();
                }
                if (this.maximized) {
                    if (this.savedState) {
                        this.x = this.savedState.x;
                        this.y = this.savedState.y;
                        this.width = this.savedState.width;
                        this.height = this.savedState.height;
                        this.updatePosition();
                    }
                    this.maximized = false;
                }
            }

            maximize() {
                if (!this.maximized) {
                    this.savedState = { x: this.x, y: this.y, width: this.width, height: this.height };
                    const workspace = document.getElementById('workspace');
                    this.x = 0;
                    this.y = 0;
                    this.width = workspace.clientWidth;
                    this.height = workspace.clientHeight;
                    this.updatePosition();
                    this.maximized = true;
                } else {
                    this.restore();
                }
            }

            close() {
                this.element.remove();
                windows = windows.filter(w => w.id !== this.id);
            }
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        //                     WINDOW TEMPLATES
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        const windowTemplates = {
            quote: `
                <!-- Condensed Quote Display -->
                <div style="padding: 8px; display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; font-size: 11px;">
                    <div style="text-align: center;">
                        <div style="color: #666; font-size: 9px; margin-bottom: 2px;">BID</div>
                        <div id="bidPrice" style="color: #ef4444; font-weight: 700; font-size: 13px;">--</div>
                        <div id="bidSize" style="color: #666; font-size: 9px;">--</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="color: #666; font-size: 9px; margin-bottom: 2px;">LAST</div>
                        <div id="lastPrice" style="color: #60a5fa; font-weight: 700; font-size: 13px;">--</div>
                        <div id="priceChange" style="font-size: 9px;">--</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="color: #666; font-size: 9px; margin-bottom: 2px;">ASK</div>
                        <div id="askPrice" style="color: #22c55e; font-weight: 700; font-size: 13px;">--</div>
                        <div id="askSize" style="color: #666; font-size: 9px;">--</div>
                    </div>
                </div>

                <!-- Secondary Stats -->
                <div style="padding: 0 8px 8px 8px; display: grid; grid-template-columns: repeat(4, 1fr); gap: 4px; font-size: 10px; border-top: 1px solid #333;">
                    <div style="text-align: center; padding-top: 4px;">
                        <div style="color: #666; font-size: 8px;">VOL</div>
                        <div id="volumePrice" style="color: #aaa; font-weight: 600; font-size: 10px;">--</div>
                    </div>
                    <div style="text-align: center; padding-top: 4px;">
                        <div style="color: #666; font-size: 8px;">HIGH</div>
                        <div id="highPrice" style="color: #aaa; font-weight: 600; font-size: 10px;">--</div>
                    </div>
                    <div style="text-align: center; padding-top: 4px;">
                        <div style="color: #666; font-size: 8px;">LOW</div>
                        <div id="lowPrice" style="color: #aaa; font-weight: 600; font-size: 10px;">--</div>
                    </div>
                    <div style="text-align: center; padding-top: 4px;">
                        <div style="color: #666; font-size: 8px;">OPEN</div>
                        <div id="openPrice" style="color: #aaa; font-weight: 600; font-size: 10px;">--</div>
                    </div>
                </div>

                <!-- Halt Indicator -->
                <div style="padding: 0 8px 8px 8px;">
                    <div id="quoteHaltIndicator" style="display: none; padding: 4px; border-radius: 3px; text-align: center; background: #dc2626; color: white; font-size: 11px;">
                        <span id="quoteHaltTitle" style="font-weight: bold;">ğŸ›‘ HALT</span>
                        <span id="quoteHaltInfo" style="font-size: 9px; margin-left: 6px;"></span>
                    </div>
                </div>
            `,

            level2: `
                <div class="level2-container">
                    <div class="level2-column">
                        <div class="level2-header">
                            <div>MM</div>
                            <div>SIZE</div>
                            <div>BID</div>
                            <div>ORD</div>
                        </div>
                        <div id="bidsDisplay"></div>
                    </div>
                    <div class="level2-column">
                        <div class="level2-header">
                            <div>ORD</div>
                            <div>ASK</div>
                            <div>SIZE</div>
                            <div>MM</div>
                        </div>
                        <div id="asksDisplay"></div>
                    </div>
                </div>
            `,

            timesales: `
                <div style="padding: 4px 0;">
                    <div class="timesales-row" style="background: #2d2d2d; position: sticky; top: 0;">
                        <div style="color: #888; font-weight: 700;">TIME</div>
                        <div style="color: #888; font-weight: 700;">PRICE</div>
                        <div style="color: #888; font-weight: 700;">SIZE</div>
                        <div style="color: #888; font-weight: 700;">SIDE</div>
                    </div>
                    <div id="timesalesDisplay"></div>
                </div>
            `,

            order: `
                <div class="module-content">
                    <div class="order-field">
                        <label>Symbol</label>
                        <input type="text" id="orderSymbol" value="AAPL" readonly
                               style="text-transform: uppercase; background: #1a1a1a; font-weight: 700; font-size: 17px;">
                    </div>

                    <div class="quantity-buttons">
                        <button class="qty-btn" onclick="setQuantity(50)">50</button>
                        <button class="qty-btn" onclick="setQuantity(100)">100</button>
                        <button class="qty-btn" onclick="setQuantity(200)">200</button>
                        <button class="qty-btn" onclick="setQuantity(500)">500</button>
                        <button class="qty-btn" onclick="setQuantity(1000)">1K</button>
                    </div>

                    <!-- Market Price Display - Clickable to set price -->
                    <div id="marketPriceDisplay" style="margin: 8px 0; padding: 8px; background: #1a1a1a; border: 1px solid #333; border-radius: 4px; display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; text-align: center;">
                        <div style="cursor: pointer; padding: 4px; border-radius: 3px; transition: background 0.2s;" onclick="setOrderPrice('bid')" onmouseover="this.style.background='#2d2d2d'" onmouseout="this.style.background='transparent'">
                            <div style="font-size: 10px; color: #666; margin-bottom: 2px;">BID</div>
                            <div id="marketBid" style="font-size: 14px; font-weight: 600; color: #ef4444;">--</div>
                        </div>
                        <div style="cursor: pointer; padding: 4px; border-radius: 3px; transition: background 0.2s;" onclick="setOrderPrice('last')" onmouseover="this.style.background='#2d2d2d'" onmouseout="this.style.background='transparent'">
                            <div style="font-size: 10px; color: #666; margin-bottom: 2px;">LAST</div>
                            <div id="marketLast" style="font-size: 14px; font-weight: 600; color: #fff;">--</div>
                        </div>
                        <div style="cursor: pointer; padding: 4px; border-radius: 3px; transition: background 0.2s;" onclick="setOrderPrice('ask')" onmouseover="this.style.background='#2d2d2d'" onmouseout="this.style.background='transparent'">
                            <div style="font-size: 10px; color: #666; margin-bottom: 2px;">ASK</div>
                            <div id="marketAsk" style="font-size: 14px; font-weight: 600; color: #22c55e;">--</div>
                        </div>
                    </div>

                    <div class="order-entry-grid">
                        <div class="order-field">
                            <label>Quantity</label>
                            <input type="number" id="orderQuantity" value="100" min="1" oninput="calculateOrderCost()">
                        </div>
                        <div class="order-field">
                            <label>Order Type</label>
                            <select id="orderType" onchange="handleOrderTypeChange()">
                                <option value="MARKET">Market</option>
                                <option value="LIMIT" selected>Limit</option>
                                <option value="STOP">Stop</option>
                                <option value="STOP_LIMIT">Stop Limit</option>
                            </select>
                        </div>
                    </div>

                    <div class="price-controls">
                        <button class="price-btn" onclick="adjustPrice(-0.01); calculateOrderCost();">âˆ’</button>
                        <div class="order-field" style="margin: 0;">
                            <label>Limit Price</label>
                            <input type="text" id="orderPrice" value="" placeholder="Enter limit price" oninput="calculateOrderCost()">
                        </div>
                        <button class="price-btn" onclick="adjustPrice(0.01); calculateOrderCost();">+</button>
                    </div>

                    <div class="order-field">
                        <label>Time In Force</label>
                        <select id="orderTIF">
                            <option value="DAY">Day</option>
                            <option value="GTC">GTC</option>
                            <option value="IOC">IOC</option>
                            <option value="FOK">FOK</option>
                        </select>
                    </div>

                    <!-- Checkboxes on one line to save space -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin: 8px 0;">
                        <div style="display: flex; align-items: center; gap: 6px;">
                            <input type="checkbox" id="extendedHours" style="width: auto; margin: 0;">
                            <label for="extendedHours" style="margin: 0; cursor: pointer; font-size: 13px;">Ext Hours</label>
                        </div>
                        <div style="display: flex; align-items: center; gap: 6px;">
                            <input type="checkbox" id="autoSubmitOrders" style="width: auto; margin: 0;" onchange="saveAutoSubmitSetting(this.checked)">
                            <label for="autoSubmitOrders" style="margin: 0; cursor: pointer; font-size: 13px; color: #fbbf24;">âš¡ Auto-Submit</label>
                        </div>
                    </div>

                    <!-- Order Cost Calculator -->
                    <div style="margin: 12px 0; padding: 10px; background: #1a1a1a; border: 1px solid #333; border-radius: 4px;">
                        <div style="font-size: 11px; color: #888; margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px;">
                            Estimated Cost
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px;">
                            <div style="text-align: center;">
                                <div style="font-size: 10px; color: #666; margin-bottom: 2px;">Shares</div>
                                <div id="calcShares" style="font-size: 15px; font-weight: 600; color: #fff;">0</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 10px; color: #666; margin-bottom: 2px;">Price</div>
                                <div id="calcPrice" style="font-size: 15px; font-weight: 600; color: #fff;">$0.00</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 10px; color: #666; margin-bottom: 2px;">Est. Total</div>
                                <div id="calcTotal" style="font-size: 15px; font-weight: 600; color: #22c55e;">$0.00</div>
                            </div>
                        </div>
                    </div>

                    <!-- Order buttons: Buys on left, Sells on right -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 12px;">
                        <!-- BUY SIDE (LEFT) -->
                        <div style="display: flex; flex-direction: column; gap: 6px;">
                            <button class="btn btn-buy" onclick="submitOrder('BUY')" style="width: 100%; font-weight: 600;">
                                BUY
                            </button>
                            <button class="btn btn-secondary" onclick="submitOrder('BUY_MARKET')" style="width: 100%; font-size: 12px;">
                                BUY MARKET
                            </button>
                            <button class="btn btn-secondary" onclick="submitOrderAtPrice('BUY', 'BID')" style="width: 100%; font-size: 11px; background: #134e4a; color: #22c55e;">
                                Buy @ Bid
                            </button>
                            <button class="btn btn-secondary" onclick="submitOrderAtPrice('BUY', 'ASK')" style="width: 100%; font-size: 11px; background: #134e4a; color: #22c55e;">
                                Buy @ Ask
                            </button>
                        </div>

                        <!-- SELL SIDE (RIGHT) -->
                        <div style="display: flex; flex-direction: column; gap: 6px;">
                            <button class="btn btn-sell" onclick="submitOrder('SELL')" style="width: 100%; font-weight: 600;">
                                SELL
                            </button>
                            <button class="btn btn-secondary" onclick="submitOrder('SELL_MARKET')" style="width: 100%; font-size: 12px;">
                                SELL MARKET
                            </button>
                            <button class="btn btn-secondary" onclick="submitOrderAtPrice('SELL', 'BID')" style="width: 100%; font-size: 11px; background: #7f1d1d; color: #ef4444;">
                                Sell @ Bid
                            </button>
                            <button class="btn btn-secondary" onclick="submitOrderAtPrice('SELL', 'ASK')" style="width: 100%; font-size: 11px; background: #7f1d1d; color: #ef4444;">
                                Sell @ Ask
                            </button>
                        </div>
                    </div>

                    <!-- Cancel All Button -->
                    <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #333;">
                        <button class="btn btn-secondary" onclick="cancelAllOrders()" style="width: 100%; background: #7f1d1d; color: #ef4444; font-size: 13px;">
                            âŒ CANCEL ALL ORDERS
                        </button>
                    </div>
                </div>
            `,

            positions: `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Symbol</th>
                            <th>Side</th>
                            <th>Qty</th>
                            <th>Avg Price</th>
                            <th>Current</th>
                            <th>P&L</th>
                            <th>P&L %</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="positionsDisplay">
                        <tr><td colspan="8" class="empty-state">No open positions</td></tr>
                    </tbody>
                </table>
            `,

            orders: `
                <div style="padding: 6px 8px; border-bottom: 1px solid #333; display: flex; justify-content: flex-end;">
                    <button class="btn btn-secondary" onclick="cancelAllOrders()"
                            style="padding: 4px 12px; font-size: 14px; font-weight: 600;">
                        CANCEL ALL ORDERS
                    </button>
                </div>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Time</th>
                            <th>Symbol</th>
                            <th>Side</th>
                            <th>Qty</th>
                            <th>Type</th>
                            <th>Price</th>
                            <th>Status</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="ordersDisplay">
                        <tr><td colspan="8" class="empty-state">No working orders</td></tr>
                    </tbody>
                </table>
            `,

            watchlist: `
                <div style="padding: 6px 8px; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center;">
                    <div style="font-size: 13px; color: #888; text-transform: uppercase;">Shared Worklist</div>
                    <div style="display: flex; gap: 4px;">
                        <button class="btn btn-secondary" onclick="showScannerDialog()"
                                style="padding: 4px 8px; font-size: 13px; font-weight: 600;">SCANNER</button>
                        <button class="btn btn-secondary" onclick="showAddSymbolDialog()"
                                style="padding: 4px 8px; font-size: 13px; font-weight: 600;">+ ADD</button>
                        <button class="btn btn-secondary" onclick="clearWorklist()"
                                style="padding: 4px 8px; font-size: 13px; font-weight: 600; background: #7f1d1d;">CLEAR ALL</button>
                    </div>
                </div>
                <div id="worklistStats" style="padding: 6px 8px; background: #1a1a1a; border-bottom: 1px solid #333; display: grid; grid-template-columns: repeat(4, 1fr); gap: 4px;">
                    <div style="background: #252525; padding: 4px 6px; border-radius: 2px;">
                        <div style="font-size: 12px; color: #888; margin-bottom: 2px;">SYMBOLS</div>
                        <div style="font-size: 18px; font-weight: 700; color: #fff;" id="statsTotal">0</div>
                    </div>
                    <div style="background: #252525; padding: 4px 6px; border-radius: 2px;">
                        <div style="font-size: 12px; color: #888; margin-bottom: 2px;">LIVE</div>
                        <div style="font-size: 18px; font-weight: 700; color: #22c55e;" id="statsLive">0</div>
                    </div>
                    <div style="background: #252525; padding: 4px 6px; border-radius: 2px;">
                        <div style="font-size: 12px; color: #888; margin-bottom: 2px;">BULLISH</div>
                        <div style="font-size: 18px; font-weight: 700; color: #22c55e;" id="statsBullish">0</div>
                    </div>
                    <div style="background: #252525; padding: 4px 6px; border-radius: 2px;">
                        <div style="font-size: 12px; color: #888; margin-bottom: 2px;">BEARISH</div>
                        <div style="font-size: 18px; font-weight: 700; color: #ef4444;" id="statsBearish">0</div>
                    </div>
                </div>
                <div id="watchlistDisplay" style="overflow-y: auto; max-height: calc(100% - 90px);">
                    <div class="empty-state">Loading worklist...</div>
                </div>
            `,

            account: `
                <!-- Condensed Account Display -->
                <div style="padding: 6px 8px; border-bottom: 1px solid #333; background: #1a1a1a;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div style="font-size: 10px; color: #888;">
                            <span id="accountNumber">DU0000000</span> â€¢ <span id="accountType">Unknown</span>
                        </div>
                        <div id="accountWarnings" style="font-size: 10px; padding: 2px 6px; border-radius: 2px; display: none;"></div>
                    </div>
                </div>

                <!-- Key Stats - Compact Grid -->
                <div style="padding: 8px; display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 11px;">
                    <div style="padding: 6px; background: #1a1a1a; border-radius: 3px;">
                        <div style="color: #666; font-size: 8px; margin-bottom: 2px;">CASH</div>
                        <div id="cashBalance" style="font-weight: 700; font-size: 13px; color: #22c55e;">$0.00</div>
                    </div>
                    <div style="padding: 6px; background: #1a1a1a; border-radius: 3px;">
                        <div style="color: #666; font-size: 8px; margin-bottom: 2px;">BUYING POWER</div>
                        <div id="buyingPower" style="font-weight: 700; font-size: 13px; color: #60a5fa;">$0.00</div>
                    </div>
                    <div style="padding: 6px; background: #1a1a1a; border-radius: 3px;">
                        <div style="color: #666; font-size: 8px; margin-bottom: 2px;">DAY P&L</div>
                        <div id="dayPL" style="font-weight: 700; font-size: 13px;">$0.00</div>
                    </div>
                    <div style="padding: 6px; background: #1a1a1a; border-radius: 3px;">
                        <div style="color: #666; font-size: 8px; margin-bottom: 2px;">EQUITY</div>
                        <div id="equityValue" style="font-weight: 700; font-size: 13px; color: #aaa;">$0.00</div>
                    </div>
                </div>

                <!-- Additional Info Bar -->
                <div style="padding: 4px 8px; display: flex; justify-content: space-between; font-size: 9px; color: #666; border-top: 1px solid #333;">
                    <div>Positions: <span id="positionCount" style="color: #aaa; font-weight: 600;">0</span></div>
                    <div id="dayTradesInfo" style="display: none;">Day Trades: <span id="dayTradesRemaining" style="color: #aaa; font-weight: 600;">-</span></div>
                    <div>Total P&L: <span id="totalPL" style="font-weight: 600;">$0.00</span></div>
                </div>
            `,

            bot: `
                <div class="module-content" style="padding: 8px; overflow-y: auto; max-height: 100%;">
                    <!-- Bot Status Header -->
                    <div style="text-align: center; margin-bottom: 12px; padding: 12px; background: #1a1a1a; border-radius: 4px;">
                        <div style="font-size: 13px; color: #888; margin-bottom: 4px; letter-spacing: 1px;">AUTONOMOUS BOT STATUS</div>
                        <div id="botStatusText" style="font-size: 24px; font-weight: 700; color: #ef4444; margin-bottom: 4px;">NOT INITIALIZED</div>
                        <div id="botStatusSubtext" style="font-size: 13px; color: #888;">Click INIT to initialize bot</div>
                    </div>

                    <!-- Control Buttons -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 6px; margin-bottom: 8px;">
                        <button id="initBotBtn" class="btn btn-secondary" onclick="initBot()" style="font-size: 14px; padding: 8px;">âš™ï¸ INIT</button>
                        <button id="startBotBtn" class="btn btn-buy" onclick="startAutonomousBot()" disabled style="font-size: 14px; padding: 8px;">â–¶ START</button>
                        <button id="stopBotBtn" class="btn btn-sell" onclick="stopAutonomousBot()" disabled style="font-size: 14px; padding: 8px;">â¹ STOP</button>
                        <button id="enableBotBtn" class="btn btn-secondary" onclick="enableBot()" disabled style="font-size: 14px; padding: 8px;">âœ“ ENABLE</button>
                    </div>

                    <!-- Statistics Grid -->
                    <div id="botStatsGrid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 6px; margin-bottom: 8px;">
                        <div style="padding: 6px; background: #1a1a1a; border-radius: 2px;">
                            <div style="font-size: 12px; color: #888;">SIGNALS</div>
                            <div id="botSignals" style="font-size: 17px; font-weight: 700; color: #60a5fa;">0</div>
                        </div>
                        <div style="padding: 6px; background: #1a1a1a; border-radius: 2px;">
                            <div style="font-size: 12px; color: #888;">TRADES</div>
                            <div id="botTrades" style="font-size: 17px; font-weight: 700; color: #22c55e;">0</div>
                        </div>
                        <div style="padding: 6px; background: #1a1a1a; border-radius: 2px;">
                            <div style="font-size: 12px; color: #888;">POSITIONS</div>
                            <div id="botPositions" style="font-size: 17px; font-weight: 700; color: #fbbf24;">0</div>
                        </div>
                        <div style="padding: 6px; background: #1a1a1a; border-radius: 2px;">
                            <div style="font-size: 12px; color: #888;">DAILY P&L (5%)</div>
                            <div id="botDailyPnl" style="font-size: 17px; font-weight: 700;">$0.00</div>
                        </div>
                    </div>

                    <!-- 3-5-7 Risk Management Display -->
                    <div style="padding: 8px; background: #1a1a1a; border: 1px solid #333; border-radius: 3px; margin-bottom: 8px;">
                        <div style="font-size: 13px; color: #888; margin-bottom: 6px; font-weight: 700; letter-spacing: 0.5px;">3-5-7 RISK MANAGEMENT</div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 6px;">
                            <div style="padding: 4px;">
                                <div style="font-size: 12px; color: #888;">WEEKLY P&L (7%)</div>
                                <div id="botWeeklyPnl" style="font-size: 16px; font-weight: 700;">$0.00</div>
                            </div>
                            <div style="padding: 4px;">
                                <div style="font-size: 12px; color: #888;">MAX RISK/TRADE (3%)</div>
                                <div id="botMaxRisk" style="font-size: 16px; font-weight: 700; color: #888;">$0.00</div>
                            </div>
                        </div>
                    </div>

                    <!-- Configuration Section -->
                    <div style="padding: 8px; background: #252525; border: 1px solid #333; border-radius: 3px; margin-bottom: 8px;">
                        <div style="font-size: 13px; color: #888; margin-bottom: 6px; font-weight: 700; letter-spacing: 0.5px;">CONFIGURATION</div>

                        <div style="margin-bottom: 6px;">
                            <label style="font-size: 12px; color: #888; display: block; margin-bottom: 2px;">Watchlist</label>
                            <input type="text" id="botWatchlist" value="AAPL,MSFT,GOOGL,TSLA,NVDA"
                                   style="width: 100%; padding: 4px 6px; background: #1a1a1a; border: 1px solid #404040; color: #fff; font-size: 14px; border-radius: 2px;">
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 6px; margin-bottom: 6px;">
                            <div>
                                <label style="font-size: 12px; color: #888; display: block; margin-bottom: 2px;">Max Position $</label>
                                <input type="number" id="botMaxPosition" value="5000" min="100" step="100"
                                       style="width: 100%; padding: 4px 6px; background: #1a1a1a; border: 1px solid #404040; color: #fff; font-size: 14px; border-radius: 2px;">
                            </div>
                            <div>
                                <label style="font-size: 12px; color: #888; display: block; margin-bottom: 2px;">Daily Loss $</label>
                                <input type="number" id="botDailyLoss" value="500" min="50" step="50"
                                       style="width: 100%; padding: 4px 6px; background: #1a1a1a; border: 1px solid #404040; color: #fff; font-size: 14px; border-radius: 2px;">
                            </div>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 6px;">
                            <div>
                                <label style="font-size: 12px; color: #888; display: block; margin-bottom: 2px;">Min Prob %</label>
                                <input type="number" id="botMinProb" value="60" min="50" max="100" step="1"
                                       style="width: 100%; padding: 4px 6px; background: #1a1a1a; border: 1px solid #404040; color: #fff; font-size: 14px; border-radius: 2px;">
                            </div>
                            <div>
                                <label style="font-size: 12px; color: #888; display: block; margin-bottom: 2px;">Max Positions</label>
                                <input type="number" id="botMaxPositions" value="5" min="1" max="20" step="1"
                                       style="width: 100%; padding: 4px 6px; background: #1a1a1a; border: 1px solid #404040; color: #fff; font-size: 14px; border-radius: 2px;">
                            </div>
                        </div>

                        <button class="btn btn-secondary" onclick="updateBotConfig()" style="width: 100%; margin-top: 6px; font-size: 13px; padding: 5px;">
                            UPDATE CONFIG
                        </button>
                    </div>

                    <!-- Recent Predictions -->
                    <div style="padding: 8px; background: #252525; border: 1px solid #333; border-radius: 3px; margin-bottom: 8px;">
                        <div style="font-size: 13px; color: #888; margin-bottom: 6px; font-weight: 700; letter-spacing: 0.5px;">RECENT PREDICTIONS</div>
                        <div id="botPredictionsDisplay" style="max-height: 120px; overflow-y: auto; font-size: 13px;">
                            <div class="empty-state" style="padding: 16px; font-size: 13px;">No predictions yet</div>
                        </div>
                    </div>

                    <!-- Open Positions -->
                    <div style="padding: 8px; background: #252525; border: 1px solid #333; border-radius: 3px;">
                        <div style="font-size: 13px; color: #888; margin-bottom: 6px; font-weight: 700; letter-spacing: 0.5px;">OPEN POSITIONS</div>
                        <div id="botPositionsDisplay" style="max-height: 120px; overflow-y: auto; font-size: 13px;">
                            <div class="empty-state" style="padding: 16px; font-size: 13px;">No positions</div>
                        </div>
                    </div>
                </div>
            `,

            ai: `
                <div class="module-content">
                    <div id="aiPredictionDisplay" class="empty-state">Click PREDICT for AI analysis</div>
                    <button class="btn btn-secondary" onclick="getPrediction()" style="width: 100%; margin-top: 12px;">
                        ğŸ¤– GET AI PREDICTION
                    </button>
                </div>
            `,

            aicontrol: `
                <div class="module-content" style="padding: 8px; overflow-y: auto; max-height: 100%;">
                    <!-- Tab Navigation -->
                    <div style="display: flex; gap: 4px; margin-bottom: 12px; border-bottom: 2px solid #333;">
                        <button id="aiTabTraining" class="ai-tab active" onclick="switchAITab('training')" style="flex: 1; padding: 8px; background: #2d2d2d; border: none; color: #fff; cursor: pointer; font-size: 13px; font-weight: 600;">
                            ğŸ“š TRAINING
                        </button>
                        <button id="aiTabPredictions" class="ai-tab" onclick="switchAITab('predictions')" style="flex: 1; padding: 8px; background: #1a1a1a; border: none; color: #888; cursor: pointer; font-size: 13px; font-weight: 600;">
                            ğŸ”® PREDICTIONS
                        </button>
                        <button id="aiTabBacktest" class="ai-tab" onclick="switchAITab('backtest')" style="flex: 1; padding: 8px; background: #1a1a1a; border: none; color: #888; cursor: pointer; font-size: 13px; font-weight: 600;">
                            ğŸ“Š BACKTEST
                        </button>
                        <button id="aiTabModels" class="ai-tab" onclick="switchAITab('models')" style="flex: 1; padding: 8px; background: #1a1a1a; border: none; color: #888; cursor: pointer; font-size: 13px; font-weight: 600;">
                            ğŸ¯ MODELS
                        </button>
                    </div>

                    <!-- TRAINING TAB -->
                    <div id="aiTrainingTab" class="ai-tab-content">
                        <div style="padding: 10px; background: #1a1a1a; border: 1px solid #333; border-radius: 4px; margin-bottom: 12px;">
                            <div style="font-size: 13px; color: #888; margin-bottom: 8px; font-weight: 700;">TRAIN NEW MODEL</div>

                            <div style="margin-bottom: 8px;">
                                <label style="font-size: 12px; color: #888; display: block; margin-bottom: 3px;">Training Symbol</label>
                                <input type="text" id="trainSymbol" value="SPY" placeholder="SPY, AAPL, etc."
                                       style="width: 100%; padding: 6px 8px; background: #252525; border: 1px solid #404040; color: #fff; font-size: 14px; border-radius: 3px;">
                            </div>

                            <div style="margin-bottom: 8px;">
                                <label style="font-size: 12px; color: #888; display: block; margin-bottom: 3px;">Training Period</label>
                                <select id="trainPeriod" style="width: 100%; padding: 6px 8px; background: #252525; border: 1px solid #404040; color: #fff; font-size: 14px; border-radius: 3px;">
                                    <option value="1y">1 Year</option>
                                    <option value="2y" selected>2 Years</option>
                                    <option value="5y">5 Years</option>
                                    <option value="10y">10 Years</option>
                                    <option value="max">Max Available</option>
                                </select>
                            </div>

                            <div style="margin-bottom: 8px;">
                                <label style="font-size: 12px; color: #888; display: block; margin-bottom: 3px;">Test Size %</label>
                                <input type="number" id="trainTestSize" value="20" min="10" max="40" step="5"
                                       style="width: 100%; padding: 6px 8px; background: #252525; border: 1px solid #404040; color: #fff; font-size: 14px; border-radius: 3px;">
                            </div>

                            <button id="trainModelBtn" class="btn btn-buy" onclick="trainModel()" style="width: 100%; font-size: 14px; padding: 10px; margin-top: 8px;">
                                ğŸš€ START TRAINING
                            </button>
                        </div>

                        <!-- Training Status -->
                        <div id="trainingStatus" style="padding: 10px; background: #1a1a1a; border: 1px solid #333; border-radius: 4px; display: none;">
                            <div style="font-size: 13px; color: #888; margin-bottom: 8px; font-weight: 700;">TRAINING PROGRESS</div>
                            <div id="trainingProgress" style="margin-bottom: 8px;">
                                <div style="background: #252525; height: 24px; border-radius: 3px; overflow: hidden; position: relative;">
                                    <div id="trainingProgressBar" style="background: linear-gradient(90deg, #22c55e, #16a34a); height: 100%; width: 0%; transition: width 0.3s; display: flex; align-items: center; justify-content: center;">
                                        <span id="trainingProgressText" style="font-size: 12px; font-weight: 700; color: #fff; position: absolute;">0%</span>
                                    </div>
                                </div>
                            </div>
                            <div id="trainingStatusText" style="font-size: 12px; color: #aaa; text-align: center;">Initializing...</div>
                            <div id="trainingMetrics" style="margin-top: 12px; padding: 8px; background: #252525; border-radius: 3px; display: none;">
                                <div style="font-size: 12px; color: #888; margin-bottom: 6px;">TRAINING RESULTS</div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                                    <div>
                                        <div style="font-size: 10px; color: #666;">ACCURACY</div>
                                        <div id="trainAccuracy" style="font-size: 16px; font-weight: 700; color: #22c55e;">--</div>
                                    </div>
                                    <div>
                                        <div style="font-size: 10px; color: #666;">SAMPLES</div>
                                        <div id="trainSamples" style="font-size: 16px; font-weight: 700; color: #60a5fa;">--</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- PREDICTIONS TAB -->
                    <div id="aiPredictionsTab" class="ai-tab-content" style="display: none;">
                        <div style="padding: 10px; background: #1a1a1a; border: 1px solid #333; border-radius: 4px; margin-bottom: 12px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <div style="font-size: 13px; color: #888; font-weight: 700;">WORKLIST PREDICTIONS</div>
                                <button class="btn btn-secondary" onclick="predictWorklist()" style="font-size: 11px; padding: 4px 8px;">
                                    ğŸ”„ REFRESH
                                </button>
                            </div>
                            <div id="worklistPredictions" style="max-height: 400px; overflow-y: auto;">
                                <div class="empty-state" style="padding: 20px; font-size: 13px;">Click REFRESH to get predictions</div>
                            </div>
                        </div>

                        <div style="padding: 10px; background: #1a1a1a; border: 1px solid #333; border-radius: 4px;">
                            <div style="font-size: 13px; color: #888; margin-bottom: 8px; font-weight: 700;">SINGLE SYMBOL PREDICTION</div>
                            <div style="display: flex; gap: 6px;">
                                <input type="text" id="singlePredictSymbol" value="" placeholder="Enter symbol..."
                                       style="flex: 1; padding: 6px 8px; background: #252525; border: 1px solid #404040; color: #fff; font-size: 14px; border-radius: 3px;">
                                <button class="btn btn-secondary" onclick="predictSingle()" style="font-size: 13px; padding: 6px 16px;">
                                    PREDICT
                                </button>
                            </div>
                            <div id="singlePredictionResult" style="margin-top: 12px; display: none;">
                                <!-- Results appear here -->
                            </div>
                        </div>
                    </div>

                    <!-- BACKTEST TAB -->
                    <div id="aiBacktestTab" class="ai-tab-content" style="display: none;">
                        <div style="padding: 10px; background: #1a1a1a; border: 1px solid #333; border-radius: 4px; margin-bottom: 12px;">
                            <div style="font-size: 13px; color: #888; margin-bottom: 8px; font-weight: 700;">BACKTEST CONFIGURATION</div>

                            <div style="margin-bottom: 8px;">
                                <label style="font-size: 12px; color: #888; display: block; margin-bottom: 3px;">Strategy</label>
                                <select id="backtestStrategy" style="width: 100%; padding: 6px 8px; background: #252525; border: 1px solid #404040; color: #fff; font-size: 14px; border-radius: 3px;">
                                    <option value="ai_predictor">AI Predictor</option>
                                    <option value="alpha_fusion">AlphaFusion V2</option>
                                    <option value="ma_cross">Moving Average Cross</option>
                                    <option value="rsi_strategy">RSI Strategy</option>
                                </select>
                            </div>

                            <div style="margin-bottom: 8px;">
                                <label style="font-size: 12px; color: #888; display: block; margin-bottom: 3px;">Symbols (comma separated)</label>
                                <input type="text" id="backtestSymbols" value="AAPL,MSFT,GOOGL" placeholder="AAPL,MSFT,GOOGL"
                                       style="width: 100%; padding: 6px 8px; background: #252525; border: 1px solid #404040; color: #fff; font-size: 14px; border-radius: 3px;">
                            </div>

                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 8px;">
                                <div>
                                    <label style="font-size: 12px; color: #888; display: block; margin-bottom: 3px;">Start Date</label>
                                    <input type="date" id="backtestStartDate" value="2024-01-01"
                                           style="width: 100%; padding: 6px 8px; background: #252525; border: 1px solid #404040; color: #fff; font-size: 14px; border-radius: 3px;">
                                </div>
                                <div>
                                    <label style="font-size: 12px; color: #888; display: block; margin-bottom: 3px;">End Date</label>
                                    <input type="date" id="backtestEndDate" value="2025-01-01"
                                           style="width: 100%; padding: 6px 8px; background: #252525; border: 1px solid #404040; color: #fff; font-size: 14px; border-radius: 3px;">
                                </div>
                            </div>

                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 8px;">
                                <div>
                                    <label style="font-size: 12px; color: #888; display: block; margin-bottom: 3px;">Initial Capital $</label>
                                    <input type="number" id="backtestCapital" value="10000" min="1000" step="1000"
                                           style="width: 100%; padding: 6px 8px; background: #252525; border: 1px solid #404040; color: #fff; font-size: 14px; border-radius: 3px;">
                                </div>
                                <div>
                                    <label style="font-size: 12px; color: #888; display: block; margin-bottom: 3px;">Position Size %</label>
                                    <input type="number" id="backtestPositionSize" value="20" min="5" max="100" step="5"
                                           style="width: 100%; padding: 6px 8px; background: #252525; border: 1px solid #404040; color: #fff; font-size: 14px; border-radius: 3px;">
                                </div>
                            </div>

                            <button id="runBacktestBtn" class="btn btn-buy" onclick="runBacktest()" style="width: 100%; font-size: 14px; padding: 10px; margin-top: 8px;">
                                ğŸ“Š RUN BACKTEST
                            </button>
                        </div>

                        <!-- Backtest Results -->
                        <div id="backtestResults" style="padding: 10px; background: #1a1a1a; border: 1px solid #333; border-radius: 4px; display: none;">
                            <div style="font-size: 13px; color: #888; margin-bottom: 8px; font-weight: 700;">BACKTEST RESULTS</div>
                            <div id="backtestMetrics" style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 12px;">
                                <!-- Metrics grid -->
                            </div>
                            <div id="backtestEquityCurve" style="margin-top: 12px;">
                                <!-- Equity curve chart -->
                            </div>
                        </div>
                    </div>

                    <!-- MODELS TAB -->
                    <div id="aiModelsTab" class="ai-tab-content" style="display: none;">
                        <div style="padding: 10px; background: #1a1a1a; border: 1px solid #333; border-radius: 4px;">
                            <div style="font-size: 13px; color: #888; margin-bottom: 8px; font-weight: 700;">MODEL PERFORMANCE</div>
                            <div id="modelsPerformance">
                                <div class="empty-state" style="padding: 20px; font-size: 13px;">No models available yet.<br>Train a model first!</div>
                            </div>
                        </div>
                    </div>
                </div>
            `,

            chart: (id) => `
                <div id="chart-${id}" class="chart-container">
                    <div class="empty-state">Chart will load here</div>
                </div>
            `
        };

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        //                     SYMBOL MANAGEMENT
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        function setCurrentSymbol(symbol) {
            currentSymbol = symbol.toUpperCase();
            document.getElementById('currentSymbolDisplay').textContent = currentSymbol;
            document.getElementById('orderSymbol').value = currentSymbol;

            // Subscribe to market data for new symbol
            subscribeToSymbol(currentSymbol);

            // Update all windows titles
            windows.forEach(win => {
                if (win.id === 'quote') {
                    win.title = `QUOTE - ${currentSymbol}`;
                    win.element.querySelector('.window-header span').textContent = win.title;
                } else if (win.id === 'level2') {
                    win.title = `LEVEL II - ${currentSymbol}`;
                    win.element.querySelector('.window-header span').textContent = win.title;
                } else if (win.id.startsWith('chart')) {
                    win.title = `CHART - ${currentSymbol}`;
                    win.element.querySelector('.window-header span').textContent = win.title;
                    // Update TradingView chart
                    updateChart(win.id, currentSymbol);
                }
            });

            // Refresh all market data
            loadPrice();
            loadLevel2();
            loadTimeSales();
            loadWorklist();
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        //                     API INTEGRATION
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        // Helper function to safely update element
        function safeUpdate(id, value) {
            const el = document.getElementById(id);
            if (el) {
                if (el.tagName === 'INPUT' || el.tagName === 'SELECT') {
                    el.value = value;
                } else {
                    el.textContent = value;
                }
                return true;
            }
            return false;
        }

        // Helper function to fetch API with error handling
        async function apiFetch(url) {
            try {
                const response = await fetch(API_BASE_URL + url);
                if (response.ok) {
                    apiAvailable = true;
                    return await response.json();
                } else if (response.status === 503) {
                    if (!demoModeLogged) {
                        console.log('%câš ï¸ IBKR not connected. Please click "Connect IBKR" in the menu.', 'color: #ef4444; font-weight: bold;');
                        demoModeLogged = true;
                    }
                    return null;
                } else {
                    apiAvailable = false;
                    return null;
                }
            } catch (error) {
                if (!demoModeLogged) {
                    console.log('%câš ï¸ API Server not available', 'color: #ef4444; font-weight: bold;');
                    demoModeLogged = true;
                }
                return null;
            }
        }

        // Subscribe to market data for a symbol
        async function subscribeToSymbol(symbol) {
            try {
                await fetch(API_BASE_URL + '/api/subscribe', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        symbol: symbol,
                        exchange: 'SMART',
                        data_types: ['quote', 'l2', 'trades']
                    })
                });
                console.log(`âœ“ Subscribed to ${symbol}`);
            } catch (error) {
                console.error(`Error subscribing to ${symbol}:`, error);
            }
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        //                     HALT DETECTION & MANAGEMENT
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        function checkForHalt(symbol, data) {
            const now = Date.now();

            // Check if we're in regular market hours (9:30 AM - 4:00 PM ET)
            const currentTime = new Date();
            const hours = currentTime.getHours();
            const minutes = currentTime.getMinutes();
            const timeInMinutes = hours * 60 + minutes;

            // Market hours: 9:30 AM (570 minutes) to 4:00 PM (960 minutes) ET
            // Note: This assumes your local time is ET. Adjust if needed.
            const marketOpen = 570;  // 9:30 AM
            const marketClose = 960; // 4:00 PM
            const isMarketHours = timeInMinutes >= marketOpen && timeInMinutes < marketClose;

            // Only check for halts during market hours
            // During pre-market/after-hours, bid/ask = 0 is normal, not a halt
            if (!isMarketHours) {
                // Not in market hours - don't detect halts
                if (haltState.isHalted) {
                    // Clear any existing halt state from previous session
                    haltState.isHalted = false;
                    hideHaltIndicator();
                }
                return;
            }

            // Detect halt conditions (ONLY during market hours):
            // 1. Bid and Ask are both 0 or -1
            // 2. OR no updates for more than 8 seconds
            const isDataHalted = (data.bid <= 0 && data.ask <= 0) ||
                                 (data.bid === -1 || data.ask === -1);

            const timeSinceLastUpdate = haltState.lastUpdateTime ? now - haltState.lastUpdateTime : 0;
            const isTimeoutHalt = timeSinceLastUpdate > 8000; // 8 seconds no update

            if ((isDataHalted || isTimeoutHalt) && !haltState.isHalted) {
                // Entering halt
                haltState.isHalted = true;
                haltState.haltTime = new Date();
                haltState.haltPrice = data.last || marketDataCache[symbol]?.last || 0;
                haltState.symbol = symbol;
                haltState.resumeTime = null;

                showHaltIndicator();
                console.log(`ğŸ›‘ HALT DETECTED: ${symbol} at $${haltState.haltPrice.toFixed(2)}`);

            } else if (!isDataHalted && !isTimeoutHalt && haltState.isHalted && data.bid > 0 && data.ask > 0) {
                // Resuming from halt
                haltState.resumeTime = new Date();
                const haltDuration = Math.floor((haltState.resumeTime - haltState.haltTime) / 1000);

                console.log(`âœ… RESUMED: ${symbol} after ${haltDuration}s halt`);

                // Show resume notification briefly, then hide
                updateHaltIndicator('resumed');
                setTimeout(() => {
                    haltState.isHalted = false;
                    hideHaltIndicator();
                }, 3000); // Show resume for 3 seconds
            }

            // Update last update time if we got valid data
            if (data.bid > 0 || data.ask > 0 || data.last > 0) {
                haltState.lastUpdateTime = now;
            }

            // Update halt indicator if already halted
            if (haltState.isHalted && haltState.resumeTime === null) {
                updateHaltIndicator('halted');
            }
        }

        function showHaltIndicator() {
            const indicator = document.getElementById('quoteHaltIndicator');
            if (indicator) {
                indicator.style.display = 'block';
            }
        }

        function hideHaltIndicator() {
            const indicator = document.getElementById('quoteHaltIndicator');
            if (indicator) {
                indicator.style.display = 'none';
            }
        }

        function updateHaltIndicator(status) {
            const indicator = document.getElementById('quoteHaltIndicator');
            const titleEl = document.getElementById('quoteHaltTitle');
            const infoEl = document.getElementById('quoteHaltInfo');

            if (!indicator || !titleEl || !infoEl) return;

            if (status === 'halted') {
                const haltDuration = Math.floor((Date.now() - haltState.haltTime) / 1000);
                const haltTimeStr = haltState.haltTime.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', second: '2-digit' });

                titleEl.textContent = 'ğŸ›‘ HALT';
                infoEl.innerHTML = `${haltTimeStr} â€¢ $${(haltState.haltPrice || 0).toFixed(2)} â€¢ ${haltDuration}s`;

                indicator.style.background = 'linear-gradient(135deg, #dc2626 0%, #991b1b 100%)';
                indicator.style.color = 'white';

            } else if (status === 'resumed') {
                const resumeTimeStr = haltState.resumeTime.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
                const haltDuration = Math.floor((haltState.resumeTime - haltState.haltTime) / 1000);

                titleEl.textContent = 'âœ… RESUMED';
                infoEl.innerHTML = `${resumeTimeStr} â€¢ ${haltDuration}s halt`;

                indicator.style.background = 'linear-gradient(135deg, #16a34a 0%, #15803d 100%)';
                indicator.style.color = 'white';
            }
        }

        async function loadPrice() {
            try {
                // Fetch ONLY from API
                const apiData = await apiFetch(`/api/price/${currentSymbol}`);
                if (!apiData || !apiData.data) {
                    // Clear displays if no data
                    safeUpdate('bidPrice', '--');
                    safeUpdate('askPrice', '--');
                    safeUpdate('lastPrice', '--');
                    safeUpdate('volumePrice', '--');
                    safeUpdate('highPrice', '--');
                    safeUpdate('lowPrice', '--');
                    safeUpdate('openPrice', '--');
                    safeUpdate('closePrice', '--');
                    safeUpdate('bidSize', '--');
                    safeUpdate('askSize', '--');
                    return;
                }

                const d = apiData.data;

                // Update UI elements safely
                safeUpdate('bidPrice', d.bid?.toFixed(2) || '--');
                safeUpdate('askPrice', d.ask?.toFixed(2) || '--');
                safeUpdate('lastPrice', d.last?.toFixed(2) || '--');
                safeUpdate('volumePrice', d.volume?.toLocaleString() || '--');
                safeUpdate('highPrice', d.high?.toFixed(2) || '--');
                safeUpdate('lowPrice', d.low?.toFixed(2) || '--');
                safeUpdate('openPrice', d.open?.toFixed(2) || '--');
                safeUpdate('closePrice', d.close?.toFixed(2) || '--');

                if (d.bid) safeUpdate('bidSize', `x ${d.bidSize || 0}`);
                if (d.ask) safeUpdate('askSize', `x ${d.askSize || 0}`);

                // Calculate and display change
                if (d.last && d.close) {
                    const change = d.last - d.close;
                    const changePct = ((change / d.close) * 100).toFixed(2);
                    const changeEl = document.getElementById('priceChange');
                    if (changeEl) {
                        changeEl.textContent = `${change >= 0 ? '+' : ''}${change.toFixed(2)} (${changePct}%)`;
                        changeEl.className = change >= 0 ? 'quote-stat-label positive' : 'quote-stat-label negative';
                    }
                }

                // Auto-set limit price to mid (only if field is not focused and empty/invalid)
                const orderTypeEl = document.getElementById('orderType');
                const orderPriceEl = document.getElementById('orderPrice');
                if (d.bid && d.ask && d.bid > 0 && d.ask > 0 && orderTypeEl && orderTypeEl.value === 'LIMIT') {
                    // Only update if user is NOT currently typing (field not focused) and field is empty or invalid
                    if (document.activeElement !== orderPriceEl &&
                        (!orderPriceEl.value || orderPriceEl.value === '' || parseFloat(orderPriceEl.value) <= 0)) {
                        const mid = ((d.bid + d.ask) / 2).toFixed(2);
                        safeUpdate('orderPrice', mid);
                    }
                }

                marketDataCache[currentSymbol] = d;

                // Update market price display in order panel
                safeUpdate('marketBid', d.bid?.toFixed(2) || '--');
                safeUpdate('marketLast', d.last?.toFixed(2) || '--');
                safeUpdate('marketAsk', d.ask?.toFixed(2) || '--');

                // Check for trading halt
                checkForHalt(currentSymbol, d);
            } catch (error) {
                console.error('Error loading price:', error);
            }
        }

        async function loadLevel2() {
            try {
                const bidsEl = document.getElementById('bidsDisplay');
                const asksEl = document.getElementById('asksDisplay');

                if (!bidsEl || !asksEl) return;

                // Fetch ONLY from API
                const apiData = await apiFetch(`/api/level2/${currentSymbol}`);
                if (!apiData) {
                    bidsEl.innerHTML = '<div class="empty-state">Connect to IBKR for Level 2 data</div>';
                    asksEl.innerHTML = '<div class="empty-state">Connect to IBKR for Level 2 data</div>';
                    return;
                }

                if (apiData.status === 'requesting') {
                    bidsEl.innerHTML = '<div class="empty-state">Requesting Level 2 data...</div>';
                    asksEl.innerHTML = '<div class="empty-state">Requesting Level 2 data...</div>';
                    return;
                }

                const data = apiData;

                let bidsHtml = '';
                if (data.bids && data.bids.length > 0) {
                    data.bids.slice(0, 20).forEach((bid, i) => {
                        bidsHtml += `
                            <div class="level2-row clickable" onclick="setOrderPrice(${bid.price}, 'BUY')">
                                <div>${bid.market_maker || ''}</div>
                                <div style="color: #22c55e;">${bid.size}</div>
                                <div class="level2-price" style="color: #22c55e; font-weight: 700;">${bid.price.toFixed(2)}</div>
                                <div style="color: #666;">1</div>
                            </div>
                        `;
                    });
                } else {
                    bidsHtml = '<div class="empty-state">No bid data</div>';
                }

                let asksHtml = '';
                if (data.asks && data.asks.length > 0) {
                    data.asks.slice(0, 20).forEach((ask, i) => {
                        asksHtml += `
                            <div class="level2-row clickable" onclick="setOrderPrice(${ask.price}, 'SELL')">
                                <div style="color: #666;">1</div>
                                <div class="level2-price" style="color: #ef4444; font-weight: 700;">${ask.price.toFixed(2)}</div>
                                <div style="color: #ef4444;">${ask.size}</div>
                                <div>${ask.market_maker || ''}</div>
                            </div>
                        `;
                    });
                } else {
                    asksHtml = '<div class="empty-state">No ask data</div>';
                }

                bidsEl.innerHTML = bidsHtml;
                asksEl.innerHTML = asksHtml;
            } catch (error) {
                console.error('Error loading level2:', error);
            }
        }

        async function loadTimeSales() {
            try {
                const displayEl = document.getElementById('timesalesDisplay');
                if (!displayEl) return;

                // Fetch ONLY from API
                const apiData = await apiFetch(`/api/timesales/${currentSymbol}?limit=50`);
                if (!apiData || !apiData.trades || apiData.trades.length === 0) {
                    displayEl.innerHTML = '<div class="empty-state">No trade data available. Subscribe to symbol for updates.</div>';
                    return;
                }

                const trades = apiData.trades;

                let html = '';
                if (trades.length > 0) {
                    trades.forEach(trade => {
                        const time = new Date(trade.timestamp).toLocaleTimeString('en-US', {
                            hour12: false,
                            hour: '2-digit',
                            minute: '2-digit',
                            second: '2-digit'
                        });
                        const side = trade.price > (marketDataCache[currentSymbol]?.last || trade.price) ? 'BUY' : 'SELL';
                        const sideColor = side === 'BUY' ? '#22c55e' : '#ef4444';

                        html += `
                            <div class="timesales-row">
                                <div class="timesales-time">${time}</div>
                                <div class="timesales-price" style="color: ${sideColor};">${trade.price.toFixed(2)}</div>
                                <div class="timesales-size">${trade.size}</div>
                                <div class="timesales-side" style="color: ${sideColor};">${side}</div>
                            </div>
                        `;
                    });
                } else {
                    html = '<div class="empty-state">No trade data</div>';
                }

                displayEl.innerHTML = html;
            } catch (error) {
                console.error('Error loading time & sales:', error);
            }
        }

        async function loadPositions() {
            try {
                const displayEl = document.getElementById('positionsDisplay');
                if (!displayEl) return;

                // Fetch ONLY from API
                const apiData = await apiFetch('/api/account');
                if (!apiData || !apiData.positions) {
                    displayEl.innerHTML = '<tr><td colspan="8" class="empty-state">Connect to IBKR to view positions</td></tr>';
                    return;
                }

                const positions = apiData.positions;

                if (positions.length > 0) {
                    let html = '';
                    positions.forEach(pos => {
                        const pnl = pos.unrealized_pnl || 0;
                        const pnlPct = pos.avg_cost ? ((pnl / (pos.avg_cost * Math.abs(pos.quantity))) * 100).toFixed(2) : 0;
                        const pnlClass = pnl >= 0 ? 'positive' : 'negative';
                        const side = pos.quantity > 0 ? 'LONG' : 'SHORT';
                        const sideClass = pos.quantity > 0 ? 'long' : 'short';

                        html += `
                            <tr class="clickable" onclick="setCurrentSymbol('${pos.symbol}')">
                                <td><strong>${pos.symbol}</strong></td>
                                <td><span class="pos-badge ${sideClass}">${side}</span></td>
                                <td>${Math.abs(pos.quantity)}</td>
                                <td>$${pos.avg_cost?.toFixed(2) || '0.00'}</td>
                                <td>$${((pos.market_value || 0) / Math.abs(pos.quantity)).toFixed(2)}</td>
                                <td class="${pnlClass}">$${pnl.toFixed(2)}</td>
                                <td class="${pnlClass}">${pnlPct}%</td>
                                <td><button class="action-btn" onclick="closePosition('${pos.symbol}', ${pos.quantity}); event.stopPropagation();">Close</button></td>
                            </tr>
                        `;
                    });
                    displayEl.innerHTML = html;
                    positionsCache = positions;
                } else {
                    displayEl.innerHTML = '<tr><td colspan="8" class="empty-state">No open positions</td></tr>';
                }
            } catch (error) {
                console.error('Error loading positions:', error);
            }
        }

        async function loadOrders() {
            const displayEl = document.getElementById('ordersDisplay');
            console.log('loadOrders called, displayEl:', displayEl);
            if (!displayEl) {
                console.error('ordersDisplay element not found!');
                return;
            }

            try {
                // Fetch real orders from IBKR
                const response = await fetch(API_BASE_URL + '/api/ibkr/orders');
                const data = await response.json();
                console.log('Orders API response:', data);

                if (data.orders && data.orders.length > 0) {
                    console.log(`Building HTML for ${data.orders.length} orders...`);
                    let html = '';
                    data.orders.forEach(order => {
                        const priceDisplay = order.limit_price ? `$${order.limit_price.toFixed(2)}` :
                                           order.stop_price ? `STOP $${order.stop_price.toFixed(2)}` : 'MKT';
                        html += `
                            <tr>
                                <td>${order.order_id}</td>
                                <td><strong onclick="selectSymbol('${order.symbol}')" style="cursor: pointer; color: #00c9ff;">${order.symbol}</strong></td>
                                <td class="${order.action === 'BUY' ? 'positive' : 'negative'}">${order.action}</td>
                                <td>${order.quantity}</td>
                                <td>${order.order_type}</td>
                                <td>${priceDisplay}</td>
                                <td>${order.status}</td>
                                <td>
                                    <button class="action-btn" onclick="cancelOrderIBKR(${order.order_id})">Cancel</button>
                                </td>
                            </tr>
                        `;
                    });
                    console.log('Built HTML string (first 500 chars):', html.substring(0, 500));
                    console.log('Element before update:', displayEl.innerHTML);
                    console.log('Setting innerHTML...');
                    displayEl.innerHTML = html;
                    console.log('After innerHTML update, element now contains:', displayEl.innerHTML.substring(0, 500));
                    console.log('Element child count:', displayEl.children.length);
                } else {
                    console.log('No orders in response, showing empty state');
                    displayEl.innerHTML = '<tr><td colspan="8" class="empty-state">No working orders</td></tr>';
                }
            } catch (error) {
                console.error('Error loading orders:', error);
                displayEl.innerHTML = '<tr><td colspan="8" class="empty-state" style="color: #ef4444;">âŒ Error loading orders</td></tr>';
            }
        }

        async function cancelOrderIBKR(orderId) {
            try {
                const response = await fetch(API_BASE_URL + '/api/ibkr/cancel-order', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ order_id: orderId })
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    console.log(`âœ“ Order ${orderId} cancelled`);
                    await loadOrders(); // Refresh orders display
                } else {
                    alert(`âŒ Failed to cancel order: ${data.detail || 'Unknown error'}`);
                }
            } catch (error) {
                console.error('Error cancelling order:', error);
                alert(`âŒ Error cancelling order: ${error.message}`);
            }
        }

        async function loadAccount() {
            try {
                // Fetch ONLY from API
                const accountData = await apiFetch('/api/account');
                if (!accountData || !accountData.summary) {
                    safeUpdate('accountNumber', '--');
                    safeUpdate('accountType', '--');
                    safeUpdate('equityValue', '--');
                    safeUpdate('buyingPower', '--');
                    safeUpdate('cashBalance', '--');
                    safeUpdate('marginUsed', '--');
                    safeUpdate('dayPL', '--');
                    safeUpdate('totalPL', '--');
                    safeUpdate('positionCount', '0');
                    return;
                }

                if (accountData.summary) {
                    const s = accountData.summary;

                    // Update account number and type
                    safeUpdate('accountNumber', s.account_id || 'DU1234567');
                    safeUpdate('accountType', s.account_type || 'Unknown');

                    // Update financial values
                    safeUpdate('equityValue', `$${(s.net_liquidation || 0).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`);
                    safeUpdate('buyingPower', `$${(s.buying_power || 0).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`);
                    safeUpdate('cashBalance', `$${(s.total_cash || 0).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`);
                    safeUpdate('marginUsed', `$${((s.net_liquidation - s.total_cash) || 0).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`);

                    const dayPL = accountData.total_unrealized_pnl || 0;
                    const dayPLEl = document.getElementById('dayPL');
                    if (dayPLEl) {
                        dayPLEl.textContent = `$${dayPL.toFixed(2)}`;
                        dayPLEl.className = dayPL >= 0 ? 'account-stat-value positive' : 'account-stat-value negative';
                    }

                    const totalPL = accountData.total_realized_pnl || 0;
                    const totalPLEl = document.getElementById('totalPL');
                    if (totalPLEl) {
                        totalPLEl.textContent = `$${totalPL.toFixed(2)}`;
                        totalPLEl.className = totalPL >= 0 ? 'account-stat-value positive' : 'account-stat-value negative';
                    }

                    safeUpdate('positionCount', accountData.positions?.length || 0);

                    // Handle day trades info for PDT accounts
                    const dayTradesStat = document.getElementById('dayTradesStat');
                    const dayTradesInfo = document.getElementById('dayTradesInfo');
                    const accountWarnings = document.getElementById('accountWarnings');

                    if (s.is_pdt) {
                        // Show day trades remaining
                        if (dayTradesStat) dayTradesStat.style.display = 'block';
                        if (s.day_trades_remaining !== null && s.day_trades_remaining !== undefined) {
                            safeUpdate('dayTradesRemaining', `${s.day_trades_remaining} Left`);

                            if (dayTradesInfo) {
                                dayTradesInfo.style.display = 'block';
                                dayTradesInfo.innerHTML = `Pattern Day Trader Account: ${s.day_trades_remaining} day trades remaining this week`;
                            }

                            // Show warning if running low
                            if (s.day_trades_remaining <= 1 && accountWarnings) {
                                accountWarnings.style.display = 'block';
                                accountWarnings.style.background = '#7f1d1d';
                                accountWarnings.style.color = '#fca5a5';
                                accountWarnings.innerHTML = s.day_trades_remaining === 0
                                    ? 'âš ï¸ DAY TRADE LIMIT REACHED - No day trades remaining!'
                                    : 'âš ï¸ WARNING - Only 1 day trade remaining!';
                            }
                        }
                    } else {
                        if (dayTradesStat) dayTradesStat.style.display = 'none';
                    }

                    // Show account capability warnings
                    if (s.account_capabilities && accountWarnings) {
                        const caps = s.account_capabilities;
                        if (caps.includes('NO_SHORT_SELLING')) {
                            accountWarnings.style.display = 'block';
                            accountWarnings.style.background = '#1e3a8a';
                            accountWarnings.style.color = '#93c5fd';
                            accountWarnings.innerHTML = 'âš ï¸ SHORT SELLING DISABLED for this account type';
                        }
                        if (caps.includes('T+2_SETTLEMENT')) {
                            if (dayTradesInfo) {
                                dayTradesInfo.style.display = 'block';
                                dayTradesInfo.innerHTML = 'Cash Account: T+2 settlement applies - avoid good faith violations';
                            }
                        }
                    }
                }
            } catch (error) {
                console.error('Error loading account:', error);
            }
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        //                     TRADING FUNCTIONS
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        function setQuantity(qty) {
            document.getElementById('orderQuantity').value = qty;
            calculateOrderCost();
        }

        window.setOrderPrice = function(priceType) {
            console.log('setOrderPrice called with:', priceType);

            const symbolEl = document.getElementById('orderSymbol');
            const priceEl = document.getElementById('orderPrice');
            const orderTypeEl = document.getElementById('orderType');

            if (!symbolEl || !priceEl || !orderTypeEl) {
                console.error('Order form elements not found');
                return;
            }

            const symbol = symbolEl.value;
            console.log('Current symbol:', symbol);

            if (!symbol || symbol.trim() === '') {
                alert('Please enter a symbol first');
                return;
            }

            // Get price from market data cache
            const marketData = marketDataCache[symbol];
            console.log('Market data for', symbol, ':', marketData);

            if (!marketData) {
                alert('No market data available for ' + symbol + '\n\nPlease wait for data to load.');
                return;
            }

            let price;
            if (priceType === 'bid') {
                price = marketData.bid;
            } else if (priceType === 'ask') {
                price = marketData.ask;
            } else if (priceType === 'last') {
                price = marketData.last;
            }

            console.log('Selected price:', price);

            if (!price || price <= 0) {
                alert(priceType.toUpperCase() + ' price not available for ' + symbol);
                return;
            }

            // Set order type to LIMIT
            orderTypeEl.value = 'LIMIT';

            // Set the price
            priceEl.value = price.toFixed(2);

            console.log('Price set to:', priceEl.value);

            // Update calculator
            calculateOrderCost();
        }

        function setAccountPercent(percent) {
            const symbol = document.getElementById('orderSymbol').value;
            const priceEl = document.getElementById('orderPrice');

            // Get account equity value
            let accountEquity = 100000; // Default value
            if (accountData && accountData.summary && accountData.summary.net_liquidation) {
                accountEquity = accountData.summary.net_liquidation;
            }

            // Get current price (try limit price first, then market data)
            let currentPrice = parseFloat(priceEl.value) || 0;

            // If no price in order form, try to get from market data cache
            if (currentPrice === 0 || priceEl.value === 'MARKET') {
                const data = marketDataCache[symbol];
                if (data && data.last) {
                    currentPrice = data.last;
                } else if (data && data.bid && data.ask) {
                    currentPrice = (data.bid + data.ask) / 2;
                }
            }

            if (currentPrice > 0) {
                // Calculate dollar amount based on percentage
                const dollarAmount = accountEquity * (percent / 100);

                // Calculate quantity (round down to whole shares)
                const quantity = Math.floor(dollarAmount / currentPrice);

                // Set the quantity
                document.getElementById('orderQuantity').value = quantity;

                // Update cost calculator
                calculateOrderCost();

                // Show confirmation
                console.log(`Account: $${accountEquity.toFixed(2)}, ${percent}% = $${dollarAmount.toFixed(2)}, Price: $${currentPrice.toFixed(2)}, Qty: ${quantity}`);
            } else {
                alert('Cannot calculate quantity: No price available for ' + symbol);
            }
        }

        function adjustPrice(amount) {
            const priceEl = document.getElementById('orderPrice');
            const currentPrice = parseFloat(priceEl.value) || 0;
            priceEl.value = (currentPrice + amount).toFixed(2);
        }

        function setOrderPrice(price, side) {
            document.getElementById('orderPrice').value = price.toFixed(2);
            // Optionally auto-focus quantity or submit
        }

        function handleOrderTypeChange() {
            const type = document.getElementById('orderType').value;
            const priceField = document.getElementById('orderPrice');

            if (type === 'MARKET') {
                priceField.disabled = true;
                priceField.value = 'MARKET';
            } else {
                priceField.disabled = false;
                if (priceField.value === 'MARKET' || priceField.value === '') {
                    const data = marketDataCache[currentSymbol];
                    if (data && data.bid && data.ask) {
                        priceField.value = ((data.bid + data.ask) / 2).toFixed(2);
                    } else {
                        // Clear field if no market data available
                        priceField.value = '';
                        priceField.placeholder = 'Enter limit price';
                    }
                }
            }
        }

        // Order Cost Calculator
        function calculateOrderCost() {
            try {
                const shares = parseInt(document.getElementById('orderQuantity')?.value) || 0;
                const price = parseFloat(document.getElementById('orderPrice')?.value) || 0;

                // Update shares display
                document.getElementById('calcShares').textContent = shares.toLocaleString();

                // Update price display
                document.getElementById('calcPrice').textContent = `$${price.toFixed(2)}`;

                // Calculate total cost (shares * price + commission)
                let cost = shares * price;
                const commission = Math.max(1, 0.005 * shares); // Min $1 or $0.005 per share
                cost += commission;

                // Update total display
                document.getElementById('calcTotal').textContent = `$${cost.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;

                return cost;
            } catch (error) {
                console.error('Error calculating order cost:', error);
                return 0;
            }
        }

        async function submitOrder(action) {
            const symbol = document.getElementById('orderSymbol').value;
            const quantity = document.getElementById('orderQuantity').value;
            const type = document.getElementById('orderType').value;
            const price = document.getElementById('orderPrice').value;
            const tif = document.getElementById('orderTIF').value;
            const extendedHours = document.getElementById('extendedHours').checked;
            const autoSubmit = document.getElementById('autoSubmitOrders').checked;

            // Validation - suppress alerts if auto-submit is enabled
            if (!symbol || symbol.trim() === '') {
                if (!autoSubmit) alert('Please enter a symbol');
                console.error('Validation error: No symbol entered');
                return;
            }

            if (!quantity || parseInt(quantity) <= 0) {
                if (!autoSubmit) alert('Please enter a valid quantity');
                console.error('Validation error: Invalid quantity');
                return;
            }

            let side, orderType;

            if (action === 'BUY_MARKET') {
                side = 'BUY';
                orderType = 'MARKET';
            } else if (action === 'SELL_MARKET') {
                side = 'SELL';
                orderType = 'MARKET';
            } else {
                side = action;
                orderType = type;
            }

            // Validate price for limit orders
            if (orderType === 'LIMIT' && (!price || isNaN(parseFloat(price)) || parseFloat(price) <= 0)) {
                if (!autoSubmit) alert('Please enter a valid limit price (not MARKET)');
                console.error('Validation error: Invalid limit price');
                return;
            }

            const orderDetails = `
ORDER DETAILS:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Side:     ${side}
Symbol:   ${symbol}
Quantity: ${quantity}
Type:     ${orderType}
Price:    ${orderType === 'MARKET' ? 'MARKET' : '$' + price}
TIF:      ${tif}
Extended: ${extendedHours ? 'YES (Pre/After Market)' : 'NO (Regular Hours)'}

Confirm order?`;

            // Check auto-submit setting - skip confirmation if enabled
            if (autoSubmit || window.confirm(orderDetails)) {
                try {
                    // Prepare order request
                    const orderRequest = {
                        symbol: symbol.trim().toUpperCase(),
                        action: side,
                        quantity: parseInt(quantity),
                        order_type: orderType,
                        limit_price: orderType !== 'MARKET' ? parseFloat(price) : null,
                        stop_price: null, // Add stop price support if needed
                        tif: tif,
                        extended_hours: extendedHours,
                        exchange: 'SMART'
                    };

                    console.log('Placing order:', orderRequest);

                    // Call API to place order
                    const response = await fetch(API_BASE_URL + '/api/ibkr/place-order', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(orderRequest)
                    });

                    const data = await response.json();

                    if (response.ok && data.success) {
                        // Show alert only if auto-submit is disabled (for faster trading)
                        if (!autoSubmit) {
                            alert(`âœ“ Order placed successfully!\n\nOrder ID: ${data.order_id}\nStatus: ${data.status}\n\n${data.message}`);
                        } else {
                            console.log(`âœ“ Order ${data.order_id} placed: ${side} ${quantity} ${symbol} @ ${orderType === 'MARKET' ? 'MARKET' : '$' + price}`);
                        }

                        // Clear form (but keep symbol for momentum trading)
                        // document.getElementById('orderSymbol').value = ''; // KEEP SYMBOL
                        document.getElementById('orderQuantity').value = '';
                        // Update price to current market price for next order
                        const data = marketDataCache[symbol];
                        if (data && data.bid && data.ask) {
                            document.getElementById('orderPrice').value = ((data.bid + data.ask) / 2).toFixed(2);
                        }

                        // Refresh orders display
                        await loadOrders();
                        await loadAccount();
                    } else {
                        // Handle error response
                        const errorMsg = data.detail || data.message || 'Unknown error';
                        if (!autoSubmit) {
                            alert(`âœ— Failed to place order\n\n${errorMsg}`);
                        } else {
                            console.error('âœ— Order failed:', errorMsg);
                        }
                    }
                } catch (error) {
                    console.error('Order error:', error);
                    if (!autoSubmit) {
                        alert(`âœ— Failed to place order\n\nError: ${error.message}\n\nMake sure IBKR is connected.`);
                    } else {
                        console.error('âœ— Order failed:', error.message);
                    }
                }
            }
        }

        async function submitOrderAtPrice(side, priceType) {
            const symbol = document.getElementById('orderSymbol').value;
            const quantity = document.getElementById('orderQuantity').value;
            const autoSubmit = document.getElementById('autoSubmitOrders')?.checked || false;

            // Validation - suppress alerts if auto-submit is enabled
            if (!symbol || symbol.trim() === '') {
                if (!autoSubmit) alert('Please enter a symbol');
                console.error('Validation error: No symbol entered');
                return;
            }

            if (!quantity || parseInt(quantity) <= 0) {
                if (!autoSubmit) alert('Please enter a valid quantity');
                console.error('Validation error: Invalid quantity');
                return;
            }

            // Get price from market data cache
            const marketData = marketDataCache[symbol];
            if (!marketData) {
                if (!autoSubmit) alert('No market data available for ' + symbol + '\n\nPlease wait for data to load.');
                console.error('Validation error: No market data for', symbol);
                return;
            }

            let price;
            if (priceType === 'BID') {
                price = marketData.bid;
                if (!price || price <= 0) {
                    if (!autoSubmit) alert('Bid price not available');
                    console.error('Validation error: Bid price not available');
                    return;
                }
            } else if (priceType === 'ASK') {
                price = marketData.ask;
                if (!price || price <= 0) {
                    if (!autoSubmit) alert('Ask price not available');
                    console.error('Validation error: Ask price not available');
                    return;
                }
            }

            // Set order type to LIMIT and fill in the price
            document.getElementById('orderType').value = 'LIMIT';
            document.getElementById('orderPrice').value = price.toFixed(2);

            // Submit the order using the regular submitOrder function
            await submitOrder(side);
        }

        async function closePosition(symbol, quantity) {
            const side = quantity > 0 ? 'SELL' : 'BUY';
            const qty = Math.abs(quantity);

            if (window.confirm(`Close position in ${symbol}?\n\n${side} ${qty} shares at MARKET`)) {
                try {
                    console.log('Closing position:', symbol, side, qty);

                    // Prepare market order to close position
                    const orderRequest = {
                        symbol: symbol,
                        action: side,
                        quantity: qty,
                        order_type: 'MARKET',
                        limit_price: null,
                        stop_price: null,
                        tif: 'DAY',
                        extended_hours: false,
                        exchange: 'SMART'
                    };

                    // Submit order to IBKR
                    const response = await fetch(API_BASE_URL + '/api/ibkr/place-order', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(orderRequest)
                    });

                    const data = await response.json();

                    if (response.ok && data.success) {
                        alert(`âœ“ Position close order placed!\n\nOrder ID: ${data.order_id}\n${side} ${qty} ${symbol} @ MARKET`);
                        console.log(`âœ“ Close order ${data.order_id} placed: ${side} ${qty} ${symbol}`);

                        // Refresh positions and orders
                        await loadPositions();
                        await loadOrders();
                        await loadAccount();
                    } else {
                        const errorMsg = data.detail || data.message || 'Unknown error';
                        alert(`âœ— Failed to close position\n\n${errorMsg}`);
                    }
                } catch (error) {
                    console.error('Close position error:', error);
                    alert(`âœ— Failed to close position\n\nError: ${error.message}\n\nMake sure IBKR is connected.`);
                }
            }
        }

        async function cancelOrder(orderId) {
            if (window.confirm('Cancel this order?')) {
                try {
                    console.log('Cancelling order:', orderId);

                    const response = await fetch(API_BASE_URL + '/api/ibkr/cancel-order', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ order_id: orderId })
                    });

                    const data = await response.json();

                    if (response.ok && data.success) {
                        alert(`âœ“ Order cancelled!\n\nOrder ID: ${orderId}\nStatus: ${data.status || 'Cancelled'}`);
                        console.log(`âœ“ Order ${orderId} cancelled`);

                        // Refresh orders and account
                        await loadOrders();
                        await loadAccount();
                    } else {
                        const errorMsg = data.detail || data.message || 'Unknown error';
                        alert(`âœ— Failed to cancel order\n\n${errorMsg}`);
                    }
                } catch (error) {
                    console.error('Cancel order error:', error);
                    alert(`âœ— Failed to cancel order\n\nError: ${error.message}\n\nMake sure IBKR is connected.`);
                }
            }
        }

        async function cancelAllOrders() {
            const autoSubmit = document.getElementById('autoSubmitOrders')?.checked || false;

            // Skip confirmation if auto-submit is enabled
            if (!autoSubmit && !window.confirm('âš ï¸ CANCEL ALL WORKING ORDERS?\n\nThis will cancel ALL open orders.\n\nAre you sure?')) {
                return;
            }

            try {
                // Fetch all current orders
                const response = await fetch(API_BASE_URL + '/api/ibkr/orders');
                const data = await response.json();

                if (!data.orders || data.orders.length === 0) {
                    if (!autoSubmit) alert('No orders to cancel');
                    console.log('No orders to cancel');
                    return;
                }

                console.log(`Cancelling ${data.orders.length} orders...`);
                let cancelled = 0;
                let failed = 0;

                // Cancel each order
                for (const order of data.orders) {
                    try {
                        const cancelResponse = await fetch(API_BASE_URL + '/api/ibkr/cancel-order', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ order_id: order.order_id })
                        });

                        const cancelData = await cancelResponse.json();

                        if (cancelResponse.ok && cancelData.success) {
                            cancelled++;
                            console.log(`âœ“ Cancelled order ${order.order_id}`);
                        } else {
                            failed++;
                            console.error(`âœ— Failed to cancel order ${order.order_id}:`, cancelData.detail);
                        }
                    } catch (error) {
                        failed++;
                        console.error(`âœ— Error cancelling order ${order.order_id}:`, error);
                    }
                }

                // Show results and refresh
                if (!autoSubmit) {
                    alert(`âœ“ Cancel All Complete\n\nCancelled: ${cancelled}\nFailed: ${failed}`);
                } else {
                    console.log(`âœ“ Cancel All Complete - Cancelled: ${cancelled}, Failed: ${failed}`);
                }
                await loadOrders();

            } catch (error) {
                console.error('Error cancelling all orders:', error);
                if (!autoSubmit) alert(`âŒ Error: ${error.message}`);
            }
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        //                     WORKLIST MANAGEMENT (UNIFIED BACKEND)
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        let worklistData = [];

        async function loadWorklist() {
            try {
                const response = await fetch(API_BASE_URL + '/api/worklist');
                const data = await response.json();

                if (data.success && data.data) {
                    worklistData = data.data;
                    updateWorklistDisplay();
                    updateWorklistStats();
                }
            } catch (error) {
                console.error('Failed to load worklist:', error);
            }
        }

        async function updateWorklistDisplay() {
            const display = document.getElementById('watchlistDisplay');
            if (!display) return;

            if (worklistData.length === 0) {
                display.innerHTML = '<div class="empty-state" style="padding: 20px; text-align: center;"><div style="font-size: 28px; margin-bottom: 8px;">ğŸ“‹</div><div style="font-size: 15px;">No symbols in worklist</div><div style="font-size: 13px; color: #888; margin-top: 4px;">Use Scanner or Add Symbol</div></div>';
                return;
            }

            let html = '<table class="data-table" style="font-size: 13px;"><thead><tr><th style="padding: 4px 6px;">Symbol</th><th style="padding: 4px 6px; text-align: right;">Price</th><th style="padding: 4px 6px; text-align: right;">Change</th><th style="padding: 4px 6px; text-align: center;">Pred</th><th style="padding: 4px 6px; text-align: right;">Conf</th><th style="padding: 4px 6px; text-align: center;">Action</th></tr></thead><tbody>';

            for (const item of worklistData) {
                const price = item.current_price ? `$${item.current_price.toFixed(2)}` : '-';
                const change = item.change_percent !== undefined ? item.change_percent.toFixed(2) + '%' : '-';
                const changeClass = item.change_percent !== undefined && item.change_percent >= 0 ? 'positive' : 'negative';

                let predBadge = '-';
                if (item.prediction === 'UP') {
                    predBadge = '<span style="background: #166534; color: #22c55e; padding: 2px 6px; border-radius: 2px; font-size: 12px; font-weight: 700;">â–² UP</span>';
                } else if (item.prediction === 'DOWN') {
                    predBadge = '<span style="background: #7f1d1d; color: #ef4444; padding: 2px 6px; border-radius: 2px; font-size: 12px; font-weight: 700;">â–¼ DOWN</span>';
                }

                const confidence = item.confidence ? item.confidence.toFixed(0) + '%' : '-';
                const liveIndicator = !item.has_live_data ? '<span style="color: #eab308; margin-left: 4px;" title="No live data">âš </span>' : '';

                html += `
                    <tr class="clickable" onclick="setCurrentSymbol('${item.symbol}')" style="font-size: 13px;">
                        <td style="padding: 4px 6px;"><strong>${item.symbol}</strong>${liveIndicator}</td>
                        <td style="padding: 4px 6px; text-align: right; font-family: monospace;">${price}</td>
                        <td class="${changeClass}" style="padding: 4px 6px; text-align: right; font-family: monospace;">${change}</td>
                        <td style="padding: 4px 6px; text-align: center;">${predBadge}</td>
                        <td style="padding: 4px 6px; text-align: right; font-family: monospace;">${confidence}</td>
                        <td style="padding: 4px 6px; text-align: center;">
                            <button onclick="event.stopPropagation(); removeFromWorklist('${item.symbol}')"
                                    style="background: #7f1d1d; color: #ef4444; border: none; padding: 2px 6px; border-radius: 2px; cursor: pointer; font-size: 12px; font-weight: 600;">âœ•</button>
                        </td>
                    </tr>
                `;
            }

            html += '</tbody></table>';
            display.innerHTML = html;
        }

        function updateWorklistStats() {
            const total = worklistData.length;
            const live = worklistData.filter(w => w.has_live_data).length;
            const bullish = worklistData.filter(w => w.prediction === 'UP').length;
            const bearish = worklistData.filter(w => w.prediction === 'DOWN').length;

            const safeUpdate = (id, value) => {
                const el = document.getElementById(id);
                if (el) el.textContent = value;
            };

            safeUpdate('statsTotal', total);
            safeUpdate('statsLive', live);
            safeUpdate('statsBullish', bullish);
            safeUpdate('statsBearish', bearish);
        }

        async function showAddSymbolDialog() {
            const symbol = window.prompt('Enter symbol to add to worklist:', '');
            if (!symbol) return;

            try {
                const response = await fetch(API_BASE_URL + '/api/worklist/add', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ symbol: symbol.toUpperCase(), exchange: 'SMART' })
                });

                const data = await response.json();
                if (data.success) {
                    await loadWorklist();
                    alert(`âœ“ ${symbol.toUpperCase()} added to worklist`);
                } else {
                    alert('Failed to add symbol: ' + (data.detail || 'Unknown error'));
                }
            } catch (error) {
                console.error('Failed to add symbol:', error);
                alert('Failed to add symbol');
            }
        }

        async function removeFromWorklist(symbol) {
            if (!window.confirm(`Remove ${symbol} from worklist?`)) return;

            try {
                const response = await fetch(API_BASE_URL + `/api/worklist/${symbol}`, {
                    method: 'DELETE'
                });

                const data = await response.json();
                if (data.success) {
                    await loadWorklist();
                } else {
                    alert('Failed to remove symbol');
                }
            } catch (error) {
                console.error('Failed to remove symbol:', error);
                alert('Failed to remove symbol');
            }
        }

        async function clearWorklist() {
            if (!window.confirm('âš ï¸ Clear entire worklist?\n\nThis will remove all symbols.')) return;

            try {
                const response = await fetch(API_BASE_URL + '/api/worklist/clear', {
                    method: 'DELETE'
                });

                const data = await response.json();
                if (data.success) {
                    await loadWorklist();
                    alert('âœ“ Worklist cleared');
                } else {
                    alert('Failed to clear worklist');
                }
            } catch (error) {
                console.error('Failed to clear worklist:', error);
                alert('Failed to clear worklist');
            }
        }

        async function showScannerDialog() {
            // Load scanner presets
            try {
                const response = await fetch(API_BASE_URL + '/api/scanner/ibkr/presets');
                const data = await response.json();

                if (!data.success || !data.data) {
                    alert('Failed to load scanner presets');
                    return;
                }

                const presets = data.data;
                let options = presets.map(p => `<option value="${p.id}">${p.name} - ${p.description}</option>`).join('');

                const html = `
                    <div style="padding: 16px; background: #1a1a1a; border: 2px solid #007acc; border-radius: 4px; width: 400px;">
                        <h3 style="margin: 0 0 12px 0; color: #fff; font-size: 18px;">IBKR Market Scanner</h3>
                        <select id="scannerSelect" style="width: 100%; padding: 8px; background: #252525; color: #fff; border: 1px solid #404040; margin-bottom: 12px;">
                            ${options}
                        </select>
                        <div style="display: flex; gap: 8px; justify-content: flex-end;">
                            <button onclick="closeScannerDialog()" class="btn btn-secondary">Cancel</button>
                            <button onclick="runScanner()" class="btn btn-primary" style="background: #007acc;">Run Scanner</button>
                        </div>
                        <div id="scannerResults" style="margin-top: 12px; max-height: 300px; overflow-y: auto;"></div>
                    </div>
                `;

                const dialog = document.createElement('div');
                dialog.id = 'scannerDialog';
                dialog.style.cssText = 'position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 10000; box-shadow: 0 0 20px rgba(0,0,0,0.5);';
                dialog.innerHTML = html;
                document.body.appendChild(dialog);

                // Add backdrop
                const backdrop = document.createElement('div');
                backdrop.id = 'scannerBackdrop';
                backdrop.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 9999;';
                backdrop.onclick = closeScannerDialog;
                document.body.appendChild(backdrop);

            } catch (error) {
                console.error('Failed to load scanner presets:', error);
                alert('Failed to load scanner presets');
            }
        }

        function closeScannerDialog() {
            const dialog = document.getElementById('scannerDialog');
            const backdrop = document.getElementById('scannerBackdrop');
            if (dialog) dialog.remove();
            if (backdrop) backdrop.remove();
        }

        async function runScanner() {
            const select = document.getElementById('scannerSelect');
            const resultsDiv = document.getElementById('scannerResults');

            if (!select || !resultsDiv) return;

            resultsDiv.innerHTML = '<div style="text-align: center; padding: 20px; color: #888;">Scanning...</div>';

            try {
                const response = await fetch(API_BASE_URL + '/api/scanner/ibkr/scan', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        scan_code: select.value,
                        instrument: 'STK',
                        location: 'STK.US.MAJOR',
                        num_rows: 50
                    })
                });

                const data = await response.json();

                console.log('Scanner response:', data);

                if (data.success && data.data && data.data.results) {
                    const results = data.data.results;
                    console.log('Scanner results:', results);

                    let html = `
                        <div style="margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center;">
                            <div style="font-size: 14px; color: #888;">Found ${results.length} symbols</div>
                            <button onclick="addAllScannerResults()" class="btn btn-primary" style="font-size: 14px; padding: 4px 12px; background: #007acc;">Add All to Worklist</button>
                        </div>
                        <table class="data-table" style="font-size: 13px;">
                            <thead>
                                <tr>
                                    <th style="padding: 4px;">Rank</th>
                                    <th style="padding: 4px;">Symbol</th>
                                    <th style="padding: 4px; text-align: right;">Price</th>
                                    <th style="padding: 4px; text-align: right;">Change %</th>
                                    <th style="padding: 4px; text-align: right;">Volume</th>
                                    <th style="padding: 4px; text-align: center;">
                                        <input type="checkbox" id="selectAllScanner" onchange="toggleAllScannerResults(this.checked)">
                                    </th>
                                </tr>
                            </thead>
                            <tbody>
                    `;

                    results.forEach((r, i) => {
                        const price = r.price ? r.price.toFixed(2) : 'N/A';
                        const changePercent = r.change_percent !== undefined ? r.change_percent.toFixed(2) : '0.00';
                        const volume = r.volume ? (r.volume / 1000000).toFixed(2) : '0.00';
                        const changeClass = (r.change_percent || 0) >= 0 ? 'positive' : 'negative';

                        html += `
                            <tr>
                                <td style="padding: 4px;">${r.rank || (i + 1)}</td>
                                <td style="padding: 4px;"><strong>${r.symbol || 'N/A'}</strong></td>
                                <td style="padding: 4px; text-align: right; font-family: monospace;">$${price}</td>
                                <td class="${changeClass}" style="padding: 4px; text-align: right; font-family: monospace;">${changePercent}%</td>
                                <td style="padding: 4px; text-align: right; font-family: monospace;">${volume}M</td>
                                <td style="padding: 4px; text-align: center;">
                                    <input type="checkbox" class="scanner-checkbox" value="${r.symbol}">
                                </td>
                            </tr>
                        `;
                    });

                    html += '</tbody></table>';
                    resultsDiv.innerHTML = html;
                } else {
                    console.error('Scanner failed - invalid response:', data);
                    resultsDiv.innerHTML = `<div style="text-align: center; padding: 20px; color: #ef4444;">
                        Scanner failed: ${data.message || data.detail || 'No results returned'}
                    </div>`;
                }
            } catch (error) {
                console.error('Scanner error:', error);
                resultsDiv.innerHTML = `<div style="text-align: center; padding: 20px; color: #ef4444;">
                    Scanner error: ${error.message}<br>
                    <small style="color: #888;">Check console for details</small>
                </div>`;
            }
        }

        function toggleAllScannerResults(checked) {
            document.querySelectorAll('.scanner-checkbox').forEach(cb => cb.checked = checked);
        }

        async function addAllScannerResults() {
            const checkboxes = document.querySelectorAll('.scanner-checkbox:checked');
            const symbols = Array.from(checkboxes).map(cb => cb.value);

            if (symbols.length === 0) {
                alert('No symbols selected');
                return;
            }

            try {
                const response = await fetch(API_BASE_URL + '/api/scanner/ibkr/add-to-worklist', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ symbols })
                });

                const data = await response.json();
                if (data.success) {
                    await loadWorklist();
                    closeScannerDialog();
                    alert(`âœ“ Added ${symbols.length} symbols to worklist`);
                } else {
                    alert('Failed to add symbols');
                }
            } catch (error) {
                console.error('Failed to add scanner results:', error);
                alert('Failed to add symbols');
            }
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        //                     AUTONOMOUS BOT CONTROL FUNCTIONS
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        let botStatusInterval = null;

        async function initBot() {
            try {
                // Get config from UI
                const watchlist = document.getElementById('botWatchlist').value.split(',').map(s => s.trim());
                const config = {
                    watchlist: watchlist,
                    max_position_size_usd: parseFloat(document.getElementById('botMaxPosition').value),
                    daily_loss_limit_usd: parseFloat(document.getElementById('botDailyLoss').value),
                    min_probability_threshold: parseFloat(document.getElementById('botMinProb').value) / 100,
                    max_positions: parseInt(document.getElementById('botMaxPositions').value)
                };

                const response = await fetch(API_BASE_URL + '/api/bot/init', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(config)
                });

                if (response.ok) {
                    const data = await response.json();
                    console.log('Bot initialized:', data);

                    // Update UI
                    document.getElementById('botStatusText').textContent = 'INITIALIZED';
                    document.getElementById('botStatusText').style.color = '#fbbf24';
                    document.getElementById('botStatusSubtext').textContent = 'Ready to start';

                    // Enable controls
                    document.getElementById('initBotBtn').disabled = true;
                    document.getElementById('startBotBtn').disabled = false;
                    document.getElementById('enableBotBtn').disabled = false;

                    // Start polling status
                    if (!botStatusInterval) {
                        botStatusInterval = setInterval(updateBotStatus, 2000);
                    }

                    alert('âœ“ Bot initialized successfully!');
                } else {
                    const error = await response.json();
                    alert('âœ— Failed to initialize bot: ' + error.detail);
                }
            } catch (error) {
                console.error('Error initializing bot:', error);
                alert('âœ— Error initializing bot: ' + error.message);
            }
        }

        async function startAutonomousBot() {
            try {
                const response = await fetch(API_BASE_URL + '/api/bot/start', { method: 'POST' });

                if (response.ok) {
                    const data = await response.json();
                    console.log('Bot started:', data);

                    document.getElementById('botStatusText').textContent = 'RUNNING';
                    document.getElementById('botStatusText').style.color = '#22c55e';
                    document.getElementById('botStatusSubtext').textContent = data.enabled ? 'Trading enabled' : 'Trading disabled (enable first)';

                    document.getElementById('startBotBtn').disabled = true;
                    document.getElementById('stopBotBtn').disabled = false;

                    alert('âœ“ Bot started successfully!');
                } else {
                    const error = await response.json();
                    alert('âœ— Failed to start bot: ' + error.detail);
                }
            } catch (error) {
                console.error('Error starting bot:', error);
                alert('âœ— Error starting bot: ' + error.message);
            }
        }

        async function stopAutonomousBot() {
            try {
                const response = await fetch(API_BASE_URL + '/api/bot/stop', { method: 'POST' });

                if (response.ok) {
                    const data = await response.json();
                    console.log('Bot stopped:', data);

                    document.getElementById('botStatusText').textContent = 'STOPPED';
                    document.getElementById('botStatusText').style.color = '#ef4444';
                    document.getElementById('botStatusSubtext').textContent = 'All positions closed';

                    document.getElementById('startBotBtn').disabled = false;
                    document.getElementById('stopBotBtn').disabled = true;

                    alert('âœ“ Bot stopped successfully!');
                } else {
                    const error = await response.json();
                    alert('âœ— Failed to stop bot: ' + error.detail);
                }
            } catch (error) {
                console.error('Error stopping bot:', error);
                alert('âœ— Error stopping bot: ' + error.message);
            }
        }

        async function enableBot() {
            try {
                const response = await fetch(API_BASE_URL + '/api/bot/enable', { method: 'POST' });

                if (response.ok) {
                    const data = await response.json();
                    console.log('Bot enabled:', data);

                    document.getElementById('botStatusSubtext').textContent = 'Trading ENABLED';
                    document.getElementById('enableBotBtn').textContent = 'âœ— DISABLE';
                    document.getElementById('enableBotBtn').onclick = disableBot;

                    alert('âœ“ Trading enabled! Bot will now execute trades.');
                } else {
                    const error = await response.json();
                    alert('âœ— Failed to enable bot: ' + error.detail);
                }
            } catch (error) {
                console.error('Error enabling bot:', error);
                alert('âœ— Error: ' + error.message);
            }
        }

        async function disableBot() {
            try {
                const response = await fetch(API_BASE_URL + '/api/bot/disable', { method: 'POST' });

                if (response.ok) {
                    const data = await response.json();
                    console.log('Bot disabled:', data);

                    document.getElementById('botStatusSubtext').textContent = 'Trading DISABLED';
                    document.getElementById('enableBotBtn').textContent = 'âœ“ ENABLE';
                    document.getElementById('enableBotBtn').onclick = enableBot;

                    alert('âœ“ Trading disabled. Bot will continue running but not execute trades.');
                } else {
                    const error = await response.json();
                    alert('âœ— Failed to disable bot: ' + error.detail);
                }
            } catch (error) {
                console.error('Error disabling bot:', error);
                alert('âœ— Error: ' + error.message);
            }
        }

        async function updateBotConfig() {
            try {
                const watchlist = document.getElementById('botWatchlist').value.split(',').map(s => s.trim());
                const config = {
                    watchlist: watchlist,
                    max_position_size_usd: parseFloat(document.getElementById('botMaxPosition').value),
                    daily_loss_limit_usd: parseFloat(document.getElementById('botDailyLoss').value),
                    min_probability_threshold: parseFloat(document.getElementById('botMinProb').value) / 100,
                    max_positions: parseInt(document.getElementById('botMaxPositions').value)
                };

                const response = await fetch(API_BASE_URL + '/api/bot/config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(config)
                });

                if (response.ok) {
                    const data = await response.json();
                    console.log('Config updated:', data);
                    alert('âœ“ Configuration updated successfully!');
                } else {
                    const error = await response.json();
                    alert('âœ— Failed to update config: ' + error.detail);
                }
            } catch (error) {
                console.error('Error updating config:', error);
                alert('âœ— Error: ' + error.message);
            }
        }

        async function updateBotStatus() {
            try {
                const response = await fetch(API_BASE_URL + '/api/bot/status');
                if (!response.ok) return;

                const data = await response.json();

                // Update statistics
                if (data.total_signals_generated !== undefined) {
                    document.getElementById('botSignals').textContent = data.total_signals_generated;
                }
                if (data.total_trades_executed !== undefined) {
                    document.getElementById('botTrades').textContent = data.total_trades_executed;
                }
                if (data.trading_engine && data.trading_engine.open_positions !== undefined) {
                    document.getElementById('botPositions').textContent = data.trading_engine.open_positions;
                }
                if (data.trading_engine && data.trading_engine.daily_pnl !== undefined) {
                    const pnl = data.trading_engine.daily_pnl;
                    const pnlElem = document.getElementById('botDailyPnl');
                    pnlElem.textContent = '$' + pnl.toFixed(2);
                    pnlElem.style.color = pnl >= 0 ? '#22c55e' : '#ef4444';
                }

                // Update 3-5-7 risk management display
                if (data.trading_engine && data.trading_engine.weekly_pnl !== undefined) {
                    const weeklyPnl = data.trading_engine.weekly_pnl;
                    const weeklyElem = document.getElementById('botWeeklyPnl');
                    weeklyElem.textContent = '$' + weeklyPnl.toFixed(2);
                    weeklyElem.style.color = weeklyPnl >= 0 ? '#22c55e' : '#ef4444';
                }
                if (data.config && data.config.account_size && data.config.max_risk_per_trade_pct) {
                    const maxRiskPerTrade = (data.config.account_size * data.config.max_risk_per_trade_pct / 100).toFixed(2);
                    document.getElementById('botMaxRisk').textContent = '$' + maxRiskPerTrade;
                } else if (data.trading_engine && data.trading_engine.account_size && data.trading_engine.max_risk_per_trade_pct) {
                    const maxRiskPerTrade = (data.trading_engine.account_size * data.trading_engine.max_risk_per_trade_pct / 100).toFixed(2);
                    document.getElementById('botMaxRisk').textContent = '$' + maxRiskPerTrade;
                }

                // Update predictions display
                if (data.last_predictions && Object.keys(data.last_predictions).length > 0) {
                    const predictionsDiv = document.getElementById('botPredictionsDisplay');
                    let html = '';
                    for (const [symbol, pred] of Object.entries(data.last_predictions)) {
                        const prob = (pred.p_final * 100).toFixed(1);
                        const reliability = (pred.reliability * 100).toFixed(0);
                        const color = pred.p_final > 0.5 ? '#22c55e' : pred.p_final < 0.5 ? '#ef4444' : '#888';

                        html += `
                            <div style="padding: 4px; margin-bottom: 4px; background: #1a1a1a; border-left: 3px solid ${color};">
                                <div style="display: flex; justify-content: space-between;">
                                    <span style="font-weight: 700;">${symbol}</span>
                                    <span style="color: ${color};">${prob}%</span>
                                </div>
                                <div style="font-size: 12px; color: #888; margin-top: 2px;">
                                    Reliability: ${reliability}% | ${new Date(pred.timestamp * 1000).toLocaleTimeString()}
                                </div>
                            </div>
                        `;
                    }
                    predictionsDiv.innerHTML = html;
                }

                // Update positions display
                if (data.trading_engine && data.trading_engine.positions && Object.keys(data.trading_engine.positions).length > 0) {
                    const positionsDiv = document.getElementById('botPositionsDisplay');
                    let html = '';
                    for (const [symbol, pos] of Object.entries(data.trading_engine.positions)) {
                        const pnl = pos.unrealized_pnl || 0;
                        const pnlPct = pos.unrealized_pnl_pct || 0;
                        const pnlColor = pnl >= 0 ? '#22c55e' : '#ef4444';

                        html += `
                            <div style="padding: 4px; margin-bottom: 4px; background: #1a1a1a; border-left: 3px solid ${pnlColor};">
                                <div style="display: flex; justify-content: space-between;">
                                    <span style="font-weight: 700;">${symbol}</span>
                                    <span style="color: ${pnlColor};">${pnl >= 0 ? '+' : ''}${pnl.toFixed(2)}</span>
                                </div>
                                <div style="font-size: 12px; color: #888; margin-top: 2px;">
                                    ${pos.quantity} @ $${pos.entry_price.toFixed(2)} | ${pnlPct >= 0 ? '+' : ''}${pnlPct.toFixed(2)}%
                                </div>
                            </div>
                        `;
                    }
                    positionsDiv.innerHTML = html;
                } else if (data.initialized) {
                    document.getElementById('botPositionsDisplay').innerHTML = '<div class="empty-state" style="padding: 16px; font-size: 13px;">No positions</div>';
                }

            } catch (error) {
                console.error('Error updating bot status:', error);
            }
        }

        // Legacy function names for compatibility
        async function startBot() {
            return startAutonomousBot();
        }

        async function stopBot() {
            return stopAutonomousBot();
        }

        async function getPrediction() {
            try {
                const response = await fetch(API_BASE_URL + '/api/ai/predict', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ symbol: currentSymbol })
                });
                const data = await response.json();

                const display = document.getElementById('aiPredictionDisplay');
                const signal = data.signal || 'NEUTRAL';
                const signalColor = signal === 'BUY' ? '#22c55e' : signal === 'SELL' ? '#ef4444' : '#888';

                display.innerHTML = `
                    <div style="padding: 16px; background: #252525; border: 1px solid #333; border-radius: 2px;">
                        <div style="text-align: center; margin-bottom: 12px;">
                            <div style="font-size: 28px; font-weight: 700; color: ${signalColor};">${signal}</div>
                            <div style="font-size: 13px; color: #888; margin-top: 4px;">CONFIDENCE: ${data.confidence || 0}%</div>
                        </div>
                        <div style="font-size: 14px; color: #aaa; line-height: 1.4;">
                            ${data.reason || 'No analysis available'}
                        </div>
                    </div>
                `;
            } catch (error) {
                console.error('Error getting prediction:', error);
                document.getElementById('aiPredictionDisplay').innerHTML = '<div class="empty-state">AI service unavailable</div>';
            }
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        //                     AI CONTROL PANEL FUNCTIONS
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        let currentTrainingId = null;
        let trainingCheckInterval = null;
        let currentBacktestId = null;
        let backtestCheckInterval = null;

        // Tab switching
        function switchAITab(tab) {
            // Hide all tabs
            document.getElementById('aiTrainingTab').style.display = 'none';
            document.getElementById('aiPredictionsTab').style.display = 'none';
            document.getElementById('aiBacktestTab').style.display = 'none';
            document.getElementById('aiModelsTab').style.display = 'none';

            // Reset all tab buttons
            document.querySelectorAll('.ai-tab').forEach(btn => {
                btn.style.background = '#1a1a1a';
                btn.style.color = '#888';
            });

            // Show selected tab
            if (tab === 'training') {
                document.getElementById('aiTrainingTab').style.display = 'block';
                document.getElementById('aiTabTraining').style.background = '#2d2d2d';
                document.getElementById('aiTabTraining').style.color = '#fff';
            } else if (tab === 'predictions') {
                document.getElementById('aiPredictionsTab').style.display = 'block';
                document.getElementById('aiTabPredictions').style.background = '#2d2d2d';
                document.getElementById('aiTabPredictions').style.color = '#fff';
            } else if (tab === 'backtest') {
                document.getElementById('aiBacktestTab').style.display = 'block';
                document.getElementById('aiTabBacktest').style.background = '#2d2d2d';
                document.getElementById('aiTabBacktest').style.color = '#fff';
            } else if (tab === 'models') {
                document.getElementById('aiModelsTab').style.display = 'block';
                document.getElementById('aiTabModels').style.background = '#2d2d2d';
                document.getElementById('aiTabModels').style.color = '#fff';
                loadModelsPerformance();
            }
        }

        // TRAINING FUNCTIONS
        async function trainModel() {
            const symbol = document.getElementById('trainSymbol').value.toUpperCase();
            const period = document.getElementById('trainPeriod').value;
            const testSize = parseFloat(document.getElementById('trainTestSize').value) / 100;

            if (!symbol) {
                alert('Please enter a training symbol');
                return;
            }

            try {
                // Disable button
                const btn = document.getElementById('trainModelBtn');
                btn.disabled = true;
                btn.textContent = 'â³ TRAINING...';

                // Show training status
                document.getElementById('trainingStatus').style.display = 'block';
                document.getElementById('trainingMetrics').style.display = 'none';

                const response = await fetch(API_BASE_URL + '/api/ai/models/train', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        symbol: symbol,
                        period: period,
                        test_size: testSize
                    })
                });

                const data = await response.json();
                console.log('Training started:', data);

                if (data.success && data.data.training_id) {
                    currentTrainingId = data.data.training_id;

                    // Start polling for progress
                    if (trainingCheckInterval) clearInterval(trainingCheckInterval);
                    trainingCheckInterval = setInterval(checkTrainingProgress, 1000);
                } else {
                    throw new Error('Failed to start training');
                }

            } catch (error) {
                console.error('Error starting training:', error);
                alert('Error starting training: ' + error.message);

                // Re-enable button
                const btn = document.getElementById('trainModelBtn');
                btn.disabled = false;
                btn.textContent = 'ğŸš€ START TRAINING';
            }
        }

        async function checkTrainingProgress() {
            if (!currentTrainingId) return;

            try {
                // Get training session status from server
                const response = await fetch(API_BASE_URL + '/api/ai/models/train/' + currentTrainingId + '/status');

                if (!response.ok) {
                    // Session might not exist yet, continue polling
                    return;
                }

                const data = await response.json();
                const session = data.session || {};

                // Update progress bar
                const progress = session.progress || 0;
                document.getElementById('trainingProgressBar').style.width = progress + '%';
                document.getElementById('trainingProgressText').textContent = progress + '%';

                // Update status text
                const statusText = session.status || 'training';
                document.getElementById('trainingStatusText').textContent = statusText.replace('_', ' ').toUpperCase();

                // Check if completed
                if (session.status === 'completed') {
                    clearInterval(trainingCheckInterval);
                    trainingCheckInterval = null;

                    // Show metrics
                    if (session.metrics) {
                        document.getElementById('trainAccuracy').textContent = (session.metrics.accuracy * 100).toFixed(2) + '%';
                        document.getElementById('trainSamples').textContent = session.metrics.samples || 0;
                        document.getElementById('trainingMetrics').style.display = 'block';
                    }

                    // Re-enable button
                    const btn = document.getElementById('trainModelBtn');
                    btn.disabled = false;
                    btn.textContent = 'ğŸš€ START TRAINING';

                    alert('âœ“ Training completed!\n\nAccuracy: ' + (session.metrics.accuracy * 100).toFixed(2) + '%\nSamples: ' + session.metrics.samples);

                } else if (session.status === 'failed') {
                    clearInterval(trainingCheckInterval);
                    trainingCheckInterval = null;

                    document.getElementById('trainingStatusText').textContent = 'FAILED: ' + (session.error || 'Unknown error');

                    // Re-enable button
                    const btn = document.getElementById('trainModelBtn');
                    btn.disabled = false;
                    btn.textContent = 'ğŸš€ START TRAINING';

                    alert('âœ— Training failed: ' + (session.error || 'Unknown error'));
                }

            } catch (error) {
                console.error('Error checking training progress:', error);
            }
        }

        // PREDICTION FUNCTIONS
        async function predictWorklist() {
            const worklistDiv = document.getElementById('worklistPredictions');
            worklistDiv.innerHTML = '<div class="empty-state" style="padding: 20px;">Loading predictions...</div>';

            try {
                // Get worklist
                const worklistResponse = await fetch(API_BASE_URL + '/api/worklist');
                const worklistData = await worklistResponse.json();

                if (!worklistData.success || !worklistData.data.length) {
                    worklistDiv.innerHTML = '<div class="empty-state" style="padding: 20px;">Worklist is empty</div>';
                    return;
                }

                let html = '';

                // Get predictions for each symbol
                for (const item of worklistData.data) {
                    const symbol = item.symbol;

                    try {
                        const predResponse = await fetch(API_BASE_URL + '/api/ai/predict', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ symbol: symbol })
                        });

                        const predData = await predResponse.json();

                        // Determine color
                        let signalColor = '#888';
                        if (predData.signal && predData.signal.includes('BULLISH')) signalColor = '#22c55e';
                        else if (predData.signal && predData.signal.includes('BEARISH')) signalColor = '#ef4444';

                        html += `
                            <div style="padding: 8px; margin-bottom: 6px; background: #252525; border-radius: 3px; border-left: 3px solid ${signalColor};">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                                    <div style="font-size: 14px; font-weight: 700; color: #fff;">${symbol}</div>
                                    <div style="font-size: 13px; font-weight: 600; color: ${signalColor};">${predData.signal || 'NEUTRAL'}</div>
                                </div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 6px; font-size: 11px;">
                                    <div>
                                        <span style="color: #666;">Confidence:</span>
                                        <span style="color: #aaa; font-weight: 600;">${(predData.confidence * 100).toFixed(1)}%</span>
                                    </div>
                                    <div>
                                        <span style="color: #666;">Prob Up:</span>
                                        <span style="color: #aaa; font-weight: 600;">${(predData.prob_up * 100).toFixed(1)}%</span>
                                    </div>
                                </div>
                            </div>
                        `;

                    } catch (error) {
                        console.error('Error predicting', symbol, ':', error);
                        html += `
                            <div style="padding: 8px; margin-bottom: 6px; background: #252525; border-radius: 3px;">
                                <div style="font-size: 14px; font-weight: 700; color: #fff;">${symbol}</div>
                                <div style="font-size: 11px; color: #ef4444;">Prediction failed</div>
                            </div>
                        `;
                    }
                }

                worklistDiv.innerHTML = html;

            } catch (error) {
                console.error('Error getting worklist predictions:', error);
                worklistDiv.innerHTML = '<div class="empty-state" style="padding: 20px;">Error loading predictions</div>';
            }
        }

        async function predictSingle() {
            const symbol = document.getElementById('singlePredictSymbol').value.toUpperCase();

            if (!symbol) {
                alert('Please enter a symbol');
                return;
            }

            const resultDiv = document.getElementById('singlePredictionResult');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '<div style="padding: 12px; text-align: center; color: #888;">Loading...</div>';

            try {
                const response = await fetch(API_BASE_URL + '/api/ai/predict', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ symbol: symbol })
                });

                const data = await response.json();

                // Determine color
                let signalColor = '#888';
                if (data.signal && data.signal.includes('BULLISH')) signalColor = '#22c55e';
                else if (data.signal && data.signal.includes('BEARISH')) signalColor = '#ef4444';

                resultDiv.innerHTML = `
                    <div style="padding: 12px; background: #252525; border-radius: 4px; border-left: 4px solid ${signalColor};">
                        <div style="font-size: 18px; font-weight: 700; color: ${signalColor}; margin-bottom: 8px; text-align: center;">
                            ${data.signal || 'NEUTRAL'}
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 12px;">
                            <div style="text-align: center;">
                                <div style="font-size: 10px; color: #666; margin-bottom: 2px;">CONFIDENCE</div>
                                <div style="font-size: 20px; font-weight: 700; color: #fff;">${(data.confidence * 100).toFixed(1)}%</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 10px; color: #666; margin-bottom: 2px;">PROB UP</div>
                                <div style="font-size: 20px; font-weight: 700; color: #22c55e;">${(data.prob_up * 100).toFixed(1)}%</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 10px; color: #666; margin-bottom: 2px;">PROB DOWN</div>
                                <div style="font-size: 20px; font-weight: 700; color: #ef4444;">${(data.prob_down * 100).toFixed(1)}%</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 10px; color: #666; margin-bottom: 2px;">TIMESTAMP</div>
                                <div style="font-size: 11px; color: #aaa;">${new Date(data.timestamp).toLocaleTimeString()}</div>
                            </div>
                        </div>
                        ${data.signal_detail ? `<div style="margin-top: 8px; padding: 6px; background: #1a1a1a; border-radius: 3px; font-size: 11px; color: #888; text-align: center;">${data.signal_detail}</div>` : ''}
                    </div>
                `;

            } catch (error) {
                console.error('Error getting prediction:', error);
                resultDiv.innerHTML = '<div style="padding: 12px; color: #ef4444; text-align: center;">Prediction failed: ' + error.message + '</div>';
            }
        }

        // BACKTEST FUNCTIONS
        async function runBacktest() {
            const strategy = document.getElementById('backtestStrategy').value;
            const symbols = document.getElementById('backtestSymbols').value.split(',').map(s => s.trim().toUpperCase());
            const startDate = document.getElementById('backtestStartDate').value;
            const endDate = document.getElementById('backtestEndDate').value;
            const capital = parseFloat(document.getElementById('backtestCapital').value);
            const positionSize = parseFloat(document.getElementById('backtestPositionSize').value) / 100;

            if (!symbols.length || !startDate || !endDate) {
                alert('Please fill in all backtest parameters');
                return;
            }

            try {
                // Disable button
                const btn = document.getElementById('runBacktestBtn');
                btn.disabled = true;
                btn.textContent = 'â³ RUNNING...';

                // Show results section
                document.getElementById('backtestResults').style.display = 'block';
                document.getElementById('backtestMetrics').innerHTML = '<div style="padding: 20px; text-align: center; color: #888;">Running backtest...</div>';

                const response = await fetch(API_BASE_URL + '/api/backtest/run', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        strategy: strategy,
                        symbols: symbols,
                        start_date: startDate,
                        end_date: endDate,
                        initial_capital: capital,
                        position_size_pct: positionSize
                    })
                });

                const data = await response.json();
                console.log('Backtest started:', data);

                if (data.success && data.data.backtest_id) {
                    currentBacktestId = data.data.backtest_id;

                    // Start polling for results
                    if (backtestCheckInterval) clearInterval(backtestCheckInterval);
                    backtestCheckInterval = setInterval(checkBacktestResults, 2000);
                } else {
                    throw new Error('Failed to start backtest');
                }

            } catch (error) {
                console.error('Error starting backtest:', error);
                alert('Error starting backtest: ' + error.message);

                // Re-enable button
                const btn = document.getElementById('runBacktestBtn');
                btn.disabled = false;
                btn.textContent = 'ğŸ“Š RUN BACKTEST';
            }
        }

        async function checkBacktestResults() {
            if (!currentBacktestId) return;

            try {
                const response = await fetch(API_BASE_URL + '/api/backtest/' + currentBacktestId + '/results');
                const data = await response.json();

                if (!data.success) return;

                const bt = data.data;

                // Check if completed
                if (bt.status === 'completed') {
                    clearInterval(backtestCheckInterval);
                    backtestCheckInterval = null;

                    // Display metrics
                    const metrics = bt.metrics;
                    document.getElementById('backtestMetrics').innerHTML = `
                        <div style="padding: 8px; background: #252525; border-radius: 3px; text-align: center;">
                            <div style="font-size: 10px; color: #666;">TOTAL RETURN</div>
                            <div style="font-size: 20px; font-weight: 700; color: ${metrics.total_return >= 0 ? '#22c55e' : '#ef4444'};">
                                ${metrics.total_return >= 0 ? '+' : ''}${metrics.total_return.toFixed(2)}%
                            </div>
                        </div>
                        <div style="padding: 8px; background: #252525; border-radius: 3px; text-align: center;">
                            <div style="font-size: 10px; color: #666;">SHARPE RATIO</div>
                            <div style="font-size: 20px; font-weight: 700; color: #60a5fa;">${metrics.sharpe_ratio.toFixed(2)}</div>
                        </div>
                        <div style="padding: 8px; background: #252525; border-radius: 3px; text-align: center;">
                            <div style="font-size: 10px; color: #666;">MAX DRAWDOWN</div>
                            <div style="font-size: 20px; font-weight: 700; color: #ef4444;">${metrics.max_drawdown.toFixed(2)}%</div>
                        </div>
                        <div style="padding: 8px; background: #252525; border-radius: 3px; text-align: center;">
                            <div style="font-size: 10px; color: #666;">WIN RATE</div>
                            <div style="font-size: 20px; font-weight: 700; color: #22c55e;">${(metrics.win_rate * 100).toFixed(1)}%</div>
                        </div>
                        <div style="padding: 8px; background: #252525; border-radius: 3px; text-align: center;">
                            <div style="font-size: 10px; color: #666;">TOTAL TRADES</div>
                            <div style="font-size: 20px; font-weight: 700; color: #fff;">${metrics.total_trades}</div>
                        </div>
                        <div style="padding: 8px; background: #252525; border-radius: 3px; text-align: center;">
                            <div style="font-size: 10px; color: #666;">PROFITABLE</div>
                            <div style="font-size: 20px; font-weight: 700; color: #22c55e;">${metrics.profitable_trades}</div>
                        </div>
                    `;

                    // Re-enable button
                    const btn = document.getElementById('runBacktestBtn');
                    btn.disabled = false;
                    btn.textContent = 'ğŸ“Š RUN BACKTEST';

                    alert('âœ“ Backtest completed!\n\nTotal Return: ' + metrics.total_return.toFixed(2) + '%\nWin Rate: ' + (metrics.win_rate * 100).toFixed(1) + '%');
                }

            } catch (error) {
                console.error('Error checking backtest results:', error);
            }
        }

        // Open AI Control Panel window
        function openAIControlPanel() {
            // Check if window already exists
            const existing = windows.find(w => w.id === 'aicontrol');
            if (existing) {
                existing.focus();
                return;
            }

            // Create new AI Control Panel window (centered, large size)
            createWindow('aicontrol', 'ğŸ¤– AI CONTROL PANEL', windowTemplates.aicontrol, 300, 100, 680, 600);
        }

        // MODELS PERFORMANCE
        async function loadModelsPerformance() {
            const perfDiv = document.getElementById('modelsPerformance');

            try {
                const response = await fetch(API_BASE_URL + '/api/ai/models/performance');
                const data = await response.json();

                if (!data.success || !data.data || !data.data.length) {
                    perfDiv.innerHTML = '<div class="empty-state" style="padding: 20px; font-size: 13px;">No models available yet.<br>Train a model first!</div>';
                    return;
                }

                let html = '';
                for (const model of data.data) {
                    html += `
                        <div style="padding: 10px; margin-bottom: 8px; background: #252525; border-radius: 4px; border-left: 3px solid #60a5fa;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                                <div style="font-size: 14px; font-weight: 700; color: #fff;">${model.name}</div>
                                <div style="font-size: 11px; color: #888;">${model.type}</div>
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; font-size: 11px; margin-bottom: 6px;">
                                <div>
                                    <span style="color: #666;">Accuracy:</span>
                                    <span style="color: #22c55e; font-weight: 600;">${(model.accuracy * 100).toFixed(1)}%</span>
                                </div>
                                <div>
                                    <span style="color: #666;">Win Rate:</span>
                                    <span style="color: #22c55e; font-weight: 600;">${(model.win_rate * 100).toFixed(1)}%</span>
                                </div>
                                <div>
                                    <span style="color: #666;">Sharpe:</span>
                                    <span style="color: #60a5fa; font-weight: 600;">${model.sharpe_ratio.toFixed(2)}</span>
                                </div>
                            </div>
                            <div style="font-size: 10px; color: #666;">Trades: ${model.total_trades} (${model.profitable_trades} profitable) â€¢ Avg Profit: $${model.avg_profit.toFixed(2)}</div>
                        </div>
                    `;
                }

                perfDiv.innerHTML = html;

            } catch (error) {
                console.error('Error loading models performance:', error);
                perfDiv.innerHTML = '<div class="empty-state" style="padding: 20px; color: #ef4444;">Error loading models</div>';
            }
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        //                     CONNECTION MANAGEMENT
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        async function connectToIBKR() {
            try {
                const response = await fetch(API_BASE_URL + '/api/ibkr/connect', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ host: '127.0.0.1', port: 7497, client_id: 1 })
                });
                const data = await response.json();

                if (data.status === 'connected') {
                    alert('âœ“ Connected to IBKR successfully!');
                    checkStatus();
                } else {
                    alert('âœ— Failed to connect to IBKR');
                }
            } catch (error) {
                alert('âœ— Connection error: ' + error.message);
            }
        }

        async function checkStatus() {
            try {
                // Check IBKR status
                const ibkrResponse = await fetch(API_BASE_URL + '/api/ibkr/status');
                const ibkrData = await ibkrResponse.json();

                console.log('IBKR Status:', ibkrData);

                const ibkrDot = document.getElementById('ibkrStatus');
                const ibkrText = document.getElementById('ibkrStatusText');

                if (ibkrData && ibkrData.connected) {
                    ibkrDot.classList.add('connected');
                    ibkrText.textContent = 'Connected';
                    apiAvailable = true;
                    console.log('âœ“ IBKR indicator set to CONNECTED');
                } else {
                    ibkrDot.classList.remove('connected');
                    if (apiAvailable === false) {
                        ibkrText.textContent = 'Demo Mode';
                    } else {
                        ibkrText.textContent = 'Disconnected';
                    }
                    console.log('âœ— IBKR indicator set to DISCONNECTED');
                }

                // Check AI/Claude status
                const healthResponse = await fetch(API_BASE_URL + '/health');
                const healthData = await healthResponse.json();

                console.log('Claude Available:', healthData.claude_available);

                const aiDot = document.getElementById('aiStatus');
                const aiText = document.getElementById('aiStatusText');

                if (healthData && healthData.claude_available) {
                    aiDot.classList.add('connected');
                    aiText.textContent = 'Online';
                    console.log('âœ“ AI indicator set to ONLINE');
                } else {
                    aiDot.classList.remove('connected');
                    aiText.textContent = 'Offline';
                    console.log('âœ— AI indicator set to OFFLINE');
                }
            } catch (error) {
                console.error('Status check error:', error);
            }
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        //                     WINDOW LAYOUT MANAGEMENT
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        function createWindow(id, title, content, x, y, width, height) {
            const win = new DraggableWindow(id, title, content, x, y, width, height);
            windows.push(win);
            return win;
        }

        function minimizeWindow(id) {
            windows.find(w => w.id === id)?.minimize();
        }

        function maximizeWindow(id) {
            windows.find(w => w.id === id)?.maximize();
        }

        function closeWindow(id) {
            windows.find(w => w.id === id)?.close();
        }

        function minimizeAll() {
            windows.forEach(w => w.minimize());
        }

        function restoreAll() {
            windows.forEach(w => w.restore());
        }

        function tileWindows() {
            const workspace = document.getElementById('workspace');
            const cols = Math.ceil(Math.sqrt(windows.length));
            const rows = Math.ceil(windows.length / cols);
            const width = Math.floor(workspace.clientWidth / cols);
            const height = Math.floor(workspace.clientHeight / rows);

            windows.forEach((win, i) => {
                win.x = (i % cols) * width;
                win.y = Math.floor(i / cols) * height;
                win.width = width - 4;
                win.height = height - 4;
                win.updatePosition();
                win.restore();
            });
        }

        function cascadeWindows() {
            windows.forEach((win, i) => {
                win.x = i * 35;
                win.y = i * 35;
                win.width = 600;
                win.height = 450;
                win.updatePosition();
                win.restore();
            });
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        //                     CONFIGURATION MANAGEMENT SYSTEM
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        function getAllConfigurations() {
            const configs = localStorage.getItem('dashboardConfigurations');
            return configs ? JSON.parse(configs) : {};
        }

        function saveAllConfigurations(configs) {
            localStorage.setItem('dashboardConfigurations', JSON.stringify(configs));
        }

        function showSaveConfigDialog() {
            document.getElementById('configNameInput').value = '';
            document.getElementById('saveConfigDialog').classList.add('show');

            const input = document.getElementById('configNameInput');
            input.focus();

            // Add Enter key handler
            input.onkeypress = function(e) {
                if (e.key === 'Enter') {
                    saveConfiguration();
                }
            };

            // Close the dropdown
            document.querySelectorAll('.dropdown').forEach(d => d.classList.remove('show'));
        }

        function closeSaveConfigDialog() {
            document.getElementById('saveConfigDialog').classList.remove('show');
        }

        function saveConfiguration() {
            const name = document.getElementById('configNameInput').value.trim();

            if (!name) {
                alert('Please enter a configuration name.');
                return;
            }

            const configs = getAllConfigurations();

            if (configs[name]) {
                if (!confirm(`Configuration "${name}" already exists. Overwrite it?`)) {
                    return;
                }
            }

            const layout = windows.map(w => ({
                id: w.id,
                title: w.title,
                x: w.x,
                y: w.y,
                width: w.width,
                height: w.height,
                minimized: w.minimized
            }));

            configs[name] = {
                windows: layout,
                watchlist: [...watchlist],
                timestamp: new Date().toISOString()
            };

            saveAllConfigurations(configs);
            closeSaveConfigDialog();
            updateSavedConfigsList();

            console.log(`âœ“ Configuration "${name}" saved with ${layout.length} windows`);
            alert(`âœ“ Configuration "${name}" saved successfully!`);
        }

        function loadConfiguration(name) {
            const configs = getAllConfigurations();
            const config = configs[name];

            if (!config) {
                alert(`Configuration "${name}" not found.`);
                return;
            }

            console.log(`Loading configuration: ${name}`);

            // Close all current windows
            windows.forEach(w => w.close());
            windows = [];

            // Restore watchlist
            if (config.watchlist) {
                watchlist = [...config.watchlist];
                localStorage.setItem('watchlist', JSON.stringify(watchlist));
            }

            // Restore windows
            config.windows.forEach(w => {
                const template = windowTemplates[w.id] || windowTemplates[w.id.replace(/\d+$/, '')] || '';
                createWindow(w.id, w.title, template, w.x, w.y, w.width, w.height);
                if (w.minimized) {
                    const window = windows.find(win => win.id === w.id);
                    if (window) window.minimize();
                }
            });

            // Refresh data
            setTimeout(() => {
                loadPrice();
                loadLevel2();
                loadTimeSales();
                loadPositions();
                loadOrders();
                loadAccount();
                loadWorklist();

                // Initialize charts
                windows.forEach(win => {
                    if (win.id.startsWith('chart')) {
                        const chartId = win.id.replace('chart', '');
                        initChart(chartId, currentSymbol);
                    }
                });
            }, 1000);

            // Close dropdown
            document.querySelectorAll('.dropdown').forEach(d => d.classList.remove('show'));

            console.log(`âœ“ Configuration "${name}" loaded`);
        }

        function deleteConfiguration(name) {
            if (!confirm(`Delete configuration "${name}"?`)) {
                return;
            }

            const configs = getAllConfigurations();
            delete configs[name];
            saveAllConfigurations(configs);
            updateSavedConfigsList();
            updateManageConfigsList();

            console.log(`âœ— Configuration "${name}" deleted`);
            alert(`âœ“ Configuration "${name}" deleted.`);
        }

        function renameConfiguration(oldName) {
            const newName = prompt(`Rename configuration "${oldName}" to:`, oldName);

            if (!newName || newName === oldName) {
                return;
            }

            const configs = getAllConfigurations();

            if (configs[newName]) {
                alert(`Configuration "${newName}" already exists.`);
                return;
            }

            configs[newName] = configs[oldName];
            configs[newName].timestamp = new Date().toISOString();
            delete configs[oldName];

            saveAllConfigurations(configs);
            updateSavedConfigsList();
            updateManageConfigsList();

            console.log(`âœ“ Configuration renamed: "${oldName}" â†’ "${newName}"`);
            alert(`âœ“ Configuration renamed to "${newName}".`);
        }

        function updateSavedConfigsList() {
            const configs = getAllConfigurations();
            const configNames = Object.keys(configs).sort();
            const listDiv = document.getElementById('savedConfigsList');

            if (configNames.length === 0) {
                listDiv.innerHTML = '<div style="padding: 10px; text-align: center; color: #666; font-size: 13px;">No saved configurations</div>';
                return;
            }

            let html = '';
            configNames.forEach(name => {
                const config = configs[name];
                const date = new Date(config.timestamp).toLocaleDateString();
                const windowCount = config.windows.length;

                html += `
                    <a href="#" onclick="event.preventDefault(); loadConfiguration('${name.replace(/'/g, "\\'")}')">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span>${name}</span>
                            <span style="font-size: 11px; color: #666;">${windowCount} windows</span>
                        </div>
                    </a>
                `;
            });

            listDiv.innerHTML = html;
        }

        function showManageConfigsDialog() {
            updateManageConfigsList();
            document.getElementById('manageConfigsDialog').classList.add('show');
            // Close the dropdown
            document.querySelectorAll('.dropdown').forEach(d => d.classList.remove('show'));
        }

        function closeManageConfigsDialog() {
            document.getElementById('manageConfigsDialog').classList.remove('show');
        }

        function updateManageConfigsList() {
            const configs = getAllConfigurations();
            const configNames = Object.keys(configs).sort();
            const listDiv = document.getElementById('manageConfigsList');
            const noConfigsMsg = document.getElementById('noConfigsMessage');

            if (configNames.length === 0) {
                listDiv.style.display = 'none';
                noConfigsMsg.style.display = 'block';
                return;
            }

            listDiv.style.display = 'block';
            noConfigsMsg.style.display = 'none';

            let html = '';
            configNames.forEach(name => {
                const config = configs[name];
                const date = new Date(config.timestamp).toLocaleString();
                const windowCount = config.windows.length;
                const watchlistCount = config.watchlist ? config.watchlist.length : 0;

                html += `
                    <div class="config-list-item">
                        <div>
                            <div class="config-list-item-name">${name}</div>
                            <div class="config-list-item-date">
                                ${date} â€¢ ${windowCount} windows â€¢ ${watchlistCount} symbols
                            </div>
                        </div>
                        <div class="config-list-item-actions">
                            <button class="config-btn-small config-btn-load" onclick="loadConfiguration('${name.replace(/'/g, "\\'")}'); closeManageConfigsDialog();">
                                ğŸ“‚ Load
                            </button>
                            <button class="config-btn-small config-btn-rename" onclick="renameConfiguration('${name.replace(/'/g, "\\'")}')">
                                âœï¸ Rename
                            </button>
                            <button class="config-btn-small config-btn-delete" onclick="deleteConfiguration('${name.replace(/'/g, "\\'")}')">
                                ğŸ—‘ï¸ Delete
                            </button>
                        </div>
                    </div>
                `;
            });

            listDiv.innerHTML = html;
        }

        // Legacy function - kept for backward compatibility
        function saveAsCustomLayout() {
            showSaveConfigDialog();
        }

        function saveCurrentLayout() {
            showSaveConfigDialog();
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        //                     MULTI-CHART MANAGEMENT
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        function getTimeframeName(interval) {
            const names = {
                '1': '1min',
                '5': '5min',
                '15': '15min',
                '30': '30min',
                '60': '1h',
                '240': '4h',
                'D': 'Daily',
                'W': 'Weekly',
                'M': 'Monthly'
            };
            return names[interval] || interval;
        }

        function addChart(interval = '5', style = '1') {
            chartCounter++;
            const chartId = `chart${chartCounter}`;
            const timeframeName = getTimeframeName(interval);
            const title = `CHART ${chartCounter} - ${currentSymbol} (${timeframeName})`;

            // Calculate position (cascade new charts)
            const baseX = 300 + (chartCounter - 1) * 30;
            const baseY = 100 + (chartCounter - 1) * 30;

            // Create chart window
            const chartWindow = createWindow(
                chartId,
                title,
                windowTemplates.chart(chartCounter),
                baseX,
                baseY,
                700,
                500
            );

            // Initialize TradingView chart after a short delay
            setTimeout(() => {
                initChart(chartCounter.toString(), currentSymbol, interval, style);
            }, 500);

            // Close dropdown
            document.querySelectorAll('.dropdown').forEach(d => d.classList.remove('show'));

            console.log(`âœ“ Added chart ${chartCounter} with ${timeframeName} timeframe`);
        }

        function showAddChartDialog() {
            document.getElementById('chartSymbolPreview').textContent = currentSymbol;
            document.getElementById('addChartDialog').classList.add('show');
            // Close the dropdown
            document.querySelectorAll('.dropdown').forEach(d => d.classList.remove('show'));
        }

        function closeAddChartDialog() {
            document.getElementById('addChartDialog').classList.remove('show');
        }

        function createCustomChart() {
            const interval = document.getElementById('chartTimeframe').value;
            const style = document.getElementById('chartStyle').value;

            addChart(interval, style);
            closeAddChartDialog();
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        //                     TRADINGVIEW DESKTOP INTEGRATION
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        async function openInTradingView(symbol) {
            try {
                const response = await fetch(API_BASE_URL + `/api/tradingview/open/${symbol}`, {
                    method: 'POST'
                });
                const data = await response.json();

                if (data.success) {
                    console.log(`âœ“ Opened ${symbol} in TradingView Desktop`);
                    alert(`Opening ${symbol} in TradingView Desktop...`);
                } else {
                    alert('Could not open TradingView Desktop. Make sure it is installed.');
                }
            } catch (error) {
                console.error('Error opening TradingView:', error);
                // Fallback: open TradingView web
                window.open(`https://www.tradingview.com/chart/?symbol=${symbol}`, '_blank');
            }

            // Close dropdown
            document.querySelectorAll('.dropdown').forEach(d => d.classList.remove('show'));
        }

        function copySymbolToClipboard() {
            navigator.clipboard.writeText(currentSymbol).then(() => {
                alert(`âœ“ ${currentSymbol} copied to clipboard!\n\nPaste it in TradingView Desktop.`);
                console.log(`Copied ${currentSymbol} to clipboard`);
            }).catch(err => {
                console.error('Failed to copy:', err);
            });

            // Close dropdown
            document.querySelectorAll('.dropdown').forEach(d => d.classList.remove('show'));
        }

        function showWebhookInfo() {
            document.getElementById('webhookInfoDialog').classList.add('show');
            // Close the dropdown
            document.querySelectorAll('.dropdown').forEach(d => d.classList.remove('show'));
        }

        function closeWebhookInfoDialog() {
            document.getElementById('webhookInfoDialog').classList.remove('show');
        }

        function copyWebhookUrl() {
            const url = document.getElementById('webhookUrl').value;
            navigator.clipboard.writeText(url).then(() => {
                alert('âœ“ Webhook URL copied to clipboard!');
            });
        }

        async function showWebhookLogs() {
            document.getElementById('webhookLogsDialog').classList.add('show');
            await refreshWebhookLogs();
            // Close the dropdown
            document.querySelectorAll('.dropdown').forEach(d => d.classList.remove('show'));
        }

        function closeWebhookLogsDialog() {
            document.getElementById('webhookLogsDialog').classList.remove('show');
        }

        async function refreshWebhookLogs() {
            try {
                const response = await fetch(API_BASE_URL + '/api/tradingview/webhook-logs');
                const data = await response.json();

                const logsList = document.getElementById('webhookLogsList');

                if (data.logs && data.logs.length > 0) {
                    let html = '';
                    data.logs.reverse().forEach(log => {
                        const timestamp = new Date(log.timestamp).toLocaleString();
                        const typeColor = log.type === 'incoming' ? '#22c55e' :
                                         log.type === 'error' ? '#ef4444' : '#60a5fa';

                        html += `
                            <div style="margin-bottom: 10px; padding: 10px; background: #1a1a1a; border-left: 3px solid ${typeColor}; border-radius: 3px;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                    <span style="color: ${typeColor}; font-weight: 700;">${log.type.toUpperCase()}</span>
                                    <span style="color: #666;">${timestamp}</span>
                                </div>
                                <pre style="margin: 0; color: #aaa; font-size: 11px; white-space: pre-wrap;">${JSON.stringify(log.data, null, 2)}</pre>
                            </div>
                        `;
                    });
                    logsList.innerHTML = html;
                } else {
                    logsList.innerHTML = '<div style="text-align: center; padding: 40px; color: #666;">No webhook activity yet.<br><small>Set up alerts in TradingView to see activity here.</small></div>';
                }
            } catch (error) {
                console.error('Error loading webhook logs:', error);
                document.getElementById('webhookLogsList').innerHTML = '<div style="text-align: center; padding: 40px; color: #ef4444;">Error loading logs</div>';
            }
        }

        async function clearWebhookLogs() {
            if (!confirm('Clear all webhook logs?')) {
                return;
            }

            try {
                await fetch(API_BASE_URL + '/api/tradingview/webhook-logs', {
                    method: 'DELETE'
                });
                alert('âœ“ Webhook logs cleared');
                await refreshWebhookLogs();
            } catch (error) {
                console.error('Error clearing logs:', error);
                alert('Error clearing logs');
            }
        }

        async function testWebhook() {
            try {
                const response = await fetch(API_BASE_URL + '/api/tradingview/test-webhook', {
                    method: 'POST'
                });
                const data = await response.json();

                if (data.success) {
                    alert('âœ“ Test webhook received successfully!\n\nCheck "View Webhook Logs" to see the test alert.');
                    console.log('Test webhook response:', data);
                } else {
                    alert('âœ— Test webhook failed');
                }
            } catch (error) {
                console.error('Error testing webhook:', error);
                alert('âœ— Error testing webhook: ' + error.message);
            }

            // Close dropdown
            document.querySelectorAll('.dropdown').forEach(d => d.classList.remove('show'));
        }

        function exportWatchlist() {
            // Export watchlist in TradingView format
            const tvWatchlist = watchlist.join(',');
            const blob = new Blob([tvWatchlist], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'tradingview_watchlist.txt';
            a.click();
            URL.revokeObjectURL(url);

            alert('âœ“ Watchlist exported!\n\nYou can import this in TradingView Desktop.');
            console.log('Exported watchlist:', tvWatchlist);

            // Close dropdown
            document.querySelectorAll('.dropdown').forEach(d => d.classList.remove('show'));
        }

        function showSetupGuide() {
            // Open setup guide in new window
            window.open('TRADINGVIEW_SETUP_GUIDE.html', '_blank');

            // Close dropdown
            document.querySelectorAll('.dropdown').forEach(d => d.classList.remove('show'));
        }

        function openTradingViewSetupGuide() {
            window.open('TRADINGVIEW_SETUP_GUIDE.html', '_blank');
        }

        // Auto-submit setting functions
        function saveAutoSubmitSetting(enabled) {
            localStorage.setItem('autoSubmitOrders', enabled ? 'true' : 'false');
            console.log('Auto-submit orders:', enabled ? 'ENABLED' : 'DISABLED');
        }

        function loadAutoSubmitSetting() {
            const saved = localStorage.getItem('autoSubmitOrders');
            const checkbox = document.getElementById('autoSubmitOrders');
            if (checkbox && saved === 'true') {
                checkbox.checked = true;
            }
        }

        function loadLayout(name) {
            windows.forEach(w => w.close());
            windows = [];

            if (name === 'custom') {
                loadCustomLayout();
            }
            else if (name === 'default') loadDefaultLayout();
            else if (name === 'trading') loadTradingLayout();
            else if (name === 'analysis') loadAnalysisLayout();
            else if (name === 'scalping') loadScalpingLayout();

            setTimeout(() => {
                loadPrice();
                loadLevel2();
                loadTimeSales();
                loadPositions();
                loadOrders();
                loadAccount();
                loadWorklist();

                // Initialize any charts that were created
                windows.forEach(win => {
                    if (win.id.startsWith('chart')) {
                        const chartId = win.id.replace('chart', '');
                        initChart(chartId, currentSymbol);
                    }
                });
            }, 1000);
        }

        function loadDefaultLayout() {
            createWindow('watchlist', 'WATCHLIST', windowTemplates.watchlist, 10, 10, 250, 400);
            createWindow('account', 'ACCOUNT', windowTemplates.account, 10, 420, 250, 280);
            createWindow('quote', `QUOTE - ${currentSymbol}`, windowTemplates.quote, 270, 10, 450, 180);
            createWindow('level2', `LEVEL II - ${currentSymbol}`, windowTemplates.level2, 270, 200, 450, 500);
            createWindow('timesales', 'TIME & SALES', windowTemplates.timesales, 730, 10, 280, 400);
            createWindow('order', 'ORDER ENTRY', windowTemplates.order, 730, 420, 280, 280);
            createWindow('chart1', `CHART - ${currentSymbol}`, windowTemplates.chart('1'), 1020, 10, 600, 400);
            createWindow('positions', 'POSITIONS', windowTemplates.positions, 1020, 420, 600, 140);
            createWindow('orders', 'WORKING ORDERS', windowTemplates.orders, 1020, 570, 600, 130);
        }

        function loadTradingLayout() {
            createWindow('quote', `QUOTE - ${currentSymbol}`, windowTemplates.quote, 10, 10, 400, 120);
            createWindow('level2', `LEVEL II - ${currentSymbol}`, windowTemplates.level2, 10, 140, 400, 560);
            createWindow('timesales', 'TIME & SALES', windowTemplates.timesales, 420, 10, 280, 400);
            createWindow('order', 'ORDER ENTRY', windowTemplates.order, 420, 420, 280, 280);
            createWindow('chart1', `CHART - ${currentSymbol}`, windowTemplates.chart('1'), 710, 10, 600, 500);
            createWindow('positions', 'POSITIONS', windowTemplates.positions, 710, 520, 600, 90);
            createWindow('orders', 'WORKING ORDERS', windowTemplates.orders, 710, 620, 600, 80);
            createWindow('watchlist', 'WATCHLIST', windowTemplates.watchlist, 1320, 10, 280, 400);
            createWindow('account', 'ACCOUNT', windowTemplates.account, 1320, 420, 280, 280);
        }

        function loadAnalysisLayout() {
            createWindow('chart1', `CHART 1 - ${currentSymbol}`, windowTemplates.chart('1'), 10, 10, 800, 450);
            createWindow('chart2', `CHART 2 - ${currentSymbol}`, windowTemplates.chart('2'), 820, 10, 800, 450);
            createWindow('watchlist', 'WATCHLIST', windowTemplates.watchlist, 10, 470, 250, 400);
            createWindow('level2', `LEVEL II - ${currentSymbol}`, windowTemplates.level2, 270, 470, 400, 400);
            createWindow('timesales', 'TIME & SALES', windowTemplates.timesales, 680, 470, 300, 400);
            createWindow('ai', 'AI ANALYSIS', windowTemplates.ai, 990, 470, 360, 200);
            createWindow('bot', 'BOT CONTROL', windowTemplates.bot, 990, 680, 360, 190);
            createWindow('account', 'ACCOUNT', windowTemplates.account, 1360, 470, 260, 200);
            createWindow('order', 'ORDER ENTRY', windowTemplates.order, 1360, 680, 260, 190);
        }

        function loadScalpingLayout() {
            createWindow('quote', `QUOTE - ${currentSymbol}`, windowTemplates.quote, 10, 10, 300, 120);
            createWindow('level2', `LEVEL II - ${currentSymbol}`, windowTemplates.level2, 10, 140, 400, 560);
            createWindow('order', 'ORDER ENTRY', windowTemplates.order, 420, 10, 280, 350);
            createWindow('timesales', 'TIME & SALES', windowTemplates.timesales, 420, 370, 280, 330);
            createWindow('chart1', `CHART - ${currentSymbol}`, windowTemplates.chart('1'), 710, 10, 700, 500);
            createWindow('positions', 'POSITIONS', windowTemplates.positions, 710, 520, 700, 90);
            createWindow('orders', 'WORKING ORDERS', windowTemplates.orders, 710, 620, 700, 80);
            createWindow('watchlist', 'WATCHLIST', windowTemplates.watchlist, 1420, 10, 200, 400);
            createWindow('account', 'ACCOUNT', windowTemplates.account, 1420, 420, 200, 280);
        }

        function loadCustomLayout() {
            const savedLayout = localStorage.getItem('customLayout');
            if (savedLayout) {
                try {
                    const layout = JSON.parse(savedLayout);
                    console.log('Loading custom layout with', layout.length, 'windows');
                    layout.forEach(w => {
                        createWindow(w.id, w.title, windowTemplates[w.id] || '', w.width, w.height, w.x, w.y);
                        if (w.minimized) {
                            const window = windows.find(win => win.id === w.id);
                            if (window) window.minimize();
                        }
                    });
                } catch (e) {
                    console.error('Failed to load custom layout:', e);
                    alert('Failed to load custom layout. Loading default instead.');
                    loadDefaultLayout();
                }
            } else {
                alert('No custom layout saved.\n\nArrange windows and click "ğŸ’¾ Save as Custom" to create one.');
                loadDefaultLayout();
            }
        }

        function resetLayout() {
            if (confirm('Reset to default layout?')) {
                localStorage.removeItem('tradingLayout');
                loadLayout('default');
            }
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        //                     INITIALIZATION
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        // TradingView Chart Management
        let chartWidgets = {};
        let chartInstances = {};
        let chartCounter = 0; // Track number of charts created

        function initChart(id, symbol, interval = '5', style = '1') {
            const containerId = `chart-${id}`;
            const container = document.getElementById(containerId);
            if (!container) {
                console.log(`Chart container ${containerId} not found`);
                return;
            }

            // Check if TradingView is available
            if (typeof TradingView === 'undefined') {
                console.error('TradingView library not loaded');
                container.innerHTML = `<div class="empty-state" style="padding: 20px; text-align: center;">
                    <div style="font-size: 16px; color: #ef4444; margin-bottom: 10px;">âš ï¸ TradingView Not Available</div>
                    <div style="font-size: 13px; color: #888;">
                        The TradingView charting library failed to load.<br>
                        <small>Check your internet connection or browser console for errors.</small>
                    </div>
                </div>`;
                return;
            }

            console.log(`Initializing chart ${id} for ${symbol} (${interval})`);

            try {
                // Clear container and clean up old widget
                container.innerHTML = '';

                if (chartWidgets[id]) {
                    try {
                        chartWidgets[id].remove();
                    } catch (e) {
                        // Ignore removal errors - container is already cleared
                    }
                    delete chartWidgets[id];
                    delete chartInstances[id];
                }

                // Create new widget
                chartWidgets[id] = new TradingView.widget({
                    "width": "100%",
                    "height": "100%",
                    "symbol": `NASDAQ:${symbol}`,
                    "interval": interval,
                    "timezone": "America/New_York",
                    "theme": "dark",
                    "style": style,
                    "locale": "en",
                    "toolbar_bg": "#1a1a1a",
                    "enable_publishing": false,
                    "hide_side_toolbar": false,
                    "allow_symbol_change": true,
                    "container_id": containerId,
                    "studies": ["MASimple@tv-basicstudies", "RSI@tv-basicstudies"],
                    "backgroundColor": "#1a1a1a",
                    "gridColor": "#2a2a2a",
                    "hide_legend": false,
                    "save_image": false,
                    "onChartReady": function() {
                        chartInstances[id] = chartWidgets[id].chart();
                        console.log(`Chart ${id} ready for ${symbol} (${interval})`);
                    }
                });
            } catch (e) {
                console.error('TradingView init error:', e);
                container.innerHTML = '<div class="empty-state">TradingView Desktop connection required</div>';
            }
        }

        function updateChart(winId, symbol) {
            // Extract chart ID from window ID (e.g., 'chart1' -> '1')
            const chartId = winId.replace('chart', '');

            if (chartInstances[chartId]) {
                try {
                    // Use the chart instance to change symbol
                    chartInstances[chartId].setSymbol(`NASDAQ:${symbol}`, function() {
                        console.log(`Chart ${chartId} updated to ${symbol}`);
                    });
                } catch (e) {
                    console.log('Chart update error, reinitializing:', e);
                    initChart(chartId, symbol);
                }
            } else if (chartWidgets[chartId]) {
                // Widget exists but no chart instance yet - reinit
                console.log(`No chart instance for ${chartId}, reinitializing`);
                initChart(chartId, symbol);
            } else {
                // No widget at all - initialize
                console.log(`Creating chart ${chartId} for ${symbol}`);
                initChart(chartId, symbol);
            }
        }

        window.addEventListener('load', async () => {
            console.log('%cğŸš€ IBKR Professional Trading Platform', 'color: #007acc; font-size: 18px; font-weight: bold;');

            // Initialize configuration system
            updateSavedConfigsList();

            // Load saved watchlist
            const savedWatchlist = localStorage.getItem('watchlist');
            if (savedWatchlist) {
                watchlist = JSON.parse(savedWatchlist);
            }

            // Load auto-submit orders setting
            loadAutoSubmitSetting();

            // Load saved custom layout first, then check old saved layout, or default
            const customLayout = localStorage.getItem('customLayout');
            const oldSavedLayout = localStorage.getItem('tradingLayout');

            if (customLayout) {
                console.log('Loading custom layout...');
                loadLayout('custom');
            } else if (oldSavedLayout) {
                console.log('Loading old saved layout (migrating to custom)...');
                // Migrate old layout to custom
                try {
                    localStorage.setItem('customLayout', oldSavedLayout);
                    localStorage.removeItem('tradingLayout');
                    loadLayout('custom');
                } catch (e) {
                    console.error('Failed to migrate layout:', e);
                    loadLayout('default');
                }
            } else {
                // Load default layout if no saved layout
                console.log('Loading default layout...');
                loadLayout('default');
            }

            // Subscribe to all watchlist symbols
            console.log('ğŸ“Š Subscribing to market data...');
            for (const symbol of watchlist) {
                await subscribeToSymbol(symbol);
            }

            // Subscribe to current symbol
            await subscribeToSymbol(currentSymbol);

            // Start status check
            checkStatus();
            setInterval(checkStatus, 5000);

            // Start data updates (every 2 seconds for real-time feel)
            setInterval(() => {
                loadPrice();
                loadLevel2();
                loadTimeSales();
                loadPositions();
                loadAccount();
                loadWorklist();
            }, 2000);

            // Initialize order form price field based on selected order type
            handleOrderTypeChange();

            console.log('%câœ“ Platform Ready', 'color: #22c55e; font-weight: bold;');
            console.log('%cğŸ’¡ Click symbols in watchlist â€¢ Click Level 2 prices to fill orders â€¢ Drag & resize windows', 'color: #888; font-size: 15px;');
        });

        // Dropdown menu functionality
        function toggleDropdown(dropdownId) {
            const dropdown = document.getElementById(dropdownId);
            const allDropdowns = document.querySelectorAll('.dropdown');

            // Close all other dropdowns
            allDropdowns.forEach(d => {
                if (d.id !== dropdownId) {
                    d.classList.remove('show');
                }
            });

            // Toggle the clicked dropdown
            dropdown.classList.toggle('show');

            // Prevent event bubbling
            event.stopPropagation();
        }

        // Close dropdowns when clicking outside
        document.addEventListener('click', function(event) {
            if (!event.target.closest('.menu-item')) {
                document.querySelectorAll('.dropdown').forEach(d => {
                    d.classList.remove('show');
                });
            }
        });
    </script>
</body>
</html>
