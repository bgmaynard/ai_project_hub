<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IBKR Live Trading Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #fff;
            padding: 20px;
        }

        .header {
            text-align: center;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .header h1 {
            font-size: 2em;
            margin-bottom: 10px;
            color: #00d4ff;
        }

        .status-bar {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 10px;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 15px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 5px;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .status-dot.connected {
            background: #00ff88;
        }

        .status-dot.disconnected {
            background: #ff4444;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .symbols-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .symbol-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 20px;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .symbol-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 212, 255, 0.3);
        }

        .symbol-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .symbol-name {
            font-size: 1.5em;
            font-weight: bold;
            color: #00d4ff;
        }

        .last-update {
            font-size: 0.8em;
            color: #888;
        }

        .price-display {
            font-size: 2.5em;
            font-weight: bold;
            margin: 15px 0;
            text-align: center;
        }

        .price-display.up {
            color: #00ff88;
        }

        .price-display.down {
            color: #ff4444;
        }

        .price-change {
            text-align: center;
            font-size: 1.2em;
            margin-bottom: 15px;
        }

        .data-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
        }

        .data-item {
            background: rgba(0, 0, 0, 0.3);
            padding: 10px;
            border-radius: 5px;
        }

        .data-label {
            font-size: 0.8em;
            color: #888;
            margin-bottom: 5px;
        }

        .data-value {
            font-size: 1.1em;
            font-weight: bold;
        }

        .bid-ask {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
            gap: 10px;
        }

        .bid, .ask {
            flex: 1;
            padding: 10px;
            border-radius: 5px;
            text-align: center;
        }

        .bid {
            background: rgba(0, 255, 136, 0.1);
            border: 1px solid rgba(0, 255, 136, 0.3);
        }

        .ask {
            background: rgba(255, 68, 68, 0.1);
            border: 1px solid rgba(255, 68, 68, 0.3);
        }

        .controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 20px 0;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
        }

        .btn-primary {
            background: linear-gradient(135deg, #00d4ff, #0099cc);
            color: white;
        }

        .btn-primary:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 20px rgba(0, 212, 255, 0.5);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .add-symbol-form {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 20px 0;
        }

        .add-symbol-form input {
            padding: 12px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 5px;
            background: rgba(0, 0, 0, 0.3);
            color: white;
            font-size: 1em;
            min-width: 200px;
        }

        .add-symbol-form input:focus {
            outline: none;
            border-color: #00d4ff;
        }

        .loading {
            text-align: center;
            padding: 40px;
            font-size: 1.2em;
            color: #888;
        }

        .error-message {
            background: rgba(255, 68, 68, 0.2);
            border: 1px solid rgba(255, 68, 68, 0.5);
            border-radius: 5px;
            padding: 15px;
            margin: 20px 0;
            text-align: center;
        }

        .success-message {
            background: rgba(0, 255, 136, 0.2);
            border: 1px solid rgba(0, 255, 136, 0.5);
            border-radius: 5px;
            padding: 15px;
            margin: 20px 0;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üöÄ IBKR Live Trading Dashboard</h1>
        <div class="status-bar">
            <div class="status-item">
                <div class="status-dot" id="serverStatus"></div>
                <span id="serverText">Server: Connecting...</span>
            </div>
            <div class="status-item">
                <div class="status-dot" id="ibkrStatus"></div>
                <span id="ibkrText">IBKR: Checking...</span>
            </div>
            <div class="status-item">
                <div class="status-dot" id="claudeStatus"></div>
                <span id="claudeText">Claude AI: Checking...</span>
            </div>
        </div>
    </div>

    <div class="controls">
        <button class="btn btn-primary" onclick="refreshAll()">üîÑ Refresh All</button>
        <button class="btn btn-secondary" onclick="checkHealth()">üìä System Health</button>
        <button class="btn btn-secondary" onclick="toggleAutoRefresh()">
            <span id="autoRefreshText">‚è∏Ô∏è Pause Auto-Refresh</span>
        </button>
    </div>

    <div class="add-symbol-form">
        <input type="text" id="newSymbol" placeholder="Enter symbol (e.g., NVDA)" onkeypress="handleSymbolKeyPress(event)">
        <button class="btn btn-primary" onclick="addSymbol()">‚ûï Add Symbol</button>
    </div>

    <div id="messageArea"></div>

    <div class="symbols-grid" id="symbolsGrid">
        <div class="loading">Loading market data...</div>
    </div>

    <script>
        const API_BASE = 'http://127.0.0.1:9101';
        let autoRefresh = true;
        let refreshInterval;
        let trackedSymbols = ['AAPL', 'TSLA', 'SPY'];
        let lastPrices = {};

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', () => {
            checkHealth();
            loadSymbols();
            startAutoRefresh();
        });

        function startAutoRefresh() {
            if (refreshInterval) clearInterval(refreshInterval);
            refreshInterval = setInterval(() => {
                if (autoRefresh) {
                    refreshAll();
                }
            }, 3000); // Refresh every 3 seconds
        }

        function toggleAutoRefresh() {
            autoRefresh = !autoRefresh;
            const btn = document.getElementById('autoRefreshText');
            btn.textContent = autoRefresh ? '‚è∏Ô∏è Pause Auto-Refresh' : '‚ñ∂Ô∏è Resume Auto-Refresh';
            if (autoRefresh) {
                refreshAll();
            }
        }

        async function checkHealth() {
            try {
                const response = await fetch(`${API_BASE}/health`);
                const health = await response.json();
                
                // Update status indicators
                updateStatus('serverStatus', 'serverText', true, 'Server: Connected');
                updateStatus('ibkrStatus', 'ibkrText', health.ibkr_connected, 
                    health.ibkr_connected ? 'IBKR: Connected' : 'IBKR: Disconnected');
                updateStatus('claudeStatus', 'claudeText', health.claude_available, 
                    health.claude_available ? 'Claude AI: Ready' : 'Claude AI: Unavailable');
                
                // Update tracked symbols
                if (health.symbols_tracked && health.symbols_tracked.length > 0) {
                    trackedSymbols = health.symbols_tracked;
                    loadSymbols();
                }
            } catch (error) {
                console.error('Health check failed:', error);
                updateStatus('serverStatus', 'serverText', false, 'Server: Error');
            }
        }

        function updateStatus(dotId, textId, isConnected, text) {
            const dot = document.getElementById(dotId);
            const textEl = document.getElementById(textId);
            
            dot.className = `status-dot ${isConnected ? 'connected' : 'disconnected'}`;
            textEl.textContent = text;
        }

        async function loadSymbols() {
            const grid = document.getElementById('symbolsGrid');
            grid.innerHTML = '';
            
            for (const symbol of trackedSymbols) {
                await loadSymbolData(symbol);
            }
        }

        async function loadSymbolData(symbol) {
            const grid = document.getElementById('symbolsGrid');
            
            try {
                const response = await fetch(`${API_BASE}/api/price/${symbol}`);
                
                if (!response.ok) {
                    console.log(`Price data not available for ${symbol} (may need to subscribe)`);
                    addPlaceholderCard(symbol);
                    return;
                }
                
                const data = await response.json();
                updateSymbolCard(symbol, data);
            } catch (error) {
                console.error(`Error loading ${symbol}:`, error);
                addPlaceholderCard(symbol);
            }
        }

        function addPlaceholderCard(symbol) {
            const grid = document.getElementById('symbolsGrid');
            const existingCard = document.getElementById(`card-${symbol}`);
            
            if (!existingCard) {
                const card = document.createElement('div');
                card.className = 'symbol-card';
                card.id = `card-${symbol}`;
                card.innerHTML = `
                    <div class="symbol-header">
                        <div class="symbol-name">${symbol}</div>
                    </div>
                    <div class="loading">Waiting for data...</div>
                    <div style="text-align: center; margin-top: 10px;">
                        <button class="btn btn-secondary" onclick="subscribeSymbol('${symbol}')">
                            üì° Subscribe to Data
                        </button>
                    </div>
                `;
                grid.appendChild(card);
            }
        }

        function updateSymbolCard(symbol, data) {
            const grid = document.getElementById('symbolsGrid');
            let card = document.getElementById(`card-${symbol}`);
            
            if (!card) {
                card = document.createElement('div');
                card.className = 'symbol-card';
                card.id = `card-${symbol}`;
                grid.appendChild(card);
            }
            
            const lastPrice = lastPrices[symbol] || data.last;
            const priceChange = data.last - lastPrice;
            const priceClass = priceChange > 0 ? 'up' : priceChange < 0 ? 'down' : '';
            lastPrices[symbol] = data.last;
            
            const changePercent = data.close ? (((data.last - data.close) / data.close) * 100).toFixed(2) : '0.00';
            const changeSymbol = changePercent >= 0 ? '‚ñ≤' : '‚ñº';
            
            card.innerHTML = `
                <div class="symbol-header">
                    <div class="symbol-name">${symbol}</div>
                    <div class="last-update">${new Date().toLocaleTimeString()}</div>
                </div>
                
                <div class="price-display ${priceClass}">
                    $${data.last.toFixed(2)}
                </div>
                
                <div class="price-change ${priceClass}">
                    ${changeSymbol} ${Math.abs(changePercent)}% 
                    (${priceChange >= 0 ? '+' : ''}${priceChange.toFixed(2)})
                </div>
                
                <div class="bid-ask">
                    <div class="bid">
                        <div class="data-label">BID</div>
                        <div class="data-value">$${data.bid.toFixed(2)}</div>
                        <div class="data-label">${data.bid_size || 0}</div>
                    </div>
                    <div class="ask">
                        <div class="data-label">ASK</div>
                        <div class="data-value">$${data.ask.toFixed(2)}</div>
                        <div class="data-label">${data.ask_size || 0}</div>
                    </div>
                </div>
                
                <div class="data-grid">
                    <div class="data-item">
                        <div class="data-label">Volume</div>
                        <div class="data-value">${formatVolume(data.volume)}</div>
                    </div>
                    <div class="data-item">
                        <div class="data-label">High</div>
                        <div class="data-value">$${data.high.toFixed(2)}</div>
                    </div>
                    <div class="data-item">
                        <div class="data-label">Low</div>
                        <div class="data-value">$${data.low.toFixed(2)}</div>
                    </div>
                    <div class="data-item">
                        <div class="data-label">Open</div>
                        <div class="data-value">$${data.open.toFixed(2)}</div>
                    </div>
                </div>
                
                <div style="text-align: center; margin-top: 15px;">
                    <button class="btn btn-secondary" onclick="analyzeSymbol('${symbol}')" style="width: 100%;">
                        ü§ñ Ask Claude AI
                    </button>
                </div>
            `;
        }

        function formatVolume(vol) {
            if (vol >= 1000000) return (vol / 1000000).toFixed(1) + 'M';
            if (vol >= 1000) return (vol / 1000).toFixed(1) + 'K';
            return vol.toString();
        }

        async function subscribeSymbol(symbol) {
            try {
                showMessage(`Subscribing to ${symbol}...`, 'info');
                
                const response = await fetch(`${API_BASE}/api/subscribe`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        symbol: symbol,
                        exchange: 'SMART',
                        data_types: ['quote']
                    })
                });
                
                if (response.ok) {
                    showMessage(`‚úÖ Subscribed to ${symbol}! Data will appear shortly...`, 'success');
                    setTimeout(() => loadSymbolData(symbol), 2000);
                } else {
                    showMessage(`‚ùå Failed to subscribe to ${symbol}`, 'error');
                }
            } catch (error) {
                showMessage(`‚ùå Error subscribing: ${error.message}`, 'error');
            }
        }

        async function addSymbol() {
            const input = document.getElementById('newSymbol');
            const symbol = input.value.trim().toUpperCase();
            
            if (!symbol) {
                showMessage('‚ö†Ô∏è Please enter a symbol', 'error');
                return;
            }
            
            if (trackedSymbols.includes(symbol)) {
                showMessage(`‚ö†Ô∏è ${symbol} is already being tracked`, 'error');
                return;
            }
            
            trackedSymbols.push(symbol);
            input.value = '';
            
            await subscribeSymbol(symbol);
        }

        function handleSymbolKeyPress(event) {
            if (event.key === 'Enter') {
                addSymbol();
            }
        }

        async function analyzeSymbol(symbol) {
            try {
                showMessage(`ü§ñ Claude is analyzing ${symbol}...`, 'info');
                
                const response = await fetch(`${API_BASE}/api/claude/analyze-with-data/${symbol}`);
                const data = await response.json();
                
                // Create modal or alert with analysis
                alert(`Claude's Analysis of ${symbol}:\n\n${data.analysis}`);
                
                showMessage(`‚úÖ Analysis complete for ${symbol}`, 'success');
            } catch (error) {
                showMessage(`‚ùå Analysis failed: ${error.message}`, 'error');
            }
        }

        function refreshAll() {
            loadSymbols();
        }

        function showMessage(text, type) {
            const area = document.getElementById('messageArea');
            const msg = document.createElement('div');
            msg.className = type === 'error' ? 'error-message' : 'success-message';
            msg.textContent = text;
            area.innerHTML = '';
            area.appendChild(msg);
            
            setTimeout(() => {
                msg.style.transition = 'opacity 0.5s';
                msg.style.opacity = '0';
                setTimeout(() => area.removeChild(msg), 500);
            }, 3000);
        }
    </script>
</body>
</html>
