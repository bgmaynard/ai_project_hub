<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alpaca Professional Trading Platform</title>
    <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #0a0a0a;
            color: #e0e0e0;
            font-size: 15px;
            overflow: hidden;
        }

        /* Top Bar */
        .top-bar {
            background: #1e1e1e;
            border-bottom: 2px solid #007acc;
            padding: 8px 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 40px;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 10000;
        }

        .top-bar-left h1 {
            font-size: 18px;
            font-weight: 600;
            color: #007acc;
            letter-spacing: 1px;
        }

        .top-bar-right {
            display: flex;
            gap: 15px;
            align-items: center;
            font-size: 14px;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            background: #252525;
            border: 1px solid #404040;
            border-radius: 3px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #ef4444;
            animation: pulse 2s infinite;
        }

        .status-dot.connected {
            background: #22c55e;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Price flash animation for synchronized updates */
        @keyframes priceFlash {
            0%, 100% { background-color: transparent; }
            50% { background-color: rgba(96, 165, 250, 0.3); }
        }

        .price-flash {
            animation: priceFlash 0.5s ease;
        }

        /* Configuration Dialog Styles */
        .config-dialog-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 99999;
        }

        .config-dialog-overlay.show {
            display: flex;
        }

        .config-dialog {
            background: #1a1a1a;
            border: 2px solid #007acc;
            border-radius: 4px;
            padding: 20px;
            min-width: 400px;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.9);
        }

        .config-dialog-header {
            font-size: 18px;
            font-weight: 700;
            color: #007acc;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #333;
        }

        .config-dialog-body {
            margin-bottom: 20px;
        }

        .config-dialog-footer {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .config-input {
            width: 100%;
            padding: 10px;
            background: #252525;
            border: 1px solid #404040;
            color: #fff;
            font-size: 14px;
            border-radius: 3px;
            margin-bottom: 10px;
        }

        .config-input:focus {
            outline: none;
            border-color: #007acc;
        }

        .config-list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: #252525;
            border: 1px solid #333;
            border-radius: 3px;
            margin-bottom: 8px;
        }

        .config-list-item:hover {
            background: #2d2d2d;
        }

        .config-list-item-name {
            font-weight: 600;
            color: #fff;
            flex: 1;
        }

        .config-list-item-date {
            font-size: 11px;
            color: #888;
            margin-right: 10px;
        }

        .config-list-item-actions {
            display: flex;
            gap: 5px;
        }

        .config-btn-small {
            padding: 4px 8px;
            font-size: 12px;
            border: none;
            border-radius: 2px;
            cursor: pointer;
            font-weight: 600;
        }

        .config-btn-load {
            background: #22c55e;
            color: #000;
        }

        .config-btn-rename {
            background: #60a5fa;
            color: #000;
        }

        .config-btn-delete {
            background: #ef4444;
            color: #fff;
        }

        .config-btn-small:hover {
            opacity: 0.8;
        }

        /* Menu Bar */
        .menu-bar {
            background: #252525;
            border-bottom: 1px solid #404040;
            padding: 0 12px;
            display: flex;
            gap: 0;
            height: 28px;
            position: fixed;
            top: 40px;
            left: 0;
            right: 0;
            z-index: 9999;
        }

        .menu-item {
            padding: 6px 12px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            color: #b0b0b0;
            border-right: 1px solid #404040;
            transition: all 0.2s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            position: relative;
        }

        .menu-item:hover {
            background: #007acc;
            color: #ffffff;
        }

        /* Dropdown Menu */
        .dropdown {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            background: #2d2d2d;
            border: 1px solid #404040;
            min-width: 220px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
            z-index: 10000;
        }

        .dropdown.show {
            display: block;
        }

        .dropdown a {
            display: block;
            padding: 10px 15px;
            color: #e0e0e0;
            text-decoration: none;
            font-size: 14px;
            border-bottom: 1px solid #404040;
            transition: background 0.2s;
            text-transform: none;
            letter-spacing: normal;
        }

        .dropdown a:hover {
            background: #007acc;
            color: #ffffff;
        }

        .dropdown strong {
            display: block;
            padding: 8px 15px;
            color: #007acc;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .dropdown hr {
            border: none;
            border-top: 1px solid #404040;
            margin: 0;
        }

        /* Workspace */
        .workspace {
            position: fixed;
            top: 68px;
            left: 0;
            right: 0;
            bottom: 0;
            background: #0a0a0a;
            overflow: hidden;
        }

        /* Draggable Window */
        .window {
            position: absolute;
            background: #1a1a1a;
            border: 1px solid #333;
            display: flex;
            flex-direction: column;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.7);
            min-width: 200px;
            min-height: 150px;
        }

        .window.active {
            border-color: #007acc;
            box-shadow: 0 8px 32px rgba(0, 122, 204, 0.4);
        }

        .window-header {
            background: #2d2d2d;
            padding: 6px 10px;
            border-bottom: 1px solid #404040;
            font-size: 14px;
            font-weight: 700;
            color: #ffffff;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: move;
            user-select: none;
        }

        .window.active .window-header {
            background: #007acc;
        }

        .window-controls {
            display: flex;
            gap: 6px;
        }

        .window-btn {
            width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 16px;
            border-radius: 2px;
            transition: background 0.2s;
            font-weight: bold;
        }

        .window-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .window-btn.minimize { color: #fbbf24; }
        .window-btn.maximize { color: #22c55e; }
        .window-btn.close { color: #ef4444; }

        .window-content {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            background: #1a1a1a;
        }

        /* Resize Handles */
        .resize-handle {
            position: absolute;
            background: transparent;
            z-index: 10;
        }

        .resize-handle.n { top: 0; left: 0; right: 0; height: 5px; cursor: ns-resize; }
        .resize-handle.s { bottom: 0; left: 0; right: 0; height: 5px; cursor: ns-resize; }
        .resize-handle.e { top: 0; right: 0; bottom: 0; width: 5px; cursor: ew-resize; }
        .resize-handle.w { top: 0; left: 0; bottom: 0; width: 5px; cursor: ew-resize; }
        .resize-handle.ne { top: 0; right: 0; width: 10px; height: 10px; cursor: nesw-resize; }
        .resize-handle.nw { top: 0; left: 0; width: 10px; height: 10px; cursor: nwse-resize; }
        .resize-handle.se { bottom: 0; right: 0; width: 10px; height: 10px; cursor: nwse-resize; }
        .resize-handle.sw { bottom: 0; left: 0; width: 10px; height: 10px; cursor: nesw-resize; }

        /* Layout Controls */
        .layout-controls {
            position: fixed;
            bottom: 10px;
            right: 10px;
            display: flex;
            gap: 6px;
            z-index: 9998;
        }

        .layout-btn {
            padding: 8px 12px;
            background: #2d2d2d;
            border: 1px solid #007acc;
            color: #ffffff;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            border-radius: 3px;
            transition: all 0.2s;
            text-transform: uppercase;
        }

        .layout-btn:hover {
            background: #007acc;
        }

        /* Data Table Styles */
        .data-table {
            width: 100%;
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }

        .data-table thead {
            background: #2d2d2d;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .data-table th {
            padding: 6px 8px;
            text-align: left;
            font-weight: 700;
            color: #888;
            border-bottom: 1px solid #404040;
            text-transform: uppercase;
            font-size: 13px;
            letter-spacing: 0.5px;
        }

        .data-table td {
            padding: 5px 8px;
            border-bottom: 1px solid #252525;
        }

        .data-table tr:hover {
            background: #252525;
        }

        .data-table .clickable {
            cursor: pointer;
        }

        .data-table .clickable:hover {
            background: #007acc;
        }

        /* Module Specific Styles */
        .module-content {
            padding: 8px;
        }

        /* Quote Display */
        .quote-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 6px;
            padding: 8px;
            background: #1e1e1e;
        }

        .quote-stat {
            padding: 6px 8px;
            background: #252525;
            border: 1px solid #333;
            border-radius: 2px;
        }

        .quote-stat-label {
            font-size: 13px;
            color: #888;
            text-transform: uppercase;
            margin-bottom: 3px;
        }

        .quote-stat-value {
            font-size: 17px;
            font-weight: 700;
            font-family: 'Courier New', monospace;
        }

        .positive { color: #22c55e !important; }
        .negative { color: #ef4444 !important; }
        .neutral { color: #888 !important; }

        /* Level 2 */
        .level2-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1px;
            background: #404040;
            font-family: 'Courier New', monospace;
            height: 100%;
        }

        .level2-column {
            background: #1a1a1a;
            overflow-y: auto;
        }

        .level2-header {
            display: grid;
            grid-template-columns: 50px 70px 70px 50px;
            padding: 6px 4px;
            font-size: 13px;
            font-weight: 700;
            background: #2d2d2d;
            border-bottom: 1px solid #404040;
            position: sticky;
            top: 0;
            z-index: 5;
        }

        .level2-header div {
            text-align: center;
            color: #888;
        }

        .level2-row {
            display: grid;
            grid-template-columns: 50px 70px 70px 50px;
            padding: 3px 4px;
            font-size: 14px;
            border-bottom: 1px solid #222;
            position: relative;
        }

        .level2-row:hover {
            background: #252525;
        }

        .level2-row div {
            text-align: center;
            padding: 2px;
        }

        .level2-row.clickable {
            cursor: pointer;
        }

        .level2-price {
            font-weight: 700;
        }

        /* Order Entry */
        .order-entry-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-bottom: 8px;
        }

        .order-field {
            margin-bottom: 10px;
        }

        .order-field label {
            display: block;
            font-size: 13px;
            color: #888;
            margin-bottom: 4px;
            text-transform: uppercase;
            font-weight: 600;
        }

        .order-field input,
        .order-field select {
            width: 100%;
            padding: 6px 8px;
            background: #252525;
            border: 1px solid #404040;
            color: #fff;
            font-size: 15px;
            border-radius: 2px;
            font-family: 'Courier New', monospace;
        }

        .order-field input:focus,
        .order-field select:focus {
            outline: none;
            border-color: #007acc;
        }

        .quantity-buttons {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 4px;
            margin-bottom: 8px;
        }

        .qty-btn {
            padding: 6px;
            background: #252525;
            border: 1px solid #404040;
            color: #888;
            font-size: 14px;
            cursor: pointer;
            border-radius: 2px;
            transition: all 0.2s;
            font-weight: 600;
        }

        .qty-btn:hover {
            background: #404040;
            color: #fff;
        }

        .price-controls {
            display: grid;
            grid-template-columns: 40px 1fr 40px;
            gap: 4px;
            margin-bottom: 8px;
        }

        .price-btn {
            padding: 6px;
            background: #252525;
            border: 1px solid #404040;
            color: #007acc;
            font-size: 20px;
            font-weight: bold;
            cursor: pointer;
            border-radius: 2px;
        }

        .price-btn:hover {
            background: #007acc;
            color: #fff;
        }

        .order-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-top: 12px;
        }

        .btn {
            padding: 10px;
            border: none;
            cursor: pointer;
            font-size: 15px;
            font-weight: 700;
            border-radius: 3px;
            transition: all 0.2s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-buy {
            background: #22c55e;
            color: #000;
        }

        .btn-buy:hover {
            background: #16a34a;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(34, 197, 94, 0.3);
        }

        .btn-sell {
            background: #ef4444;
            color: #fff;
        }

        .btn-sell:hover {
            background: #dc2626;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(239, 68, 68, 0.3);
        }

        .btn-secondary {
            background: #404040;
            color: #fff;
        }

        .btn-secondary:hover {
            background: #525252;
        }

        .btn-danger {
            background: #991b1b;
            color: #fff;
        }

        .btn-danger:hover {
            background: #7f1d1d;
        }

        /* Watchlist */
        .watchlist-item {
            display: grid;
            grid-template-columns: 60px 1fr 60px;
            padding: 6px 8px;
            border-bottom: 1px solid #252525;
            cursor: pointer;
            transition: background 0.2s;
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }

        .watchlist-item:hover {
            background: #252525;
        }

        .watchlist-item.active {
            background: #007acc;
        }

        .watchlist-symbol {
            font-weight: 700;
            font-size: 15px;
        }

        .watchlist-price {
            text-align: right;
        }

        .watchlist-change {
            text-align: right;
            font-size: 13px;
        }

        /* Account */
        .account-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 6px;
            padding: 8px;
        }

        .account-stat {
            padding: 6px 8px;
            background: #252525;
            border: 1px solid #333;
            border-radius: 2px;
        }

        .account-stat-label {
            font-size: 13px;
            color: #888;
            margin-bottom: 3px;
            text-transform: uppercase;
        }

        .account-stat-value {
            font-size: 16px;
            font-weight: 700;
            font-family: 'Courier New', monospace;
        }

        /* Time & Sales */
        .timesales-row {
            display: grid;
            grid-template-columns: 70px 80px 60px 40px;
            padding: 4px 8px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            border-bottom: 1px solid #222;
        }

        .timesales-row:hover {
            background: #252525;
        }

        .timesales-time { color: #666; }
        .timesales-price { text-align: right; font-weight: 700; }
        .timesales-size { text-align: right; color: #888; }
        .timesales-side { text-align: center; font-size: 13px; }

        .empty-state {
            padding: 30px 20px;
            text-align: center;
            color: #555;
            font-style: italic;
            font-size: 15px;
        }

        /* Chart */
        .chart-container {
            width: 100%;
            height: 100%;
            min-height: 300px;
            background: #1a1a1a;
        }

        .chart-link-btn {
            width: 22px;
            height: 18px;
            border: 1px solid #444;
            border-radius: 3px;
            background: #2a2a2a;
            cursor: pointer;
            font-size: 11px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s;
            padding: 0;
        }

        .chart-link-btn.linked {
            background: #1e3a5f;
            border-color: #3b82f6;
        }

        .chart-link-btn.unlinked {
            background: #3f3f46;
            border-color: #666;
            opacity: 0.8;
        }

        .chart-link-btn:hover {
            transform: scale(1.1);
            opacity: 1;
        }

        /* Position Badge */
        .pos-badge {
            padding: 2px 6px;
            border-radius: 2px;
            font-size: 13px;
            font-weight: 700;
        }

        .pos-badge.long {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
        }

        .pos-badge.short {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        /* Action Button */
        .action-btn {
            padding: 4px 8px;
            font-size: 13px;
            background: #404040;
            border: 1px solid #555;
            color: #fff;
            cursor: pointer;
            border-radius: 2px;
            transition: all 0.2s;
        }

        .action-btn:hover {
            background: #007acc;
            border-color: #007acc;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #1a1a1a;
        }

        ::-webkit-scrollbar-thumb {
            background: #404040;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
    </style>
</head>
<body>
    <!-- Top Bar -->
    <div class="top-bar">
        <div class="top-bar-left">
            <h1>‚ö° ALPACA PROFESSIONAL TRADING PLATFORM</h1>
        </div>
        <div class="top-bar-right">
            <div class="status-item">
                <div class="status-dot" id="alpacaStatus"></div>
                <span>Alpaca: <strong id="alpacaStatusText">Disconnected</strong></span>
            </div>
            <div class="status-item">
                <div class="status-dot" id="aiStatus"></div>
                <span>AI: <strong id="aiStatusText">Offline</strong></span>
            </div>
            <div class="status-item">
                <span>Current: <strong id="currentSymbolDisplay">AAPL</strong></span>
            </div>
        </div>
    </div>

    <!-- Menu Bar -->
    <div class="menu-bar">
        <div class="menu-item" onclick="toggleDropdown('layouts-dropdown')">
            üìê LAYOUTS
            <div class="dropdown" id="layouts-dropdown">
                <strong>Preset Layouts</strong>
                <a href="#" onclick="event.preventDefault(); loadLayout('default')">üìä Default</a>
                <a href="#" onclick="event.preventDefault(); loadLayout('trading')">‚ö° Trading</a>
                <a href="#" onclick="event.preventDefault(); loadLayout('analysis')">üìà Analysis</a>
                <a href="#" onclick="event.preventDefault(); loadLayout('scalping')">üéØ Scalping</a>
                <hr>
                <a href="#" onclick="event.preventDefault(); resetLayout()">üîÑ Reset to Default</a>
            </div>
        </div>
        <div class="menu-item" onclick="toggleDropdown('configs-dropdown')" style="background: #1e3a8a;">
            üíæ CONFIGURATIONS
            <div class="dropdown" id="configs-dropdown">
                <strong>Saved Configurations</strong>
                <div id="savedConfigsList" style="max-height: 300px; overflow-y: auto;">
                    <!-- Dynamically populated -->
                </div>
                <hr>
                <a href="#" onclick="event.preventDefault(); showSaveConfigDialog()">üíæ Save Current As...</a>
                <a href="#" onclick="event.preventDefault(); setAsDefaultLayout()">‚≠ê Set as Startup Default</a>
                <a href="#" onclick="event.preventDefault(); showManageConfigsDialog()">‚öôÔ∏è Manage Configurations</a>
            </div>
        </div>
        <div class="menu-item" onclick="toggleDropdown('switch-ui-dropdown')">
            üñ•Ô∏è Switch UI
            <div class="dropdown" id="switch-ui-dropdown">
                <strong>Available Dashboards</strong>
                <a href="/ui/monitor.html" target="_blank">üéõÔ∏è Monitor Dashboard</a>
                <a href="/ui/live_dashboard.html" target="_blank">üìà Live Dashboard</a>
                <a href="/ui/trading_platform_complete.html" target="_blank">üìä Trading Platform</a>
                <a href="/ui/complete_platform.html">üñ•Ô∏è Complete Platform (Current)</a>
                <hr>
                <strong>Open New Instance</strong>
                <a href="#" onclick="event.preventDefault(); openNewDashboardInstance()">‚ûï New Dashboard Window</a>
            </div>
        </div>
        <div class="menu-item" onclick="toggleDropdown('charts-dropdown')">
            üìä CHARTS
            <div class="dropdown" id="charts-dropdown">
                <strong>Quick Add (Uses Your Defaults)</strong>
                <a href="#" onclick="event.preventDefault(); addChartWithDefault('1')">üìä 1 Minute</a>
                <a href="#" onclick="event.preventDefault(); addChartWithDefault('5')">üìä 5 Minutes</a>
                <a href="#" onclick="event.preventDefault(); addChartWithDefault('15')">üìä 15 Minutes</a>
                <a href="#" onclick="event.preventDefault(); addChartWithDefault('60')">üìä 1 Hour</a>
                <a href="#" onclick="event.preventDefault(); addChartWithDefault('D')">üìä Daily</a>
                <hr>
                <strong>Templates</strong>
                <a href="#" onclick="event.preventDefault(); showAddChartDialog()">üìä Add Chart (Select Template)...</a>
                <a href="#" onclick="event.preventDefault(); showCreateTemplateDialog()">üé® Create New Template...</a>
                <a href="#" onclick="event.preventDefault(); showManageTemplatesDialog()">üìã Manage Templates & Defaults...</a>
            </div>
        </div>
        <div class="menu-item" onclick="toggleDropdown('tradingview-dropdown')" style="background: #2563eb;">
            üì∫ TV DESKTOP
            <div class="dropdown" id="tradingview-dropdown" style="width: 280px;">
                <strong>üñ•Ô∏è Open in TradingView Desktop</strong>
                <a href="#" onclick="event.preventDefault(); openTVDesktop(currentSymbol, '1')">üìä 1 Minute Chart</a>
                <a href="#" onclick="event.preventDefault(); openTVDesktop(currentSymbol, '5')">üìä 5 Minute Chart</a>
                <a href="#" onclick="event.preventDefault(); openTVDesktop(currentSymbol, '15')">üìä 15 Minute Chart</a>
                <a href="#" onclick="event.preventDefault(); openTVDesktop(currentSymbol, '60')">üìä 1 Hour Chart</a>
                <a href="#" onclick="event.preventDefault(); openTVDesktop(currentSymbol, 'D')">üìä Daily Chart</a>
                <a href="#" onclick="event.preventDefault(); openTVDesktop(currentSymbol, 'W')">üìä Weekly Chart</a>
                <hr>
                <strong>üöÄ Quick Actions</strong>
                <a href="#" onclick="event.preventDefault(); openTVDesktopMulti()">üì∫ Open All Watchlist Symbols</a>
                <a href="#" onclick="event.preventDefault(); copySymbolToClipboard()">üìã Copy Symbol to Clipboard</a>
                <a href="#" onclick="event.preventDefault(); showTVDesktopHelp()">‚ùì How to Use TV Desktop</a>
                <hr>
                <strong>‚ö° Webhook Integration</strong>
                <a href="#" onclick="event.preventDefault(); showWebhookInfo()">üîó Webhook URL & Setup</a>
                <a href="#" onclick="event.preventDefault(); showWebhookLogs()">üìä View Webhook Logs</a>
                <a href="#" onclick="event.preventDefault(); testWebhook()">üß™ Test Webhook</a>
                <hr>
                <strong>üìÅ Watchlist Sync</strong>
                <a href="#" onclick="event.preventDefault(); exportWatchlist()">‚¨áÔ∏è Export Watchlist for TV</a>
                <a href="#" onclick="event.preventDefault(); showSetupGuide()">üìö Setup Guide</a>
            </div>
        </div>
        <div class="menu-item" onclick="connectToAlpaca()">üîå Connect Alpaca</div>
        <div class="menu-item" onclick="openPDTMonitor()" style="background: #7f1d1d;">‚öñÔ∏è PDT Monitor</div>
        <div class="menu-item" onclick="openAIControlPanel()" style="background: #1e40af;">ü§ñ AI Control</div>
        <div class="menu-item" onclick="openClaudeChatWindow()" style="background: #7c3aed;">üí¨ Claude Chat</div>
    </div>

    <!-- Workspace -->
    <div class="workspace" id="workspace"></div>

    <!-- Configuration Dialogs -->
    <div class="config-dialog-overlay" id="saveConfigDialog">
        <div class="config-dialog">
            <div class="config-dialog-header">üíæ Save Configuration</div>
            <div class="config-dialog-body">
                <label style="display: block; margin-bottom: 8px; color: #888; font-size: 14px;">Configuration Name:</label>
                <input type="text" class="config-input" id="configNameInput" placeholder="e.g., My Trading Setup" />
                <div style="font-size: 12px; color: #666; margin-top: 5px;">
                    This will save the current window layout and watchlist.
                </div>
            </div>
            <div class="config-dialog-footer">
                <button class="btn btn-secondary" onclick="closeSaveConfigDialog()">Cancel</button>
                <button class="btn btn-buy" onclick="saveConfiguration()">üíæ Save</button>
            </div>
        </div>
    </div>

    <div class="config-dialog-overlay" id="manageConfigsDialog">
        <div class="config-dialog">
            <div class="config-dialog-header">‚öôÔ∏è Manage Configurations</div>
            <div class="config-dialog-body">
                <div id="manageConfigsList">
                    <!-- Dynamically populated -->
                </div>
                <div id="noConfigsMessage" style="text-align: center; padding: 40px 20px; color: #666;">
                    No saved configurations yet.<br>
                    <small>Save your first configuration from the CONFIGURATIONS menu!</small>
                </div>
            </div>
            <div class="config-dialog-footer">
                <button class="btn btn-secondary" onclick="closeManageConfigsDialog()">Close</button>
            </div>
        </div>
    </div>

    <div class="config-dialog-overlay" id="addChartDialog">
        <div class="config-dialog">
            <div class="config-dialog-header">üìä Add Chart</div>
            <div class="config-dialog-body">
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 8px; color: #888; font-size: 14px;">Chart Template:</label>
                    <select class="config-input" id="chartTemplate" onchange="updateTemplateDescription()">
                        <option value="default">Default (5m) - SMA + RSI</option>
                        <option value="scalping">Scalping (1m) - EMA + VWAP + MACD</option>
                        <option value="daytrading">Day Trading (5m) - EMA + VWAP + RSI + Vol</option>
                        <option value="swing">Swing (1H) - SMA + RSI + MACD + BB</option>
                        <option value="momentum">Momentum (15m) - EMA + RSI + MACD + VWAP</option>
                        <option value="volume">Volume Profile (5m) - VWAP + Volume + SMA</option>
                        <option value="clean">Clean - Price Only (No Indicators)</option>
                        <option value="warrior">Warrior Trading (1m) - 9 EMA + VWAP + Volume</option>
                    </select>
                </div>
                <div id="templateDescription" style="background: #1e1e1e; border: 1px solid #333; padding: 10px; border-radius: 4px; margin-bottom: 15px; font-size: 12px;">
                    <div style="color: #60a5fa; font-weight: 600; margin-bottom: 5px;">Template Details:</div>
                    <div id="templateDetails" style="color: #888;">SMA + RSI on 5-minute timeframe</div>
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 8px; color: #888; font-size: 14px;">Custom Timeframe (Optional):</label>
                    <select class="config-input" id="chartTimeframe">
                        <option value="" selected>Use Template Default</option>
                        <option value="1">1 Minute</option>
                        <option value="5">5 Minutes</option>
                        <option value="15">15 Minutes</option>
                        <option value="30">30 Minutes</option>
                        <option value="60">1 Hour</option>
                        <option value="240">4 Hours</option>
                        <option value="D">Daily</option>
                        <option value="W">Weekly</option>
                        <option value="M">Monthly</option>
                    </select>
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 8px; color: #888; font-size: 14px;">Chart Style:</label>
                    <select class="config-input" id="chartStyle">
                        <option value="1" selected>Candles</option>
                        <option value="0">Bars</option>
                        <option value="9">Heikin Ashi</option>
                        <option value="3">Line</option>
                        <option value="8">Area</option>
                    </select>
                </div>
                <div style="font-size: 12px; color: #666; margin-top: 10px;">
                    Chart will be created for current symbol: <span id="chartSymbolPreview" style="color: #007acc; font-weight: 700;">AAPL</span>
                </div>
            </div>
            <div class="config-dialog-footer">
                <button class="btn btn-secondary" onclick="closeAddChartDialog()">Cancel</button>
                <button class="btn btn-buy" onclick="createCustomChart()">üìä Add Chart</button>
            </div>
        </div>
    </div>

    <!-- Create Custom Template Dialog -->
    <div class="config-dialog-overlay" id="createTemplateDialog">
        <div class="config-dialog" style="max-width: 550px;">
            <div class="config-dialog-header">üé® Create Custom Chart Template</div>
            <div class="config-dialog-body">
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 8px; color: #888; font-size: 14px;">Template Name:</label>
                    <input type="text" class="config-input" id="newTemplateName" placeholder="My Trading Setup">
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 8px; color: #888; font-size: 14px;">Default Timeframe:</label>
                    <select class="config-input" id="newTemplateTimeframe">
                        <option value="1">1 Minute</option>
                        <option value="5" selected>5 Minutes</option>
                        <option value="15">15 Minutes</option>
                        <option value="30">30 Minutes</option>
                        <option value="60">1 Hour</option>
                        <option value="240">4 Hours</option>
                        <option value="D">Daily</option>
                        <option value="W">Weekly</option>
                    </select>
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 8px; color: #888; font-size: 14px;">Chart Style:</label>
                    <select class="config-input" id="newTemplateStyle">
                        <option value="1" selected>Candles</option>
                        <option value="0">Bars</option>
                        <option value="9">Heikin Ashi</option>
                        <option value="3">Line</option>
                    </select>
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 8px; color: #888; font-size: 14px;">Select Indicators:</label>
                    <div id="indicatorCheckboxes" style="max-height: 200px; overflow-y: auto; background: #1e1e1e; border: 1px solid #333; border-radius: 4px; padding: 10px;">
                        <!-- Populated by JS -->
                    </div>
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: flex; align-items: center; gap: 8px; color: #60a5fa; cursor: pointer;">
                        <input type="checkbox" id="setAsTimeframeDefault" style="width: 16px; height: 16px;">
                        <span>Set as default for this timeframe</span>
                    </label>
                </div>
            </div>
            <div class="config-dialog-footer">
                <button class="btn btn-secondary" onclick="closeCreateTemplateDialog()">Cancel</button>
                <button class="btn btn-buy" onclick="saveNewTemplate()">üíæ Save Template</button>
            </div>
        </div>
    </div>

    <!-- Manage Templates Dialog -->
    <div class="config-dialog-overlay" id="manageTemplatesDialog">
        <div class="config-dialog" style="max-width: 600px;">
            <div class="config-dialog-header">üìã Manage Chart Templates</div>
            <div class="config-dialog-body">
                <div style="margin-bottom: 15px;">
                    <div style="color: #60a5fa; font-weight: 600; margin-bottom: 10px;">Timeframe Defaults:</div>
                    <div id="timeframeDefaultsList" style="background: #1e1e1e; border: 1px solid #333; border-radius: 4px; padding: 10px; margin-bottom: 15px;">
                        <!-- Populated by JS -->
                    </div>
                </div>
                <div style="margin-bottom: 15px;">
                    <div style="color: #60a5fa; font-weight: 600; margin-bottom: 10px;">Custom Templates:</div>
                    <div id="customTemplatesList" style="background: #1e1e1e; border: 1px solid #333; border-radius: 4px; padding: 10px; max-height: 300px; overflow-y: auto;">
                        <!-- Populated by JS -->
                    </div>
                </div>
            </div>
            <div class="config-dialog-footer">
                <button class="btn btn-buy" onclick="showCreateTemplateDialog()" style="margin-right: auto;">+ New Template</button>
                <button class="btn btn-secondary" onclick="closeManageTemplatesDialog()">Close</button>
            </div>
        </div>
    </div>

    <!-- TradingView Webhook Info Dialog -->
    <div class="config-dialog-overlay" id="webhookInfoDialog">
        <div class="config-dialog" style="max-width: 700px;">
            <div class="config-dialog-header">‚ö° TradingView Webhook Setup</div>
            <div class="config-dialog-body">
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 8px; color: #007acc; font-size: 14px; font-weight: 700;">Webhook URL:</label>
                    <div style="display: flex; gap: 5px;">
                        <input type="text" class="config-input" id="webhookUrl" readonly value="http://127.0.0.1:9101/api/tradingview/webhook" style="flex: 1; font-family: monospace; font-size: 13px;">
                        <button class="btn btn-secondary" onclick="copyWebhookUrl()" style="padding: 10px 15px;">üìã Copy</button>
                    </div>
                </div>
                <div style="background: #1a1a1a; border: 1px solid #333; border-radius: 4px; padding: 15px; margin-bottom: 15px;">
                    <div style="font-size: 13px; color: #888; font-weight: 700; margin-bottom: 10px;">ALERT MESSAGE FORMAT:</div>
                    <pre style="background: #252525; padding: 10px; border-radius: 3px; font-size: 12px; color: #22c55e; overflow-x: auto; margin: 0;">{
  "action": "{{strategy.order.action}}",
  "symbol": "{{ticker}}",
  "price": {{close}},
  "confidence": 0.85,
  "target": {{close}} * 1.05,
  "stop": {{close}} * 0.98
}</pre>
                </div>
                <div style="font-size: 12px; color: #666;">
                    <strong style="color: #007acc;">Setup Steps:</strong><br>
                    1. Open TradingView Desktop<br>
                    2. Create an alert on your chart<br>
                    3. Set "Webhook URL" to the URL above<br>
                    4. Paste the alert message format<br>
                    5. Test with the "Test Webhook" button below
                </div>
            </div>
            <div class="config-dialog-footer">
                <button class="btn btn-secondary" onclick="closeWebhookInfoDialog()">Close</button>
                <button class="btn btn-buy" onclick="openTradingViewSetupGuide()">üìö Full Guide</button>
            </div>
        </div>
    </div>

    <!-- TradingView Webhook Logs Dialog -->
    <div class="config-dialog-overlay" id="webhookLogsDialog">
        <div class="config-dialog" style="max-width: 800px;">
            <div class="config-dialog-header">üìä Webhook Activity Logs</div>
            <div class="config-dialog-body">
                <div id="webhookLogsList" style="max-height: 400px; overflow-y: auto; font-family: monospace; font-size: 12px;">
                    <div style="text-align: center; padding: 40px; color: #666;">
                        Loading webhook logs...
                    </div>
                </div>
            </div>
            <div class="config-dialog-footer">
                <button class="btn btn-danger" onclick="clearWebhookLogs()">üóëÔ∏è Clear Logs</button>
                <button class="btn btn-secondary" onclick="closeWebhookLogsDialog()">Close</button>
                <button class="btn btn-buy" onclick="refreshWebhookLogs()">üîÑ Refresh</button>
            </div>
        </div>
    </div>

    <!-- Halt Indicator (DISABLED - Now in quote window) -->
    <div id="haltIndicator" style="display: none;"></div>

    <style>
        @keyframes pulse {
            0%, 100% { opacity: 1; transform: translateX(-50%) scale(1); }
            50% { opacity: 0.85; transform: translateX(-50%) scale(1.02); }
        }
    </style>

    <!-- Layout Controls -->
    <div class="layout-controls">
        <button class="layout-btn" onclick="tileWindows()">‚äû Tile</button>
        <button class="layout-btn" onclick="cascadeWindows()">‚ßâ Cascade</button>
        <button class="layout-btn" onclick="minimizeAll()">‚ñº Min All</button>
        <button class="layout-btn" onclick="restoreAll()">‚ñ≤ Restore</button>
    </div>

    <script>
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        //           MULTI-DASHBOARD INSTANCE SUPPORT (MUST BE FIRST!)
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        // Get current instance ID from URL or use default
        function getDashboardInstanceId() {
            const params = new URLSearchParams(window.location.search);
            return params.get('instance') || 'default';
        }

        // Get storage key with instance prefix
        function getStorageKey(key) {
            const instanceId = getDashboardInstanceId();
            return instanceId === 'default' ? key : `${instanceId}_${key}`;
        }

        // Override localStorage methods for instance isolation BEFORE any code runs
        (function initInstanceIsolation() {
            const originalGetItem = localStorage.getItem.bind(localStorage);
            const originalSetItem = localStorage.setItem.bind(localStorage);
            const originalRemoveItem = localStorage.removeItem.bind(localStorage);

            // Keys that should be isolated per instance
            const instanceKeys = ['watchlist', 'customLayout', 'tradingLayout', 'currentSymbol'];

            localStorage.getItem = function(key) {
                if (instanceKeys.includes(key)) {
                    return originalGetItem(getStorageKey(key));
                }
                return originalGetItem(key);
            };

            localStorage.setItem = function(key, value) {
                if (instanceKeys.includes(key)) {
                    return originalSetItem(getStorageKey(key), value);
                }
                return originalSetItem(key, value);
            };

            localStorage.removeItem = function(key) {
                if (instanceKeys.includes(key)) {
                    return originalRemoveItem(getStorageKey(key));
                }
                return originalRemoveItem(key);
            };

            // Update window title with instance info
            const instanceId = getDashboardInstanceId();
            if (instanceId !== 'default') {
                document.title = `Trading Platform - Instance ${instanceId.split('_')[1]}`;
            }

            console.log(`Dashboard Instance: ${instanceId}`);
        })();

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        //              GLOBAL UTILITY FUNCTIONS (MUST BE EARLY)
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        // Dropdown menu functionality - must be global for onclick handlers
        function toggleDropdown(dropdownId) {
            const dropdown = document.getElementById(dropdownId);
            const allDropdowns = document.querySelectorAll('.dropdown');

            // Close all other dropdowns
            allDropdowns.forEach(d => {
                if (d.id !== dropdownId) {
                    d.classList.remove('show');
                }
            });

            // Toggle the clicked dropdown
            if (dropdown) {
                dropdown.classList.toggle('show');
            }

            // Prevent event bubbling
            if (event) {
                event.stopPropagation();
            }
        }

        // Close dropdowns when clicking outside
        document.addEventListener('click', function(event) {
            if (!event.target.closest('.menu-item')) {
                document.querySelectorAll('.dropdown').forEach(d => {
                    d.classList.remove('show');
                });
            }
        });

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        //                     GLOBAL STATE
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        let windows = [];
        let activeWindow = null;
        let zIndexCounter = 100;
        let currentSymbol = 'AAPL';
        let watchlist = ['AAPL', 'MSFT', 'GOOGL', 'TSLA', 'NVDA', 'SPY', 'QQQ'];

        // CENTRALIZED MARKET DATA STORE - Single source of truth for all prices
        const marketDataStore = {
            data: {},
            subscribers: [],

            update(symbol, newData) {
                const existing = this.data[symbol] || {};
                this.data[symbol] = {
                    ...existing,
                    ...newData,
                    timestamp: Date.now()
                };
                this.notifySubscribers(symbol);
                // Also update legacy cache for compatibility
                marketDataCache[symbol] = this.data[symbol];
            },

            get(symbol) {
                return this.data[symbol] || null;
            },

            subscribe(callback) {
                this.subscribers.push(callback);
            },

            notifySubscribers(symbol) {
                const data = this.data[symbol];
                this.subscribers.forEach(callback => {
                    try { callback(symbol, data); } catch (e) { console.error('[SYNC]', e); }
                });
            },

            isFresh(symbol) {
                const data = this.data[symbol];
                return data && data.timestamp && (Date.now() - data.timestamp) < 5000;
            }
        };

        // UNIFIED REFRESH SYSTEM - Updates store and notifies all components
        let unifiedRefreshInterval = null;

        function startUnifiedRefresh() {
            // Clear any existing interval
            if (unifiedRefreshInterval) {
                clearInterval(unifiedRefreshInterval);
            }

            // Refresh every 2 seconds for synchronized updates
            unifiedRefreshInterval = setInterval(async () => {
                if (currentSymbol) {
                    await fetchAndUpdateStore(currentSymbol);
                }

                // Also refresh worklist if it's being displayed
                if (document.getElementById('worklistDisplay')) {
                    await refreshWorklistPrices();
                }
            }, 2000);
        }

        async function fetchAndUpdateStore(symbol) {
            try {
                const apiData = await apiFetch(`/api/price/${symbol}`);
                if (apiData && apiData.data) {
                    const d = apiData.data;
                    marketDataStore.update(symbol, {
                        last: d.last,
                        bid: d.bid,
                        ask: d.ask,
                        volume: d.volume,
                        high: d.high,
                        low: d.low,
                        open: d.open,
                        close: d.close,
                        bidSize: d.bidSize,
                        askSize: d.askSize,
                        change: d.change,
                        changePercent: d.changePercent
                    });
                    console.log(`[SYNC] ${symbol} updated from unified refresh: $${d.last?.toFixed(2)}`);
                }
            } catch (error) {
                console.error('[SYNC] Error in unified refresh:', error);
            }
        }

        async function refreshWorklistPrices() {
            try {
                const response = await fetch(API_BASE_URL + '/api/worklist');
                const result = await response.json();
                if (result.success && result.data) {
                    result.data.forEach(item => {
                        marketDataStore.update(item.symbol, {
                            last: item.current_price,
                            bid: item.bid,
                            ask: item.ask,
                            volume: item.volume,
                            change: item.change,
                            change_percent: item.change_percent
                        });
                    });
                }
            } catch (error) {
                console.error('[SYNC] Error refreshing worklist:', error);
            }
        }

        // Subscribe all components to store updates
        marketDataStore.subscribe((symbol, data) => {
            // Update Quote panel if this is current symbol
            if (symbol === currentSymbol) {
                updateQuotePanelFromStore(symbol, data);
                updateOrderPanelFromStore(symbol, data);
            }

            // Update worklist row for this symbol
            updateWorklistRowFromStore(symbol, data);
        });

        function updateQuotePanelFromStore(symbol, data) {
            if (!data) return;

            safeUpdate('bidPrice', data.bid?.toFixed(2) || '--');
            safeUpdate('askPrice', data.ask?.toFixed(2) || '--');
            safeUpdate('lastPrice', data.last?.toFixed(2) || '--');
            safeUpdate('volumePrice', data.volume?.toLocaleString() || '--');
            safeUpdate('highPrice', data.high?.toFixed(2) || '--');
            safeUpdate('lowPrice', data.low?.toFixed(2) || '--');
            safeUpdate('openPrice', data.open?.toFixed(2) || '--');
            safeUpdate('closePrice', data.close?.toFixed(2) || '--');

            if (data.bid) safeUpdate('bidSize', `x ${data.bidSize || 0}`);
            if (data.ask) safeUpdate('askSize', `x ${data.askSize || 0}`);

            // Calculate and display change
            if (data.last && data.close) {
                const change = data.last - data.close;
                const changePct = ((change / data.close) * 100).toFixed(2);
                const changeEl = document.getElementById('priceChange');
                if (changeEl) {
                    changeEl.textContent = `${change >= 0 ? '+' : ''}${change.toFixed(2)} (${changePct}%)`;
                    changeEl.className = change >= 0 ? 'quote-stat-label positive' : 'quote-stat-label negative';
                }
            }
        }

        function updateOrderPanelFromStore(symbol, data) {
            if (!data) return;

            safeUpdate('marketBid', data.bid?.toFixed(2) || '--');
            safeUpdate('marketLast', data.last?.toFixed(2) || '--');
            safeUpdate('marketAsk', data.ask?.toFixed(2) || '--');

            // Auto-set limit price to mid (only if field is not focused and empty/invalid)
            const orderTypeEl = document.getElementById('orderType');
            const orderPriceEl = document.getElementById('orderPrice');
            if (data.bid && data.ask && data.bid > 0 && data.ask > 0 && orderTypeEl && orderTypeEl.value === 'LIMIT') {
                if (document.activeElement !== orderPriceEl &&
                    (!orderPriceEl.value || orderPriceEl.value === '' || parseFloat(orderPriceEl.value) <= 0)) {
                    const mid = ((data.bid + data.ask) / 2).toFixed(2);
                    safeUpdate('orderPrice', mid);
                }
            }
        }

        function updateWorklistRowFromStore(symbol, data) {
            if (!data) return;

            // Find the row in worklist table
            const rows = document.querySelectorAll('#worklistDisplay tbody tr');
            rows.forEach(row => {
                const symbolCell = row.querySelector('td:first-child');
                if (symbolCell && symbolCell.textContent.includes(symbol)) {
                    // Update price cell (second column)
                    const priceCell = row.querySelector('td:nth-child(2)');
                    if (priceCell && data.last) {
                        const isFresh = marketDataStore.isFresh(symbol);
                        const liveIndicator = isFresh ? '<span style="color: #22c55e; margin-left: 4px;" title="Live data">üü¢</span>' :
                                              '<span style="color: #eab308; margin-left: 4px;" title="Delayed">üü°</span>';
                        priceCell.innerHTML = `${data.last.toFixed(2)}${liveIndicator}`;

                        // Add flash animation
                        priceCell.classList.add('price-flash');
                        setTimeout(() => priceCell.classList.remove('price-flash'), 500);
                    }

                    // Update change cell (third column)
                    const changeCell = row.querySelector('td:nth-child(3)');
                    if (changeCell && data.change_percent !== undefined) {
                        const changeClass = data.change_percent >= 0 ? 'positive' : 'negative';
                        changeCell.innerHTML = `<span class="${changeClass}">${data.change_percent.toFixed(2)}%</span>`;
                    }
                }
            });
        }

        let marketDataCache = {}; // Legacy cache
        let positionsCache = [];
        let apiAvailable = null; // null = unknown, true = available, false = demo mode
        let demoModeLogged = false;
        const API_BASE_URL = 'http://127.0.0.1:9100'; // API server base URL

        // Halt Detection State
        let haltState = {
            isHalted: false,
            haltTime: null,
            haltPrice: null,
            resumeTime: null,
            lastUpdateTime: null,
            symbol: null
        };

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        //                     WINDOW MANAGEMENT
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        class DraggableWindow {
            constructor(id, title, content, x, y, width, height) {
                this.id = id;
                this.title = title;
                this.x = x;
                this.y = y;
                this.width = width;
                this.height = height;
                this.minimized = false;
                this.maximized = false;
                this.savedState = null;
                this.element = null;
                this.create(content);
            }

            create(content) {
                const win = document.createElement('div');
                win.className = 'window';
                win.id = `window-${this.id}`;
                win.style.left = this.x + 'px';
                win.style.top = this.y + 'px';
                win.style.width = this.width + 'px';
                win.style.height = this.height + 'px';
                win.style.zIndex = ++zIndexCounter;

                // Add chart controls to header for chart windows
                let chartControls = '';
                if (this.id.startsWith('chart')) {
                    const chartId = this.id.replace('chart', '');
                    chartControls = `
                        <div class="chart-header-controls" style="display: flex; align-items: center; gap: 6px; margin-left: 8px;">
                            <button id="chart-link-${chartId}" class="chart-link-btn linked" onclick="event.stopPropagation(); toggleChartLink('${chartId}')" title="Click to unlink">üîó</button>
                            <input type="text" id="chart-symbol-${chartId}" class="chart-symbol-input"
                                   style="width: 60px; padding: 2px 5px; background: #2a2a2a; border: 1px solid #444; border-radius: 3px; color: #22c55e; font-size: 11px; font-weight: bold; text-transform: uppercase; display: none;"
                                   onclick="event.stopPropagation()"
                                   onkeypress="if(event.key==='Enter') setChartSymbol('${chartId}', this.value)"
                            />
                            <span id="chart-symbol-display-${chartId}" style="color: #22c55e; font-weight: bold; font-size: 11px;"></span>
                            <select id="chart-template-${chartId}" class="chart-template-select"
                                    style="padding: 2px 4px; background: #2a2a2a; border: 1px solid #444; border-radius: 3px; color: #60a5fa; font-size: 10px; cursor: pointer; max-width: 100px;"
                                    onclick="event.stopPropagation(); refreshChartTemplateDropdown('${chartId}')"
                                    onchange="changeChartTemplate('${chartId}', this.value)"
                                    title="Select chart template">
                                <!-- Options populated dynamically -->
                            </select>
                        </div>
                    `;
                }

                win.innerHTML = `
                    <div class="window-header">
                        <span>${this.title}</span>
                        ${chartControls}
                        <div class="window-controls">
                            <div class="window-btn minimize" onclick="minimizeWindow('${this.id}')">‚àí</div>
                            <div class="window-btn maximize" onclick="maximizeWindow('${this.id}')">‚ñ°</div>
                            <div class="window-btn close" onclick="closeWindow('${this.id}')">√ó</div>
                        </div>
                    </div>
                    <div class="window-content">${content}</div>
                    <div class="resize-handle n"></div>
                    <div class="resize-handle s"></div>
                    <div class="resize-handle e"></div>
                    <div class="resize-handle w"></div>
                    <div class="resize-handle ne"></div>
                    <div class="resize-handle nw"></div>
                    <div class="resize-handle se"></div>
                    <div class="resize-handle sw"></div>
                `;

                this.element = win;
                document.getElementById('workspace').appendChild(win);
                this.setupDrag();
                this.setupResize();
                win.addEventListener('mousedown', () => this.activate());
            }

            setupDrag() {
                const header = this.element.querySelector('.window-header');
                let isDragging = false;
                let startX, startY, startLeft, startTop;

                header.addEventListener('mousedown', (e) => {
                    if (e.target.classList.contains('window-btn')) return;
                    isDragging = true;
                    startX = e.clientX;
                    startY = e.clientY;
                    startLeft = this.x;
                    startTop = this.y;
                    this.activate();
                });

                document.addEventListener('mousemove', (e) => {
                    if (!isDragging) return;
                    this.x = startLeft + e.clientX - startX;
                    this.y = startTop + e.clientY - startY;
                    this.element.style.left = this.x + 'px';
                    this.element.style.top = this.y + 'px';
                });

                document.addEventListener('mouseup', () => isDragging = false);
            }

            setupResize() {
                const handles = this.element.querySelectorAll('.resize-handle');
                handles.forEach(handle => {
                    let isResizing = false;
                    let startX, startY, startWidth, startHeight, startLeft, startTop;
                    const direction = handle.className.split(' ')[1];

                    handle.addEventListener('mousedown', (e) => {
                        e.stopPropagation();
                        isResizing = true;
                        startX = e.clientX;
                        startY = e.clientY;
                        startWidth = this.width;
                        startHeight = this.height;
                        startLeft = this.x;
                        startTop = this.y;
                        this.activate();
                    });

                    document.addEventListener('mousemove', (e) => {
                        if (!isResizing) return;
                        const dx = e.clientX - startX;
                        const dy = e.clientY - startY;

                        if (direction.includes('e')) this.width = Math.max(200, startWidth + dx);
                        if (direction.includes('w')) {
                            const newWidth = Math.max(200, startWidth - dx);
                            if (newWidth > 200) {
                                this.width = newWidth;
                                this.x = startLeft + dx;
                            }
                        }
                        if (direction.includes('s')) this.height = Math.max(150, startHeight + dy);
                        if (direction.includes('n')) {
                            const newHeight = Math.max(150, startHeight - dy);
                            if (newHeight > 150) {
                                this.height = newHeight;
                                this.y = startTop + dy;
                            }
                        }

                        this.updatePosition();
                    });

                    document.addEventListener('mouseup', () => isResizing = false);
                });
            }

            updatePosition() {
                this.element.style.left = this.x + 'px';
                this.element.style.top = this.y + 'px';
                this.element.style.width = this.width + 'px';
                this.element.style.height = this.height + 'px';
            }

            activate() {
                windows.forEach(w => w.element.classList.remove('active'));
                this.element.classList.add('active');
                this.element.style.zIndex = ++zIndexCounter;
                activeWindow = this;
            }

            minimize() {
                if (!this.minimized) {
                    this.element.style.display = 'none';
                    this.minimized = true;
                }
            }

            restore() {
                if (this.minimized) {
                    this.element.style.display = 'flex';
                    this.minimized = false;
                    this.activate();
                }
                if (this.maximized) {
                    if (this.savedState) {
                        this.x = this.savedState.x;
                        this.y = this.savedState.y;
                        this.width = this.savedState.width;
                        this.height = this.savedState.height;
                        this.updatePosition();
                    }
                    this.maximized = false;
                }
            }

            maximize() {
                if (!this.maximized) {
                    this.savedState = { x: this.x, y: this.y, width: this.width, height: this.height };
                    const workspace = document.getElementById('workspace');
                    this.x = 0;
                    this.y = 0;
                    this.width = workspace.clientWidth;
                    this.height = workspace.clientHeight;
                    this.updatePosition();
                    this.maximized = true;
                } else {
                    this.restore();
                }
            }

            close() {
                this.element.remove();
                windows = windows.filter(w => w.id !== this.id);
            }
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        //                     WINDOW TEMPLATES
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        const windowTemplates = {
            quote: `
                <!-- Condensed Quote Display -->
                <div style="padding: 8px; display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; font-size: 11px;">
                    <div style="text-align: center;">
                        <div style="color: #666; font-size: 9px; margin-bottom: 2px;">BID</div>
                        <div id="bidPrice" style="color: #ef4444; font-weight: 700; font-size: 13px;">--</div>
                        <div id="bidSize" style="color: #666; font-size: 9px;">--</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="color: #666; font-size: 9px; margin-bottom: 2px;">LAST</div>
                        <div id="lastPrice" style="color: #60a5fa; font-weight: 700; font-size: 13px;">--</div>
                        <div id="priceChange" style="font-size: 9px;">--</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="color: #666; font-size: 9px; margin-bottom: 2px;">ASK</div>
                        <div id="askPrice" style="color: #22c55e; font-weight: 700; font-size: 13px;">--</div>
                        <div id="askSize" style="color: #666; font-size: 9px;">--</div>
                    </div>
                </div>

                <!-- Secondary Stats -->
                <div style="padding: 0 8px 8px 8px; display: grid; grid-template-columns: repeat(4, 1fr); gap: 4px; font-size: 10px; border-top: 1px solid #333;">
                    <div style="text-align: center; padding-top: 4px;">
                        <div style="color: #666; font-size: 8px;">VOL</div>
                        <div id="volumePrice" style="color: #aaa; font-weight: 600; font-size: 10px;">--</div>
                    </div>
                    <div style="text-align: center; padding-top: 4px;">
                        <div style="color: #666; font-size: 8px;">HIGH</div>
                        <div id="highPrice" style="color: #aaa; font-weight: 600; font-size: 10px;">--</div>
                    </div>
                    <div style="text-align: center; padding-top: 4px;">
                        <div style="color: #666; font-size: 8px;">LOW</div>
                        <div id="lowPrice" style="color: #aaa; font-weight: 600; font-size: 10px;">--</div>
                    </div>
                    <div style="text-align: center; padding-top: 4px;">
                        <div style="color: #666; font-size: 8px;">OPEN</div>
                        <div id="openPrice" style="color: #aaa; font-weight: 600; font-size: 10px;">--</div>
                    </div>
                </div>

                <!-- Halt Indicator -->
                <div style="padding: 0 8px 8px 8px;">
                    <div id="quoteHaltIndicator" style="display: none; padding: 4px; border-radius: 3px; text-align: center; background: #dc2626; color: white; font-size: 11px;">
                        <span id="quoteHaltTitle" style="font-weight: bold;">üõë HALT</span>
                        <span id="quoteHaltInfo" style="font-size: 9px; margin-left: 6px;"></span>
                    </div>
                </div>
            `,

            level2: `
                <div class="level2-container">
                    <div class="level2-column">
                        <div class="level2-header">
                            <div>MM</div>
                            <div>SIZE</div>
                            <div>BID</div>
                            <div>ORD</div>
                        </div>
                        <div id="bidsDisplay"></div>
                    </div>
                    <div class="level2-column">
                        <div class="level2-header">
                            <div>ORD</div>
                            <div>ASK</div>
                            <div>SIZE</div>
                            <div>MM</div>
                        </div>
                        <div id="asksDisplay"></div>
                    </div>
                </div>
            `,

            timesales: `
                <div style="padding: 4px 0;">
                    <div class="timesales-row" style="background: #2d2d2d; position: sticky; top: 0;">
                        <div style="color: #888; font-weight: 700;">TIME</div>
                        <div style="color: #888; font-weight: 700;">PRICE</div>
                        <div style="color: #888; font-weight: 700;">SIZE</div>
                        <div style="color: #888; font-weight: 700;">SIDE</div>
                    </div>
                    <div id="timesalesDisplay"></div>
                </div>
            `,

            order: `
                <div class="module-content">
                    <div class="order-field">
                        <label>Symbol</label>
                        <input type="text" id="orderSymbol" value="AAPL" readonly
                               style="text-transform: uppercase; background: #1a1a1a; font-weight: 700; font-size: 17px;">
                    </div>

                    <div class="quantity-buttons">
                        <button class="qty-btn" onclick="setQuantity(50)">50</button>
                        <button class="qty-btn" onclick="setQuantity(100)">100</button>
                        <button class="qty-btn" onclick="setQuantity(200)">200</button>
                        <button class="qty-btn" onclick="setQuantity(500)">500</button>
                        <button class="qty-btn" onclick="setQuantity(1000)">1K</button>
                    </div>

                    <!-- Market Price Display - Clickable to set price -->
                    <div id="marketPriceDisplay" style="margin: 8px 0; padding: 8px; background: #1a1a1a; border: 1px solid #333; border-radius: 4px; display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; text-align: center;">
                        <div style="cursor: pointer; padding: 4px; border-radius: 3px; transition: background 0.2s;" onclick="setOrderPrice('bid')" onmouseover="this.style.background='#2d2d2d'" onmouseout="this.style.background='transparent'">
                            <div style="font-size: 10px; color: #666; margin-bottom: 2px;">BID</div>
                            <div id="marketBid" style="font-size: 14px; font-weight: 600; color: #ef4444;">--</div>
                        </div>
                        <div style="cursor: pointer; padding: 4px; border-radius: 3px; transition: background 0.2s;" onclick="setOrderPrice('last')" onmouseover="this.style.background='#2d2d2d'" onmouseout="this.style.background='transparent'">
                            <div style="font-size: 10px; color: #666; margin-bottom: 2px;">LAST</div>
                            <div id="marketLast" style="font-size: 14px; font-weight: 600; color: #fff;">--</div>
                        </div>
                        <div style="cursor: pointer; padding: 4px; border-radius: 3px; transition: background 0.2s;" onclick="setOrderPrice('ask')" onmouseover="this.style.background='#2d2d2d'" onmouseout="this.style.background='transparent'">
                            <div style="font-size: 10px; color: #666; margin-bottom: 2px;">ASK</div>
                            <div id="marketAsk" style="font-size: 14px; font-weight: 600; color: #22c55e;">--</div>
                        </div>
                    </div>

                    <div class="order-entry-grid">
                        <div class="order-field">
                            <label>Quantity</label>
                            <input type="number" id="orderQuantity" value="100" min="1" oninput="calculateOrderCost()">
                        </div>
                        <div class="order-field">
                            <label>Order Type</label>
                            <select id="orderType" onchange="handleOrderTypeChange()">
                                <option value="MARKET">Market</option>
                                <option value="LIMIT" selected>Limit</option>
                                <option value="STOP">Stop</option>
                                <option value="STOP_LIMIT">Stop Limit</option>
                            </select>
                        </div>
                    </div>

                    <div class="price-controls">
                        <button class="price-btn" onclick="adjustPrice(-0.01); calculateOrderCost();">‚àí</button>
                        <div class="order-field" style="margin: 0;">
                            <label>Limit Price</label>
                            <input type="text" id="orderPrice" value="" placeholder="Enter limit price" oninput="calculateOrderCost()">
                        </div>
                        <button class="price-btn" onclick="adjustPrice(0.01); calculateOrderCost();">+</button>
                    </div>

                    <div class="order-field">
                        <label>Time In Force</label>
                        <select id="orderTIF">
                            <option value="DAY">Day</option>
                            <option value="GTC">GTC</option>
                            <option value="IOC">IOC</option>
                            <option value="FOK">FOK</option>
                        </select>
                    </div>

                    <!-- Checkboxes on one line to save space -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin: 8px 0;">
                        <div style="display: flex; align-items: center; gap: 6px;">
                            <input type="checkbox" id="extendedHours" style="width: auto; margin: 0;">
                            <label for="extendedHours" style="margin: 0; cursor: pointer; font-size: 13px;">Ext Hours</label>
                        </div>
                        <div style="display: flex; align-items: center; gap: 6px;">
                            <input type="checkbox" id="autoSubmitOrders" style="width: auto; margin: 0;" onchange="saveAutoSubmitSetting(this.checked)">
                            <label for="autoSubmitOrders" style="margin: 0; cursor: pointer; font-size: 13px; color: #fbbf24;">‚ö° Auto-Submit</label>
                        </div>
                    </div>

                    <!-- Order Cost Calculator -->
                    <div style="margin: 12px 0; padding: 10px; background: #1a1a1a; border: 1px solid #333; border-radius: 4px;">
                        <div style="font-size: 11px; color: #888; margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px;">
                            Estimated Cost
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px;">
                            <div style="text-align: center;">
                                <div style="font-size: 10px; color: #666; margin-bottom: 2px;">Shares</div>
                                <div id="calcShares" style="font-size: 15px; font-weight: 600; color: #fff;">0</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 10px; color: #666; margin-bottom: 2px;">Price</div>
                                <div id="calcPrice" style="font-size: 15px; font-weight: 600; color: #fff;">$0.00</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 10px; color: #666; margin-bottom: 2px;">Est. Total</div>
                                <div id="calcTotal" style="font-size: 15px; font-weight: 600; color: #22c55e;">$0.00</div>
                            </div>
                        </div>
                    </div>

                    <!-- Order buttons: Buys on left, Sells on right -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 12px;">
                        <!-- BUY SIDE (LEFT) -->
                        <div style="display: flex; flex-direction: column; gap: 6px;">
                            <button class="btn btn-buy" onclick="submitOrder('BUY')" style="width: 100%; font-weight: 600;">
                                BUY
                            </button>
                            <button class="btn btn-secondary" onclick="submitOrder('BUY_MARKET')" style="width: 100%; font-size: 12px;">
                                BUY MARKET
                            </button>
                            <button class="btn btn-secondary" onclick="submitOrderAtPrice('BUY', 'BID')" style="width: 100%; font-size: 11px; background: #134e4a; color: #22c55e;">
                                Buy @ Bid
                            </button>
                            <button class="btn btn-secondary" onclick="submitOrderAtPrice('BUY', 'ASK')" style="width: 100%; font-size: 11px; background: #134e4a; color: #22c55e;">
                                Buy @ Ask
                            </button>
                        </div>

                        <!-- SELL SIDE (RIGHT) -->
                        <div style="display: flex; flex-direction: column; gap: 6px;">
                            <button class="btn btn-sell" onclick="submitOrder('SELL')" style="width: 100%; font-weight: 600;">
                                SELL
                            </button>
                            <button class="btn btn-secondary" onclick="submitOrder('SELL_MARKET')" style="width: 100%; font-size: 12px;">
                                SELL MARKET
                            </button>
                            <button class="btn btn-secondary" onclick="submitOrderAtPrice('SELL', 'BID')" style="width: 100%; font-size: 11px; background: #7f1d1d; color: #ef4444;">
                                Sell @ Bid
                            </button>
                            <button class="btn btn-secondary" onclick="submitOrderAtPrice('SELL', 'ASK')" style="width: 100%; font-size: 11px; background: #7f1d1d; color: #ef4444;">
                                Sell @ Ask
                            </button>
                        </div>
                    </div>

                    <!-- Cancel All Button -->
                    <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #333;">
                        <button class="btn btn-secondary" onclick="cancelAllOrders()" style="width: 100%; background: #7f1d1d; color: #ef4444; font-size: 13px;">
                            ‚ùå CANCEL ALL ORDERS
                        </button>
                    </div>
                </div>
            `,

            positions: `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Symbol</th>
                            <th>Side</th>
                            <th>Qty</th>
                            <th>Avg Price</th>
                            <th>Current</th>
                            <th>P&L</th>
                            <th>P&L %</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="positionsDisplay">
                        <tr><td colspan="8" class="empty-state">No open positions</td></tr>
                    </tbody>
                </table>
            `,

            orders: `
                <div style="padding: 6px 8px; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center;">
                    <div style="display: flex; gap: 2px;">
                        <button id="ordersTabWorking" class="orders-tab active" onclick="switchOrdersTab('working')"
                                style="padding: 4px 10px; font-size: 12px; font-weight: 600; background: #2d2d2d; border: none; color: #fff; cursor: pointer; border-radius: 3px 3px 0 0;">
                            Working
                        </button>
                        <button id="ordersTabOpen" class="orders-tab" onclick="switchOrdersTab('open')"
                                style="padding: 4px 10px; font-size: 12px; font-weight: 600; background: #1a1a1a; border: none; color: #888; cursor: pointer; border-radius: 3px 3px 0 0;">
                            Open
                        </button>
                        <button id="ordersTabFilled" class="orders-tab" onclick="switchOrdersTab('filled')"
                                style="padding: 4px 10px; font-size: 12px; font-weight: 600; background: #1a1a1a; border: none; color: #888; cursor: pointer; border-radius: 3px 3px 0 0;">
                            Filled
                        </button>
                        <button id="ordersTabClosed" class="orders-tab" onclick="switchOrdersTab('closed')"
                                style="padding: 4px 10px; font-size: 12px; font-weight: 600; background: #1a1a1a; border: none; color: #888; cursor: pointer; border-radius: 3px 3px 0 0;">
                            Closed
                        </button>
                    </div>
                    <button class="btn btn-secondary" onclick="cancelAllOrders()"
                            style="padding: 4px 12px; font-size: 12px; font-weight: 600;">
                        CANCEL ALL
                    </button>
                </div>
                <div id="ordersTabContent">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Time</th>
                                <th>Symbol</th>
                                <th>Side</th>
                                <th>Qty</th>
                                <th>Type</th>
                                <th>Price</th>
                                <th>Status</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="ordersDisplay">
                            <tr><td colspan="8" class="empty-state">No orders</td></tr>
                        </tbody>
                    </table>
                </div>
            `,

            watchlist: `
                <div style="padding: 6px 8px; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center;">
                    <div style="font-size: 13px; color: #888; text-transform: uppercase;">Shared Worklist</div>
                    <div style="display: flex; gap: 4px;">
                        <button class="btn btn-secondary" onclick="showScannerDialog()"
                                style="padding: 4px 8px; font-size: 13px; font-weight: 600;">SCANNER</button>
                        <button class="btn btn-secondary" onclick="showAddSymbolDialog()"
                                style="padding: 4px 8px; font-size: 13px; font-weight: 600;">+ ADD</button>
                        <button class="btn btn-secondary" onclick="clearWorklist()"
                                style="padding: 4px 8px; font-size: 13px; font-weight: 600; background: #7f1d1d;">CLEAR ALL</button>
                    </div>
                </div>
                <div id="worklistStats" style="padding: 6px 8px; background: #1a1a1a; border-bottom: 1px solid #333; display: grid; grid-template-columns: repeat(4, 1fr); gap: 4px;">
                    <div style="background: #252525; padding: 4px 6px; border-radius: 2px;">
                        <div style="font-size: 12px; color: #888; margin-bottom: 2px;">SYMBOLS</div>
                        <div style="font-size: 18px; font-weight: 700; color: #fff;" id="statsTotal">0</div>
                    </div>
                    <div style="background: #252525; padding: 4px 6px; border-radius: 2px;">
                        <div style="font-size: 12px; color: #888; margin-bottom: 2px;">LIVE</div>
                        <div style="font-size: 18px; font-weight: 700; color: #22c55e;" id="statsLive">0</div>
                    </div>
                    <div style="background: #252525; padding: 4px 6px; border-radius: 2px;">
                        <div style="font-size: 12px; color: #888; margin-bottom: 2px;">BULLISH</div>
                        <div style="font-size: 18px; font-weight: 700; color: #22c55e;" id="statsBullish">0</div>
                    </div>
                    <div style="background: #252525; padding: 4px 6px; border-radius: 2px;">
                        <div style="font-size: 12px; color: #888; margin-bottom: 2px;">BEARISH</div>
                        <div style="font-size: 18px; font-weight: 700; color: #ef4444;" id="statsBearish">0</div>
                    </div>
                </div>
                <div id="watchlistDisplay" style="overflow-y: auto; max-height: calc(100% - 90px);">
                    <div class="empty-state">Loading worklist...</div>
                </div>
            `,

            account: `
                <!-- Condensed Account Display -->
                <div style="padding: 6px 8px; border-bottom: 1px solid #333; background: #1a1a1a;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div style="font-size: 10px; color: #888;">
                            <span id="accountNumber">DU0000000</span> ‚Ä¢ <span id="accountType">Unknown</span>
                        </div>
                        <div id="accountWarnings" style="font-size: 10px; padding: 2px 6px; border-radius: 2px; display: none;"></div>
                    </div>
                </div>

                <!-- Key Stats - Compact Grid -->
                <div style="padding: 8px; display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 11px;">
                    <div style="padding: 6px; background: #1a1a1a; border-radius: 3px;">
                        <div style="color: #666; font-size: 8px; margin-bottom: 2px;">CASH</div>
                        <div id="cashBalance" style="font-weight: 700; font-size: 13px; color: #22c55e;">$0.00</div>
                    </div>
                    <div style="padding: 6px; background: #1a1a1a; border-radius: 3px;">
                        <div style="color: #666; font-size: 8px; margin-bottom: 2px;">BUYING POWER</div>
                        <div id="buyingPower" style="font-weight: 700; font-size: 13px; color: #60a5fa;">$0.00</div>
                    </div>
                    <div style="padding: 6px; background: #1a1a1a; border-radius: 3px;">
                        <div style="color: #666; font-size: 8px; margin-bottom: 2px;">DAY P&L</div>
                        <div id="dayPL" style="font-weight: 700; font-size: 13px;">$0.00</div>
                    </div>
                    <div style="padding: 6px; background: #1a1a1a; border-radius: 3px;">
                        <div style="color: #666; font-size: 8px; margin-bottom: 2px;">EQUITY</div>
                        <div id="equityValue" style="font-weight: 700; font-size: 13px; color: #aaa;">$0.00</div>
                    </div>
                </div>

                <!-- Additional Info Bar -->
                <div style="padding: 4px 8px; display: flex; justify-content: space-between; font-size: 9px; color: #666; border-top: 1px solid #333;">
                    <div>Positions: <span id="positionCount" style="color: #aaa; font-weight: 600;">0</span></div>
                    <div id="dayTradesInfo" style="display: none;">Day Trades: <span id="dayTradesRemaining" style="color: #aaa; font-weight: 600;">-</span></div>
                    <div>Total P&L: <span id="totalPL" style="font-weight: 600;">$0.00</span></div>
                </div>
            `,

            bot: `
                <div class="module-content" style="padding: 8px; overflow-y: auto; max-height: 100%;">
                    <!-- Bot Status Header -->
                    <div style="text-align: center; margin-bottom: 12px; padding: 12px; background: #1a1a1a; border-radius: 4px;">
                        <div style="font-size: 13px; color: #888; margin-bottom: 4px; letter-spacing: 1px;">AUTONOMOUS BOT STATUS</div>
                        <div id="botStatusText" style="font-size: 24px; font-weight: 700; color: #ef4444; margin-bottom: 4px;">NOT INITIALIZED</div>
                        <div id="botStatusSubtext" style="font-size: 13px; color: #888;">Click INIT to initialize bot</div>
                    </div>

                    <!-- Control Buttons -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 6px; margin-bottom: 8px;">
                        <button id="initBotBtn" class="btn btn-secondary" onclick="initBot()" style="font-size: 14px; padding: 8px;">‚öôÔ∏è INIT</button>
                        <button id="startBotBtn" class="btn btn-buy" onclick="startAutonomousBot()" disabled style="font-size: 14px; padding: 8px;">‚ñ∂ START</button>
                        <button id="stopBotBtn" class="btn btn-sell" onclick="stopAutonomousBot()" disabled style="font-size: 14px; padding: 8px;">‚èπ STOP</button>
                        <button id="enableBotBtn" class="btn btn-secondary" onclick="enableBot()" disabled style="font-size: 14px; padding: 8px;">‚úì ENABLE</button>
                    </div>

                    <!-- Statistics Grid -->
                    <div id="botStatsGrid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 6px; margin-bottom: 8px;">
                        <div style="padding: 6px; background: #1a1a1a; border-radius: 2px;">
                            <div style="font-size: 12px; color: #888;">SIGNALS</div>
                            <div id="botSignals" style="font-size: 17px; font-weight: 700; color: #60a5fa;">0</div>
                        </div>
                        <div style="padding: 6px; background: #1a1a1a; border-radius: 2px;">
                            <div style="font-size: 12px; color: #888;">TRADES</div>
                            <div id="botTrades" style="font-size: 17px; font-weight: 700; color: #22c55e;">0</div>
                        </div>
                        <div style="padding: 6px; background: #1a1a1a; border-radius: 2px;">
                            <div style="font-size: 12px; color: #888;">POSITIONS</div>
                            <div id="botPositions" style="font-size: 17px; font-weight: 700; color: #fbbf24;">0</div>
                        </div>
                        <div style="padding: 6px; background: #1a1a1a; border-radius: 2px;">
                            <div style="font-size: 12px; color: #888;">DAILY P&L (5%)</div>
                            <div id="botDailyPnl" style="font-size: 17px; font-weight: 700;">$0.00</div>
                        </div>
                    </div>

                    <!-- 3-5-7 Risk Management Display -->
                    <div style="padding: 8px; background: #1a1a1a; border: 1px solid #333; border-radius: 3px; margin-bottom: 8px;">
                        <div style="font-size: 13px; color: #888; margin-bottom: 6px; font-weight: 700; letter-spacing: 0.5px;">3-5-7 RISK MANAGEMENT</div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 6px;">
                            <div style="padding: 4px;">
                                <div style="font-size: 12px; color: #888;">WEEKLY P&L (7%)</div>
                                <div id="botWeeklyPnl" style="font-size: 16px; font-weight: 700;">$0.00</div>
                            </div>
                            <div style="padding: 4px;">
                                <div style="font-size: 12px; color: #888;">MAX RISK/TRADE (3%)</div>
                                <div id="botMaxRisk" style="font-size: 16px; font-weight: 700; color: #888;">$0.00</div>
                            </div>
                        </div>
                    </div>

                    <!-- Configuration Section -->
                    <div style="padding: 8px; background: #252525; border: 1px solid #333; border-radius: 3px; margin-bottom: 8px;">
                        <div style="font-size: 13px; color: #888; margin-bottom: 6px; font-weight: 700; letter-spacing: 0.5px;">CONFIGURATION</div>

                        <div style="margin-bottom: 6px;">
                            <label style="font-size: 12px; color: #888; display: block; margin-bottom: 2px;">Watchlist</label>
                            <input type="text" id="botWatchlist" value="AAPL,MSFT,GOOGL,TSLA,NVDA"
                                   style="width: 100%; padding: 4px 6px; background: #1a1a1a; border: 1px solid #404040; color: #fff; font-size: 14px; border-radius: 2px;">
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 6px; margin-bottom: 6px;">
                            <div>
                                <label style="font-size: 12px; color: #888; display: block; margin-bottom: 2px;">Max Position $</label>
                                <input type="number" id="botMaxPosition" value="5000" min="100" step="100"
                                       style="width: 100%; padding: 4px 6px; background: #1a1a1a; border: 1px solid #404040; color: #fff; font-size: 14px; border-radius: 2px;">
                            </div>
                            <div>
                                <label style="font-size: 12px; color: #888; display: block; margin-bottom: 2px;">Daily Loss $</label>
                                <input type="number" id="botDailyLoss" value="500" min="50" step="50"
                                       style="width: 100%; padding: 4px 6px; background: #1a1a1a; border: 1px solid #404040; color: #fff; font-size: 14px; border-radius: 2px;">
                            </div>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 6px;">
                            <div>
                                <label style="font-size: 12px; color: #888; display: block; margin-bottom: 2px;">Min Prob %</label>
                                <input type="number" id="botMinProb" value="60" min="50" max="100" step="1"
                                       style="width: 100%; padding: 4px 6px; background: #1a1a1a; border: 1px solid #404040; color: #fff; font-size: 14px; border-radius: 2px;">
                            </div>
                            <div>
                                <label style="font-size: 12px; color: #888; display: block; margin-bottom: 2px;">Max Positions</label>
                                <input type="number" id="botMaxPositions" value="5" min="1" max="20" step="1"
                                       style="width: 100%; padding: 4px 6px; background: #1a1a1a; border: 1px solid #404040; color: #fff; font-size: 14px; border-radius: 2px;">
                            </div>
                        </div>

                        <button class="btn btn-secondary" onclick="updateBotConfig()" style="width: 100%; margin-top: 6px; font-size: 13px; padding: 5px;">
                            UPDATE CONFIG
                        </button>
                    </div>

                    <!-- Recent Predictions -->
                    <div style="padding: 8px; background: #252525; border: 1px solid #333; border-radius: 3px; margin-bottom: 8px;">
                        <div style="font-size: 13px; color: #888; margin-bottom: 6px; font-weight: 700; letter-spacing: 0.5px;">RECENT PREDICTIONS</div>
                        <div id="botPredictionsDisplay" style="max-height: 120px; overflow-y: auto; font-size: 13px;">
                            <div class="empty-state" style="padding: 16px; font-size: 13px;">No predictions yet</div>
                        </div>
                    </div>

                    <!-- Open Positions -->
                    <div style="padding: 8px; background: #252525; border: 1px solid #333; border-radius: 3px;">
                        <div style="font-size: 13px; color: #888; margin-bottom: 6px; font-weight: 700; letter-spacing: 0.5px;">OPEN POSITIONS</div>
                        <div id="botPositionsDisplay" style="max-height: 120px; overflow-y: auto; font-size: 13px;">
                            <div class="empty-state" style="padding: 16px; font-size: 13px;">No positions</div>
                        </div>
                    </div>
                </div>
            `,

            ai: `
                <div class="module-content">
                    <div id="aiPredictionDisplay" class="empty-state">Click PREDICT for AI analysis</div>
                    <button class="btn btn-secondary" onclick="getPrediction()" style="width: 100%; margin-top: 12px;">
                        ü§ñ GET AI PREDICTION
                    </button>
                </div>
            `,

            pdtmonitor: `
                <div class="module-content" style="padding: 10px; overflow-y: auto;">
                    <!-- PDT Status Header -->
                    <div id="pdtStatusHeader" style="text-align: center; padding: 15px; background: #1a1a1a; border-radius: 6px; margin-bottom: 12px;">
                        <div style="font-size: 11px; color: #666; letter-spacing: 1px; margin-bottom: 6px;">PDT RULE STATUS</div>
                        <div id="pdtStatusBadge" style="font-size: 22px; font-weight: 700; color: #22c55e;">CHECKING...</div>
                        <div id="pdtStatusMessage" style="font-size: 12px; color: #888; margin-top: 6px;">Loading PDT status...</div>
                    </div>

                    <!-- Day Trades Counter -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-bottom: 12px;">
                        <div style="padding: 12px; background: #1a1a1a; border-radius: 4px; text-align: center;">
                            <div style="font-size: 10px; color: #666; margin-bottom: 4px;">USED</div>
                            <div id="pdtDayTradesUsed" style="font-size: 24px; font-weight: 700; color: #f59e0b;">0</div>
                        </div>
                        <div style="padding: 12px; background: #1a1a1a; border-radius: 4px; text-align: center;">
                            <div style="font-size: 10px; color: #666; margin-bottom: 4px;">REMAINING</div>
                            <div id="pdtDayTradesRemaining" style="font-size: 24px; font-weight: 700; color: #22c55e;">3</div>
                        </div>
                        <div style="padding: 12px; background: #1a1a1a; border-radius: 4px; text-align: center;">
                            <div style="font-size: 10px; color: #666; margin-bottom: 4px;">LIMIT</div>
                            <div style="font-size: 24px; font-weight: 700; color: #60a5fa;">3</div>
                        </div>
                    </div>

                    <!-- Account Info -->
                    <div style="padding: 10px; background: #1a1a1a; border-radius: 4px; margin-bottom: 12px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span style="font-size: 12px; color: #666;">Account Equity:</span>
                            <span id="pdtEquity" style="font-size: 12px; color: #fff; font-weight: 600;">$0.00</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span style="font-size: 12px; color: #666;">PDT Threshold:</span>
                            <span style="font-size: 12px; color: #fff; font-weight: 600;">$25,000</span>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span style="font-size: 12px; color: #666;">PDT Exempt:</span>
                            <span id="pdtExempt" style="font-size: 12px; font-weight: 600;">No</span>
                        </div>
                    </div>

                    <!-- Rolling Window Visualization -->
                    <div style="padding: 10px; background: #1a1a1a; border-radius: 4px; margin-bottom: 12px;">
                        <div style="font-size: 11px; color: #666; margin-bottom: 8px; font-weight: 600;">5-DAY ROLLING WINDOW</div>
                        <div id="pdtWindowVisual" style="display: flex; gap: 4px; margin-bottom: 8px;">
                            <div style="flex: 1; height: 24px; background: #252525; border-radius: 2px; display: flex; align-items: center; justify-content: center; font-size: 10px; color: #666;">D1</div>
                            <div style="flex: 1; height: 24px; background: #252525; border-radius: 2px; display: flex; align-items: center; justify-content: center; font-size: 10px; color: #666;">D2</div>
                            <div style="flex: 1; height: 24px; background: #252525; border-radius: 2px; display: flex; align-items: center; justify-content: center; font-size: 10px; color: #666;">D3</div>
                            <div style="flex: 1; height: 24px; background: #252525; border-radius: 2px; display: flex; align-items: center; justify-content: center; font-size: 10px; color: #666;">D4</div>
                            <div style="flex: 1; height: 24px; background: #252525; border-radius: 2px; display: flex; align-items: center; justify-content: center; font-size: 10px; color: #666;">D5</div>
                        </div>
                        <div style="font-size: 10px; color: #555; text-align: center;">Day trades reset as they fall outside the 5-day window</div>
                    </div>

                    <!-- Recent Day Trades -->
                    <div style="padding: 10px; background: #1a1a1a; border-radius: 4px; margin-bottom: 12px;">
                        <div style="font-size: 11px; color: #666; margin-bottom: 8px; font-weight: 600;">RECENT DAY TRADES</div>
                        <div id="pdtRecentTrades" style="font-size: 12px; max-height: 100px; overflow-y: auto;">
                            <div style="color: #666; text-align: center; padding: 10px;">No day trades in window</div>
                        </div>
                    </div>

                    <!-- SEC Rule Info -->
                    <div style="padding: 10px; background: #0d1117; border: 1px solid #1e3a5f; border-radius: 4px;">
                        <div style="font-size: 11px; color: #60a5fa; margin-bottom: 6px; font-weight: 600;">üìú SEC PATTERN DAY TRADER RULE</div>
                        <div style="font-size: 11px; color: #888; line-height: 1.5;">
                            <p style="margin: 0 0 6px 0;"><b>Limit:</b> 3 day trades per 5 rolling business days for accounts under $25,000</p>
                            <p style="margin: 0 0 6px 0;"><b>Day Trade:</b> Buying AND selling the same security on the same day</p>
                            <p style="margin: 0;"><b>Consequence:</b> 4+ day trades = PDT flag = trading restrictions</p>
                        </div>
                    </div>

                    <!-- Refresh Button -->
                    <button onclick="refreshPDTStatus()" style="width: 100%; margin-top: 12px; padding: 10px; background: #1e3a5f; border: 1px solid #2563eb; color: #60a5fa; font-size: 13px; font-weight: 600; border-radius: 4px; cursor: pointer;">
                        üîÑ REFRESH PDT STATUS
                    </button>
                </div>
            `,

            claudechat: `
                <div class="module-content" style="display: flex; flex-direction: column; height: 100%; padding: 0;">
                    <!-- LIVE SYSTEM STATUS PANEL -->
                    <div id="claudeSystemStatus" style="background: #0d1117; border-bottom: 1px solid #333; padding: 8px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                            <span style="font-size: 10px; color: #666; font-weight: 700;">üì° LIVE SYSTEM STATUS</span>
                            <span id="claudeStatusTime" style="font-size: 9px; color: #444;">--</span>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 6px;">
                            <div style="background: #161b22; padding: 6px; border-radius: 4px; text-align: center;">
                                <div style="font-size: 9px; color: #666;">MODEL</div>
                                <div id="claudeModelStatus" style="font-size: 11px; color: #22c55e; font-weight: 600;">--</div>
                            </div>
                            <div style="background: #161b22; padding: 6px; border-radius: 4px; text-align: center;">
                                <div style="font-size: 9px; color: #666;">REGIME</div>
                                <div id="claudeRegimeStatus" style="font-size: 11px; color: #60a5fa; font-weight: 600;">--</div>
                            </div>
                            <div style="background: #161b22; padding: 6px; border-radius: 4px; text-align: center;">
                                <div style="font-size: 9px; color: #666;">DRIFT</div>
                                <div id="claudeDriftStatus" style="font-size: 11px; color: #22c55e; font-weight: 600;">--</div>
                            </div>
                        </div>
                    </div>

                    <!-- LIVE ACTIVITY FEED -->
                    <div id="claudeActivityFeed" style="background: #0a0a0a; border-bottom: 1px solid #222; max-height: 80px; overflow-y: auto; font-size: 11px;">
                        <div id="activityLog" style="padding: 6px 10px;">
                            <div style="color: #666; padding: 4px 0;">‚è≥ Initializing system monitor...</div>
                        </div>
                    </div>

                    <!-- Chat Messages -->
                    <div id="claudeChatMessages" style="flex: 1; overflow-y: auto; padding: 12px; background: #0a0a0a;">
                        <div style="padding: 12px; background: #1e3a5f; border-radius: 8px; margin-bottom: 10px;">
                            <div style="font-size: 11px; color: #60a5fa; margin-bottom: 4px;">ü§ñ Claude AI</div>
                            <div style="color: #e0e0e0; font-size: 14px; line-height: 1.5;">
                                Hello! I'm Claude, your AI trading assistant. I monitor the system and can help you with:
                                <ul style="margin: 8px 0 0 16px; padding: 0; font-size: 13px;">
                                    <li><b>Training</b> - Start/monitor model training</li>
                                    <li><b>Predictions</b> - Get AI signals for any stock</li>
                                    <li><b>Regime</b> - Understand current market conditions</li>
                                    <li><b>Drift</b> - Check if model needs retraining</li>
                                </ul>
                                <div style="margin-top: 10px; padding: 8px; background: #1a3a5f; border-radius: 4px; font-size: 12px;">
                                    üí° <b>Try:</b> "train model", "predict TSLA", "check regime", "system status"
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Quick Actions -->
                    <div style="padding: 8px; background: #1a1a1a; border-top: 1px solid #333; border-bottom: 1px solid #333;">
                        <div style="display: flex; gap: 6px; flex-wrap: wrap;">
                            <button onclick="claudeQuickAction('status')" style="padding: 4px 8px; background: #1e3a5f; border: 1px solid #2563eb; color: #60a5fa; font-size: 11px; border-radius: 3px; cursor: pointer;">üìä System Status</button>
                            <button onclick="claudeQuickAction('train')" style="padding: 4px 8px; background: #14532d; border: 1px solid #22c55e; color: #22c55e; font-size: 11px; border-radius: 3px; cursor: pointer;">üöÄ Train Model</button>
                            <button onclick="claudeQuickAction('predict')" style="padding: 4px 8px; background: #2d2d2d; border: 1px solid #404040; color: #888; font-size: 11px; border-radius: 3px; cursor: pointer;">üîÆ Predict</button>
                            <button onclick="claudeQuickAction('regime')" style="padding: 4px 8px; background: #2d2d2d; border: 1px solid #404040; color: #888; font-size: 11px; border-radius: 3px; cursor: pointer;">üìà Regime</button>
                            <button onclick="claudeQuickAction('drift')" style="padding: 4px 8px; background: #2d2d2d; border: 1px solid #404040; color: #888; font-size: 11px; border-radius: 3px; cursor: pointer;">üîç Check Drift</button>
                        </div>
                    </div>
                    <!-- Chat Input -->
                    <div style="padding: 10px; background: #1a1a1a;">
                        <div style="display: flex; gap: 8px;">
                            <input type="text" id="claudeChatInput" placeholder="Ask about training, predictions, regime, or type a command..."
                                   style="flex: 1; padding: 10px 12px; background: #252525; border: 1px solid #404040; color: #fff; font-size: 14px; border-radius: 4px;"
                                   onkeypress="if(event.key==='Enter') sendClaudeMessage()">
                            <button onclick="sendClaudeMessage()" style="padding: 10px 16px; background: #007acc; color: #fff; border: none; border-radius: 4px; cursor: pointer; font-weight: 600;">
                                Send
                            </button>
                        </div>
                    </div>
                </div>
            `,

            aicontrol: `
                <div class="module-content" style="padding: 8px; overflow-y: auto; max-height: 100%;">
                    <!-- Tab Navigation -->
                    <div style="display: flex; gap: 4px; margin-bottom: 12px; border-bottom: 2px solid #333;">
                        <button id="aiTabTraining" class="ai-tab active" onclick="switchAITab('training')" style="flex: 1; padding: 8px; background: #2d2d2d; border: none; color: #fff; cursor: pointer; font-size: 13px; font-weight: 600;">
                            üìö TRAINING
                        </button>
                        <button id="aiTabPredictions" class="ai-tab" onclick="switchAITab('predictions')" style="flex: 1; padding: 8px; background: #1a1a1a; border: none; color: #888; cursor: pointer; font-size: 13px; font-weight: 600;">
                            üîÆ PREDICTIONS
                        </button>
                        <button id="aiTabBacktest" class="ai-tab" onclick="switchAITab('backtest')" style="flex: 1; padding: 8px; background: #1a1a1a; border: none; color: #888; cursor: pointer; font-size: 13px; font-weight: 600;">
                            üìä BACKTEST
                        </button>
                        <button id="aiTabModels" class="ai-tab" onclick="switchAITab('models')" style="flex: 1; padding: 8px; background: #1a1a1a; border: none; color: #888; cursor: pointer; font-size: 13px; font-weight: 600;">
                            üéØ MODELS
                        </button>
                        <button id="aiTabBot" class="ai-tab" onclick="switchAITab('bot')" style="flex: 1; padding: 8px; background: #1a1a1a; border: none; color: #888; cursor: pointer; font-size: 13px; font-weight: 600;">
                            ü§ñ BOT TRADING
                        </button>
                    </div>

                    <!-- TRAINING TAB -->
                    <div id="aiTrainingTab" class="ai-tab-content">
                        <div style="padding: 10px; background: #1a1a1a; border: 1px solid #333; border-radius: 4px; margin-bottom: 12px;">
                            <div style="font-size: 13px; color: #888; margin-bottom: 8px; font-weight: 700;">TRAIN NEW MODEL</div>

                            <!-- Training Mode Selection -->
                            <div style="margin-bottom: 10px;">
                                <label style="font-size: 12px; color: #888; display: block; margin-bottom: 3px;">Training Mode</label>
                                <select id="trainMode" onchange="updateTrainingMode()" style="width: 100%; padding: 6px 8px; background: #252525; border: 1px solid #404040; color: #fff; font-size: 14px; border-radius: 3px;">
                                    <option value="single">Single Symbol (~30 sec)</option>
                                    <option value="multi" selected>Multi-Symbol Momentum (~3 min)</option>
                                    <option value="walkforward">Walk-Forward Validation (~10 min)</option>
                                    <option value="advanced">Advanced + Optuna Tuning (~15 min)</option>
                                </select>
                            </div>

                            <div id="singleSymbolInput" style="margin-bottom: 8px; display: none;">
                                <label style="font-size: 12px; color: #888; display: block; margin-bottom: 3px;">Training Symbol</label>
                                <div style="display: flex; gap: 6px;">
                                    <input type="text" id="trainSymbol" value="SPY" placeholder="SPY, AAPL, etc."
                                           style="flex: 1; padding: 6px 8px; background: #252525; border: 1px solid #404040; color: #fff; font-size: 14px; border-radius: 3px;">
                                    <button onclick="loadWorklistSymbol('trainSymbol')" style="padding: 6px 12px; background: #007acc; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 11px; white-space: nowrap;">
                                        üìã Worklist
                                    </button>
                                </div>
                            </div>

                            <div id="multiSymbolInput" style="margin-bottom: 8px;">
                                <label style="font-size: 12px; color: #888; display: block; margin-bottom: 3px;">Training Symbols (comma-separated)</label>
                                <div style="display: flex; gap: 6px;">
                                    <input type="text" id="trainSymbols" value="TSLA,NVDA,AMD,META,AAPL,GOOGL,MSFT,AMZN,PLTR,COIN" placeholder="TSLA,NVDA,AMD..."
                                           style="flex: 1; padding: 6px 8px; background: #252525; border: 1px solid #404040; color: #fff; font-size: 12px; border-radius: 3px;">
                                    <button onclick="loadWorklistSymbols('trainSymbols')" style="padding: 6px 12px; background: #007acc; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 11px; white-space: nowrap;">
                                        üìã Worklist
                                    </button>
                                </div>
                            </div>

                            <div style="margin-bottom: 8px;">
                                <label style="font-size: 12px; color: #888; display: block; margin-bottom: 3px;">Training Period</label>
                                <select id="trainPeriod" style="width: 100%; padding: 6px 8px; background: #252525; border: 1px solid #404040; color: #fff; font-size: 14px; border-radius: 3px;">
                                    <option value="1y">1 Year</option>
                                    <option value="2y" selected>2 Years</option>
                                    <option value="5y">5 Years</option>
                                    <option value="10y">10 Years</option>
                                    <option value="max">Max Available</option>
                                </select>
                            </div>

                            <div style="margin-bottom: 8px;">
                                <label style="font-size: 12px; color: #888; display: block; margin-bottom: 3px;">Test Size %</label>
                                <input type="number" id="trainTestSize" value="20" min="10" max="40" step="5"
                                       style="width: 100%; padding: 6px 8px; background: #252525; border: 1px solid #404040; color: #fff; font-size: 14px; border-radius: 3px;">
                            </div>

                            <!-- Training Time Estimate -->
                            <div id="trainTimeEstimate" style="padding: 8px; background: #252525; border-radius: 3px; margin-bottom: 8px; text-align: center;">
                                <span style="font-size: 11px; color: #888;">Estimated Time: </span>
                                <span id="trainTimeValue" style="font-size: 12px; color: #60a5fa; font-weight: 600;">~3 minutes</span>
                            </div>

                            <button id="trainModelBtn" class="btn btn-buy" onclick="trainModelAdvanced()" style="width: 100%; font-size: 14px; padding: 10px; margin-top: 8px;">
                                üöÄ START TRAINING
                            </button>
                        </div>

                        <!-- Training Status -->
                        <div id="trainingStatus" style="padding: 10px; background: #1a1a1a; border: 1px solid #333; border-radius: 4px; display: none;">
                            <div style="font-size: 13px; color: #888; margin-bottom: 8px; font-weight: 700;">TRAINING PROGRESS</div>
                            <div id="trainingProgress" style="margin-bottom: 8px;">
                                <div style="background: #252525; height: 24px; border-radius: 3px; overflow: hidden; position: relative;">
                                    <div id="trainingProgressBar" style="background: linear-gradient(90deg, #22c55e, #16a34a); height: 100%; width: 0%; transition: width 0.3s; display: flex; align-items: center; justify-content: center;">
                                        <span id="trainingProgressText" style="font-size: 12px; font-weight: 700; color: #fff; position: absolute;">0%</span>
                                    </div>
                                </div>
                            </div>
                            <div id="trainingStatusText" style="font-size: 12px; color: #aaa; text-align: center;">Initializing...</div>
                            <div id="trainingMetrics" style="margin-top: 12px; padding: 8px; background: #252525; border-radius: 3px; display: none;">
                                <div style="font-size: 12px; color: #888; margin-bottom: 6px;">TRAINING RESULTS</div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                                    <div>
                                        <div style="font-size: 10px; color: #666;">ACCURACY</div>
                                        <div id="trainAccuracy" style="font-size: 16px; font-weight: 700; color: #22c55e;">--</div>
                                    </div>
                                    <div>
                                        <div style="font-size: 10px; color: #666;">SAMPLES</div>
                                        <div id="trainSamples" style="font-size: 16px; font-weight: 700; color: #60a5fa;">--</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- PREDICTIONS TAB -->
                    <div id="aiPredictionsTab" class="ai-tab-content" style="display: none;">
                        <div style="padding: 10px; background: #1a1a1a; border: 1px solid #333; border-radius: 4px; margin-bottom: 12px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <div style="font-size: 13px; color: #888; font-weight: 700;">WORKLIST PREDICTIONS</div>
                                <button class="btn btn-secondary" onclick="predictWorklist()" style="font-size: 11px; padding: 4px 8px;">
                                    üîÑ REFRESH
                                </button>
                            </div>
                            <div id="worklistPredictions" style="max-height: 400px; overflow-y: auto;">
                                <div class="empty-state" style="padding: 20px; font-size: 13px;">Click REFRESH to get predictions</div>
                            </div>
                        </div>

                        <div style="padding: 10px; background: #1a1a1a; border: 1px solid #333; border-radius: 4px;">
                            <div style="font-size: 13px; color: #888; margin-bottom: 8px; font-weight: 700;">SINGLE SYMBOL PREDICTION</div>
                            <div style="display: flex; gap: 6px;">
                                <input type="text" id="singlePredictSymbol" value="" placeholder="Enter symbol..."
                                       style="flex: 1; padding: 6px 8px; background: #252525; border: 1px solid #404040; color: #fff; font-size: 14px; border-radius: 3px;">
                                <button class="btn btn-secondary" onclick="predictSingle()" style="font-size: 13px; padding: 6px 16px;">
                                    PREDICT
                                </button>
                            </div>
                            <div id="singlePredictionResult" style="margin-top: 12px; display: none;">
                                <!-- Results appear here -->
                            </div>
                        </div>
                    </div>

                    <!-- BACKTEST TAB -->
                    <div id="aiBacktestTab" class="ai-tab-content" style="display: none;">
                        <div style="padding: 10px; background: #1a1a1a; border: 1px solid #333; border-radius: 4px; margin-bottom: 12px;">
                            <div style="font-size: 13px; color: #888; margin-bottom: 8px; font-weight: 700;">BACKTEST CONFIGURATION</div>

                            <div style="margin-bottom: 8px;">
                                <label style="font-size: 12px; color: #888; display: block; margin-bottom: 3px;">Strategy</label>
                                <select id="backtestStrategy" style="width: 100%; padding: 6px 8px; background: #252525; border: 1px solid #404040; color: #fff; font-size: 14px; border-radius: 3px;">
                                    <option value="ai_predictor">AI Predictor</option>
                                    <option value="alpha_fusion">AlphaFusion V2</option>
                                    <option value="ma_cross">Moving Average Cross</option>
                                    <option value="rsi_strategy">RSI Strategy</option>
                                </select>
                            </div>

                            <div style="margin-bottom: 8px;">
                                <label style="font-size: 12px; color: #888; display: block; margin-bottom: 3px;">Symbols (comma separated)</label>
                                <div style="display: flex; gap: 6px;">
                                    <input type="text" id="backtestSymbols" value="AAPL,MSFT,GOOGL" placeholder="AAPL,MSFT,GOOGL"
                                           style="flex: 1; padding: 6px 8px; background: #252525; border: 1px solid #404040; color: #fff; font-size: 14px; border-radius: 3px;">
                                    <button onclick="loadWorklistSymbols('backtestSymbols')" style="padding: 6px 12px; background: #007acc; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 11px; white-space: nowrap;">
                                        üìã Worklist
                                    </button>
                                </div>
                            </div>

                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 8px;">
                                <div>
                                    <label style="font-size: 12px; color: #888; display: block; margin-bottom: 3px;">Start Date</label>
                                    <input type="date" id="backtestStartDate" value="2024-01-01"
                                           style="width: 100%; padding: 6px 8px; background: #252525; border: 1px solid #404040; color: #fff; font-size: 14px; border-radius: 3px;">
                                </div>
                                <div>
                                    <label style="font-size: 12px; color: #888; display: block; margin-bottom: 3px;">End Date</label>
                                    <input type="date" id="backtestEndDate" value="2025-01-01"
                                           style="width: 100%; padding: 6px 8px; background: #252525; border: 1px solid #404040; color: #fff; font-size: 14px; border-radius: 3px;">
                                </div>
                            </div>

                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 8px;">
                                <div>
                                    <label style="font-size: 12px; color: #888; display: block; margin-bottom: 3px;">Initial Capital $</label>
                                    <input type="number" id="backtestCapital" value="10000" min="1000" step="1000"
                                           style="width: 100%; padding: 6px 8px; background: #252525; border: 1px solid #404040; color: #fff; font-size: 14px; border-radius: 3px;">
                                </div>
                                <div>
                                    <label style="font-size: 12px; color: #888; display: block; margin-bottom: 3px;">Position Size %</label>
                                    <input type="number" id="backtestPositionSize" value="20" min="5" max="100" step="5"
                                           style="width: 100%; padding: 6px 8px; background: #252525; border: 1px solid #404040; color: #fff; font-size: 14px; border-radius: 3px;">
                                </div>
                            </div>

                            <div style="margin-top: 8px; padding: 8px; background: #2d2d2d; border-left: 3px solid #f59e0b; border-radius: 3px; font-size: 11px; color: #f59e0b;">
                                ‚ö†Ô∏è <strong>Note:</strong> Backtest currently returns simulated results (always 65% win rate, 150 trades). Real backtesting implementation coming soon.
                            </div>

                            <button id="runBacktestBtn" class="btn btn-buy" onclick="runBacktest()" style="width: 100%; font-size: 14px; padding: 10px; margin-top: 8px;">
                                üìä RUN BACKTEST (DEMO)
                            </button>
                        </div>

                        <!-- Backtest Results -->
                        <div id="backtestResults" style="padding: 10px; background: #1a1a1a; border: 1px solid #333; border-radius: 4px; display: none;">
                            <div style="font-size: 13px; color: #888; margin-bottom: 8px; font-weight: 700;">BACKTEST RESULTS</div>
                            <div id="backtestMetrics" style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 12px;">
                                <!-- Metrics grid -->
                            </div>
                            <div id="backtestEquityCurve" style="margin-top: 12px;">
                                <!-- Equity curve chart -->
                            </div>
                        </div>
                    </div>

                    <!-- MODELS TAB -->
                    <div id="aiModelsTab" class="ai-tab-content" style="display: none;">
                        <!-- Current Model Status -->
                        <div style="padding: 10px; background: #1a1a1a; border: 1px solid #333; border-radius: 4px; margin-bottom: 12px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <div style="font-size: 13px; color: #888; font-weight: 700;">CURRENT MODEL</div>
                                <button onclick="refreshModelStatus()" style="padding: 4px 8px; background: #333; border: none; color: #888; border-radius: 3px; cursor: pointer; font-size: 11px;">üîÑ</button>
                            </div>
                            <div id="currentModelStatus">
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                                    <div style="padding: 8px; background: #252525; border-radius: 4px;">
                                        <div style="font-size: 10px; color: #666;">ACCURACY</div>
                                        <div id="modelAccuracy" style="font-size: 18px; font-weight: 700; color: #22c55e;">--</div>
                                    </div>
                                    <div style="padding: 8px; background: #252525; border-radius: 4px;">
                                        <div style="font-size: 10px; color: #666;">LAST TRAINED</div>
                                        <div id="modelTrainDate" style="font-size: 12px; font-weight: 600; color: #60a5fa;">--</div>
                                    </div>
                                </div>
                                <div id="topFeatures" style="margin-top: 8px; padding: 8px; background: #252525; border-radius: 4px;">
                                    <div style="font-size: 10px; color: #666; margin-bottom: 4px;">TOP FEATURES</div>
                                    <div id="topFeaturesList" style="font-size: 11px; color: #aaa;">--</div>
                                </div>
                            </div>
                        </div>

                        <!-- Market Regime Status -->
                        <div style="padding: 10px; background: #1a1a1a; border: 1px solid #333; border-radius: 4px; margin-bottom: 12px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <div style="font-size: 13px; color: #888; font-weight: 700;">MARKET REGIME</div>
                                <button onclick="detectRegime()" style="padding: 4px 8px; background: #333; border: none; color: #888; border-radius: 3px; cursor: pointer; font-size: 11px;">üîÑ DETECT</button>
                            </div>
                            <div id="regimeStatus">
                                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                                    <div id="regimeIndicator" style="width: 12px; height: 12px; border-radius: 50%; background: #666;"></div>
                                    <div>
                                        <div id="regimeType" style="font-size: 14px; font-weight: 700; color: #fff;">Unknown</div>
                                        <div id="regimeConfidence" style="font-size: 11px; color: #888;">Click DETECT to analyze</div>
                                    </div>
                                </div>
                                <div id="regimeAdjustments" style="padding: 8px; background: #252525; border-radius: 4px; font-size: 11px; color: #888; display: none;">
                                    <div style="font-size: 10px; color: #666; margin-bottom: 4px;">RECOMMENDED ADJUSTMENTS</div>
                                    <div id="regimeAdjustmentsList">--</div>
                                </div>
                            </div>
                        </div>

                        <!-- Drift Detection Status -->
                        <div style="padding: 10px; background: #1a1a1a; border: 1px solid #333; border-radius: 4px; margin-bottom: 12px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <div style="font-size: 13px; color: #888; font-weight: 700;">DATA DRIFT</div>
                                <button onclick="checkDrift()" style="padding: 4px 8px; background: #333; border: none; color: #888; border-radius: 3px; cursor: pointer; font-size: 11px;">üîÑ CHECK</button>
                            </div>
                            <div id="driftStatus">
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <div id="driftIndicator" style="width: 12px; height: 12px; border-radius: 50%; background: #22c55e;"></div>
                                    <div>
                                        <div id="driftSeverity" style="font-size: 14px; font-weight: 700; color: #22c55e;">No Drift</div>
                                        <div id="driftMessage" style="font-size: 11px; color: #888;">Model is stable</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Scheduler Status -->
                        <div style="padding: 10px; background: #1a1a1a; border: 1px solid #333; border-radius: 4px;">
                            <div style="font-size: 13px; color: #888; margin-bottom: 8px; font-weight: 700;">AUTO-RETRAIN SCHEDULER</div>
                            <div id="schedulerStatus">
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                                    <div style="padding: 8px; background: #252525; border-radius: 4px;">
                                        <div style="font-size: 10px; color: #666;">NEXT SCHEDULED</div>
                                        <div id="nextTrainTime" style="font-size: 11px; font-weight: 600; color: #f59e0b;">--</div>
                                    </div>
                                    <div style="padding: 8px; background: #252525; border-radius: 4px;">
                                        <div style="font-size: 10px; color: #666;">PENDING JOBS</div>
                                        <div id="pendingJobs" style="font-size: 14px; font-weight: 700; color: #60a5fa;">0</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- BOT TRADING TAB -->
                    <div id="aiBotTab" class="ai-tab-content" style="display: none;">
                        <!-- Bot Status -->
                        <div style="padding: 12px; background: #1a1a1a; border: 2px solid #007acc; border-radius: 4px; margin-bottom: 12px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <div style="font-size: 14px; color: #007acc; font-weight: 700;">ü§ñ BOT STATUS</div>
                                <div id="botStatusIndicator" style="display: flex; align-items: center; gap: 6px; padding: 4px 12px; background: #252525; border-radius: 3px;">
                                    <div style="width: 10px; height: 10px; border-radius: 50%; background: #ef4444;"></div>
                                    <span style="font-size: 12px; font-weight: 600; color: #ef4444;">STOPPED</span>
                                </div>
                            </div>

                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; margin-bottom: 10px;">
                                <div style="padding: 8px; background: #252525; border-radius: 3px;">
                                    <div style="font-size: 11px; color: #888;">RUNNING</div>
                                    <div id="botRunning" style="font-size: 16px; font-weight: 600; color: #ef4444;">FALSE</div>
                                </div>
                                <div style="padding: 8px; background: #252525; border-radius: 3px;">
                                    <div style="font-size: 11px; color: #888;">TRADING</div>
                                    <div id="botEnabled" style="font-size: 16px; font-weight: 600; color: #ef4444;">FALSE</div>
                                </div>
                                <div style="padding: 8px; background: #252525; border-radius: 3px;">
                                    <div style="font-size: 11px; color: #888;">SIGNALS</div>
                                    <div id="botSignals" style="font-size: 16px; font-weight: 600; color: #007acc;">0</div>
                                </div>
                                <div style="padding: 8px; background: #252525; border-radius: 3px;">
                                    <div style="font-size: 11px; color: #888;">TRADES</div>
                                    <div id="botTrades" style="font-size: 16px; font-weight: 600; color: #007acc;">0</div>
                                </div>
                                <div style="padding: 8px; background: #252525; border-radius: 3px;">
                                    <div style="font-size: 11px; color: #888;">POSITIONS</div>
                                    <div id="botPositions" style="font-size: 16px; font-weight: 600; color: #007acc;">0</div>
                                </div>
                                <div style="padding: 8px; background: #252525; border-radius: 3px;">
                                    <div style="font-size: 11px; color: #888;">DAILY P&L</div>
                                    <div id="botPnL" style="font-size: 16px; font-weight: 600; color: #888;">$0.00</div>
                                </div>
                            </div>

                            <!-- Control Buttons -->
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px;">
                                <button onclick="startBot()" style="padding: 10px; background: #22c55e; border: none; color: #fff; font-size: 13px; font-weight: 600; border-radius: 3px; cursor: pointer;">
                                    ‚ñ∂Ô∏è START BOT
                                </button>
                                <button onclick="stopBot()" style="padding: 10px; background: #ef4444; border: none; color: #fff; font-size: 13px; font-weight: 600; border-radius: 3px; cursor: pointer;">
                                    ‚èπÔ∏è STOP BOT
                                </button>
                                <button onclick="enableBotTrading()" style="padding: 10px; background: #3b82f6; border: none; color: #fff; font-size: 13px; font-weight: 600; border-radius: 3px; cursor: pointer;">
                                    ‚úÖ ENABLE TRADING
                                </button>
                                <button onclick="disableBotTrading()" style="padding: 10px; background: #f59e0b; border: none; color: #fff; font-size: 13px; font-weight: 600; border-radius: 3px; cursor: pointer;">
                                    ‚è∏Ô∏è PAUSE TRADING
                                </button>
                            </div>
                        </div>

                        <!-- Risk Limits -->
                        <div style="padding: 10px; background: #1a1a1a; border: 1px solid #ef4444; border-radius: 4px; margin-bottom: 12px;">
                            <div style="font-size: 13px; color: #ef4444; margin-bottom: 8px; font-weight: 700;">‚ö†Ô∏è RISK LIMITS</div>
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; font-size: 11px;">
                                <div style="padding: 6px; background: #252525; border-radius: 3px; text-align: center;">
                                    <div style="color: #888;">MAX/TRADE</div>
                                    <div id="botMaxRisk" style="font-weight: 600; color: #ef4444;">$50</div>
                                </div>
                                <div style="padding: 6px; background: #252525; border-radius: 3px; text-align: center;">
                                    <div style="color: #888;">DAILY LIMIT</div>
                                    <div id="botDailyLimit" style="font-weight: 600; color: #ef4444;">$500</div>
                                </div>
                                <div style="padding: 6px; background: #252525; border-radius: 3px; text-align: center;">
                                    <div style="color: #888;">WEEKLY LIMIT</div>
                                    <div id="botWeeklyLimit" style="font-weight: 600; color: #ef4444;">$3,500</div>
                                </div>
                            </div>
                        </div>

                        <!-- WORKLIST (Shared with Platform) -->
                        <div style="padding: 10px; background: #1a1a1a; border: 1px solid #333; border-radius: 4px; margin-bottom: 12px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <div style="font-size: 13px; color: #888; font-weight: 700;">üìã WORKLIST (Shared)</div>
                                <button onclick="syncWorklistWithScanner()" style="padding: 4px 10px; background: #007acc; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 11px; font-weight: 600;">
                                    üîÑ Add Scanner
                                </button>
                            </div>
                            <div id="botWorklist" style="font-size: 12px; color: #007acc; font-weight: 600;">
                                Loading...
                            </div>
                            <div id="worklistCount" style="font-size: 10px; color: #666; margin-top: 6px;">
                                0 symbols
                            </div>
                            <div style="font-size: 10px; color: #666; margin-top: 4px; padding-top: 4px; border-top: 1px solid #333;">
                                üí° Same worklist used for training, backtesting, predictions & bot trading
                            </div>
                        </div>

                        <!-- Recent Signals -->
                        <div style="padding: 10px; background: #1a1a1a; border: 1px solid #333; border-radius: 4px; margin-bottom: 12px;">
                            <div style="font-size: 13px; color: #888; margin-bottom: 8px; font-weight: 700;">üîî RECENT SIGNALS</div>
                            <div id="botSignalsList" style="max-height: 150px; overflow-y: auto; font-size: 11px;">
                                <div class="empty-state" style="padding: 20px; font-size: 12px;">No signals yet. Bot will generate signals when it finds opportunities.</div>
                            </div>
                        </div>

                        <!-- Open Positions -->
                        <div style="padding: 10px; background: #1a1a1a; border: 1px solid #333; border-radius: 4px;">
                            <div style="font-size: 13px; color: #888; margin-bottom: 8px; font-weight: 700;">üìä OPEN POSITIONS</div>
                            <div id="botOpenPositions" style="max-height: 200px; overflow-y: auto; font-size: 11px;">
                                <div class="empty-state" style="padding: 20px; font-size: 12px;">No open positions</div>
                            </div>
                        </div>

                        <!-- Auto-refresh notice -->
                        <div style="margin-top: 12px; padding: 8px; background: #252525; border-left: 3px solid #007acc; border-radius: 3px; font-size: 11px; color: #888;">
                            ‚ÑπÔ∏è Status updates every 5 seconds automatically
                        </div>
                    </div>
                </div>
            `,

            chart: (id) => `
                <div id="chart-${id}" class="chart-container">
                    <div class="empty-state">Chart will load here</div>
                </div>
            `
        };

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        //                     SYMBOL MANAGEMENT
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        function setCurrentSymbol(symbol) {
            currentSymbol = symbol.toUpperCase();
            document.getElementById('currentSymbolDisplay').textContent = currentSymbol;
            document.getElementById('orderSymbol').value = currentSymbol;

            // Subscribe to market data for new symbol
            subscribeToSymbol(currentSymbol);

            // Update all windows titles
            windows.forEach(win => {
                if (win.id === 'quote') {
                    win.title = `QUOTE - ${currentSymbol}`;
                    win.element.querySelector('.window-header span').textContent = win.title;
                } else if (win.id === 'level2') {
                    win.title = `LEVEL II - ${currentSymbol}`;
                    win.element.querySelector('.window-header span').textContent = win.title;
                } else if (win.id.startsWith('chart')) {
                    const chartId = win.id.replace('chart', '');
                    // Only update LINKED charts
                    if (isChartLinked(chartId)) {
                        win.title = `CHART - ${currentSymbol}`;
                        win.element.querySelector('.window-header span').textContent = win.title;
                        // Update TradingView chart
                        setChartSymbol(chartId, currentSymbol);
                    }
                    // Independent charts keep their own symbol
                }
            });

            // Refresh all market data
            loadPrice();
            loadLevel2();
            loadTimeSales();
            loadWorklist();
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        //                     API INTEGRATION
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        // Helper function to safely update element
        function safeUpdate(id, value) {
            const el = document.getElementById(id);
            if (el) {
                if (el.tagName === 'INPUT' || el.tagName === 'SELECT') {
                    el.value = value;
                } else {
                    el.textContent = value;
                }
                return true;
            }
            return false;
        }

        // Helper function to fetch API with error handling
        async function apiFetch(url) {
            try {
                const response = await fetch(API_BASE_URL + url);
                if (response.ok) {
                    apiAvailable = true;
                    return await response.json();
                } else if (response.status === 503) {
                    if (!demoModeLogged) {
                        console.log('%c‚ö†Ô∏è Alpaca not connected. Please click "Connect Alpaca" in the menu.', 'color: #ef4444; font-weight: bold;');
                        demoModeLogged = true;
                    }
                    return null;
                } else {
                    apiAvailable = false;
                    return null;
                }
            } catch (error) {
                if (!demoModeLogged) {
                    console.log('%c‚ö†Ô∏è API Server not available', 'color: #ef4444; font-weight: bold;');
                    demoModeLogged = true;
                }
                return null;
            }
        }

        // Subscribe to market data for a symbol
        async function subscribeToSymbol(symbol) {
            try {
                await fetch(API_BASE_URL + '/api/subscribe', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        symbol: symbol,
                        exchange: 'SMART',
                        data_types: ['quote', 'l2', 'trades']
                    })
                });
                console.log(`‚úì Subscribed to ${symbol}`);
            } catch (error) {
                console.error(`Error subscribing to ${symbol}:`, error);
            }
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        //                     HALT DETECTION & MANAGEMENT
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        function checkForHalt(symbol, data) {
            const now = Date.now();

            // Check if we're in regular market hours (9:30 AM - 4:00 PM ET)
            const currentTime = new Date();
            const hours = currentTime.getHours();
            const minutes = currentTime.getMinutes();
            const timeInMinutes = hours * 60 + minutes;

            // Market hours: 9:30 AM (570 minutes) to 4:00 PM (960 minutes) ET
            // Note: This assumes your local time is ET. Adjust if needed.
            const marketOpen = 570;  // 9:30 AM
            const marketClose = 960; // 4:00 PM
            const isMarketHours = timeInMinutes >= marketOpen && timeInMinutes < marketClose;

            // Only check for halts during market hours
            // During pre-market/after-hours, bid/ask = 0 is normal, not a halt
            if (!isMarketHours) {
                // Not in market hours - don't detect halts
                if (haltState.isHalted) {
                    // Clear any existing halt state from previous session
                    haltState.isHalted = false;
                    hideHaltIndicator();
                }
                return;
            }

            // Detect halt conditions (ONLY during market hours):
            // 1. Bid and Ask are both 0 or -1
            // 2. OR no updates for more than 8 seconds
            const isDataHalted = (data.bid <= 0 && data.ask <= 0) ||
                                 (data.bid === -1 || data.ask === -1);

            const timeSinceLastUpdate = haltState.lastUpdateTime ? now - haltState.lastUpdateTime : 0;
            const isTimeoutHalt = timeSinceLastUpdate > 8000; // 8 seconds no update

            if ((isDataHalted || isTimeoutHalt) && !haltState.isHalted) {
                // Entering halt
                haltState.isHalted = true;
                haltState.haltTime = new Date();
                haltState.haltPrice = data.last || marketDataCache[symbol]?.last || 0;
                haltState.symbol = symbol;
                haltState.resumeTime = null;

                showHaltIndicator();
                console.log(`üõë HALT DETECTED: ${symbol} at $${haltState.haltPrice.toFixed(2)}`);

            } else if (!isDataHalted && !isTimeoutHalt && haltState.isHalted && data.bid > 0 && data.ask > 0) {
                // Resuming from halt
                haltState.resumeTime = new Date();
                const haltDuration = Math.floor((haltState.resumeTime - haltState.haltTime) / 1000);

                console.log(`‚úÖ RESUMED: ${symbol} after ${haltDuration}s halt`);

                // Show resume notification briefly, then hide
                updateHaltIndicator('resumed');
                setTimeout(() => {
                    haltState.isHalted = false;
                    hideHaltIndicator();
                }, 3000); // Show resume for 3 seconds
            }

            // Update last update time if we got valid data
            if (data.bid > 0 || data.ask > 0 || data.last > 0) {
                haltState.lastUpdateTime = now;
            }

            // Update halt indicator if already halted
            if (haltState.isHalted && haltState.resumeTime === null) {
                updateHaltIndicator('halted');
            }
        }

        function showHaltIndicator() {
            const indicator = document.getElementById('quoteHaltIndicator');
            if (indicator) {
                indicator.style.display = 'block';
            }
        }

        function hideHaltIndicator() {
            const indicator = document.getElementById('quoteHaltIndicator');
            if (indicator) {
                indicator.style.display = 'none';
            }
        }

        function updateHaltIndicator(status) {
            const indicator = document.getElementById('quoteHaltIndicator');
            const titleEl = document.getElementById('quoteHaltTitle');
            const infoEl = document.getElementById('quoteHaltInfo');

            if (!indicator || !titleEl || !infoEl) return;

            if (status === 'halted') {
                const haltDuration = Math.floor((Date.now() - haltState.haltTime) / 1000);
                const haltTimeStr = haltState.haltTime.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', second: '2-digit' });

                titleEl.textContent = 'üõë HALT';
                infoEl.innerHTML = `${haltTimeStr} ‚Ä¢ $${(haltState.haltPrice || 0).toFixed(2)} ‚Ä¢ ${haltDuration}s`;

                indicator.style.background = 'linear-gradient(135deg, #dc2626 0%, #991b1b 100%)';
                indicator.style.color = 'white';

            } else if (status === 'resumed') {
                const resumeTimeStr = haltState.resumeTime.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
                const haltDuration = Math.floor((haltState.resumeTime - haltState.haltTime) / 1000);

                titleEl.textContent = '‚úÖ RESUMED';
                infoEl.innerHTML = `${resumeTimeStr} ‚Ä¢ ${haltDuration}s halt`;

                indicator.style.background = 'linear-gradient(135deg, #16a34a 0%, #15803d 100%)';
                indicator.style.color = 'white';
            }
        }

        async function loadPrice() {
            try {
                // Fetch ONLY from API
                const apiData = await apiFetch(`/api/price/${currentSymbol}`);
                if (!apiData || !apiData.data) {
                    // Clear displays if no data
                    safeUpdate('bidPrice', '--');
                    safeUpdate('askPrice', '--');
                    safeUpdate('lastPrice', '--');
                    safeUpdate('volumePrice', '--');
                    safeUpdate('highPrice', '--');
                    safeUpdate('lowPrice', '--');
                    safeUpdate('openPrice', '--');
                    safeUpdate('closePrice', '--');
                    safeUpdate('bidSize', '--');
                    safeUpdate('askSize', '--');
                    return;
                }

                const d = apiData.data;

                // UPDATE CENTRALIZED STORE FIRST - This will trigger all subscribers
                marketDataStore.update(currentSymbol, {
                    last: d.last,
                    bid: d.bid,
                    ask: d.ask,
                    volume: d.volume,
                    high: d.high,
                    low: d.low,
                    open: d.open,
                    close: d.close,
                    bidSize: d.bidSize,
                    askSize: d.askSize
                });

                // Update UI elements safely
                safeUpdate('bidPrice', d.bid?.toFixed(2) || '--');
                safeUpdate('askPrice', d.ask?.toFixed(2) || '--');
                safeUpdate('lastPrice', d.last?.toFixed(2) || '--');
                safeUpdate('volumePrice', d.volume?.toLocaleString() || '--');
                safeUpdate('highPrice', d.high?.toFixed(2) || '--');
                safeUpdate('lowPrice', d.low?.toFixed(2) || '--');
                safeUpdate('openPrice', d.open?.toFixed(2) || '--');
                safeUpdate('closePrice', d.close?.toFixed(2) || '--');

                if (d.bid) safeUpdate('bidSize', `x ${d.bidSize || 0}`);
                if (d.ask) safeUpdate('askSize', `x ${d.askSize || 0}`);

                // Calculate and display change
                if (d.last && d.close) {
                    const change = d.last - d.close;
                    const changePct = ((change / d.close) * 100).toFixed(2);
                    const changeEl = document.getElementById('priceChange');
                    if (changeEl) {
                        changeEl.textContent = `${change >= 0 ? '+' : ''}${change.toFixed(2)} (${changePct}%)`;
                        changeEl.className = change >= 0 ? 'quote-stat-label positive' : 'quote-stat-label negative';
                    }
                }

                // Auto-set limit price to mid (only if field is not focused and empty/invalid)
                const orderTypeEl = document.getElementById('orderType');
                const orderPriceEl = document.getElementById('orderPrice');
                if (d.bid && d.ask && d.bid > 0 && d.ask > 0 && orderTypeEl && orderTypeEl.value === 'LIMIT') {
                    // Only update if user is NOT currently typing (field not focused) and field is empty or invalid
                    if (document.activeElement !== orderPriceEl &&
                        (!orderPriceEl.value || orderPriceEl.value === '' || parseFloat(orderPriceEl.value) <= 0)) {
                        const mid = ((d.bid + d.ask) / 2).toFixed(2);
                        safeUpdate('orderPrice', mid);
                    }
                }

                // Legacy cache already updated by store.update()

                // Update market price display in order panel
                safeUpdate('marketBid', d.bid?.toFixed(2) || '--');
                safeUpdate('marketLast', d.last?.toFixed(2) || '--');
                safeUpdate('marketAsk', d.ask?.toFixed(2) || '--');

                // Check for trading halt
                checkForHalt(currentSymbol, d);
            } catch (error) {
                console.error('Error loading price:', error);
            }
        }

        async function loadLevel2() {
            try {
                const bidsEl = document.getElementById('bidsDisplay');
                const asksEl = document.getElementById('asksDisplay');

                if (!bidsEl || !asksEl) return;

                // Fetch ONLY from API
                const apiData = await apiFetch(`/api/level2/${currentSymbol}`);
                if (!apiData) {
                    bidsEl.innerHTML = '<div class="empty-state">Connect to Alpaca for Level 2 data</div>';
                    asksEl.innerHTML = '<div class="empty-state">Connect to Alpaca for Level 2 data</div>';
                    return;
                }

                if (apiData.status === 'requesting') {
                    bidsEl.innerHTML = '<div class="empty-state">Requesting Level 2 data...</div>';
                    asksEl.innerHTML = '<div class="empty-state">Requesting Level 2 data...</div>';
                    return;
                }

                const data = apiData;

                let bidsHtml = '';
                if (data.bids && data.bids.length > 0) {
                    data.bids.slice(0, 20).forEach((bid, i) => {
                        bidsHtml += `
                            <div class="level2-row clickable" onclick="setOrderPrice(${bid.price}, 'BUY')">
                                <div>${bid.market_maker || ''}</div>
                                <div style="color: #22c55e;">${bid.size}</div>
                                <div class="level2-price" style="color: #22c55e; font-weight: 700;">${bid.price.toFixed(2)}</div>
                                <div style="color: #666;">1</div>
                            </div>
                        `;
                    });
                } else {
                    bidsHtml = '<div class="empty-state">No bid data</div>';
                }

                let asksHtml = '';
                if (data.asks && data.asks.length > 0) {
                    data.asks.slice(0, 20).forEach((ask, i) => {
                        asksHtml += `
                            <div class="level2-row clickable" onclick="setOrderPrice(${ask.price}, 'SELL')">
                                <div style="color: #666;">1</div>
                                <div class="level2-price" style="color: #ef4444; font-weight: 700;">${ask.price.toFixed(2)}</div>
                                <div style="color: #ef4444;">${ask.size}</div>
                                <div>${ask.market_maker || ''}</div>
                            </div>
                        `;
                    });
                } else {
                    asksHtml = '<div class="empty-state">No ask data</div>';
                }

                bidsEl.innerHTML = bidsHtml;
                asksEl.innerHTML = asksHtml;
            } catch (error) {
                console.error('Error loading level2:', error);
            }
        }

        async function loadTimeSales() {
            try {
                const displayEl = document.getElementById('timesalesDisplay');
                if (!displayEl) return;

                // Fetch ONLY from API
                const apiData = await apiFetch(`/api/timesales/${currentSymbol}?limit=50`);
                if (!apiData || !apiData.trades || apiData.trades.length === 0) {
                    displayEl.innerHTML = '<div class="empty-state">No trade data available. Subscribe to symbol for updates.</div>';
                    return;
                }

                const trades = apiData.trades;

                let html = '';
                if (trades.length > 0) {
                    trades.forEach(trade => {
                        const time = new Date(trade.timestamp).toLocaleTimeString('en-US', {
                            hour12: false,
                            hour: '2-digit',
                            minute: '2-digit',
                            second: '2-digit'
                        });
                        const side = trade.price > (marketDataCache[currentSymbol]?.last || trade.price) ? 'BUY' : 'SELL';
                        const sideColor = side === 'BUY' ? '#22c55e' : '#ef4444';

                        html += `
                            <div class="timesales-row">
                                <div class="timesales-time">${time}</div>
                                <div class="timesales-price" style="color: ${sideColor};">${trade.price.toFixed(2)}</div>
                                <div class="timesales-size">${trade.size}</div>
                                <div class="timesales-side" style="color: ${sideColor};">${side}</div>
                            </div>
                        `;
                    });
                } else {
                    html = '<div class="empty-state">No trade data</div>';
                }

                displayEl.innerHTML = html;
            } catch (error) {
                console.error('Error loading time & sales:', error);
            }
        }

        async function loadPositions() {
            try {
                const displayEl = document.getElementById('positionsDisplay');
                if (!displayEl) return;

                // Fetch ONLY from API
                const apiData = await apiFetch('/api/account');
                if (!apiData || !apiData.positions) {
                    displayEl.innerHTML = '<tr><td colspan="8" class="empty-state">Connect to Alpaca to view positions</td></tr>';
                    return;
                }

                const positions = apiData.positions;

                if (positions.length > 0) {
                    let html = '';
                    positions.forEach(pos => {
                        const pnl = pos.unrealized_pnl || 0;
                        const pnlPct = pos.avg_cost ? ((pnl / (pos.avg_cost * Math.abs(pos.quantity))) * 100).toFixed(2) : 0;
                        const pnlClass = pnl >= 0 ? 'positive' : 'negative';
                        const side = pos.quantity > 0 ? 'LONG' : 'SHORT';
                        const sideClass = pos.quantity > 0 ? 'long' : 'short';

                        html += `
                            <tr class="clickable" onclick="setCurrentSymbol('${pos.symbol}')">
                                <td><strong>${pos.symbol}</strong></td>
                                <td><span class="pos-badge ${sideClass}">${side}</span></td>
                                <td>${Math.abs(pos.quantity)}</td>
                                <td>$${pos.avg_cost?.toFixed(2) || '0.00'}</td>
                                <td>$${((pos.market_value || 0) / Math.abs(pos.quantity)).toFixed(2)}</td>
                                <td class="${pnlClass}">$${pnl.toFixed(2)}</td>
                                <td class="${pnlClass}">${pnlPct}%</td>
                                <td><button class="action-btn" onclick="closePosition('${pos.symbol}', ${pos.quantity}); event.stopPropagation();">Close</button></td>
                            </tr>
                        `;
                    });
                    displayEl.innerHTML = html;
                    positionsCache = positions;
                } else {
                    displayEl.innerHTML = '<tr><td colspan="8" class="empty-state">No open positions</td></tr>';
                }
            } catch (error) {
                console.error('Error loading positions:', error);
            }
        }

        // Current orders tab state
        let currentOrdersTab = 'working';
        let ordersCache = { working: [], open: [], filled: [], closed: [] };

        // Switch orders tab
        function switchOrdersTab(tab) {
            currentOrdersTab = tab;

            // Update tab button styles
            ['working', 'open', 'filled', 'closed'].forEach(t => {
                const btn = document.getElementById('ordersTab' + t.charAt(0).toUpperCase() + t.slice(1));
                if (btn) {
                    if (t === tab) {
                        btn.style.background = '#2d2d2d';
                        btn.style.color = '#fff';
                    } else {
                        btn.style.background = '#1a1a1a';
                        btn.style.color = '#888';
                    }
                }
            });

            // Load orders for selected tab
            loadOrders();
        }

        async function loadOrders() {
            const displayEl = document.getElementById('ordersDisplay');
            if (!displayEl) return;

            try {
                // Fetch orders from Alpaca based on current tab
                let endpoint = '/api/alpaca/orders';
                let statusFilter = null;

                switch(currentOrdersTab) {
                    case 'working':
                        statusFilter = ['new', 'accepted', 'pending_new', 'partially_filled'];
                        break;
                    case 'open':
                        statusFilter = ['new', 'accepted', 'pending_new'];
                        break;
                    case 'filled':
                        statusFilter = ['filled'];
                        endpoint = '/api/alpaca/orders?status=closed';
                        break;
                    case 'closed':
                        statusFilter = ['canceled', 'expired', 'rejected', 'replaced'];
                        endpoint = '/api/alpaca/orders?status=closed';
                        break;
                }

                const response = await fetch(API_BASE_URL + endpoint);
                const data = await response.json();

                let orders = data.orders || [];

                // Filter by status if needed
                if (statusFilter && currentOrdersTab !== 'filled' && currentOrdersTab !== 'closed') {
                    orders = orders.filter(o => statusFilter.includes(o.status?.toLowerCase()));
                } else if (currentOrdersTab === 'filled') {
                    orders = orders.filter(o => o.status?.toLowerCase() === 'filled');
                } else if (currentOrdersTab === 'closed') {
                    orders = orders.filter(o => ['canceled', 'expired', 'rejected', 'replaced'].includes(o.status?.toLowerCase()));
                }

                if (orders.length > 0) {
                    let html = '';
                    orders.forEach(order => {
                        const priceDisplay = order.limit_price ? `$${parseFloat(order.limit_price).toFixed(2)}` :
                                           order.stop_price ? `STOP $${parseFloat(order.stop_price).toFixed(2)}` : 'MKT';
                        const filledQty = order.filled_qty || 0;
                        const qtyDisplay = filledQty > 0 ? `${filledQty}/${order.quantity}` : order.quantity;
                        const statusClass = order.status?.toLowerCase() === 'filled' ? 'positive' :
                                          order.status?.toLowerCase() === 'canceled' ? 'negative' : '';

                        html += `
                            <tr>
                                <td style="font-size: 11px;">${order.created_at ? new Date(order.created_at).toLocaleTimeString() : order.order_id?.slice(0,8)}</td>
                                <td><strong onclick="selectSymbol('${order.symbol}')" style="cursor: pointer; color: #00c9ff;">${order.symbol}</strong></td>
                                <td class="${order.action === 'BUY' || order.side === 'buy' ? 'positive' : 'negative'}">${order.action || order.side?.toUpperCase()}</td>
                                <td>${qtyDisplay}</td>
                                <td>${order.order_type || order.type}</td>
                                <td>${priceDisplay}</td>
                                <td class="${statusClass}">${order.status}</td>
                                <td>
                                    ${['new', 'accepted', 'pending_new', 'partially_filled'].includes(order.status?.toLowerCase()) ?
                                        `<button class="action-btn" onclick="cancelOrderAlpaca('${order.order_id || order.id}')">Cancel</button>` :
                                        '<span style="color: #666;">-</span>'}
                                </td>
                            </tr>
                        `;
                    });
                    displayEl.innerHTML = html;
                } else {
                    const tabName = currentOrdersTab.charAt(0).toUpperCase() + currentOrdersTab.slice(1);
                    displayEl.innerHTML = `<tr><td colspan="8" class="empty-state">No ${tabName.toLowerCase()} orders</td></tr>`;
                }
            } catch (error) {
                console.error('Error loading orders:', error);
                displayEl.innerHTML = '<tr><td colspan="8" class="empty-state" style="color: #ef4444;">‚ùå Error loading orders</td></tr>';
            }
        }

        async function cancelOrderAlpaca(orderId) {
            try {
                const response = await fetch(API_BASE_URL + '/api/alpaca/cancel-order', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ order_id: orderId })
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    console.log(`‚úì Order ${orderId} cancelled`);
                    await loadOrders(); // Refresh orders display
                } else {
                    alert(`‚ùå Failed to cancel order: ${data.detail || 'Unknown error'}`);
                }
            } catch (error) {
                console.error('Error cancelling order:', error);
                alert(`‚ùå Error cancelling order: ${error.message}`);
            }
        }

        async function loadAccount() {
            try {
                // Fetch ONLY from API
                const accountData = await apiFetch('/api/account');
                if (!accountData || !accountData.summary) {
                    safeUpdate('accountNumber', '--');
                    safeUpdate('accountType', '--');
                    safeUpdate('equityValue', '--');
                    safeUpdate('buyingPower', '--');
                    safeUpdate('cashBalance', '--');
                    safeUpdate('marginUsed', '--');
                    safeUpdate('dayPL', '--');
                    safeUpdate('totalPL', '--');
                    safeUpdate('positionCount', '0');
                    return;
                }

                if (accountData.summary) {
                    const s = accountData.summary;

                    // Update account number and type
                    safeUpdate('accountNumber', s.account_id || 'DU1234567');
                    safeUpdate('accountType', s.account_type || 'Unknown');

                    // Update financial values
                    safeUpdate('equityValue', `$${(s.net_liquidation || 0).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`);
                    safeUpdate('buyingPower', `$${(s.buying_power || 0).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`);
                    safeUpdate('cashBalance', `$${(s.total_cash || 0).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`);
                    safeUpdate('marginUsed', `$${((s.net_liquidation - s.total_cash) || 0).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`);

                    const dayPL = accountData.total_unrealized_pnl || 0;
                    const dayPLEl = document.getElementById('dayPL');
                    if (dayPLEl) {
                        dayPLEl.textContent = `$${dayPL.toFixed(2)}`;
                        dayPLEl.className = dayPL >= 0 ? 'account-stat-value positive' : 'account-stat-value negative';
                    }

                    const totalPL = accountData.total_realized_pnl || 0;
                    const totalPLEl = document.getElementById('totalPL');
                    if (totalPLEl) {
                        totalPLEl.textContent = `$${totalPL.toFixed(2)}`;
                        totalPLEl.className = totalPL >= 0 ? 'account-stat-value positive' : 'account-stat-value negative';
                    }

                    safeUpdate('positionCount', accountData.positions?.length || 0);

                    // Handle day trades info for PDT accounts
                    const dayTradesStat = document.getElementById('dayTradesStat');
                    const dayTradesInfo = document.getElementById('dayTradesInfo');
                    const accountWarnings = document.getElementById('accountWarnings');

                    if (s.is_pdt) {
                        // Show day trades remaining
                        if (dayTradesStat) dayTradesStat.style.display = 'block';
                        if (s.day_trades_remaining !== null && s.day_trades_remaining !== undefined) {
                            safeUpdate('dayTradesRemaining', `${s.day_trades_remaining} Left`);

                            if (dayTradesInfo) {
                                dayTradesInfo.style.display = 'block';
                                dayTradesInfo.innerHTML = `Pattern Day Trader Account: ${s.day_trades_remaining} day trades remaining this week`;
                            }

                            // Show warning if running low
                            if (s.day_trades_remaining <= 1 && accountWarnings) {
                                accountWarnings.style.display = 'block';
                                accountWarnings.style.background = '#7f1d1d';
                                accountWarnings.style.color = '#fca5a5';
                                accountWarnings.innerHTML = s.day_trades_remaining === 0
                                    ? '‚ö†Ô∏è DAY TRADE LIMIT REACHED - No day trades remaining!'
                                    : '‚ö†Ô∏è WARNING - Only 1 day trade remaining!';
                            }
                        }
                    } else {
                        if (dayTradesStat) dayTradesStat.style.display = 'none';
                    }

                    // Show account capability warnings
                    if (s.account_capabilities && accountWarnings) {
                        const caps = s.account_capabilities;
                        if (caps.includes('NO_SHORT_SELLING')) {
                            accountWarnings.style.display = 'block';
                            accountWarnings.style.background = '#1e3a8a';
                            accountWarnings.style.color = '#93c5fd';
                            accountWarnings.innerHTML = '‚ö†Ô∏è SHORT SELLING DISABLED for this account type';
                        }
                        if (caps.includes('T+2_SETTLEMENT')) {
                            if (dayTradesInfo) {
                                dayTradesInfo.style.display = 'block';
                                dayTradesInfo.innerHTML = 'Cash Account: T+2 settlement applies - avoid good faith violations';
                            }
                        }
                    }
                }
            } catch (error) {
                console.error('Error loading account:', error);
            }
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        //                     TRADING FUNCTIONS
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        function setQuantity(qty) {
            document.getElementById('orderQuantity').value = qty;
            calculateOrderCost();
        }

        window.setOrderPrice = function(priceType) {
            console.log('setOrderPrice called with:', priceType);

            const symbolEl = document.getElementById('orderSymbol');
            const priceEl = document.getElementById('orderPrice');
            const orderTypeEl = document.getElementById('orderType');

            if (!symbolEl || !priceEl || !orderTypeEl) {
                console.error('Order form elements not found');
                return;
            }

            const symbol = symbolEl.value;
            console.log('Current symbol:', symbol);

            if (!symbol || symbol.trim() === '') {
                alert('Please enter a symbol first');
                return;
            }

            // Get price from market data cache
            const marketData = marketDataCache[symbol];
            console.log('Market data for', symbol, ':', marketData);

            if (!marketData) {
                alert('No market data available for ' + symbol + '\n\nPlease wait for data to load.');
                return;
            }

            let price;
            if (priceType === 'bid') {
                price = marketData.bid;
            } else if (priceType === 'ask') {
                price = marketData.ask;
            } else if (priceType === 'last') {
                price = marketData.last;
            }

            console.log('Selected price:', price);

            if (!price || price <= 0) {
                alert(priceType.toUpperCase() + ' price not available for ' + symbol);
                return;
            }

            // Set order type to LIMIT
            orderTypeEl.value = 'LIMIT';

            // Set the price
            priceEl.value = price.toFixed(2);

            console.log('Price set to:', priceEl.value);

            // Update calculator
            calculateOrderCost();
        }

        function setAccountPercent(percent) {
            const symbol = document.getElementById('orderSymbol').value;
            const priceEl = document.getElementById('orderPrice');

            // Get account equity value
            let accountEquity = 100000; // Default value
            if (accountData && accountData.summary && accountData.summary.net_liquidation) {
                accountEquity = accountData.summary.net_liquidation;
            }

            // Get current price (try limit price first, then market data)
            let currentPrice = parseFloat(priceEl.value) || 0;

            // If no price in order form, try to get from market data cache
            if (currentPrice === 0 || priceEl.value === 'MARKET') {
                const data = marketDataCache[symbol];
                if (data && data.last) {
                    currentPrice = data.last;
                } else if (data && data.bid && data.ask) {
                    currentPrice = (data.bid + data.ask) / 2;
                }
            }

            if (currentPrice > 0) {
                // Calculate dollar amount based on percentage
                const dollarAmount = accountEquity * (percent / 100);

                // Calculate quantity (round down to whole shares)
                const quantity = Math.floor(dollarAmount / currentPrice);

                // Set the quantity
                document.getElementById('orderQuantity').value = quantity;

                // Update cost calculator
                calculateOrderCost();

                // Show confirmation
                console.log(`Account: $${accountEquity.toFixed(2)}, ${percent}% = $${dollarAmount.toFixed(2)}, Price: $${currentPrice.toFixed(2)}, Qty: ${quantity}`);
            } else {
                alert('Cannot calculate quantity: No price available for ' + symbol);
            }
        }

        function adjustPrice(amount) {
            const priceEl = document.getElementById('orderPrice');
            const currentPrice = parseFloat(priceEl.value) || 0;
            priceEl.value = (currentPrice + amount).toFixed(2);
        }

        function setOrderPrice(price, side) {
            document.getElementById('orderPrice').value = price.toFixed(2);
            // Optionally auto-focus quantity or submit
        }

        function handleOrderTypeChange() {
            const type = document.getElementById('orderType').value;
            const priceField = document.getElementById('orderPrice');

            if (type === 'MARKET') {
                priceField.disabled = true;
                priceField.value = 'MARKET';
            } else {
                priceField.disabled = false;
                if (priceField.value === 'MARKET' || priceField.value === '') {
                    const data = marketDataCache[currentSymbol];
                    if (data && data.bid && data.ask) {
                        priceField.value = ((data.bid + data.ask) / 2).toFixed(2);
                    } else {
                        // Clear field if no market data available
                        priceField.value = '';
                        priceField.placeholder = 'Enter limit price';
                    }
                }
            }
        }

        // Order Cost Calculator
        function calculateOrderCost() {
            try {
                const shares = parseInt(document.getElementById('orderQuantity')?.value) || 0;
                const price = parseFloat(document.getElementById('orderPrice')?.value) || 0;

                // Update shares display
                document.getElementById('calcShares').textContent = shares.toLocaleString();

                // Update price display
                document.getElementById('calcPrice').textContent = `$${price.toFixed(2)}`;

                // Calculate total cost (shares * price + commission)
                let cost = shares * price;
                const commission = Math.max(1, 0.005 * shares); // Min $1 or $0.005 per share
                cost += commission;

                // Update total display
                document.getElementById('calcTotal').textContent = `$${cost.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;

                return cost;
            } catch (error) {
                console.error('Error calculating order cost:', error);
                return 0;
            }
        }

        async function submitOrder(action) {
            const symbol = document.getElementById('orderSymbol').value;
            const quantity = document.getElementById('orderQuantity').value;
            const type = document.getElementById('orderType').value;
            const price = document.getElementById('orderPrice').value;
            const tif = document.getElementById('orderTIF').value;
            const extendedHours = document.getElementById('extendedHours').checked;
            const autoSubmit = document.getElementById('autoSubmitOrders').checked;

            // Validation - suppress alerts if auto-submit is enabled
            if (!symbol || symbol.trim() === '') {
                if (!autoSubmit) alert('Please enter a symbol');
                console.error('Validation error: No symbol entered');
                return;
            }

            if (!quantity || parseInt(quantity) <= 0) {
                if (!autoSubmit) alert('Please enter a valid quantity');
                console.error('Validation error: Invalid quantity');
                return;
            }

            let side, orderType;

            if (action === 'BUY_MARKET') {
                side = 'BUY';
                orderType = 'MARKET';
            } else if (action === 'SELL_MARKET') {
                side = 'SELL';
                orderType = 'MARKET';
            } else {
                side = action;
                orderType = type;
            }

            // Validate price for limit orders
            if (orderType === 'LIMIT' && (!price || isNaN(parseFloat(price)) || parseFloat(price) <= 0)) {
                if (!autoSubmit) alert('Please enter a valid limit price (not MARKET)');
                console.error('Validation error: Invalid limit price');
                return;
            }

            const orderDetails = `
ORDER DETAILS:
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
Side:     ${side}
Symbol:   ${symbol}
Quantity: ${quantity}
Type:     ${orderType}
Price:    ${orderType === 'MARKET' ? 'MARKET' : '$' + price}
TIF:      ${tif}
Extended: ${extendedHours ? 'YES (Pre/After Market)' : 'NO (Regular Hours)'}

Confirm order?`;

            // Check auto-submit setting - skip confirmation if enabled
            if (autoSubmit || window.confirm(orderDetails)) {
                try {
                    // Prepare order request
                    const orderRequest = {
                        symbol: symbol.trim().toUpperCase(),
                        action: side,
                        quantity: parseInt(quantity),
                        order_type: orderType,
                        limit_price: orderType !== 'MARKET' ? parseFloat(price) : null,
                        stop_price: null, // Add stop price support if needed
                        tif: tif,
                        extended_hours: extendedHours,
                        exchange: 'SMART'
                    };

                    console.log('Placing order:', orderRequest);

                    // Call API to place order
                    const response = await fetch(API_BASE_URL + '/api/alpaca/place-order', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(orderRequest)
                    });

                    const data = await response.json();

                    if (response.ok && data.success) {
                        // Show alert only if auto-submit is disabled (for faster trading)
                        if (!autoSubmit) {
                            alert(`‚úì Order placed successfully!\n\nOrder ID: ${data.order_id}\nStatus: ${data.status}\n\n${data.message}`);
                        } else {
                            console.log(`‚úì Order ${data.order_id} placed: ${side} ${quantity} ${symbol} @ ${orderType === 'MARKET' ? 'MARKET' : '$' + price}`);
                        }

                        // Clear form (but keep symbol for momentum trading)
                        // document.getElementById('orderSymbol').value = ''; // KEEP SYMBOL
                        document.getElementById('orderQuantity').value = '';
                        // Update price to current market price for next order
                        const data = marketDataCache[symbol];
                        if (data && data.bid && data.ask) {
                            document.getElementById('orderPrice').value = ((data.bid + data.ask) / 2).toFixed(2);
                        }

                        // Refresh orders display
                        await loadOrders();
                        await loadAccount();
                    } else {
                        // Handle error response
                        const errorMsg = data.detail || data.message || 'Unknown error';
                        if (!autoSubmit) {
                            alert(`‚úó Failed to place order\n\n${errorMsg}`);
                        } else {
                            console.error('‚úó Order failed:', errorMsg);
                        }
                    }
                } catch (error) {
                    console.error('Order error:', error);
                    if (!autoSubmit) {
                        alert(`‚úó Failed to place order\n\nError: ${error.message}\n\nMake sure Alpaca is connected.`);
                    } else {
                        console.error('‚úó Order failed:', error.message);
                    }
                }
            }
        }

        async function submitOrderAtPrice(side, priceType) {
            const symbol = document.getElementById('orderSymbol').value;
            const quantity = document.getElementById('orderQuantity').value;
            const autoSubmit = document.getElementById('autoSubmitOrders')?.checked || false;

            // Validation - suppress alerts if auto-submit is enabled
            if (!symbol || symbol.trim() === '') {
                if (!autoSubmit) alert('Please enter a symbol');
                console.error('Validation error: No symbol entered');
                return;
            }

            if (!quantity || parseInt(quantity) <= 0) {
                if (!autoSubmit) alert('Please enter a valid quantity');
                console.error('Validation error: Invalid quantity');
                return;
            }

            // Get price from market data cache
            const marketData = marketDataCache[symbol];
            if (!marketData) {
                if (!autoSubmit) alert('No market data available for ' + symbol + '\n\nPlease wait for data to load.');
                console.error('Validation error: No market data for', symbol);
                return;
            }

            let price;
            if (priceType === 'BID') {
                price = marketData.bid;
                if (!price || price <= 0) {
                    if (!autoSubmit) alert('Bid price not available');
                    console.error('Validation error: Bid price not available');
                    return;
                }
            } else if (priceType === 'ASK') {
                price = marketData.ask;
                if (!price || price <= 0) {
                    if (!autoSubmit) alert('Ask price not available');
                    console.error('Validation error: Ask price not available');
                    return;
                }
            }

            // Set order type to LIMIT and fill in the price
            document.getElementById('orderType').value = 'LIMIT';
            document.getElementById('orderPrice').value = price.toFixed(2);

            // Submit the order using the regular submitOrder function
            await submitOrder(side);
        }

        async function closePosition(symbol, quantity) {
            const side = quantity > 0 ? 'SELL' : 'BUY';
            const qty = Math.abs(quantity);

            if (window.confirm(`Close position in ${symbol}?\n\n${side} ${qty} shares at MARKET`)) {
                try {
                    console.log('Closing position:', symbol, side, qty);

                    // Prepare market order to close position
                    const orderRequest = {
                        symbol: symbol,
                        action: side,
                        quantity: qty,
                        order_type: 'MARKET',
                        limit_price: null,
                        stop_price: null,
                        tif: 'DAY',
                        extended_hours: false,
                        exchange: 'SMART'
                    };

                    // Submit order to Alpaca
                    const response = await fetch(API_BASE_URL + '/api/alpaca/place-order', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(orderRequest)
                    });

                    const data = await response.json();

                    if (response.ok && data.success) {
                        alert(`‚úì Position close order placed!\n\nOrder ID: ${data.order_id}\n${side} ${qty} ${symbol} @ MARKET`);
                        console.log(`‚úì Close order ${data.order_id} placed: ${side} ${qty} ${symbol}`);

                        // Refresh positions and orders
                        await loadPositions();
                        await loadOrders();
                        await loadAccount();
                    } else {
                        const errorMsg = data.detail || data.message || 'Unknown error';
                        alert(`‚úó Failed to close position\n\n${errorMsg}`);
                    }
                } catch (error) {
                    console.error('Close position error:', error);
                    alert(`‚úó Failed to close position\n\nError: ${error.message}\n\nMake sure Alpaca is connected.`);
                }
            }
        }

        async function cancelOrder(orderId) {
            if (window.confirm('Cancel this order?')) {
                try {
                    console.log('Cancelling order:', orderId);

                    const response = await fetch(API_BASE_URL + '/api/alpaca/cancel-order', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ order_id: orderId })
                    });

                    const data = await response.json();

                    if (response.ok && data.success) {
                        alert(`‚úì Order cancelled!\n\nOrder ID: ${orderId}\nStatus: ${data.status || 'Cancelled'}`);
                        console.log(`‚úì Order ${orderId} cancelled`);

                        // Refresh orders and account
                        await loadOrders();
                        await loadAccount();
                    } else {
                        const errorMsg = data.detail || data.message || 'Unknown error';
                        alert(`‚úó Failed to cancel order\n\n${errorMsg}`);
                    }
                } catch (error) {
                    console.error('Cancel order error:', error);
                    alert(`‚úó Failed to cancel order\n\nError: ${error.message}\n\nMake sure Alpaca is connected.`);
                }
            }
        }

        async function cancelAllOrders() {
            const autoSubmit = document.getElementById('autoSubmitOrders')?.checked || false;

            // Skip confirmation if auto-submit is enabled
            if (!autoSubmit && !window.confirm('‚ö†Ô∏è CANCEL ALL WORKING ORDERS?\n\nThis will cancel ALL open orders.\n\nAre you sure?')) {
                return;
            }

            try {
                // Fetch all current orders
                const response = await fetch(API_BASE_URL + '/api/alpaca/orders');
                const data = await response.json();

                if (!data.orders || data.orders.length === 0) {
                    if (!autoSubmit) alert('No orders to cancel');
                    console.log('No orders to cancel');
                    return;
                }

                console.log(`Cancelling ${data.orders.length} orders...`);
                let cancelled = 0;
                let failed = 0;

                // Cancel each order
                for (const order of data.orders) {
                    try {
                        const cancelResponse = await fetch(API_BASE_URL + '/api/alpaca/cancel-order', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ order_id: order.order_id })
                        });

                        const cancelData = await cancelResponse.json();

                        if (cancelResponse.ok && cancelData.success) {
                            cancelled++;
                            console.log(`‚úì Cancelled order ${order.order_id}`);
                        } else {
                            failed++;
                            console.error(`‚úó Failed to cancel order ${order.order_id}:`, cancelData.detail);
                        }
                    } catch (error) {
                        failed++;
                        console.error(`‚úó Error cancelling order ${order.order_id}:`, error);
                    }
                }

                // Show results and refresh
                if (!autoSubmit) {
                    alert(`‚úì Cancel All Complete\n\nCancelled: ${cancelled}\nFailed: ${failed}`);
                } else {
                    console.log(`‚úì Cancel All Complete - Cancelled: ${cancelled}, Failed: ${failed}`);
                }
                await loadOrders();

            } catch (error) {
                console.error('Error cancelling all orders:', error);
                if (!autoSubmit) alert(`‚ùå Error: ${error.message}`);
            }
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        //                     WORKLIST MANAGEMENT (UNIFIED BACKEND)
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        let worklistData = [];

        async function loadWorklist() {
            try {
                const response = await fetch(API_BASE_URL + '/api/worklist');
                const data = await response.json();

                if (data.success && data.data) {
                    worklistData = data.data;

                    // UPDATE CENTRALIZED STORE for each symbol
                    worklistData.forEach(item => {
                        marketDataStore.update(item.symbol, {
                            last: item.current_price,
                            bid: item.bid,
                            ask: item.ask,
                            volume: item.volume,
                            change: item.change,
                            change_percent: item.change_percent
                        });
                    });

                    updateWorklistDisplay();
                    updateWorklistStats();
                }
            } catch (error) {
                console.error('Failed to load worklist:', error);
            }
        }

        async function updateWorklistDisplay() {
            const display = document.getElementById('watchlistDisplay');
            if (!display) return;

            if (worklistData.length === 0) {
                display.innerHTML = '<div class="empty-state" style="padding: 20px; text-align: center;"><div style="font-size: 28px; margin-bottom: 8px;">üìã</div><div style="font-size: 15px;">No symbols in worklist</div><div style="font-size: 13px; color: #888; margin-top: 4px;">Use Scanner or Add Symbol</div></div>';
                return;
            }

            let html = '<table class="data-table" style="font-size: 13px;"><thead><tr><th style="padding: 4px 6px;">Symbol</th><th style="padding: 4px 6px; text-align: right;">Price</th><th style="padding: 4px 6px; text-align: right;">Change</th><th style="padding: 4px 6px; text-align: center;">Pred</th><th style="padding: 4px 6px; text-align: right;">Conf</th><th style="padding: 4px 6px; text-align: center;">Action</th></tr></thead><tbody>';

            for (const item of worklistData) {
                // GET PRICE FROM CENTRALIZED STORE (not from item)
                const storeData = marketDataStore.get(item.symbol);
                const isFresh = marketDataStore.isFresh(item.symbol);
                const price = storeData?.last ? `$${storeData.last.toFixed(2)}` : '-';
                const change = storeData?.change_percent !== undefined ? storeData.change_percent.toFixed(2) + '%' : '-';
                const changeClass = storeData?.change_percent !== undefined && storeData.change_percent >= 0 ? 'positive' : 'negative';

                let predBadge = '-';
                // Handle all prediction formats: BUY/SELL/HOLD, UP/DOWN, BULLISH/BEARISH/NEUTRAL
                const pred = item.prediction?.toUpperCase();
                if (pred === 'BUY' || pred === 'UP' || pred === 'BULLISH' || pred === 'STRONG_BULLISH') {
                    const label = pred === 'STRONG_BULLISH' ? '‚ñ≤‚ñ≤ STRONG' : '‚ñ≤ BUY';
                    const bgColor = pred === 'STRONG_BULLISH' ? '#14532d' : '#166534';
                    predBadge = `<span style="background: ${bgColor}; color: #22c55e; padding: 2px 6px; border-radius: 2px; font-size: 11px; font-weight: 700;">${label}</span>`;
                } else if (pred === 'SELL' || pred === 'DOWN' || pred === 'BEARISH' || pred === 'STRONG_BEARISH') {
                    const label = pred === 'STRONG_BEARISH' ? '‚ñº‚ñº STRONG' : '‚ñº SELL';
                    const bgColor = pred === 'STRONG_BEARISH' ? '#450a0a' : '#7f1d1d';
                    predBadge = `<span style="background: ${bgColor}; color: #ef4444; padding: 2px 6px; border-radius: 2px; font-size: 11px; font-weight: 700;">${label}</span>`;
                } else if (pred === 'HOLD' || pred === 'NEUTRAL') {
                    predBadge = '<span style="background: #3f3f46; color: #a1a1aa; padding: 2px 6px; border-radius: 2px; font-size: 11px; font-weight: 700;">‚Äî HOLD</span>';
                }

                const confidence = item.confidence ? item.confidence.toFixed(0) + '%' : '-';
                // Live indicator: green dot if fresh, red if stale
                const liveIndicator = isFresh ? '<span style="color: #22c55e; margin-left: 4px;" title="Live data (fresh)">üü¢</span>' :
                                      (storeData ? '<span style="color: #eab308; margin-left: 4px;" title="Data delayed">üü°</span>' :
                                       '<span style="color: #ef4444; margin-left: 4px;" title="No data">üî¥</span>');

                html += `
                    <tr class="clickable" onclick="setCurrentSymbol('${item.symbol}')" style="font-size: 13px;">
                        <td style="padding: 4px 6px;"><strong>${item.symbol}</strong>${liveIndicator}</td>
                        <td style="padding: 4px 6px; text-align: right; font-family: monospace;">${price}</td>
                        <td class="${changeClass}" style="padding: 4px 6px; text-align: right; font-family: monospace;">${change}</td>
                        <td style="padding: 4px 6px; text-align: center;">${predBadge}</td>
                        <td style="padding: 4px 6px; text-align: right; font-family: monospace;">${confidence}</td>
                        <td style="padding: 4px 6px; text-align: center;">
                            <button onclick="event.stopPropagation(); removeFromWorklist('${item.symbol}')"
                                    style="background: #7f1d1d; color: #ef4444; border: none; padding: 2px 6px; border-radius: 2px; cursor: pointer; font-size: 12px; font-weight: 600;">‚úï</button>
                        </td>
                    </tr>
                `;
            }

            html += '</tbody></table>';
            display.innerHTML = html;
        }

        function updateWorklistStats() {
            const total = worklistData.length;
            const live = worklistData.filter(w => w.has_live_data || w.price > 0).length;
            // Count all bullish/bearish prediction variants
            const bullish = worklistData.filter(w => {
                const p = w.prediction?.toUpperCase();
                return p === 'BUY' || p === 'UP' || p === 'BULLISH' || p === 'STRONG_BULLISH';
            }).length;
            const bearish = worklistData.filter(w => {
                const p = w.prediction?.toUpperCase();
                return p === 'SELL' || p === 'DOWN' || p === 'BEARISH' || p === 'STRONG_BEARISH';
            }).length;

            const safeUpdate = (id, value) => {
                const el = document.getElementById(id);
                if (el) el.textContent = value;
            };

            safeUpdate('statsTotal', total);
            safeUpdate('statsLive', live);
            safeUpdate('statsBullish', bullish);
            safeUpdate('statsBearish', bearish);
        }

        async function showAddSymbolDialog() {
            const symbol = window.prompt('Enter symbol to add to worklist:', '');
            if (!symbol) return;

            try {
                const response = await fetch(API_BASE_URL + '/api/worklist/add', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ symbol: symbol.toUpperCase(), exchange: 'SMART' })
                });

                const data = await response.json();
                if (data.success) {
                    await loadWorklist();
                    alert(`‚úì ${symbol.toUpperCase()} added to worklist`);
                } else {
                    alert('Failed to add symbol: ' + (data.detail || 'Unknown error'));
                }
            } catch (error) {
                console.error('Failed to add symbol:', error);
                alert('Failed to add symbol');
            }
        }

        async function removeFromWorklist(symbol) {
            if (!window.confirm(`Remove ${symbol} from worklist?`)) return;

            try {
                const response = await fetch(API_BASE_URL + `/api/worklist/${symbol}`, {
                    method: 'DELETE'
                });

                const data = await response.json();
                if (data.success) {
                    await loadWorklist();
                } else {
                    alert('Failed to remove symbol');
                }
            } catch (error) {
                console.error('Failed to remove symbol:', error);
                alert('Failed to remove symbol');
            }
        }

        async function clearWorklist() {
            if (!window.confirm('‚ö†Ô∏è Clear entire worklist?\n\nThis will remove all symbols.')) return;

            try {
                const response = await fetch(API_BASE_URL + '/api/worklist/clear', {
                    method: 'DELETE'
                });

                const data = await response.json();
                if (data.success) {
                    await loadWorklist();
                    alert('‚úì Worklist cleared');
                } else {
                    alert('Failed to clear worklist');
                }
            } catch (error) {
                console.error('Failed to clear worklist:', error);
                alert('Failed to clear worklist');
            }
        }

        async function showScannerDialog() {
            // Load scanner presets
            try {
                const response = await fetch(API_BASE_URL + '/api/scanner/ALPACA/presets');
                const data = await response.json();

                if (!data.success || !data.data) {
                    alert('Failed to load scanner presets');
                    return;
                }

                const presets = data.data;
                let options = presets.map(p => `<option value="${p.id}">${p.name} - ${p.description}</option>`).join('');

                const html = `
                    <div style="padding: 16px; background: #1a1a1a; border: 2px solid #007acc; border-radius: 4px; width: 400px;">
                        <h3 style="margin: 0 0 12px 0; color: #fff; font-size: 18px;">Alpaca Market Scanner</h3>
                        <select id="scannerSelect" style="width: 100%; padding: 8px; background: #252525; color: #fff; border: 1px solid #404040; margin-bottom: 12px;">
                            ${options}
                        </select>
                        <div style="display: flex; gap: 8px; justify-content: flex-end;">
                            <button onclick="closeScannerDialog()" class="btn btn-secondary">Cancel</button>
                            <button onclick="runScanner()" class="btn btn-primary" style="background: #007acc;">Run Scanner</button>
                        </div>
                        <div id="scannerResults" style="margin-top: 12px; max-height: 300px; overflow-y: auto;"></div>
                    </div>
                `;

                const dialog = document.createElement('div');
                dialog.id = 'scannerDialog';
                dialog.style.cssText = 'position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 10000; box-shadow: 0 0 20px rgba(0,0,0,0.5);';
                dialog.innerHTML = html;
                document.body.appendChild(dialog);

                // Add backdrop
                const backdrop = document.createElement('div');
                backdrop.id = 'scannerBackdrop';
                backdrop.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 9999;';
                backdrop.onclick = closeScannerDialog;
                document.body.appendChild(backdrop);

            } catch (error) {
                console.error('Failed to load scanner presets:', error);
                alert('Failed to load scanner presets');
            }
        }

        function closeScannerDialog() {
            const dialog = document.getElementById('scannerDialog');
            const backdrop = document.getElementById('scannerBackdrop');
            if (dialog) dialog.remove();
            if (backdrop) backdrop.remove();
        }

        async function runScanner() {
            const select = document.getElementById('scannerSelect');
            const resultsDiv = document.getElementById('scannerResults');

            if (!select || !resultsDiv) return;

            const preset = select.value;
            resultsDiv.innerHTML = '<div style="text-align: center; padding: 20px; color: #888;">Scanning with Alpaca API...</div>';

            try {
                // Use Alpaca scanner API with correct parameters
                const response = await fetch(API_BASE_URL + '/api/scanner/ALPACA/scan', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        preset: preset,
                        scan_type: preset
                    })
                });

                const data = await response.json();

                console.log('Scanner response:', data);

                if (data.success && data.data && data.data.results) {
                    const results = data.data.results;
                    console.log('Scanner results:', results.length);

                    // Show scan info header
                    let html = `
                        <div style="margin-bottom: 8px; padding: 8px; background: #1a1a1a; border-radius: 4px;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <span style="font-size: 14px; color: #888;">Found <strong style="color: #22c55e;">${results.length}</strong> stocks meeting all criteria</span>
                                </div>
                                <button onclick="addAllScannerResults()" class="btn btn-primary" style="font-size: 14px; padding: 4px 12px; background: #007acc;">Add All to Worklist</button>
                            </div>
                        </div>
                        <table class="data-table" style="font-size: 13px;">
                            <thead>
                                <tr>
                                    <th style="padding: 4px;">#</th>
                                    <th style="padding: 4px;">Symbol</th>
                                    <th style="padding: 4px; text-align: right;">Price</th>
                                    <th style="padding: 4px; text-align: right;">Gap %</th>
                                    <th style="padding: 4px; text-align: right;">RVOL</th>
                                    <th style="padding: 4px; text-align: right;">Volume</th>
                                    <th style="padding: 4px; text-align: center;">Signal</th>
                                    <th style="padding: 4px; text-align: center;">
                                        <input type="checkbox" id="selectAllScanner" onchange="toggleAllScannerResults(this.checked)">
                                    </th>
                                </tr>
                            </thead>
                            <tbody>
                    `;

                    results.forEach((r, i) => {
                        const price = r.price ? r.price.toFixed(2) : 'N/A';
                        const gapPercent = r.gap_percent !== undefined ? r.gap_percent.toFixed(2) : (r.change_percent || 0).toFixed(2);
                        const rvol = r.relative_volume !== undefined ? r.relative_volume.toFixed(1) : '-';
                        const volume = r.volume ? (r.volume / 1000000).toFixed(2) : '0.00';
                        const changeClass = parseFloat(gapPercent) >= 0 ? 'positive' : 'negative';
                        const signal = r.signal || 'NEUTRAL';
                        const hasCatalyst = r.has_catalyst || false;
                        const catalystHeadline = r.catalyst_headline || '';

                        // Signal badge color
                        let signalColor = '#888';
                        if (signal.includes('LONG') || signal.includes('BULLISH') || signal.includes('UP')) signalColor = '#22c55e';
                        else if (signal.includes('SHORT') || signal.includes('BEARISH') || signal.includes('DOWN')) signalColor = '#ef4444';
                        else if (signal.includes('5/5') || signal.includes('NEWS')) signalColor = '#eab308';

                        // News catalyst indicator
                        const newsIcon = hasCatalyst ? '<span title="' + catalystHeadline.replace(/"/g, '&quot;') + '" style="cursor: help;">üì∞</span>' : '';

                        html += `
                            <tr>
                                <td style="padding: 4px;">${i + 1}</td>
                                <td style="padding: 4px;">
                                    <strong>${r.symbol || 'N/A'}</strong>
                                    ${newsIcon}
                                </td>
                                <td style="padding: 4px; text-align: right; font-family: monospace;">$${price}</td>
                                <td class="${changeClass}" style="padding: 4px; text-align: right; font-family: monospace;">${gapPercent}%</td>
                                <td style="padding: 4px; text-align: right; font-family: monospace; color: ${parseFloat(rvol) >= 2 ? '#22c55e' : '#888'};">${rvol}x</td>
                                <td style="padding: 4px; text-align: right; font-family: monospace;">${volume}M</td>
                                <td style="padding: 4px; text-align: center;">
                                    <span style="background: ${signalColor}; color: #000; padding: 1px 5px; border-radius: 2px; font-size: 10px; font-weight: 600;">
                                        ${signal.replace('5/5 PILLARS - ', '').trim()}
                                    </span>
                                </td>
                                <td style="padding: 4px; text-align: center;">
                                    <input type="checkbox" class="scanner-checkbox" value="${r.symbol}" checked>
                                </td>
                            </tr>
                            ${hasCatalyst ? `<tr><td colspan="8" style="padding: 2px 4px 6px 20px; font-size: 11px; color: #f59e0b; background: #1a1a1a;">üì∞ ${catalystHeadline.substring(0, 80)}${catalystHeadline.length > 80 ? '...' : ''}</td></tr>` : ''}
                        `;
                    });

                    html += '</tbody></table>';

                    if (results.length === 0) {
                        html = `<div style="text-align: center; padding: 20px; color: #888;">
                            <p>No stocks currently meet ALL ${preset === 'warrior' || preset === 'warrior_long' ? '5 Pillars' : 'criteria'}.</p>
                            <p style="font-size: 12px; margin-top: 10px;">Requirements: Price $2-$20, RVOL 2x+, Gap 4%+, Volume 500K+</p>
                        </div>`;
                    }

                    resultsDiv.innerHTML = html;
                } else {
                    console.error('Scanner failed - invalid response:', data);
                    resultsDiv.innerHTML = `<div style="text-align: center; padding: 20px; color: #ef4444;">
                        Scanner failed: ${data.message || data.detail || 'No results returned'}
                    </div>`;
                }
            } catch (error) {
                console.error('Scanner error:', error);
                resultsDiv.innerHTML = `<div style="text-align: center; padding: 20px; color: #ef4444;">
                    Scanner error: ${error.message}<br>
                    <small style="color: #888;">Check console for details</small>
                </div>`;
            }
        }

        function toggleAllScannerResults(checked) {
            document.querySelectorAll('.scanner-checkbox').forEach(cb => cb.checked = checked);
        }

        async function addAllScannerResults() {
            const checkboxes = document.querySelectorAll('.scanner-checkbox:checked');
            const symbols = Array.from(checkboxes).map(cb => cb.value);

            if (symbols.length === 0) {
                alert('No symbols selected');
                return;
            }

            try {
                const response = await fetch(API_BASE_URL + '/api/scanner/ALPACA/add-to-worklist', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ symbols })
                });

                const data = await response.json();
                if (data.success) {
                    await loadWorklist();
                    closeScannerDialog();
                    alert(`‚úì Added ${symbols.length} symbols to worklist`);
                } else {
                    alert('Failed to add symbols');
                }
            } catch (error) {
                console.error('Failed to add scanner results:', error);
                alert('Failed to add symbols');
            }
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        //                     AUTONOMOUS BOT CONTROL FUNCTIONS
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        let botStatusInterval = null;

        async function initBot() {
            try {
                // Get config from UI
                const watchlist = document.getElementById('botWatchlist').value.split(',').map(s => s.trim());
                const config = {
                    watchlist: watchlist,
                    max_position_size_usd: parseFloat(document.getElementById('botMaxPosition').value),
                    daily_loss_limit_usd: parseFloat(document.getElementById('botDailyLoss').value),
                    min_probability_threshold: parseFloat(document.getElementById('botMinProb').value) / 100,
                    max_positions: parseInt(document.getElementById('botMaxPositions').value)
                };

                const response = await fetch(API_BASE_URL + '/api/bot/init', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(config)
                });

                if (response.ok) {
                    const data = await response.json();
                    console.log('Bot initialized:', data);

                    // Update UI
                    document.getElementById('botStatusText').textContent = 'INITIALIZED';
                    document.getElementById('botStatusText').style.color = '#fbbf24';
                    document.getElementById('botStatusSubtext').textContent = 'Ready to start';

                    // Enable controls
                    document.getElementById('initBotBtn').disabled = true;
                    document.getElementById('startBotBtn').disabled = false;
                    document.getElementById('enableBotBtn').disabled = false;

                    // Start polling status
                    if (!botStatusInterval) {
                        botStatusInterval = setInterval(updateBotStatus, 2000);
                    }

                    alert('‚úì Bot initialized successfully!');
                } else {
                    const error = await response.json();
                    alert('‚úó Failed to initialize bot: ' + error.detail);
                }
            } catch (error) {
                console.error('Error initializing bot:', error);
                alert('‚úó Error initializing bot: ' + error.message);
            }
        }

        async function startAutonomousBot() {
            try {
                const response = await fetch(API_BASE_URL + '/api/bot/start', { method: 'POST' });

                if (response.ok) {
                    const data = await response.json();
                    console.log('Bot started:', data);

                    document.getElementById('botStatusText').textContent = 'RUNNING';
                    document.getElementById('botStatusText').style.color = '#22c55e';
                    document.getElementById('botStatusSubtext').textContent = data.enabled ? 'Trading enabled' : 'Trading disabled (enable first)';

                    document.getElementById('startBotBtn').disabled = true;
                    document.getElementById('stopBotBtn').disabled = false;

                    alert('‚úì Bot started successfully!');
                } else {
                    const error = await response.json();
                    alert('‚úó Failed to start bot: ' + error.detail);
                }
            } catch (error) {
                console.error('Error starting bot:', error);
                alert('‚úó Error starting bot: ' + error.message);
            }
        }

        async function stopAutonomousBot() {
            try {
                const response = await fetch(API_BASE_URL + '/api/bot/stop', { method: 'POST' });

                if (response.ok) {
                    const data = await response.json();
                    console.log('Bot stopped:', data);

                    document.getElementById('botStatusText').textContent = 'STOPPED';
                    document.getElementById('botStatusText').style.color = '#ef4444';
                    document.getElementById('botStatusSubtext').textContent = 'All positions closed';

                    document.getElementById('startBotBtn').disabled = false;
                    document.getElementById('stopBotBtn').disabled = true;

                    alert('‚úì Bot stopped successfully!');
                } else {
                    const error = await response.json();
                    alert('‚úó Failed to stop bot: ' + error.detail);
                }
            } catch (error) {
                console.error('Error stopping bot:', error);
                alert('‚úó Error stopping bot: ' + error.message);
            }
        }

        async function enableBot() {
            try {
                const response = await fetch(API_BASE_URL + '/api/bot/enable', { method: 'POST' });

                if (response.ok) {
                    const data = await response.json();
                    console.log('Bot enabled:', data);

                    document.getElementById('botStatusSubtext').textContent = 'Trading ENABLED';
                    document.getElementById('enableBotBtn').textContent = '‚úó DISABLE';
                    document.getElementById('enableBotBtn').onclick = disableBot;

                    alert('‚úì Trading enabled! Bot will now execute trades.');
                } else {
                    const error = await response.json();
                    alert('‚úó Failed to enable bot: ' + error.detail);
                }
            } catch (error) {
                console.error('Error enabling bot:', error);
                alert('‚úó Error: ' + error.message);
            }
        }

        async function disableBot() {
            try {
                const response = await fetch(API_BASE_URL + '/api/bot/disable', { method: 'POST' });

                if (response.ok) {
                    const data = await response.json();
                    console.log('Bot disabled:', data);

                    document.getElementById('botStatusSubtext').textContent = 'Trading DISABLED';
                    document.getElementById('enableBotBtn').textContent = '‚úì ENABLE';
                    document.getElementById('enableBotBtn').onclick = enableBot;

                    alert('‚úì Trading disabled. Bot will continue running but not execute trades.');
                } else {
                    const error = await response.json();
                    alert('‚úó Failed to disable bot: ' + error.detail);
                }
            } catch (error) {
                console.error('Error disabling bot:', error);
                alert('‚úó Error: ' + error.message);
            }
        }

        async function updateBotConfig() {
            try {
                const watchlist = document.getElementById('botWatchlist').value.split(',').map(s => s.trim());
                const config = {
                    watchlist: watchlist,
                    max_position_size_usd: parseFloat(document.getElementById('botMaxPosition').value),
                    daily_loss_limit_usd: parseFloat(document.getElementById('botDailyLoss').value),
                    min_probability_threshold: parseFloat(document.getElementById('botMinProb').value) / 100,
                    max_positions: parseInt(document.getElementById('botMaxPositions').value)
                };

                const response = await fetch(API_BASE_URL + '/api/bot/config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(config)
                });

                if (response.ok) {
                    const data = await response.json();
                    console.log('Config updated:', data);
                    alert('‚úì Configuration updated successfully!');
                } else {
                    const error = await response.json();
                    alert('‚úó Failed to update config: ' + error.detail);
                }
            } catch (error) {
                console.error('Error updating config:', error);
                alert('‚úó Error: ' + error.message);
            }
        }

        async function updateBotStatus() {
            try {
                const response = await fetch(API_BASE_URL + '/api/bot/status');
                if (!response.ok) return;

                const data = await response.json();

                // Update statistics
                if (data.total_signals_generated !== undefined) {
                    document.getElementById('botSignals').textContent = data.total_signals_generated;
                }
                if (data.total_trades_executed !== undefined) {
                    document.getElementById('botTrades').textContent = data.total_trades_executed;
                }
                if (data.trading_engine && data.trading_engine.open_positions !== undefined) {
                    document.getElementById('botPositions').textContent = data.trading_engine.open_positions;
                }
                if (data.trading_engine && data.trading_engine.daily_pnl !== undefined) {
                    const pnl = data.trading_engine.daily_pnl;
                    const pnlElem = document.getElementById('botDailyPnl');
                    pnlElem.textContent = '$' + pnl.toFixed(2);
                    pnlElem.style.color = pnl >= 0 ? '#22c55e' : '#ef4444';
                }

                // Update 3-5-7 risk management display
                if (data.trading_engine && data.trading_engine.weekly_pnl !== undefined) {
                    const weeklyPnl = data.trading_engine.weekly_pnl;
                    const weeklyElem = document.getElementById('botWeeklyPnl');
                    weeklyElem.textContent = '$' + weeklyPnl.toFixed(2);
                    weeklyElem.style.color = weeklyPnl >= 0 ? '#22c55e' : '#ef4444';
                }
                if (data.config && data.config.account_size && data.config.max_risk_per_trade_pct) {
                    const maxRiskPerTrade = (data.config.account_size * data.config.max_risk_per_trade_pct / 100).toFixed(2);
                    document.getElementById('botMaxRisk').textContent = '$' + maxRiskPerTrade;
                } else if (data.trading_engine && data.trading_engine.account_size && data.trading_engine.max_risk_per_trade_pct) {
                    const maxRiskPerTrade = (data.trading_engine.account_size * data.trading_engine.max_risk_per_trade_pct / 100).toFixed(2);
                    document.getElementById('botMaxRisk').textContent = '$' + maxRiskPerTrade;
                }

                // Update predictions display
                if (data.last_predictions && Object.keys(data.last_predictions).length > 0) {
                    const predictionsDiv = document.getElementById('botPredictionsDisplay');
                    let html = '';
                    for (const [symbol, pred] of Object.entries(data.last_predictions)) {
                        const prob = (pred.p_final * 100).toFixed(1);
                        const reliability = (pred.reliability * 100).toFixed(0);
                        const color = pred.p_final > 0.5 ? '#22c55e' : pred.p_final < 0.5 ? '#ef4444' : '#888';

                        html += `
                            <div style="padding: 4px; margin-bottom: 4px; background: #1a1a1a; border-left: 3px solid ${color};">
                                <div style="display: flex; justify-content: space-between;">
                                    <span style="font-weight: 700;">${symbol}</span>
                                    <span style="color: ${color};">${prob}%</span>
                                </div>
                                <div style="font-size: 12px; color: #888; margin-top: 2px;">
                                    Reliability: ${reliability}% | ${new Date(pred.timestamp * 1000).toLocaleTimeString()}
                                </div>
                            </div>
                        `;
                    }
                    predictionsDiv.innerHTML = html;
                }

                // Update positions display
                if (data.trading_engine && data.trading_engine.positions && Object.keys(data.trading_engine.positions).length > 0) {
                    const positionsDiv = document.getElementById('botPositionsDisplay');
                    let html = '';
                    for (const [symbol, pos] of Object.entries(data.trading_engine.positions)) {
                        const pnl = pos.unrealized_pnl || 0;
                        const pnlPct = pos.unrealized_pnl_pct || 0;
                        const pnlColor = pnl >= 0 ? '#22c55e' : '#ef4444';

                        html += `
                            <div style="padding: 4px; margin-bottom: 4px; background: #1a1a1a; border-left: 3px solid ${pnlColor};">
                                <div style="display: flex; justify-content: space-between;">
                                    <span style="font-weight: 700;">${symbol}</span>
                                    <span style="color: ${pnlColor};">${pnl >= 0 ? '+' : ''}${pnl.toFixed(2)}</span>
                                </div>
                                <div style="font-size: 12px; color: #888; margin-top: 2px;">
                                    ${pos.quantity} @ $${pos.entry_price.toFixed(2)} | ${pnlPct >= 0 ? '+' : ''}${pnlPct.toFixed(2)}%
                                </div>
                            </div>
                        `;
                    }
                    positionsDiv.innerHTML = html;
                } else if (data.initialized) {
                    document.getElementById('botPositionsDisplay').innerHTML = '<div class="empty-state" style="padding: 16px; font-size: 13px;">No positions</div>';
                }

            } catch (error) {
                console.error('Error updating bot status:', error);
            }
        }

        // Legacy function names for compatibility
        async function startBot() {
            return startAutonomousBot();
        }

        async function stopBot() {
            return stopAutonomousBot();
        }

        async function getPrediction() {
            try {
                const response = await fetch(API_BASE_URL + '/api/ai/predict', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ symbol: currentSymbol })
                });
                const data = await response.json();

                const display = document.getElementById('aiPredictionDisplay');
                const signal = data.signal || 'NEUTRAL';
                const signalColor = signal === 'BUY' ? '#22c55e' : signal === 'SELL' ? '#ef4444' : '#888';

                display.innerHTML = `
                    <div style="padding: 16px; background: #252525; border: 1px solid #333; border-radius: 2px;">
                        <div style="text-align: center; margin-bottom: 12px;">
                            <div style="font-size: 28px; font-weight: 700; color: ${signalColor};">${signal}</div>
                            <div style="font-size: 13px; color: #888; margin-top: 4px;">CONFIDENCE: ${data.confidence || 0}%</div>
                        </div>
                        <div style="font-size: 14px; color: #aaa; line-height: 1.4;">
                            ${data.reason || 'No analysis available'}
                        </div>
                    </div>
                `;
            } catch (error) {
                console.error('Error getting prediction:', error);
                document.getElementById('aiPredictionDisplay').innerHTML = '<div class="empty-state">AI service unavailable</div>';
            }
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        //                     AI CONTROL PANEL FUNCTIONS
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        let currentTrainingId = null;
        let trainingCheckInterval = null;
        let currentBacktestId = null;
        let backtestCheckInterval = null;

        // Tab switching
        function switchAITab(tab) {
            // Hide all tabs
            document.getElementById('aiTrainingTab').style.display = 'none';
            document.getElementById('aiPredictionsTab').style.display = 'none';
            document.getElementById('aiBacktestTab').style.display = 'none';
            document.getElementById('aiModelsTab').style.display = 'none';
            document.getElementById('aiBotTab').style.display = 'none';

            // Reset all tab buttons
            document.querySelectorAll('.ai-tab').forEach(btn => {
                btn.style.background = '#1a1a1a';
                btn.style.color = '#888';
            });

            // Show selected tab
            if (tab === 'training') {
                document.getElementById('aiTrainingTab').style.display = 'block';
                document.getElementById('aiTabTraining').style.background = '#2d2d2d';
                document.getElementById('aiTabTraining').style.color = '#fff';
            } else if (tab === 'predictions') {
                document.getElementById('aiPredictionsTab').style.display = 'block';
                document.getElementById('aiTabPredictions').style.background = '#2d2d2d';
                document.getElementById('aiTabPredictions').style.color = '#fff';
            } else if (tab === 'backtest') {
                document.getElementById('aiBacktestTab').style.display = 'block';
                document.getElementById('aiTabBacktest').style.background = '#2d2d2d';
                document.getElementById('aiTabBacktest').style.color = '#fff';
            } else if (tab === 'models') {
                document.getElementById('aiModelsTab').style.display = 'block';
                document.getElementById('aiTabModels').style.background = '#2d2d2d';
                document.getElementById('aiTabModels').style.color = '#fff';
                loadModelsPerformance();
            } else if (tab === 'bot') {
                document.getElementById('aiBotTab').style.display = 'block';
                document.getElementById('aiTabBot').style.background = '#2d2d2d';
                document.getElementById('aiTabBot').style.color = '#fff';
                updateBotStatus();
                startBotStatusRefresh();
            }
        }

        // TRAINING MODE FUNCTIONS
        function updateTrainingMode() {
            const mode = document.getElementById('trainMode').value;
            const singleInput = document.getElementById('singleSymbolInput');
            const multiInput = document.getElementById('multiSymbolInput');
            const timeValue = document.getElementById('trainTimeValue');

            if (mode === 'single') {
                singleInput.style.display = 'block';
                multiInput.style.display = 'none';
                timeValue.textContent = '~30 seconds';
            } else {
                singleInput.style.display = 'none';
                multiInput.style.display = 'block';
                if (mode === 'multi') timeValue.textContent = '~3 minutes';
                else if (mode === 'walkforward') timeValue.textContent = '~10 minutes';
                else if (mode === 'advanced') timeValue.textContent = '~15 minutes';
            }
        }

        // Advanced training function with multiple modes
        async function trainModelAdvanced() {
            const mode = document.getElementById('trainMode').value;
            const testSize = parseFloat(document.getElementById('trainTestSize').value) / 100;

            let endpoint, body;

            if (mode === 'single') {
                const symbol = document.getElementById('trainSymbol').value.toUpperCase();
                if (!symbol) {
                    alert('Please enter a training symbol');
                    return;
                }
                endpoint = '/api/ai/models/train';
                body = { symbol: symbol, test_size: testSize };
            } else {
                const symbolsStr = document.getElementById('trainSymbols').value;
                const symbols = symbolsStr.split(',').map(s => s.trim().toUpperCase()).filter(s => s);
                if (symbols.length === 0) {
                    alert('Please enter at least one symbol');
                    return;
                }

                if (mode === 'multi') {
                    endpoint = '/api/ai/train-multi';
                    body = { symbols: symbols, test_size: testSize };
                } else if (mode === 'walkforward') {
                    endpoint = '/api/ai/train-walkforward';
                    body = { symbols: symbols, train_months: 12, test_months: 3 };
                } else if (mode === 'advanced') {
                    endpoint = '/api/pipeline/train/advanced';
                    body = { symbols: symbols, model_type: 'lightgbm', optimize: true, n_trials: 30 };
                }
            }

            try {
                const btn = document.getElementById('trainModelBtn');
                btn.disabled = true;
                btn.textContent = '‚è≥ TRAINING...';

                document.getElementById('trainingStatus').style.display = 'block';
                document.getElementById('trainingMetrics').style.display = 'none';
                document.getElementById('trainingStatusText').textContent = 'Training in progress... This may take several minutes.';
                document.getElementById('trainingProgressBar').style.width = '50%';
                document.getElementById('trainingProgressText').textContent = 'Training...';

                const startTime = Date.now();

                const response = await fetch(API_BASE_URL + endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });

                const data = await response.json();
                const elapsedTime = ((Date.now() - startTime) / 1000).toFixed(1);
                console.log('Training result:', data);

                // Show results
                document.getElementById('trainingProgressBar').style.width = '100%';
                document.getElementById('trainingProgressText').textContent = '100%';

                if (data.success || data.metrics || data.accuracy) {
                    const metrics = data.data || data.metrics || data;
                    const accuracy = metrics.accuracy || metrics.metrics?.accuracy || 0;
                    const samples = metrics.samples || metrics.train_samples || '--';

                    document.getElementById('trainingStatusText').textContent = `Training completed in ${elapsedTime}s`;
                    document.getElementById('trainingMetrics').style.display = 'block';
                    document.getElementById('trainAccuracy').textContent = (accuracy * 100).toFixed(1) + '%';
                    document.getElementById('trainAccuracy').style.color = accuracy > 0.5 ? '#22c55e' : accuracy > 0.4 ? '#f59e0b' : '#ef4444';
                    document.getElementById('trainSamples').textContent = samples;
                } else {
                    document.getElementById('trainingStatusText').textContent = 'Training completed (check console for details)';
                }

                btn.disabled = false;
                btn.textContent = 'üöÄ START TRAINING';

            } catch (error) {
                console.error('Training error:', error);
                alert('Training error: ' + error.message);
                document.getElementById('trainModelBtn').disabled = false;
                document.getElementById('trainModelBtn').textContent = 'üöÄ START TRAINING';
            }
        }

        // Model status functions
        async function refreshModelStatus() {
            try {
                const response = await fetch(API_BASE_URL + '/api/ai/model-info');
                const data = await response.json();

                if (data.trained) {
                    document.getElementById('modelAccuracy').textContent = (data.accuracy * 100).toFixed(1) + '%';
                    document.getElementById('modelAccuracy').style.color = data.accuracy > 0.5 ? '#22c55e' : data.accuracy > 0.4 ? '#f59e0b' : '#ef4444';

                    const trainDate = new Date(data.training_date);
                    document.getElementById('modelTrainDate').textContent = trainDate.toLocaleDateString() + ' ' + trainDate.toLocaleTimeString();

                    if (data.top_features && data.top_features.length > 0) {
                        const featureNames = data.top_features.slice(0, 5).map(f => f.name).join(', ');
                        document.getElementById('topFeaturesList').textContent = featureNames;
                    }
                } else {
                    document.getElementById('modelAccuracy').textContent = '--';
                    document.getElementById('modelTrainDate').textContent = 'Not trained';
                    document.getElementById('topFeaturesList').textContent = 'Train a model first';
                }

                // Also fetch scheduler status
                refreshSchedulerStatus();
            } catch (error) {
                console.error('Error fetching model info:', error);
            }
        }

        async function refreshSchedulerStatus() {
            try {
                const response = await fetch(API_BASE_URL + '/api/pipeline/scheduler/status');
                const data = await response.json();

                if (data.success && data.data) {
                    const scheduler = data.data;
                    document.getElementById('pendingJobs').textContent = scheduler.pending_jobs || 0;

                    if (scheduler.next_scheduled) {
                        const nextTime = new Date(scheduler.next_scheduled);
                        document.getElementById('nextTrainTime').textContent = nextTime.toLocaleDateString() + ' ' + nextTime.toLocaleTimeString();
                    }
                }
            } catch (error) {
                console.error('Error fetching scheduler status:', error);
            }
        }

        // Regime detection
        async function detectRegime() {
            try {
                document.getElementById('regimeType').textContent = 'Detecting...';
                document.getElementById('regimeConfidence').textContent = 'Analyzing market data...';

                const response = await fetch(API_BASE_URL + '/api/pipeline/regime/detect');
                const data = await response.json();

                if (data.success && data.data) {
                    const regime = data.data;
                    const regimeNames = {
                        'bull_trend': 'üìà Bull Trend',
                        'bear_trend': 'üìâ Bear Trend',
                        'range_bound': '‚ÜîÔ∏è Range Bound',
                        'high_volatility': '‚ö° High Volatility',
                        'low_volatility': 'üò¥ Low Volatility',
                        'crisis': 'üö® Crisis',
                        'unknown': '‚ùì Unknown'
                    };

                    const regimeColors = {
                        'bull_trend': '#22c55e',
                        'bear_trend': '#ef4444',
                        'range_bound': '#f59e0b',
                        'high_volatility': '#ef4444',
                        'low_volatility': '#60a5fa',
                        'crisis': '#dc2626',
                        'unknown': '#666'
                    };

                    document.getElementById('regimeType').textContent = regimeNames[regime.regime] || regime.regime;
                    document.getElementById('regimeConfidence').textContent = `Confidence: ${(regime.confidence * 100).toFixed(1)}%`;
                    document.getElementById('regimeIndicator').style.background = regimeColors[regime.regime] || '#666';

                    // Show adjustments if available
                    const adjResponse = await fetch(API_BASE_URL + '/api/pipeline/regime/adjustments');
                    const adjData = await adjResponse.json();
                    if (adjData.success && adjData.data.adjustments) {
                        const adj = adjData.data.adjustments;
                        document.getElementById('regimeAdjustments').style.display = 'block';
                        document.getElementById('regimeAdjustmentsList').innerHTML = `
                            Position Size: ${(adj.position_size_multiplier * 100).toFixed(0)}%<br>
                            Confidence Threshold: ${adj.confidence_threshold > 0 ? '+' : ''}${(adj.confidence_threshold * 100).toFixed(0)}%
                        `;
                    }
                }
            } catch (error) {
                console.error('Error detecting regime:', error);
                document.getElementById('regimeType').textContent = 'Error';
                document.getElementById('regimeConfidence').textContent = error.message;
            }
        }

        // Drift detection
        async function checkDrift() {
            try {
                document.getElementById('driftSeverity').textContent = 'Checking...';
                document.getElementById('driftMessage').textContent = 'Analyzing data distributions...';

                const response = await fetch(API_BASE_URL + '/api/pipeline/drift/summary');
                const data = await response.json();

                if (data.success && data.data) {
                    const drift = data.data;

                    if (drift.message === 'No drift history') {
                        document.getElementById('driftSeverity').textContent = 'No Baseline';
                        document.getElementById('driftSeverity').style.color = '#888';
                        document.getElementById('driftIndicator').style.background = '#666';
                        document.getElementById('driftMessage').textContent = 'Set reference data first with training';
                    } else {
                        const severityColors = {
                            'none': '#22c55e',
                            'low': '#84cc16',
                            'medium': '#f59e0b',
                            'high': '#ef4444',
                            'critical': '#dc2626'
                        };

                        const shouldRetrain = drift.should_retrain?.[0] || false;
                        document.getElementById('driftSeverity').textContent = shouldRetrain ? 'Retrain Needed' : 'Stable';
                        document.getElementById('driftSeverity').style.color = shouldRetrain ? '#ef4444' : '#22c55e';
                        document.getElementById('driftIndicator').style.background = shouldRetrain ? '#ef4444' : '#22c55e';
                        document.getElementById('driftMessage').textContent = drift.should_retrain?.[1] || 'Model is stable';
                    }
                }
            } catch (error) {
                console.error('Error checking drift:', error);
                document.getElementById('driftSeverity').textContent = 'Error';
                document.getElementById('driftMessage').textContent = error.message;
            }
        }

        // TRAINING FUNCTIONS (legacy)
        async function trainModel() {
            const symbol = document.getElementById('trainSymbol').value.toUpperCase();
            const period = document.getElementById('trainPeriod').value;
            const testSize = parseFloat(document.getElementById('trainTestSize').value) / 100;

            if (!symbol) {
                alert('Please enter a training symbol');
                return;
            }

            try {
                // Disable button
                const btn = document.getElementById('trainModelBtn');
                btn.disabled = true;
                btn.textContent = '‚è≥ TRAINING...';

                // Show training status
                document.getElementById('trainingStatus').style.display = 'block';
                document.getElementById('trainingMetrics').style.display = 'none';

                const response = await fetch(API_BASE_URL + '/api/ai/models/train', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        symbol: symbol,
                        period: period,
                        test_size: testSize
                    })
                });

                const data = await response.json();
                console.log('Training started:', data);

                if (data.success && data.data.training_id) {
                    currentTrainingId = data.data.training_id;

                    // Start polling for progress
                    if (trainingCheckInterval) clearInterval(trainingCheckInterval);
                    trainingCheckInterval = setInterval(checkTrainingProgress, 1000);
                } else {
                    throw new Error('Failed to start training');
                }

            } catch (error) {
                console.error('Error starting training:', error);
                alert('Error starting training: ' + error.message);

                // Re-enable button
                const btn = document.getElementById('trainModelBtn');
                btn.disabled = false;
                btn.textContent = 'üöÄ START TRAINING';
            }
        }

        async function checkTrainingProgress() {
            if (!currentTrainingId) return;

            try {
                // Get training session status from server
                const response = await fetch(API_BASE_URL + '/api/ai/models/train/' + currentTrainingId + '/status');

                if (!response.ok) {
                    // Session might not exist yet, continue polling
                    return;
                }

                const data = await response.json();
                const session = data.session || {};

                // Update progress bar
                const progress = session.progress || 0;
                document.getElementById('trainingProgressBar').style.width = progress + '%';
                document.getElementById('trainingProgressText').textContent = progress + '%';

                // Update status text
                const statusText = session.status || 'training';
                document.getElementById('trainingStatusText').textContent = statusText.replace('_', ' ').toUpperCase();

                // Check if completed
                if (session.status === 'completed') {
                    clearInterval(trainingCheckInterval);
                    trainingCheckInterval = null;

                    // Show metrics
                    if (session.metrics) {
                        document.getElementById('trainAccuracy').textContent = (session.metrics.accuracy * 100).toFixed(2) + '%';
                        document.getElementById('trainSamples').textContent = session.metrics.samples || 0;
                        document.getElementById('trainingMetrics').style.display = 'block';
                    }

                    // Re-enable button
                    const btn = document.getElementById('trainModelBtn');
                    btn.disabled = false;
                    btn.textContent = 'üöÄ START TRAINING';

                    alert('‚úì Training completed!\n\nAccuracy: ' + (session.metrics.accuracy * 100).toFixed(2) + '%\nSamples: ' + session.metrics.samples);

                } else if (session.status === 'failed') {
                    clearInterval(trainingCheckInterval);
                    trainingCheckInterval = null;

                    document.getElementById('trainingStatusText').textContent = 'FAILED: ' + (session.error || 'Unknown error');

                    // Re-enable button
                    const btn = document.getElementById('trainModelBtn');
                    btn.disabled = false;
                    btn.textContent = 'üöÄ START TRAINING';

                    alert('‚úó Training failed: ' + (session.error || 'Unknown error'));
                }

            } catch (error) {
                console.error('Error checking training progress:', error);
            }
        }

        // PREDICTION FUNCTIONS
        async function predictWorklist() {
            const worklistDiv = document.getElementById('worklistPredictions');
            worklistDiv.innerHTML = '<div class="empty-state" style="padding: 20px;">Loading predictions...</div>';

            try {
                // Get worklist
                const worklistResponse = await fetch(API_BASE_URL + '/api/worklist');
                const worklistData = await worklistResponse.json();

                if (!worklistData.success || !worklistData.data.length) {
                    worklistDiv.innerHTML = '<div class="empty-state" style="padding: 20px;">Worklist is empty</div>';
                    return;
                }

                let html = '';

                // Get predictions for each symbol
                for (const item of worklistData.data) {
                    const symbol = item.symbol;

                    try {
                        const predResponse = await fetch(API_BASE_URL + '/api/ai/predict', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ symbol: symbol })
                        });

                        const predData = await predResponse.json();

                        // Determine color
                        let signalColor = '#888';
                        if (predData.signal && predData.signal.includes('BULLISH')) signalColor = '#22c55e';
                        else if (predData.signal && predData.signal.includes('BEARISH')) signalColor = '#ef4444';

                        html += `
                            <div style="padding: 8px; margin-bottom: 6px; background: #252525; border-radius: 3px; border-left: 3px solid ${signalColor};">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                                    <div style="font-size: 14px; font-weight: 700; color: #fff;">${symbol}</div>
                                    <div style="font-size: 13px; font-weight: 600; color: ${signalColor};">${predData.signal || 'NEUTRAL'}</div>
                                </div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 6px; font-size: 11px;">
                                    <div>
                                        <span style="color: #666;">Confidence:</span>
                                        <span style="color: #aaa; font-weight: 600;">${(predData.confidence * 100).toFixed(1)}%</span>
                                    </div>
                                    <div>
                                        <span style="color: #666;">Prob Up:</span>
                                        <span style="color: #aaa; font-weight: 600;">${(predData.prob_up * 100).toFixed(1)}%</span>
                                    </div>
                                </div>
                            </div>
                        `;

                    } catch (error) {
                        console.error('Error predicting', symbol, ':', error);
                        html += `
                            <div style="padding: 8px; margin-bottom: 6px; background: #252525; border-radius: 3px;">
                                <div style="font-size: 14px; font-weight: 700; color: #fff;">${symbol}</div>
                                <div style="font-size: 11px; color: #ef4444;">Prediction failed</div>
                            </div>
                        `;
                    }
                }

                worklistDiv.innerHTML = html;

            } catch (error) {
                console.error('Error getting worklist predictions:', error);
                worklistDiv.innerHTML = '<div class="empty-state" style="padding: 20px;">Error loading predictions</div>';
            }
        }

        async function predictSingle() {
            const symbol = document.getElementById('singlePredictSymbol').value.toUpperCase();

            if (!symbol) {
                alert('Please enter a symbol');
                return;
            }

            const resultDiv = document.getElementById('singlePredictionResult');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '<div style="padding: 12px; text-align: center; color: #888;">Loading...</div>';

            try {
                const response = await fetch(API_BASE_URL + '/api/ai/predict', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ symbol: symbol })
                });

                const data = await response.json();

                // Determine color
                let signalColor = '#888';
                if (data.signal && data.signal.includes('BULLISH')) signalColor = '#22c55e';
                else if (data.signal && data.signal.includes('BEARISH')) signalColor = '#ef4444';

                resultDiv.innerHTML = `
                    <div style="padding: 12px; background: #252525; border-radius: 4px; border-left: 4px solid ${signalColor};">
                        <div style="font-size: 18px; font-weight: 700; color: ${signalColor}; margin-bottom: 8px; text-align: center;">
                            ${data.signal || 'NEUTRAL'}
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 12px;">
                            <div style="text-align: center;">
                                <div style="font-size: 10px; color: #666; margin-bottom: 2px;">CONFIDENCE</div>
                                <div style="font-size: 20px; font-weight: 700; color: #fff;">${(data.confidence * 100).toFixed(1)}%</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 10px; color: #666; margin-bottom: 2px;">PROB UP</div>
                                <div style="font-size: 20px; font-weight: 700; color: #22c55e;">${(data.prob_up * 100).toFixed(1)}%</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 10px; color: #666; margin-bottom: 2px;">PROB DOWN</div>
                                <div style="font-size: 20px; font-weight: 700; color: #ef4444;">${(data.prob_down * 100).toFixed(1)}%</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 10px; color: #666; margin-bottom: 2px;">TIMESTAMP</div>
                                <div style="font-size: 11px; color: #aaa;">${new Date(data.timestamp).toLocaleTimeString()}</div>
                            </div>
                        </div>
                        ${data.signal_detail ? `<div style="margin-top: 8px; padding: 6px; background: #1a1a1a; border-radius: 3px; font-size: 11px; color: #888; text-align: center;">${data.signal_detail}</div>` : ''}
                    </div>
                `;

            } catch (error) {
                console.error('Error getting prediction:', error);
                resultDiv.innerHTML = '<div style="padding: 12px; color: #ef4444; text-align: center;">Prediction failed: ' + error.message + '</div>';
            }
        }

        // BACKTEST FUNCTIONS
        async function runBacktest() {
            const strategy = document.getElementById('backtestStrategy').value;
            const symbols = document.getElementById('backtestSymbols').value.split(',').map(s => s.trim().toUpperCase());
            const startDate = document.getElementById('backtestStartDate').value;
            const endDate = document.getElementById('backtestEndDate').value;
            const capital = parseFloat(document.getElementById('backtestCapital').value);
            const positionSize = parseFloat(document.getElementById('backtestPositionSize').value) / 100;

            if (!symbols.length || !startDate || !endDate) {
                alert('Please fill in all backtest parameters');
                return;
            }

            try {
                // Disable button
                const btn = document.getElementById('runBacktestBtn');
                btn.disabled = true;
                btn.textContent = '‚è≥ RUNNING...';

                // Show results section
                document.getElementById('backtestResults').style.display = 'block';
                document.getElementById('backtestMetrics').innerHTML = '<div style="padding: 20px; text-align: center; color: #888;">Running backtest...</div>';

                const response = await fetch(API_BASE_URL + '/api/backtest/run', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        strategy: strategy,
                        symbols: symbols,
                        start_date: startDate,
                        end_date: endDate,
                        initial_capital: capital,
                        position_size_pct: positionSize
                    })
                });

                const data = await response.json();
                console.log('Backtest started:', data);

                if (data.success && data.data.backtest_id) {
                    currentBacktestId = data.data.backtest_id;

                    // Start polling for results
                    if (backtestCheckInterval) clearInterval(backtestCheckInterval);
                    backtestCheckInterval = setInterval(checkBacktestResults, 2000);
                } else {
                    throw new Error('Failed to start backtest');
                }

            } catch (error) {
                console.error('Error starting backtest:', error);
                alert('Error starting backtest: ' + error.message);

                // Re-enable button
                const btn = document.getElementById('runBacktestBtn');
                btn.disabled = false;
                btn.textContent = 'üìä RUN BACKTEST';
            }
        }

        async function checkBacktestResults() {
            if (!currentBacktestId) return;

            try {
                const response = await fetch(API_BASE_URL + '/api/backtest/' + currentBacktestId + '/results');
                const data = await response.json();

                if (!data.success) return;

                const bt = data.data;

                // Check if completed
                if (bt.status === 'completed') {
                    clearInterval(backtestCheckInterval);
                    backtestCheckInterval = null;

                    // Display metrics
                    const metrics = bt.metrics;
                    document.getElementById('backtestMetrics').innerHTML = `
                        <div style="padding: 8px; background: #252525; border-radius: 3px; text-align: center;">
                            <div style="font-size: 10px; color: #666;">TOTAL RETURN</div>
                            <div style="font-size: 20px; font-weight: 700; color: ${metrics.total_return >= 0 ? '#22c55e' : '#ef4444'};">
                                ${metrics.total_return >= 0 ? '+' : ''}${metrics.total_return.toFixed(2)}%
                            </div>
                        </div>
                        <div style="padding: 8px; background: #252525; border-radius: 3px; text-align: center;">
                            <div style="font-size: 10px; color: #666;">SHARPE RATIO</div>
                            <div style="font-size: 20px; font-weight: 700; color: #60a5fa;">${metrics.sharpe_ratio.toFixed(2)}</div>
                        </div>
                        <div style="padding: 8px; background: #252525; border-radius: 3px; text-align: center;">
                            <div style="font-size: 10px; color: #666;">MAX DRAWDOWN</div>
                            <div style="font-size: 20px; font-weight: 700; color: #ef4444;">${metrics.max_drawdown.toFixed(2)}%</div>
                        </div>
                        <div style="padding: 8px; background: #252525; border-radius: 3px; text-align: center;">
                            <div style="font-size: 10px; color: #666;">WIN RATE</div>
                            <div style="font-size: 20px; font-weight: 700; color: #22c55e;">${(metrics.win_rate * 100).toFixed(1)}%</div>
                        </div>
                        <div style="padding: 8px; background: #252525; border-radius: 3px; text-align: center;">
                            <div style="font-size: 10px; color: #666;">TOTAL TRADES</div>
                            <div style="font-size: 20px; font-weight: 700; color: #fff;">${metrics.total_trades}</div>
                        </div>
                        <div style="padding: 8px; background: #252525; border-radius: 3px; text-align: center;">
                            <div style="font-size: 10px; color: #666;">PROFITABLE</div>
                            <div style="font-size: 20px; font-weight: 700; color: #22c55e;">${metrics.profitable_trades}</div>
                        </div>
                    `;

                    // Re-enable button
                    const btn = document.getElementById('runBacktestBtn');
                    btn.disabled = false;
                    btn.textContent = 'üìä RUN BACKTEST';

                    alert('‚úì Backtest completed!\n\nTotal Return: ' + metrics.total_return.toFixed(2) + '%\nWin Rate: ' + (metrics.win_rate * 100).toFixed(1) + '%');
                }

            } catch (error) {
                console.error('Error checking backtest results:', error);
            }
        }

        // Open AI Control Panel window
        function openAIControlPanel() {
            // Check if window already exists
            const existing = windows.find(w => w.id === 'aicontrol');
            if (existing) {
                existing.restore();
                existing.activate();
                return;
            }

            // Create new AI Control Panel window (centered, large size)
            createWindow('aicontrol', 'ü§ñ AI CONTROL PANEL', windowTemplates.aicontrol, 300, 100, 680, 600);
        }

        // Open Claude Chat window
        function openClaudeChatWindow() {
            const existing = windows.find(w => w.id === 'claudechat');
            if (existing) {
                existing.restore();
                existing.activate();
                // Refresh live status when reopening
                updateClaudeLiveStatus();
                return;
            }
            createWindow('claudechat', 'üí¨ CLAUDE AI CHAT', windowTemplates.claudechat, 1000, 100, 450, 550);
            // Initialize live monitoring after a brief delay to ensure DOM is ready
            setTimeout(initClaudeLiveMonitoring, 100);
        }

        // Open PDT Monitor window
        function openPDTMonitor() {
            const existing = windows.find(w => w.id === 'pdtmonitor');
            if (existing) {
                existing.restore();
                existing.activate();
                refreshPDTStatus();
                return;
            }
            createWindow('pdtmonitor', '‚öñÔ∏è PDT RULE MONITOR', windowTemplates.pdtmonitor, 100, 150, 380, 620);
            // Load PDT status after window opens
            setTimeout(refreshPDTStatus, 100);
        }

        // Refresh PDT status
        async function refreshPDTStatus() {
            try {
                const response = await fetch(API_BASE_URL + '/api/alpaca/pdt-status');
                const data = await response.json();

                // Update status badge
                const badge = document.getElementById('pdtStatusBadge');
                const message = document.getElementById('pdtStatusMessage');
                const header = document.getElementById('pdtStatusHeader');

                if (badge) {
                    badge.textContent = data.status;
                    // Color based on warning level
                    const colors = {
                        'none': '#22c55e',      // Green - exempt
                        'low': '#22c55e',       // Green - OK
                        'medium': '#f59e0b',    // Yellow - caution
                        'high': '#f97316',      // Orange - warning
                        'critical': '#ef4444',  // Red - limit reached or flagged
                        'unknown': '#888'
                    };
                    badge.style.color = colors[data.warning_level] || '#888';

                    // Update header background for critical warnings
                    if (data.warning_level === 'critical') {
                        header.style.background = '#2d1b1b';
                        header.style.border = '1px solid #7f1d1d';
                    } else if (data.warning_level === 'high') {
                        header.style.background = '#2d2b1b';
                        header.style.border = '1px solid #7f6d1d';
                    } else {
                        header.style.background = '#1a1a1a';
                        header.style.border = 'none';
                    }
                }

                if (message) {
                    message.textContent = data.message;
                }

                // Update counters
                const used = document.getElementById('pdtDayTradesUsed');
                const remaining = document.getElementById('pdtDayTradesRemaining');

                if (used) {
                    used.textContent = data.day_trades_used || 0;
                    used.style.color = data.day_trades_used >= 3 ? '#ef4444' : data.day_trades_used >= 2 ? '#f59e0b' : '#22c55e';
                }

                if (remaining) {
                    remaining.textContent = data.day_trades_remaining || 0;
                    remaining.style.color = data.day_trades_remaining === 0 ? '#ef4444' : data.day_trades_remaining === 1 ? '#f59e0b' : '#22c55e';
                }

                // Update account info
                const equity = document.getElementById('pdtEquity');
                const exempt = document.getElementById('pdtExempt');

                if (equity) {
                    equity.textContent = '$' + (data.equity || 0).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                }

                if (exempt) {
                    exempt.textContent = data.is_exempt ? 'Yes (>$25k)' : 'No';
                    exempt.style.color = data.is_exempt ? '#22c55e' : '#f59e0b';
                }

                // Update recent day trades
                const recentTrades = document.getElementById('pdtRecentTrades');
                if (recentTrades && data.recent_day_trades) {
                    if (data.recent_day_trades.length === 0) {
                        recentTrades.innerHTML = '<div style="color: #666; text-align: center; padding: 10px;">No day trades in rolling 5-day window</div>';
                    } else {
                        let html = '';
                        for (const trade of data.recent_day_trades) {
                            html += `
                                <div style="display: flex; justify-content: space-between; padding: 4px 0; border-bottom: 1px solid #252525;">
                                    <span style="color: #fff; font-weight: 600;">${trade.symbol}</span>
                                    <span style="color: #888;">${trade.date}</span>
                                </div>
                            `;
                        }
                        recentTrades.innerHTML = html;
                    }
                }

                // Also update the account panel day trades info if visible
                const dayTradesInfo = document.getElementById('dayTradesInfo');
                const dayTradesRemaining = document.getElementById('dayTradesRemaining');
                if (dayTradesInfo && !data.is_exempt) {
                    dayTradesInfo.style.display = 'inline';
                    if (dayTradesRemaining) {
                        dayTradesRemaining.textContent = data.day_trades_remaining + '/3';
                        dayTradesRemaining.style.color = data.day_trades_remaining === 0 ? '#ef4444' : data.day_trades_remaining === 1 ? '#f59e0b' : '#22c55e';
                    }
                }

            } catch (error) {
                console.error('Error fetching PDT status:', error);
                const badge = document.getElementById('pdtStatusBadge');
                if (badge) {
                    badge.textContent = 'ERROR';
                    badge.style.color = '#888';
                }
            }
        }

        // Send message to Claude
        async function sendClaudeMessage() {
            const input = document.getElementById('claudeChatInput');
            const messagesDiv = document.getElementById('claudeChatMessages');
            const query = input.value.trim();

            if (!query) return;

            // Add user message
            messagesDiv.innerHTML += `
                <div style="padding: 12px; background: #252525; border-radius: 8px; margin-bottom: 10px; margin-left: 40px;">
                    <div style="font-size: 11px; color: #888; margin-bottom: 4px;">You</div>
                    <div style="color: #e0e0e0; font-size: 14px;">${query}</div>
                </div>
            `;

            input.value = '';
            messagesDiv.scrollTop = messagesDiv.scrollHeight;

            // Add typing indicator
            const typingId = 'typing-' + Date.now();
            messagesDiv.innerHTML += `
                <div id="${typingId}" style="padding: 12px; background: #1e3a5f; border-radius: 8px; margin-bottom: 10px;">
                    <div style="font-size: 11px; color: #60a5fa; margin-bottom: 4px;">ü§ñ Claude AI</div>
                    <div style="color: #888; font-size: 14px;">Thinking...</div>
                </div>
            `;
            messagesDiv.scrollTop = messagesDiv.scrollHeight;

            try {
                const response = await fetch(API_BASE_URL + '/api/claude/query', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        query: query,
                        symbol: currentSymbol,
                        context: 'trading_platform'
                    })
                });

                const data = await response.json();
                const typingEl = document.getElementById(typingId);

                if (data.success && data.data) {
                    typingEl.innerHTML = `
                        <div style="font-size: 11px; color: #60a5fa; margin-bottom: 4px;">ü§ñ Claude AI</div>
                        <div style="color: #e0e0e0; font-size: 14px; line-height: 1.5; white-space: pre-wrap;">${data.data.response || data.data}</div>
                    `;
                } else {
                    typingEl.innerHTML = `
                        <div style="font-size: 11px; color: #60a5fa; margin-bottom: 4px;">ü§ñ Claude AI</div>
                        <div style="color: #e0e0e0; font-size: 14px; line-height: 1.5;">I'm here to help with your trading questions. The AI service may be initializing - please try again in a moment.</div>
                    `;
                }
            } catch (error) {
                const typingEl = document.getElementById(typingId);
                typingEl.innerHTML = `
                    <div style="font-size: 11px; color: #ef4444; margin-bottom: 4px;">‚ö†Ô∏è Error</div>
                    <div style="color: #888; font-size: 14px;">Unable to reach Claude AI. Make sure the server is running.</div>
                `;
            }

            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        // Claude quick actions
        async function claudeQuickAction(action) {
            const input = document.getElementById('claudeChatInput');
            const messagesDiv = document.getElementById('claudeChatMessages');
            const symbol = currentSymbol || 'SPY';

            switch(action) {
                case 'status':
                    // Show live system status directly
                    await showClaudeSystemStatus();
                    return;
                case 'train':
                    addClaudeMessage('user', 'Start model training');
                    addActivityLog('üöÄ Training request initiated');
                    await executeClaudeTraining();
                    return;
                case 'predict':
                    addClaudeMessage('user', `Get AI prediction for ${symbol}`);
                    addActivityLog(`üîÆ Prediction requested for ${symbol}`);
                    await executeClaudePrediction(symbol);
                    return;
                case 'regime':
                    addClaudeMessage('user', 'Check current market regime');
                    addActivityLog('üìà Regime detection running');
                    await executeClaudeRegimeCheck();
                    return;
                case 'drift':
                    addClaudeMessage('user', 'Check for data drift');
                    addActivityLog('üîç Drift check initiated');
                    await executeClaudeDriftCheck();
                    return;
                case 'analyze':
                    input.value = `Analyze ${symbol} - give me key support/resistance levels, trend direction, and trading recommendation`;
                    break;
                case 'sentiment':
                    input.value = `What's the current market sentiment? Any major news affecting ${symbol} or the broader market?`;
                    break;
                case 'strategy':
                    input.value = `What trading strategy would you recommend for ${symbol} in current market conditions?`;
                    break;
                case 'risk':
                    input.value = `Evaluate risk for trading ${symbol} right now. What's my risk/reward if I enter a position?`;
                    break;
            }

            if (input.value) {
                sendClaudeMessage();
            }
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        //               CLAUDE CHAT LIVE SYSTEM MONITORING
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        let claudeStatusInterval = null;

        // Add message to Claude chat
        function addClaudeMessage(type, content, isHtml = false) {
            const messagesDiv = document.getElementById('claudeChatMessages');
            if (!messagesDiv) return;

            const isUser = type === 'user';
            const bgColor = isUser ? '#252525' : '#1e3a5f';
            const marginLeft = isUser ? 'margin-left: 40px;' : '';
            const labelColor = isUser ? '#888' : '#60a5fa';
            const label = isUser ? 'You' : 'ü§ñ Claude AI';

            messagesDiv.innerHTML += `
                <div style="padding: 12px; background: ${bgColor}; border-radius: 8px; margin-bottom: 10px; ${marginLeft}">
                    <div style="font-size: 11px; color: ${labelColor}; margin-bottom: 4px;">${label}</div>
                    <div style="color: #e0e0e0; font-size: 14px; line-height: 1.5; ${isHtml ? '' : 'white-space: pre-wrap;'}">${content}</div>
                </div>
            `;
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        // Add entry to activity log
        function addActivityLog(message) {
            const logDiv = document.getElementById('activityLog');
            if (!logDiv) return;

            const time = new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            const entry = document.createElement('div');
            entry.style.cssText = 'color: #888; padding: 2px 0; border-bottom: 1px solid #1a1a1a;';
            entry.innerHTML = `<span style="color: #555; font-size: 10px;">${time}</span> ${message}`;

            // Keep only last 20 entries
            while (logDiv.children.length > 20) {
                logDiv.removeChild(logDiv.firstChild);
            }

            logDiv.appendChild(entry);
            logDiv.parentElement.scrollTop = logDiv.parentElement.scrollHeight;
        }

        // Update Claude chat live status panel
        async function updateClaudeLiveStatus() {
            try {
                // Update timestamp
                const timeEl = document.getElementById('claudeStatusTime');
                if (timeEl) {
                    timeEl.textContent = new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
                }

                // Fetch model info
                try {
                    const modelRes = await fetch(API_BASE_URL + '/api/ai/model-info');
                    const modelData = await modelRes.json();
                    const modelEl = document.getElementById('claudeModelStatus');
                    if (modelEl) {
                        if (modelData.trained) {
                            modelEl.textContent = `${(modelData.accuracy * 100).toFixed(1)}%`;
                            modelEl.style.color = modelData.accuracy > 0.55 ? '#22c55e' : '#f59e0b';
                        } else {
                            modelEl.textContent = 'Not Trained';
                            modelEl.style.color = '#ef4444';
                        }
                    }
                } catch (e) {
                    const modelEl = document.getElementById('claudeModelStatus');
                    if (modelEl) {
                        modelEl.textContent = '--';
                        modelEl.style.color = '#666';
                    }
                }

                // Fetch regime (if available)
                try {
                    const regimeRes = await fetch(API_BASE_URL + '/api/pipeline/regime/detect');
                    const regimeData = await regimeRes.json();
                    const regimeEl = document.getElementById('claudeRegimeStatus');
                    if (regimeEl && regimeData.success) {
                        const regime = regimeData.data.regime.toUpperCase();
                        regimeEl.textContent = regime;
                        regimeEl.style.color = regime === 'BULL' ? '#22c55e' : regime === 'BEAR' ? '#ef4444' : '#60a5fa';
                    }
                } catch (e) {
                    const regimeEl = document.getElementById('claudeRegimeStatus');
                    if (regimeEl) {
                        regimeEl.textContent = '--';
                        regimeEl.style.color = '#666';
                    }
                }

                // Fetch drift status (if available)
                try {
                    const driftRes = await fetch(API_BASE_URL + '/api/pipeline/drift/summary');
                    const driftData = await driftRes.json();
                    const driftEl = document.getElementById('claudeDriftStatus');
                    if (driftEl && driftData.success) {
                        const hasDrift = driftData.data.should_retrain?.[0] || false;
                        driftEl.textContent = hasDrift ? 'DRIFT!' : 'OK';
                        driftEl.style.color = hasDrift ? '#ef4444' : '#22c55e';
                    }
                } catch (e) {
                    const driftEl = document.getElementById('claudeDriftStatus');
                    if (driftEl) {
                        driftEl.textContent = 'N/A';
                        driftEl.style.color = '#666';
                    }
                }

            } catch (error) {
                console.error('Error updating Claude live status:', error);
            }
        }

        // Show comprehensive system status in chat
        async function showClaudeSystemStatus() {
            addActivityLog('üìä Fetching system status...');

            let statusHtml = '<div style="font-size: 13px;">';
            statusHtml += '<div style="font-weight: 700; color: #60a5fa; margin-bottom: 10px;">üìä SYSTEM STATUS REPORT</div>';

            // Model Status
            try {
                const modelRes = await fetch(API_BASE_URL + '/api/ai/model-info');
                const model = await modelRes.json();
                if (model.trained) {
                    statusHtml += `
                        <div style="background: #161b22; padding: 10px; border-radius: 6px; margin-bottom: 8px;">
                            <div style="color: #22c55e; font-weight: 600;">‚úÖ AI Model: TRAINED</div>
                            <div style="color: #888; font-size: 12px; margin-top: 4px;">
                                Accuracy: <span style="color: #fff;">${(model.accuracy * 100).toFixed(1)}%</span> ‚Ä¢
                                Features: <span style="color: #fff;">${model.num_features}</span> ‚Ä¢
                                Trained: <span style="color: #fff;">${model.training_date || 'Unknown'}</span>
                            </div>
                            <div style="color: #666; font-size: 11px; margin-top: 4px;">Top Features: ${model.top_features?.slice(0, 3).map(f => f.name).join(', ') || 'N/A'}</div>
                        </div>
                    `;
                } else {
                    statusHtml += `
                        <div style="background: #2d1b1b; padding: 10px; border-radius: 6px; margin-bottom: 8px;">
                            <div style="color: #ef4444; font-weight: 600;">‚ùå AI Model: NOT TRAINED</div>
                            <div style="color: #888; font-size: 12px; margin-top: 4px;">Click "Train Model" to start training</div>
                        </div>
                    `;
                }
            } catch (e) {
                statusHtml += `<div style="color: #666; margin-bottom: 8px;">Model status unavailable</div>`;
            }

            // Regime Status
            try {
                const regimeRes = await fetch(API_BASE_URL + '/api/pipeline/regime/detect');
                const regime = await regimeRes.json();
                if (regime.success) {
                    const r = regime.data;
                    const regimeColor = r.regime === 'bull' ? '#22c55e' : r.regime === 'bear' ? '#ef4444' : '#60a5fa';
                    statusHtml += `
                        <div style="background: #161b22; padding: 10px; border-radius: 6px; margin-bottom: 8px;">
                            <div style="color: ${regimeColor}; font-weight: 600;">üìà Market Regime: ${r.regime.toUpperCase()}</div>
                            <div style="color: #888; font-size: 12px; margin-top: 4px;">
                                Confidence: <span style="color: #fff;">${(r.confidence * 100).toFixed(0)}%</span>
                            </div>
                        </div>
                    `;
                }
            } catch (e) {
                statusHtml += `<div style="color: #666; margin-bottom: 8px;">Regime detection not available (advanced pipeline not loaded)</div>`;
            }

            // Connection Status
            try {
                const healthRes = await fetch(API_BASE_URL + '/api/health');
                const health = await healthRes.json();
                statusHtml += `
                    <div style="background: #161b22; padding: 10px; border-radius: 6px; margin-bottom: 8px;">
                        <div style="color: ${health.broker?.connected ? '#22c55e' : '#ef4444'}; font-weight: 600;">
                            ${health.broker?.connected ? '‚úÖ' : '‚ùå'} Alpaca: ${health.broker?.connected ? 'CONNECTED' : 'DISCONNECTED'}
                        </div>
                        <div style="color: #888; font-size: 12px; margin-top: 4px;">
                            Paper Trading: <span style="color: #fff;">${health.broker?.paper_trading ? 'Yes' : 'No'}</span>
                        </div>
                    </div>
                `;
            } catch (e) {
                statusHtml += `<div style="color: #ef4444; margin-bottom: 8px;">‚ùå API Server: NOT RESPONDING</div>`;
            }

            statusHtml += '</div>';
            addClaudeMessage('claude', statusHtml, true);
            addActivityLog('‚úÖ Status report complete');
        }

        // Execute training from Claude chat
        async function executeClaudeTraining() {
            const typingId = 'training-' + Date.now();
            const messagesDiv = document.getElementById('claudeChatMessages');

            messagesDiv.innerHTML += `
                <div id="${typingId}" style="padding: 12px; background: #1e3a5f; border-radius: 8px; margin-bottom: 10px;">
                    <div style="font-size: 11px; color: #60a5fa; margin-bottom: 4px;">ü§ñ Claude AI</div>
                    <div style="color: #f59e0b; font-size: 14px;">‚è≥ Starting multi-symbol training... This takes ~3 minutes.</div>
                </div>
            `;
            messagesDiv.scrollTop = messagesDiv.scrollHeight;

            try {
                const response = await fetch(API_BASE_URL + '/api/ai/train-multi', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        symbols: ['TSLA', 'NVDA', 'AMD', 'META', 'AAPL', 'GOOGL', 'MSFT', 'AMZN', 'PLTR', 'COIN'],
                        test_size: 0.2
                    })
                });

                const data = await response.json();
                const typingEl = document.getElementById(typingId);

                if (data.accuracy) {
                    addActivityLog(`‚úÖ Training complete: ${(data.accuracy * 100).toFixed(1)}% accuracy`);
                    typingEl.innerHTML = `
                        <div style="font-size: 11px; color: #60a5fa; margin-bottom: 4px;">ü§ñ Claude AI</div>
                        <div style="color: #e0e0e0; font-size: 14px; line-height: 1.6;">
                            <div style="color: #22c55e; font-weight: 600; margin-bottom: 8px;">‚úÖ Training Complete!</div>
                            <div style="background: #161b22; padding: 10px; border-radius: 6px;">
                                <div><b>Accuracy:</b> ${(data.accuracy * 100).toFixed(1)}%</div>
                                <div><b>Precision:</b> ${(data.precision * 100).toFixed(1)}%</div>
                                <div><b>Recall:</b> ${(data.recall * 100).toFixed(1)}%</div>
                                <div><b>F1 Score:</b> ${(data.f1 * 100).toFixed(1)}%</div>
                                <div style="margin-top: 6px; font-size: 12px; color: #888;">Training samples: ${data.train_samples || 'N/A'}</div>
                            </div>
                        </div>
                    `;
                    updateClaudeLiveStatus();
                } else {
                    addActivityLog('‚ö†Ô∏è Training returned unexpected response');
                    typingEl.innerHTML = `
                        <div style="font-size: 11px; color: #60a5fa; margin-bottom: 4px;">ü§ñ Claude AI</div>
                        <div style="color: #f59e0b; font-size: 14px;">Training completed but results format unexpected. Check AI Control Panel for details.</div>
                    `;
                }
            } catch (error) {
                addActivityLog('‚ùå Training failed: ' + error.message);
                const typingEl = document.getElementById(typingId);
                typingEl.innerHTML = `
                    <div style="font-size: 11px; color: #ef4444; margin-bottom: 4px;">‚ö†Ô∏è Error</div>
                    <div style="color: #888; font-size: 14px;">Training failed: ${error.message}</div>
                `;
            }
        }

        // Execute prediction from Claude chat
        async function executeClaudePrediction(symbol) {
            try {
                const response = await fetch(API_BASE_URL + '/api/ai/predict', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ symbol: symbol, timeframe: '1Day' })
                });

                const data = await response.json();

                if (data.signal) {
                    const signalColor = data.signal === 'BUY' ? '#22c55e' : data.signal === 'SELL' ? '#ef4444' : '#f59e0b';
                    addActivityLog(`‚úÖ Prediction: ${symbol} ‚Üí ${data.signal}`);

                    const html = `
                        <div style="font-size: 13px;">
                            <div style="font-weight: 700; color: #60a5fa; margin-bottom: 10px;">üîÆ AI PREDICTION: ${symbol}</div>
                            <div style="background: #161b22; padding: 12px; border-radius: 6px; border-left: 4px solid ${signalColor};">
                                <div style="font-size: 20px; font-weight: 700; color: ${signalColor}; margin-bottom: 8px;">${data.signal}</div>
                                <div style="color: #888; font-size: 12px;">
                                    <div>Confidence: <span style="color: #fff;">${(data.confidence * 100).toFixed(1)}%</span></div>
                                    <div>Current Price: <span style="color: #fff;">$${data.current_price?.toFixed(2) || 'N/A'}</span></div>
                                    <div>Expected Move: <span style="color: ${data.expected_return > 0 ? '#22c55e' : '#ef4444'};">${(data.expected_return * 100).toFixed(2)}%</span></div>
                                </div>
                            </div>
                        </div>
                    `;
                    addClaudeMessage('claude', html, true);
                } else {
                    addActivityLog(`‚ö†Ô∏è No prediction available for ${symbol}`);
                    addClaudeMessage('claude', `Unable to generate prediction for ${symbol}. Make sure the model is trained first.`);
                }
            } catch (error) {
                addActivityLog('‚ùå Prediction failed: ' + error.message);
                addClaudeMessage('claude', `Error getting prediction: ${error.message}`);
            }
        }

        // Execute regime check from Claude chat
        async function executeClaudeRegimeCheck() {
            try {
                const response = await fetch(API_BASE_URL + '/api/pipeline/regime/detect');
                const data = await response.json();

                if (data.success) {
                    const r = data.data;
                    const regimeColor = r.regime === 'bull' ? '#22c55e' : r.regime === 'bear' ? '#ef4444' : '#60a5fa';
                    addActivityLog(`‚úÖ Regime: ${r.regime.toUpperCase()} (${(r.confidence * 100).toFixed(0)}%)`);

                    const html = `
                        <div style="font-size: 13px;">
                            <div style="font-weight: 700; color: #60a5fa; margin-bottom: 10px;">üìà MARKET REGIME ANALYSIS</div>
                            <div style="background: #161b22; padding: 12px; border-radius: 6px; border-left: 4px solid ${regimeColor};">
                                <div style="font-size: 18px; font-weight: 700; color: ${regimeColor}; margin-bottom: 8px;">${r.regime.toUpperCase()} MARKET</div>
                                <div style="color: #888; font-size: 12px;">
                                    <div>Confidence: <span style="color: #fff;">${(r.confidence * 100).toFixed(0)}%</span></div>
                                    <div style="margin-top: 6px; color: #666;">
                                        ${r.regime === 'bull' ? 'üí° Strategy: Trend following, momentum plays' :
                                          r.regime === 'bear' ? 'üí° Strategy: Defensive, short opportunities' :
                                          'üí° Strategy: Range trading, mean reversion'}
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    addClaudeMessage('claude', html, true);
                } else {
                    throw new Error(data.message || 'Regime detection failed');
                }
            } catch (error) {
                addActivityLog('‚ö†Ô∏è Regime check unavailable');
                addClaudeMessage('claude', 'Regime detection not available. The advanced pipeline module may not be loaded.');
            }
        }

        // Execute drift check from Claude chat
        async function executeClaudeDriftCheck() {
            try {
                const response = await fetch(API_BASE_URL + '/api/pipeline/drift/summary');
                const data = await response.json();

                if (data.success) {
                    const d = data.data;
                    const hasDrift = d.should_retrain?.[0] || false;
                    addActivityLog(`‚úÖ Drift check: ${hasDrift ? 'DRIFT DETECTED' : 'No drift'}`);

                    const html = `
                        <div style="font-size: 13px;">
                            <div style="font-weight: 700; color: #60a5fa; margin-bottom: 10px;">üîç DATA DRIFT ANALYSIS</div>
                            <div style="background: #161b22; padding: 12px; border-radius: 6px; border-left: 4px solid ${hasDrift ? '#ef4444' : '#22c55e'};">
                                <div style="font-size: 16px; font-weight: 700; color: ${hasDrift ? '#ef4444' : '#22c55e'}; margin-bottom: 8px;">
                                    ${hasDrift ? '‚ö†Ô∏è DRIFT DETECTED - Retraining Recommended' : '‚úÖ NO SIGNIFICANT DRIFT'}
                                </div>
                                <div style="color: #888; font-size: 12px;">
                                    ${hasDrift ?
                                      'Market conditions have changed significantly since last training. Consider retraining the model.' :
                                      'Current market data is consistent with training data. Model should perform as expected.'}
                                </div>
                            </div>
                        </div>
                    `;
                    addClaudeMessage('claude', html, true);
                } else {
                    throw new Error(data.message || 'Drift check failed');
                }
            } catch (error) {
                addActivityLog('‚ö†Ô∏è Drift check unavailable');
                addClaudeMessage('claude', 'Drift detection not available. Set reference data first or ensure advanced pipeline is loaded.');
            }
        }

        // Initialize Claude chat live monitoring when window opens
        function initClaudeLiveMonitoring() {
            // Initial status update
            updateClaudeLiveStatus();
            addActivityLog('üì° System monitor initialized');

            // Set up auto-refresh every 30 seconds
            if (claudeStatusInterval) {
                clearInterval(claudeStatusInterval);
            }
            claudeStatusInterval = setInterval(updateClaudeLiveStatus, 30000);
        }

        // MODELS PERFORMANCE
        async function loadModelsPerformance() {
            const perfDiv = document.getElementById('modelsPerformance');

            try {
                const response = await fetch(API_BASE_URL + '/api/ai/models/performance');
                const data = await response.json();

                if (!data.success || !data.data || !data.data.length) {
                    perfDiv.innerHTML = '<div class="empty-state" style="padding: 20px; font-size: 13px;">No models available yet.<br>Train a model first!</div>';
                    return;
                }

                let html = '';
                for (const model of data.data) {
                    html += `
                        <div style="padding: 10px; margin-bottom: 8px; background: #252525; border-radius: 4px; border-left: 3px solid #60a5fa;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                                <div style="font-size: 14px; font-weight: 700; color: #fff;">${model.name}</div>
                                <div style="font-size: 11px; color: #888;">${model.type}</div>
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; font-size: 11px; margin-bottom: 6px;">
                                <div>
                                    <span style="color: #666;">Accuracy:</span>
                                    <span style="color: #22c55e; font-weight: 600;">${(model.accuracy * 100).toFixed(1)}%</span>
                                </div>
                                <div>
                                    <span style="color: #666;">Win Rate:</span>
                                    <span style="color: #22c55e; font-weight: 600;">${(model.win_rate * 100).toFixed(1)}%</span>
                                </div>
                                <div>
                                    <span style="color: #666;">Sharpe:</span>
                                    <span style="color: #60a5fa; font-weight: 600;">${model.sharpe_ratio.toFixed(2)}</span>
                                </div>
                            </div>
                            <div style="font-size: 10px; color: #666;">Trades: ${model.total_trades} (${model.profitable_trades} profitable) ‚Ä¢ Avg Profit: $${model.avg_profit.toFixed(2)}</div>
                        </div>
                    `;
                }

                perfDiv.innerHTML = html;

            } catch (error) {
                console.error('Error loading models performance:', error);
                perfDiv.innerHTML = '<div class="empty-state" style="padding: 20px; color: #ef4444;">Error loading models</div>';
            }
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        //                     CONNECTION MANAGEMENT
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        async function connectToAlpaca() {
            try {
                const response = await fetch(API_BASE_URL + '/api/alpaca/connect', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                const data = await response.json();

                if (data.status === 'connected' || data.connected) {
                    alert('‚úì Connected to Alpaca successfully!');
                    checkStatus();
                } else {
                    alert('‚úó Failed to connect to Alpaca');
                }
            } catch (error) {
                alert('‚úó Connection error: ' + error.message);
            }
        }

        async function checkStatus() {
            try {
                // Check Alpaca status
                const alpacaResponse = await fetch(API_BASE_URL + '/api/alpaca/status');
                const alpacaData = await alpacaResponse.json();

                console.log('Alpaca Status:', alpacaData);

                const alpacaDot = document.getElementById('alpacaStatus');
                const alpacaText = document.getElementById('alpacaStatusText');

                if (alpacaData && alpacaData.connected) {
                    alpacaDot.classList.add('connected');
                    alpacaText.textContent = 'Connected';
                    apiAvailable = true;
                    console.log('‚úì Alpaca indicator set to CONNECTED');
                } else {
                    alpacaDot.classList.remove('connected');
                    if (apiAvailable === false) {
                        alpacaText.textContent = 'Demo Mode';
                    } else {
                        alpacaText.textContent = 'Disconnected';
                    }
                    console.log('‚úó Alpaca indicator set to DISCONNECTED');
                }

                // Check AI/Claude status
                const healthResponse = await fetch(API_BASE_URL + '/health');
                const healthData = await healthResponse.json();

                console.log('Claude Available:', healthData.claude_available);

                const aiDot = document.getElementById('aiStatus');
                const aiText = document.getElementById('aiStatusText');

                if (healthData && healthData.claude_available) {
                    aiDot.classList.add('connected');
                    aiText.textContent = 'Online';
                    console.log('‚úì AI indicator set to ONLINE');
                } else {
                    aiDot.classList.remove('connected');
                    aiText.textContent = 'Offline';
                    console.log('‚úó AI indicator set to OFFLINE');
                }
            } catch (error) {
                console.error('Status check error:', error);
            }
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        //                     WINDOW LAYOUT MANAGEMENT
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        function createWindow(id, title, content, x, y, width, height) {
            const win = new DraggableWindow(id, title, content, x, y, width, height);
            windows.push(win);
            return win;
        }

        function minimizeWindow(id) {
            windows.find(w => w.id === id)?.minimize();
        }

        function maximizeWindow(id) {
            windows.find(w => w.id === id)?.maximize();
        }

        function closeWindow(id) {
            windows.find(w => w.id === id)?.close();
        }

        function minimizeAll() {
            windows.forEach(w => w.minimize());
        }

        function restoreAll() {
            windows.forEach(w => w.restore());
        }

        function tileWindows() {
            const workspace = document.getElementById('workspace');
            const cols = Math.ceil(Math.sqrt(windows.length));
            const rows = Math.ceil(windows.length / cols);
            const width = Math.floor(workspace.clientWidth / cols);
            const height = Math.floor(workspace.clientHeight / rows);

            windows.forEach((win, i) => {
                win.x = (i % cols) * width;
                win.y = Math.floor(i / cols) * height;
                win.width = width - 4;
                win.height = height - 4;
                win.updatePosition();
                win.restore();
            });
        }

        function cascadeWindows() {
            windows.forEach((win, i) => {
                win.x = i * 35;
                win.y = i * 35;
                win.width = 600;
                win.height = 450;
                win.updatePosition();
                win.restore();
            });
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        //                     CONFIGURATION MANAGEMENT SYSTEM
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        function getAllConfigurations() {
            const configs = localStorage.getItem('dashboardConfigurations');
            return configs ? JSON.parse(configs) : {};
        }

        function saveAllConfigurations(configs) {
            localStorage.setItem('dashboardConfigurations', JSON.stringify(configs));
        }

        function showSaveConfigDialog() {
            document.getElementById('configNameInput').value = '';
            document.getElementById('saveConfigDialog').classList.add('show');

            const input = document.getElementById('configNameInput');
            input.focus();

            // Add Enter key handler
            input.onkeypress = function(e) {
                if (e.key === 'Enter') {
                    saveConfiguration();
                }
            };

            // Close the dropdown
            document.querySelectorAll('.dropdown').forEach(d => d.classList.remove('show'));
        }

        function closeSaveConfigDialog() {
            document.getElementById('saveConfigDialog').classList.remove('show');
        }

        function saveConfiguration() {
            const name = document.getElementById('configNameInput').value.trim();

            if (!name) {
                alert('Please enter a configuration name.');
                return;
            }

            const configs = getAllConfigurations();

            if (configs[name]) {
                if (!confirm(`Configuration "${name}" already exists. Overwrite it?`)) {
                    return;
                }
            }

            const layout = windows.map(w => ({
                id: w.id,
                title: w.title,
                x: w.x,
                y: w.y,
                width: w.width,
                height: w.height,
                minimized: w.minimized
            }));

            configs[name] = {
                windows: layout,
                watchlist: [...watchlist],
                timestamp: new Date().toISOString()
            };

            saveAllConfigurations(configs);
            closeSaveConfigDialog();
            updateSavedConfigsList();

            console.log(`‚úì Configuration "${name}" saved with ${layout.length} windows`);
            alert(`‚úì Configuration "${name}" saved successfully!`);
        }

        function setAsDefaultLayout() {
            // Save current window layout as the startup default
            const layout = windows.map(w => ({
                id: w.id,
                title: w.title,
                x: w.x,
                y: w.y,
                width: w.width,
                height: w.height,
                minimized: w.minimized
            }));

            const defaultConfig = {
                windows: layout,
                watchlist: [...watchlist],
                currentSymbol: currentSymbol,
                timestamp: new Date().toISOString()
            };

            // Save to localStorage as the startup default
            localStorage.setItem('startupDefaultLayout', JSON.stringify(defaultConfig));

            console.log(`‚úì Startup default set with ${layout.length} windows`);
            alert('‚úì Current layout saved as startup default!\n\nThis layout will load automatically when you open the dashboard.');
        }

        function loadStartupDefaultLayout() {
            const saved = localStorage.getItem('startupDefaultLayout');
            if (!saved) return false;

            try {
                const config = JSON.parse(saved);
                console.log('Loading startup default layout with', config.windows.length, 'windows');

                // Restore watchlist
                if (config.watchlist) {
                    watchlist = [...config.watchlist];
                    localStorage.setItem('watchlist', JSON.stringify(watchlist));
                }

                // Restore current symbol
                if (config.currentSymbol) {
                    currentSymbol = config.currentSymbol;
                }

                // Restore windows
                config.windows.forEach(w => {
                    // Handle chart templates specially - they need the function call
                    let template;
                    if (w.id.startsWith('chart')) {
                        const chartId = w.id.replace('chart', '');
                        template = windowTemplates.chart(chartId);
                    } else {
                        template = windowTemplates[w.id] || '';
                    }

                    createWindow(w.id, w.title, template, w.x, w.y, w.width, w.height);
                    if (w.minimized) {
                        const window = windows.find(win => win.id === w.id);
                        if (window) window.minimize();
                    }
                });

                // Initialize charts after windows are created
                setTimeout(() => {
                    windows.forEach(win => {
                        if (win.id.startsWith('chart')) {
                            const chartId = win.id.replace('chart', '');
                            initChart(chartId, currentSymbol);
                        }
                    });
                }, 500);

                return true;
            } catch (e) {
                console.error('Failed to load startup default layout:', e);
                return false;
            }
        }

        function loadConfiguration(name) {
            const configs = getAllConfigurations();
            const config = configs[name];

            if (!config) {
                alert(`Configuration "${name}" not found.`);
                return;
            }

            console.log(`Loading configuration: ${name}`);

            // Close all current windows
            windows.forEach(w => w.close());
            windows = [];

            // Restore watchlist
            if (config.watchlist) {
                watchlist = [...config.watchlist];
                localStorage.setItem('watchlist', JSON.stringify(watchlist));
            }

            // Restore windows
            config.windows.forEach(w => {
                // Handle chart templates specially - they need the function call
                let template;
                if (w.id.startsWith('chart')) {
                    const chartId = w.id.replace('chart', '');
                    template = windowTemplates.chart(chartId);
                } else {
                    template = windowTemplates[w.id] || '';
                }

                createWindow(w.id, w.title, template, w.x, w.y, w.width, w.height);
                if (w.minimized) {
                    const window = windows.find(win => win.id === w.id);
                    if (window) window.minimize();
                }
            });

            // Refresh data
            setTimeout(() => {
                loadPrice();
                loadLevel2();
                loadTimeSales();
                loadPositions();
                loadOrders();
                loadAccount();
                loadWorklist();

                // Initialize charts
                windows.forEach(win => {
                    if (win.id.startsWith('chart')) {
                        const chartId = win.id.replace('chart', '');
                        initChart(chartId, currentSymbol);
                    }
                });
            }, 1000);

            // Close dropdown
            document.querySelectorAll('.dropdown').forEach(d => d.classList.remove('show'));

            console.log(`‚úì Configuration "${name}" loaded`);
        }

        function deleteConfiguration(name) {
            if (!confirm(`Delete configuration "${name}"?`)) {
                return;
            }

            const configs = getAllConfigurations();
            delete configs[name];
            saveAllConfigurations(configs);
            updateSavedConfigsList();
            updateManageConfigsList();

            console.log(`‚úó Configuration "${name}" deleted`);
            alert(`‚úì Configuration "${name}" deleted.`);
        }

        function renameConfiguration(oldName) {
            const newName = prompt(`Rename configuration "${oldName}" to:`, oldName);

            if (!newName || newName === oldName) {
                return;
            }

            const configs = getAllConfigurations();

            if (configs[newName]) {
                alert(`Configuration "${newName}" already exists.`);
                return;
            }

            configs[newName] = configs[oldName];
            configs[newName].timestamp = new Date().toISOString();
            delete configs[oldName];

            saveAllConfigurations(configs);
            updateSavedConfigsList();
            updateManageConfigsList();

            console.log(`‚úì Configuration renamed: "${oldName}" ‚Üí "${newName}"`);
            alert(`‚úì Configuration renamed to "${newName}".`);
        }

        function updateSavedConfigsList() {
            const configs = getAllConfigurations();
            const configNames = Object.keys(configs).sort();
            const listDiv = document.getElementById('savedConfigsList');

            if (configNames.length === 0) {
                listDiv.innerHTML = '<div style="padding: 10px; text-align: center; color: #666; font-size: 13px;">No saved configurations</div>';
                return;
            }

            let html = '';
            configNames.forEach(name => {
                const config = configs[name];
                const date = new Date(config.timestamp).toLocaleDateString();
                const windowCount = config.windows.length;

                html += `
                    <a href="#" onclick="event.preventDefault(); loadConfiguration('${name.replace(/'/g, "\\'")}')">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span>${name}</span>
                            <span style="font-size: 11px; color: #666;">${windowCount} windows</span>
                        </div>
                    </a>
                `;
            });

            listDiv.innerHTML = html;
        }

        function showManageConfigsDialog() {
            updateManageConfigsList();
            document.getElementById('manageConfigsDialog').classList.add('show');
            // Close the dropdown
            document.querySelectorAll('.dropdown').forEach(d => d.classList.remove('show'));
        }

        function closeManageConfigsDialog() {
            document.getElementById('manageConfigsDialog').classList.remove('show');
        }

        function updateManageConfigsList() {
            const configs = getAllConfigurations();
            const configNames = Object.keys(configs).sort();
            const listDiv = document.getElementById('manageConfigsList');
            const noConfigsMsg = document.getElementById('noConfigsMessage');

            if (configNames.length === 0) {
                listDiv.style.display = 'none';
                noConfigsMsg.style.display = 'block';
                return;
            }

            listDiv.style.display = 'block';
            noConfigsMsg.style.display = 'none';

            let html = '';
            configNames.forEach(name => {
                const config = configs[name];
                const date = new Date(config.timestamp).toLocaleString();
                const windowCount = config.windows.length;
                const watchlistCount = config.watchlist ? config.watchlist.length : 0;

                html += `
                    <div class="config-list-item">
                        <div>
                            <div class="config-list-item-name">${name}</div>
                            <div class="config-list-item-date">
                                ${date} ‚Ä¢ ${windowCount} windows ‚Ä¢ ${watchlistCount} symbols
                            </div>
                        </div>
                        <div class="config-list-item-actions">
                            <button class="config-btn-small config-btn-load" onclick="loadConfiguration('${name.replace(/'/g, "\\'")}'); closeManageConfigsDialog();">
                                üìÇ Load
                            </button>
                            <button class="config-btn-small config-btn-rename" onclick="renameConfiguration('${name.replace(/'/g, "\\'")}')">
                                ‚úèÔ∏è Rename
                            </button>
                            <button class="config-btn-small config-btn-delete" onclick="deleteConfiguration('${name.replace(/'/g, "\\'")}')">
                                üóëÔ∏è Delete
                            </button>
                        </div>
                    </div>
                `;
            });

            listDiv.innerHTML = html;
        }

        // Legacy function - kept for backward compatibility
        function saveAsCustomLayout() {
            showSaveConfigDialog();
        }

        function saveCurrentLayout() {
            showSaveConfigDialog();
        }

        // Open a new dashboard instance with isolated storage
        function openNewDashboardInstance() {
            const instanceId = 'dashboard_' + Date.now();
            const url = new URL(window.location.href);
            url.searchParams.set('instance', instanceId);
            window.open(url.toString(), '_blank', 'width=1600,height=900');
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        //                     MULTI-CHART MANAGEMENT
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        function getTimeframeName(interval) {
            const names = {
                '1': '1min',
                '5': '5min',
                '15': '15min',
                '30': '30min',
                '60': '1h',
                '240': '4h',
                'D': 'Daily',
                'W': 'Weekly',
                'M': 'Monthly'
            };
            return names[interval] || interval;
        }

        function addChart(templateName = 'default', customInterval = null, style = '1') {
            chartCounter++;
            const chartId = `chart${chartCounter}`;

            // Get template info for title
            const allTemplates = getAllChartTemplates();
            const template = allTemplates[templateName] || CHART_PRESETS['default'];
            const interval = customInterval || template.interval || '5';
            const timeframeName = getTimeframeName(interval);
            const title = `CHART ${chartCounter} - ${currentSymbol} (${template.name})`;

            // Calculate position (cascade new charts)
            const baseX = 300 + (chartCounter - 1) * 30;
            const baseY = 100 + (chartCounter - 1) * 30;

            // Create chart window
            const chartWindow = createWindow(
                chartId,
                title,
                windowTemplates.chart(chartCounter),
                baseX,
                baseY,
                700,
                500
            );

            // Initialize TradingView chart after a short delay
            setTimeout(() => {
                // If custom interval provided, create modified template
                if (customInterval) {
                    const modifiedTemplate = { ...template, interval: customInterval, style: style };
                    // Temporarily store in custom templates
                    const customKey = `custom_${chartCounter}`;
                    const customTemplates = getSavedChartTemplates();
                    customTemplates[customKey] = modifiedTemplate;
                    localStorage.setItem('customChartTemplates', JSON.stringify(customTemplates));
                    initChart(chartCounter.toString(), currentSymbol, customKey);
                } else {
                    initChart(chartCounter.toString(), currentSymbol, templateName);
                }
            }, 500);

            // Close dropdown
            document.querySelectorAll('.dropdown').forEach(d => d.classList.remove('show'));

            console.log(`‚úì Added chart ${chartCounter} with template "${template.name}" (${timeframeName})`);
        }

        // Add chart using the user's default template for that timeframe
        function addChartWithDefault(interval) {
            // Check if user has set a default template for this timeframe
            const defaultTemplate = getDefaultTemplateForTimeframe(interval);

            if (defaultTemplate) {
                // Use the user's custom default
                addChart(defaultTemplate);
            } else {
                // Find a built-in template that matches this interval, or use default
                let templateName = 'default';
                for (const [key, preset] of Object.entries(CHART_PRESETS)) {
                    if (preset.interval === interval) {
                        templateName = key;
                        break;
                    }
                }
                addChart(templateName, interval);
            }
        }

        function showAddChartDialog() {
            document.getElementById('chartSymbolPreview').textContent = currentSymbol;
            document.getElementById('chartTemplate').value = 'default';
            document.getElementById('chartTimeframe').value = '';
            updateTemplateDescription();
            document.getElementById('addChartDialog').classList.add('show');
            // Close the dropdown
            document.querySelectorAll('.dropdown').forEach(d => d.classList.remove('show'));
        }

        function closeAddChartDialog() {
            document.getElementById('addChartDialog').classList.remove('show');
        }

        function updateTemplateDescription() {
            const templateName = document.getElementById('chartTemplate').value;
            const allTemplates = getAllChartTemplates();
            const template = allTemplates[templateName] || CHART_PRESETS['default'];

            const detailsDiv = document.getElementById('templateDetails');
            if (detailsDiv) {
                const timeframeName = getTimeframeName(template.interval);
                const studiesText = template.studies.length > 0
                    ? template.studies.map(s => s.split('@')[0]).join(', ')
                    : 'No indicators';
                detailsDiv.textContent = `${template.description} on ${timeframeName} timeframe`;
            }
        }

        function createCustomChart() {
            const templateName = document.getElementById('chartTemplate').value;
            const customInterval = document.getElementById('chartTimeframe').value || null;
            const style = document.getElementById('chartStyle').value;

            addChart(templateName, customInterval, style);
            closeAddChartDialog();
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        //                     TRADINGVIEW DESKTOP INTEGRATION
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        /**
         * Open a symbol directly in TradingView Desktop with specific timeframe
         * TradingView Desktop uses the tradingview:// protocol
         */
        function openTVDesktop(symbol, interval = 'D') {
            // Build the TradingView Desktop URL
            const exchange = getExchangeForSymbol(symbol);
            const tvSymbol = `${exchange}:${symbol}`;

            // TradingView Desktop protocol URL
            const tvDesktopUrl = `tradingview://chart?symbol=${tvSymbol}&interval=${interval}`;

            // Also build web fallback URL
            const tvWebUrl = `https://www.tradingview.com/chart/?symbol=${tvSymbol}&interval=${interval}`;

            console.log(`Opening ${tvSymbol} (${interval}) in TradingView Desktop...`);

            // Try to open via protocol handler using window.location
            // This is the most reliable way to trigger desktop app protocols
            try {
                window.location.href = tvDesktopUrl;
                showNotification(`Opening ${symbol} (${getIntervalName(interval)}) in TradingView Desktop...`, 'info');
            } catch (e) {
                // Fallback to web
                console.log('Desktop protocol failed, opening web version...');
                window.open(tvWebUrl, '_blank');
            }

            // Close dropdown
            document.querySelectorAll('.dropdown').forEach(d => d.classList.remove('show'));
        }

        /**
         * Get the exchange prefix for a symbol (for TradingView)
         */
        function getExchangeForSymbol(symbol) {
            const sym = symbol.toUpperCase();

            // ETFs typically on AMEX/NYSE Arca
            const amexSymbols = ['SPY', 'QQQ', 'DIA', 'IWM', 'XLF', 'XLE', 'XLK', 'XLV', 'GLD', 'SLV', 'TLT', 'VXX', 'UVXY', 'SQQQ', 'TQQQ'];
            if (amexSymbols.includes(sym)) return 'AMEX';

            // Major NYSE stocks
            const nyseSymbols = ['JPM', 'BAC', 'WFC', 'C', 'GS', 'MS', 'V', 'MA', 'DIS', 'KO', 'PEP', 'WMT', 'HD', 'MCD', 'NKE', 'BA', 'CAT', 'GE', 'MMM', 'IBM', 'JNJ', 'PFE', 'MRK', 'UNH', 'CVX', 'XOM'];
            if (nyseSymbols.includes(sym)) return 'NYSE';

            // Default to NASDAQ for tech stocks
            return 'NASDAQ';
        }

        /**
         * Get human-readable interval name
         */
        function getIntervalName(interval) {
            const names = {
                '1': '1 Minute',
                '5': '5 Minutes',
                '15': '15 Minutes',
                '30': '30 Minutes',
                '60': '1 Hour',
                '240': '4 Hours',
                'D': 'Daily',
                'W': 'Weekly',
                'M': 'Monthly'
            };
            return names[interval] || interval;
        }

        /**
         * Open all watchlist symbols in TradingView Desktop
         */
        function openTVDesktopMulti() {
            const symbols = getCurrentWatchlistSymbols();

            if (symbols.length === 0) {
                showNotification('No symbols in watchlist to open.', 'warning');
                return;
            }

            if (symbols.length > 8) {
                if (!confirm(`This will open ${symbols.length} charts. TradingView Desktop works best with up to 8 charts.\n\nContinue with first 8 symbols?`)) {
                    return;
                }
                symbols.length = 8; // Limit to 8
            }

            // Open each symbol with a delay to prevent overwhelming
            symbols.forEach((symbol, index) => {
                setTimeout(() => {
                    openTVDesktop(symbol, 'D');
                }, index * 1000); // 1 second delay between each
            });

            showNotification(`Opening ${symbols.length} charts in TradingView Desktop...`, 'info');

            // Close dropdown
            document.querySelectorAll('.dropdown').forEach(d => d.classList.remove('show'));
        }

        /**
         * Get current watchlist symbols
         */
        function getCurrentWatchlistSymbols() {
            const watchlistBody = document.getElementById('watchlist-body');
            if (!watchlistBody) return [];

            const symbols = [];
            watchlistBody.querySelectorAll('tr').forEach(row => {
                const symbolCell = row.querySelector('td:first-child');
                if (symbolCell) {
                    const sym = symbolCell.textContent.trim();
                    if (sym && sym.length > 0 && sym.length <= 5) {
                        symbols.push(sym);
                    }
                }
            });
            return symbols;
        }

        /**
         * Show help dialog for TradingView Desktop integration
         */
        function showTVDesktopHelp() {
            const helpHtml = `
                <div style="text-align: left; line-height: 1.8;">
                    <h3 style="color: #2563eb; margin-bottom: 15px;">üñ•Ô∏è TradingView Desktop Integration</h3>

                    <p><strong>Why use TradingView Desktop?</strong></p>
                    <ul style="margin-left: 20px; margin-bottom: 15px;">
                        <li><span style="color: #22c55e;">‚úì</span> Unlimited indicators (no 2-indicator limit!)</li>
                        <li><span style="color: #22c55e;">‚úì</span> Your custom templates & saved layouts</li>
                        <li><span style="color: #22c55e;">‚úì</span> Multi-monitor support</li>
                        <li><span style="color: #22c55e;">‚úì</span> Faster performance</li>
                    </ul>

                    <p><strong>How to use:</strong></p>
                    <ol style="margin-left: 20px; margin-bottom: 15px;">
                        <li>Install TradingView Desktop (link below)</li>
                        <li>Set up your chart templates in TV Desktop</li>
                        <li>Click any timeframe in the TV DESKTOP menu</li>
                        <li>Chart opens with your saved template!</li>
                    </ol>

                    <p><strong>Pro Tips:</strong></p>
                    <ul style="margin-left: 20px; margin-bottom: 15px;">
                        <li>Create templates for each timeframe (1m Scalping, 5m Day Trading, etc.)</li>
                        <li>Right-click chart ‚Üí "Save chart layout as..." to save your setup</li>
                        <li>Use "Apply template" to quickly switch indicator sets</li>
                    </ul>

                    <div style="margin-top: 20px; padding: 15px; background: #1e3a5f; border-radius: 5px;">
                        <strong>üì• Download TradingView Desktop:</strong><br>
                        <a href="https://www.tradingview.com/desktop/" target="_blank"
                           style="color: #60a5fa; text-decoration: underline; font-size: 16px;">
                            www.tradingview.com/desktop
                        </a>
                    </div>
                </div>
            `;

            showGenericDialog('TradingView Desktop Help', helpHtml);

            // Close dropdown
            document.querySelectorAll('.dropdown').forEach(d => d.classList.remove('show'));
        }

        /**
         * Show a generic dialog with custom content
         */
        function showGenericDialog(title, contentHtml) {
            // Create overlay if it doesn't exist
            let overlay = document.getElementById('genericDialogOverlay');
            if (!overlay) {
                overlay = document.createElement('div');
                overlay.id = 'genericDialogOverlay';
                overlay.className = 'config-dialog-overlay';
                overlay.innerHTML = `
                    <div class="config-dialog" style="max-width: 550px;">
                        <div class="config-dialog-header" id="genericDialogTitle"></div>
                        <div class="config-dialog-body" id="genericDialogContent"></div>
                        <div class="config-dialog-footer">
                            <button class="action-btn" onclick="closeGenericDialog()">Close</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(overlay);
            }

            document.getElementById('genericDialogTitle').textContent = title;
            document.getElementById('genericDialogContent').innerHTML = contentHtml;
            overlay.classList.add('show');
        }

        function closeGenericDialog() {
            const overlay = document.getElementById('genericDialogOverlay');
            if (overlay) overlay.classList.remove('show');
        }

        // Legacy function - redirect to new function
        async function openInTradingView(symbol) {
            openTVDesktop(symbol, 'D');
        }

        function copySymbolToClipboard() {
            const exchange = getExchangeForSymbol(currentSymbol);
            const fullSymbol = `${exchange}:${currentSymbol}`;

            navigator.clipboard.writeText(fullSymbol).then(() => {
                showNotification(`‚úì ${fullSymbol} copied to clipboard!`, 'success');
                console.log(`Copied ${fullSymbol} to clipboard`);
            }).catch(err => {
                // Fallback - just copy symbol without exchange
                navigator.clipboard.writeText(currentSymbol).then(() => {
                    showNotification(`‚úì ${currentSymbol} copied to clipboard!`, 'success');
                });
            });

            // Close dropdown
            document.querySelectorAll('.dropdown').forEach(d => d.classList.remove('show'));
        }

        function showWebhookInfo() {
            document.getElementById('webhookInfoDialog').classList.add('show');
            // Close the dropdown
            document.querySelectorAll('.dropdown').forEach(d => d.classList.remove('show'));
        }

        function closeWebhookInfoDialog() {
            document.getElementById('webhookInfoDialog').classList.remove('show');
        }

        function copyWebhookUrl() {
            const url = document.getElementById('webhookUrl').value;
            navigator.clipboard.writeText(url).then(() => {
                alert('‚úì Webhook URL copied to clipboard!');
            });
        }

        async function showWebhookLogs() {
            document.getElementById('webhookLogsDialog').classList.add('show');
            await refreshWebhookLogs();
            // Close the dropdown
            document.querySelectorAll('.dropdown').forEach(d => d.classList.remove('show'));
        }

        function closeWebhookLogsDialog() {
            document.getElementById('webhookLogsDialog').classList.remove('show');
        }

        async function refreshWebhookLogs() {
            try {
                const response = await fetch(API_BASE_URL + '/api/tradingview/webhook-logs');
                const data = await response.json();

                const logsList = document.getElementById('webhookLogsList');

                if (data.logs && data.logs.length > 0) {
                    let html = '';
                    data.logs.reverse().forEach(log => {
                        const timestamp = new Date(log.timestamp).toLocaleString();
                        const typeColor = log.type === 'incoming' ? '#22c55e' :
                                         log.type === 'error' ? '#ef4444' : '#60a5fa';

                        html += `
                            <div style="margin-bottom: 10px; padding: 10px; background: #1a1a1a; border-left: 3px solid ${typeColor}; border-radius: 3px;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                    <span style="color: ${typeColor}; font-weight: 700;">${log.type.toUpperCase()}</span>
                                    <span style="color: #666;">${timestamp}</span>
                                </div>
                                <pre style="margin: 0; color: #aaa; font-size: 11px; white-space: pre-wrap;">${JSON.stringify(log.data, null, 2)}</pre>
                            </div>
                        `;
                    });
                    logsList.innerHTML = html;
                } else {
                    logsList.innerHTML = '<div style="text-align: center; padding: 40px; color: #666;">No webhook activity yet.<br><small>Set up alerts in TradingView to see activity here.</small></div>';
                }
            } catch (error) {
                console.error('Error loading webhook logs:', error);
                document.getElementById('webhookLogsList').innerHTML = '<div style="text-align: center; padding: 40px; color: #ef4444;">Error loading logs</div>';
            }
        }

        async function clearWebhookLogs() {
            if (!confirm('Clear all webhook logs?')) {
                return;
            }

            try {
                await fetch(API_BASE_URL + '/api/tradingview/webhook-logs', {
                    method: 'DELETE'
                });
                alert('‚úì Webhook logs cleared');
                await refreshWebhookLogs();
            } catch (error) {
                console.error('Error clearing logs:', error);
                alert('Error clearing logs');
            }
        }

        async function testWebhook() {
            try {
                const response = await fetch(API_BASE_URL + '/api/tradingview/test-webhook', {
                    method: 'POST'
                });
                const data = await response.json();

                if (data.success) {
                    alert('‚úì Test webhook received successfully!\n\nCheck "View Webhook Logs" to see the test alert.');
                    console.log('Test webhook response:', data);
                } else {
                    alert('‚úó Test webhook failed');
                }
            } catch (error) {
                console.error('Error testing webhook:', error);
                alert('‚úó Error testing webhook: ' + error.message);
            }

            // Close dropdown
            document.querySelectorAll('.dropdown').forEach(d => d.classList.remove('show'));
        }

        function exportWatchlist() {
            // Export watchlist in TradingView format
            const tvWatchlist = watchlist.join(',');
            const blob = new Blob([tvWatchlist], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'tradingview_watchlist.txt';
            a.click();
            URL.revokeObjectURL(url);

            alert('‚úì Watchlist exported!\n\nYou can import this in TradingView Desktop.');
            console.log('Exported watchlist:', tvWatchlist);

            // Close dropdown
            document.querySelectorAll('.dropdown').forEach(d => d.classList.remove('show'));
        }

        function showSetupGuide() {
            // Open setup guide in new window
            window.open('TRADINGVIEW_SETUP_GUIDE.html', '_blank');

            // Close dropdown
            document.querySelectorAll('.dropdown').forEach(d => d.classList.remove('show'));
        }

        function openTradingViewSetupGuide() {
            window.open('TRADINGVIEW_SETUP_GUIDE.html', '_blank');
        }

        // Auto-submit setting functions
        function saveAutoSubmitSetting(enabled) {
            localStorage.setItem('autoSubmitOrders', enabled ? 'true' : 'false');
            console.log('Auto-submit orders:', enabled ? 'ENABLED' : 'DISABLED');
        }

        function loadAutoSubmitSetting() {
            const saved = localStorage.getItem('autoSubmitOrders');
            const checkbox = document.getElementById('autoSubmitOrders');
            if (checkbox && saved === 'true') {
                checkbox.checked = true;
            }
        }

        function loadLayout(name) {
            windows.forEach(w => w.close());
            windows = [];

            if (name === 'custom') {
                loadCustomLayout();
            }
            else if (name === 'default') loadDefaultLayout();
            else if (name === 'trading') loadTradingLayout();
            else if (name === 'analysis') loadAnalysisLayout();
            else if (name === 'scalping') loadScalpingLayout();

            setTimeout(() => {
                loadPrice();
                loadLevel2();
                loadTimeSales();
                loadPositions();
                loadOrders();
                loadAccount();
                loadWorklist();

                // Initialize any charts that were created
                windows.forEach(win => {
                    if (win.id.startsWith('chart')) {
                        const chartId = win.id.replace('chart', '');
                        initChart(chartId, currentSymbol);
                    }
                });
            }, 1000);
        }

        function loadDefaultLayout() {
            createWindow('watchlist', 'WATCHLIST', windowTemplates.watchlist, 10, 10, 250, 400);
            createWindow('account', 'ACCOUNT', windowTemplates.account, 10, 420, 250, 280);
            createWindow('quote', `QUOTE - ${currentSymbol}`, windowTemplates.quote, 270, 10, 450, 180);
            createWindow('level2', `LEVEL II - ${currentSymbol}`, windowTemplates.level2, 270, 200, 450, 500);
            createWindow('timesales', 'TIME & SALES', windowTemplates.timesales, 730, 10, 280, 400);
            createWindow('order', 'ORDER ENTRY', windowTemplates.order, 730, 420, 280, 280);
            createWindow('chart1', `CHART - ${currentSymbol}`, windowTemplates.chart('1'), 1020, 10, 600, 400);
            createWindow('positions', 'POSITIONS', windowTemplates.positions, 1020, 420, 600, 140);
            createWindow('orders', 'ORDERS', windowTemplates.orders, 1020, 570, 600, 150);
        }

        function loadTradingLayout() {
            createWindow('quote', `QUOTE - ${currentSymbol}`, windowTemplates.quote, 10, 10, 400, 120);
            createWindow('level2', `LEVEL II - ${currentSymbol}`, windowTemplates.level2, 10, 140, 400, 560);
            createWindow('timesales', 'TIME & SALES', windowTemplates.timesales, 420, 10, 280, 400);
            createWindow('order', 'ORDER ENTRY', windowTemplates.order, 420, 420, 280, 280);
            createWindow('chart1', `CHART - ${currentSymbol}`, windowTemplates.chart('1'), 710, 10, 600, 500);
            createWindow('positions', 'POSITIONS', windowTemplates.positions, 710, 520, 600, 90);
            createWindow('orders', 'ORDERS', windowTemplates.orders, 710, 620, 600, 100);
            createWindow('watchlist', 'WATCHLIST', windowTemplates.watchlist, 1320, 10, 280, 400);
            createWindow('account', 'ACCOUNT', windowTemplates.account, 1320, 420, 280, 280);
        }

        function loadAnalysisLayout() {
            createWindow('chart1', `CHART 1 - ${currentSymbol}`, windowTemplates.chart('1'), 10, 10, 800, 450);
            createWindow('chart2', `CHART 2 - ${currentSymbol}`, windowTemplates.chart('2'), 820, 10, 800, 450);
            createWindow('watchlist', 'WATCHLIST', windowTemplates.watchlist, 10, 470, 250, 400);
            createWindow('level2', `LEVEL II - ${currentSymbol}`, windowTemplates.level2, 270, 470, 400, 400);
            createWindow('timesales', 'TIME & SALES', windowTemplates.timesales, 680, 470, 300, 400);
            createWindow('ai', 'AI ANALYSIS', windowTemplates.ai, 990, 470, 360, 200);
            createWindow('bot', 'BOT CONTROL', windowTemplates.bot, 990, 680, 360, 190);
            createWindow('account', 'ACCOUNT', windowTemplates.account, 1360, 470, 260, 200);
            createWindow('order', 'ORDER ENTRY', windowTemplates.order, 1360, 680, 260, 190);
        }

        function loadScalpingLayout() {
            createWindow('quote', `QUOTE - ${currentSymbol}`, windowTemplates.quote, 10, 10, 300, 120);
            createWindow('level2', `LEVEL II - ${currentSymbol}`, windowTemplates.level2, 10, 140, 400, 560);
            createWindow('order', 'ORDER ENTRY', windowTemplates.order, 420, 10, 280, 350);
            createWindow('timesales', 'TIME & SALES', windowTemplates.timesales, 420, 370, 280, 330);
            createWindow('chart1', `CHART - ${currentSymbol}`, windowTemplates.chart('1'), 710, 10, 700, 500);
            createWindow('positions', 'POSITIONS', windowTemplates.positions, 710, 520, 700, 90);
            createWindow('orders', 'ORDERS', windowTemplates.orders, 710, 620, 700, 100);
            createWindow('watchlist', 'WATCHLIST', windowTemplates.watchlist, 1420, 10, 200, 400);
            createWindow('account', 'ACCOUNT', windowTemplates.account, 1420, 420, 200, 280);
        }

        function loadCustomLayout() {
            const savedLayout = localStorage.getItem('customLayout');
            if (savedLayout) {
                try {
                    const layout = JSON.parse(savedLayout);
                    console.log('Loading custom layout with', layout.length, 'windows');
                    layout.forEach(w => {
                        // Handle chart templates specially - they need the function call
                        let template;
                        if (w.id.startsWith('chart')) {
                            const chartId = w.id.replace('chart', '');
                            template = windowTemplates.chart(chartId);
                        } else {
                            template = windowTemplates[w.id] || '';
                        }

                        createWindow(w.id, w.title, template, w.x, w.y, w.width, w.height);
                        if (w.minimized) {
                            const window = windows.find(win => win.id === w.id);
                            if (window) window.minimize();
                        }
                    });

                    // Initialize charts after windows are created
                    setTimeout(() => {
                        windows.forEach(win => {
                            if (win.id.startsWith('chart')) {
                                const chartId = win.id.replace('chart', '');
                                initChart(chartId, currentSymbol);
                            }
                        });
                    }, 500);
                } catch (e) {
                    console.error('Failed to load custom layout:', e);
                    alert('Failed to load custom layout. Loading default instead.');
                    loadDefaultLayout();
                }
            } else {
                alert('No custom layout saved.\n\nArrange windows and click "üíæ Save as Custom" to create one.');
                loadDefaultLayout();
            }
        }

        function resetLayout() {
            if (confirm('Reset to default layout?')) {
                localStorage.removeItem('tradingLayout');
                loadLayout('default');
            }
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        //                     INITIALIZATION
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        // TradingView Chart Management
        let chartWidgets = {};
        let chartInstances = {};
        let chartCounter = 0; // Track number of charts created
        let chartLinkStatus = {}; // Track which charts are linked to current symbol
        let chartSymbols = {}; // Track each chart's current symbol
        let chartTemplates = {}; // Track which template each chart uses

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // CHART TEMPLATES - Predefined indicator sets for different trading styles
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        const CHART_PRESETS = {
            'default': {
                name: 'Default',
                interval: '5',
                style: '1', // Candles
                studies: ['MASimple@tv-basicstudies', 'RSI@tv-basicstudies'],
                description: 'SMA + RSI'
            },
            'scalping': {
                name: 'Scalping (1m)',
                interval: '1',
                style: '1',
                studies: [
                    'MAExp@tv-basicstudies',      // EMA
                    'VWAP@tv-basicstudies',       // VWAP
                    'MACDHistogram@tv-basicstudies' // MACD
                ],
                description: 'EMA + VWAP + MACD'
            },
            'daytrading': {
                name: 'Day Trading (5m)',
                interval: '5',
                style: '1',
                studies: [
                    'MAExp@tv-basicstudies',      // EMA 9/21
                    'VWAP@tv-basicstudies',       // VWAP
                    'RSI@tv-basicstudies',        // RSI
                    'Volume@tv-basicstudies'      // Volume
                ],
                description: 'EMA + VWAP + RSI + Vol'
            },
            'swing': {
                name: 'Swing (1H)',
                interval: '60',
                style: '1',
                studies: [
                    'MASimple@tv-basicstudies',   // SMA 20/50/200
                    'RSI@tv-basicstudies',        // RSI
                    'MACD@tv-basicstudies',       // MACD
                    'BB@tv-basicstudies'          // Bollinger Bands
                ],
                description: 'SMA + RSI + MACD + BB'
            },
            'momentum': {
                name: 'Momentum (15m)',
                interval: '15',
                style: '1',
                studies: [
                    'MAExp@tv-basicstudies',      // EMA
                    'RSI@tv-basicstudies',        // RSI
                    'MACDHistogram@tv-basicstudies', // MACD Histogram
                    'VWAP@tv-basicstudies'        // VWAP
                ],
                description: 'EMA + RSI + MACD + VWAP'
            },
            'volume': {
                name: 'Volume Profile',
                interval: '5',
                style: '1',
                studies: [
                    'VWAP@tv-basicstudies',       // VWAP
                    'Volume@tv-basicstudies',     // Volume
                    'MASimple@tv-basicstudies'    // SMA
                ],
                description: 'VWAP + Volume + SMA'
            },
            'clean': {
                name: 'Clean (No Indicators)',
                interval: '5',
                style: '1',
                studies: [],
                description: 'Price only'
            },
            'warrior': {
                name: 'Warrior Trading',
                interval: '1',
                style: '1',
                studies: [
                    'MAExp@tv-basicstudies',      // 9 EMA
                    'VWAP@tv-basicstudies',       // VWAP (key level)
                    'Volume@tv-basicstudies'      // Volume for confirmation
                ],
                description: '9 EMA + VWAP + Volume'
            }
        };

        // Available TradingView studies/indicators for user selection
        const AVAILABLE_STUDIES = {
            'MASimple@tv-basicstudies': { name: 'SMA (Simple Moving Average)', category: 'Moving Averages' },
            'MAExp@tv-basicstudies': { name: 'EMA (Exponential Moving Average)', category: 'Moving Averages' },
            'MAWeighted@tv-basicstudies': { name: 'WMA (Weighted Moving Average)', category: 'Moving Averages' },
            'VWAP@tv-basicstudies': { name: 'VWAP', category: 'Volume' },
            'Volume@tv-basicstudies': { name: 'Volume', category: 'Volume' },
            'RSI@tv-basicstudies': { name: 'RSI (Relative Strength Index)', category: 'Momentum' },
            'MACD@tv-basicstudies': { name: 'MACD', category: 'Momentum' },
            'MACDHistogram@tv-basicstudies': { name: 'MACD Histogram', category: 'Momentum' },
            'Stochastic@tv-basicstudies': { name: 'Stochastic', category: 'Momentum' },
            'BB@tv-basicstudies': { name: 'Bollinger Bands', category: 'Volatility' },
            'ATR@tv-basicstudies': { name: 'ATR (Average True Range)', category: 'Volatility' },
            'PSAR@tv-basicstudies': { name: 'Parabolic SAR', category: 'Trend' },
            'IchimokuCloud@tv-basicstudies': { name: 'Ichimoku Cloud', category: 'Trend' },
            'ADX@tv-basicstudies': { name: 'ADX', category: 'Trend' },
            'CCI@tv-basicstudies': { name: 'CCI (Commodity Channel Index)', category: 'Momentum' },
            'WilliamsR@tv-basicstudies': { name: 'Williams %R', category: 'Momentum' },
            'OBV@tv-basicstudies': { name: 'OBV (On Balance Volume)', category: 'Volume' },
            'MFI@tv-basicstudies': { name: 'MFI (Money Flow Index)', category: 'Volume' },
            'PivotPointsStandard@tv-basicstudies': { name: 'Pivot Points', category: 'Support/Resistance' }
        };

        // Get saved chart templates from localStorage
        function getSavedChartTemplates() {
            const saved = localStorage.getItem('customChartTemplates');
            return saved ? JSON.parse(saved) : {};
        }

        // Get timeframe default templates
        function getTimeframeDefaults() {
            const saved = localStorage.getItem('timeframeDefaultTemplates');
            return saved ? JSON.parse(saved) : {};
        }

        // Set a template as default for a timeframe
        function setTimeframeDefault(interval, templateName) {
            const defaults = getTimeframeDefaults();
            defaults[interval] = templateName;
            localStorage.setItem('timeframeDefaultTemplates', JSON.stringify(defaults));
            console.log(`Set "${templateName}" as default template for ${getTimeframeName(interval)} timeframe`);
        }

        // Get default template for a timeframe
        function getDefaultTemplateForTimeframe(interval) {
            const defaults = getTimeframeDefaults();
            return defaults[interval] || null;
        }

        // Save custom chart template
        function saveChartTemplate(name, config) {
            const templates = getSavedChartTemplates();
            templates[name] = config;
            localStorage.setItem('customChartTemplates', JSON.stringify(templates));
            console.log(`Saved custom template: ${name}`);
        }

        // Delete custom chart template
        function deleteChartTemplate(name) {
            const templates = getSavedChartTemplates();
            if (templates[name]) {
                delete templates[name];
                localStorage.setItem('customChartTemplates', JSON.stringify(templates));

                // Also remove from timeframe defaults if set
                const defaults = getTimeframeDefaults();
                for (const [interval, templateName] of Object.entries(defaults)) {
                    if (templateName === name) {
                        delete defaults[interval];
                    }
                }
                localStorage.setItem('timeframeDefaultTemplates', JSON.stringify(defaults));
                console.log(`Deleted custom template: ${name}`);
                return true;
            }
            return false;
        }

        // Get all available templates (built-in + custom)
        function getAllChartTemplates() {
            return { ...CHART_PRESETS, ...getSavedChartTemplates() };
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // CUSTOM TEMPLATE DIALOG FUNCTIONS
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        function showCreateTemplateDialog() {
            // Reset form
            document.getElementById('newTemplateName').value = '';
            document.getElementById('newTemplateTimeframe').value = '5';
            document.getElementById('newTemplateStyle').value = '1';
            document.getElementById('setAsTimeframeDefault').checked = false;

            // Populate indicator checkboxes
            const container = document.getElementById('indicatorCheckboxes');
            let html = '';

            // Group indicators by category
            const categories = {};
            for (const [key, info] of Object.entries(AVAILABLE_STUDIES)) {
                if (!categories[info.category]) categories[info.category] = [];
                categories[info.category].push({ key, ...info });
            }

            for (const [category, indicators] of Object.entries(categories)) {
                html += `<div style="margin-bottom: 10px;">
                    <div style="color: #60a5fa; font-size: 11px; font-weight: 600; margin-bottom: 5px; text-transform: uppercase;">${category}</div>`;
                for (const ind of indicators) {
                    html += `<label style="display: flex; align-items: center; gap: 8px; padding: 4px 0; cursor: pointer; color: #ccc;">
                        <input type="checkbox" class="indicator-checkbox" value="${ind.key}" style="width: 14px; height: 14px;">
                        <span style="font-size: 12px;">${ind.name}</span>
                    </label>`;
                }
                html += '</div>';
            }
            container.innerHTML = html;

            document.getElementById('createTemplateDialog').classList.add('show');
            document.querySelectorAll('.dropdown').forEach(d => d.classList.remove('show'));
        }

        function closeCreateTemplateDialog() {
            document.getElementById('createTemplateDialog').classList.remove('show');
        }

        function saveNewTemplate() {
            const name = document.getElementById('newTemplateName').value.trim();
            if (!name) {
                alert('Please enter a template name');
                return;
            }

            // Check for duplicate names (not allowed to override built-ins)
            if (CHART_PRESETS[name.toLowerCase().replace(/\s+/g, '')]) {
                alert('Cannot override built-in template. Choose a different name.');
                return;
            }

            const interval = document.getElementById('newTemplateTimeframe').value;
            const style = document.getElementById('newTemplateStyle').value;
            const setAsDefault = document.getElementById('setAsTimeframeDefault').checked;

            // Get selected indicators
            const checkboxes = document.querySelectorAll('.indicator-checkbox:checked');
            const studies = Array.from(checkboxes).map(cb => cb.value);

            // Create template key (sanitized name)
            const templateKey = 'custom_' + name.toLowerCase().replace(/[^a-z0-9]/g, '_');

            // Build description from selected indicators
            const studyNames = studies.map(s => {
                const info = AVAILABLE_STUDIES[s];
                return info ? info.name.split(' ')[0] : s.split('@')[0];
            });
            const description = studyNames.length > 0 ? studyNames.join(' + ') : 'No indicators';

            const config = {
                name: name,
                interval: interval,
                style: style,
                studies: studies,
                description: description,
                isCustom: true,
                createdAt: new Date().toISOString()
            };

            // Save the template
            saveChartTemplate(templateKey, config);

            // Set as timeframe default if checked
            if (setAsDefault) {
                setTimeframeDefault(interval, templateKey);
            }

            closeCreateTemplateDialog();
            alert(`Template "${name}" saved successfully!`);

            // Refresh manage dialog if open
            if (document.getElementById('manageTemplatesDialog').classList.contains('show')) {
                refreshManageTemplatesDialog();
            }
        }

        function showManageTemplatesDialog() {
            refreshManageTemplatesDialog();
            document.getElementById('manageTemplatesDialog').classList.add('show');
            document.querySelectorAll('.dropdown').forEach(d => d.classList.remove('show'));
        }

        function closeManageTemplatesDialog() {
            document.getElementById('manageTemplatesDialog').classList.remove('show');
        }

        // Refresh the template dropdown in a chart header
        function refreshChartTemplateDropdown(chartId) {
            const select = document.getElementById(`chart-template-${chartId}`);
            if (!select) return;

            const currentTemplate = chartTemplates[chartId] || 'default';
            const allTemplates = getAllChartTemplates();

            let html = '<optgroup label="Built-in Templates">';
            for (const [key, template] of Object.entries(CHART_PRESETS)) {
                const selected = key === currentTemplate ? 'selected' : '';
                html += `<option value="${key}" ${selected}>${template.name}</option>`;
            }
            html += '</optgroup>';

            // Add custom templates
            const customTemplates = getSavedChartTemplates();
            const customKeys = Object.keys(customTemplates).filter(k => k.startsWith('custom_') && !k.match(/^custom_\d+$/));
            if (customKeys.length > 0) {
                html += '<optgroup label="My Templates">';
                for (const key of customKeys) {
                    const template = customTemplates[key];
                    const selected = key === currentTemplate ? 'selected' : '';
                    html += `<option value="${key}" ${selected}>${template.name}</option>`;
                }
                html += '</optgroup>';
            }

            select.innerHTML = html;
        }

        // Initialize all chart template dropdowns
        function initAllChartTemplateDropdowns() {
            for (const chartId of Object.keys(chartTemplates)) {
                refreshChartTemplateDropdown(chartId);
            }
        }

        function refreshManageTemplatesDialog() {
            // Populate timeframe defaults
            const defaultsContainer = document.getElementById('timeframeDefaultsList');
            const defaults = getTimeframeDefaults();
            const allTemplates = getAllChartTemplates();

            const timeframes = ['1', '5', '15', '30', '60', '240', 'D', 'W'];
            let defaultsHtml = '';

            for (const tf of timeframes) {
                const templateKey = defaults[tf];
                const template = templateKey ? allTemplates[templateKey] : null;
                const templateName = template ? template.name : '(Built-in default)';
                const tfName = getTimeframeName(tf);

                defaultsHtml += `<div style="display: flex; justify-content: space-between; align-items: center; padding: 6px 0; border-bottom: 1px solid #333;">
                    <span style="color: #888; font-size: 12px;">${tfName}:</span>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <span style="color: ${template ? '#22c55e' : '#666'}; font-size: 12px;">${templateName}</span>
                        ${template ? `<button onclick="clearTimeframeDefault('${tf}')" style="background: #ef4444; color: #fff; border: none; padding: 2px 6px; border-radius: 3px; font-size: 10px; cursor: pointer;">Clear</button>` : ''}
                    </div>
                </div>`;
            }
            defaultsContainer.innerHTML = defaultsHtml || '<div style="color: #666; font-size: 12px;">No custom defaults set</div>';

            // Populate custom templates
            const templatesContainer = document.getElementById('customTemplatesList');
            const customTemplates = getSavedChartTemplates();
            let templatesHtml = '';

            for (const [key, template] of Object.entries(customTemplates)) {
                if (key.startsWith('custom_') && !key.match(/^custom_\d+$/)) { // Skip temp custom templates
                    const tfName = getTimeframeName(template.interval);
                    templatesHtml += `<div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; background: #252525; border-radius: 4px; margin-bottom: 6px;">
                        <div>
                            <div style="color: #fff; font-weight: 600; font-size: 13px;">${template.name}</div>
                            <div style="color: #888; font-size: 11px;">${tfName} - ${template.description}</div>
                        </div>
                        <div style="display: flex; gap: 5px;">
                            <button onclick="setTemplateAsDefault('${key}')" style="background: #3b82f6; color: #fff; border: none; padding: 4px 8px; border-radius: 3px; font-size: 11px; cursor: pointer;">Set Default</button>
                            <button onclick="confirmDeleteTemplate('${key}', '${template.name}')" style="background: #ef4444; color: #fff; border: none; padding: 4px 8px; border-radius: 3px; font-size: 11px; cursor: pointer;">Delete</button>
                        </div>
                    </div>`;
                }
            }
            templatesContainer.innerHTML = templatesHtml || '<div style="color: #666; font-size: 12px; text-align: center; padding: 20px;">No custom templates yet. Click "+ New Template" to create one.</div>';
        }

        function setTemplateAsDefault(templateKey) {
            const template = getAllChartTemplates()[templateKey];
            if (template) {
                setTimeframeDefault(template.interval, templateKey);
                refreshManageTemplatesDialog();
                alert(`"${template.name}" set as default for ${getTimeframeName(template.interval)} timeframe`);
            }
        }

        function clearTimeframeDefault(interval) {
            const defaults = getTimeframeDefaults();
            delete defaults[interval];
            localStorage.setItem('timeframeDefaultTemplates', JSON.stringify(defaults));
            refreshManageTemplatesDialog();
        }

        function confirmDeleteTemplate(key, name) {
            if (confirm(`Delete template "${name}"? This cannot be undone.`)) {
                deleteChartTemplate(key);
                refreshManageTemplatesDialog();
            }
        }

        // Toggle chart link status
        function toggleChartLink(chartId) {
            const btn = document.getElementById(`chart-link-${chartId}`);
            const symbolInput = document.getElementById(`chart-symbol-${chartId}`);
            const symbolDisplay = document.getElementById(`chart-symbol-display-${chartId}`);

            if (!btn) return;

            const isLinked = chartLinkStatus[chartId] !== false; // Default to linked

            if (isLinked) {
                // Unlink the chart
                chartLinkStatus[chartId] = false;
                btn.classList.remove('linked');
                btn.classList.add('unlinked');
                btn.innerHTML = 'üîì';
                btn.title = 'Click to link to selected symbol';
                if (symbolInput) {
                    symbolInput.style.display = 'inline-block';
                    symbolInput.value = chartSymbols[chartId] || currentSymbol;
                    symbolInput.focus();
                    symbolInput.select();
                }
                if (symbolDisplay) symbolDisplay.style.display = 'none';
                console.log(`Chart ${chartId} unlinked - now independent`);
            } else {
                // Link the chart
                chartLinkStatus[chartId] = true;
                btn.classList.remove('unlinked');
                btn.classList.add('linked');
                btn.innerHTML = 'üîó';
                btn.title = 'Click to unlink from selected symbol';
                if (symbolInput) symbolInput.style.display = 'none';
                if (symbolDisplay) symbolDisplay.style.display = 'inline';
                // Update to current symbol
                setChartSymbol(chartId, currentSymbol);
                console.log(`Chart ${chartId} linked - synced to ${currentSymbol}`);
            }
        }

        // Set a specific chart's symbol
        function setChartSymbol(chartId, symbol) {
            symbol = symbol.toUpperCase().trim();
            if (!symbol) return;

            chartSymbols[chartId] = symbol;

            // Update display
            const displaySpan = document.getElementById(`chart-symbol-display-${chartId}`);
            if (displaySpan) {
                displaySpan.textContent = symbol;
            }

            // Update the chart
            updateChart(`chart${chartId}`, symbol);
        }

        // Check if a chart is linked
        function isChartLinked(chartId) {
            return chartLinkStatus[chartId] !== false; // Default to linked
        }

        // Initialize chart with optional template/preset
        function initChart(id, symbol, templateName = 'default') {
            const containerId = `chart-${id}`;
            const container = document.getElementById(containerId);
            if (!container) {
                console.log(`Chart container ${containerId} not found`);
                return;
            }

            // Check if TradingView is available
            if (typeof TradingView === 'undefined') {
                console.error('TradingView library not loaded');
                container.innerHTML = `<div class="empty-state" style="padding: 20px; text-align: center;">
                    <div style="font-size: 16px; color: #ef4444; margin-bottom: 10px;">‚ö†Ô∏è TradingView Not Available</div>
                    <div style="font-size: 13px; color: #888;">
                        The TradingView charting library failed to load.<br>
                        <small>Check your internet connection or browser console for errors.</small>
                    </div>
                </div>`;
                return;
            }

            // Get template configuration
            const allTemplates = getAllChartTemplates();
            const template = allTemplates[templateName] || CHART_PRESETS['default'];
            const interval = template.interval || '5';
            const style = template.style || '1';
            const studies = template.studies || ['MASimple@tv-basicstudies', 'RSI@tv-basicstudies'];

            console.log(`Initializing chart ${id} for ${symbol} with template "${templateName}" (${interval})`);

            // Track the symbol and template for this chart
            chartSymbols[id] = symbol;
            chartTemplates[id] = templateName;

            // Update symbol display in header
            const displaySpan = document.getElementById(`chart-symbol-display-${id}`);
            if (displaySpan) {
                displaySpan.textContent = symbol;
            }

            // Update template selector in header (populate with all templates)
            refreshChartTemplateDropdown(id);

            try {
                // Clear container and clean up old widget
                container.innerHTML = '';

                if (chartWidgets[id]) {
                    try {
                        chartWidgets[id].remove();
                    } catch (e) {
                        // Ignore removal errors - container is already cleared
                    }
                    delete chartWidgets[id];
                    delete chartInstances[id];
                }

                // Create new widget with template settings
                chartWidgets[id] = new TradingView.widget({
                    "width": "100%",
                    "height": "100%",
                    "symbol": `NASDAQ:${symbol}`,
                    "interval": interval,
                    "timezone": "America/New_York",
                    "theme": "dark",
                    "style": style,
                    "locale": "en",
                    "toolbar_bg": "#1a1a1a",
                    "enable_publishing": false,
                    "hide_side_toolbar": false,
                    "allow_symbol_change": true,
                    "container_id": containerId,
                    "studies": studies,
                    "backgroundColor": "#1a1a1a",
                    "gridColor": "#2a2a2a",
                    "hide_legend": false,
                    "save_image": false,
                    "onChartReady": function() {
                        chartInstances[id] = chartWidgets[id].chart();
                        console.log(`Chart ${id} ready for ${symbol} (${template.name}, ${interval})`);
                    }
                });
            } catch (e) {
                console.error('TradingView init error:', e);
                container.innerHTML = '<div class="empty-state">TradingView Desktop connection required</div>';
            }
        }

        // Change chart template
        function changeChartTemplate(chartId, templateName) {
            const symbol = chartSymbols[chartId] || currentSymbol;
            chartTemplates[chartId] = templateName;
            console.log(`Changing chart ${chartId} to template "${templateName}"`);
            initChart(chartId, symbol, templateName);
        }

        // Get template options HTML for select dropdown
        function getChartTemplateOptionsHTML(selectedTemplate = 'default') {
            const allTemplates = getAllChartTemplates();
            let html = '';
            for (const [key, template] of Object.entries(allTemplates)) {
                const selected = key === selectedTemplate ? 'selected' : '';
                html += `<option value="${key}" ${selected}>${template.name}</option>`;
            }
            return html;
        }

        function updateChart(winId, symbol) {
            // Extract chart ID from window ID (e.g., 'chart1' -> '1')
            const chartId = winId.replace('chart', '');

            // Preserve the current template
            const currentTemplate = chartTemplates[chartId] || 'default';

            if (chartInstances[chartId]) {
                try {
                    // Use the chart instance to change symbol
                    chartInstances[chartId].setSymbol(`NASDAQ:${symbol}`, function() {
                        console.log(`Chart ${chartId} updated to ${symbol}`);
                    });
                    // Update tracked symbol
                    chartSymbols[chartId] = symbol;
                    // Update symbol display
                    const displaySpan = document.getElementById(`chart-symbol-display-${chartId}`);
                    if (displaySpan) displaySpan.textContent = symbol;
                } catch (e) {
                    console.log('Chart update error, reinitializing:', e);
                    initChart(chartId, symbol, currentTemplate);
                }
            } else if (chartWidgets[chartId]) {
                // Widget exists but no chart instance yet - reinit
                console.log(`No chart instance for ${chartId}, reinitializing`);
                initChart(chartId, symbol, currentTemplate);
            } else {
                // No widget at all - initialize
                console.log(`Creating chart ${chartId} for ${symbol}`);
                initChart(chartId, symbol, currentTemplate);
            }
        }

        window.addEventListener('load', async () => {
            console.log('%cüöÄ Alpaca Professional Trading Platform', 'color: #007acc; font-size: 18px; font-weight: bold;');

            // Start unified price refresh system
            startUnifiedRefresh();
            console.log('[SYNC] Unified refresh system started (updates every 2 seconds)');

            // Initialize configuration system
            updateSavedConfigsList();

            // Load saved watchlist
            const savedWatchlist = localStorage.getItem('watchlist');
            if (savedWatchlist) {
                watchlist = JSON.parse(savedWatchlist);
            }

            // Load auto-submit orders setting
            loadAutoSubmitSetting();

            // Priority: 1. Startup Default Layout (user's saved preference)
            //           2. Custom Layout (legacy)
            //           3. Old Trading Layout (migrate)
            //           4. Built-in Default Layout
            const startupDefault = localStorage.getItem('startupDefaultLayout');
            const customLayout = localStorage.getItem('customLayout');
            const oldSavedLayout = localStorage.getItem('tradingLayout');

            if (startupDefault) {
                console.log('Loading startup default layout...');
                if (!loadStartupDefaultLayout()) {
                    console.log('Fallback to built-in default...');
                    loadLayout('default');
                }
            } else if (customLayout) {
                console.log('Loading custom layout...');
                loadLayout('custom');
            } else if (oldSavedLayout) {
                console.log('Loading old saved layout (migrating to custom)...');
                // Migrate old layout to custom
                try {
                    localStorage.setItem('customLayout', oldSavedLayout);
                    localStorage.removeItem('tradingLayout');
                    loadLayout('custom');
                } catch (e) {
                    console.error('Failed to migrate layout:', e);
                    loadLayout('default');
                }
            } else {
                // Load built-in default layout if no saved layout
                console.log('Loading built-in default layout...');
                loadLayout('default');
            }

            // Subscribe to all watchlist symbols
            console.log('üìä Subscribing to market data...');
            for (const symbol of watchlist) {
                await subscribeToSymbol(symbol);
            }

            // Subscribe to current symbol
            await subscribeToSymbol(currentSymbol);

            // Start status check
            checkStatus();
            setInterval(checkStatus, 5000);

            // Start data updates (every 2 seconds for real-time feel)
            setInterval(() => {
                loadPrice();
                loadLevel2();
                loadTimeSales();
                loadPositions();
                loadAccount();
                loadWorklist();
            }, 2000);

            // Initialize order form price field based on selected order type
            handleOrderTypeChange();

            console.log('%c‚úì Platform Ready', 'color: #22c55e; font-weight: bold;');
            console.log('%cüí° Click symbols in watchlist ‚Ä¢ Click Level 2 prices to fill orders ‚Ä¢ Drag & resize windows', 'color: #888; font-size: 15px;');
        });

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        //                     BOT TRADING CONTROL FUNCTIONS
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        let botStatusRefreshInterval = null;

        async function startBot() {
            try {
                // Try to start bot
                let response = await fetch(`${API_BASE_URL}/api/bot/start`, { method: 'POST' });
                let data = await response.json();

                // If bot not initialized, initialize it first
                if (!response.ok && data.detail && data.detail.includes('not initialized')) {
                    console.log('Bot not initialized, initializing now...');

                    // Initialize bot
                    const initResponse = await fetch(`${API_BASE_URL}/api/bot/init`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' }
                    });

                    if (!initResponse.ok) {
                        alert('‚ùå Failed to initialize bot. Check Alpaca connection.');
                        return;
                    }

                    // Try starting again
                    response = await fetch(`${API_BASE_URL}/api/bot/start`, { method: 'POST' });
                    data = await response.json();
                }

                if (response.ok) {
                    alert('‚úÖ Bot Started Successfully!\n\nNow click "‚úÖ ENABLE TRADING" to activate trading.');
                    await updateBotStatus();
                } else {
                    alert('‚ùå Failed to start bot: ' + (data.detail || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error starting bot:', error);
                alert('‚ùå Error starting bot: ' + error.message);
            }
        }

        async function stopBot() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/bot/stop`, { method: 'POST' });
                const data = await response.json();
                if (response.ok) {
                    alert('‚èπÔ∏è Bot Stopped');
                    await updateBotStatus();
                } else {
                    alert('‚ùå Failed to stop bot: ' + data.detail);
                }
            } catch (error) {
                console.error('Error stopping bot:', error);
                alert('‚ùå Error stopping bot');
            }
        }

        async function enableBotTrading() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/bot/enable`, { method: 'POST' });
                const data = await response.json();
                if (response.ok) {
                    alert('‚úÖ Trading Enabled');
                    await updateBotStatus();
                } else {
                    alert('‚ùå Failed to enable trading: ' + data.detail);
                }
            } catch (error) {
                console.error('Error enabling trading:', error);
                alert('‚ùå Error enabling trading');
            }
        }

        async function disableBotTrading() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/bot/disable`, { method: 'POST' });
                const data = await response.json();
                if (response.ok) {
                    alert('‚è∏Ô∏è Trading Paused');
                    await updateBotStatus();
                } else {
                    alert('‚ùå Failed to pause trading: ' + data.detail);
                }
            } catch (error) {
                console.error('Error pausing trading:', error);
                alert('‚ùå Error pausing trading');
            }
        }

        async function updateBotStatus() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/bot/status`);
                if (!response.ok) return;
                const data = await response.json();

                const indicator = document.getElementById('botStatusIndicator');
                if (indicator) {
                    const dot = indicator.querySelector('div');
                    const text = indicator.querySelector('span');
                    if (data.running && data.enabled) {
                        dot.style.background = '#22c55e';
                        text.style.color = '#22c55e';
                        text.textContent = 'TRADING';
                    } else if (data.running) {
                        dot.style.background = '#f59e0b';
                        text.style.color = '#f59e0b';
                        text.textContent = 'MONITORING';
                    } else {
                        dot.style.background = '#ef4444';
                        text.style.color = '#ef4444';
                        text.textContent = 'STOPPED';
                    }
                }

                const runningEl = document.getElementById('botRunning');
                if (runningEl) {
                    runningEl.textContent = data.running ? 'TRUE' : 'FALSE';
                    runningEl.style.color = data.running ? '#22c55e' : '#ef4444';
                }

                const enabledEl = document.getElementById('botEnabled');
                if (enabledEl) {
                    enabledEl.textContent = data.enabled ? 'TRUE' : 'FALSE';
                    enabledEl.style.color = data.enabled ? '#22c55e' : '#ef4444';
                }

                if (document.getElementById('botSignals')) document.getElementById('botSignals').textContent = data.total_signals_generated || 0;
                if (document.getElementById('botTrades')) document.getElementById('botTrades').textContent = data.total_trades_executed || 0;
                if (document.getElementById('botPositions')) document.getElementById('botPositions').textContent = data.trading_engine?.open_positions || 0;

                const pnlEl = document.getElementById('botPnL');
                if (pnlEl && data.trading_engine) {
                    const pnl = data.trading_engine.daily_pnl || 0;
                    pnlEl.textContent = `$${pnl.toFixed(2)}`;
                    pnlEl.style.color = pnl > 0 ? '#22c55e' : pnl < 0 ? '#ef4444' : '#888';
                }

                if (data.trading_engine) {
                    if (document.getElementById('botDailyLimit')) document.getElementById('botDailyLimit').textContent = `$${data.trading_engine.daily_loss_limit || 500}`;
                    if (document.getElementById('botWeeklyLimit')) document.getElementById('botWeeklyLimit').textContent = `$${data.trading_engine.weekly_loss_limit?.toFixed(0) || 3500}`;
                }

                // Fetch and display shared WORKLIST (not bot's internal watchlist)
                const worklistEl = document.getElementById('botWorklist');
                const countEl = document.getElementById('worklistCount');
                if (worklistEl) {
                    try {
                        const worklistResponse = await fetch(`${API_BASE_URL}/api/worklist`);
                        if (worklistResponse.ok) {
                            const worklistData = await worklistResponse.json();
                            const symbols = worklistData.data.map(item => item.symbol);
                            worklistEl.textContent = symbols.length > 0 ? symbols.join(', ') : 'Empty - Add symbols from scanner';
                            if (countEl) {
                                countEl.textContent = `${symbols.length} symbols`;
                                countEl.style.color = symbols.length > 0 ? '#4ade80' : '#666';
                            }
                        }
                    } catch (err) {
                        console.log('Could not fetch worklist:', err);
                    }
                }

                const positionsEl = document.getElementById('botOpenPositions');
                if (positionsEl && data.trading_engine?.positions) {
                    const positions = data.trading_engine.positions;
                    if (Object.keys(positions).length === 0) {
                        positionsEl.innerHTML = '<div class="empty-state" style="padding: 20px; font-size: 12px;">No open positions</div>';
                    } else {
                        let html = '<div style="display: flex; flex-direction: column; gap: 6px;">';
                        for (const [symbol, pos] of Object.entries(positions)) {
                            const pnl = pos.unrealized_pnl || 0;
                            const pnlColor = pnl > 0 ? '#22c55e' : pnl < 0 ? '#ef4444' : '#888';
                            html += `<div style="padding: 8px; background: #252525; border-radius: 3px; border-left: 3px solid ${pnlColor};"><div style="display: flex; justify-content: space-between; margin-bottom: 4px;"><span style="font-weight: 600; color: #fff;">${symbol}</span><span style="color: ${pnlColor}; font-weight: 600;">$${pnl.toFixed(2)}</span></div><div style="display: flex; justify-content: space-between; font-size: 10px; color: #888;"><span>${pos.shares} shares @ $${pos.entry_price?.toFixed(2)}</span><span>Stop: $${pos.stop_loss?.toFixed(2)}</span></div></div>`;
                        }
                        html += '</div>';
                        positionsEl.innerHTML = html;
                    }
                }
            } catch (error) {
                console.error('Error updating bot status:', error);
            }
        }

        function startBotStatusRefresh() {
            if (botStatusRefreshInterval) clearInterval(botStatusRefreshInterval);
            botStatusRefreshInterval = setInterval(updateBotStatus, 5000);
        }

        function stopBotStatusRefresh() {
            if (botStatusRefreshInterval) {
                clearInterval(botStatusRefreshInterval);
                botStatusRefreshInterval = null;
            }
        }

        // Load a single symbol from worklist (for training/predictions)
        async function loadWorklistSymbol(inputId) {
            try {
                const response = await fetch(`${API_BASE_URL}/api/worklist`);
                if (!response.ok) throw new Error('Failed to fetch worklist');

                const data = await response.json();
                const symbols = data.data.map(item => item.symbol);

                if (symbols.length === 0) {
                    alert('‚ö†Ô∏è Worklist is empty!\n\nAdd symbols from scanner first.');
                    return;
                }

                // Create a custom dropdown dialog
                const inputEl = document.getElementById(inputId);
                const rect = inputEl.getBoundingClientRect();

                // Create dropdown container
                const dropdown = document.createElement('div');
                dropdown.id = 'worklistDropdown';
                dropdown.style.cssText = `
                    position: fixed;
                    top: ${rect.bottom + 5}px;
                    left: ${rect.left}px;
                    width: ${rect.width}px;
                    max-height: 300px;
                    overflow-y: auto;
                    background: #252525;
                    border: 2px solid #007acc;
                    border-radius: 4px;
                    z-index: 10000;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.5);
                `;

                // Add title
                dropdown.innerHTML = `
                    <div style="padding: 8px; background: #007acc; color: white; font-weight: 600; font-size: 12px; position: sticky; top: 0;">
                        üìã Select from Worklist (${symbols.length} symbols)
                    </div>
                `;

                // Add symbol options
                symbols.forEach((symbol, idx) => {
                    const option = document.createElement('div');
                    option.style.cssText = `
                        padding: 10px;
                        cursor: pointer;
                        border-bottom: 1px solid #333;
                        color: #fff;
                        font-size: 14px;
                        font-weight: 600;
                    `;
                    option.textContent = symbol;
                    option.onmouseover = () => option.style.background = '#007acc';
                    option.onmouseout = () => option.style.background = 'transparent';
                    option.onclick = () => {
                        inputEl.value = symbol;
                        document.body.removeChild(dropdown);
                    };
                    dropdown.appendChild(option);
                });

                // Close on click outside
                const closeDropdown = (e) => {
                    if (!dropdown.contains(e.target) && e.target !== inputEl) {
                        document.body.removeChild(dropdown);
                        document.removeEventListener('click', closeDropdown);
                    }
                };

                setTimeout(() => document.addEventListener('click', closeDropdown), 100);

                document.body.appendChild(dropdown);

            } catch (error) {
                console.error('Error loading worklist symbol:', error);
                alert('‚ùå Failed to load worklist');
            }
        }

        // Load all symbols from worklist (for backtesting)
        async function loadWorklistSymbols(inputId) {
            try {
                const response = await fetch(`${API_BASE_URL}/api/worklist`);
                if (!response.ok) throw new Error('Failed to fetch worklist');

                const data = await response.json();
                const symbols = data.data.map(item => item.symbol);

                if (symbols.length === 0) {
                    alert('‚ö†Ô∏è Worklist is empty!\n\nAdd symbols from scanner first.');
                    return;
                }

                const inputEl = document.getElementById(inputId);
                if (inputEl) {
                    inputEl.value = symbols.join(',');
                    alert(`‚úÖ Loaded ${symbols.length} symbols from worklist!\n\n${symbols.slice(0, 10).join(', ')}${symbols.length > 10 ? '...' : ''}`);
                }
            } catch (error) {
                console.error('Error loading worklist symbols:', error);
                alert('‚ùå Failed to load worklist');
            }
        }

        // Add scanner results to shared WORKLIST
        async function syncWorklistWithScanner() {
            try {
                console.log('Adding scanner symbols to WORKLIST...');

                // Fetch scanner results
                const response = await fetch(`${API_BASE_URL}/api/scanner/results`);
                if (!response.ok) {
                    throw new Error(`Scanner API returned ${response.status}`);
                }

                const data = await response.json();
                console.log('Scanner data:', data);

                if (!data.symbols || data.symbols.length === 0) {
                    alert('‚ö†Ô∏è No symbols found in scanner. Run a scan first.');
                    return;
                }

                // Extract unique symbols from scanner (momentum stocks)
                const scannerSymbols = [...new Set(data.symbols.map(s => s.symbol))];
                console.log(`Found ${scannerSymbols.length} symbols in scanner`);

                // Get current worklist to avoid duplicates
                const worklistResponse = await fetch(`${API_BASE_URL}/api/worklist`);
                const worklistData = await worklistResponse.json();
                const existingSymbols = new Set(worklistData.data.map(item => item.symbol));

                // Filter out symbols already in worklist
                const newSymbols = scannerSymbols.filter(s => !existingSymbols.has(s));

                if (newSymbols.length === 0) {
                    alert(`‚úÖ All ${scannerSymbols.length} scanner symbols already in worklist!\n\nNo new symbols to add.`);
                    return;
                }

                // Add new symbols to worklist
                let addedCount = 0;
                const errors = [];

                for (const symbol of newSymbols) {
                    try {
                        const addResponse = await fetch(`${API_BASE_URL}/api/worklist/add`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ symbol: symbol })
                        });

                        if (addResponse.ok) {
                            addedCount++;
                        } else {
                            errors.push(symbol);
                        }
                    } catch (err) {
                        errors.push(symbol);
                    }
                }

                // Refresh bot status to show updated worklist
                await updateBotStatus();

                // Show results
                const totalInWorklist = existingSymbols.size + addedCount;
                let message = `‚úÖ Worklist updated!\n\n`;
                message += `‚Ä¢ Added: ${addedCount} new symbols\n`;
                message += `‚Ä¢ Already had: ${existingSymbols.size} symbols\n`;
                message += `‚Ä¢ Total in worklist: ${totalInWorklist}\n\n`;

                if (addedCount > 0) {
                    message += `New momentum stocks:\n${newSymbols.slice(0, 10).join(', ')}${newSymbols.length > 10 ? '...' : ''}`;
                }

                if (errors.length > 0) {
                    message += `\n\n‚ö†Ô∏è Failed to add: ${errors.join(', ')}`;
                }

                alert(message);

            } catch (error) {
                console.error('Error syncing worklist:', error);
                alert(`‚ùå Failed to sync: ${error.message}`);
            }
        }

    </script>
</body>
</html>
