<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Morpheus Trading Bot - Professional Platform</title>
    <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
    <script src="https://unpkg.com/lightweight-charts@5.0.9/dist/lightweight-charts.standalone.production.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            background: #000000;
            color: #c0c0c0;
            font-size: 12px;
            overflow: hidden;
        }

        /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
           STERLING TRADER PRO THEME
           Professional trading platform styling
           ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

        /* Sterling Color Palette */
        :root {
            --sterling-bg: #000000;
            --sterling-panel: #0a0a0a;
            --sterling-header: #1a1a1a;
            --sterling-border: #2a2a2a;
            --sterling-text: #c0c0c0;
            --sterling-text-dim: #666666;
            --sterling-buy: #0066cc;        /* Sterling Blue for Buy */
            --sterling-sell: #cc0000;       /* Sterling Red for Sell */
            --sterling-short: #9900cc;      /* Sterling Purple for Short */
            --sterling-up: #00cc00;         /* Green for up */
            --sterling-down: #ff3333;       /* Red for down */
            --sterling-bid: #00aa00;        /* Bid green */
            --sterling-ask: #cc3333;        /* Ask red */
            --sterling-highlight: #003366;
            --sterling-warning: #ff6600;
        }

        /* Top Bar - Sterling Style */
        .top-bar {
            background: linear-gradient(180deg, #1a1a1a 0%, #0d0d0d 100%);
            border-bottom: 1px solid #333;
            padding: 2px 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 26px;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 10000;
        }

        .top-bar-left h1 {
            font-size: 13px;
            font-weight: 700;
            color: #00aaff;
            letter-spacing: 1px;
            font-family: 'Consolas', monospace;
            text-shadow: 0 0 10px rgba(0, 170, 255, 0.3);
        }

        .top-bar-right {
            display: flex;
            gap: 10px;
            align-items: center;
            font-size: 11px;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 2px 6px;
            background: #252525;
            border: 1px solid #404040;
            border-radius: 2px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #ef4444;
            animation: pulse 2s infinite;
        }

        .status-dot.connected {
            background: #22c55e;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Price flash animation for synchronized updates */
        @keyframes priceFlash {
            0%, 100% { background-color: transparent; }
            50% { background-color: rgba(96, 165, 250, 0.3); }
        }

        .price-flash {
            animation: priceFlash 0.5s ease;
        }

        /* Configuration Dialog Styles */
        .config-dialog-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 99999;
        }

        .config-dialog-overlay.show {
            display: flex;
        }

        .config-dialog {
            background: #1a1a1a;
            border: 2px solid #007acc;
            border-radius: 4px;
            padding: 20px;
            min-width: 400px;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.9);
        }

        .config-dialog-header {
            font-size: 18px;
            font-weight: 700;
            color: #007acc;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #333;
        }

        .config-dialog-body {
            margin-bottom: 20px;
        }

        .config-dialog-footer {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .config-input {
            width: 100%;
            padding: 10px;
            background: #252525;
            border: 1px solid #404040;
            color: #fff;
            font-size: 14px;
            border-radius: 3px;
            margin-bottom: 10px;
        }

        .config-input:focus {
            outline: none;
            border-color: #007acc;
        }

        .config-list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: #252525;
            border: 1px solid #333;
            border-radius: 3px;
            margin-bottom: 8px;
        }

        .config-list-item:hover {
            background: #2d2d2d;
        }

        .config-list-item-name {
            font-weight: 600;
            color: #fff;
            flex: 1;
        }

        .config-list-item-date {
            font-size: 11px;
            color: #888;
            margin-right: 10px;
        }

        .config-list-item-actions {
            display: flex;
            gap: 5px;
        }

        .config-btn-small {
            padding: 4px 8px;
            font-size: 12px;
            border: none;
            border-radius: 2px;
            cursor: pointer;
            font-weight: 600;
        }

        .config-btn-load {
            background: #22c55e;
            color: #000;
        }

        .config-btn-rename {
            background: #60a5fa;
            color: #000;
        }

        .config-btn-delete {
            background: #ef4444;
            color: #fff;
        }

        .config-btn-small:hover {
            opacity: 0.8;
        }

        /* Menu Bar - Sterling Style */
        .menu-bar {
            background: linear-gradient(180deg, #1a1a1a 0%, #0d0d0d 100%);
            border-bottom: 1px solid #333;
            padding: 0 4px;
            display: flex;
            gap: 0;
            height: 20px;
            position: fixed;
            top: 26px;
            left: 0;
            right: 0;
            z-index: 9999;
        }

        .menu-item {
            padding: 3px 10px;
            cursor: pointer;
            font-size: 11px;
            font-weight: 600;
            color: #888;
            border-right: 1px solid #222;
            transition: all 0.15s;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            position: relative;
            font-family: 'Consolas', monospace;
        }

        .menu-item:hover {
            background: linear-gradient(180deg, #003366 0%, #001a33 100%);
            color: #00aaff;
        }

        /* Dropdown Menu */
        .dropdown {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            background: #2d2d2d;
            border: 1px solid #404040;
            min-width: 220px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
            z-index: 10000;
        }

        .dropdown.show {
            display: block;
        }

        .dropdown a {
            display: block;
            padding: 10px 15px;
            color: #e0e0e0;
            text-decoration: none;
            font-size: 14px;
            border-bottom: 1px solid #404040;
            transition: background 0.2s;
            text-transform: none;
            letter-spacing: normal;
        }

        .dropdown a:hover {
            background: #007acc;
            color: #ffffff;
        }

        .dropdown strong {
            display: block;
            padding: 8px 15px;
            color: #007acc;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .dropdown hr {
            border: none;
            border-top: 1px solid #404040;
            margin: 0;
        }

        /* Workspace - Sterling Style */
        .workspace {
            position: fixed;
            top: 46px;
            left: 0;
            right: 0;
            bottom: 0;
            background: #000;
            overflow: hidden;
        }

        /* Draggable Window - Sterling Style */
        .window {
            position: absolute;
            background: #000;
            border: 1px solid #333;
            display: flex;
            flex-direction: column;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.9);
            min-width: 180px;
            min-height: 120px;
        }

        .window.active {
            border-color: #00aaff;
            box-shadow: 0 4px 20px rgba(0, 170, 255, 0.3);
        }

        .window-header {
            background: linear-gradient(180deg, #1a1a1a 0%, #0d0d0d 100%);
            padding: 3px 6px;
            border-bottom: 1px solid #333;
            font-size: 10px;
            font-weight: 700;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: move;
            user-select: none;
            font-family: 'Consolas', monospace;
        }

        .window.active .window-header {
            background: linear-gradient(180deg, #003366 0%, #001a33 100%);
            color: #00aaff;
            border-bottom-color: #004488;
        }

        .window-controls {
            display: flex;
            gap: 6px;
        }

        .window-btn {
            width: 14px;
            height: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 12px;
            border-radius: 2px;
            transition: background 0.2s;
            font-weight: bold;
        }

        .window-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .window-btn.minimize { color: #fbbf24; }
        .window-btn.maximize { color: #22c55e; }
        .window-btn.close { color: #ef4444; }

        .window-content {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            background: #1a1a1a;
        }

        /* Resize Handles */
        .resize-handle {
            position: absolute;
            background: transparent;
            z-index: 10;
        }

        .resize-handle.n { top: 0; left: 0; right: 0; height: 5px; cursor: ns-resize; }
        .resize-handle.s { bottom: 0; left: 0; right: 0; height: 5px; cursor: ns-resize; }
        .resize-handle.e { top: 0; right: 0; bottom: 0; width: 5px; cursor: ew-resize; }
        .resize-handle.w { top: 0; left: 0; bottom: 0; width: 5px; cursor: ew-resize; }
        .resize-handle.ne { top: 0; right: 0; width: 10px; height: 10px; cursor: nesw-resize; }
        .resize-handle.nw { top: 0; left: 0; width: 10px; height: 10px; cursor: nwse-resize; }
        .resize-handle.se { bottom: 0; right: 0; width: 10px; height: 10px; cursor: nwse-resize; }
        .resize-handle.sw { bottom: 0; left: 0; width: 10px; height: 10px; cursor: nesw-resize; }

        /* Layout Controls */
        .layout-controls {
            position: fixed;
            bottom: 10px;
            right: 10px;
            display: flex;
            gap: 6px;
            z-index: 9998;
        }

        .layout-btn {
            padding: 8px 12px;
            background: #2d2d2d;
            border: 1px solid #007acc;
            color: #ffffff;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            border-radius: 3px;
            transition: all 0.2s;
            text-transform: uppercase;
        }

        .layout-btn:hover {
            background: #007acc;
        }

        /* Data Table Styles - Sterling Style */
        .data-table {
            width: 100%;
            font-family: 'Consolas', monospace;
            font-size: 12px;
            border-collapse: collapse;
        }

        .data-table thead {
            background: linear-gradient(180deg, #1a1a1a 0%, #0d0d0d 100%);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .data-table th {
            padding: 4px 5px;
            text-align: left;
            font-weight: 700;
            color: #666;
            border-bottom: 1px solid #333;
            text-transform: uppercase;
            font-size: 10px;
            letter-spacing: 0.3px;
        }

        .data-table td {
            padding: 2px 4px;
            border-bottom: 1px solid #0a0a0a;
        }

        .data-table tr:hover {
            background: #1a2a3a;
        }

        .data-table .clickable {
            cursor: pointer;
        }

        .data-table .clickable:hover {
            background: linear-gradient(180deg, #003366 0%, #001a33 100%);
        }

        /* Position row colors */
        .data-table tr.position-long {
            background: rgba(0, 170, 0, 0.1);
        }
        .data-table tr.position-short {
            background: rgba(204, 51, 51, 0.1);
        }
        .data-table tr.position-profit {
            border-left: 2px solid #00cc00;
        }
        .data-table tr.position-loss {
            border-left: 2px solid #ff3333;
        }

        /* Module Specific Styles - Compact */
        .module-content {
            padding: 4px;
        }

        /* Quote Display - Compact */
        .quote-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 3px;
            padding: 4px;
            background: #1e1e1e;
        }

        .quote-stat {
            padding: 3px 5px;
            background: #252525;
            border: 1px solid #333;
            border-radius: 2px;
        }

        .quote-stat-label {
            font-size: 9px;
            color: #888;
            text-transform: uppercase;
            margin-bottom: 1px;
        }

        .quote-stat-value {
            font-size: 12px;
            font-weight: 700;
            font-family: 'Courier New', monospace;
        }

        .positive { color: #22c55e !important; }
        .negative { color: #ef4444 !important; }
        .neutral { color: #888 !important; }

        /* Level 2 - Sterling Trader Pro Style */
        .level2-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0;
            background: #000;
            font-family: 'Consolas', 'Monaco', monospace;
            height: 100%;
        }

        .level2-column {
            background: #000;
            overflow-y: auto;
            border-right: 1px solid #1a1a1a;
        }

        .level2-column:last-child {
            border-right: none;
            border-left: 1px solid #1a1a1a;
        }

        .level2-header {
            display: grid;
            grid-template-columns: 46px 60px 68px 46px;
            padding: 2px 2px;
            font-size: 10px;
            font-weight: 700;
            background: linear-gradient(180deg, #1a1a1a 0%, #0d0d0d 100%);
            border-bottom: 1px solid #333;
            position: sticky;
            top: 0;
            z-index: 5;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .level2-header div {
            text-align: center;
            color: #888;
            padding: 2px 0;
        }

        .level2-row {
            display: grid;
            grid-template-columns: 46px 60px 68px 46px;
            padding: 1px 2px;
            font-size: 12px;
            border-bottom: 1px solid #0a0a0a;
            position: relative;
            transition: background 0.1s;
        }

        .level2-row:hover {
            background: #1a2a3a !important;
        }

        .level2-row div {
            text-align: center;
            padding: 2px 1px;
        }

        .level2-row.clickable {
            cursor: pointer;
        }

        /* Sterling-style price level coloring - bids (green tones) */
        .level2-row.bid-level-0 { background: rgba(0, 170, 0, 0.25); }
        .level2-row.bid-level-1 { background: rgba(0, 170, 0, 0.18); }
        .level2-row.bid-level-2 { background: rgba(0, 170, 0, 0.12); }
        .level2-row.bid-level-3 { background: rgba(0, 170, 0, 0.08); }
        .level2-row.bid-level-4 { background: rgba(0, 170, 0, 0.04); }

        /* Sterling-style price level coloring - asks (red tones) */
        .level2-row.ask-level-0 { background: rgba(204, 51, 51, 0.25); }
        .level2-row.ask-level-1 { background: rgba(204, 51, 51, 0.18); }
        .level2-row.ask-level-2 { background: rgba(204, 51, 51, 0.12); }
        .level2-row.ask-level-3 { background: rgba(204, 51, 51, 0.08); }
        .level2-row.ask-level-4 { background: rgba(204, 51, 51, 0.04); }

        .level2-price {
            font-weight: 700;
        }

        .level2-mmid {
            color: #00aaff;
            font-size: 11px;
            font-weight: 600;
        }

        .level2-size {
            color: #fff;
            font-weight: 600;
        }

        .level2-size.large {
            color: #ffff00;
            font-weight: 700;
        }

        .level2-time {
            color: #666;
            font-size: 10px;
        }

        /* Order Entry - Compact */
        .order-entry-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 4px;
            margin-bottom: 4px;
        }

        .order-field {
            margin-bottom: 4px;
        }

        .order-field label {
            display: block;
            font-size: 11px;
            color: #888;
            margin-bottom: 2px;
            text-transform: uppercase;
            font-weight: 600;
        }

        .order-field input,
        .order-field select {
            width: 100%;
            padding: 4px 6px;
            background: #252525;
            border: 1px solid #404040;
            color: #fff;
            font-size: 13px;
            border-radius: 2px;
            font-family: 'Courier New', monospace;
        }

        .order-field input:focus,
        .order-field select:focus {
            outline: none;
            border-color: #007acc;
        }

        .quantity-buttons {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 2px;
            margin-bottom: 4px;
        }

        .qty-btn {
            padding: 4px;
            background: #252525;
            border: 1px solid #404040;
            color: #888;
            font-size: 12px;
            cursor: pointer;
            border-radius: 2px;
            transition: all 0.2s;
            font-weight: 600;
        }

        .qty-btn:hover {
            background: #404040;
            color: #fff;
        }

        .price-controls {
            display: grid;
            grid-template-columns: 30px 1fr 30px;
            gap: 2px;
            margin-bottom: 4px;
        }

        .price-btn {
            padding: 3px;
            background: #252525;
            border: 1px solid #404040;
            color: #007acc;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            border-radius: 2px;
        }

        .price-btn:hover {
            background: #007acc;
            color: #fff;
        }

        .order-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 4px;
            margin-top: 6px;
        }

        .btn {
            padding: 6px;
            border: none;
            cursor: pointer;
            font-size: 11px;
            font-weight: 700;
            border-radius: 2px;
            transition: all 0.2s;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        /* Sterling-style order buttons */
        .btn-buy {
            background: linear-gradient(180deg, #0077cc 0%, #004488 100%);
            color: #fff;
            border: 1px solid #0088dd;
            text-shadow: 0 1px 1px rgba(0,0,0,0.5);
        }

        .btn-buy:hover {
            background: linear-gradient(180deg, #0088dd 0%, #0055aa 100%);
            box-shadow: 0 0 8px rgba(0, 136, 221, 0.5);
        }

        .btn-sell {
            background: linear-gradient(180deg, #cc0000 0%, #880000 100%);
            color: #fff;
            border: 1px solid #dd0000;
            text-shadow: 0 1px 1px rgba(0,0,0,0.5);
        }

        .btn-sell:hover {
            background: linear-gradient(180deg, #dd0000 0%, #aa0000 100%);
            box-shadow: 0 0 8px rgba(221, 0, 0, 0.5);
        }

        .btn-short {
            background: linear-gradient(180deg, #9900cc 0%, #660088 100%);
            color: #fff;
            border: 1px solid #aa00dd;
            text-shadow: 0 1px 1px rgba(0,0,0,0.5);
        }

        .btn-short:hover {
            background: linear-gradient(180deg, #aa00dd 0%, #7700aa 100%);
            box-shadow: 0 0 8px rgba(153, 0, 204, 0.5);
        }

        /* Sterling Hot Button Bar */
        .hot-button-bar {
            display: flex;
            gap: 2px;
            padding: 3px;
            background: linear-gradient(180deg, #1a1a1a 0%, #0d0d0d 100%);
            border-bottom: 1px solid #333;
        }

        .hot-btn {
            padding: 4px 8px;
            font-size: 10px;
            font-weight: 700;
            font-family: 'Consolas', monospace;
            border: 1px solid #333;
            border-radius: 2px;
            cursor: pointer;
            transition: all 0.1s;
            text-transform: uppercase;
        }

        .hot-btn.buy-hot {
            background: linear-gradient(180deg, #003366 0%, #001a33 100%);
            color: #00aaff;
            border-color: #004488;
        }

        .hot-btn.buy-hot:hover {
            background: linear-gradient(180deg, #004488 0%, #002244 100%);
            box-shadow: 0 0 5px rgba(0, 170, 255, 0.3);
        }

        .hot-btn.sell-hot {
            background: linear-gradient(180deg, #330000 0%, #1a0000 100%);
            color: #ff6666;
            border-color: #440000;
        }

        .hot-btn.sell-hot:hover {
            background: linear-gradient(180deg, #440000 0%, #220000 100%);
            box-shadow: 0 0 5px rgba(255, 102, 102, 0.3);
        }

        .hot-btn.qty-hot {
            background: linear-gradient(180deg, #1a1a1a 0%, #0d0d0d 100%);
            color: #aaa;
            border-color: #333;
        }

        .hot-btn.qty-hot:hover, .hot-btn.qty-hot.active {
            background: linear-gradient(180deg, #2a2a2a 0%, #1a1a1a 100%);
            color: #fff;
            border-color: #555;
        }

        /* Hotkey Panel Styles */
        .hk-row {
            display: grid;
            grid-template-columns: 100px 50px 1fr;
            gap: 10px;
            padding: 6px 8px;
            border-bottom: 1px solid #1a1a1a;
            align-items: center;
        }

        .hk-row:hover {
            background: #0a0a0a;
        }

        .hk-label {
            color: #c0c0c0;
            font-size: 11px;
            font-weight: 600;
        }

        .hk-input {
            width: 40px;
            text-align: center;
            padding: 4px;
            background: #1a1a1a;
            border: 1px solid #333;
            color: #00aaff;
            font-size: 12px;
            font-weight: 700;
            font-family: 'Consolas', monospace;
            text-transform: uppercase;
        }

        .hk-input:focus {
            border-color: #00aaff;
            box-shadow: 0 0 5px rgba(0, 170, 255, 0.3);
            background: #0a1a2a;
        }

        .hk-desc {
            color: #666;
            font-size: 10px;
        }

        .btn-secondary {
            background: #404040;
            color: #fff;
        }

        .btn-secondary:hover {
            background: #525252;
        }

        .btn-danger {
            background: #991b1b;
            color: #fff;
        }

        .btn-danger:hover {
            background: #7f1d1d;
        }

        /* Watchlist */
        .watchlist-item {
            display: grid;
            grid-template-columns: 60px 1fr 60px;
            padding: 6px 8px;
            border-bottom: 1px solid #252525;
            cursor: pointer;
            transition: background 0.2s;
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }

        .watchlist-item:hover {
            background: #252525;
        }

        .watchlist-item.active {
            background: #007acc;
        }

        .watchlist-symbol {
            font-weight: 700;
            font-size: 15px;
        }

        .watchlist-price {
            text-align: right;
        }

        .watchlist-change {
            text-align: right;
            font-size: 13px;
        }

        /* Account */
        .account-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 6px;
            padding: 8px;
        }

        .account-stat {
            padding: 6px 8px;
            background: #252525;
            border: 1px solid #333;
            border-radius: 2px;
        }

        .account-stat-label {
            font-size: 13px;
            color: #888;
            margin-bottom: 3px;
            text-transform: uppercase;
        }

        .account-stat-value {
            font-size: 16px;
            font-weight: 700;
            font-family: 'Courier New', monospace;
        }

        /* Time & Sales - Sterling Style Tape */
        .timesales-row {
            display: grid;
            grid-template-columns: 72px 82px 60px;
            padding: 2px 4px;
            font-family: 'Consolas', monospace;
            font-size: 12px;
            border-bottom: 1px solid #0a0a0a;
            transition: background 0.1s;
        }

        .timesales-row:hover {
            background: #1a2a3a;
        }

        .timesales-row.uptick {
            background: rgba(0, 170, 0, 0.15);
        }

        .timesales-row.downtick {
            background: rgba(204, 51, 51, 0.15);
        }

        .timesales-row.large-print {
            background: rgba(255, 255, 0, 0.15) !important;
        }

        .timesales-time {
            color: #666;
            font-size: 11px;
        }
        .timesales-price {
            text-align: right;
            font-weight: 700;
        }
        .timesales-price.up { color: #00cc00; }
        .timesales-price.down { color: #ff3333; }
        .timesales-size {
            text-align: right;
            color: #aaa;
        }
        .timesales-size.large {
            color: #ffff00;
            font-weight: 700;
        }

        .empty-state {
            padding: 30px 20px;
            text-align: center;
            color: #555;
            font-style: italic;
            font-size: 15px;
        }

        /* Chart */
        .chart-container {
            width: 100%;
            height: 100%;
            min-height: 300px;
            background: #1a1a1a;
        }

        .chart-link-btn {
            width: 22px;
            height: 18px;
            border: 1px solid #444;
            border-radius: 3px;
            background: #2a2a2a;
            cursor: pointer;
            font-size: 11px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s;
            padding: 0;
        }

        .chart-link-btn.linked {
            background: #1e3a5f;
            border-color: #3b82f6;
        }

        .chart-link-btn.unlinked {
            background: #3f3f46;
            border-color: #666;
            opacity: 0.8;
        }

        .chart-link-btn:hover {
            transform: scale(1.1);
            opacity: 1;
        }

        /* Position Badge */
        .pos-badge {
            padding: 2px 6px;
            border-radius: 2px;
            font-size: 13px;
            font-weight: 700;
        }

        .pos-badge.long {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
        }

        .pos-badge.short {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        /* Action Button */
        .action-btn {
            padding: 4px 8px;
            font-size: 13px;
            background: #404040;
            border: 1px solid #555;
            color: #fff;
            cursor: pointer;
            border-radius: 2px;
            transition: all 0.2s;
        }

        .action-btn:hover {
            background: #007acc;
            border-color: #007acc;
        }

        /* Scrollbar - Sterling Style (thin, subtle) */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: #0a0a0a;
        }

        ::-webkit-scrollbar-thumb {
            background: #2a2a2a;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #3a3a3a;
        }

        /* Sterling-style input fields */
        input, select, textarea {
            font-family: 'Consolas', monospace;
            background: #0a0a0a;
            border: 1px solid #333;
            color: #c0c0c0;
            padding: 3px 6px;
            border-radius: 2px;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #00aaff;
            box-shadow: 0 0 3px rgba(0, 170, 255, 0.3);
        }

        input::placeholder {
            color: #444;
        }

        /* Lightweight Charts Styles */
        .lw-tf-btn {
            padding: 4px 8px;
            background: #252525;
            border: 1px solid #404040;
            color: #888;
            font-size: 10px;
            cursor: pointer;
            border-radius: 2px;
            transition: all 0.2s;
        }
        .lw-tf-btn:hover {
            background: #333;
            color: #fff;
        }
        .lw-tf-btn.active {
            background: #2563eb;
            border-color: #2563eb;
            color: #fff;
        }
    </style>
</head>
<body>
    <!-- Top Bar - Sterling Style -->
    <div class="top-bar">
        <div class="top-bar-left">
            <h1>MORPHEUS TRADER PRO</h1>
        </div>
        <div class="top-bar-right">
            <div class="status-item">
                <div class="status-dot connected" id="schwabStatusTop"></div>
                <span>Schwab: <strong id="schwabStatusText">Connected</strong></span>
            </div>
            <div class="status-item">
                <div class="status-dot" id="aiStatus"></div>
                <span>AI: <strong id="aiStatusText">Offline</strong></span>
            </div>
            <div class="status-item">
                <span>Current: <strong id="currentSymbolDisplay">AAPL</strong></span>
            </div>
            <div class="status-item" onclick="showChannelStatusModal()" style="cursor: pointer;" title="Click for details">
                <div class="status-dot" id="channelStatus"></div>
                <span>Data: <strong id="channelStatusText">--</strong></span>
            </div>
            <div class="status-item" onclick="showStreamingModal()" style="cursor: pointer;" title="Click for streaming controls">
                <div class="status-dot" id="streamingStatus"></div>
                <span>Stream: <strong id="streamingStatusText">Off</strong></span>
            </div>
            <div class="status-item" onclick="showBrokerModal()" style="cursor: pointer;" title="Click to switch broker/account">
                <div class="status-dot" id="schwabStatus"></div>
                <span>Broker: <strong id="brokerStatusText">Schwab</strong></span>
            </div>
        </div>
    </div>

    <!-- News Feed is now in the NEWS FEED window panel -->

    <!-- Channel Status Modal -->
    <div id="channelStatusModal" class="config-dialog-overlay">
        <div class="config-dialog" style="min-width: 500px;">
            <div class="config-dialog-header">
                üì° Multi-Channel Data Status
            </div>
            <div class="config-dialog-body">
                <div id="channelStatusDetails" style="font-size: 13px;">
                    <div style="text-align: center; padding: 20px; color: #666;">Loading channel status...</div>
                </div>
            </div>
            <div class="config-dialog-footer">
                <button class="btn btn-secondary" onclick="refreshChannelStatus()">üîÑ Refresh</button>
                <button class="btn btn-secondary" onclick="closeChannelStatusModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- Streaming Control Modal -->
    <div id="streamingModal" class="config-dialog-overlay">
        <div class="config-dialog" style="min-width: 550px;">
            <div class="config-dialog-header">
                üî¥ Real-Time Streaming Control
            </div>
            <div class="config-dialog-body">
                <div style="margin-bottom: 15px;">
                    <div style="font-size: 12px; color: #888; margin-bottom: 5px;">STREAMING STATUS</div>
                    <div id="streamingModalStatus" style="padding: 12px; background: #1a1a1a; border-radius: 4px;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="font-size: 14px;">Status:</span>
                            <span id="streamModalStatusText" style="font-weight: 700; color: #ef4444;">Not Running</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-top: 8px;">
                            <span style="color: #888;">Subscriptions:</span>
                            <span id="streamSubCount" style="color: #fff;">0</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-top: 4px;">
                            <span style="color: #888;">Messages Received:</span>
                            <span id="streamMsgCount" style="color: #22c55e;">0</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-top: 4px;">
                            <span style="color: #888;">Connected Clients:</span>
                            <span id="streamClientCount" style="color: #60a5fa;">0</span>
                        </div>
                    </div>
                </div>

                <div style="margin-bottom: 15px;">
                    <div style="font-size: 12px; color: #888; margin-bottom: 5px;">SUBSCRIBE TO SYMBOLS</div>
                    <input type="text" id="streamSymbolsInput" class="config-input" placeholder="Enter symbols (e.g., AAPL, TSLA, NVDA)" value="">
                    <div style="display: flex; gap: 8px; margin-top: 8px;">
                        <label style="display: flex; align-items: center; gap: 4px; font-size: 12px;">
                            <input type="checkbox" id="streamQuotes" checked> Quotes
                        </label>
                        <label style="display: flex; align-items: center; gap: 4px; font-size: 12px;">
                            <input type="checkbox" id="streamTrades"> Trades
                        </label>
                        <label style="display: flex; align-items: center; gap: 4px; font-size: 12px;">
                            <input type="checkbox" id="streamBars"> Bars
                        </label>
                    </div>
                </div>

                <div style="margin-bottom: 15px;">
                    <div style="font-size: 12px; color: #888; margin-bottom: 5px;">ACTIVE SUBSCRIPTIONS</div>
                    <div id="activeSubscriptions" style="padding: 12px; background: #1a1a1a; border-radius: 4px; max-height: 150px; overflow-y: auto;">
                        <div style="color: #666; font-size: 12px;">No active subscriptions</div>
                    </div>
                </div>
            </div>
            <div class="config-dialog-footer">
                <button class="btn btn-secondary" onclick="subscribeToStream()">üì° Subscribe</button>
                <button class="btn btn-secondary" onclick="unsubscribeAll()">üîï Unsubscribe All</button>
                <button id="streamToggleBtn" class="btn btn-buy" onclick="toggleStreaming()">‚ñ∂ Start Stream</button>
                <button class="btn btn-secondary" onclick="closeStreamingModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- Broker/Account Switcher Modal -->
    <div id="brokerModal" class="config-dialog-overlay">
        <div class="config-dialog" style="min-width: 500px;">
            <div class="config-dialog-header">
                üè¶ Broker & Account Selection
            </div>
            <div class="config-dialog-body">
                <!-- Active Broker Selection -->
                <div style="margin-bottom: 20px;">
                    <div style="font-size: 12px; color: #888; margin-bottom: 8px;">ACTIVE TRADING BROKER</div>
                    <div style="display: flex; gap: 10px;">
                        <button id="brokerSchwabBtn" class="btn btn-secondary" onclick="selectBroker('schwab')" style="flex: 1; padding: 15px; border: 2px solid #00ff00; background: rgba(0, 255, 0, 0.1);">
                            <div style="font-size: 18px;">üíπ</div>
                            <div style="font-weight: bold;">Schwab</div>
                            <div style="font-size: 11px; color: #00ff00;">Primary Broker</div>
                        </button>
                    </div>
                </div>

                <!-- Schwab Account Selection (shown when Schwab selected) -->
                <div id="schwabAccountSection" style="display: none; margin-bottom: 15px;">
                    <div style="font-size: 12px; color: #888; margin-bottom: 8px;">SCHWAB ACCOUNT</div>
                    <select id="schwabAccountSelect" class="config-input" onchange="selectSchwabAccount()">
                        <option value="">Select account...</option>
                    </select>
                    <div id="schwabAccountInfo" style="margin-top: 10px; padding: 12px; background: #1a1a1a; border-radius: 4px; font-size: 13px;">
                        <div style="color: #666;">Select an account to view details</div>
                    </div>
                </div>

                <!-- Broker Status -->
                <div style="margin-top: 15px; padding: 12px; background: #1a1a1a; border-radius: 4px;">
                    <div style="font-size: 12px; color: #888; margin-bottom: 8px;">STATUS</div>
                    <div id="brokerStatusDetails" style="font-size: 13px;">
                        <div>Schwab: <span id="schwabConnectionStatus" style="color: #00ff00;">Connected</span></div>
                        <div>Data Source: <span id="dataSourceStatus" style="color: #00ff00;">Schwab</span></div>
                    </div>
                </div>
            </div>
            <div class="config-dialog-footer">
                <button class="btn btn-secondary" onclick="refreshBrokerStatus()">üîÑ Refresh</button>
                <button class="btn btn-secondary" onclick="closeBrokerModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- TV Desktop Watchlist Sync Modal -->
    <div id="tvSyncModal" class="config-dialog-overlay">
        <div class="config-dialog" style="min-width: 550px;">
            <div class="config-dialog-header">
                üîÑ Sync Watchlist to TradingView Desktop
            </div>
            <div class="config-dialog-body">
                <div style="margin-bottom: 15px;">
                    <div style="font-size: 12px; color: #888; margin-bottom: 5px;">SELECT WATCHLIST</div>
                    <select id="tvSyncWatchlistSelect" class="config-input" onchange="loadTVSyncWatchlist()">
                        <option value="">Loading watchlists...</option>
                    </select>
                </div>

                <div style="margin-bottom: 15px;">
                    <div style="font-size: 12px; color: #888; margin-bottom: 5px;">TRADINGVIEW FORMAT (Copy this to TV Desktop)</div>
                    <div style="position: relative;">
                        <textarea id="tvSyncOutput" class="config-input" rows="8" readonly style="font-family: monospace; font-size: 12px; resize: vertical;"></textarea>
                        <button onclick="copyTVSyncOutput()" style="position: absolute; top: 8px; right: 8px; padding: 4px 8px; background: #007acc; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 11px;">üìã Copy</button>
                    </div>
                    <div style="font-size: 11px; color: #666; margin-top: 5px;">
                        Format: EXCHANGE:SYMBOL (e.g., NASDAQ:AAPL)
                    </div>
                </div>

                <div style="padding: 12px; background: #1a1a1a; border-radius: 4px; margin-bottom: 15px;">
                    <div style="font-weight: 700; color: #007acc; margin-bottom: 8px;">üìã How to Import in TradingView Desktop</div>
                    <ol style="margin: 0; padding-left: 20px; color: #ccc; font-size: 12px; line-height: 1.8;">
                        <li>Click "Copy" button above</li>
                        <li>Open TradingView Desktop</li>
                        <li>Right-click on your watchlist panel</li>
                        <li>Select "Import List from Clipboard"</li>
                        <li>All symbols will be added to your watchlist!</li>
                    </ol>
                </div>

                <div style="display: flex; gap: 8px;">
                    <button class="btn btn-secondary" onclick="openAllInTVDesktop()" style="flex: 1;">
                        üñ•Ô∏è Open All in TV Desktop
                    </button>
                    <button class="btn btn-secondary" onclick="downloadTVWatchlistFile()" style="flex: 1;">
                        üíæ Download as File
                    </button>
                </div>
            </div>
            <div class="config-dialog-footer">
                <button class="btn btn-secondary" onclick="closeTVSyncModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- Scanner Modal -->
    <div id="scannerModal" class="config-dialog-overlay">
        <div class="config-dialog" style="min-width: 800px; max-width: 1000px;">
            <div class="config-dialog-header">
                üîç AI Stock Scanner & Working List
            </div>
            <div class="config-dialog-body" style="max-height: 70vh; overflow-y: auto;">
                <!-- Scanner Info -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                    <div style="padding: 12px; background: #1a1a1a; border-radius: 4px;">
                        <div style="font-size: 12px; color: #888; margin-bottom: 5px;">SCANNER STATUS</div>
                        <div id="scannerStatusInfo" style="font-size: 13px; color: #22c55e;">Loading...</div>
                    </div>
                    <div style="padding: 12px; background: #1a1a1a; border-radius: 4px;">
                        <div style="font-size: 12px; color: #888; margin-bottom: 5px;">WORKING LIST</div>
                        <div id="workingListCount" style="font-size: 13px; color: #60a5fa;">0 symbols</div>
                    </div>
                </div>

                <!-- Scanner Presets -->
                <div style="margin-bottom: 15px;">
                    <div style="font-size: 12px; color: #888; margin-bottom: 8px;">SCANNER PRESETS</div>
                    <div id="scannerPresetsList" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px;">
                        <!-- Dynamically populated -->
                    </div>
                </div>

                <!-- Quick Scan Buttons -->
                <div style="margin-bottom: 15px;">
                    <div style="font-size: 12px; color: #888; margin-bottom: 8px;">QUICK SCANS</div>
                    <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                        <button class="btn btn-secondary" onclick="runQuickScan('momentum')" style="flex: 1;">üöÄ Momentum</button>
                        <button class="btn btn-secondary" onclick="runQuickScan('gaps')" style="flex: 1;">üìà Gaps</button>
                        <button class="btn btn-secondary" onclick="runQuickScan('volume')" style="flex: 1;">üìä Volume</button>
                        <button class="btn btn-secondary" onclick="runQuickScan('breakout')" style="flex: 1;">üí• Breakout</button>
                        <button class="btn btn-secondary" onclick="runQuickScan('oversold')" style="flex: 1;">üìâ Oversold</button>
                    </div>
                </div>

                <!-- Scan Results -->
                <div style="margin-bottom: 15px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <div style="font-size: 12px; color: #888;">SCAN RESULTS</div>
                        <button class="btn btn-secondary" onclick="addAllToWorkingList()" style="font-size: 11px; padding: 4px 8px;">‚ûï Add All to Working List</button>
                    </div>
                    <div id="scanResultsContainer" style="max-height: 200px; overflow-y: auto; background: #1a1a1a; border-radius: 4px; padding: 8px;">
                        <div style="text-align: center; color: #666; padding: 20px;">Run a scan to see results</div>
                    </div>
                </div>

                <!-- Working List -->
                <div style="margin-bottom: 15px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <div style="font-size: 12px; color: #888;">AI WORKING LIST</div>
                        <div style="display: flex; gap: 8px;">
                            <button class="btn btn-secondary" onclick="syncWorkingListToWatchlist()" style="font-size: 11px; padding: 4px 8px;">üîÑ Sync to Watchlist</button>
                            <button class="btn btn-secondary" onclick="trainWorkingList()" style="font-size: 11px; padding: 4px 8px;">üß† Train AI</button>
                        </div>
                    </div>
                    <div id="workingListContainer" style="max-height: 200px; overflow-y: auto; background: #1a1a1a; border-radius: 4px; padding: 8px;">
                        <div style="text-align: center; color: #666; padding: 20px;">Loading working list...</div>
                    </div>
                </div>

                <!-- Manual Add -->
                <div style="padding: 12px; background: #1a1a1a; border-radius: 4px;">
                    <div style="font-size: 12px; color: #888; margin-bottom: 8px;">ADD SYMBOL MANUALLY</div>
                    <div style="display: flex; gap: 8px;">
                        <input type="text" id="manualAddSymbol" class="config-input" placeholder="Enter symbol (e.g., AAPL)" style="flex: 1; margin: 0;">
                        <button class="btn btn-buy" onclick="addSymbolToWorkingList()">‚ûï Add</button>
                    </div>
                </div>
            </div>
            <div class="config-dialog-footer">
                <button class="btn btn-secondary" onclick="refreshScannerPanel()">üîÑ Refresh</button>
                <button class="btn btn-secondary" onclick="closeScannerPanel()">Close</button>
            </div>
        </div>
    </div>

    <!-- Menu Bar - Redesigned with Nested Dropdowns -->
    <div class="menu-bar">
        <!-- FILE MENU -->
        <div class="menu-item" onclick="toggleDropdown('file-dropdown')">
            üìÅ FILE
            <div class="dropdown" id="file-dropdown" style="width: 220px;">
                <a href="#" onclick="event.preventDefault(); showSaveConfigDialog()">üíæ Save Configuration...</a>
                <a href="#" onclick="event.preventDefault(); setAsDefaultLayout()">‚≠ê Set as Default</a>
                <a href="#" onclick="event.preventDefault(); showManageConfigsDialog()">‚öôÔ∏è Manage Configs</a>
                <hr>
                <a href="#" onclick="event.preventDefault(); resetLayout()">üîÑ Reset Layout</a>
                <a href="#" onclick="event.preventDefault(); openNewDashboardInstance()">‚ûï New Window</a>
            </div>
        </div>

        <!-- LAYOUTS MENU -->
        <div class="menu-item" onclick="toggleDropdown('layouts-dropdown')">
            üìê LAYOUTS
            <div class="dropdown" id="layouts-dropdown">
                <a href="#" onclick="event.preventDefault(); loadLayout('default')">üìä Default</a>
                <a href="#" onclick="event.preventDefault(); loadLayout('trading')">‚ö° Trading</a>
                <a href="#" onclick="event.preventDefault(); loadLayout('analysis')">üìà Analysis</a>
                <a href="#" onclick="event.preventDefault(); loadLayout('scalping')">üéØ Scalping</a>
            </div>
        </div>

        <!-- CHARTS MENU -->
        <div class="menu-item" onclick="toggleDropdown('charts-dropdown')">
            üìä CHARTS
            <div class="dropdown" id="charts-dropdown" style="width: 200px;">
                <strong style="font-size: 10px;">Add Chart</strong>
                <a href="#" onclick="event.preventDefault(); addChartWithDefault('1')">1 Min</a>
                <a href="#" onclick="event.preventDefault(); addChartWithDefault('5')">5 Min</a>
                <a href="#" onclick="event.preventDefault(); addChartWithDefault('15')">15 Min</a>
                <a href="#" onclick="event.preventDefault(); addChartWithDefault('60')">1 Hour</a>
                <a href="#" onclick="event.preventDefault(); addChartWithDefault('D')">Daily</a>
                <hr>
                <strong style="font-size: 10px;">AI Charts (Lightweight)</strong>
                <a href="#" onclick="event.preventDefault(); openLWChart()">üìà AI Trade Chart</a>
                <a href="#" onclick="event.preventDefault(); openEquityCurve()">üí∞ Equity Curve</a>
                <a href="#" onclick="event.preventDefault(); openBacktestView()">üî¨ Backtest View</a>
                <hr>
                <a href="#" onclick="event.preventDefault(); showAddChartDialog()">üìã Templates...</a>
            </div>
        </div>

        <!-- TRADING VIEW MENU -->
        <div class="menu-item" onclick="toggleDropdown('tv-dropdown')" style="background: #2563eb;">
            üì∫ TV
            <div class="dropdown" id="tv-dropdown" style="width: 220px;">
                <strong style="font-size: 10px;">Open in TradingView</strong>
                <a href="#" onclick="event.preventDefault(); openTVDesktop(currentSymbol, '5')">üìä 5 Min Chart</a>
                <a href="#" onclick="event.preventDefault(); openTVDesktop(currentSymbol, '15')">üìä 15 Min Chart</a>
                <a href="#" onclick="event.preventDefault(); openTVDesktop(currentSymbol, 'D')">üìä Daily Chart</a>
                <hr>
                <a href="#" onclick="event.preventDefault(); openTVDesktopMulti()">üì∫ Open Watchlist</a>
                <a href="#" onclick="event.preventDefault(); copySymbolToClipboard()">üìã Copy Symbol</a>
                <hr>
                <strong style="font-size: 10px;">Webhooks</strong>
                <a href="#" onclick="event.preventDefault(); showWebhookInfo()">üîó Webhook Setup</a>
                <a href="#" onclick="event.preventDefault(); testWebhook()">üß™ Test Webhook</a>
            </div>
        </div>

        <!-- AI TOOLS MENU -->
        <div class="menu-item" onclick="toggleDropdown('ai-dropdown')" style="background: #1e40af;">
            ü§ñ AI
            <div class="dropdown" id="ai-dropdown" style="width: 280px;">
                <strong style="font-size: 10px;">üñ•Ô∏è OPEN IN SEPARATE WINDOW (for 2nd monitor)</strong>
                <a href="/dashboard?panel=ai" target="_blank">üéõÔ∏è AI Control Panel (Full Screen)</a>
                <a href="/ai-control" target="_blank">üìä AI Control Center</a>
                <hr>
                <strong style="font-size: 10px;">üìå EMBEDDED PANELS (in this window)</strong>
                <a href="#" onclick="event.preventDefault(); openAIControlPanel()">üéõÔ∏è AI Control Panel</a>
                <a href="#" onclick="event.preventDefault(); openAIMonitor()">üì° AI Monitor</a>
                <a href="#" onclick="event.preventDefault(); openNewsTraderPanel()">üì∞ Breaking News</a>
                <a href="#" onclick="event.preventDefault(); openAISignalsPanel()">üìä AI Signals (Watchlist)</a>
                <a href="#" onclick="event.preventDefault(); openWarriorPanel()" style="color: #ef4444;">‚öîÔ∏è Warrior Trading (Ross Cameron)</a>
                <hr>
                <strong style="font-size: 10px;">üîß TOOLS</strong>
                <a href="#" onclick="event.preventDefault(); openScannerPanel()">üîç Stock Scanner</a>
            </div>
        </div>

        <!-- TOOLS MENU -->
        <div class="menu-item" onclick="toggleDropdown('tools-dropdown')">
            üõ†Ô∏è TOOLS
            <div class="dropdown" id="tools-dropdown" style="width: 200px;">
                <a href="#" onclick="event.preventDefault(); openHotkeyPanel()">‚å®Ô∏è Hotkey Settings</a>
                <hr style="border-color: #333; margin: 4px 0;">
                <a href="#" onclick="event.preventDefault(); openScalpMonitor()">‚ö° Scalp Assistant</a>
                <a href="#" onclick="event.preventDefault(); openPDTMonitor()">‚öñÔ∏è PDT Monitor</a>
                <a href="#" onclick="event.preventDefault(); exportWatchlist()">‚¨áÔ∏è Export Watchlist</a>
                <a href="#" onclick="event.preventDefault(); copyWatchlistToClipboard()">üìã Copy Watchlist</a>
            </div>
        </div>

        <!-- CONNECT BUTTON -->
        <div class="menu-item" onclick="connectToSchwab()" style="background: #059669;">
            üîå CONNECT SCHWAB
        </div>

        <!-- AI CONTROL PANEL - OPEN IN NEW WINDOW -->
        <a href="/dashboard?panel=ai" target="_blank" class="menu-item" style="background: #7c3aed; text-decoration: none; color: white;">
            üéõÔ∏è AI PANEL ‚Üó
        </a>
    </div>

    <!-- Workspace -->
    <div class="workspace" id="workspace"></div>

    <!-- Configuration Dialogs -->
    <div class="config-dialog-overlay" id="saveConfigDialog">
        <div class="config-dialog">
            <div class="config-dialog-header">üíæ Save Configuration</div>
            <div class="config-dialog-body">
                <label style="display: block; margin-bottom: 8px; color: #888; font-size: 14px;">Configuration Name:</label>
                <input type="text" class="config-input" id="configNameInput" placeholder="e.g., My Trading Setup" />
                <div style="font-size: 12px; color: #666; margin-top: 5px;">
                    This will save the current window layout and watchlist.
                </div>
            </div>
            <div class="config-dialog-footer">
                <button class="btn btn-secondary" onclick="closeSaveConfigDialog()">Cancel</button>
                <button class="btn btn-buy" onclick="saveConfiguration()">üíæ Save</button>
            </div>
        </div>
    </div>

    <div class="config-dialog-overlay" id="manageConfigsDialog">
        <div class="config-dialog">
            <div class="config-dialog-header">‚öôÔ∏è Manage Configurations</div>
            <div class="config-dialog-body">
                <div id="manageConfigsList">
                    <!-- Dynamically populated -->
                </div>
                <div id="noConfigsMessage" style="text-align: center; padding: 40px 20px; color: #666;">
                    No saved configurations yet.<br>
                    <small>Save your first configuration from the CONFIGURATIONS menu!</small>
                </div>
            </div>
            <div class="config-dialog-footer">
                <button class="btn btn-secondary" onclick="closeManageConfigsDialog()">Close</button>
            </div>
        </div>
    </div>

    <div class="config-dialog-overlay" id="addChartDialog">
        <div class="config-dialog">
            <div class="config-dialog-header">üìä Add Chart</div>
            <div class="config-dialog-body">
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 8px; color: #888; font-size: 14px;">Chart Template:</label>
                    <select class="config-input" id="chartTemplate" onchange="updateTemplateDescription()">
                        <option value="default">Default (5m) - SMA + RSI</option>
                        <option value="scalping">Scalping (1m) - EMA + VWAP + MACD</option>
                        <option value="daytrading">Day Trading (5m) - EMA + VWAP + RSI + Vol</option>
                        <option value="swing">Swing (1H) - SMA + RSI + MACD + BB</option>
                        <option value="momentum">Momentum (15m) - EMA + RSI + MACD + VWAP</option>
                        <option value="volume">Volume Profile (5m) - VWAP + Volume + SMA</option>
                        <option value="clean">Clean - Price Only (No Indicators)</option>
                        <option value="warrior">Warrior Trading (1m) - 9 EMA + VWAP + Volume</option>
                    </select>
                </div>
                <div id="templateDescription" style="background: #1e1e1e; border: 1px solid #333; padding: 10px; border-radius: 4px; margin-bottom: 15px; font-size: 12px;">
                    <div style="color: #60a5fa; font-weight: 600; margin-bottom: 5px;">Template Details:</div>
                    <div id="templateDetails" style="color: #888;">SMA + RSI on 5-minute timeframe</div>
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 8px; color: #888; font-size: 14px;">Custom Timeframe (Optional):</label>
                    <select class="config-input" id="chartTimeframe">
                        <option value="" selected>Use Template Default</option>
                        <option value="1">1 Minute</option>
                        <option value="5">5 Minutes</option>
                        <option value="15">15 Minutes</option>
                        <option value="30">30 Minutes</option>
                        <option value="60">1 Hour</option>
                        <option value="240">4 Hours</option>
                        <option value="D">Daily</option>
                        <option value="W">Weekly</option>
                        <option value="M">Monthly</option>
                    </select>
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 8px; color: #888; font-size: 14px;">Chart Style:</label>
                    <select class="config-input" id="chartStyle">
                        <option value="1" selected>Candles</option>
                        <option value="0">Bars</option>
                        <option value="9">Heikin Ashi</option>
                        <option value="3">Line</option>
                        <option value="8">Area</option>
                    </select>
                </div>
                <div style="font-size: 12px; color: #666; margin-top: 10px;">
                    Chart will be created for current symbol: <span id="chartSymbolPreview" style="color: #007acc; font-weight: 700;">AAPL</span>
                </div>
            </div>
            <div class="config-dialog-footer">
                <button class="btn btn-secondary" onclick="closeAddChartDialog()">Cancel</button>
                <button class="btn btn-buy" onclick="createCustomChart()">üìä Add Chart</button>
            </div>
        </div>
    </div>

    <!-- Create Custom Template Dialog -->
    <div class="config-dialog-overlay" id="createTemplateDialog">
        <div class="config-dialog" style="max-width: 550px;">
            <div class="config-dialog-header">üé® Create Custom Chart Template</div>
            <div class="config-dialog-body">
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 8px; color: #888; font-size: 14px;">Template Name:</label>
                    <input type="text" class="config-input" id="newTemplateName" placeholder="My Trading Setup">
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 8px; color: #888; font-size: 14px;">Default Timeframe:</label>
                    <select class="config-input" id="newTemplateTimeframe">
                        <option value="1">1 Minute</option>
                        <option value="5" selected>5 Minutes</option>
                        <option value="15">15 Minutes</option>
                        <option value="30">30 Minutes</option>
                        <option value="60">1 Hour</option>
                        <option value="240">4 Hours</option>
                        <option value="D">Daily</option>
                        <option value="W">Weekly</option>
                    </select>
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 8px; color: #888; font-size: 14px;">Chart Style:</label>
                    <select class="config-input" id="newTemplateStyle">
                        <option value="1" selected>Candles</option>
                        <option value="0">Bars</option>
                        <option value="9">Heikin Ashi</option>
                        <option value="3">Line</option>
                    </select>
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 8px; color: #888; font-size: 14px;">Select Indicators:</label>
                    <div id="indicatorCheckboxes" style="max-height: 200px; overflow-y: auto; background: #1e1e1e; border: 1px solid #333; border-radius: 4px; padding: 10px;">
                        <!-- Populated by JS -->
                    </div>
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: flex; align-items: center; gap: 8px; color: #60a5fa; cursor: pointer;">
                        <input type="checkbox" id="setAsTimeframeDefault" style="width: 16px; height: 16px;">
                        <span>Set as default for this timeframe</span>
                    </label>
                </div>
            </div>
            <div class="config-dialog-footer">
                <button class="btn btn-secondary" onclick="closeCreateTemplateDialog()">Cancel</button>
                <button class="btn btn-buy" onclick="saveNewTemplate()">üíæ Save Template</button>
            </div>
        </div>
    </div>

    <!-- Manage Templates Dialog -->
    <div class="config-dialog-overlay" id="manageTemplatesDialog">
        <div class="config-dialog" style="max-width: 600px;">
            <div class="config-dialog-header">üìã Manage Chart Templates</div>
            <div class="config-dialog-body">
                <div style="margin-bottom: 15px;">
                    <div style="color: #60a5fa; font-weight: 600; margin-bottom: 10px;">Timeframe Defaults:</div>
                    <div id="timeframeDefaultsList" style="background: #1e1e1e; border: 1px solid #333; border-radius: 4px; padding: 10px; margin-bottom: 15px;">
                        <!-- Populated by JS -->
                    </div>
                </div>
                <div style="margin-bottom: 15px;">
                    <div style="color: #60a5fa; font-weight: 600; margin-bottom: 10px;">Custom Templates:</div>
                    <div id="customTemplatesList" style="background: #1e1e1e; border: 1px solid #333; border-radius: 4px; padding: 10px; max-height: 300px; overflow-y: auto;">
                        <!-- Populated by JS -->
                    </div>
                </div>
            </div>
            <div class="config-dialog-footer">
                <button class="btn btn-buy" onclick="showCreateTemplateDialog()" style="margin-right: auto;">+ New Template</button>
                <button class="btn btn-secondary" onclick="closeManageTemplatesDialog()">Close</button>
            </div>
        </div>
    </div>

    <!-- TradingView Webhook Info Dialog -->
    <div class="config-dialog-overlay" id="webhookInfoDialog">
        <div class="config-dialog" style="max-width: 700px;">
            <div class="config-dialog-header">‚ö° TradingView Webhook Setup</div>
            <div class="config-dialog-body">
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 8px; color: #007acc; font-size: 14px; font-weight: 700;">Webhook URL:</label>
                    <div style="display: flex; gap: 5px;">
                        <input type="text" class="config-input" id="webhookUrl" readonly value="http://127.0.0.1:9101/api/tradingview/webhook" style="flex: 1; font-family: monospace; font-size: 13px;">
                        <button class="btn btn-secondary" onclick="copyWebhookUrl()" style="padding: 10px 15px;">üìã Copy</button>
                    </div>
                </div>
                <div style="background: #1a1a1a; border: 1px solid #333; border-radius: 4px; padding: 15px; margin-bottom: 15px;">
                    <div style="font-size: 13px; color: #888; font-weight: 700; margin-bottom: 10px;">ALERT MESSAGE FORMAT:</div>
                    <pre style="background: #252525; padding: 10px; border-radius: 3px; font-size: 12px; color: #22c55e; overflow-x: auto; margin: 0;">{
  "action": "{{strategy.order.action}}",
  "symbol": "{{ticker}}",
  "price": {{close}},
  "confidence": 0.85,
  "target": {{close}} * 1.05,
  "stop": {{close}} * 0.98
}</pre>
                </div>
                <div style="font-size: 12px; color: #666;">
                    <strong style="color: #007acc;">Setup Steps:</strong><br>
                    1. Open TradingView Desktop<br>
                    2. Create an alert on your chart<br>
                    3. Set "Webhook URL" to the URL above<br>
                    4. Paste the alert message format<br>
                    5. Test with the "Test Webhook" button below
                </div>
            </div>
            <div class="config-dialog-footer">
                <button class="btn btn-secondary" onclick="closeWebhookInfoDialog()">Close</button>
                <button class="btn btn-buy" onclick="openTradingViewSetupGuide()">üìö Full Guide</button>
            </div>
        </div>
    </div>

    <!-- TradingView Webhook Logs Dialog -->
    <div class="config-dialog-overlay" id="webhookLogsDialog">
        <div class="config-dialog" style="max-width: 800px;">
            <div class="config-dialog-header">üìä Webhook Activity Logs</div>
            <div class="config-dialog-body">
                <div id="webhookLogsList" style="max-height: 400px; overflow-y: auto; font-family: monospace; font-size: 12px;">
                    <div style="text-align: center; padding: 40px; color: #666;">
                        Loading webhook logs...
                    </div>
                </div>
            </div>
            <div class="config-dialog-footer">
                <button class="btn btn-danger" onclick="clearWebhookLogs()">üóëÔ∏è Clear Logs</button>
                <button class="btn btn-secondary" onclick="closeWebhookLogsDialog()">Close</button>
                <button class="btn btn-buy" onclick="refreshWebhookLogs()">üîÑ Refresh</button>
            </div>
        </div>
    </div>

    <!-- Halt Indicator (DISABLED - Now in quote window) -->
    <div id="haltIndicator" style="display: none;"></div>

    <style>
        @keyframes pulse {
            0%, 100% { opacity: 1; transform: translateX(-50%) scale(1); }
            50% { opacity: 0.85; transform: translateX(-50%) scale(1.02); }
        }
    </style>

    <!-- Layout Controls -->
    <div class="layout-controls">
        <button class="layout-btn" onclick="tileWindows()">‚äû Tile</button>
        <button class="layout-btn" onclick="cascadeWindows()">‚ßâ Cascade</button>
        <button class="layout-btn" onclick="minimizeAll()">‚ñº Min All</button>
        <button class="layout-btn" onclick="restoreAll()">‚ñ≤ Restore</button>
    </div>

    <script>
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        //           MULTI-DASHBOARD INSTANCE SUPPORT (MUST BE FIRST!)
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        // Get current instance ID from URL or use default
        function getDashboardInstanceId() {
            const params = new URLSearchParams(window.location.search);
            return params.get('instance') || 'default';
        }

        // Get storage key with instance prefix
        function getStorageKey(key) {
            const instanceId = getDashboardInstanceId();
            return instanceId === 'default' ? key : `${instanceId}_${key}`;
        }

        // Override localStorage methods for instance isolation BEFORE any code runs
        (function initInstanceIsolation() {
            const originalGetItem = localStorage.getItem.bind(localStorage);
            const originalSetItem = localStorage.setItem.bind(localStorage);
            const originalRemoveItem = localStorage.removeItem.bind(localStorage);

            // Keys that should be isolated per instance
            const instanceKeys = ['watchlist', 'customLayout', 'tradingLayout', 'currentSymbol'];

            localStorage.getItem = function(key) {
                if (instanceKeys.includes(key)) {
                    return originalGetItem(getStorageKey(key));
                }
                return originalGetItem(key);
            };

            localStorage.setItem = function(key, value) {
                if (instanceKeys.includes(key)) {
                    return originalSetItem(getStorageKey(key), value);
                }
                return originalSetItem(key, value);
            };

            localStorage.removeItem = function(key) {
                if (instanceKeys.includes(key)) {
                    return originalRemoveItem(getStorageKey(key));
                }
                return originalRemoveItem(key);
            };

            // Update window title with instance info
            const instanceId = getDashboardInstanceId();
            if (instanceId !== 'default') {
                document.title = `Trading Platform - Instance ${instanceId.split('_')[1]}`;
            }

            console.log(`Dashboard Instance: ${instanceId}`);
        })();

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        //              GLOBAL UTILITY FUNCTIONS (MUST BE EARLY)
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        // Toast notification system
        function showNotification(message, type = 'info') {
            // Remove existing notifications
            const existing = document.getElementById('toast-notification');
            if (existing) existing.remove();

            // Create notification element
            const toast = document.createElement('div');
            toast.id = 'toast-notification';

            // Color schemes for different types
            const colors = {
                success: { bg: '#14532d', border: '#22c55e', text: '#22c55e' },
                error: { bg: '#450a0a', border: '#ef4444', text: '#ef4444' },
                warning: { bg: '#451a03', border: '#f59e0b', text: '#f59e0b' },
                info: { bg: '#1e3a5f', border: '#3b82f6', text: '#3b82f6' }
            };
            const color = colors[type] || colors.info;

            toast.style.cssText = `
                position: fixed;
                bottom: 20px;
                right: 20px;
                background: ${color.bg};
                border: 1px solid ${color.border};
                color: ${color.text};
                padding: 12px 20px;
                border-radius: 6px;
                font-size: 13px;
                font-weight: 500;
                z-index: 99999;
                box-shadow: 0 4px 12px rgba(0,0,0,0.4);
                animation: slideIn 0.3s ease;
                max-width: 400px;
            `;
            toast.textContent = message;

            // Add animation style if not exists
            if (!document.getElementById('toast-styles')) {
                const style = document.createElement('style');
                style.id = 'toast-styles';
                style.textContent = `
                    @keyframes slideIn {
                        from { transform: translateX(100%); opacity: 0; }
                        to { transform: translateX(0); opacity: 1; }
                    }
                    @keyframes slideOut {
                        from { transform: translateX(0); opacity: 1; }
                        to { transform: translateX(100%); opacity: 0; }
                    }
                `;
                document.head.appendChild(style);
            }

            document.body.appendChild(toast);

            // Auto-remove after 3 seconds
            setTimeout(() => {
                toast.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // Dropdown menu functionality - must be global for onclick handlers
        function toggleDropdown(dropdownId) {
            const dropdown = document.getElementById(dropdownId);
            const allDropdowns = document.querySelectorAll('.dropdown');

            // Close all other dropdowns
            allDropdowns.forEach(d => {
                if (d.id !== dropdownId) {
                    d.classList.remove('show');
                }
            });

            // Toggle the clicked dropdown
            if (dropdown) {
                dropdown.classList.toggle('show');
            }

            // Prevent event bubbling
            if (event) {
                event.stopPropagation();
            }
        }

        // Close dropdowns when clicking outside
        document.addEventListener('click', function(event) {
            if (!event.target.closest('.menu-item')) {
                document.querySelectorAll('.dropdown').forEach(d => {
                    d.classList.remove('show');
                });
            }
        });

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        //                     GLOBAL STATE
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        let windows = [];
        let activeWindow = null;
        let zIndexCounter = 100;
        let currentSymbol = 'AAPL';
        let watchlist = ['AAPL', 'MSFT', 'GOOGL', 'TSLA', 'NVDA', 'SPY', 'QQQ'];

        // CENTRALIZED MARKET DATA STORE - Single source of truth for all prices
        const marketDataStore = {
            data: {},
            subscribers: [],

            update(symbol, newData) {
                const existing = this.data[symbol] || {};
                this.data[symbol] = {
                    ...existing,
                    ...newData,
                    timestamp: Date.now()
                };
                this.notifySubscribers(symbol);
                // Also update legacy cache for compatibility
                marketDataCache[symbol] = this.data[symbol];
            },

            get(symbol) {
                return this.data[symbol] || null;
            },

            subscribe(callback) {
                this.subscribers.push(callback);
            },

            notifySubscribers(symbol) {
                const data = this.data[symbol];
                this.subscribers.forEach(callback => {
                    try { callback(symbol, data); } catch (e) { console.error('[SYNC]', e); }
                });
            },

            isFresh(symbol) {
                const data = this.data[symbol];
                return data && data.timestamp && (Date.now() - data.timestamp) < 5000;
            }
        };

        // UNIFIED REFRESH SYSTEM - Updates store and notifies all components
        let unifiedRefreshInterval = null;

        function startUnifiedRefresh() {
            // Clear any existing interval
            if (unifiedRefreshInterval) {
                clearInterval(unifiedRefreshInterval);
            }

            // Refresh every 10 seconds to prevent resource exhaustion
            unifiedRefreshInterval = setInterval(async () => {
                if (currentSymbol) {
                    await fetchAndUpdateStore(currentSymbol);
                }
            }, 10000);
        }

        async function fetchAndUpdateStore(symbol) {
            try {
                const apiData = await apiFetch(`/api/price/${symbol}`);
                if (apiData && apiData.data) {
                    const d = apiData.data;
                    marketDataStore.update(symbol, {
                        last: d.last,
                        bid: d.bid,
                        ask: d.ask,
                        volume: d.volume,
                        high: d.high,
                        low: d.low,
                        open: d.open,
                        close: d.close,
                        bidSize: d.bidSize,
                        askSize: d.askSize,
                        change: d.change,
                        changePercent: d.changePercent
                    });
                    console.log(`[SYNC] ${symbol} updated from unified refresh: $${d.last?.toFixed(2)}`);
                }
            } catch (error) {
                console.error('[SYNC] Error in unified refresh:', error);
            }
        }

        async function refreshWorklistPrices() {
            try {
                const response = await fetch(API_BASE_URL + '/api/worklist');
                const result = await response.json();
                if (result.success && result.data) {
                    result.data.forEach(item => {
                        marketDataStore.update(item.symbol, {
                            last: item.price || item.current_price || 0,
                            bid: item.bid,
                            ask: item.ask,
                            volume: item.volume,
                            change: item.change,
                            change_percent: item.change_percent
                        });
                    });
                }
            } catch (error) {
                console.error('[SYNC] Error refreshing worklist:', error);
            }
        }

        // Subscribe all components to store updates
        marketDataStore.subscribe((symbol, data) => {
            // Update Quote panel if this is current symbol
            if (symbol === currentSymbol) {
                updateQuotePanelFromStore(symbol, data);
                updateOrderPanelFromStore(symbol, data);
            }

            // Update worklist row for this symbol
            updateWorklistRowFromStore(symbol, data);
        });

        function updateQuotePanelFromStore(symbol, data) {
            if (!data) return;

            safeUpdate('bidPrice', data.bid?.toFixed(2) || '--');
            safeUpdate('askPrice', data.ask?.toFixed(2) || '--');
            safeUpdate('lastPrice', data.last?.toFixed(2) || '--');
            safeUpdate('volumePrice', data.volume?.toLocaleString() || '--');
            safeUpdate('highPrice', data.high?.toFixed(2) || '--');
            safeUpdate('lowPrice', data.low?.toFixed(2) || '--');
            safeUpdate('openPrice', data.open?.toFixed(2) || '--');
            safeUpdate('closePrice', data.close?.toFixed(2) || '--');

            if (data.bid) safeUpdate('bidSize', `x ${data.bidSize || 0}`);
            if (data.ask) safeUpdate('askSize', `x ${data.askSize || 0}`);

            // Calculate and display change
            if (data.last && data.close) {
                const change = data.last - data.close;
                const changePct = ((change / data.close) * 100).toFixed(2);
                const changeEl = document.getElementById('priceChange');
                if (changeEl) {
                    changeEl.textContent = `${change >= 0 ? '+' : ''}${change.toFixed(2)} (${changePct}%)`;
                    changeEl.className = change >= 0 ? 'quote-stat-label positive' : 'quote-stat-label negative';
                }
            }
        }

        function updateOrderPanelFromStore(symbol, data) {
            if (!data) return;

            safeUpdate('marketBid', data.bid?.toFixed(2) || '--');
            safeUpdate('marketLast', data.last?.toFixed(2) || '--');
            safeUpdate('marketAsk', data.ask?.toFixed(2) || '--');

            // Auto-set limit price to mid (only if field is not focused and empty/invalid)
            const orderTypeEl = document.getElementById('orderType');
            const orderPriceEl = document.getElementById('orderPrice');
            if (data.bid && data.ask && data.bid > 0 && data.ask > 0 && orderTypeEl && orderTypeEl.value === 'LIMIT') {
                if (document.activeElement !== orderPriceEl &&
                    (!orderPriceEl.value || orderPriceEl.value === '' || parseFloat(orderPriceEl.value) <= 0)) {
                    const mid = ((data.bid + data.ask) / 2).toFixed(2);
                    safeUpdate('orderPrice', mid);
                }
            }
        }

        function updateWorklistRowFromStore(symbol, data) {
            if (!data) return;

            // Find the row in worklist table
            const rows = document.querySelectorAll('#worklistDisplay tbody tr');
            rows.forEach(row => {
                const symbolCell = row.querySelector('td:first-child');
                if (symbolCell && symbolCell.textContent.includes(symbol)) {
                    // Update price cell (second column)
                    const priceCell = row.querySelector('td:nth-child(2)');
                    if (priceCell && data.last) {
                        const isFresh = marketDataStore.isFresh(symbol);
                        const liveIndicator = isFresh ? '<span style="color: #22c55e; margin-left: 4px;" title="Live data">üü¢</span>' :
                                              '<span style="color: #eab308; margin-left: 4px;" title="Delayed">üü°</span>';
                        priceCell.innerHTML = `${data.last.toFixed(2)}${liveIndicator}`;

                        // Add flash animation
                        priceCell.classList.add('price-flash');
                        setTimeout(() => priceCell.classList.remove('price-flash'), 500);
                    }

                    // Update change cell (third column)
                    const changeCell = row.querySelector('td:nth-child(3)');
                    if (changeCell && data.change_percent !== undefined) {
                        const changeClass = data.change_percent >= 0 ? 'positive' : 'negative';
                        changeCell.innerHTML = `<span class="${changeClass}">${data.change_percent.toFixed(2)}%</span>`;
                    }
                }
            });
        }

        let marketDataCache = {}; // Legacy cache
        let positionsCache = [];
        let apiAvailable = null; // null = unknown, true = available, false = demo mode
        let demoModeLogged = false;
        // Use same host as page is served from to avoid CORS/fetch issues
        const API_BASE_URL = window.location.origin || 'http://127.0.0.1:9100';

        // Halt Detection State
        let haltState = {
            isHalted: false,
            haltTime: null,
            haltPrice: null,
            resumeTime: null,
            lastUpdateTime: null,
            symbol: null
        };

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        //                     WINDOW MANAGEMENT
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        class DraggableWindow {
            constructor(id, title, content, x, y, width, height) {
                this.id = id;
                this.title = title;
                this.x = x;
                this.y = y;
                this.width = width;
                this.height = height;
                this.minimized = false;
                this.maximized = false;
                this.savedState = null;
                this.element = null;
                this.create(content);
            }

            create(content) {
                const win = document.createElement('div');
                win.className = 'window';
                win.id = `window-${this.id}`;
                win.style.left = this.x + 'px';
                win.style.top = this.y + 'px';
                win.style.width = this.width + 'px';
                win.style.height = this.height + 'px';
                win.style.zIndex = ++zIndexCounter;

                // Add chart controls to header for chart windows
                let chartControls = '';
                if (this.id.startsWith('chart')) {
                    const chartId = this.id.replace('chart', '');
                    chartControls = `
                        <div class="chart-header-controls" style="display: flex; align-items: center; gap: 6px; margin-left: 8px;">
                            <button id="chart-link-${chartId}" class="chart-link-btn linked" onclick="event.stopPropagation(); toggleChartLink('${chartId}')" title="Click to unlink">üîó</button>
                            <input type="text" id="chart-symbol-${chartId}" class="chart-symbol-input"
                                   style="width: 60px; padding: 2px 5px; background: #2a2a2a; border: 1px solid #444; border-radius: 3px; color: #22c55e; font-size: 11px; font-weight: bold; text-transform: uppercase; display: none;"
                                   onclick="event.stopPropagation()"
                                   onkeypress="if(event.key==='Enter') setChartSymbol('${chartId}', this.value)"
                            />
                            <span id="chart-symbol-display-${chartId}" style="color: #22c55e; font-weight: bold; font-size: 11px;"></span>
                            <select id="chart-template-${chartId}" class="chart-template-select"
                                    style="padding: 2px 4px; background: #2a2a2a; border: 1px solid #444; border-radius: 3px; color: #60a5fa; font-size: 10px; cursor: pointer; max-width: 100px;"
                                    onclick="event.stopPropagation(); refreshChartTemplateDropdown('${chartId}')"
                                    onchange="changeChartTemplate('${chartId}', this.value)"
                                    title="Select chart template">
                                <!-- Options populated dynamically -->
                            </select>
                        </div>
                    `;
                }

                win.innerHTML = `
                    <div class="window-header">
                        <span>${this.title}</span>
                        ${chartControls}
                        <div class="window-controls">
                            <div class="window-btn minimize" onclick="minimizeWindow('${this.id}')">‚àí</div>
                            <div class="window-btn maximize" onclick="maximizeWindow('${this.id}')">‚ñ°</div>
                            <div class="window-btn close" onclick="closeWindow('${this.id}')">√ó</div>
                        </div>
                    </div>
                    <div class="window-content">${content}</div>
                    <div class="resize-handle n"></div>
                    <div class="resize-handle s"></div>
                    <div class="resize-handle e"></div>
                    <div class="resize-handle w"></div>
                    <div class="resize-handle ne"></div>
                    <div class="resize-handle nw"></div>
                    <div class="resize-handle se"></div>
                    <div class="resize-handle sw"></div>
                `;

                this.element = win;
                document.getElementById('workspace').appendChild(win);
                this.setupDrag();
                this.setupResize();
                win.addEventListener('mousedown', () => this.activate());
            }

            setupDrag() {
                const header = this.element.querySelector('.window-header');
                let isDragging = false;
                let startX, startY, startLeft, startTop;

                header.addEventListener('mousedown', (e) => {
                    if (e.target.classList.contains('window-btn')) return;
                    isDragging = true;
                    startX = e.clientX;
                    startY = e.clientY;
                    startLeft = this.x;
                    startTop = this.y;
                    this.activate();
                });

                document.addEventListener('mousemove', (e) => {
                    if (!isDragging) return;
                    this.x = startLeft + e.clientX - startX;
                    this.y = startTop + e.clientY - startY;
                    this.element.style.left = this.x + 'px';
                    this.element.style.top = this.y + 'px';
                });

                document.addEventListener('mouseup', () => isDragging = false);
            }

            setupResize() {
                const handles = this.element.querySelectorAll('.resize-handle');
                handles.forEach(handle => {
                    let isResizing = false;
                    let startX, startY, startWidth, startHeight, startLeft, startTop;
                    const direction = handle.className.split(' ')[1];

                    handle.addEventListener('mousedown', (e) => {
                        e.stopPropagation();
                        isResizing = true;
                        startX = e.clientX;
                        startY = e.clientY;
                        startWidth = this.width;
                        startHeight = this.height;
                        startLeft = this.x;
                        startTop = this.y;
                        this.activate();
                    });

                    document.addEventListener('mousemove', (e) => {
                        if (!isResizing) return;
                        const dx = e.clientX - startX;
                        const dy = e.clientY - startY;

                        if (direction.includes('e')) this.width = Math.max(200, startWidth + dx);
                        if (direction.includes('w')) {
                            const newWidth = Math.max(200, startWidth - dx);
                            if (newWidth > 200) {
                                this.width = newWidth;
                                this.x = startLeft + dx;
                            }
                        }
                        if (direction.includes('s')) this.height = Math.max(150, startHeight + dy);
                        if (direction.includes('n')) {
                            const newHeight = Math.max(150, startHeight - dy);
                            if (newHeight > 150) {
                                this.height = newHeight;
                                this.y = startTop + dy;
                            }
                        }

                        this.updatePosition();
                    });

                    document.addEventListener('mouseup', () => isResizing = false);
                });
            }

            updatePosition() {
                this.element.style.left = this.x + 'px';
                this.element.style.top = this.y + 'px';
                this.element.style.width = this.width + 'px';
                this.element.style.height = this.height + 'px';
            }

            activate() {
                windows.forEach(w => w.element.classList.remove('active'));
                this.element.classList.add('active');
                this.element.style.zIndex = ++zIndexCounter;
                activeWindow = this;
            }

            minimize() {
                if (!this.minimized) {
                    this.element.style.display = 'none';
                    this.minimized = true;
                }
            }

            restore() {
                if (this.minimized) {
                    this.element.style.display = 'flex';
                    this.minimized = false;
                    this.activate();
                }
                if (this.maximized) {
                    if (this.savedState) {
                        this.x = this.savedState.x;
                        this.y = this.savedState.y;
                        this.width = this.savedState.width;
                        this.height = this.savedState.height;
                        this.updatePosition();
                    }
                    this.maximized = false;
                }
            }

            maximize() {
                if (!this.maximized) {
                    this.savedState = { x: this.x, y: this.y, width: this.width, height: this.height };
                    const workspace = document.getElementById('workspace');
                    this.x = 0;
                    this.y = 0;
                    this.width = workspace.clientWidth;
                    this.height = workspace.clientHeight;
                    this.updatePosition();
                    this.maximized = true;
                } else {
                    this.restore();
                }
            }

            close() {
                this.element.remove();
                windows = windows.filter(w => w.id !== this.id);
            }
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        //                     WINDOW TEMPLATES
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        const windowTemplates = {
            quote: `
                <!-- Condensed Quote Display -->
                <div style="padding: 8px; display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; font-size: 11px;">
                    <div style="text-align: center;">
                        <div style="color: #666; font-size: 9px; margin-bottom: 2px;">BID</div>
                        <div id="bidPrice" style="color: #ef4444; font-weight: 700; font-size: 13px;">--</div>
                        <div id="bidSize" style="color: #666; font-size: 9px;">--</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="color: #666; font-size: 9px; margin-bottom: 2px;">LAST</div>
                        <div id="lastPrice" style="color: #60a5fa; font-weight: 700; font-size: 13px;">--</div>
                        <div id="priceChange" style="font-size: 9px;">--</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="color: #666; font-size: 9px; margin-bottom: 2px;">ASK</div>
                        <div id="askPrice" style="color: #22c55e; font-weight: 700; font-size: 13px;">--</div>
                        <div id="askSize" style="color: #666; font-size: 9px;">--</div>
                    </div>
                </div>

                <!-- Secondary Stats -->
                <div style="padding: 0 8px 8px 8px; display: grid; grid-template-columns: repeat(4, 1fr); gap: 4px; font-size: 10px; border-top: 1px solid #333;">
                    <div style="text-align: center; padding-top: 4px;">
                        <div style="color: #666; font-size: 10px;">VOL</div>
                        <div id="volumePrice" style="color: #aaa; font-weight: 600; font-size: 12px;">--</div>
                    </div>
                    <div style="text-align: center; padding-top: 4px;">
                        <div style="color: #666; font-size: 10px;">HIGH</div>
                        <div id="highPrice" style="color: #aaa; font-weight: 600; font-size: 12px;">--</div>
                    </div>
                    <div style="text-align: center; padding-top: 4px;">
                        <div style="color: #666; font-size: 10px;">LOW</div>
                        <div id="lowPrice" style="color: #aaa; font-weight: 600; font-size: 12px;">--</div>
                    </div>
                    <div style="text-align: center; padding-top: 4px;">
                        <div style="color: #666; font-size: 10px;">OPEN</div>
                        <div id="openPrice" style="color: #aaa; font-weight: 600; font-size: 12px;">--</div>
                    </div>
                </div>

                <!-- Halt Indicator -->
                <div style="padding: 0 8px 8px 8px;">
                    <div id="quoteHaltIndicator" style="display: none; padding: 4px; border-radius: 3px; text-align: center; background: #dc2626; color: white; font-size: 11px;">
                        <span id="quoteHaltTitle" style="font-weight: bold;">üõë HALT</span>
                        <span id="quoteHaltInfo" style="font-size: 9px; margin-left: 6px;"></span>
                    </div>
                </div>

                <!-- Asset Status Indicators (ETB/HTB/Shortable) -->
                <div id="assetStatusRow" style="display: flex; gap: 6px; padding: 0 8px 8px 8px; flex-wrap: wrap;">
                    <div id="shortableIndicator" style="display: none; padding: 2px 6px; border-radius: 3px; font-size: 10px; font-weight: 600;"></div>
                    <div id="borrowIndicator" style="display: none; padding: 2px 6px; border-radius: 3px; font-size: 10px; font-weight: 600;"></div>
                    <div id="marginIndicator" style="display: none; padding: 2px 6px; border-radius: 3px; font-size: 10px; font-weight: 600;"></div>
                </div>
            `,

            level2: `
                <div id="luld-indicator" style="display: none; padding: 4px 8px; background: #1a1a1a; border-bottom: 1px solid #333; font-size: 11px;">
                    <span style="color: #888;">LULD:</span>
                    <span style="color: #22c55e;">‚ñ≤ <span id="luld-upper">--</span></span>
                    <span style="margin-left: 12px; color: #ef4444;">‚ñº <span id="luld-lower">--</span></span>
                </div>
                <div class="level2-container">
                    <div class="level2-column">
                        <div class="level2-header">
                            <div>MM</div>
                            <div>SIZE</div>
                            <div>BID</div>
                            <div>ORD</div>
                        </div>
                        <div id="bidsDisplay"></div>
                    </div>
                    <div class="level2-column">
                        <div class="level2-header">
                            <div>ORD</div>
                            <div>ASK</div>
                            <div>SIZE</div>
                            <div>MM</div>
                        </div>
                        <div id="asksDisplay"></div>
                    </div>
                </div>
            `,

            timesales: `
                <div style="padding: 4px 0;">
                    <div class="timesales-row" style="background: #2d2d2d; position: sticky; top: 0;">
                        <div style="color: #888; font-weight: 700;">TIME</div>
                        <div style="color: #888; font-weight: 700;">PRICE</div>
                        <div style="color: #888; font-weight: 700;">SIZE</div>
                    </div>
                    <div id="timesalesDisplay"></div>
                </div>
            `,

            order: `
                <div class="module-content">
                    <!-- Account Selector -->
                    <div class="order-field" style="margin-bottom: 8px;">
                        <label style="display: flex; justify-content: space-between; align-items: center;">
                            <span>Trading Account</span>
                            <span id="accountTypeLabel" style="font-size: 10px; color: #22c55e;"></span>
                        </label>
                        <select id="tradingAccount" onchange="selectTradingAccount(this.value)" style="background: #1a1a1a; font-weight: 600;">
                            <option value="">Loading accounts...</option>
                        </select>
                    </div>

                    <div class="order-field">
                        <label>Symbol</label>
                        <input type="text" id="orderSymbol" value="AAPL"
                               style="text-transform: uppercase; background: #1a1a1a; font-weight: 700; font-size: 17px;"
                               onchange="handleSymbolChange(this.value)"
                               onkeyup="if(event.key==='Enter')handleSymbolChange(this.value)"
                               placeholder="Enter symbol...">
                    </div>

                    <div class="quantity-buttons">
                        <button class="qty-btn" onclick="setQuantity(50)">50</button>
                        <button class="qty-btn" onclick="setQuantity(100)">100</button>
                        <button class="qty-btn" onclick="setQuantity(200)">200</button>
                        <button class="qty-btn" onclick="setQuantity(500)">500</button>
                        <button class="qty-btn" onclick="setQuantity(1000)">1K</button>
                    </div>

                    <!-- Market Price Display - Clickable to set price -->
                    <div id="marketPriceDisplay" style="margin: 8px 0; padding: 8px; background: #1a1a1a; border: 1px solid #333; border-radius: 4px; display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; text-align: center;">
                        <div style="cursor: pointer; padding: 4px; border-radius: 3px; transition: background 0.2s;" onclick="setOrderPrice('bid')" onmouseover="this.style.background='#2d2d2d'" onmouseout="this.style.background='transparent'">
                            <div style="font-size: 10px; color: #666; margin-bottom: 2px;">BID</div>
                            <div id="marketBid" style="font-size: 14px; font-weight: 600; color: #ef4444;">--</div>
                        </div>
                        <div style="cursor: pointer; padding: 4px; border-radius: 3px; transition: background 0.2s;" onclick="setOrderPrice('last')" onmouseover="this.style.background='#2d2d2d'" onmouseout="this.style.background='transparent'">
                            <div style="font-size: 10px; color: #666; margin-bottom: 2px;">LAST</div>
                            <div id="marketLast" style="font-size: 14px; font-weight: 600; color: #fff;">--</div>
                        </div>
                        <div style="cursor: pointer; padding: 4px; border-radius: 3px; transition: background 0.2s;" onclick="setOrderPrice('ask')" onmouseover="this.style.background='#2d2d2d'" onmouseout="this.style.background='transparent'">
                            <div style="font-size: 10px; color: #666; margin-bottom: 2px;">ASK</div>
                            <div id="marketAsk" style="font-size: 14px; font-weight: 600; color: #22c55e;">--</div>
                        </div>
                    </div>

                    <div class="order-entry-grid">
                        <div class="order-field">
                            <label>Quantity</label>
                            <input type="number" id="orderQuantity" value="100" min="1" oninput="calculateOrderCost()">
                        </div>
                        <div class="order-field">
                            <label>Order Type</label>
                            <select id="orderType" onchange="handleOrderTypeChange()">
                                <option value="MARKET">Market</option>
                                <option value="LIMIT" selected>Limit</option>
                                <option value="STOP">Stop</option>
                                <option value="STOP_LIMIT">Stop Limit</option>
                            </select>
                        </div>
                    </div>

                    <div class="price-controls">
                        <button class="price-btn" onclick="adjustPrice(-0.01); calculateOrderCost();">‚àí</button>
                        <div class="order-field" style="margin: 0;">
                            <label>Limit Price</label>
                            <input type="text" id="orderPrice" value="" placeholder="Enter limit price" oninput="calculateOrderCost()">
                        </div>
                        <button class="price-btn" onclick="adjustPrice(0.01); calculateOrderCost();">+</button>
                    </div>

                    <div class="order-field">
                        <label>Time In Force</label>
                        <select id="orderTIF">
                            <option value="DAY" selected>Day + Ext Hrs</option>
                            <option value="GTC">GTC</option>
                            <option value="IOC">IOC</option>
                            <option value="FOK">FOK</option>
                        </select>
                    </div>

                    <!-- Checkboxes on one line to save space -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin: 8px 0;">
                        <div style="display: flex; align-items: center; gap: 6px;">
                            <input type="checkbox" id="extendedHours" style="width: auto; margin: 0;" checked>
                            <label for="extendedHours" style="margin: 0; cursor: pointer; font-size: 13px; color: #22c55e;">Ext Hours ‚úì</label>
                        </div>
                        <div style="display: flex; align-items: center; gap: 6px;">
                            <input type="checkbox" id="autoSubmitOrders" style="width: auto; margin: 0;" onchange="saveAutoSubmitSetting(this.checked)">
                            <label for="autoSubmitOrders" style="margin: 0; cursor: pointer; font-size: 13px; color: #fbbf24;">‚ö° Auto-Submit</label>
                        </div>
                    </div>

                    <!-- Order Cost Calculator -->
                    <div style="margin: 12px 0; padding: 10px; background: #1a1a1a; border: 1px solid #333; border-radius: 4px;">
                        <div style="font-size: 11px; color: #888; margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px;">
                            Estimated Cost
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px;">
                            <div style="text-align: center;">
                                <div style="font-size: 10px; color: #666; margin-bottom: 2px;">Shares</div>
                                <div id="calcShares" style="font-size: 15px; font-weight: 600; color: #fff;">0</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 10px; color: #666; margin-bottom: 2px;">Price</div>
                                <div id="calcPrice" style="font-size: 15px; font-weight: 600; color: #fff;">$0.00</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 10px; color: #666; margin-bottom: 2px;">Est. Total</div>
                                <div id="calcTotal" style="font-size: 15px; font-weight: 600; color: #22c55e;">$0.00</div>
                            </div>
                        </div>
                    </div>

                    <!-- Order buttons: Buys on left, Sells on right -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 12px;">
                        <!-- BUY SIDE (LEFT) -->
                        <div style="display: flex; flex-direction: column; gap: 6px;">
                            <button class="btn btn-buy" onclick="submitOrder('BUY')" style="width: 100%; font-weight: 600;">
                                BUY
                            </button>
                            <button class="btn btn-secondary" onclick="submitOrder('BUY_MARKET')" style="width: 100%; font-size: 12px;">
                                BUY MARKET
                            </button>
                            <button class="btn btn-secondary" onclick="submitOrderAtPrice('BUY', 'BID', event)" style="width: 100%; font-size: 11px; background: #134e4a; color: #22c55e; transition: all 0.15s;">
                                Buy @ Bid
                            </button>
                            <button class="btn btn-secondary" onclick="submitOrderAtPrice('BUY', 'ASK', event)" style="width: 100%; font-size: 11px; background: #134e4a; color: #22c55e; transition: all 0.15s;">
                                Buy @ Ask
                            </button>
                        </div>

                        <!-- SELL SIDE (RIGHT) -->
                        <div style="display: flex; flex-direction: column; gap: 6px;">
                            <button class="btn btn-sell" onclick="submitOrder('SELL')" style="width: 100%; font-weight: 600;">
                                SELL
                            </button>
                            <button class="btn btn-secondary" onclick="submitOrder('SELL_MARKET')" style="width: 100%; font-size: 12px;">
                                SELL MARKET
                            </button>
                            <button class="btn btn-secondary" onclick="submitOrderAtPrice('SELL', 'BID', event)" style="width: 100%; font-size: 11px; background: #7f1d1d; color: #ef4444; transition: all 0.15s;">
                                Sell @ Bid
                            </button>
                            <button class="btn btn-secondary" onclick="submitOrderAtPrice('SELL', 'ASK', event)" style="width: 100%; font-size: 11px; background: #7f1d1d; color: #ef4444; transition: all 0.15s;">
                                Sell @ Ask
                            </button>
                        </div>
                    </div>

                    <!-- Cancel All Button -->
                    <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #333;">
                        <button class="btn btn-secondary" onclick="cancelAllOrders()" style="width: 100%; background: #7f1d1d; color: #ef4444; font-size: 13px;">
                            ‚ùå CANCEL ALL ORDERS
                        </button>
                    </div>
                </div>
            `,

            positions: `
                <div style="padding: 4px 8px; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center;">
                    <div style="font-size: 11px; color: #888;">
                        <span id="scalpAssistantStatus" style="color: #ef4444;">AI: OFF</span>
                    </div>
                    <div style="display: flex; gap: 6px;">
                        <button class="btn btn-secondary" onclick="toggleScalpAssistant()" id="scalpToggleBtn"
                                style="padding: 3px 8px; font-size: 11px; background: #1a472a; border: 1px solid #22c55e;">
                            Start AI Monitor
                        </button>
                    </div>
                </div>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th style="width: 60px;">AI</th>
                            <th>Symbol</th>
                            <th>Side</th>
                            <th>Qty</th>
                            <th>Avg Price</th>
                            <th>Current</th>
                            <th>P&L</th>
                            <th>P&L %</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="positionsDisplay">
                        <tr><td colspan="9" class="empty-state">No open positions</td></tr>
                    </tbody>
                </table>
            `,

            orders: `
                <div style="padding: 6px 8px; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center;">
                    <div style="display: flex; gap: 2px;">
                        <button id="ordersTabWorking" class="orders-tab active" onclick="switchOrdersTab('working')"
                                style="padding: 4px 10px; font-size: 12px; font-weight: 600; background: #2d2d2d; border: none; color: #fff; cursor: pointer; border-radius: 3px 3px 0 0;">
                            Working
                        </button>
                        <button id="ordersTabOpen" class="orders-tab" onclick="switchOrdersTab('open')"
                                style="padding: 4px 10px; font-size: 12px; font-weight: 600; background: #1a1a1a; border: none; color: #888; cursor: pointer; border-radius: 3px 3px 0 0;">
                            Open
                        </button>
                        <button id="ordersTabFilled" class="orders-tab" onclick="switchOrdersTab('filled')"
                                style="padding: 4px 10px; font-size: 12px; font-weight: 600; background: #1a1a1a; border: none; color: #888; cursor: pointer; border-radius: 3px 3px 0 0;">
                            Filled
                        </button>
                        <button id="ordersTabClosed" class="orders-tab" onclick="switchOrdersTab('closed')"
                                style="padding: 4px 10px; font-size: 12px; font-weight: 600; background: #1a1a1a; border: none; color: #888; cursor: pointer; border-radius: 3px 3px 0 0;">
                            Closed
                        </button>
                    </div>
                    <div style="display: flex; gap: 6px;">
                        <button class="btn btn-secondary" onclick="loadOrders()"
                                style="padding: 4px 10px; font-size: 12px; font-weight: 600; background: #1e3a5f; color: #60a5fa;"
                                title="Refresh orders list">
                            üîÑ
                        </button>
                        <button class="btn btn-secondary" onclick="cancelAllOrders()"
                                style="padding: 4px 12px; font-size: 12px; font-weight: 600;">
                            CANCEL ALL
                        </button>
                    </div>
                </div>
                <div id="ordersTabContent">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Time</th>
                                <th>Symbol</th>
                                <th>Side</th>
                                <th>Qty</th>
                                <th>Type</th>
                                <th>Price</th>
                                <th>Status</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="ordersDisplay">
                            <tr><td colspan="8" class="empty-state">No orders</td></tr>
                        </tbody>
                    </table>
                </div>
            `,

            watchlist: `
                <div style="padding: 6px 8px; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center;">
                    <div style="font-size: 13px; color: #888; text-transform: uppercase;">Shared Worklist</div>
                    <div style="display: flex; gap: 4px;">
                        <button class="btn btn-secondary" onclick="showScannerDialog()"
                                style="padding: 4px 8px; font-size: 13px; font-weight: 600;">SCANNER</button>
                        <button class="btn btn-secondary" onclick="showAddSymbolDialog()"
                                style="padding: 4px 8px; font-size: 13px; font-weight: 600;">+ ADD</button>
                        <button class="btn btn-secondary" onclick="clearWorklist()"
                                style="padding: 4px 8px; font-size: 13px; font-weight: 600; background: #7f1d1d;">CLEAR ALL</button>
                    </div>
                </div>
                <div id="worklistStats" style="padding: 6px 8px; background: #1a1a1a; border-bottom: 1px solid #333; display: grid; grid-template-columns: repeat(4, 1fr); gap: 4px;">
                    <div style="background: #252525; padding: 4px 6px; border-radius: 2px;">
                        <div style="font-size: 12px; color: #888; margin-bottom: 2px;">SYMBOLS</div>
                        <div style="font-size: 18px; font-weight: 700; color: #fff;" id="statsTotal">0</div>
                    </div>
                    <div style="background: #252525; padding: 4px 6px; border-radius: 2px;">
                        <div style="font-size: 12px; color: #888; margin-bottom: 2px;">LIVE</div>
                        <div style="font-size: 18px; font-weight: 700; color: #22c55e;" id="statsLive">0</div>
                    </div>
                    <div style="background: #252525; padding: 4px 6px; border-radius: 2px;">
                        <div style="font-size: 12px; color: #888; margin-bottom: 2px;">BULLISH</div>
                        <div style="font-size: 18px; font-weight: 700; color: #22c55e;" id="statsBullish">0</div>
                    </div>
                    <div style="background: #252525; padding: 4px 6px; border-radius: 2px;">
                        <div style="font-size: 12px; color: #888; margin-bottom: 2px;">BEARISH</div>
                        <div style="font-size: 18px; font-weight: 700; color: #ef4444;" id="statsBearish">0</div>
                    </div>
                </div>
                <div id="watchlistDisplay" style="overflow-y: auto; max-height: calc(100% - 90px);">
                    <div class="empty-state">Loading worklist...</div>
                </div>
            `,

            account: `
                <!-- Condensed Account Display -->
                <div style="padding: 6px 8px; border-bottom: 1px solid #333; background: #1a1a1a;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div style="font-size: 10px; color: #888;">
                            <span id="accountNumber">DU0000000</span> ‚Ä¢ <span id="accountType">Unknown</span>
                        </div>
                        <div id="accountWarnings" style="font-size: 10px; padding: 2px 6px; border-radius: 2px; display: none;"></div>
                    </div>
                </div>

                <!-- Key Stats - Compact Grid -->
                <div style="padding: 8px; display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 11px;">
                    <div style="padding: 6px; background: #1a1a1a; border-radius: 3px;">
                        <div style="color: #666; font-size: 10px; margin-bottom: 2px;">CASH</div>
                        <div id="cashBalance" style="font-weight: 700; font-size: 14px; color: #22c55e;">$0.00</div>
                    </div>
                    <div style="padding: 6px; background: #1a1a1a; border-radius: 3px;">
                        <div style="color: #666; font-size: 10px; margin-bottom: 2px;">BUYING POWER</div>
                        <div id="buyingPower" style="font-weight: 700; font-size: 14px; color: #60a5fa;">$0.00</div>
                    </div>
                    <div style="padding: 6px; background: #1a1a1a; border-radius: 3px;">
                        <div style="color: #666; font-size: 10px; margin-bottom: 2px;">DAY P&L</div>
                        <div id="dayPL" style="font-weight: 700; font-size: 14px;">$0.00</div>
                    </div>
                    <div style="padding: 6px; background: #1a1a1a; border-radius: 3px;">
                        <div style="color: #666; font-size: 10px; margin-bottom: 2px;">EQUITY</div>
                        <div id="equityValue" style="font-weight: 700; font-size: 14px; color: #aaa;">$0.00</div>
                    </div>
                </div>

                <!-- Additional Info Bar -->
                <div style="padding: 4px 8px; display: flex; justify-content: space-between; font-size: 9px; color: #666; border-top: 1px solid #333;">
                    <div>Positions: <span id="positionCount" style="color: #aaa; font-weight: 600;">0</span></div>
                    <div id="dayTradesInfo" style="display: none;">Day Trades: <span id="dayTradesRemaining" style="color: #aaa; font-weight: 600;">-</span></div>
                    <div>Total P&L: <span id="totalPL" style="font-weight: 600;">$0.00</span></div>
                </div>
            `,

            bot: `
                <div class="module-content" style="padding: 8px; overflow-y: auto; max-height: 100%;">
                    <!-- Bot Status Header -->
                    <div style="text-align: center; margin-bottom: 12px; padding: 12px; background: #1a1a1a; border-radius: 4px;">
                        <div style="font-size: 13px; color: #888; margin-bottom: 4px; letter-spacing: 1px;">AUTONOMOUS BOT STATUS</div>
                        <div id="botStatusText" style="font-size: 24px; font-weight: 700; color: #ef4444; margin-bottom: 4px;">NOT INITIALIZED</div>
                        <div id="botStatusSubtext" style="font-size: 13px; color: #888;">Click INIT to initialize bot</div>
                    </div>

                    <!-- Control Buttons -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 6px; margin-bottom: 8px;">
                        <button id="initBotBtn" class="btn btn-secondary" onclick="initBot()" style="font-size: 14px; padding: 8px;">‚öôÔ∏è INIT</button>
                        <button id="startBotBtn" class="btn btn-buy" onclick="startAutonomousBot()" disabled style="font-size: 14px; padding: 8px;">‚ñ∂ START</button>
                        <button id="stopBotBtn" class="btn btn-sell" onclick="stopAutonomousBot()" disabled style="font-size: 14px; padding: 8px;">‚èπ STOP</button>
                        <button id="enableBotBtn" class="btn btn-secondary" onclick="enableBot()" disabled style="font-size: 14px; padding: 8px;">‚úì ENABLE</button>
                    </div>

                    <!-- Statistics Grid -->
                    <div id="botStatsGrid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 6px; margin-bottom: 8px;">
                        <div style="padding: 6px; background: #1a1a1a; border-radius: 2px;">
                            <div style="font-size: 12px; color: #888;">SIGNALS</div>
                            <div id="botSignals" style="font-size: 17px; font-weight: 700; color: #60a5fa;">0</div>
                        </div>
                        <div style="padding: 6px; background: #1a1a1a; border-radius: 2px;">
                            <div style="font-size: 12px; color: #888;">TRADES</div>
                            <div id="botTrades" style="font-size: 17px; font-weight: 700; color: #22c55e;">0</div>
                        </div>
                        <div style="padding: 6px; background: #1a1a1a; border-radius: 2px;">
                            <div style="font-size: 12px; color: #888;">POSITIONS</div>
                            <div id="botPositions" style="font-size: 17px; font-weight: 700; color: #fbbf24;">0</div>
                        </div>
                        <div style="padding: 6px; background: #1a1a1a; border-radius: 2px;">
                            <div style="font-size: 12px; color: #888;">DAY P/L</div>
                            <div id="botDailyPnl" style="font-size: 17px; font-weight: 700;">$0.00</div>
                        </div>
                        <div style="padding: 6px; background: #1a1a1a; border-radius: 2px;">
                            <div style="font-size: 12px; color: #888;">UNREALIZED</div>
                            <div id="botPositionPnl" style="font-size: 17px; font-weight: 700;">$0.00</div>
                        </div>
                    </div>

                    <!-- 3-5-7 Risk Management Display -->
                    <div style="padding: 8px; background: #1a1a1a; border: 1px solid #333; border-radius: 3px; margin-bottom: 8px;">
                        <div style="font-size: 13px; color: #888; margin-bottom: 6px; font-weight: 700; letter-spacing: 0.5px;">3-5-7 RISK MANAGEMENT</div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 6px;">
                            <div style="padding: 4px;">
                                <div style="font-size: 12px; color: #888;">WEEKLY P&L (7%)</div>
                                <div id="botWeeklyPnl" style="font-size: 16px; font-weight: 700;">$0.00</div>
                            </div>
                            <div style="padding: 4px;">
                                <div style="font-size: 12px; color: #888;">MAX RISK/TRADE (3%)</div>
                                <div id="botMaxRisk" style="font-size: 16px; font-weight: 700; color: #888;">$0.00</div>
                            </div>
                        </div>
                    </div>

                    <!-- Configuration Section -->
                    <div style="padding: 8px; background: #252525; border: 1px solid #333; border-radius: 3px; margin-bottom: 8px;">
                        <div style="font-size: 13px; color: #888; margin-bottom: 6px; font-weight: 700; letter-spacing: 0.5px;">CONFIGURATION</div>

                        <div style="margin-bottom: 6px;">
                            <label style="font-size: 12px; color: #888; display: block; margin-bottom: 2px;">Watchlist</label>
                            <input type="text" id="botWatchlist" value="AAPL,MSFT,GOOGL,TSLA,NVDA"
                                   style="width: 100%; padding: 4px 6px; background: #1a1a1a; border: 1px solid #404040; color: #fff; font-size: 14px; border-radius: 2px;">
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 6px; margin-bottom: 6px;">
                            <div>
                                <label style="font-size: 12px; color: #888; display: block; margin-bottom: 2px;">Max Position $</label>
                                <input type="number" id="botMaxPosition" value="5000" min="100" step="100"
                                       style="width: 100%; padding: 4px 6px; background: #1a1a1a; border: 1px solid #404040; color: #fff; font-size: 14px; border-radius: 2px;">
                            </div>
                            <div>
                                <label style="font-size: 12px; color: #888; display: block; margin-bottom: 2px;">Daily Loss $</label>
                                <input type="number" id="botDailyLoss" value="500" min="50" step="50"
                                       style="width: 100%; padding: 4px 6px; background: #1a1a1a; border: 1px solid #404040; color: #fff; font-size: 14px; border-radius: 2px;">
                            </div>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 6px;">
                            <div>
                                <label style="font-size: 12px; color: #888; display: block; margin-bottom: 2px;">Min Prob %</label>
                                <input type="number" id="botMinProb" value="60" min="50" max="100" step="1"
                                       style="width: 100%; padding: 4px 6px; background: #1a1a1a; border: 1px solid #404040; color: #fff; font-size: 14px; border-radius: 2px;">
                            </div>
                            <div>
                                <label style="font-size: 12px; color: #888; display: block; margin-bottom: 2px;">Max Positions</label>
                                <input type="number" id="botMaxPositions" value="5" min="1" max="20" step="1"
                                       style="width: 100%; padding: 4px 6px; background: #1a1a1a; border: 1px solid #404040; color: #fff; font-size: 14px; border-radius: 2px;">
                            </div>
                        </div>

                        <button class="btn btn-secondary" onclick="updateBotConfig()" style="width: 100%; margin-top: 6px; font-size: 13px; padding: 5px;">
                            UPDATE CONFIG
                        </button>
                    </div>

                    <!-- Recent Predictions -->
                    <div style="padding: 8px; background: #252525; border: 1px solid #333; border-radius: 3px; margin-bottom: 8px;">
                        <div style="font-size: 13px; color: #888; margin-bottom: 6px; font-weight: 700; letter-spacing: 0.5px;">RECENT PREDICTIONS</div>
                        <div id="botPredictionsDisplay" style="max-height: 120px; overflow-y: auto; font-size: 13px;">
                            <div class="empty-state" style="padding: 16px; font-size: 13px;">No predictions yet</div>
                        </div>
                    </div>

                    <!-- Open Positions -->
                    <div style="padding: 8px; background: #252525; border: 1px solid #333; border-radius: 3px;">
                        <div style="font-size: 13px; color: #888; margin-bottom: 6px; font-weight: 700; letter-spacing: 0.5px;">OPEN POSITIONS</div>
                        <div id="botPositionsDisplay" style="max-height: 120px; overflow-y: auto; font-size: 13px;">
                            <div class="empty-state" style="padding: 16px; font-size: 13px;">No positions</div>
                        </div>
                    </div>
                </div>
            `,

            ai: `
                <div class="module-content">
                    <div id="aiPredictionDisplay" class="empty-state">Click PREDICT for AI analysis</div>
                    <button class="btn btn-secondary" onclick="getPrediction()" style="width: 100%; margin-top: 12px;">
                        ü§ñ GET AI PREDICTION
                    </button>
                </div>
            `,

            scalpmonitor: `
                <div class="module-content" style="padding: 10px; overflow-y: auto;">
                    <!-- Scalp Assistant Status -->
                    <div id="scalpMonitorHeader" style="text-align: center; padding: 12px; background: #1a1a1a; border-radius: 6px; margin-bottom: 10px;">
                        <div style="font-size: 11px; color: #666; letter-spacing: 1px; margin-bottom: 4px;">SCALP ASSISTANT</div>
                        <div id="scalpMonitorStatus" style="font-size: 18px; font-weight: 700; color: #ef4444;">OFFLINE</div>
                        <div style="margin-top: 6px;">
                            <button id="scalpMonitorToggle" onclick="toggleScalpAssistant()" class="btn btn-secondary" style="padding: 4px 12px; font-size: 11px;">Start</button>
                            <button onclick="loadScalpMonitorDetails()" class="btn btn-secondary" style="padding: 4px 12px; font-size: 11px; margin-left: 4px;">Refresh</button>
                        </div>
                    </div>

                    <!-- Stats -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 6px; margin-bottom: 10px;">
                        <div style="padding: 8px; background: #1a1a1a; border-radius: 4px; text-align: center;">
                            <div style="font-size: 10px; color: #666; margin-bottom: 2px;">MONITORED</div>
                            <div id="scalpMonitored" style="font-size: 18px; font-weight: 700; color: #60a5fa;">0</div>
                        </div>
                        <div style="padding: 8px; background: #1a1a1a; border-radius: 4px; text-align: center;">
                            <div style="font-size: 10px; color: #666; margin-bottom: 2px;">EXITS</div>
                            <div id="scalpExits" style="font-size: 18px; font-weight: 700; color: #f59e0b;">0</div>
                        </div>
                        <div style="padding: 8px; background: #1a1a1a; border-radius: 4px; text-align: center;">
                            <div style="font-size: 10px; color: #666; margin-bottom: 2px;">WIN %</div>
                            <div id="scalpWinRate" style="font-size: 18px; font-weight: 700; color: #22c55e;">0%</div>
                        </div>
                    </div>

                    <!-- Total P/L -->
                    <div style="padding: 10px; background: #1a1a1a; border-radius: 4px; margin-bottom: 10px; text-align: center;">
                        <div style="font-size: 10px; color: #666; margin-bottom: 2px;">TOTAL P/L</div>
                        <div id="scalpTotalPnl" style="font-size: 22px; font-weight: 700; color: #888;">$0.00</div>
                    </div>

                    <!-- Config -->
                    <div style="padding: 8px; background: #252525; border: 1px solid #333; border-radius: 4px; margin-bottom: 10px;">
                        <div style="font-size: 11px; color: #888; margin-bottom: 6px; font-weight: 700;">EXIT RULES</div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 4px; font-size: 11px;">
                            <div style="display: flex; justify-content: space-between;">
                                <span style="color: #666;">Stop Loss:</span>
                                <span id="scalpStopLoss" style="color: #ef4444;">-3%</span>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span style="color: #666;">Target:</span>
                                <span id="scalpTarget" style="color: #22c55e;">+3%</span>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span style="color: #666;">Trailing:</span>
                                <span id="scalpTrailing" style="color: #f59e0b;">1.5%</span>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span style="color: #666;">Max Hold:</span>
                                <span id="scalpMaxHold" style="color: #60a5fa;">180s</span>
                            </div>
                        </div>
                    </div>

                    <!-- Monitored Positions -->
                    <div style="padding: 8px; background: #252525; border: 1px solid #333; border-radius: 4px;">
                        <div style="font-size: 11px; color: #888; margin-bottom: 6px; font-weight: 700;">MONITORED POSITIONS</div>
                        <div id="scalpPositionsList" style="max-height: 150px; overflow-y: auto; font-size: 11px;">
                            <div class="empty-state" style="padding: 12px; font-size: 11px;">No positions monitored</div>
                        </div>
                    </div>

                    <!-- Paper Mode Toggle -->
                    <div style="margin-top: 8px; padding: 6px; background: #1a1a1a; border-radius: 4px; display: flex; justify-content: space-between; align-items: center;">
                        <span style="font-size: 11px; color: #666;">Paper Mode:</span>
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" id="scalpPaperMode" checked onchange="toggleScalpPaperMode(this.checked)" style="margin-right: 4px;">
                            <span id="scalpPaperLabel" style="font-size: 11px; color: #22c55e;">ON (safe)</span>
                        </label>
                    </div>
                </div>
            `,

            pdtmonitor: `
                <div class="module-content" style="padding: 10px; overflow-y: auto;">
                    <!-- PDT Status Header -->
                    <div id="pdtStatusHeader" style="text-align: center; padding: 15px; background: #1a1a1a; border-radius: 6px; margin-bottom: 12px;">
                        <div style="font-size: 11px; color: #666; letter-spacing: 1px; margin-bottom: 6px;">PDT RULE STATUS</div>
                        <div id="pdtStatusBadge" style="font-size: 22px; font-weight: 700; color: #22c55e;">CHECKING...</div>
                        <div id="pdtStatusMessage" style="font-size: 12px; color: #888; margin-top: 6px;">Loading PDT status...</div>
                    </div>

                    <!-- Day Trades Counter -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-bottom: 12px;">
                        <div style="padding: 12px; background: #1a1a1a; border-radius: 4px; text-align: center;">
                            <div style="font-size: 10px; color: #666; margin-bottom: 4px;">USED</div>
                            <div id="pdtDayTradesUsed" style="font-size: 24px; font-weight: 700; color: #f59e0b;">0</div>
                        </div>
                        <div style="padding: 12px; background: #1a1a1a; border-radius: 4px; text-align: center;">
                            <div style="font-size: 10px; color: #666; margin-bottom: 4px;">REMAINING</div>
                            <div id="pdtDayTradesRemaining" style="font-size: 24px; font-weight: 700; color: #22c55e;">3</div>
                        </div>
                        <div style="padding: 12px; background: #1a1a1a; border-radius: 4px; text-align: center;">
                            <div style="font-size: 10px; color: #666; margin-bottom: 4px;">LIMIT</div>
                            <div style="font-size: 24px; font-weight: 700; color: #60a5fa;">3</div>
                        </div>
                    </div>

                    <!-- Account Info -->
                    <div style="padding: 10px; background: #1a1a1a; border-radius: 4px; margin-bottom: 12px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span style="font-size: 12px; color: #666;">Account Equity:</span>
                            <span id="pdtEquity" style="font-size: 12px; color: #fff; font-weight: 600;">$0.00</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span style="font-size: 12px; color: #666;">PDT Threshold:</span>
                            <span style="font-size: 12px; color: #fff; font-weight: 600;">$25,000</span>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span style="font-size: 12px; color: #666;">PDT Exempt:</span>
                            <span id="pdtExempt" style="font-size: 12px; font-weight: 600;">No</span>
                        </div>
                    </div>

                    <!-- Rolling Window Visualization -->
                    <div style="padding: 10px; background: #1a1a1a; border-radius: 4px; margin-bottom: 12px;">
                        <div style="font-size: 11px; color: #666; margin-bottom: 8px; font-weight: 600;">5-DAY ROLLING WINDOW</div>
                        <div id="pdtWindowVisual" style="display: flex; gap: 4px; margin-bottom: 8px;">
                            <div style="flex: 1; height: 24px; background: #252525; border-radius: 2px; display: flex; align-items: center; justify-content: center; font-size: 10px; color: #666;">D1</div>
                            <div style="flex: 1; height: 24px; background: #252525; border-radius: 2px; display: flex; align-items: center; justify-content: center; font-size: 10px; color: #666;">D2</div>
                            <div style="flex: 1; height: 24px; background: #252525; border-radius: 2px; display: flex; align-items: center; justify-content: center; font-size: 10px; color: #666;">D3</div>
                            <div style="flex: 1; height: 24px; background: #252525; border-radius: 2px; display: flex; align-items: center; justify-content: center; font-size: 10px; color: #666;">D4</div>
                            <div style="flex: 1; height: 24px; background: #252525; border-radius: 2px; display: flex; align-items: center; justify-content: center; font-size: 10px; color: #666;">D5</div>
                        </div>
                        <div style="font-size: 10px; color: #555; text-align: center;">Day trades reset as they fall outside the 5-day window</div>
                    </div>

                    <!-- Recent Day Trades -->
                    <div style="padding: 10px; background: #1a1a1a; border-radius: 4px; margin-bottom: 12px;">
                        <div style="font-size: 11px; color: #666; margin-bottom: 8px; font-weight: 600;">RECENT DAY TRADES</div>
                        <div id="pdtRecentTrades" style="font-size: 12px; max-height: 100px; overflow-y: auto;">
                            <div style="color: #666; text-align: center; padding: 10px;">No day trades in window</div>
                        </div>
                    </div>

                    <!-- SEC Rule Info -->
                    <div style="padding: 10px; background: #0d1117; border: 1px solid #1e3a5f; border-radius: 4px;">
                        <div style="font-size: 11px; color: #60a5fa; margin-bottom: 6px; font-weight: 600;">üìú SEC PATTERN DAY TRADER RULE</div>
                        <div style="font-size: 11px; color: #888; line-height: 1.5;">
                            <p style="margin: 0 0 6px 0;"><b>Limit:</b> 3 day trades per 5 rolling business days for accounts under $25,000</p>
                            <p style="margin: 0 0 6px 0;"><b>Day Trade:</b> Buying AND selling the same security on the same day</p>
                            <p style="margin: 0;"><b>Consequence:</b> 4+ day trades = PDT flag = trading restrictions</p>
                        </div>
                    </div>

                    <!-- Refresh Button -->
                    <button onclick="refreshPDTStatus()" style="width: 100%; margin-top: 12px; padding: 10px; background: #1e3a5f; border: 1px solid #2563eb; color: #60a5fa; font-size: 13px; font-weight: 600; border-radius: 4px; cursor: pointer;">
                        üîÑ REFRESH PDT STATUS
                    </button>
                </div>
            `,

            claudechat: `
                <div class="module-content" style="display: flex; flex-direction: column; height: 100%; padding: 0;">
                    <!-- LIVE SYSTEM STATUS PANEL -->
                    <div id="claudeSystemStatus" style="background: #0d1117; border-bottom: 1px solid #333; padding: 8px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                            <span style="font-size: 10px; color: #666; font-weight: 700;">üì° LIVE SYSTEM STATUS</span>
                            <span id="claudeStatusTime" style="font-size: 9px; color: #444;">--</span>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 6px;">
                            <div style="background: #161b22; padding: 6px; border-radius: 4px; text-align: center;">
                                <div style="font-size: 9px; color: #666;">MODEL</div>
                                <div id="claudeModelStatus" style="font-size: 11px; color: #22c55e; font-weight: 600;">--</div>
                            </div>
                            <div style="background: #161b22; padding: 6px; border-radius: 4px; text-align: center;">
                                <div style="font-size: 9px; color: #666;">REGIME</div>
                                <div id="claudeRegimeStatus" style="font-size: 11px; color: #60a5fa; font-weight: 600;">--</div>
                            </div>
                            <div style="background: #161b22; padding: 6px; border-radius: 4px; text-align: center;">
                                <div style="font-size: 9px; color: #666;">DRIFT</div>
                                <div id="claudeDriftStatus" style="font-size: 11px; color: #22c55e; font-weight: 600;">--</div>
                            </div>
                        </div>
                    </div>

                    <!-- LIVE ACTIVITY FEED -->
                    <div id="claudeActivityFeed" style="background: #0a0a0a; border-bottom: 1px solid #222; max-height: 80px; overflow-y: auto; font-size: 11px;">
                        <div id="activityLog" style="padding: 6px 10px;">
                            <div style="color: #666; padding: 4px 0;">‚è≥ Initializing system monitor...</div>
                        </div>
                    </div>

                    <!-- Chat Messages -->
                    <div id="claudeChatMessages" style="flex: 1; overflow-y: auto; padding: 12px; background: #0a0a0a;">
                        <div style="padding: 12px; background: #1e3a5f; border-radius: 8px; margin-bottom: 10px;">
                            <div style="font-size: 11px; color: #60a5fa; margin-bottom: 4px;">ü§ñ Claude AI</div>
                            <div style="color: #e0e0e0; font-size: 14px; line-height: 1.5;">
                                Hello! I'm Claude, your AI trading assistant. I monitor the system and can help you with:
                                <ul style="margin: 8px 0 0 16px; padding: 0; font-size: 13px;">
                                    <li><b>Training</b> - Start/monitor model training</li>
                                    <li><b>Predictions</b> - Get AI signals for any stock</li>
                                    <li><b>Regime</b> - Understand current market conditions</li>
                                    <li><b>Drift</b> - Check if model needs retraining</li>
                                </ul>
                                <div style="margin-top: 10px; padding: 8px; background: #1a3a5f; border-radius: 4px; font-size: 12px;">
                                    üí° <b>Try:</b> "train model", "predict TSLA", "check regime", "system status"
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Quick Actions -->
                    <div style="padding: 8px; background: #1a1a1a; border-top: 1px solid #333; border-bottom: 1px solid #333;">
                        <div style="display: flex; gap: 6px; flex-wrap: wrap;">
                            <button onclick="claudeQuickAction('status')" style="padding: 4px 8px; background: #1e3a5f; border: 1px solid #2563eb; color: #60a5fa; font-size: 11px; border-radius: 3px; cursor: pointer;">üìä System Status</button>
                            <button onclick="claudeQuickAction('train')" style="padding: 4px 8px; background: #14532d; border: 1px solid #22c55e; color: #22c55e; font-size: 11px; border-radius: 3px; cursor: pointer;">üöÄ Train Model</button>
                            <button onclick="claudeQuickAction('predict')" style="padding: 4px 8px; background: #2d2d2d; border: 1px solid #404040; color: #888; font-size: 11px; border-radius: 3px; cursor: pointer;">üîÆ Predict</button>
                            <button onclick="claudeQuickAction('regime')" style="padding: 4px 8px; background: #2d2d2d; border: 1px solid #404040; color: #888; font-size: 11px; border-radius: 3px; cursor: pointer;">üìà Regime</button>
                            <button onclick="claudeQuickAction('drift')" style="padding: 4px 8px; background: #2d2d2d; border: 1px solid #404040; color: #888; font-size: 11px; border-radius: 3px; cursor: pointer;">üîç Check Drift</button>
                        </div>
                    </div>
                    <!-- Chat Input -->
                    <div style="padding: 10px; background: #1a1a1a;">
                        <div style="display: flex; gap: 8px;">
                            <input type="text" id="claudeChatInput" placeholder="Chat with Claude - ask anything about trading, markets, coding, or any topic..."
                                   style="flex: 1; padding: 10px 12px; background: #252525; border: 1px solid #404040; color: #fff; font-size: 14px; border-radius: 4px;"
                                   onkeypress="if(event.key==='Enter') sendClaudeMessage()">
                            <button onclick="sendClaudeMessage()" style="padding: 10px 16px; background: #007acc; color: #fff; border: none; border-radius: 4px; cursor: pointer; font-weight: 600;">
                                Send
                            </button>
                        </div>
                    </div>
                </div>
            `,

            aicontrol: `
                <div class="module-content" style="padding: 8px; overflow-y: auto; max-height: 100%;">
                    <!-- Tab Navigation -->
                    <div style="display: flex; gap: 4px; margin-bottom: 12px; border-bottom: 2px solid #333;">
                        <button id="aiTabTraining" class="ai-tab active" onclick="switchAITab('training')" style="flex: 1; padding: 8px; background: #2d2d2d; border: none; color: #fff; cursor: pointer; font-size: 13px; font-weight: 600;">
                            üìö TRAINING
                        </button>
                        <button id="aiTabPredictions" class="ai-tab" onclick="switchAITab('predictions')" style="flex: 1; padding: 8px; background: #1a1a1a; border: none; color: #888; cursor: pointer; font-size: 13px; font-weight: 600;">
                            üîÆ PREDICTIONS
                        </button>
                        <button id="aiTabBacktest" class="ai-tab" onclick="switchAITab('backtest')" style="flex: 1; padding: 8px; background: #1a1a1a; border: none; color: #888; cursor: pointer; font-size: 13px; font-weight: 600;">
                            üìä BACKTEST
                        </button>
                        <button id="aiTabBot" class="ai-tab" onclick="switchAITab('bot')" style="flex: 1; padding: 8px; background: #1a1a1a; border: none; color: #888; cursor: pointer; font-size: 13px; font-weight: 600;">
                            ü§ñ BOT
                        </button>
                        <button id="aiTabNews" class="ai-tab" onclick="switchAITab('news')" style="flex: 1; padding: 8px; background: #1a1a1a; border: none; color: #888; cursor: pointer; font-size: 13px; font-weight: 600;">
                            üì∞ NEWS
                        </button>
                    </div>

                    <!-- TRAINING TAB -->
                    <div id="aiTrainingTab" class="ai-tab-content">
                        <div style="padding: 10px; background: #1a1a1a; border: 1px solid #333; border-radius: 4px; margin-bottom: 12px;">
                            <div style="font-size: 13px; color: #888; margin-bottom: 8px; font-weight: 700;">TRAIN NEW MODEL</div>

                            <!-- Training Mode Selection -->
                            <div style="margin-bottom: 10px;">
                                <label style="font-size: 12px; color: #888; display: block; margin-bottom: 3px;">Training Mode</label>
                                <select id="trainMode" onchange="updateTrainingMode()" style="width: 100%; padding: 6px 8px; background: #252525; border: 1px solid #404040; color: #fff; font-size: 14px; border-radius: 3px;">
                                    <option value="single">Single Symbol (~30 sec)</option>
                                    <option value="multi" selected>Multi-Symbol Momentum (~3 min)</option>
                                    <option value="walkforward">Walk-Forward Validation (~10 min)</option>
                                    <option value="advanced">Advanced + Optuna Tuning (~15 min)</option>
                                </select>
                            </div>

                            <div id="singleSymbolInput" style="margin-bottom: 8px; display: none;">
                                <label style="font-size: 12px; color: #888; display: block; margin-bottom: 3px;">Training Symbol</label>
                                <div style="display: flex; gap: 6px;">
                                    <input type="text" id="trainSymbol" value="SPY" placeholder="SPY, AAPL, etc."
                                           style="flex: 1; padding: 6px 8px; background: #252525; border: 1px solid #404040; color: #fff; font-size: 14px; border-radius: 3px;">
                                    <button onclick="loadWorklistSymbol('trainSymbol')" style="padding: 6px 12px; background: #007acc; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 11px; white-space: nowrap;">
                                        üìã Worklist
                                    </button>
                                </div>
                            </div>

                            <div id="multiSymbolInput" style="margin-bottom: 8px;">
                                <label style="font-size: 12px; color: #888; display: block; margin-bottom: 3px;">Training Symbols (comma-separated)</label>
                                <div style="display: flex; gap: 6px;">
                                    <input type="text" id="trainSymbols" value="TSLA,NVDA,AMD,META,AAPL,GOOGL,MSFT,AMZN,PLTR,COIN" placeholder="TSLA,NVDA,AMD..."
                                           style="flex: 1; padding: 6px 8px; background: #252525; border: 1px solid #404040; color: #fff; font-size: 12px; border-radius: 3px;">
                                    <button onclick="loadWorklistSymbols('trainSymbols')" style="padding: 6px 12px; background: #007acc; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 11px; white-space: nowrap;">
                                        üìã Worklist
                                    </button>
                                </div>
                            </div>

                            <div style="margin-bottom: 8px;">
                                <label style="font-size: 12px; color: #888; display: block; margin-bottom: 3px;">Training Period</label>
                                <select id="trainPeriod" style="width: 100%; padding: 6px 8px; background: #252525; border: 1px solid #404040; color: #fff; font-size: 14px; border-radius: 3px;">
                                    <option value="1y">1 Year</option>
                                    <option value="2y" selected>2 Years</option>
                                    <option value="5y">5 Years</option>
                                    <option value="10y">10 Years</option>
                                    <option value="max">Max Available</option>
                                </select>
                            </div>

                            <div style="margin-bottom: 8px;">
                                <label style="font-size: 12px; color: #888; display: block; margin-bottom: 3px;">Test Size %</label>
                                <input type="number" id="trainTestSize" value="20" min="10" max="40" step="5"
                                       style="width: 100%; padding: 6px 8px; background: #252525; border: 1px solid #404040; color: #fff; font-size: 14px; border-radius: 3px;">
                            </div>

                            <!-- Training Time Estimate -->
                            <div id="trainTimeEstimate" style="padding: 8px; background: #252525; border-radius: 3px; margin-bottom: 8px; text-align: center;">
                                <span style="font-size: 11px; color: #888;">Estimated Time: </span>
                                <span id="trainTimeValue" style="font-size: 12px; color: #60a5fa; font-weight: 600;">~3 minutes</span>
                            </div>

                            <button id="trainModelBtn" class="btn btn-buy" onclick="trainModelAdvanced()" style="width: 100%; font-size: 14px; padding: 10px; margin-top: 8px;">
                                üöÄ START TRAINING
                            </button>
                        </div>

                        <!-- Training Status -->
                        <div id="trainingStatus" style="padding: 10px; background: #1a1a1a; border: 1px solid #333; border-radius: 4px; display: none;">
                            <div style="font-size: 13px; color: #888; margin-bottom: 8px; font-weight: 700;">TRAINING PROGRESS</div>
                            <div id="trainingProgress" style="margin-bottom: 8px;">
                                <div style="background: #252525; height: 24px; border-radius: 3px; overflow: hidden; position: relative;">
                                    <div id="trainingProgressBar" style="background: linear-gradient(90deg, #22c55e, #16a34a); height: 100%; width: 0%; transition: width 0.3s; display: flex; align-items: center; justify-content: center;">
                                        <span id="trainingProgressText" style="font-size: 12px; font-weight: 700; color: #fff; position: absolute;">0%</span>
                                    </div>
                                </div>
                            </div>
                            <div id="trainingStatusText" style="font-size: 12px; color: #aaa; text-align: center;">Initializing...</div>
                            <div id="trainingMetrics" style="margin-top: 12px; padding: 8px; background: #252525; border-radius: 3px; display: none;">
                                <div style="font-size: 12px; color: #888; margin-bottom: 6px;">TRAINING RESULTS</div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                                    <div>
                                        <div style="font-size: 10px; color: #666;">ACCURACY</div>
                                        <div id="trainAccuracy" style="font-size: 16px; font-weight: 700; color: #22c55e;">--</div>
                                    </div>
                                    <div>
                                        <div style="font-size: 10px; color: #666;">SAMPLES</div>
                                        <div id="trainSamples" style="font-size: 16px; font-weight: 700; color: #60a5fa;">--</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- PREDICTIONS TAB -->
                    <div id="aiPredictionsTab" class="ai-tab-content" style="display: none;">
                        <div style="padding: 10px; background: #1a1a1a; border: 1px solid #333; border-radius: 4px; margin-bottom: 12px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <div style="font-size: 13px; color: #888; font-weight: 700;">WORKLIST PREDICTIONS</div>
                                <button class="btn btn-secondary" onclick="predictWorklist()" style="font-size: 11px; padding: 4px 8px;">
                                    üîÑ REFRESH
                                </button>
                            </div>
                            <div id="worklistPredictions" style="max-height: 400px; overflow-y: auto;">
                                <div class="empty-state" style="padding: 20px; font-size: 13px;">Click REFRESH to get predictions</div>
                            </div>
                        </div>

                        <div style="padding: 10px; background: #1a1a1a; border: 1px solid #333; border-radius: 4px;">
                            <div style="font-size: 13px; color: #888; margin-bottom: 8px; font-weight: 700;">SINGLE SYMBOL PREDICTION</div>
                            <div style="display: flex; gap: 6px;">
                                <input type="text" id="singlePredictSymbol" value="" placeholder="Enter symbol..."
                                       style="flex: 1; padding: 6px 8px; background: #252525; border: 1px solid #404040; color: #fff; font-size: 14px; border-radius: 3px;">
                                <button class="btn btn-secondary" onclick="predictSingle()" style="font-size: 13px; padding: 6px 16px;">
                                    PREDICT
                                </button>
                            </div>
                            <div id="singlePredictionResult" style="margin-top: 12px; display: none;">
                                <!-- Results appear here -->
                            </div>
                        </div>
                    </div>

                    <!-- BACKTEST TAB -->
                    <div id="aiBacktestTab" class="ai-tab-content" style="display: none;">
                        <div style="padding: 10px; background: #1a1a1a; border: 1px solid #333; border-radius: 4px; margin-bottom: 12px;">
                            <div style="font-size: 13px; color: #888; margin-bottom: 8px; font-weight: 700;">BACKTEST CONFIGURATION</div>

                            <div style="margin-bottom: 8px;">
                                <label style="font-size: 12px; color: #888; display: block; margin-bottom: 3px;">Symbols (comma separated)</label>
                                <div style="display: flex; gap: 6px;">
                                    <input type="text" id="backtestSymbols" value="AAPL,MSFT,GOOGL" placeholder="AAPL,MSFT,GOOGL"
                                           style="flex: 1; padding: 6px 8px; background: #252525; border: 1px solid #404040; color: #fff; font-size: 14px; border-radius: 3px;">
                                    <button onclick="loadWorklistSymbols('backtestSymbols')" style="padding: 6px 12px; background: #007acc; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 11px; white-space: nowrap;">
                                        üìã Worklist
                                    </button>
                                </div>
                            </div>

                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 8px;">
                                <div>
                                    <label style="font-size: 12px; color: #888; display: block; margin-bottom: 3px;">Start Date</label>
                                    <input type="date" id="backtestStartDate" value="2024-09-01"
                                           style="width: 100%; padding: 6px 8px; background: #252525; border: 1px solid #404040; color: #fff; font-size: 14px; border-radius: 3px;">
                                </div>
                                <div>
                                    <label style="font-size: 12px; color: #888; display: block; margin-bottom: 3px;">End Date</label>
                                    <input type="date" id="backtestEndDate" value="2025-12-01"
                                           style="width: 100%; padding: 6px 8px; background: #252525; border: 1px solid #404040; color: #fff; font-size: 14px; border-radius: 3px;">
                                </div>
                            </div>

                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 8px;">
                                <div>
                                    <label style="font-size: 12px; color: #888; display: block; margin-bottom: 3px;">Initial Capital $</label>
                                    <input type="number" id="backtestCapital" value="100000" min="1000" step="1000"
                                           style="width: 100%; padding: 6px 8px; background: #252525; border: 1px solid #404040; color: #fff; font-size: 14px; border-radius: 3px;">
                                </div>
                                <div>
                                    <label style="font-size: 12px; color: #888; display: block; margin-bottom: 3px;">Position Size %</label>
                                    <input type="number" id="backtestPositionSize" value="10" min="5" max="100" step="5"
                                           style="width: 100%; padding: 6px 8px; background: #252525; border: 1px solid #404040; color: #fff; font-size: 14px; border-radius: 3px;">
                                </div>
                            </div>

                            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-bottom: 8px;">
                                <div>
                                    <label style="font-size: 12px; color: #888; display: block; margin-bottom: 3px;">Stop Loss %</label>
                                    <input type="number" id="backtestStopLoss" value="4" min="1" max="20" step="0.5"
                                           style="width: 100%; padding: 6px 8px; background: #252525; border: 1px solid #404040; color: #fff; font-size: 14px; border-radius: 3px;">
                                </div>
                                <div>
                                    <label style="font-size: 12px; color: #888; display: block; margin-bottom: 3px;">Take Profit %</label>
                                    <input type="number" id="backtestTakeProfit" value="6" min="1" max="50" step="0.5"
                                           style="width: 100%; padding: 6px 8px; background: #252525; border: 1px solid #404040; color: #fff; font-size: 14px; border-radius: 3px;">
                                </div>
                                <div>
                                    <label style="font-size: 12px; color: #888; display: block; margin-bottom: 3px;">Trailing Stop %</label>
                                    <input type="number" id="backtestTrailingStop" value="2.5" min="0.5" max="10" step="0.5"
                                           style="width: 100%; padding: 6px 8px; background: #252525; border: 1px solid #404040; color: #fff; font-size: 14px; border-radius: 3px;">
                                </div>
                            </div>

                            <!-- Advanced Options -->
                            <div style="margin-bottom: 8px; padding: 8px; background: #252525; border-radius: 4px;">
                                <div style="font-size: 11px; color: #888; margin-bottom: 6px; font-weight: 600;">ADVANCED OPTIONS</div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                                    <label style="display: flex; align-items: center; gap: 6px; font-size: 11px; color: #aaa; cursor: pointer;">
                                        <input type="checkbox" id="backtestSlippage" checked style="accent-color: #22c55e;">
                                        Include Slippage Model
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 6px; font-size: 11px; color: #aaa; cursor: pointer;">
                                        <input type="checkbox" id="backtestEODLiquidation" checked style="accent-color: #22c55e;">
                                        EOD Liquidation (3:45 PM)
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 6px; font-size: 11px; color: #aaa; cursor: pointer;">
                                        <input type="checkbox" id="backtestMonteCarlo" style="accent-color: #22c55e;">
                                        Run Monte Carlo (1000 sims)
                                    </label>
                                    <div style="display: flex; align-items: center; gap: 6px; font-size: 11px; color: #aaa;">
                                        <span>Max Positions:</span>
                                        <input type="number" id="backtestMaxPositions" value="5" min="1" max="20" step="1"
                                               style="width: 50px; padding: 3px 6px; background: #1a1a1a; border: 1px solid #404040; color: #fff; font-size: 11px; border-radius: 3px;">
                                    </div>
                                </div>
                            </div>

                            <div style="margin-top: 8px; padding: 8px; background: #2d2d2d; border-left: 3px solid #22c55e; border-radius: 3px; font-size: 11px; color: #22c55e;">
                                ‚úì <strong>Enhanced Backtester:</strong> Warrior Trading rules with slippage modeling, EOD liquidation, and Monte Carlo analysis.
                            </div>

                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 8px;">
                                <button id="runBacktestBtn" class="btn btn-buy" onclick="runEnhancedBacktest()" style="font-size: 14px; padding: 10px;">
                                    üìä RUN BACKTEST
                                </button>
                                <button id="quickBacktestBtn" class="btn btn-secondary" onclick="runQuickBacktest()" style="font-size: 14px; padding: 10px;">
                                    ‚ö° QUICK (30 Days)
                                </button>
                            </div>
                            <div style="margin-top: 12px; padding: 10px; background: #1e3a5f; border-radius: 4px; border: 1px solid #3b82f6;">
                                <div style="font-size: 12px; color: #60a5fa; margin-bottom: 6px; font-weight: 600;">üî¨ ENSEMBLE COMPARISON</div>
                                <div style="font-size: 11px; color: #888; margin-bottom: 8px;">Compare Single vs Parallel vs Hybrid ensemble performance</div>
                                <button class="btn" onclick="window.open('/ui/ensemble_backtest.html', '_blank')" style="background: #3b82f6; color: white; font-size: 12px; padding: 8px 16px; width: 100%;">
                                    Open Ensemble Comparison Tool ‚Üí
                                </button>
                            </div>
                        </div>

                        <!-- Backtest Results -->
                        <div id="backtestResults" style="padding: 10px; background: #1a1a1a; border: 1px solid #333; border-radius: 4px; display: none;">
                            <div style="font-size: 13px; color: #888; margin-bottom: 8px; font-weight: 700;">BACKTEST RESULTS</div>
                            <div id="backtestMetrics" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-bottom: 12px;">
                                <!-- Metrics grid -->
                            </div>
                            <div id="backtestExitReasons" style="margin-top: 12px; display: none;">
                                <!-- Exit reasons breakdown -->
                            </div>
                            <div id="backtestMonteCarlo" style="margin-top: 12px; display: none;">
                                <!-- Monte Carlo results -->
                            </div>
                            <div id="backtestEquityCurve" style="margin-top: 12px;">
                                <!-- Equity curve chart -->
                            </div>
                        </div>
                    </div>

                    <!-- MODELS TAB -->
                    <div id="aiModelsTab" class="ai-tab-content" style="display: none;">
                        <!-- Current Model Status -->
                        <div style="padding: 10px; background: #1a1a1a; border: 1px solid #333; border-radius: 4px; margin-bottom: 12px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <div style="font-size: 13px; color: #888; font-weight: 700;">CURRENT MODEL</div>
                                <button onclick="refreshModelStatus()" style="padding: 4px 8px; background: #333; border: none; color: #888; border-radius: 3px; cursor: pointer; font-size: 11px;">üîÑ</button>
                            </div>
                            <div id="currentModelStatus">
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                                    <div style="padding: 8px; background: #252525; border-radius: 4px;">
                                        <div style="font-size: 10px; color: #666;">ACCURACY</div>
                                        <div id="modelAccuracy" style="font-size: 18px; font-weight: 700; color: #22c55e;">--</div>
                                    </div>
                                    <div style="padding: 8px; background: #252525; border-radius: 4px;">
                                        <div style="font-size: 10px; color: #666;">LAST TRAINED</div>
                                        <div id="modelTrainDate" style="font-size: 12px; font-weight: 600; color: #60a5fa;">--</div>
                                    </div>
                                </div>
                                <div id="topFeatures" style="margin-top: 8px; padding: 8px; background: #252525; border-radius: 4px;">
                                    <div style="font-size: 10px; color: #666; margin-bottom: 4px;">TOP FEATURES</div>
                                    <div id="topFeaturesList" style="font-size: 11px; color: #aaa;">--</div>
                                </div>
                            </div>
                        </div>

                        <!-- Market Regime Status -->
                        <div style="padding: 10px; background: #1a1a1a; border: 1px solid #333; border-radius: 4px; margin-bottom: 12px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <div style="font-size: 13px; color: #888; font-weight: 700;">MARKET REGIME</div>
                                <button onclick="detectRegime()" style="padding: 4px 8px; background: #333; border: none; color: #888; border-radius: 3px; cursor: pointer; font-size: 11px;">üîÑ DETECT</button>
                            </div>
                            <div id="regimeStatus">
                                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                                    <div id="regimeIndicator" style="width: 12px; height: 12px; border-radius: 50%; background: #666;"></div>
                                    <div>
                                        <div id="regimeType" style="font-size: 14px; font-weight: 700; color: #fff;">Unknown</div>
                                        <div id="regimeConfidence" style="font-size: 11px; color: #888;">Click DETECT to analyze</div>
                                    </div>
                                </div>
                                <div id="regimeAdjustments" style="padding: 8px; background: #252525; border-radius: 4px; font-size: 11px; color: #888; display: none;">
                                    <div style="font-size: 10px; color: #666; margin-bottom: 4px;">RECOMMENDED ADJUSTMENTS</div>
                                    <div id="regimeAdjustmentsList">--</div>
                                </div>
                            </div>
                        </div>

                        <!-- Drift Detection Status -->
                        <div style="padding: 10px; background: #1a1a1a; border: 1px solid #333; border-radius: 4px; margin-bottom: 12px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <div style="font-size: 13px; color: #888; font-weight: 700;">DATA DRIFT</div>
                                <button onclick="checkDrift()" style="padding: 4px 8px; background: #333; border: none; color: #888; border-radius: 3px; cursor: pointer; font-size: 11px;">üîÑ CHECK</button>
                            </div>
                            <div id="driftStatus">
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <div id="driftIndicator" style="width: 12px; height: 12px; border-radius: 50%; background: #22c55e;"></div>
                                    <div>
                                        <div id="driftSeverity" style="font-size: 14px; font-weight: 700; color: #22c55e;">No Drift</div>
                                        <div id="driftMessage" style="font-size: 11px; color: #888;">Model is stable</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Scheduler Status -->
                        <div style="padding: 10px; background: #1a1a1a; border: 1px solid #333; border-radius: 4px;">
                            <div style="font-size: 13px; color: #888; margin-bottom: 8px; font-weight: 700;">AUTO-RETRAIN SCHEDULER</div>
                            <div id="schedulerStatus">
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                                    <div style="padding: 8px; background: #252525; border-radius: 4px;">
                                        <div style="font-size: 10px; color: #666;">NEXT SCHEDULED</div>
                                        <div id="nextTrainTime" style="font-size: 11px; font-weight: 600; color: #f59e0b;">--</div>
                                    </div>
                                    <div style="padding: 8px; background: #252525; border-radius: 4px;">
                                        <div style="font-size: 10px; color: #666;">PENDING JOBS</div>
                                        <div id="pendingJobs" style="font-size: 14px; font-weight: 700; color: #60a5fa;">0</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- BOT TRADING TAB -->
                    <div id="aiBotTab" class="ai-tab-content" style="display: none;">
                        <!-- Bot Status -->
                        <div style="padding: 12px; background: #1a1a1a; border: 2px solid #007acc; border-radius: 4px; margin-bottom: 12px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <div style="font-size: 14px; color: #007acc; font-weight: 700;">ü§ñ BOT STATUS</div>
                                <div id="botStatusIndicator" style="display: flex; align-items: center; gap: 6px; padding: 4px 12px; background: #252525; border-radius: 3px;">
                                    <div style="width: 10px; height: 10px; border-radius: 50%; background: #ef4444;"></div>
                                    <span style="font-size: 12px; font-weight: 600; color: #ef4444;">STOPPED</span>
                                </div>
                            </div>

                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; margin-bottom: 10px;">
                                <div style="padding: 8px; background: #252525; border-radius: 3px;">
                                    <div style="font-size: 11px; color: #888;">RUNNING</div>
                                    <div id="botRunning" style="font-size: 16px; font-weight: 600; color: #ef4444;">FALSE</div>
                                </div>
                                <div style="padding: 8px; background: #252525; border-radius: 3px;">
                                    <div style="font-size: 11px; color: #888;">TRADING</div>
                                    <div id="botEnabled" style="font-size: 16px; font-weight: 600; color: #ef4444;">FALSE</div>
                                </div>
                                <div style="padding: 8px; background: #252525; border-radius: 3px;">
                                    <div style="font-size: 11px; color: #888;">SIGNALS</div>
                                    <div id="botSignals" style="font-size: 16px; font-weight: 600; color: #007acc;">0</div>
                                </div>
                                <div style="padding: 8px; background: #252525; border-radius: 3px;">
                                    <div style="font-size: 11px; color: #888;">TRADES</div>
                                    <div id="botTrades" style="font-size: 16px; font-weight: 600; color: #007acc;">0</div>
                                </div>
                                <div style="padding: 8px; background: #252525; border-radius: 3px;">
                                    <div style="font-size: 11px; color: #888;">POSITIONS</div>
                                    <div id="botPositions" style="font-size: 16px; font-weight: 600; color: #007acc;">0</div>
                                </div>
                                <div style="padding: 8px; background: #252525; border-radius: 3px;">
                                    <div style="font-size: 11px; color: #888;">DAILY P&L</div>
                                    <div id="botPnL" style="font-size: 16px; font-weight: 600; color: #888;">$0.00</div>
                                </div>
                            </div>

                            <!-- Control Buttons -->
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px;">
                                <button onclick="startBot()" style="padding: 10px; background: #22c55e; border: none; color: #fff; font-size: 13px; font-weight: 600; border-radius: 3px; cursor: pointer;">
                                    ‚ñ∂Ô∏è START BOT
                                </button>
                                <button onclick="stopBot()" style="padding: 10px; background: #ef4444; border: none; color: #fff; font-size: 13px; font-weight: 600; border-radius: 3px; cursor: pointer;">
                                    ‚èπÔ∏è STOP BOT
                                </button>
                                <button onclick="enableBotTrading()" style="padding: 10px; background: #3b82f6; border: none; color: #fff; font-size: 13px; font-weight: 600; border-radius: 3px; cursor: pointer;">
                                    ‚úÖ ENABLE TRADING
                                </button>
                                <button onclick="disableBotTrading()" style="padding: 10px; background: #f59e0b; border: none; color: #fff; font-size: 13px; font-weight: 600; border-radius: 3px; cursor: pointer;">
                                    ‚è∏Ô∏è PAUSE TRADING
                                </button>
                            </div>
                        </div>

                        <!-- Risk Limits -->
                        <div style="padding: 10px; background: #1a1a1a; border: 1px solid #ef4444; border-radius: 4px; margin-bottom: 12px;">
                            <div style="font-size: 13px; color: #ef4444; margin-bottom: 8px; font-weight: 700;">‚ö†Ô∏è RISK LIMITS</div>
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; font-size: 11px;">
                                <div style="padding: 6px; background: #252525; border-radius: 3px; text-align: center;">
                                    <div style="color: #888;">MAX/TRADE</div>
                                    <div id="botMaxRisk" style="font-weight: 600; color: #ef4444;">$50</div>
                                </div>
                                <div style="padding: 6px; background: #252525; border-radius: 3px; text-align: center;">
                                    <div style="color: #888;">DAILY LIMIT</div>
                                    <div id="botDailyLimit" style="font-weight: 600; color: #ef4444;">$500</div>
                                </div>
                                <div style="padding: 6px; background: #252525; border-radius: 3px; text-align: center;">
                                    <div style="color: #888;">WEEKLY LIMIT</div>
                                    <div id="botWeeklyLimit" style="font-weight: 600; color: #ef4444;">$3,500</div>
                                </div>
                            </div>
                        </div>

                        <!-- TRADING PIPELINE - Automated Flow -->
                        <div style="padding: 10px; background: #1a1a1a; border: 1px solid #10b981; border-radius: 4px; margin-bottom: 12px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <div style="font-size: 13px; color: #10b981; font-weight: 700;">üîÑ TRADING PIPELINE</div>
                                <div id="pipelineStatusBadge" style="padding: 2px 8px; background: #252525; border-radius: 3px; font-size: 10px;">
                                    <span style="color: #888;">STOPPED</span>
                                </div>
                            </div>

                            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; margin-bottom: 10px; font-size: 10px;">
                                <div style="padding: 6px; background: #252525; border-radius: 3px; text-align: center;">
                                    <div style="color: #888;">SCANNED</div>
                                    <div id="pipelineScanned" style="font-weight: 600; color: #007acc;">0</div>
                                </div>
                                <div style="padding: 6px; background: #252525; border-radius: 3px; text-align: center;">
                                    <div style="color: #888;">ADDED</div>
                                    <div id="pipelineAdded" style="font-weight: 600; color: #22c55e;">0</div>
                                </div>
                                <div style="padding: 6px; background: #252525; border-radius: 3px; text-align: center;">
                                    <div style="color: #888;">ANALYZED</div>
                                    <div id="pipelineAnalyzed" style="font-weight: 600; color: #f59e0b;">0</div>
                                </div>
                                <div style="padding: 6px; background: #252525; border-radius: 3px; text-align: center;">
                                    <div style="color: #888;">EXECUTED</div>
                                    <div id="pipelineExecuted" style="font-weight: 600; color: #ef4444;">0</div>
                                </div>
                            </div>

                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 6px;">
                                <button onclick="startPipeline()" style="padding: 8px; background: #10b981; border: none; color: #fff; font-size: 11px; font-weight: 600; border-radius: 3px; cursor: pointer;">
                                    ‚ñ∂Ô∏è START PIPELINE
                                </button>
                                <button onclick="stopPipeline()" style="padding: 8px; background: #6b7280; border: none; color: #fff; font-size: 11px; font-weight: 600; border-radius: 3px; cursor: pointer;">
                                    ‚èπÔ∏è STOP PIPELINE
                                </button>
                            </div>
                        </div>

                        <!-- TRADING COACH -->
                        <div style="padding: 10px; background: #1a1a1a; border: 1px solid #8b5cf6; border-radius: 4px; margin-bottom: 12px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <div style="font-size: 13px; color: #8b5cf6; font-weight: 700;">üéØ TRADING COACH</div>
                                <div id="coachWindowBadge" style="padding: 2px 8px; background: #252525; border-radius: 3px; font-size: 10px; color: #888;">
                                    AFTER_HOURS
                                </div>
                            </div>

                            <div id="coachStatus" style="padding: 8px; background: #252525; border-radius: 3px; margin-bottom: 8px; font-size: 11px; color: #ccc;">
                                Loading coach status...
                            </div>

                            <div id="emotionalPatterns" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 4px; margin-bottom: 8px; font-size: 9px;">
                                <div style="padding: 4px; background: #252525; border-radius: 2px; text-align: center;">
                                    <div style="color: #888;">FOMO</div>
                                    <div id="patternFomo" style="color: #10b981;">0</div>
                                </div>
                                <div style="padding: 4px; background: #252525; border-radius: 2px; text-align: center;">
                                    <div style="color: #888;">REVENGE</div>
                                    <div id="patternRevenge" style="color: #10b981;">0</div>
                                </div>
                                <div style="padding: 4px; background: #252525; border-radius: 2px; text-align: center;">
                                    <div style="color: #888;">FEAR</div>
                                    <div id="patternFear" style="color: #10b981;">0</div>
                                </div>
                            </div>

                            <div id="coachAssessment" style="padding: 6px; background: #252525; border-radius: 3px; font-size: 10px; color: #22c55e; text-align: center;">
                                ‚úì No emotional trading detected
                            </div>
                        </div>

                        <!-- AI TRADER QUEUE -->
                        <div style="padding: 10px; background: #1a1a1a; border: 1px solid #f59e0b; border-radius: 4px; margin-bottom: 12px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <div style="font-size: 13px; color: #f59e0b; font-weight: 700;">ü§ñ AI TRADER QUEUE</div>
                                <div id="aiTraderMode" style="padding: 2px 8px; background: #252525; border-radius: 3px; font-size: 10px; color: #f59e0b;">
                                    PAPER
                                </div>
                            </div>

                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; margin-bottom: 8px; font-size: 10px;">
                                <div style="padding: 6px; background: #252525; border-radius: 3px; text-align: center;">
                                    <div style="color: #888;">PENDING</div>
                                    <div id="aiTraderPending" style="font-weight: 600; color: #007acc;">0</div>
                                </div>
                                <div style="padding: 6px; background: #252525; border-radius: 3px; text-align: center;">
                                    <div style="color: #888;">TODAY</div>
                                    <div id="aiTraderToday" style="font-weight: 600; color: #22c55e;">0</div>
                                </div>
                                <div style="padding: 6px; background: #252525; border-radius: 3px; text-align: center;">
                                    <div style="color: #888;">MAX/DAY</div>
                                    <div id="aiTraderMax" style="font-weight: 600; color: #888;">10</div>
                                </div>
                            </div>

                            <div id="aiTraderQueue" style="max-height: 80px; overflow-y: auto; font-size: 10px; background: #252525; border-radius: 3px; padding: 6px;">
                                <div style="color: #666; text-align: center;">No opportunities in queue</div>
                            </div>
                        </div>

                        <!-- WORKLIST (Shared with Platform) -->
                        <div style="padding: 10px; background: #1a1a1a; border: 1px solid #333; border-radius: 4px; margin-bottom: 12px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <div style="font-size: 13px; color: #888; font-weight: 700;">üìã WORKLIST (Shared)</div>
                                <button onclick="syncWorklistWithScanner()" style="padding: 4px 10px; background: #007acc; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 11px; font-weight: 600;">
                                    üîÑ Add Scanner
                                </button>
                            </div>
                            <div id="botWorklist" style="font-size: 12px; color: #007acc; font-weight: 600;">
                                Loading...
                            </div>
                            <div id="worklistCount" style="font-size: 10px; color: #666; margin-top: 6px;">
                                0 symbols
                            </div>
                            <div style="font-size: 10px; color: #666; margin-top: 4px; padding-top: 4px; border-top: 1px solid #333;">
                                üí° Same worklist used for training, backtesting, predictions & bot trading
                            </div>
                        </div>

                        <!-- Recent Signals -->
                        <div style="padding: 10px; background: #1a1a1a; border: 1px solid #333; border-radius: 4px; margin-bottom: 12px;">
                            <div style="font-size: 13px; color: #888; margin-bottom: 8px; font-weight: 700;">üîî RECENT SIGNALS</div>
                            <div id="botSignalsList" style="max-height: 150px; overflow-y: auto; font-size: 11px;">
                                <div class="empty-state" style="padding: 20px; font-size: 12px;">No signals yet. Bot will generate signals when it finds opportunities.</div>
                            </div>
                        </div>

                        <!-- Open Positions -->
                        <div style="padding: 10px; background: #1a1a1a; border: 1px solid #333; border-radius: 4px;">
                            <div style="font-size: 13px; color: #888; margin-bottom: 8px; font-weight: 700;">üìä OPEN POSITIONS</div>
                            <div id="botOpenPositions" style="max-height: 200px; overflow-y: auto; font-size: 11px;">
                                <div class="empty-state" style="padding: 20px; font-size: 12px;">No open positions</div>
                            </div>
                        </div>

                        <!-- Auto-refresh notice -->
                        <div style="margin-top: 12px; padding: 8px; background: #252525; border-left: 3px solid #007acc; border-radius: 3px; font-size: 11px; color: #888;">
                            ‚ÑπÔ∏è Status updates every 5 seconds automatically
                        </div>
                    </div>

                    <!-- MORPHIC AI TAB -->
                    <div id="aiMorphicTab" class="ai-tab-content" style="display: none;">
                        <!-- Morphic Status Banner -->
                        <div style="padding: 12px; background: linear-gradient(135deg, #1a1a2e, #16213e); border: 2px solid #8b5cf6; border-radius: 6px; margin-bottom: 12px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <div style="font-size: 14px; color: #8b5cf6; font-weight: 700;">üß¨ MORPHIC AI CONTROLLER</div>
                                <div id="morphicStatusBadge" style="padding: 4px 12px; background: #252525; border-radius: 3px; font-size: 11px; font-weight: 600; color: #22c55e;">
                                    HEALTHY
                                </div>
                            </div>
                            <div style="font-size: 11px; color: #888; margin-bottom: 10px;">
                                Self-adapting AI that monitors, refines, and rebuilds models based on market conditions
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px;">
                                <div style="padding: 8px; background: rgba(139, 92, 246, 0.1); border: 1px solid #8b5cf6; border-radius: 4px; text-align: center;">
                                    <div style="font-size: 10px; color: #888;">REGIME</div>
                                    <div id="morphicRegime" style="font-size: 13px; font-weight: 700; color: #8b5cf6;">RANGE</div>
                                </div>
                                <div style="padding: 8px; background: rgba(34, 197, 94, 0.1); border: 1px solid #22c55e; border-radius: 4px; text-align: center;">
                                    <div style="font-size: 10px; color: #888;">HEALTH</div>
                                    <div id="morphicHealth" style="font-size: 13px; font-weight: 700; color: #22c55e;">HEALTHY</div>
                                </div>
                                <div style="padding: 8px; background: rgba(59, 130, 246, 0.1); border: 1px solid #3b82f6; border-radius: 4px; text-align: center;">
                                    <div style="font-size: 10px; color: #888;">RISK</div>
                                    <div id="morphicRisk" style="font-size: 13px; font-weight: 700; color: #3b82f6;">1.0x</div>
                                </div>
                                <div style="padding: 8px; background: rgba(249, 115, 22, 0.1); border: 1px solid #f97316; border-radius: 4px; text-align: center;">
                                    <div style="font-size: 10px; color: #888;">STRATEGY</div>
                                    <div id="morphicStrategy" style="font-size: 13px; font-weight: 700; color: #f97316;">BALANCED</div>
                                </div>
                            </div>
                        </div>

                        <!-- Morphic Controls -->
                        <div style="padding: 10px; background: #1a1a1a; border: 1px solid #333; border-radius: 4px; margin-bottom: 12px;">
                            <div style="font-size: 13px; color: #888; margin-bottom: 10px; font-weight: 700;">‚öôÔ∏è MORPHIC CONTROLS</div>

                            <!-- Auto-Adapt Toggle -->
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; background: #252525; border-radius: 4px; margin-bottom: 8px;">
                                <div>
                                    <div style="font-size: 12px; color: #fff; font-weight: 600;">Auto-Adapt Mode</div>
                                    <div style="font-size: 10px; color: #666;">Automatically adjust to market changes</div>
                                </div>
                                <label style="position: relative; display: inline-block; width: 50px; height: 24px;">
                                    <input type="checkbox" id="morphicAutoAdapt" onchange="toggleMorphicAutoAdapt()" checked style="opacity: 0; width: 0; height: 0;">
                                    <span style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #22c55e; transition: .3s; border-radius: 24px;"></span>
                                </label>
                            </div>

                            <!-- Risk Multiplier -->
                            <div style="margin-bottom: 8px;">
                                <label style="font-size: 11px; color: #888; display: block; margin-bottom: 3px;">Risk Multiplier: <span id="riskMultiplierValue">1.0x</span></label>
                                <input type="range" id="morphicRiskSlider" min="0.1" max="2.0" step="0.1" value="1.0" onchange="updateMorphicRisk(this.value)" style="width: 100%; accent-color: #8b5cf6;">
                                <div style="display: flex; justify-content: space-between; font-size: 9px; color: #666;">
                                    <span>0.1x (Conservative)</span>
                                    <span>2.0x (Aggressive)</span>
                                </div>
                            </div>

                            <!-- Confidence Threshold -->
                            <div style="margin-bottom: 8px;">
                                <label style="font-size: 11px; color: #888; display: block; margin-bottom: 3px;">Confidence Threshold: <span id="confThresholdValue">65%</span></label>
                                <input type="range" id="morphicConfSlider" min="50" max="95" step="5" value="65" onchange="updateMorphicConfidence(this.value)" style="width: 100%; accent-color: #8b5cf6;">
                                <div style="display: flex; justify-content: space-between; font-size: 9px; color: #666;">
                                    <span>50% (More trades)</span>
                                    <span>95% (Fewer trades)</span>
                                </div>
                            </div>

                            <!-- Action Buttons -->
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; margin-top: 10px;">
                                <button onclick="morphicAnalyzeRegime()" style="padding: 10px; background: #8b5cf6; border: none; color: #fff; font-size: 12px; font-weight: 600; border-radius: 4px; cursor: pointer;">
                                    üîç Analyze Regime
                                </button>
                                <button onclick="morphicDetectDrift()" style="padding: 10px; background: #3b82f6; border: none; color: #fff; font-size: 12px; font-weight: 600; border-radius: 4px; cursor: pointer;">
                                    üìä Detect Drift
                                </button>
                                <button onclick="morphicAutoRetrain()" style="padding: 10px; background: #22c55e; border: none; color: #fff; font-size: 12px; font-weight: 600; border-radius: 4px; cursor: pointer;">
                                    üöÄ Auto Retrain
                                </button>
                                <button onclick="morphicValidateStrategy()" style="padding: 10px; background: #f97316; border: none; color: #fff; font-size: 12px; font-weight: 600; border-radius: 4px; cursor: pointer;">
                                    ‚úÖ Validate Strategy
                                </button>
                            </div>
                        </div>

                        <!-- Claude AI Analysis -->
                        <div style="padding: 10px; background: #1a1a1a; border: 1px solid #333; border-radius: 4px; margin-bottom: 12px;">
                            <div style="font-size: 13px; color: #888; margin-bottom: 8px; font-weight: 700;">ü§ñ CLAUDE AI ANALYSIS</div>
                            <div id="morphicAnalysis" style="max-height: 150px; overflow-y: auto; padding: 8px; background: #252525; border-radius: 4px; font-size: 11px; color: #aaa;">
                                Click "Analyze Regime" or "Detect Drift" to get Claude AI analysis of current market conditions.
                            </div>
                        </div>

                        <!-- Adaptation History -->
                        <div style="padding: 10px; background: #1a1a1a; border: 1px solid #333; border-radius: 4px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <div style="font-size: 13px; color: #888; font-weight: 700;">üìú ADAPTATION HISTORY</div>
                                <button onclick="loadMorphicHistory()" style="padding: 4px 8px; background: #252525; border: 1px solid #404040; color: #888; font-size: 10px; border-radius: 3px; cursor: pointer;">
                                    üîÑ Refresh
                                </button>
                            </div>
                            <div id="morphicHistory" style="max-height: 120px; overflow-y: auto; font-size: 11px;">
                                <div style="padding: 6px; background: #252525; border-radius: 3px; margin-bottom: 4px; display: flex; justify-content: space-between;">
                                    <span style="color: #8b5cf6;">System initialized</span>
                                    <span style="color: #666;">Ready</span>
                                </div>
                            </div>
                        </div>

                        <!-- Monitoring Toggle -->
                        <div style="margin-top: 12px; display: flex; gap: 8px;">
                            <button onclick="startMorphicMonitoring()" style="flex: 1; padding: 10px; background: #22c55e; border: none; color: #fff; font-size: 12px; font-weight: 600; border-radius: 4px; cursor: pointer;">
                                ‚ñ∂Ô∏è Start Monitoring
                            </button>
                            <button onclick="stopMorphicMonitoring()" style="flex: 1; padding: 10px; background: #ef4444; border: none; color: #fff; font-size: 12px; font-weight: 600; border-radius: 4px; cursor: pointer;">
                                ‚èπÔ∏è Stop Monitoring
                            </button>
                        </div>

                        <!-- Info -->
                        <div style="margin-top: 12px; padding: 8px; background: #252525; border-left: 3px solid #8b5cf6; border-radius: 3px; font-size: 10px; color: #888;">
                            üß¨ Morphic AI continuously monitors market regimes, detects model drift, and automatically adapts trading parameters to maintain optimal performance.
                        </div>
                    </div>

                    <!-- STRATEGIES TAB -->
                    <div id="aiStrategiesTab" class="ai-tab-content" style="display: none;">
                        <!-- Strategy Library Header -->
                        <div style="padding: 12px; background: linear-gradient(135deg, #1a2e1a, #162e16); border: 2px solid #22c55e; border-radius: 6px; margin-bottom: 12px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <div style="font-size: 14px; color: #22c55e; font-weight: 700;">üìã STRATEGY TEMPLATE LIBRARY</div>
                                <div id="strategyMonitorBadge" style="padding: 4px 12px; background: #252525; border-radius: 3px; font-size: 11px; font-weight: 600; color: #888;">
                                    MONITOR: OFF
                                </div>
                            </div>
                            <div style="font-size: 11px; color: #888; margin-bottom: 10px;">
                                Claude AI-driven strategy management with auto-switching based on market conditions
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px;">
                                <div style="padding: 8px; background: rgba(34, 197, 94, 0.1); border: 1px solid #22c55e; border-radius: 4px; text-align: center;">
                                    <div style="font-size: 10px; color: #888;">ACTIVE STRATEGY</div>
                                    <div id="activeStrategyName" style="font-size: 12px; font-weight: 700; color: #22c55e;">Momentum Warrior</div>
                                </div>
                                <div style="padding: 8px; background: rgba(59, 130, 246, 0.1); border: 1px solid #3b82f6; border-radius: 4px; text-align: center;">
                                    <div style="font-size: 10px; color: #888;">WIN RATE</div>
                                    <div id="strategyWinRate" style="font-size: 12px; font-weight: 700; color: #3b82f6;">0.0%</div>
                                </div>
                                <div style="padding: 8px; background: rgba(249, 115, 22, 0.1); border: 1px solid #f97316; border-radius: 4px; text-align: center;">
                                    <div style="font-size: 10px; color: #888;">PROFIT FACTOR</div>
                                    <div id="strategyProfitFactor" style="font-size: 12px; font-weight: 700; color: #f97316;">0.0</div>
                                </div>
                            </div>
                        </div>

                        <!-- Available Strategies -->
                        <div style="padding: 10px; background: #1a1a1a; border: 1px solid #333; border-radius: 4px; margin-bottom: 12px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <div style="font-size: 13px; color: #888; font-weight: 700;">üìö AVAILABLE STRATEGIES</div>
                                <button onclick="loadStrategyTemplates()" style="padding: 4px 8px; background: #252525; border: 1px solid #404040; color: #888; font-size: 10px; border-radius: 3px; cursor: pointer;">
                                    üîÑ Refresh
                                </button>
                            </div>
                            <div id="strategyList" style="max-height: 200px; overflow-y: auto;">
                                <div style="padding: 8px; background: #252525; border-left: 3px solid #22c55e; border-radius: 3px; margin-bottom: 6px; cursor: pointer;" onclick="activateStrategy('momentum_warrior')">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <div>
                                            <span style="color: #22c55e; font-weight: 600; font-size: 12px;">üöÄ Momentum Warrior</span>
                                            <span style="margin-left: 8px; padding: 2px 6px; background: #22c55e; color: #000; font-size: 9px; border-radius: 2px;">ACTIVE</span>
                                        </div>
                                        <span style="color: #666; font-size: 10px;">MOMENTUM</span>
                                    </div>
                                    <div style="font-size: 10px; color: #888; margin-top: 4px;">Strong moves with volume confirmation</div>
                                </div>
                                <div style="padding: 8px; background: #252525; border-left: 3px solid #3b82f6; border-radius: 3px; margin-bottom: 6px; cursor: pointer;" onclick="activateStrategy('mean_reversion_bounce')">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <div>
                                            <span style="color: #3b82f6; font-weight: 600; font-size: 12px;">üìà Mean Reversion Bounce</span>
                                        </div>
                                        <span style="color: #666; font-size: 10px;">MEAN REVERSION</span>
                                    </div>
                                    <div style="font-size: 10px; color: #888; margin-top: 4px;">Oversold bounces using Bollinger & RSI</div>
                                </div>
                                <div style="padding: 8px; background: #252525; border-left: 3px solid #f97316; border-radius: 3px; margin-bottom: 6px; cursor: pointer;" onclick="activateStrategy('breakout_explosion')">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <div>
                                            <span style="color: #f97316; font-weight: 600; font-size: 12px;">üí• Breakout Explosion</span>
                                        </div>
                                        <span style="color: #666; font-size: 10px;">BREAKOUT</span>
                                    </div>
                                    <div style="font-size: 10px; color: #888; margin-top: 4px;">Explosive moves on key level breaks</div>
                                </div>
                                <div style="padding: 8px; background: #252525; border-left: 3px solid #8b5cf6; border-radius: 3px; margin-bottom: 6px; cursor: pointer;" onclick="activateStrategy('trend_rider')">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <div>
                                            <span style="color: #8b5cf6; font-weight: 600; font-size: 12px;">üåä Trend Rider</span>
                                        </div>
                                        <span style="color: #666; font-size: 10px;">TREND FOLLOWING</span>
                                    </div>
                                    <div style="font-size: 10px; color: #888; margin-top: 4px;">Ride trends with EMA crossovers</div>
                                </div>
                                <div style="padding: 8px; background: #252525; border-left: 3px solid #ef4444; border-radius: 3px; margin-bottom: 6px; cursor: pointer;" onclick="activateStrategy('gap_and_go')">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <div>
                                            <span style="color: #ef4444; font-weight: 600; font-size: 12px;">üåÖ Gap and Go</span>
                                        </div>
                                        <span style="color: #666; font-size: 10px;">GAP TRADING</span>
                                    </div>
                                    <div style="font-size: 10px; color: #888; margin-top: 4px;">Trade morning gaps with volume</div>
                                </div>
                                <div style="padding: 8px; background: #252525; border-left: 3px solid #06b6d4; border-radius: 3px; margin-bottom: 6px; cursor: pointer;" onclick="activateStrategy('vwap_magnet')">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <div>
                                            <span style="color: #06b6d4; font-weight: 600; font-size: 12px;">üß≤ VWAP Magnet</span>
                                        </div>
                                        <span style="color: #666; font-size: 10px;">VWAP</span>
                                    </div>
                                    <div style="font-size: 10px; color: #888; margin-top: 4px;">VWAP bounces and rejections</div>
                                </div>
                            </div>
                        </div>

                        <!-- Strategy Actions -->
                        <div style="padding: 10px; background: #1a1a1a; border: 1px solid #333; border-radius: 4px; margin-bottom: 12px;">
                            <div style="font-size: 13px; color: #888; margin-bottom: 10px; font-weight: 700;">‚ö° STRATEGY ACTIONS</div>
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px;">
                                <button onclick="evaluateCurrentStrategy()" style="padding: 10px; background: #3b82f6; border: none; color: #fff; font-size: 12px; font-weight: 600; border-radius: 4px; cursor: pointer;">
                                    üìä Evaluate Strategy
                                </button>
                                <button onclick="getStrategyRecommendation()" style="padding: 10px; background: #8b5cf6; border: none; color: #fff; font-size: 12px; font-weight: 600; border-radius: 4px; cursor: pointer;">
                                    ü§ñ Claude Recommendation
                                </button>
                                <button onclick="refineActiveStrategy()" style="padding: 10px; background: #22c55e; border: none; color: #fff; font-size: 12px; font-weight: 600; border-radius: 4px; cursor: pointer;">
                                    üîß Refine from Winners
                                </button>
                                <button onclick="feedTrainingData()" style="padding: 10px; background: #f97316; border: none; color: #fff; font-size: 12px; font-weight: 600; border-radius: 4px; cursor: pointer;">
                                    üéØ Feed Training Data
                                </button>
                            </div>
                        </div>

                        <!-- Claude AI Strategy Analysis -->
                        <div style="padding: 10px; background: #1a1a1a; border: 1px solid #333; border-radius: 4px; margin-bottom: 12px;">
                            <div style="font-size: 13px; color: #888; margin-bottom: 8px; font-weight: 700;">ü§ñ CLAUDE AI STRATEGY ANALYSIS</div>
                            <div id="strategyAnalysis" style="max-height: 120px; overflow-y: auto; padding: 8px; background: #252525; border-radius: 4px; font-size: 11px; color: #aaa;">
                                Click "Evaluate Strategy" or "Claude Recommendation" to get AI analysis of your trading strategies.
                            </div>
                        </div>

                        <!-- Strategy Switch History -->
                        <div style="padding: 10px; background: #1a1a1a; border: 1px solid #333; border-radius: 4px; margin-bottom: 12px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <div style="font-size: 13px; color: #888; font-weight: 700;">üîÑ SWITCH HISTORY</div>
                                <button onclick="loadSwitchHistory()" style="padding: 4px 8px; background: #252525; border: 1px solid #404040; color: #888; font-size: 10px; border-radius: 3px; cursor: pointer;">
                                    üîÑ Refresh
                                </button>
                            </div>
                            <div id="strategySwitchHistory" style="max-height: 100px; overflow-y: auto; font-size: 11px;">
                                <div style="padding: 6px; background: #252525; border-radius: 3px; margin-bottom: 4px; color: #888;">
                                    No strategy switches recorded yet
                                </div>
                            </div>
                        </div>

                        <!-- Monitor Controls -->
                        <div style="display: flex; gap: 8px;">
                            <button onclick="startStrategyMonitor()" style="flex: 1; padding: 10px; background: #22c55e; border: none; color: #fff; font-size: 12px; font-weight: 600; border-radius: 4px; cursor: pointer;">
                                ‚ñ∂Ô∏è Start Monitor
                            </button>
                            <button onclick="stopStrategyMonitor()" style="flex: 1; padding: 10px; background: #ef4444; border: none; color: #fff; font-size: 12px; font-weight: 600; border-radius: 4px; cursor: pointer;">
                                ‚èπÔ∏è Stop Monitor
                            </button>
                        </div>

                        <!-- Info -->
                        <div style="margin-top: 12px; padding: 8px; background: #252525; border-left: 3px solid #22c55e; border-radius: 3px; font-size: 10px; color: #888;">
                            üìã Strategy Library monitors trades, learns from winners, and automatically switches strategies based on market conditions. Claude AI provides real-time analysis and refinement recommendations.
                        </div>
                    </div>

                    <!-- NEWS TAB -->
                    <div id="aiNewsTab" class="ai-tab-content" style="display: none;">
                        <!-- News Feed Header -->
                        <div style="padding: 10px; background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); border: 1px solid #333; border-radius: 4px; margin-bottom: 12px;">
                            <div style="display: flex; align-items: center; justify-content: space-between;">
                                <div>
                                    <div style="font-size: 14px; font-weight: 700; color: #00d4ff;">üì∞ NEWS & FUNDAMENTALS</div>
                                    <div style="font-size: 11px; color: #888; margin-top: 2px;">Breaking news triggers + AI sentiment analysis</div>
                                </div>
                                <div id="newsMonitorStatus" style="font-size: 11px; color: #888; padding: 4px 8px; background: #252525; border-radius: 3px;">
                                    ‚ö™ Idle
                                </div>
                            </div>
                        </div>

                        <!-- Sentiment Summary -->
                        <div style="padding: 10px; background: #1a1a1a; border: 1px solid #333; border-radius: 4px; margin-bottom: 12px;">
                            <div style="font-size: 13px; color: #888; margin-bottom: 8px; font-weight: 700;">üìä MARKET SENTIMENT (24h)</div>
                            <div id="newsSentimentSummary" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px;">
                                <div style="text-align: center; padding: 8px; background: #252525; border-radius: 4px;">
                                    <div style="font-size: 18px; font-weight: 700; color: #888;" id="sentimentScore">--</div>
                                    <div style="font-size: 10px; color: #666;">Sentiment</div>
                                </div>
                                <div style="text-align: center; padding: 8px; background: #252525; border-radius: 4px;">
                                    <div style="font-size: 18px; font-weight: 700; color: #22c55e;" id="bullishCount">0</div>
                                    <div style="font-size: 10px; color: #666;">Bullish</div>
                                </div>
                                <div style="text-align: center; padding: 8px; background: #252525; border-radius: 4px;">
                                    <div style="font-size: 18px; font-weight: 700; color: #ef4444;" id="bearishCount">0</div>
                                    <div style="font-size: 10px; color: #666;">Bearish</div>
                                </div>
                                <div style="text-align: center; padding: 8px; background: #252525; border-radius: 4px;">
                                    <div style="font-size: 18px; font-weight: 700; color: #f59e0b;" id="highImpactCount">0</div>
                                    <div style="font-size: 10px; color: #666;">High Impact</div>
                                </div>
                            </div>
                        </div>

                        <!-- Timestamped News Log (4AM Scanner) -->
                        <div style="padding: 10px; background: #1a1a1a; border: 1px solid #333; border-radius: 4px; margin-bottom: 12px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <div style="font-size: 13px; color: #888; font-weight: 700;">üìã NEWS LOG (Live)</div>
                                <div style="display: flex; gap: 6px; align-items: center;">
                                    <span id="newsLogCount" style="font-size: 10px; color: #666;">0 items</span>
                                    <button onclick="loadTimestampedNewsLog()" style="padding: 4px 8px; background: #252525; border: 1px solid #404040; color: #888; font-size: 10px; border-radius: 3px; cursor: pointer;">
                                        üîÑ Refresh
                                    </button>
                                </div>
                            </div>
                            <div id="timestampedNewsLog" style="max-height: 250px; overflow-y: auto; font-family: 'Consolas', monospace; font-size: 11px; background: #0d0d0d; padding: 8px; border-radius: 4px;">
                                <div style="color: #666;">Loading news log...</div>
                            </div>
                        </div>

                        <!-- News Feed -->
                        <div style="padding: 10px; background: #1a1a1a; border: 1px solid #333; border-radius: 4px; margin-bottom: 12px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <div style="font-size: 13px; color: #888; font-weight: 700;">üì∞ BREAKING NEWS FEED</div>
                                <div style="display: flex; gap: 6px;">
                                    <select id="newsImpactFilter" onchange="filterNewsFeed()" style="padding: 4px 6px; background: #252525; border: 1px solid #404040; color: #fff; font-size: 10px; border-radius: 3px;">
                                        <option value="">All Impact</option>
                                        <option value="critical">Critical</option>
                                        <option value="high">High</option>
                                        <option value="medium">Medium</option>
                                    </select>
                                    <button onclick="loadNewsFeed()" style="padding: 4px 8px; background: #252525; border: 1px solid #404040; color: #888; font-size: 10px; border-radius: 3px; cursor: pointer;">
                                        üîÑ Refresh
                                    </button>
                                </div>
                            </div>
                            <div id="newsFeedList" style="max-height: 200px; overflow-y: auto;">
                                <div style="padding: 20px; text-align: center; color: #666; font-size: 12px;">
                                    Click "Refresh" to load news feed
                                </div>
                            </div>
                        </div>

                        <!-- Fundamentals Panel -->
                        <div style="padding: 10px; background: #1a1a1a; border: 1px solid #333; border-radius: 4px; margin-bottom: 12px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <div style="font-size: 13px; color: #888; font-weight: 700;">üìà FUNDAMENTAL ANALYSIS</div>
                                <div style="display: flex; gap: 6px; align-items: center;">
                                    <input type="text" id="fundamentalSymbol" value="AAPL" placeholder="Symbol" style="width: 60px; padding: 4px 6px; background: #252525; border: 1px solid #404040; color: #fff; font-size: 11px; border-radius: 3px;">
                                    <button onclick="loadFundamentals()" style="padding: 4px 8px; background: #00d4ff; border: none; color: #000; font-size: 10px; border-radius: 3px; cursor: pointer; font-weight: 600;">
                                        Analyze
                                    </button>
                                </div>
                            </div>
                            <div id="fundamentalsPanel" style="display: none;">
                                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 10px;">
                                    <div style="padding: 8px; background: #252525; border-radius: 4px; text-align: center;">
                                        <div style="font-size: 14px; font-weight: 700;" id="fundValuation">--</div>
                                        <div style="font-size: 9px; color: #666;">Valuation</div>
                                    </div>
                                    <div style="padding: 8px; background: #252525; border-radius: 4px; text-align: center;">
                                        <div style="font-size: 14px; font-weight: 700;" id="fundHealth">--</div>
                                        <div style="font-size: 9px; color: #666;">Health</div>
                                    </div>
                                    <div style="padding: 8px; background: #252525; border-radius: 4px; text-align: center;">
                                        <div style="font-size: 14px; font-weight: 700;" id="fundGrowth">--</div>
                                        <div style="font-size: 9px; color: #666;">Growth</div>
                                    </div>
                                </div>
                                <div id="fundamentalMetrics" style="font-size: 11px; color: #888; line-height: 1.6;"></div>
                                <div id="fundamentalRecommendation" style="margin-top: 8px; padding: 8px; background: #252525; border-radius: 4px; font-size: 12px;"></div>
                            </div>
                            <div id="fundamentalsEmpty" style="padding: 15px; text-align: center; color: #666; font-size: 12px;">
                                Enter a symbol and click "Analyze" for fundamental analysis
                            </div>
                        </div>

                        <!-- Earnings Calendar -->
                        <div style="padding: 10px; background: #1a1a1a; border: 1px solid #333; border-radius: 4px; margin-bottom: 12px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <div style="font-size: 13px; color: #888; font-weight: 700;">üìÖ EARNINGS CALENDAR</div>
                                <button onclick="loadEarningsCalendar()" style="padding: 4px 8px; background: #252525; border: 1px solid #404040; color: #888; font-size: 10px; border-radius: 3px; cursor: pointer;">
                                    üîÑ Load
                                </button>
                            </div>
                            <div id="earningsCalendar" style="max-height: 100px; overflow-y: auto; font-size: 11px;">
                                <div style="padding: 8px; text-align: center; color: #666;">Click "Load" to see upcoming earnings</div>
                            </div>
                        </div>

                        <!-- News Trigger Management -->
                        <div style="padding: 10px; background: #1a1a1a; border: 1px solid #333; border-radius: 4px; margin-bottom: 12px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <div style="font-size: 13px; color: #888; font-weight: 700;">‚ö° NEWS TRIGGERS</div>
                                <button onclick="loadNewsTriggers()" style="padding: 4px 8px; background: #252525; border: 1px solid #404040; color: #888; font-size: 10px; border-radius: 3px; cursor: pointer;">
                                    üîÑ Refresh
                                </button>
                            </div>
                            <div id="newsTriggersList" style="max-height: 120px; overflow-y: auto; font-size: 11px;">
                                <div style="padding: 8px; text-align: center; color: #666;">Loading triggers...</div>
                            </div>
                        </div>

                        <!-- Monitor Controls -->
                        <div style="display: flex; gap: 8px;">
                            <button onclick="startNewsMonitor()" style="flex: 1; padding: 10px; background: #22c55e; border: none; color: #fff; font-size: 12px; font-weight: 600; border-radius: 4px; cursor: pointer;">
                                ‚ñ∂Ô∏è Start Monitor
                            </button>
                            <button onclick="stopNewsMonitor()" style="flex: 1; padding: 10px; background: #ef4444; border: none; color: #fff; font-size: 12px; font-weight: 600; border-radius: 4px; cursor: pointer;">
                                ‚èπÔ∏è Stop Monitor
                            </button>
                        </div>

                        <!-- Info -->
                        <div style="margin-top: 12px; padding: 8px; background: #252525; border-left: 3px solid #00d4ff; border-radius: 3px; font-size: 10px; color: #888;">
                            üì∞ News Feed monitors breaking market news, analyzes sentiment with AI, and triggers automatic trading actions. Fundamentals analysis provides deep valuation insights for informed decisions.
                        </div>
                    </div>

                    <!-- BRAIN TAB (Background AI Brain) -->
                    <div id="aiBrainTab" class="ai-tab-content" style="display: none;">
                        <!-- Brain Status Banner -->
                        <div style="padding: 12px; background: linear-gradient(135deg, #1a1a2e, #16213e); border: 2px solid #22c55e; border-radius: 6px; margin-bottom: 12px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <div style="font-size: 14px; color: #22c55e; font-weight: 700;">üß† BACKGROUND AI BRAIN</div>
                                <div id="brainStatusBadge" style="padding: 4px 12px; background: #252525; border-radius: 3px; font-size: 11px; font-weight: 600; color: #ef4444;">
                                    STOPPED
                                </div>
                            </div>
                            <div style="font-size: 11px; color: #888; margin-bottom: 10px;">
                                Continuous AI learning engine that adapts to market conditions in real-time
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px;">
                                <div style="padding: 8px; background: rgba(34, 197, 94, 0.1); border: 1px solid #22c55e; border-radius: 4px; text-align: center;">
                                    <div style="font-size: 10px; color: #888;">CPU TARGET</div>
                                    <div id="brainCpuTarget" style="font-size: 13px; font-weight: 700; color: #22c55e;">30%</div>
                                </div>
                                <div style="padding: 8px; background: rgba(59, 130, 246, 0.1); border: 1px solid #3b82f6; border-radius: 4px; text-align: center;">
                                    <div style="font-size: 10px; color: #888;">ACTUAL CPU</div>
                                    <div id="brainActualCpu" style="font-size: 13px; font-weight: 700; color: #3b82f6;">0%</div>
                                </div>
                                <div style="padding: 8px; background: rgba(139, 92, 246, 0.1); border: 1px solid #8b5cf6; border-radius: 4px; text-align: center;">
                                    <div style="font-size: 10px; color: #888;">REGIME</div>
                                    <div id="brainRegime" style="font-size: 13px; font-weight: 700; color: #8b5cf6;">UNKNOWN</div>
                                </div>
                                <div style="padding: 8px; background: rgba(249, 115, 22, 0.1); border: 1px solid #f97316; border-radius: 4px; text-align: center;">
                                    <div style="font-size: 10px; color: #888;">UPTIME</div>
                                    <div id="brainUptime" style="font-size: 13px; font-weight: 700; color: #f97316;">0m</div>
                                </div>
                            </div>
                        </div>

                        <!-- Brain Controls -->
                        <div style="padding: 10px; background: #1a1a1a; border: 1px solid #333; border-radius: 4px; margin-bottom: 12px;">
                            <div style="font-size: 13px; color: #888; margin-bottom: 10px; font-weight: 700;">‚öôÔ∏è BRAIN CONTROLS</div>

                            <!-- CPU Target Slider -->
                            <div style="margin-bottom: 12px;">
                                <label style="font-size: 11px; color: #888; display: block; margin-bottom: 3px;">CPU Target: <span id="brainCpuSliderValue">30%</span></label>
                                <input type="range" id="brainCpuSlider" min="10" max="80" step="10" value="30" onchange="updateBrainCpuTarget(this.value)" style="width: 100%; accent-color: #22c55e;">
                                <div style="display: flex; justify-content: space-between; font-size: 9px; color: #666;">
                                    <span>10% (Light)</span>
                                    <span>80% (Heavy)</span>
                                </div>
                            </div>

                            <!-- Start/Stop Buttons -->
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; margin-top: 10px;">
                                <button onclick="startBackgroundBrain()" style="padding: 12px; background: #22c55e; border: none; color: #fff; font-size: 12px; font-weight: 600; border-radius: 4px; cursor: pointer;">
                                    ‚ñ∂Ô∏è Start Brain
                                </button>
                                <button onclick="stopBackgroundBrain()" style="padding: 12px; background: #ef4444; border: none; color: #fff; font-size: 12px; font-weight: 600; border-radius: 4px; cursor: pointer;">
                                    ‚èπÔ∏è Stop Brain
                                </button>
                            </div>
                        </div>

                        <!-- Brain Metrics -->
                        <div style="padding: 10px; background: #1a1a1a; border: 1px solid #333; border-radius: 4px; margin-bottom: 12px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <div style="font-size: 13px; color: #888; font-weight: 700;">üìä BRAIN METRICS</div>
                                <button onclick="loadBrainStatus()" style="padding: 4px 8px; background: #252525; border: 1px solid #404040; color: #888; font-size: 10px; border-radius: 3px; cursor: pointer;">
                                    üîÑ Refresh
                                </button>
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px;">
                                <div style="padding: 8px; background: #252525; border-radius: 4px;">
                                    <div style="font-size: 10px; color: #666;">Tasks Completed</div>
                                    <div id="brainTasksCompleted" style="font-size: 16px; font-weight: 700; color: #22c55e;">0</div>
                                </div>
                                <div style="padding: 8px; background: #252525; border-radius: 4px;">
                                    <div style="font-size: 10px; color: #666;">Tasks Pending</div>
                                    <div id="brainTasksPending" style="font-size: 16px; font-weight: 700; color: #f59e0b;">0</div>
                                </div>
                                <div style="padding: 8px; background: #252525; border-radius: 4px;">
                                    <div style="font-size: 10px; color: #666;">Predictions Evaluated</div>
                                    <div id="brainPredictionsEval" style="font-size: 16px; font-weight: 700; color: #3b82f6;">0</div>
                                </div>
                                <div style="padding: 8px; background: #252525; border-radius: 4px;">
                                    <div style="font-size: 10px; color: #666;">Prediction Accuracy</div>
                                    <div id="brainAccuracy" style="font-size: 16px; font-weight: 700; color: #8b5cf6;">0%</div>
                                </div>
                            </div>
                        </div>

                        <!-- Market Regime Detection -->
                        <div style="padding: 10px; background: #1a1a1a; border: 1px solid #333; border-radius: 4px;">
                            <div style="font-size: 13px; color: #888; margin-bottom: 8px; font-weight: 700;">üéØ MARKET REGIME</div>
                            <div id="brainRegimeDetails" style="padding: 10px; background: #252525; border-radius: 4px; font-size: 11px; color: #888;">
                                <div style="margin-bottom: 6px;"><strong>Current:</strong> <span id="brainRegimeName" style="color: #22c55e;">UNKNOWN</span></div>
                                <div style="margin-bottom: 6px;"><strong>Confidence:</strong> <span id="brainRegimeConf">0%</span></div>
                                <div><strong>Detected:</strong> <span id="brainRegimeTime">--</span></div>
                            </div>
                        </div>

                        <!-- Info -->
                        <div style="margin-top: 12px; padding: 8px; background: #252525; border-left: 3px solid #22c55e; border-radius: 3px; font-size: 10px; color: #888;">
                            üß† Background Brain continuously monitors market conditions, evaluates predictions, and retrains models during off-hours. Adjust CPU target based on your system resources.
                        </div>
                    </div>

                    <!-- SAFETY TAB (Circuit Breaker & Trade Journal) -->
                    <div id="aiSafetyTab" class="ai-tab-content" style="display: none;">
                        <!-- Circuit Breaker Status -->
                        <div style="padding: 12px; background: linear-gradient(135deg, #1a1a2e, #16213e); border: 2px solid #ef4444; border-radius: 6px; margin-bottom: 12px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <div style="font-size: 14px; color: #ef4444; font-weight: 700;">üõ°Ô∏è CIRCUIT BREAKER</div>
                                <div id="circuitBreakerLevel" style="padding: 4px 12px; background: #22c55e; border-radius: 3px; font-size: 11px; font-weight: 600; color: #fff;">
                                    NORMAL
                                </div>
                            </div>
                            <div style="font-size: 11px; color: #888; margin-bottom: 10px;">
                                Multi-level drawdown protection system to prevent catastrophic losses
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px;">
                                <div style="padding: 8px; background: rgba(34, 197, 94, 0.1); border: 1px solid #22c55e; border-radius: 4px; text-align: center;">
                                    <div style="font-size: 10px; color: #888;">STARTING $</div>
                                    <div id="cbStartingEquity" style="font-size: 12px; font-weight: 700; color: #22c55e;">$0</div>
                                </div>
                                <div style="padding: 8px; background: rgba(59, 130, 246, 0.1); border: 1px solid #3b82f6; border-radius: 4px; text-align: center;">
                                    <div style="font-size: 10px; color: #888;">CURRENT $</div>
                                    <div id="cbCurrentEquity" style="font-size: 12px; font-weight: 700; color: #3b82f6;">$0</div>
                                </div>
                                <div style="padding: 8px; background: rgba(249, 115, 22, 0.1); border: 1px solid #f97316; border-radius: 4px; text-align: center;">
                                    <div style="font-size: 10px; color: #888;">TODAY P&L</div>
                                    <div id="cbTodayPnL" style="font-size: 12px; font-weight: 700; color: #f97316;">$0</div>
                                </div>
                                <div style="padding: 8px; background: rgba(239, 68, 68, 0.1); border: 1px solid #ef4444; border-radius: 4px; text-align: center;">
                                    <div style="font-size: 10px; color: #888;">DRAWDOWN</div>
                                    <div id="cbDrawdown" style="font-size: 12px; font-weight: 700; color: #ef4444;">0%</div>
                                </div>
                            </div>
                        </div>

                        <!-- Threshold Levels -->
                        <div style="padding: 10px; background: #1a1a1a; border: 1px solid #333; border-radius: 4px; margin-bottom: 12px;">
                            <div style="font-size: 13px; color: #888; margin-bottom: 10px; font-weight: 700;">‚ö†Ô∏è PROTECTION LEVELS</div>
                            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 4px; margin-bottom: 10px;">
                                <div style="padding: 8px; background: #22c55e; border-radius: 4px; text-align: center;">
                                    <div style="font-size: 9px; color: #fff;">NORMAL</div>
                                    <div style="font-size: 11px; font-weight: 700; color: #fff;">0-2%</div>
                                </div>
                                <div style="padding: 8px; background: #f59e0b; border-radius: 4px; text-align: center;">
                                    <div style="font-size: 9px; color: #fff;">WARNING</div>
                                    <div style="font-size: 11px; font-weight: 700; color: #fff;">2-3%</div>
                                </div>
                                <div style="padding: 8px; background: #f97316; border-radius: 4px; text-align: center;">
                                    <div style="font-size: 9px; color: #fff;">CAUTION</div>
                                    <div style="font-size: 11px; font-weight: 700; color: #fff;">3-5%</div>
                                </div>
                                <div style="padding: 8px; background: #ef4444; border-radius: 4px; text-align: center;">
                                    <div style="font-size: 9px; color: #fff;">HALT</div>
                                    <div style="font-size: 11px; font-weight: 700; color: #fff;">>5%</div>
                                </div>
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px;">
                                <button onclick="loadCircuitBreakerStatus()" style="padding: 10px; background: #3b82f6; border: none; color: #fff; font-size: 12px; font-weight: 600; border-radius: 4px; cursor: pointer;">
                                    üîÑ Refresh Status
                                </button>
                                <button onclick="resetCircuitBreaker()" style="padding: 10px; background: #f97316; border: none; color: #fff; font-size: 12px; font-weight: 600; border-radius: 4px; cursor: pointer;">
                                    üîì Reset Day
                                </button>
                            </div>
                        </div>

                        <!-- Trade Journal -->
                        <div style="padding: 10px; background: #1a1a1a; border: 1px solid #333; border-radius: 4px; margin-bottom: 12px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <div style="font-size: 13px; color: #888; font-weight: 700;">üìî TRADE JOURNAL</div>
                                <button onclick="loadTradeJournal()" style="padding: 4px 8px; background: #252525; border: 1px solid #404040; color: #888; font-size: 10px; border-radius: 3px; cursor: pointer;">
                                    üîÑ Load
                                </button>
                            </div>
                            <div id="tradeJournalList" style="max-height: 200px; overflow-y: auto; font-size: 11px;">
                                <div style="padding: 15px; text-align: center; color: #666;">Click "Load" to view trade journal entries</div>
                            </div>
                        </div>

                        <!-- Symbol Memory -->
                        <div style="padding: 10px; background: #1a1a1a; border: 1px solid #333; border-radius: 4px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <div style="font-size: 13px; color: #888; font-weight: 700;">üß† SYMBOL MEMORY</div>
                                <div style="display: flex; gap: 4px;">
                                    <input type="text" id="symbolMemorySearch" placeholder="Symbol..." style="width: 70px; padding: 4px 6px; background: #252525; border: 1px solid #404040; color: #fff; font-size: 11px; border-radius: 3px;">
                                    <button onclick="loadSymbolMemory()" style="padding: 4px 8px; background: #007acc; border: none; color: #fff; font-size: 10px; border-radius: 3px; cursor: pointer;">
                                        Load
                                    </button>
                                </div>
                            </div>
                            <div id="symbolMemoryInfo" style="font-size: 11px; color: #888; padding: 8px; background: #252525; border-radius: 4px;">
                                Enter a symbol to view its trading history and AI memory
                            </div>
                        </div>

                        <!-- Info -->
                        <div style="margin-top: 12px; padding: 8px; background: #252525; border-left: 3px solid #ef4444; border-radius: 3px; font-size: 10px; color: #888;">
                            üõ°Ô∏è Circuit Breaker protects your account from excessive losses. Trade Journal records AI-generated reasoning for every trade. Symbol Memory tracks historical performance per stock.
                        </div>
                    </div>

                    <!-- RISK TAB -->
                    <div id="aiRiskTab" class="ai-tab-content" style="display: none;">
                        <!-- Risk Status Banner -->
                        <div id="riskStatusBanner" style="padding: 12px; background: linear-gradient(135deg, #1a1a2e, #16213e); border: 2px solid #22c55e; border-radius: 6px; margin-bottom: 12px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <div style="font-size: 14px; color: #22c55e; font-weight: 700;">üìà PORTFOLIO RISK GUARD</div>
                                <div id="riskLevelBadge" style="padding: 4px 12px; background: #22c55e; border-radius: 3px; font-size: 11px; font-weight: 600; color: #fff;">
                                    LOW
                                </div>
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px;">
                                <div style="padding: 8px; background: rgba(34, 197, 94, 0.1); border: 1px solid #22c55e; border-radius: 4px; text-align: center;">
                                    <div style="font-size: 10px; color: #888;">VAR 95%</div>
                                    <div id="riskVar95" style="font-size: 13px; font-weight: 700; color: #22c55e;">$0</div>
                                </div>
                                <div style="padding: 8px; background: rgba(59, 130, 246, 0.1); border: 1px solid #3b82f6; border-radius: 4px; text-align: center;">
                                    <div style="font-size: 10px; color: #888;">DRAWDOWN</div>
                                    <div id="riskDrawdown" style="font-size: 13px; font-weight: 700; color: #3b82f6;">0%</div>
                                </div>
                                <div style="padding: 8px; background: rgba(139, 92, 246, 0.1); border: 1px solid #8b5cf6; border-radius: 4px; text-align: center;">
                                    <div style="font-size: 10px; color: #888;">MAX DD</div>
                                    <div id="riskMaxDD" style="font-size: 13px; font-weight: 700; color: #8b5cf6;">0%</div>
                                </div>
                                <div style="padding: 8px; background: rgba(249, 115, 22, 0.1); border: 1px solid #f97316; border-radius: 4px; text-align: center;">
                                    <div style="font-size: 10px; color: #888;">EQUITY</div>
                                    <div id="riskEquity" style="font-size: 13px; font-weight: 700; color: #f97316;">$0</div>
                                </div>
                            </div>
                        </div>

                        <!-- VAR Details -->
                        <div style="padding: 10px; background: #1a1a1a; border: 1px solid #333; border-radius: 4px; margin-bottom: 12px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <div style="font-size: 13px; color: #888; font-weight: 700;">üìä VALUE AT RISK (VAR)</div>
                                <button onclick="loadVARData()" style="padding: 4px 8px; background: #252525; border: 1px solid #404040; color: #888; font-size: 10px; border-radius: 3px; cursor: pointer;">
                                    üîÑ Refresh
                                </button>
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px;">
                                <div style="padding: 8px; background: #252525; border-radius: 4px;">
                                    <div style="font-size: 10px; color: #666;">1-Day 95% VAR</div>
                                    <div id="var1Day95" style="font-size: 16px; font-weight: 700; color: #ef4444;">$0</div>
                                    <div id="var1Day95Pct" style="font-size: 10px; color: #888;">0%</div>
                                </div>
                                <div style="padding: 8px; background: #252525; border-radius: 4px;">
                                    <div style="font-size: 10px; color: #666;">1-Day 99% VAR</div>
                                    <div id="var1Day99" style="font-size: 16px; font-weight: 700; color: #ef4444;">$0</div>
                                    <div id="var1Day99Pct" style="font-size: 10px; color: #888;">0%</div>
                                </div>
                                <div style="padding: 8px; background: #252525; border-radius: 4px;">
                                    <div style="font-size: 10px; color: #666;">5-Day 95% VAR</div>
                                    <div id="var5Day95" style="font-size: 16px; font-weight: 700; color: #f97316;">$0</div>
                                    <div id="var5Day95Pct" style="font-size: 10px; color: #888;">0%</div>
                                </div>
                            </div>
                            <div style="margin-top: 8px; padding: 8px; background: #252525; border-radius: 4px;">
                                <div style="font-size: 10px; color: #666;">Expected Shortfall (CVaR)</div>
                                <div id="varCVaR" style="font-size: 14px; font-weight: 700; color: #ef4444;">$0</div>
                                <div style="font-size: 9px; color: #666; margin-top: 2px;">Average loss in worst 5% scenarios</div>
                            </div>
                        </div>

                        <!-- Drawdown Tracking -->
                        <div style="padding: 10px; background: #1a1a1a; border: 1px solid #333; border-radius: 4px; margin-bottom: 12px;">
                            <div style="font-size: 13px; color: #888; margin-bottom: 10px; font-weight: 700;">üìâ DRAWDOWN TRACKING</div>
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px;">
                                <div style="padding: 8px; background: #252525; border-radius: 4px;">
                                    <div style="font-size: 10px; color: #666;">Peak Equity</div>
                                    <div id="ddPeakEquity" style="font-size: 14px; font-weight: 700; color: #22c55e;">$0</div>
                                </div>
                                <div style="padding: 8px; background: #252525; border-radius: 4px;">
                                    <div style="font-size: 10px; color: #666;">Current Equity</div>
                                    <div id="ddCurrentEquity" style="font-size: 14px; font-weight: 700; color: #60a5fa;">$0</div>
                                </div>
                                <div style="padding: 8px; background: #252525; border-radius: 4px;">
                                    <div style="font-size: 10px; color: #666;">Days in Drawdown</div>
                                    <div id="ddDaysIn" style="font-size: 14px; font-weight: 700; color: #f59e0b;">0</div>
                                </div>
                                <div style="padding: 8px; background: #252525; border-radius: 4px;">
                                    <div style="font-size: 10px; color: #666;">Recovery Needed</div>
                                    <div id="ddRecoveryNeeded" style="font-size: 14px; font-weight: 700; color: #ef4444;">0%</div>
                                </div>
                            </div>
                            <!-- Drawdown Progress Bar -->
                            <div style="margin-top: 8px;">
                                <div style="display: flex; justify-content: space-between; font-size: 10px; color: #666; margin-bottom: 4px;">
                                    <span>Current Drawdown</span>
                                    <span id="ddProgressPct">0%</span>
                                </div>
                                <div style="background: #333; height: 8px; border-radius: 4px; overflow: hidden;">
                                    <div id="ddProgressBar" style="background: linear-gradient(90deg, #22c55e, #ef4444); height: 100%; width: 0%; transition: width 0.3s;"></div>
                                </div>
                                <div style="display: flex; justify-content: space-between; font-size: 9px; color: #666; margin-top: 2px;">
                                    <span>0%</span>
                                    <span style="color: #f59e0b;">5% Warning</span>
                                    <span style="color: #ef4444;">15% Max</span>
                                </div>
                            </div>
                        </div>

                        <!-- Concentration Limits -->
                        <div style="padding: 10px; background: #1a1a1a; border: 1px solid #333; border-radius: 4px; margin-bottom: 12px;">
                            <div style="font-size: 13px; color: #888; margin-bottom: 10px; font-weight: 700;">üéØ CONCENTRATION LIMITS</div>
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px;">
                                <div style="padding: 8px; background: #252525; border-radius: 4px;">
                                    <div style="font-size: 10px; color: #666;">Largest Position</div>
                                    <div id="concLargestPos" style="font-size: 14px; font-weight: 700; color: #60a5fa;">0%</div>
                                    <div style="font-size: 9px; color: #666;">Max: 20%</div>
                                </div>
                                <div style="padding: 8px; background: #252525; border-radius: 4px;">
                                    <div style="font-size: 10px; color: #666;">Top 3 Concentration</div>
                                    <div id="concTop3" style="font-size: 14px; font-weight: 700; color: #60a5fa;">0%</div>
                                    <div style="font-size: 9px; color: #666;">Max: 50%</div>
                                </div>
                                <div style="padding: 8px; background: #252525; border-radius: 4px;">
                                    <div style="font-size: 10px; color: #666;">Small Cap Exposure</div>
                                    <div id="concSmallCap" style="font-size: 14px; font-weight: 700; color: #8b5cf6;">0%</div>
                                    <div style="font-size: 9px; color: #666;">Max: 50%</div>
                                </div>
                                <div style="padding: 8px; background: #252525; border-radius: 4px;">
                                    <div style="font-size: 10px; color: #666;">Diversification Ratio</div>
                                    <div id="concDiversification" style="font-size: 14px; font-weight: 700; color: #22c55e;">1.0</div>
                                    <div style="font-size: 9px; color: #666;">Higher = Better</div>
                                </div>
                            </div>
                        </div>

                        <!-- Risk Flags -->
                        <div style="padding: 10px; background: #1a1a1a; border: 1px solid #333; border-radius: 4px;">
                            <div style="font-size: 13px; color: #888; margin-bottom: 10px; font-weight: 700;">‚ö†Ô∏è RISK FLAGS</div>
                            <div id="riskFlagsList" style="font-size: 11px; color: #aaa;">
                                <div style="padding: 8px; background: #252525; border-radius: 4px; text-align: center; color: #22c55e;">
                                    ‚úì No active risk flags
                                </div>
                            </div>
                        </div>

                        <!-- WebSocket Status -->
                        <div style="margin-top: 12px; padding: 8px; background: #252525; border-left: 3px solid #007acc; border-radius: 3px; font-size: 10px; color: #888;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span>üì° Real-time updates: <span id="riskWsStatus" style="color: #ef4444;">Disconnected</span></span>
                                <button onclick="connectRiskWebSocket()" style="padding: 3px 8px; background: #007acc; border: none; color: #fff; font-size: 9px; border-radius: 3px; cursor: pointer;">
                                    Connect
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- ENSEMBLE TAB -->
                    <div id="aiEnsembleTab" class="ai-tab-content" style="display: none;">
                        <div style="padding: 10px; background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); border: 1px solid #0f3460; border-radius: 4px; margin-bottom: 12px;">
                            <div style="font-size: 14px; color: #e94560; margin-bottom: 6px; font-weight: 700;">üéØ ENSEMBLE AI PREDICTOR</div>
                            <div style="font-size: 11px; color: #aaa;">Combines LightGBM + Heuristics + Momentum with regime-aware weighting</div>
                        </div>

                        <!-- Quick Predict -->
                        <div style="padding: 10px; background: #1a1a1a; border: 1px solid #333; border-radius: 4px; margin-bottom: 12px;">
                            <div style="font-size: 13px; color: #888; margin-bottom: 10px; font-weight: 700;">‚ö° QUICK PREDICT</div>
                            <div style="display: flex; gap: 8px; margin-bottom: 10px;">
                                <input type="text" id="ensembleSymbol" placeholder="Symbol (e.g., AAPL)"
                                    style="flex: 1; padding: 8px; background: #252525; border: 1px solid #404040; color: #fff; font-size: 14px; border-radius: 3px; text-transform: uppercase;">
                                <button onclick="runEnsemblePrediction()" style="padding: 8px 16px; background: #e94560; border: none; color: #fff; font-size: 13px; font-weight: 600; border-radius: 3px; cursor: pointer;">
                                    PREDICT
                                </button>
                            </div>

                            <!-- Prediction Result -->
                            <div id="ensembleResult" style="display: none; padding: 12px; background: #252525; border-radius: 4px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                    <div>
                                        <span id="ensembleSymbolResult" style="font-size: 18px; font-weight: 700; color: #fff;">AAPL</span>
                                        <span id="ensemblePrediction" style="margin-left: 10px; padding: 4px 12px; border-radius: 4px; font-size: 12px; font-weight: 700;">BULLISH</span>
                                    </div>
                                    <div style="text-align: right;">
                                        <div style="font-size: 10px; color: #666;">Confidence</div>
                                        <div id="ensembleConfidence" style="font-size: 20px; font-weight: 700; color: #22c55e;">75%</div>
                                    </div>
                                </div>

                                <!-- Component Scores -->
                                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 12px;">
                                    <div style="padding: 8px; background: #1a1a1a; border-radius: 4px; text-align: center;">
                                        <div style="font-size: 10px; color: #666;">LightGBM</div>
                                        <div id="ensembleLgbScore" style="font-size: 16px; font-weight: 700; color: #60a5fa;">56%</div>
                                        <div id="ensembleLgbWeight" style="font-size: 9px; color: #444;">40% weight</div>
                                    </div>
                                    <div style="padding: 8px; background: #1a1a1a; border-radius: 4px; text-align: center;">
                                        <div style="font-size: 10px; color: #666;">Heuristic</div>
                                        <div id="ensembleHeurScore" style="font-size: 16px; font-weight: 700; color: #f59e0b;">50%</div>
                                        <div id="ensembleHeurWeight" style="font-size: 9px; color: #444;">30% weight</div>
                                    </div>
                                    <div style="padding: 8px; background: #1a1a1a; border-radius: 4px; text-align: center;">
                                        <div style="font-size: 10px; color: #666;">Momentum</div>
                                        <div id="ensembleMomScore" style="font-size: 16px; font-weight: 700; color: #22c55e;">65%</div>
                                        <div id="ensembleMomWeight" style="font-size: 9px; color: #444;">30% weight</div>
                                    </div>
                                </div>

                                <!-- Regime -->
                                <div style="padding: 8px; background: #1a1a1a; border-radius: 4px; margin-bottom: 12px;">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <span style="font-size: 11px; color: #666;">Market Regime:</span>
                                        <span id="ensembleRegime" style="font-size: 12px; font-weight: 700; color: #e94560;">TRENDING_UP</span>
                                    </div>
                                </div>

                                <!-- Signals -->
                                <div style="font-size: 11px; color: #666; margin-bottom: 4px;">Signals:</div>
                                <div id="ensembleSignals" style="font-size: 10px; color: #aaa; max-height: 100px; overflow-y: auto;">
                                    <div style="padding: 4px 0; border-bottom: 1px solid #333;">‚Ä¢ LightGBM: 56% bullish</div>
                                </div>
                            </div>
                        </div>

                        <!-- Batch Predict -->
                        <div style="padding: 10px; background: #1a1a1a; border: 1px solid #333; border-radius: 4px; margin-bottom: 12px;">
                            <div style="font-size: 13px; color: #888; margin-bottom: 10px; font-weight: 700;">üìä BATCH PREDICT (Watchlist)</div>
                            <button onclick="runBatchEnsemble()" style="width: 100%; padding: 10px; background: #16213e; border: 1px solid #0f3460; color: #fff; font-size: 13px; font-weight: 600; border-radius: 3px; cursor: pointer;">
                                üîç Scan Watchlist Symbols
                            </button>

                            <div id="batchEnsembleResults" style="margin-top: 10px; display: none;">
                                <div style="max-height: 200px; overflow-y: auto;" id="batchResultsContainer"></div>
                            </div>
                        </div>

                        <!-- Performance Stats -->
                        <div style="padding: 10px; background: #1a1a1a; border: 1px solid #333; border-radius: 4px;">
                            <div style="font-size: 13px; color: #888; margin-bottom: 10px; font-weight: 700;">üìà PERFORMANCE</div>
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px;">
                                <div style="padding: 8px; background: #252525; border-radius: 4px;">
                                    <div style="font-size: 10px; color: #666;">Accuracy</div>
                                    <div id="ensembleAccuracy" style="font-size: 16px; font-weight: 700; color: #22c55e;">--</div>
                                </div>
                                <div style="padding: 8px; background: #252525; border-radius: 4px;">
                                    <div style="font-size: 10px; color: #666;">Sample Size</div>
                                    <div id="ensembleSampleSize" style="font-size: 16px; font-weight: 700; color: #60a5fa;">--</div>
                                </div>
                            </div>
                            <button onclick="loadEnsemblePerformance()" style="width: 100%; margin-top: 8px; padding: 6px; background: #252525; border: 1px solid #404040; color: #888; font-size: 11px; border-radius: 3px; cursor: pointer;">
                                Refresh Stats
                            </button>
                        </div>
                    </div>

                    <!-- RL AGENT TAB -->
                    <div id="aiRLTab" class="ai-tab-content" style="display: none;">
                        <div style="padding: 10px; background: linear-gradient(135deg, #1a1a2e 0%, #2d1b4e 100%); border: 1px solid #6b21a8; border-radius: 4px; margin-bottom: 12px;">
                            <div style="font-size: 14px; color: #a855f7; margin-bottom: 6px; font-weight: 700;">ü§ñ REINFORCEMENT LEARNING AGENT</div>
                            <div style="font-size: 11px; color: #aaa;">Self-optimizing DQN agent for entry/exit timing</div>
                        </div>

                        <!-- Agent Status -->
                        <div style="padding: 10px; background: #1a1a1a; border: 1px solid #333; border-radius: 4px; margin-bottom: 12px;">
                            <div style="font-size: 13px; color: #888; margin-bottom: 10px; font-weight: 700;">üìä AGENT STATUS</div>
                            <div id="rlStatusPanel" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px;">
                                <div style="padding: 8px; background: #252525; border-radius: 4px; text-align: center;">
                                    <div style="font-size: 10px; color: #666;">PyTorch</div>
                                    <div id="rlPytorch" style="font-size: 14px; font-weight: 700; color: #22c55e;">--</div>
                                </div>
                                <div style="padding: 8px; background: #252525; border-radius: 4px; text-align: center;">
                                    <div style="font-size: 10px; color: #666;">Episodes</div>
                                    <div id="rlEpisodes" style="font-size: 14px; font-weight: 700; color: #60a5fa;">--</div>
                                </div>
                                <div style="padding: 8px; background: #252525; border-radius: 4px; text-align: center;">
                                    <div style="font-size: 10px; color: #666;">Epsilon</div>
                                    <div id="rlEpsilon" style="font-size: 14px; font-weight: 700; color: #f59e0b;">--</div>
                                </div>
                            </div>
                            <button onclick="loadRLStatus()" style="width: 100%; margin-top: 8px; padding: 6px; background: #252525; border: 1px solid #404040; color: #888; font-size: 11px; border-radius: 3px; cursor: pointer;">
                                Refresh Status
                            </button>
                        </div>

                        <!-- Quick Predict -->
                        <div style="padding: 10px; background: #1a1a1a; border: 1px solid #333; border-radius: 4px; margin-bottom: 12px;">
                            <div style="font-size: 13px; color: #888; margin-bottom: 10px; font-weight: 700;">‚ö° RL PREDICTION</div>
                            <div style="display: flex; gap: 8px; margin-bottom: 10px;">
                                <input type="text" id="rlSymbol" placeholder="Symbol (e.g., AAPL)"
                                    style="flex: 1; padding: 8px; background: #252525; border: 1px solid #404040; color: #fff; font-size: 14px; border-radius: 3px; text-transform: uppercase;">
                                <button onclick="runRLPrediction()" style="padding: 8px 16px; background: #6b21a8; border: none; color: #fff; font-size: 13px; font-weight: 600; border-radius: 3px; cursor: pointer;">
                                    PREDICT
                                </button>
                            </div>

                            <!-- RL Result -->
                            <div id="rlResult" style="display: none; padding: 12px; background: #252525; border-radius: 4px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                    <div>
                                        <span id="rlSymbolResult" style="font-size: 18px; font-weight: 700; color: #fff;">AAPL</span>
                                        <span id="rlAction" style="margin-left: 10px; padding: 4px 12px; border-radius: 4px; font-size: 12px; font-weight: 700;">HOLD</span>
                                    </div>
                                    <div style="text-align: right;">
                                        <div style="font-size: 10px; color: #666;">Price</div>
                                        <div id="rlPrice" style="font-size: 16px; font-weight: 700; color: #fff;">$0.00</div>
                                    </div>
                                </div>

                                <!-- Action Probabilities -->
                                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 12px;">
                                    <div style="padding: 8px; background: #1a1a1a; border-radius: 4px; text-align: center;">
                                        <div style="font-size: 10px; color: #666;">HOLD</div>
                                        <div id="rlProbHold" style="font-size: 16px; font-weight: 700; color: #888;">33%</div>
                                    </div>
                                    <div style="padding: 8px; background: #1a1a1a; border-radius: 4px; text-align: center;">
                                        <div style="font-size: 10px; color: #666;">BUY</div>
                                        <div id="rlProbBuy" style="font-size: 16px; font-weight: 700; color: #22c55e;">33%</div>
                                    </div>
                                    <div style="padding: 8px; background: #1a1a1a; border-radius: 4px; text-align: center;">
                                        <div style="font-size: 10px; color: #666;">SELL</div>
                                        <div id="rlProbSell" style="font-size: 16px; font-weight: 700; color: #ef4444;">33%</div>
                                    </div>
                                </div>

                                <!-- State Features -->
                                <div style="font-size: 11px; color: #666; margin-bottom: 4px;">State Features:</div>
                                <div id="rlStateFeatures" style="font-size: 10px; color: #aaa; padding: 8px; background: #1a1a1a; border-radius: 4px;">
                                    RSI: -- | MACD: -- | Trend: --
                                </div>
                            </div>
                        </div>

                        <!-- Training Section -->
                        <div style="padding: 10px; background: #1a1a1a; border: 1px solid #333; border-radius: 4px; margin-bottom: 12px;">
                            <div style="font-size: 13px; color: #888; margin-bottom: 10px; font-weight: 700;">üéì TRAIN AGENT</div>
                            <div style="display: flex; gap: 8px; margin-bottom: 10px;">
                                <input type="text" id="rlTrainSymbols" value="AAPL,MSFT,NVDA" placeholder="Symbols"
                                    style="flex: 2; padding: 8px; background: #252525; border: 1px solid #404040; color: #fff; font-size: 12px; border-radius: 3px;">
                                <input type="number" id="rlTrainEpisodes" value="5" min="1" max="100" placeholder="Episodes"
                                    style="flex: 1; padding: 8px; background: #252525; border: 1px solid #404040; color: #fff; font-size: 12px; border-radius: 3px;">
                            </div>
                            <button onclick="trainRLAgent()" id="rlTrainBtn" style="width: 100%; padding: 10px; background: #6b21a8; border: none; color: #fff; font-size: 13px; font-weight: 600; border-radius: 3px; cursor: pointer;">
                                üöÄ Start Training
                            </button>
                            <div id="rlTrainStatus" style="display: none; margin-top: 8px; padding: 8px; background: #252525; border-radius: 4px; font-size: 11px; color: #aaa;"></div>
                        </div>

                        <!-- Reset Button -->
                        <div style="padding: 10px; background: #1a1a1a; border: 1px solid #333; border-radius: 4px;">
                            <button onclick="resetRLAgent()" style="width: 100%; padding: 8px; background: #7f1d1d; border: none; color: #fff; font-size: 12px; font-weight: 600; border-radius: 3px; cursor: pointer;">
                                ‚ö†Ô∏è Reset Agent (Clear Training)
                            </button>
                        </div>
                    </div>
                </div>
            `,

            aimonitor: `
                <div class="module-content" style="display: flex; flex-direction: column; height: 100%; padding: 0; font-size: 10px;">
                    <!-- Status Bar -->
                    <div style="background: #0d1117; padding: 4px 6px; display: flex; gap: 8px; flex-wrap: wrap; border-bottom: 1px solid #333;">
                        <div style="display: flex; align-items: center; gap: 3px;">
                            <span id="monBrainStatus" style="width: 6px; height: 6px; border-radius: 50%; background: #666;"></span>
                            <span style="color: #888;">Brain</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 3px;">
                            <span id="monBotStatus" style="width: 6px; height: 6px; border-radius: 50%; background: #666;"></span>
                            <span style="color: #888;">Bot</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 3px;">
                            <span id="monModelStatus" style="width: 6px; height: 6px; border-radius: 50%; background: #666;"></span>
                            <span style="color: #888;">Model</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 3px;">
                            <span id="monCircuitStatus" style="width: 6px; height: 6px; border-radius: 50%; background: #22c55e;"></span>
                            <span style="color: #888;">Circuit</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 3px;">
                            <span id="monWSStatus" style="width: 6px; height: 6px; border-radius: 50%; background: #666;"></span>
                            <span style="color: #888;">WS</span>
                        </div>
                        <div style="margin-left: auto; color: #444;" id="monTimestamp">--:--:--</div>
                    </div>

                    <!-- Quick Stats Row -->
                    <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 1px; background: #333; border-bottom: 1px solid #333;">
                        <div style="background: #1a1a1a; padding: 3px 4px; text-align: center;">
                            <div style="color: #666; font-size: 10px;">REGIME</div>
                            <div id="monRegime" style="color: #60a5fa; font-weight: 600; font-size: 12px;">--</div>
                        </div>
                        <div style="background: #1a1a1a; padding: 3px 4px; text-align: center;">
                            <div style="color: #666; font-size: 10px;">DRIFT</div>
                            <div id="monDrift" style="color: #22c55e; font-weight: 600; font-size: 12px;">OK</div>
                        </div>
                        <div style="background: #1a1a1a; padding: 3px 4px; text-align: center;">
                            <div style="color: #666; font-size: 10px;">TRADES</div>
                            <div id="monTrades" style="color: #fff; font-weight: 600; font-size: 12px;">0</div>
                        </div>
                        <div style="background: #1a1a1a; padding: 3px 4px; text-align: center;">
                            <div style="color: #666; font-size: 10px;">P&L</div>
                            <div id="monPnL" style="color: #888; font-weight: 600; font-size: 12px;">$0</div>
                        </div>
                        <div style="background: #1a1a1a; padding: 3px 4px; text-align: center;">
                            <div style="color: #666; font-size: 10px;">DD%</div>
                            <div id="monDrawdown" style="color: #22c55e; font-weight: 600; font-size: 12px;">0%</div>
                        </div>
                    </div>

                    <!-- Activity Log -->
                    <div style="flex: 1; overflow-y: auto; background: #0a0a0a;" id="aiMonitorLog">
                        <div style="padding: 4px 6px; color: #666; border-bottom: 1px solid #1a1a1a;">
                            ‚è≥ Connecting to AI Monitor...
                        </div>
                    </div>

                    <!-- Filter Bar -->
                    <div style="display: flex; gap: 2px; padding: 3px; background: #1a1a1a; border-top: 1px solid #333;">
                        <button onclick="filterMonitorLog('all')" class="mon-filter active" style="flex: 1; padding: 2px; background: #007acc; border: none; color: #fff; font-size: 9px; border-radius: 2px; cursor: pointer;">ALL</button>
                        <button onclick="filterMonitorLog('trade')" class="mon-filter" style="flex: 1; padding: 2px; background: #252525; border: none; color: #888; font-size: 9px; border-radius: 2px; cursor: pointer;">TRADES</button>
                        <button onclick="filterMonitorLog('signal')" class="mon-filter" style="flex: 1; padding: 2px; background: #252525; border: none; color: #888; font-size: 9px; border-radius: 2px; cursor: pointer;">SIGNALS</button>
                        <button onclick="filterMonitorLog('error')" class="mon-filter" style="flex: 1; padding: 2px; background: #252525; border: none; color: #888; font-size: 9px; border-radius: 2px; cursor: pointer;">ERRORS</button>
                        <button onclick="filterMonitorLog('system')" class="mon-filter" style="flex: 1; padding: 2px; background: #252525; border: none; color: #888; font-size: 9px; border-radius: 2px; cursor: pointer;">SYSTEM</button>
                        <button onclick="clearMonitorLog()" style="padding: 2px 6px; background: #333; border: none; color: #666; font-size: 9px; border-radius: 2px; cursor: pointer;">CLR</button>
                    </div>
                </div>
            `,

            // News Feed Panel - Scrollable list of breaking news
            newsTrader: `
                <div class="module-content" style="display: flex; flex-direction: column; height: 100%; padding: 0; font-size: 13px;">
                    <!-- Header -->
                    <div style="background: #0d1117; padding: 8px 10px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #333;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span style="color: #f59e0b; animation: pulse 2s infinite; font-size: 14px;">&#9679;</span>
                            <span style="color: #f59e0b; font-weight: 600; font-size: 14px;">BREAKING NEWS</span>
                            <span id="newsFeedCount" style="color: #666; font-size: 12px;">(0)</span>
                        </div>
                        <button onclick="loadNewsFeedPanel()" style="padding: 4px 10px; background: #333; border: none; color: #888; font-size: 12px; border-radius: 3px; cursor: pointer;">‚Üª REFRESH</button>
                    </div>

                    <!-- Column Headers -->
                    <div style="display: grid; grid-template-columns: 50px 55px 50px 1fr; gap: 8px; padding: 6px 10px; background: #1a1a1a; border-bottom: 1px solid #333; font-size: 10px; color: #888; font-weight: 600;">
                        <div>TIME</div>
                        <div style="text-align: center;">MOVE</div>
                        <div>SYM</div>
                        <div>HEADLINE</div>
                    </div>

                    <!-- Scrollable News List -->
                    <div style="flex: 1; overflow-y: auto; background: #0a0a0a;" id="newsFeedList">
                        <div style="padding: 20px; color: #666; text-align: center; font-size: 13px;">Loading news...</div>
                    </div>
                </div>
            `,

            // AI Signals Panel - Shows real-time AI filter results for watchlist
            aiSignals: `
                <div class="module-content" style="display: flex; flex-direction: column; height: 100%; padding: 0; font-size: 10px;">
                    <!-- Header -->
                    <div style="background: #0d1117; padding: 6px 8px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #333;">
                        <span style="color: #60a5fa; font-weight: 600;">AI SIGNALS - WATCHLIST</span>
                        <button onclick="refreshAISignals()" style="padding: 2px 8px; background: #333; border: none; color: #888; font-size: 9px; border-radius: 3px; cursor: pointer;">REFRESH</button>
                    </div>

                    <!-- Signal Table -->
                    <div style="flex: 1; overflow-y: auto;">
                        <table style="width: 100%; border-collapse: collapse; font-size: 10px;">
                            <thead style="position: sticky; top: 0; background: #1a1a1a;">
                                <tr>
                                    <th style="padding: 4px 6px; text-align: left; color: #888; border-bottom: 1px solid #333;">SYM</th>
                                    <th style="padding: 4px 6px; text-align: center; color: #888; border-bottom: 1px solid #333;">CHRONOS</th>
                                    <th style="padding: 4px 6px; text-align: center; color: #888; border-bottom: 1px solid #333;">QLIB</th>
                                    <th style="padding: 4px 6px; text-align: center; color: #888; border-bottom: 1px solid #333;">FLOW</th>
                                    <th style="padding: 4px 6px; text-align: center; color: #888; border-bottom: 1px solid #333;">SIGNAL</th>
                                </tr>
                            </thead>
                            <tbody id="aiSignalsTable">
                                <tr><td colspan="5" style="padding: 12px; text-align: center; color: #666;">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            `,

            // Warrior Trading Panel - Ross Cameron Methodology
            warrior: `
                <div class="module-content" style="display: flex; flex-direction: column; height: 100%; padding: 0; font-size: 10px;">
                    <!-- Header -->
                    <div style="background: linear-gradient(180deg, #1a0a0a 0%, #0d0d0d 100%); padding: 6px 8px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #dc2626;">
                        <span style="color: #ef4444; font-weight: 700;">‚öîÔ∏è WARRIOR TRADING</span>
                        <div style="display: flex; gap: 6px;">
                            <button onclick="refreshWarriorPanel()" style="padding: 2px 8px; background: #333; border: none; color: #888; font-size: 9px; border-radius: 3px; cursor: pointer;">REFRESH</button>
                        </div>
                    </div>

                    <!-- Tab Navigation -->
                    <div style="display: flex; background: #0a0a0a; border-bottom: 1px solid #333;">
                        <button id="warriorTabSignals" class="warrior-tab active" onclick="switchWarriorTab('signals')" style="flex: 1; padding: 6px; background: #1a1a1a; border: none; border-right: 1px solid #333; color: #ef4444; font-size: 10px; cursor: pointer;">SIGNALS</button>
                        <button id="warriorTabPatterns" class="warrior-tab" onclick="switchWarriorTab('patterns')" style="flex: 1; padding: 6px; background: #0a0a0a; border: none; border-right: 1px solid #333; color: #888; font-size: 10px; cursor: pointer;">PATTERNS</button>
                        <button id="warriorTabTape" class="warrior-tab" onclick="switchWarriorTab('tape')" style="flex: 1; padding: 6px; background: #0a0a0a; border: none; border-right: 1px solid #333; color: #888; font-size: 10px; cursor: pointer;">TAPE</button>
                        <button id="warriorTabHalts" class="warrior-tab" onclick="switchWarriorTab('halts')" style="flex: 1; padding: 6px; background: #0a0a0a; border: none; color: #888; font-size: 10px; cursor: pointer;">HALTS</button>
                    </div>

                    <!-- Signals Tab -->
                    <div id="warriorSignalsTab" style="flex: 1; overflow-y: auto;">
                        <table style="width: 100%; border-collapse: collapse; font-size: 10px;">
                            <thead style="position: sticky; top: 0; background: #1a1a1a;">
                                <tr>
                                    <th style="padding: 4px 6px; text-align: left; color: #888; border-bottom: 1px solid #333;">SYM</th>
                                    <th style="padding: 4px 6px; text-align: center; color: #888; border-bottom: 1px solid #333;">GRADE</th>
                                    <th style="padding: 4px 6px; text-align: center; color: #888; border-bottom: 1px solid #333;">SCORE</th>
                                    <th style="padding: 4px 6px; text-align: center; color: #888; border-bottom: 1px solid #333;">PATTERN</th>
                                    <th style="padding: 4px 6px; text-align: center; color: #888; border-bottom: 1px solid #333;">ACTION</th>
                                </tr>
                            </thead>
                            <tbody id="warriorSignalsTable">
                                <tr><td colspan="5" style="padding: 12px; text-align: center; color: #666;">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Patterns Tab -->
                    <div id="warriorPatternsTab" style="flex: 1; overflow-y: auto; display: none;">
                        <div id="warriorPatternsContent" style="padding: 8px;">
                            <div style="color: #666; text-align: center; padding: 20px;">Click REFRESH to load patterns</div>
                        </div>
                    </div>

                    <!-- Tape Tab -->
                    <div id="warriorTapeTab" style="flex: 1; overflow-y: auto; display: none;">
                        <div id="warriorTapeContent" style="padding: 8px;">
                            <div style="color: #666; text-align: center; padding: 20px;">Click REFRESH to load tape signals</div>
                        </div>
                    </div>

                    <!-- Halts Tab -->
                    <div id="warriorHaltsTab" style="flex: 1; overflow-y: auto; display: none;">
                        <div id="warriorHaltsContent" style="padding: 8px;">
                            <div style="color: #666; text-align: center; padding: 20px;">No active halts detected</div>
                        </div>
                    </div>

                    <!-- Legend -->
                    <div style="padding: 4px 8px; background: #0a0a0a; border-top: 1px solid #333; font-size: 9px; display: flex; gap: 12px; justify-content: center;">
                        <span><span style="color: #22c55e; font-weight: 700;">A</span>=Full Size</span>
                        <span><span style="color: #fbbf24; font-weight: 700;">B</span>=Half Size</span>
                        <span><span style="color: #ef4444; font-weight: 700;">C</span>=Scalp Only</span>
                    </div>
                </div>
            `,

            chart: (id) => `
                <div id="chart-${id}" class="chart-container">
                    <div class="empty-state">Chart will load here</div>
                </div>
            `,

            hotkeys: `
                <div style="display: flex; flex-direction: column; height: 100%; font-family: 'Consolas', monospace;">
                    <!-- Header with Enable/Disable -->
                    <div style="padding: 8px 12px; background: linear-gradient(180deg, #1a1a1a 0%, #0d0d0d 100%); border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center;">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span style="color: #888; font-size: 11px;">HOTKEYS:</span>
                            <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
                                <input type="checkbox" id="hotkeysEnabled" checked onchange="toggleHotkeysEnabled(this.checked)" style="width: 14px; height: 14px;">
                                <span id="hotkeysStatusText" style="color: #00cc00; font-size: 11px; font-weight: 600;">ENABLED</span>
                            </label>
                        </div>
                        <div style="display: flex; gap: 6px;">
                            <button onclick="resetHotkeysToDefault()" class="hot-btn qty-hot" style="font-size: 9px;">RESET</button>
                            <button onclick="saveHotkeyConfig()" class="hot-btn buy-hot" style="font-size: 9px;">SAVE</button>
                        </div>
                    </div>

                    <!-- Hotkey Categories Tabs -->
                    <div style="display: flex; background: #0a0a0a; border-bottom: 1px solid #333;">
                        <button id="hkTabOrders" class="hot-btn qty-hot active" onclick="switchHotkeyTab('orders')" style="flex: 1; border-radius: 0; border: none; border-right: 1px solid #333;">ORDERS</button>
                        <button id="hkTabQty" class="hot-btn qty-hot" onclick="switchHotkeyTab('qty')" style="flex: 1; border-radius: 0; border: none; border-right: 1px solid #333;">QTY</button>
                        <button id="hkTabPrice" class="hot-btn qty-hot" onclick="switchHotkeyTab('price')" style="flex: 1; border-radius: 0; border: none; border-right: 1px solid #333;">PRICE</button>
                        <button id="hkTabMgmt" class="hot-btn qty-hot" onclick="switchHotkeyTab('mgmt')" style="flex: 1; border-radius: 0; border: none;">MGMT</button>
                    </div>

                    <!-- Hotkey Configuration Content -->
                    <div id="hotkeyTabContent" style="flex: 1; overflow-y: auto; padding: 8px;">
                        <!-- Orders Tab (default) - with modifier+key combos -->
                        <div id="hkPanelOrders">
                            <div style="padding: 4px 8px; background: #0a0a0a; border-bottom: 1px solid #222; margin-bottom: 4px;">
                                <div style="display: grid; grid-template-columns: 90px 70px 40px 1fr; gap: 4px; font-size: 9px; color: #666; text-transform: uppercase;">
                                    <span>ACTION</span>
                                    <span>MODIFIER</span>
                                    <span>KEY</span>
                                    <span>DESCRIPTION</span>
                                </div>
                            </div>
                            <div class="hk-row" style="grid-template-columns: 90px 70px 40px 1fr;">
                                <span class="hk-label">Buy @ Ask</span>
                                <select id="hk_buyAsk_mod" class="hk-input" style="width: 65px;" onchange="updateHotkeyCombo('buyAsk')">
                                    <option value="">None</option><option value="SHIFT">Shift</option><option value="CTRL">Ctrl</option><option value="ALT">Alt</option><option value="CTRL+SHIFT">Ctrl+Shift</option>
                                </select>
                                <input type="text" id="hk_buyAsk_key" class="hk-input" style="width: 35px;" value="B" maxlength="1" onclick="this.select()" onchange="updateHotkeyCombo('buyAsk')">
                                <span class="hk-desc">Aggressive buy</span>
                            </div>
                            <div class="hk-row" style="grid-template-columns: 90px 70px 40px 1fr;">
                                <span class="hk-label">Buy @ Bid</span>
                                <select id="hk_buyBid_mod" class="hk-input" style="width: 65px;" onchange="updateHotkeyCombo('buyBid')">
                                    <option value="">None</option><option value="SHIFT">Shift</option><option value="CTRL">Ctrl</option><option value="ALT">Alt</option><option value="CTRL+SHIFT">Ctrl+Shift</option>
                                </select>
                                <input type="text" id="hk_buyBid_key" class="hk-input" style="width: 35px;" value="" maxlength="1" onclick="this.select()" onchange="updateHotkeyCombo('buyBid')">
                                <span class="hk-desc">Passive buy</span>
                            </div>
                            <div class="hk-row" style="grid-template-columns: 90px 70px 40px 1fr;">
                                <span class="hk-label">Buy Market</span>
                                <select id="hk_buyMarket_mod" class="hk-input" style="width: 65px;" onchange="updateHotkeyCombo('buyMarket')">
                                    <option value="">None</option><option value="SHIFT">Shift</option><option value="CTRL">Ctrl</option><option value="ALT">Alt</option><option value="CTRL+SHIFT">Ctrl+Shift</option>
                                </select>
                                <input type="text" id="hk_buyMarket_key" class="hk-input" style="width: 35px;" value="M" maxlength="1" onclick="this.select()" onchange="updateHotkeyCombo('buyMarket')">
                                <span class="hk-desc">Market buy</span>
                            </div>
                            <div class="hk-row" style="grid-template-columns: 90px 70px 40px 1fr;">
                                <span class="hk-label">Sell @ Bid</span>
                                <select id="hk_sellBid_mod" class="hk-input" style="width: 65px;" onchange="updateHotkeyCombo('sellBid')">
                                    <option value="">None</option><option value="SHIFT">Shift</option><option value="CTRL">Ctrl</option><option value="ALT">Alt</option><option value="CTRL+SHIFT">Ctrl+Shift</option>
                                </select>
                                <input type="text" id="hk_sellBid_key" class="hk-input" style="width: 35px;" value="S" maxlength="1" onclick="this.select()" onchange="updateHotkeyCombo('sellBid')">
                                <span class="hk-desc">Aggressive sell</span>
                            </div>
                            <div class="hk-row" style="grid-template-columns: 90px 70px 40px 1fr;">
                                <span class="hk-label">Sell @ Ask</span>
                                <select id="hk_sellAsk_mod" class="hk-input" style="width: 65px;" onchange="updateHotkeyCombo('sellAsk')">
                                    <option value="">None</option><option value="SHIFT">Shift</option><option value="CTRL">Ctrl</option><option value="ALT">Alt</option><option value="CTRL+SHIFT">Ctrl+Shift</option>
                                </select>
                                <input type="text" id="hk_sellAsk_key" class="hk-input" style="width: 35px;" value="" maxlength="1" onclick="this.select()" onchange="updateHotkeyCombo('sellAsk')">
                                <span class="hk-desc">Passive sell</span>
                            </div>
                            <div class="hk-row" style="grid-template-columns: 90px 70px 40px 1fr;">
                                <span class="hk-label">Sell Market</span>
                                <select id="hk_sellMarket_mod" class="hk-input" style="width: 65px;" onchange="updateHotkeyCombo('sellMarket')">
                                    <option value="">None</option><option value="SHIFT">Shift</option><option value="CTRL">Ctrl</option><option value="ALT">Alt</option><option value="CTRL+SHIFT">Ctrl+Shift</option>
                                </select>
                                <input type="text" id="hk_sellMarket_key" class="hk-input" style="width: 35px;" value="N" maxlength="1" onclick="this.select()" onchange="updateHotkeyCombo('sellMarket')">
                                <span class="hk-desc">Market sell</span>
                            </div>
                            <div class="hk-row" style="grid-template-columns: 90px 70px 40px 1fr;">
                                <span class="hk-label">Sell Short</span>
                                <select id="hk_sellShort_mod" class="hk-input" style="width: 65px;" onchange="updateHotkeyCombo('sellShort')">
                                    <option value="">None</option><option value="SHIFT">Shift</option><option value="CTRL">Ctrl</option><option value="ALT">Alt</option><option value="CTRL+SHIFT">Ctrl+Shift</option>
                                </select>
                                <input type="text" id="hk_sellShort_key" class="hk-input" style="width: 35px;" value="" maxlength="1" onclick="this.select()" onchange="updateHotkeyCombo('sellShort')">
                                <span class="hk-desc">Short sell</span>
                            </div>
                            <div style="margin: 8px 0 4px 0; padding-top: 8px; border-top: 1px solid #333; color: #888; font-size: 10px;">POSITION SELLS</div>
                            <div class="hk-row" style="grid-template-columns: 90px 70px 40px 1fr;">
                                <span class="hk-label">Sell All @ Ask</span>
                                <select id="hk_sellAllAsk_mod" class="hk-input" style="width: 65px;" onchange="updateHotkeyCombo('sellAllAsk')">
                                    <option value="">None</option><option value="SHIFT">Shift</option><option value="CTRL">Ctrl</option><option value="ALT">Alt</option><option value="CTRL+SHIFT">Ctrl+Shift</option>
                                </select>
                                <input type="text" id="hk_sellAllAsk_key" class="hk-input" style="width: 35px;" value="A" maxlength="1" onclick="this.select()" onchange="updateHotkeyCombo('sellAllAsk')">
                                <span class="hk-desc">Sell all @ ask</span>
                            </div>
                            <div class="hk-row" style="grid-template-columns: 90px 70px 40px 1fr;">
                                <span class="hk-label">Sell All @ Bid</span>
                                <select id="hk_sellAllBid_mod" class="hk-input" style="width: 65px;" onchange="updateHotkeyCombo('sellAllBid')">
                                    <option value="">None</option><option value="SHIFT">Shift</option><option value="CTRL">Ctrl</option><option value="ALT">Alt</option><option value="CTRL+SHIFT">Ctrl+Shift</option>
                                </select>
                                <input type="text" id="hk_sellAllBid_key" class="hk-input" style="width: 35px;" value="B" maxlength="1" onclick="this.select()" onchange="updateHotkeyCombo('sellAllBid')">
                                <span class="hk-desc">Sell all @ bid</span>
                            </div>
                            <div class="hk-row" style="grid-template-columns: 90px 70px 40px 1fr;">
                                <span class="hk-label">Sell 1/2 @ Ask</span>
                                <select id="hk_sellHalfAsk_mod" class="hk-input" style="width: 65px;" onchange="updateHotkeyCombo('sellHalfAsk')">
                                    <option value="">None</option><option value="SHIFT">Shift</option><option value="CTRL">Ctrl</option><option value="ALT">Alt</option><option value="CTRL+SHIFT">Ctrl+Shift</option>
                                </select>
                                <input type="text" id="hk_sellHalfAsk_key" class="hk-input" style="width: 35px;" value="H" maxlength="1" onclick="this.select()" onchange="updateHotkeyCombo('sellHalfAsk')">
                                <span class="hk-desc">Sell half @ ask</span>
                            </div>
                            <div class="hk-row" style="grid-template-columns: 90px 70px 40px 1fr;">
                                <span class="hk-label">Sell 1/4 @ Ask</span>
                                <select id="hk_sellQuarterAsk_mod" class="hk-input" style="width: 65px;" onchange="updateHotkeyCombo('sellQuarterAsk')">
                                    <option value="">None</option><option value="SHIFT">Shift</option><option value="CTRL">Ctrl</option><option value="ALT">Alt</option><option value="CTRL+SHIFT">Ctrl+Shift</option>
                                </select>
                                <input type="text" id="hk_sellQuarterAsk_key" class="hk-input" style="width: 35px;" value="Q" maxlength="1" onclick="this.select()" onchange="updateHotkeyCombo('sellQuarterAsk')">
                                <span class="hk-desc">Sell 1/4 @ ask</span>
                            </div>
                        </div>

                        <!-- Quantity Tab - Editable Keys AND Share Amounts -->
                        <div id="hkPanelQty" style="display: none;">
                            <div style="padding: 4px 8px; background: #0a0a0a; border-bottom: 1px solid #222; margin-bottom: 4px;">
                                <div style="display: grid; grid-template-columns: 70px 50px 80px 1fr; gap: 8px; font-size: 9px; color: #666; text-transform: uppercase;">
                                    <span>SLOT</span>
                                    <span>KEY</span>
                                    <span>SHARES</span>
                                    <span>DESCRIPTION</span>
                                </div>
                            </div>
                            <div class="hk-row" style="grid-template-columns: 70px 50px 80px 1fr;">
                                <span class="hk-label">Qty 1</span>
                                <input type="text" id="hk_qty1Key" class="hk-input" value="1" maxlength="1" onclick="this.select()" onchange="updateHotkeyBinding('qty1Key', this.value)">
                                <input type="number" id="hk_qty1Shares" class="hk-input" value="100" min="1" max="99999" style="width: 70px;" onchange="updateHotkeyBinding('qty1Shares', parseInt(this.value))">
                                <span class="hk-desc">shares</span>
                            </div>
                            <div class="hk-row" style="grid-template-columns: 70px 50px 80px 1fr;">
                                <span class="hk-label">Qty 2</span>
                                <input type="text" id="hk_qty2Key" class="hk-input" value="2" maxlength="1" onclick="this.select()" onchange="updateHotkeyBinding('qty2Key', this.value)">
                                <input type="number" id="hk_qty2Shares" class="hk-input" value="200" min="1" max="99999" style="width: 70px;" onchange="updateHotkeyBinding('qty2Shares', parseInt(this.value))">
                                <span class="hk-desc">shares</span>
                            </div>
                            <div class="hk-row" style="grid-template-columns: 70px 50px 80px 1fr;">
                                <span class="hk-label">Qty 3</span>
                                <input type="text" id="hk_qty3Key" class="hk-input" value="3" maxlength="1" onclick="this.select()" onchange="updateHotkeyBinding('qty3Key', this.value)">
                                <input type="number" id="hk_qty3Shares" class="hk-input" value="500" min="1" max="99999" style="width: 70px;" onchange="updateHotkeyBinding('qty3Shares', parseInt(this.value))">
                                <span class="hk-desc">shares</span>
                            </div>
                            <div class="hk-row" style="grid-template-columns: 70px 50px 80px 1fr;">
                                <span class="hk-label">Qty 4</span>
                                <input type="text" id="hk_qty4Key" class="hk-input" value="4" maxlength="1" onclick="this.select()" onchange="updateHotkeyBinding('qty4Key', this.value)">
                                <input type="number" id="hk_qty4Shares" class="hk-input" value="1000" min="1" max="99999" style="width: 70px;" onchange="updateHotkeyBinding('qty4Shares', parseInt(this.value))">
                                <span class="hk-desc">shares</span>
                            </div>
                            <div class="hk-row" style="grid-template-columns: 70px 50px 80px 1fr;">
                                <span class="hk-label">Qty 5</span>
                                <input type="text" id="hk_qty5Key" class="hk-input" value="5" maxlength="1" onclick="this.select()" onchange="updateHotkeyBinding('qty5Key', this.value)">
                                <input type="number" id="hk_qty5Shares" class="hk-input" value="2000" min="1" max="99999" style="width: 70px;" onchange="updateHotkeyBinding('qty5Shares', parseInt(this.value))">
                                <span class="hk-desc">shares</span>
                            </div>
                            <div style="padding: 8px; margin-top: 8px; background: #0a1a0a; border: 1px solid #1a3a1a; border-radius: 4px; font-size: 10px; color: #4a4;">
                                TIP: Set shares to match your typical position sizes for quick entry
                            </div>
                        </div>

                        <!-- Price Tab -->
                        <div id="hkPanelPrice" style="display: none;">
                            <div class="hk-row">
                                <span class="hk-label">Price +0.01</span>
                                <input type="text" id="hk_priceUp1" class="hk-input" value="+" maxlength="1" onclick="this.select()" onchange="updateHotkeyBinding('priceUp1', this.value)">
                                <span class="hk-desc">Increase price by $0.01</span>
                            </div>
                            <div class="hk-row">
                                <span class="hk-label">Price -0.01</span>
                                <input type="text" id="hk_priceDown1" class="hk-input" value="-" maxlength="1" onclick="this.select()" onchange="updateHotkeyBinding('priceDown1', this.value)">
                                <span class="hk-desc">Decrease price by $0.01</span>
                            </div>
                            <div class="hk-row">
                                <span class="hk-label">Price +0.05</span>
                                <input type="text" id="hk_priceUp5" class="hk-input" value="" maxlength="1" onclick="this.select()" onchange="updateHotkeyBinding('priceUp5', this.value)">
                                <span class="hk-desc">Increase price by $0.05</span>
                            </div>
                            <div class="hk-row">
                                <span class="hk-label">Price -0.05</span>
                                <input type="text" id="hk_priceDown5" class="hk-input" value="" maxlength="1" onclick="this.select()" onchange="updateHotkeyBinding('priceDown5', this.value)">
                                <span class="hk-desc">Decrease price by $0.05</span>
                            </div>
                            <div class="hk-row">
                                <span class="hk-label">Set Bid Price</span>
                                <input type="text" id="hk_setBid" class="hk-input" value="" maxlength="1" onclick="this.select()" onchange="updateHotkeyBinding('setBid', this.value)">
                                <span class="hk-desc">Set order price to bid</span>
                            </div>
                            <div class="hk-row">
                                <span class="hk-label">Set Ask Price</span>
                                <input type="text" id="hk_setAsk" class="hk-input" value="" maxlength="1" onclick="this.select()" onchange="updateHotkeyBinding('setAsk', this.value)">
                                <span class="hk-desc">Set order price to ask</span>
                            </div>
                        </div>

                        <!-- Management Tab - with modifier+key combos -->
                        <div id="hkPanelMgmt" style="display: none;">
                            <div style="padding: 4px 8px; background: #0a0a0a; border-bottom: 1px solid #222; margin-bottom: 4px;">
                                <div style="display: grid; grid-template-columns: 90px 70px 40px 1fr; gap: 4px; font-size: 9px; color: #666; text-transform: uppercase;">
                                    <span>ACTION</span>
                                    <span>MODIFIER</span>
                                    <span>KEY</span>
                                    <span>DESCRIPTION</span>
                                </div>
                            </div>
                            <div class="hk-row" style="grid-template-columns: 90px 70px 40px 1fr;">
                                <span class="hk-label">Cancel All</span>
                                <select id="hk_cancelAll_mod" class="hk-input" style="width: 65px;" onchange="updateHotkeyCombo('cancelAll')">
                                    <option value="">None</option><option value="SHIFT">Shift</option><option value="CTRL">Ctrl</option><option value="ALT">Alt</option><option value="CTRL+SHIFT">Ctrl+Shift</option>
                                </select>
                                <input type="text" id="hk_cancelAll_key" class="hk-input" style="width: 35px;" value="X" maxlength="1" onclick="this.select()" onchange="updateHotkeyCombo('cancelAll')">
                                <span class="hk-desc">Cancel orders</span>
                            </div>
                            <div class="hk-row" style="grid-template-columns: 90px 70px 40px 1fr;">
                                <span class="hk-label">Flatten</span>
                                <select id="hk_flatten_mod" class="hk-input" style="width: 65px;" onchange="updateHotkeyCombo('flatten')">
                                    <option value="">None</option><option value="SHIFT">Shift</option><option value="CTRL">Ctrl</option><option value="ALT">Alt</option><option value="CTRL+SHIFT">Ctrl+Shift</option>
                                </select>
                                <input type="text" id="hk_flatten_key" class="hk-input" style="width: 35px;" value="F" maxlength="1" onclick="this.select()" onchange="updateHotkeyCombo('flatten')">
                                <span class="hk-desc">Close position</span>
                            </div>
                            <div class="hk-row" style="grid-template-columns: 90px 70px 40px 1fr;">
                                <span class="hk-label">Flatten All</span>
                                <select id="hk_flattenAll_mod" class="hk-input" style="width: 65px;" onchange="updateHotkeyCombo('flattenAll')">
                                    <option value="">None</option><option value="SHIFT">Shift</option><option value="CTRL">Ctrl</option><option value="ALT">Alt</option><option value="CTRL+SHIFT">Ctrl+Shift</option>
                                </select>
                                <input type="text" id="hk_flattenAll_key" class="hk-input" style="width: 35px;" value="F" maxlength="1" onclick="this.select()" onchange="updateHotkeyCombo('flattenAll')">
                                <span class="hk-desc">Close all</span>
                            </div>
                            <div class="hk-row" style="grid-template-columns: 90px 70px 40px 1fr;">
                                <span class="hk-label">Reverse</span>
                                <select id="hk_reverse_mod" class="hk-input" style="width: 65px;" onchange="updateHotkeyCombo('reverse')">
                                    <option value="">None</option><option value="SHIFT">Shift</option><option value="CTRL">Ctrl</option><option value="ALT">Alt</option><option value="CTRL+SHIFT">Ctrl+Shift</option>
                                </select>
                                <input type="text" id="hk_reverse_key" class="hk-input" style="width: 35px;" value="R" maxlength="1" onclick="this.select()" onchange="updateHotkeyCombo('reverse')">
                                <span class="hk-desc">Reverse pos</span>
                            </div>
                            <div class="hk-row" style="grid-template-columns: 90px 70px 40px 1fr;">
                                <span class="hk-label">Show Help</span>
                                <select id="hk_help_mod" class="hk-input" style="width: 65px;" onchange="updateHotkeyCombo('help')">
                                    <option value="">None</option><option value="SHIFT">Shift</option><option value="CTRL">Ctrl</option><option value="ALT">Alt</option><option value="CTRL+SHIFT">Ctrl+Shift</option>
                                </select>
                                <input type="text" id="hk_help_key" class="hk-input" style="width: 35px;" value="?" maxlength="1" onclick="this.select()" onchange="updateHotkeyCombo('help')">
                                <span class="hk-desc">Show help</span>
                            </div>
                        </div>
                    </div>

                    <!-- Quick Reference -->
                    <div style="padding: 8px 12px; background: #0a0a0a; border-top: 1px solid #333; font-size: 10px; color: #666;">
                        <div style="display: flex; justify-content: space-between;">
                            <span>TIP: Press key outside input fields to trigger</span>
                            <span>ESC always cancels all</span>
                        </div>
                    </div>
                </div>
            `,

            // AI Trade Chart - Lightweight Charts
            lwchart: `
                <div class="module-content" style="height: 100%; display: flex; flex-direction: column; background: #0a0a0a;">
                    <!-- Chart Controls -->
                    <div style="padding: 6px 8px; background: #1a1a1a; border-bottom: 1px solid #333; display: flex; gap: 8px; align-items: center; flex-wrap: wrap;">
                        <input type="text" id="lwchartSymbol" value="AAPL" placeholder="Symbol"
                               style="width: 70px; padding: 4px 8px; background: #252525; border: 1px solid #404040; color: #fff; font-size: 12px; border-radius: 3px;">
                        <div style="display: flex; gap: 2px;">
                            <button class="lw-tf-btn" data-tf="1m" onclick="changeLWTimeframe('1m', this)">1m</button>
                            <button class="lw-tf-btn active" data-tf="5m" onclick="changeLWTimeframe('5m', this)">5m</button>
                            <button class="lw-tf-btn" data-tf="15m" onclick="changeLWTimeframe('15m', this)">15m</button>
                            <button class="lw-tf-btn" data-tf="1h" onclick="changeLWTimeframe('1h', this)">1h</button>
                            <button class="lw-tf-btn" data-tf="1d" onclick="changeLWTimeframe('1d', this)">D</button>
                        </div>
                        <select id="lwchartDays" style="padding: 3px 6px; background: #252525; border: 1px solid #404040; color: #fff; font-size: 11px; border-radius: 3px;">
                            <option value="1">1 Day</option>
                            <option value="3">3 Days</option>
                            <option value="5" selected>5 Days</option>
                            <option value="7">1 Week</option>
                            <option value="14">2 Weeks</option>
                            <option value="30">1 Month</option>
                        </select>
                        <button onclick="loadLWChart()" style="padding: 4px 12px; background: #2563eb; color: #fff; border: none; border-radius: 3px; cursor: pointer; font-size: 11px;">Load</button>
                        <button onclick="jumpToTrades()" style="padding: 4px 8px; background: #22c55e; color: #fff; border: none; border-radius: 3px; cursor: pointer; font-size: 10px;" title="Jump to trade markers">Trades</button>
                        <span id="lwchartStatus" style="font-size: 10px; color: #666; margin-left: auto;">Ready</span>
                    </div>

                    <!-- Indicator Toggles -->
                    <div style="padding: 4px 8px; background: #151515; border-bottom: 1px solid #333; display: flex; gap: 8px; align-items: center; font-size: 10px; flex-wrap: wrap;">
                        <label style="color: #888; cursor: pointer;"><input type="checkbox" id="lwShowTrades" checked onchange="toggleLWTrades()"> Trades</label>
                        <label style="color: #eab308; cursor: pointer;"><input type="checkbox" id="lwShowSignals" onchange="toggleLWSignals()"> Signals</label>
                        <label style="color: #f97316; cursor: pointer;"><input type="checkbox" id="lwShowEMA9" onchange="toggleLWIndicator('ema9')"> EMA(9)</label>
                        <label style="color: #3b82f6; cursor: pointer;"><input type="checkbox" id="lwShowEMA20" onchange="toggleLWIndicator('ema20')"> EMA(20)</label>
                        <label style="color: #a855f7; cursor: pointer;"><input type="checkbox" id="lwShowVWAP" onchange="toggleLWIndicator('vwap')"> VWAP</label>
                        <label style="color: #26a69a; cursor: pointer;"><input type="checkbox" id="lwShowVolume" checked onchange="toggleLWVolume()"> Volume</label>
                        <label style="color: #22c55e; cursor: pointer;"><input type="checkbox" id="lwShowMACD" onchange="toggleLWMACD()"> MACD</label>
                    </div>

                    <!-- Signal Status Bar -->
                    <div id="lwSignalBar" style="padding: 4px 8px; background: #0d0d0d; border-bottom: 1px solid #333; font-size: 10px; display: none;">
                        <span style="color: #888;">Confluence: </span>
                        <span id="lwConfluenceScore" style="font-weight: bold;">--</span>
                        <span style="color: #888; margin-left: 12px;">Bias: </span>
                        <span id="lwSignalBias" style="font-weight: bold;">--</span>
                        <span style="color: #888; margin-left: 12px;">EMA: </span>
                        <span id="lwEmaState">--</span>
                        <span style="color: #888; margin-left: 12px;">MACD: </span>
                        <span id="lwMacdState">--</span>
                        <span style="color: #888; margin-left: 12px;">VWAP: </span>
                        <span id="lwVwapState">--</span>
                    </div>

                    <!-- Chart Container (includes MACD as overlay) -->
                    <div id="lwchartContainer" style="flex: 1; min-height: 350px;"></div>

                    <!-- Trade Summary -->
                    <div id="lwchartSummary" style="padding: 6px 10px; background: #1a1a1a; border-top: 1px solid #333; font-size: 11px; display: flex; gap: 16px;">
                        <span>Trades: <b id="lwTradeCount">0</b></span>
                        <span>Win Rate: <b id="lwWinRate" style="color: #22c55e;">0%</b></span>
                        <span>P&L: <b id="lwTotalPnl" style="color: #888;">$0.00</b></span>
                    </div>
                </div>
            `,

            // Equity Curve - Lightweight Charts
            equitycurve: `
                <div class="module-content" style="height: 100%; display: flex; flex-direction: column; background: #0a0a0a;">
                    <!-- Controls -->
                    <div style="padding: 8px 10px; background: #1a1a1a; border-bottom: 1px solid #333; display: flex; gap: 12px; align-items: center;">
                        <span style="font-size: 11px; color: #888;">Period:</span>
                        <select id="equityCurvePeriod" onchange="loadEquityCurve()" style="padding: 4px 8px; background: #252525; border: 1px solid #404040; color: #fff; font-size: 11px; border-radius: 3px;">
                            <option value="7">Last 7 Days</option>
                            <option value="30" selected>Last 30 Days</option>
                            <option value="90">Last 90 Days</option>
                            <option value="all">All Time</option>
                        </select>
                        <button onclick="loadEquityCurve()" style="padding: 4px 12px; background: #2563eb; color: #fff; border: none; border-radius: 3px; cursor: pointer; font-size: 11px;">Refresh</button>
                    </div>

                    <!-- Chart Container -->
                    <div id="equityCurveContainer" style="flex: 1; min-height: 250px;"></div>

                    <!-- Stats Summary -->
                    <div style="padding: 8px 12px; background: #1a1a1a; border-top: 1px solid #333; display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; font-size: 10px;">
                        <div style="text-align: center;">
                            <div style="color: #666;">Initial</div>
                            <div id="eqInitial" style="color: #fff; font-weight: 600;">$1,000</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="color: #666;">Current</div>
                            <div id="eqCurrent" style="color: #22c55e; font-weight: 600;">$0</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="color: #666;">Total P&L</div>
                            <div id="eqTotalPnl" style="color: #888; font-weight: 600;">$0</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="color: #666;">Max DD</div>
                            <div id="eqMaxDD" style="color: #ef4444; font-weight: 600;">0%</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="color: #666;">Win Rate</div>
                            <div id="eqWinRate" style="color: #888; font-weight: 600;">0%</div>
                        </div>
                    </div>
                </div>
            `,

            // Backtest View - Lightweight Charts
            backtestview: `
                <div class="module-content" style="height: 100%; display: flex; flex-direction: column; background: #0a0a0a;">
                    <!-- Controls -->
                    <div style="padding: 8px 10px; background: #1a1a1a; border-bottom: 1px solid #333; display: flex; gap: 8px; align-items: center; flex-wrap: wrap;">
                        <input type="text" id="backtestSymbol" placeholder="Symbol (or ALL)" value="ALL"
                               style="width: 80px; padding: 4px 8px; background: #252525; border: 1px solid #404040; color: #fff; font-size: 11px; border-radius: 3px;">
                        <button onclick="loadBacktestView()" style="padding: 4px 12px; background: #2563eb; color: #fff; border: none; border-radius: 3px; cursor: pointer; font-size: 11px;">Load</button>
                        <span id="backtestStatus" style="font-size: 10px; color: #666; margin-left: auto;">Ready</span>
                    </div>

                    <!-- Summary Stats -->
                    <div style="padding: 8px 12px; background: #151515; border-bottom: 1px solid #333; display: grid; grid-template-columns: repeat(6, 1fr); gap: 6px; font-size: 10px;">
                        <div style="text-align: center;">
                            <div style="color: #666;">Trades</div>
                            <div id="btTotalTrades" style="color: #fff; font-weight: 600;">0</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="color: #666;">Winners</div>
                            <div id="btWinners" style="color: #22c55e; font-weight: 600;">0</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="color: #666;">Losers</div>
                            <div id="btLosers" style="color: #ef4444; font-weight: 600;">0</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="color: #666;">Win Rate</div>
                            <div id="btWinRate" style="color: #888; font-weight: 600;">0%</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="color: #666;">Avg Win</div>
                            <div id="btAvgWin" style="color: #22c55e; font-weight: 600;">$0</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="color: #666;">Avg Loss</div>
                            <div id="btAvgLoss" style="color: #ef4444; font-weight: 600;">$0</div>
                        </div>
                    </div>

                    <!-- Exit Reason Breakdown -->
                    <div style="padding: 8px 12px; background: #1a1a1a; border-bottom: 1px solid #333;">
                        <div style="font-size: 10px; color: #888; margin-bottom: 6px;">Exit Reason Breakdown</div>
                        <div id="btExitReasons" style="display: flex; flex-wrap: wrap; gap: 6px; font-size: 10px;"></div>
                    </div>

                    <!-- Trades Table -->
                    <div style="flex: 1; overflow-y: auto;">
                        <table style="width: 100%; border-collapse: collapse; font-size: 10px;">
                            <thead style="position: sticky; top: 0; background: #1a1a1a;">
                                <tr style="color: #888; border-bottom: 1px solid #333;">
                                    <th style="padding: 6px 8px; text-align: left;">Symbol</th>
                                    <th style="padding: 6px 8px; text-align: right;">Entry</th>
                                    <th style="padding: 6px 8px; text-align: right;">Exit</th>
                                    <th style="padding: 6px 8px; text-align: left;">Reason</th>
                                    <th style="padding: 6px 8px; text-align: right;">P&L</th>
                                    <th style="padding: 6px 8px; text-align: right;">%</th>
                                </tr>
                            </thead>
                            <tbody id="btTradesBody"></tbody>
                        </table>
                    </div>

                    <!-- Total P&L -->
                    <div style="padding: 8px 12px; background: #1a1a1a; border-top: 1px solid #333; display: flex; justify-content: space-between; align-items: center;">
                        <span style="font-size: 11px; color: #888;">Total P&L:</span>
                        <span id="btTotalPnl" style="font-size: 14px; font-weight: 700; color: #888;">$0.00</span>
                    </div>
                </div>
            `
        };

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        //                     ACCOUNT MANAGEMENT
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        let availableAccounts = [];
        let selectedTradingAccount = null;

        async function loadTradingAccounts() {
            try {
                const resp = await fetch(API_BASE_URL + '/api/schwab/accounts');
                const data = await resp.json();

                if (data.accounts && data.accounts.length > 0) {
                    availableAccounts = data.accounts;
                    const select = document.getElementById('tradingAccount');
                    if (select) {
                        select.innerHTML = data.accounts.map(acc =>
                            `<option value="${acc.account_number}" ${acc.selected ? 'selected' : ''}>
                                ${acc.account_number}
                            </option>`
                        ).join('');

                        // Set selected account
                        selectedTradingAccount = data.selected;
                        // Fetch account type from API
                        updateAccountLabelFromAPI();
                    }
                }
            } catch (e) {
                console.error('Failed to load trading accounts:', e);
            }
        }

        async function selectTradingAccount(accountNumber) {
            if (!accountNumber) return;

            try {
                const resp = await fetch(API_BASE_URL + '/api/schwab/accounts/select', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({account_number: accountNumber})
                });

                const data = await resp.json();
                if (data.success) {
                    selectedTradingAccount = accountNumber;
                    await updateAccountLabelFromAPI();
                    showNotification(`Trading account switched to ${accountNumber}`, 'success');
                    // Refresh positions and account for new account
                    loadPositions();
                    loadAccount();
                }
            } catch (e) {
                console.error('Failed to switch account:', e);
                showNotification('Failed to switch account', 'error');
            }
        }

        async function updateAccountLabelFromAPI() {
            const label = document.getElementById('accountTypeLabel');
            if (label) {
                try {
                    const resp = await fetch(API_BASE_URL + '/api/account');
                    const data = await resp.json();
                    if (data.type) {
                        label.textContent = data.type;
                        label.style.color = data.type === 'CASH' ? '#22c55e' : '#60a5fa';
                    }
                } catch (e) {
                    console.error('Failed to get account type:', e);
                }
            }
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        //                     SYMBOL MANAGEMENT
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        // Handle manual symbol entry in order form
        function handleSymbolChange(symbol) {
            if (!symbol || symbol.trim() === '') return;
            symbol = symbol.toUpperCase().trim();
            console.log('Manual symbol entry:', symbol);
            setCurrentSymbol(symbol);
            showNotification(`Symbol changed to ${symbol}`, 'info');
        }

        function setCurrentSymbol(symbol) {
            currentSymbol = symbol.toUpperCase();
            document.getElementById('currentSymbolDisplay').textContent = currentSymbol;
            document.getElementById('orderSymbol').value = currentSymbol;

            // Subscribe to market data for new symbol
            subscribeToSymbol(currentSymbol);

            // Update all windows titles
            windows.forEach(win => {
                if (win.id === 'quote') {
                    win.title = `QUOTE - ${currentSymbol}`;
                    win.element.querySelector('.window-header span').textContent = win.title;
                } else if (win.id === 'level2') {
                    win.title = `LEVEL II - ${currentSymbol}`;
                    win.element.querySelector('.window-header span').textContent = win.title;
                } else if (win.id.startsWith('chart')) {
                    const chartId = win.id.replace('chart', '');
                    // Only update LINKED charts
                    if (isChartLinked(chartId)) {
                        win.title = `CHART - ${currentSymbol}`;
                        win.element.querySelector('.window-header span').textContent = win.title;
                        // Update TradingView chart
                        setChartSymbol(chartId, currentSymbol);
                    }
                    // Independent charts keep their own symbol
                }
            });

            // Refresh all market data
            loadPrice();
            loadLevel2();
            loadTimeSales();
            loadWorklist();
            loadAssetStatus();  // Load halt/ETB/HTB status
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        //                     API INTEGRATION
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        // Helper function to safely update element
        function safeUpdate(id, value) {
            const el = document.getElementById(id);
            if (el) {
                if (el.tagName === 'INPUT' || el.tagName === 'SELECT') {
                    el.value = value;
                } else {
                    el.textContent = value;
                }
                return true;
            }
            return false;
        }

        // Helper function to fetch API with error handling
        async function apiFetch(url) {
            try {
                const response = await fetch(API_BASE_URL + url);
                if (response.ok) {
                    apiAvailable = true;
                    return await response.json();
                } else if (response.status === 503) {
                    if (!demoModeLogged) {
                        console.log('%c‚ö†Ô∏è Broker not connected. Please check Schwab connection.', 'color: #ef4444; font-weight: bold;');
                        demoModeLogged = true;
                    }
                    return null;
                } else {
                    apiAvailable = false;
                    return null;
                }
            } catch (error) {
                if (!demoModeLogged) {
                    console.log('%c‚ö†Ô∏è API Server not available', 'color: #ef4444; font-weight: bold;');
                    demoModeLogged = true;
                }
                return null;
            }
        }

        // Subscribe to market data for a symbol
        async function subscribeToSymbol(symbol) {
            try {
                await fetch(API_BASE_URL + '/api/subscribe', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        symbol: symbol,
                        exchange: 'SMART',
                        data_types: ['quote', 'l2', 'trades']
                    })
                });
                console.log(`‚úì Subscribed to ${symbol}`);

                // Also subscribe to Polygon streaming if active
                if (polygonStreamActive) {
                    await fetch(API_BASE_URL + '/api/polygon/stream/subscribe', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ symbol: symbol, data_type: 'trades' })
                    });
                    console.log(`‚úì Polygon stream subscribed: ${symbol}`);
                }
            } catch (error) {
                console.error(`Error subscribing to ${symbol}:`, error);
            }
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        //                     HALT DETECTION & MANAGEMENT
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        function checkForHalt(symbol, data) {
            const now = Date.now();

            // Check if we're in regular market hours (9:30 AM - 4:00 PM ET)
            const currentTime = new Date();
            const hours = currentTime.getHours();
            const minutes = currentTime.getMinutes();
            const timeInMinutes = hours * 60 + minutes;

            // Market hours: 9:30 AM (570 minutes) to 4:00 PM (960 minutes) ET
            // Note: This assumes your local time is ET. Adjust if needed.
            const marketOpen = 570;  // 9:30 AM
            const marketClose = 960; // 4:00 PM
            const isMarketHours = timeInMinutes >= marketOpen && timeInMinutes < marketClose;

            // Only check for halts during market hours
            // During pre-market/after-hours, bid/ask = 0 is normal, not a halt
            if (!isMarketHours) {
                // Not in market hours - don't detect halts
                if (haltState.isHalted) {
                    // Clear any existing halt state from previous session
                    haltState.isHalted = false;
                    hideHaltIndicator();
                }
                return;
            }

            // Detect halt conditions (ONLY during market hours):
            // 1. Bid and Ask are both 0 or -1
            // 2. OR no updates for more than 8 seconds
            const isDataHalted = (data.bid <= 0 && data.ask <= 0) ||
                                 (data.bid === -1 || data.ask === -1);

            const timeSinceLastUpdate = haltState.lastUpdateTime ? now - haltState.lastUpdateTime : 0;
            const isTimeoutHalt = timeSinceLastUpdate > 8000; // 8 seconds no update

            if ((isDataHalted || isTimeoutHalt) && !haltState.isHalted) {
                // Entering halt
                haltState.isHalted = true;
                haltState.haltTime = new Date();
                haltState.haltPrice = data.last || marketDataCache[symbol]?.last || 0;
                haltState.symbol = symbol;
                haltState.resumeTime = null;

                showHaltIndicator();
                console.log(`üõë HALT DETECTED: ${symbol} at $${haltState.haltPrice.toFixed(2)}`);

            } else if (!isDataHalted && !isTimeoutHalt && haltState.isHalted && data.bid > 0 && data.ask > 0) {
                // Resuming from halt
                haltState.resumeTime = new Date();
                const haltDuration = Math.floor((haltState.resumeTime - haltState.haltTime) / 1000);

                console.log(`‚úÖ RESUMED: ${symbol} after ${haltDuration}s halt`);

                // Show resume notification briefly, then hide
                updateHaltIndicator('resumed');
                setTimeout(() => {
                    haltState.isHalted = false;
                    hideHaltIndicator();
                }, 3000); // Show resume for 3 seconds
            }

            // Update last update time if we got valid data
            if (data.bid > 0 || data.ask > 0 || data.last > 0) {
                haltState.lastUpdateTime = now;
            }

            // Update halt indicator if already halted
            if (haltState.isHalted && haltState.resumeTime === null) {
                updateHaltIndicator('halted');
            }
        }

        function showHaltIndicator() {
            const indicator = document.getElementById('quoteHaltIndicator');
            if (indicator) {
                indicator.style.display = 'block';
            }
        }

        function hideHaltIndicator() {
            const indicator = document.getElementById('quoteHaltIndicator');
            if (indicator) {
                indicator.style.display = 'none';
            }
        }

        function updateHaltIndicator(status) {
            const indicator = document.getElementById('quoteHaltIndicator');
            const titleEl = document.getElementById('quoteHaltTitle');
            const infoEl = document.getElementById('quoteHaltInfo');

            if (!indicator || !titleEl || !infoEl) return;

            if (status === 'halted') {
                const haltDuration = Math.floor((Date.now() - haltState.haltTime) / 1000);
                const haltTimeStr = haltState.haltTime.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', second: '2-digit' });

                titleEl.textContent = 'üõë HALT';
                infoEl.innerHTML = `${haltTimeStr} ‚Ä¢ $${(haltState.haltPrice || 0).toFixed(2)} ‚Ä¢ ${haltDuration}s`;

                indicator.style.background = 'linear-gradient(135deg, #dc2626 0%, #991b1b 100%)';
                indicator.style.color = 'white';

            } else if (status === 'resumed') {
                const resumeTimeStr = haltState.resumeTime.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
                const haltDuration = Math.floor((haltState.resumeTime - haltState.haltTime) / 1000);

                titleEl.textContent = '‚úÖ RESUMED';
                infoEl.innerHTML = `${resumeTimeStr} ‚Ä¢ ${haltDuration}s halt`;

                indicator.style.background = 'linear-gradient(135deg, #16a34a 0%, #15803d 100%)';
                indicator.style.color = 'white';
            }
        }

        async function loadPrice() {
            try {
                // Fetch ONLY from API
                const apiData = await apiFetch(`/api/price/${currentSymbol}`);
                if (!apiData || !apiData.data) {
                    // Clear displays if no data
                    safeUpdate('bidPrice', '--');
                    safeUpdate('askPrice', '--');
                    safeUpdate('lastPrice', '--');
                    safeUpdate('volumePrice', '--');
                    safeUpdate('highPrice', '--');
                    safeUpdate('lowPrice', '--');
                    safeUpdate('openPrice', '--');
                    safeUpdate('closePrice', '--');
                    safeUpdate('bidSize', '--');
                    safeUpdate('askSize', '--');
                    return;
                }

                const d = apiData.data;

                // UPDATE CENTRALIZED STORE FIRST - This will trigger all subscribers
                marketDataStore.update(currentSymbol, {
                    last: d.last,
                    bid: d.bid,
                    ask: d.ask,
                    volume: d.volume,
                    high: d.high,
                    low: d.low,
                    open: d.open,
                    close: d.close,
                    bidSize: d.bidSize,
                    askSize: d.askSize
                });

                // Update UI elements safely
                safeUpdate('bidPrice', d.bid?.toFixed(2) || '--');
                safeUpdate('askPrice', d.ask?.toFixed(2) || '--');
                safeUpdate('lastPrice', d.last?.toFixed(2) || '--');
                safeUpdate('volumePrice', d.volume?.toLocaleString() || '--');
                safeUpdate('highPrice', d.high?.toFixed(2) || '--');
                safeUpdate('lowPrice', d.low?.toFixed(2) || '--');
                safeUpdate('openPrice', d.open?.toFixed(2) || '--');
                safeUpdate('closePrice', d.close?.toFixed(2) || '--');

                if (d.bid) safeUpdate('bidSize', `x ${d.bidSize || 0}`);
                if (d.ask) safeUpdate('askSize', `x ${d.askSize || 0}`);

                // Calculate and display change
                if (d.last && d.close) {
                    const change = d.last - d.close;
                    const changePct = ((change / d.close) * 100).toFixed(2);
                    const changeEl = document.getElementById('priceChange');
                    if (changeEl) {
                        changeEl.textContent = `${change >= 0 ? '+' : ''}${change.toFixed(2)} (${changePct}%)`;
                        changeEl.className = change >= 0 ? 'quote-stat-label positive' : 'quote-stat-label negative';
                    }
                }

                // Auto-set limit price to mid (only if field is not focused and empty/invalid)
                const orderTypeEl = document.getElementById('orderType');
                const orderPriceEl = document.getElementById('orderPrice');
                if (d.bid && d.ask && d.bid > 0 && d.ask > 0 && orderTypeEl && orderTypeEl.value === 'LIMIT') {
                    // Only update if user is NOT currently typing (field not focused) and field is empty or invalid
                    if (document.activeElement !== orderPriceEl &&
                        (!orderPriceEl.value || orderPriceEl.value === '' || parseFloat(orderPriceEl.value) <= 0)) {
                        const mid = ((d.bid + d.ask) / 2).toFixed(2);
                        safeUpdate('orderPrice', mid);
                    }
                }

                // Legacy cache already updated by store.update()

                // Update market price display in order panel
                safeUpdate('marketBid', d.bid?.toFixed(2) || '--');
                safeUpdate('marketLast', d.last?.toFixed(2) || '--');
                safeUpdate('marketAsk', d.ask?.toFixed(2) || '--');

                // Check for trading halt
                checkForHalt(currentSymbol, d);
            } catch (error) {
                console.error('Error loading price:', error);
            }
        }

        async function loadLevel2() {
            try {
                const bidsEl = document.getElementById('bidsDisplay');
                const asksEl = document.getElementById('asksDisplay');

                if (!bidsEl || !asksEl) return;

                let data = null;
                let source = 'schwab';

                // Try Schwab L2 first (real order book - shows pending orders)
                const apiData = await apiFetch(`/api/level2/${currentSymbol}`);
                if (apiData && apiData.bids && apiData.bids.length > 1) {
                    // Real L2 book data (more than just top of book)
                    data = apiData;
                    source = apiData.source || 'schwab_book';
                }

                // If only top of book from Schwab, try Polygon synthetic depth
                if (!data || data.bids.length <= 1) {
                    // Always try Polygon depth for real volume data
                    try {
                        const depthResp = await fetch(API_BASE_URL + `/api/polygon/stream/depth/${currentSymbol}?levels=15`);
                        if (depthResp.ok) {
                            const depthData = await depthResp.json();
                            if (depthData.bids && depthData.bids.length > 0) {
                                data = depthData;
                                source = 'polygon_synthetic';
                            }
                        }
                    } catch (e) {
                        console.log('Polygon depth fetch error:', e);
                    }
                }

                // Final fallback to basic Schwab quote
                if (!data && apiData) {
                    data = apiData;
                    source = 'cache';
                }

                if (!data) {
                    bidsEl.innerHTML = '<div class="empty-state">Level 2 data unavailable</div>';
                    asksEl.innerHTML = '<div class="empty-state">Level 2 data unavailable</div>';
                    return;
                }

                // Source indicator - Sterling style
                let sourceLabel = '';
                if (source.includes('schwab_book') || source.includes('nyse') || source.includes('nasdaq')) {
                    sourceLabel = '<div style="font-size: 8px; color: #00cc00; text-align: center; padding: 1px; background: #001a00; letter-spacing: 1px;">ORDER BOOK</div>';
                } else if (source === 'polygon_synthetic') {
                    sourceLabel = '<div style="font-size: 8px; color: #ff9900; text-align: center; padding: 1px; background: #1a0d00; letter-spacing: 1px;">DEPTH</div>';
                }

                // Sterling-style Market Maker IDs
                const mmidList = ['ARCA', 'BATS', 'NSDQ', 'EDGX', 'IEX', 'MEMX', 'LTSE', 'PHLX', 'NYSE', 'AMEX', 'BYX', 'EDGA', 'XCHI', 'XBOS'];
                const getMMID = (mm, idx) => mm || mmidList[idx % mmidList.length];

                // Find max size for highlighting large orders
                const maxBidSize = data.bids ? Math.max(...data.bids.map(b => b.size)) : 0;
                const maxAskSize = data.asks ? Math.max(...data.asks.map(a => a.size)) : 0;

                let bidsHtml = sourceLabel;
                if (data.bids && data.bids.length > 0) {
                    data.bids.slice(0, 15).forEach((bid, i) => {
                        const level = Math.min(i, 4); // 0-4 for gradient levels
                        const isLarge = bid.size > maxBidSize * 0.5;
                        const sizeClass = isLarge ? 'level2-size large' : 'level2-size';
                        const mmid = getMMID(bid.market_maker, i);
                        bidsHtml += `
                            <div class="level2-row bid-level-${level} clickable" onclick="setOrderPrice(${bid.price}, 'BUY')">
                                <div class="level2-mmid">${mmid}</div>
                                <div class="${sizeClass}" style="color: #00cc00;">${bid.size >= 1000 ? (bid.size/1000).toFixed(1)+'K' : bid.size}</div>
                                <div class="level2-price" style="color: #00ff00;">${bid.price.toFixed(2)}</div>
                                <div class="level2-time">${bid.orders || ''}</div>
                            </div>
                        `;
                    });
                } else {
                    bidsHtml += '<div class="empty-state" style="font-size: 10px; padding: 15px;">No bids</div>';
                }

                let asksHtml = sourceLabel;
                if (data.asks && data.asks.length > 0) {
                    data.asks.slice(0, 15).forEach((ask, i) => {
                        const level = Math.min(i, 4); // 0-4 for gradient levels
                        const isLarge = ask.size > maxAskSize * 0.5;
                        const sizeClass = isLarge ? 'level2-size large' : 'level2-size';
                        const mmid = getMMID(ask.market_maker, i);
                        asksHtml += `
                            <div class="level2-row ask-level-${level} clickable" onclick="setOrderPrice(${ask.price}, 'SELL')">
                                <div class="level2-time">${ask.orders || ''}</div>
                                <div class="level2-price" style="color: #ff3333;">${ask.price.toFixed(2)}</div>
                                <div class="${sizeClass}" style="color: #cc3333;">${ask.size >= 1000 ? (ask.size/1000).toFixed(1)+'K' : ask.size}</div>
                                <div class="level2-mmid">${mmid}</div>
                            </div>
                        `;
                    });
                } else {
                    asksHtml += '<div class="empty-state" style="font-size: 10px; padding: 15px;">No asks</div>';
                }

                bidsEl.innerHTML = bidsHtml;
                asksEl.innerHTML = asksHtml;

                // Update LULD indicator
                const luldIndicator = document.getElementById('luld-indicator');
                const luldUpper = document.getElementById('luld-upper');
                const luldLower = document.getElementById('luld-lower');

                if (data.luld && data.luld.upper && data.luld.lower && luldIndicator) {
                    luldIndicator.style.display = 'block';
                    if (luldUpper) luldUpper.textContent = data.luld.upper.toFixed(2);
                    if (luldLower) luldLower.textContent = data.luld.lower.toFixed(2);

                    // Color code if price is close to bands (within 2%)
                    const price = data.bids[0]?.price || data.asks[0]?.price || 0;
                    if (price > 0) {
                        const upperPct = ((data.luld.upper - price) / price) * 100;
                        const lowerPct = ((price - data.luld.lower) / price) * 100;
                        const upperSpan = luldUpper?.parentElement;
                        const lowerSpan = luldLower?.parentElement;

                        if (upperSpan) {
                            upperSpan.style.color = upperPct < 2 ? '#ff6b6b' : '#22c55e';
                            if (upperPct < 2) upperSpan.style.fontWeight = '700';
                        }
                        if (lowerSpan) {
                            lowerSpan.style.color = lowerPct < 2 ? '#ff6b6b' : '#ef4444';
                            if (lowerPct < 2) lowerSpan.style.fontWeight = '700';
                        }
                    }
                } else if (luldIndicator) {
                    luldIndicator.style.display = 'none';
                }
            } catch (error) {
                console.error('Error loading level2:', error);
            }
        }

        // Polygon streaming state
        let polygonStreamActive = false;

        async function checkPolygonStream() {
            try {
                const resp = await fetch(API_BASE_URL + '/api/polygon/stream/status');
                if (resp.ok) {
                    const data = await resp.json();
                    const wasActive = polygonStreamActive;
                    polygonStreamActive = data.connected && data.available;

                    // If stream just became active or current symbol not subscribed, subscribe it
                    if (polygonStreamActive && currentSymbol) {
                        const subs = data.trade_subscriptions || [];
                        if (!subs.includes(currentSymbol)) {
                            await fetch(API_BASE_URL + '/api/polygon/stream/subscribe', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ symbol: currentSymbol, data_type: 'trades' })
                            });
                            console.log(`‚úì Auto-subscribed ${currentSymbol} to Polygon stream`);
                        }
                    }
                    return polygonStreamActive;
                }
            } catch (e) {}
            return false;
        }

        async function startPolygonStream(symbol) {
            try {
                // Start the stream if not running
                await fetch(API_BASE_URL + '/api/polygon/stream/start', { method: 'POST' });
                // Subscribe to the symbol
                await fetch(API_BASE_URL + '/api/polygon/stream/subscribe', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ symbol: symbol, trades: true, quotes: true })
                });
                polygonStreamActive = true;
                console.log(`Polygon stream started for ${symbol}`);
            } catch (e) {
                console.log('Polygon stream not available:', e);
            }
        }

        async function loadTimeSales() {
            try {
                const displayEl = document.getElementById('timesalesDisplay');
                if (!displayEl) return;

                let trades = [];
                let source = 'none';

                // Try Polygon streaming first
                if (polygonStreamActive) {
                    try {
                        const polygonResp = await fetch(API_BASE_URL + `/api/polygon/stream/trades/${currentSymbol}?limit=50`);
                        if (polygonResp.ok) {
                            const data = await polygonResp.json();
                            if (data.trades && data.trades.length > 0) {
                                trades = data.trades;
                                source = 'polygon';
                            }
                        }
                    } catch (e) {}
                }

                // Fall back to REST API
                if (trades.length === 0) {
                    const apiData = await apiFetch(`/api/timesales/${currentSymbol}?limit=50`);
                    if (apiData && apiData.trades && apiData.trades.length > 0) {
                        trades = apiData.trades;
                        source = 'rest';
                    }
                }

                if (trades.length === 0) {
                    displayEl.innerHTML = `
                        <div class="empty-state">
                            Time & Sales requires tick data<br>
                            <small style="color: #666;">
                                ${polygonStreamActive ? 'Waiting for trades...' : 'Start Polygon stream or upgrade subscription'}
                            </small>
                            <button onclick="startPolygonStream('${currentSymbol}')" class="btn btn-secondary" style="margin-top: 8px; font-size: 11px; padding: 4px 8px;">
                                Start Polygon Stream
                            </button>
                        </div>`;
                    return;
                }

                let html = '';
                // Sterling-style source indicator
                const sourceIndicator = source === 'polygon' ?
                    '<div style="font-size: 8px; color: #00cc00; text-align: center; padding: 1px; background: #001a00; letter-spacing: 1px;">LIVE TAPE</div>' :
                    '<div style="font-size: 8px; color: #ff9900; text-align: center; padding: 1px; background: #1a0d00; letter-spacing: 1px;">DELAYED</div>';

                html += sourceIndicator;

                // Find max size for large print detection
                const maxSize = Math.max(...trades.map(t => t.size || 0));
                let lastPrice = null;

                // Reverse so newest trades appear at top
                trades.reverse().forEach(trade => {
                    const time = trade.time || '--:--:--';
                    const price = parseFloat(trade.price);
                    const size = trade.size || 0;

                    // Determine uptick/downtick based on price movement
                    let tickClass = '';
                    let priceClass = '';
                    if (lastPrice !== null) {
                        if (price > lastPrice) {
                            tickClass = 'uptick';
                            priceClass = 'up';
                        } else if (price < lastPrice) {
                            tickClass = 'downtick';
                            priceClass = 'down';
                        }
                    }
                    lastPrice = price;

                    // Large print detection (>50% of max or >1000 shares)
                    const isLarge = size > maxSize * 0.5 || size >= 1000;
                    if (isLarge) tickClass += ' large-print';
                    const sizeClass = isLarge ? 'timesales-size large' : 'timesales-size';

                    html += `
                        <div class="timesales-row ${tickClass}">
                            <div class="timesales-time">${time}</div>
                            <div class="timesales-price ${priceClass}">${price.toFixed(2)}</div>
                            <div class="${sizeClass}">${size >= 1000 ? (size/1000).toFixed(1)+'K' : size}</div>
                        </div>
                    `;
                });

                displayEl.innerHTML = html;
            } catch (error) {
                console.error('Error loading time & sales:', error);
            }
        }

        // Scalp Assistant state
        let scalpAssistantRunning = false;
        let scalpMonitoredSymbols = new Set();

        async function loadScalpStatus() {
            try {
                const resp = await fetch(API_BASE_URL + '/api/scalp/status');
                if (resp.ok) {
                    const data = await resp.json();
                    scalpAssistantRunning = data.running;
                    scalpMonitoredSymbols = new Set(data.monitored_positions?.map(p => p.symbol) || []);

                    // Update UI
                    const statusEl = document.getElementById('scalpAssistantStatus');
                    const btnEl = document.getElementById('scalpToggleBtn');
                    if (statusEl) {
                        if (scalpAssistantRunning) {
                            statusEl.textContent = `AI: ON (${scalpMonitoredSymbols.size} monitored)`;
                            statusEl.style.color = '#22c55e';
                        } else {
                            statusEl.textContent = 'AI: OFF';
                            statusEl.style.color = '#ef4444';
                        }
                    }
                    if (btnEl) {
                        btnEl.textContent = scalpAssistantRunning ? 'Stop AI Monitor' : 'Start AI Monitor';
                        btnEl.style.background = scalpAssistantRunning ? '#7f1d1d' : '#1a472a';
                        btnEl.style.borderColor = scalpAssistantRunning ? '#ef4444' : '#22c55e';
                    }
                }
            } catch (e) {
                console.log('Scalp status not available');
            }
        }

        async function toggleScalpAssistant() {
            try {
                const endpoint = scalpAssistantRunning ? '/api/scalp/stop' : '/api/scalp/start';
                const resp = await fetch(API_BASE_URL + endpoint, { method: 'POST' });
                if (resp.ok) {
                    await loadScalpStatus();
                    await loadScalpMonitorDetails();
                }
            } catch (e) {
                console.error('Error toggling scalp assistant:', e);
            }
        }

        async function toggleAiTakeover(symbol, checkbox) {
            try {
                const endpoint = checkbox.checked ? `/api/scalp/takeover/${symbol}` : `/api/scalp/release/${symbol}`;
                const resp = await fetch(API_BASE_URL + endpoint, { method: 'POST' });
                if (resp.ok) {
                    const data = await resp.json();
                    if (data.success) {
                        await loadScalpStatus();
                        await loadScalpMonitorDetails();
                        console.log(`AI takeover ${checkbox.checked ? 'enabled' : 'disabled'} for ${symbol}`);
                    }
                } else {
                    checkbox.checked = !checkbox.checked; // Revert
                    console.error('Failed to toggle AI takeover');
                }
            } catch (e) {
                checkbox.checked = !checkbox.checked; // Revert
                console.error('Error toggling AI takeover:', e);
            }
        }

        async function loadScalpMonitorDetails() {
            try {
                const resp = await fetch(API_BASE_URL + '/api/scalp/status');
                if (!resp.ok) return;

                const data = await resp.json();

                // Update status
                const statusEl = document.getElementById('scalpMonitorStatus');
                const toggleBtn = document.getElementById('scalpMonitorToggle');
                if (statusEl) {
                    statusEl.textContent = data.running ? 'ONLINE' : 'OFFLINE';
                    statusEl.style.color = data.running ? '#22c55e' : '#ef4444';
                }
                if (toggleBtn) {
                    toggleBtn.textContent = data.running ? 'Stop' : 'Start';
                }

                // Update stats
                const monitored = data.monitored_positions?.length || 0;
                const exits = data.stats?.total_exits || 0;
                const winRate = data.win_rate || 0;
                const totalPnl = data.stats?.total_pnl || 0;

                safeUpdate('scalpMonitored', monitored);
                safeUpdate('scalpExits', exits);
                safeUpdate('scalpWinRate', winRate.toFixed(0) + '%');

                const pnlEl = document.getElementById('scalpTotalPnl');
                if (pnlEl) {
                    pnlEl.textContent = '$' + totalPnl.toFixed(2);
                    pnlEl.style.color = totalPnl >= 0 ? '#22c55e' : '#ef4444';
                }

                // Update config display
                if (data.config) {
                    safeUpdate('scalpStopLoss', '-' + data.config.stop_loss_pct + '%');
                    safeUpdate('scalpTarget', '+' + data.config.profit_target_pct + '%');
                    safeUpdate('scalpTrailing', data.config.trailing_stop_pct + '%');
                    safeUpdate('scalpMaxHold', data.config.max_hold_seconds + 's');

                    // Update paper mode checkbox
                    const paperCheck = document.getElementById('scalpPaperMode');
                    const paperLabel = document.getElementById('scalpPaperLabel');
                    if (paperCheck) paperCheck.checked = data.config.paper_mode;
                    if (paperLabel) {
                        paperLabel.textContent = data.config.paper_mode ? 'ON (safe)' : 'OFF (LIVE!)';
                        paperLabel.style.color = data.config.paper_mode ? '#22c55e' : '#ef4444';
                    }
                }

                // Update monitored positions list
                const listEl = document.getElementById('scalpPositionsList');
                if (listEl && data.monitored_positions) {
                    if (data.monitored_positions.length === 0) {
                        listEl.innerHTML = '<div class="empty-state" style="padding: 12px; font-size: 11px;">No positions monitored</div>';
                    } else {
                        let html = '';
                        data.monitored_positions.forEach(pos => {
                            const pnlColor = pos.pnl >= 0 ? '#22c55e' : '#ef4444';
                            const trailStatus = pos.trailing_active ? '<span style="color: #f59e0b;">TRAILING</span>' : '';
                            html += `
                                <div style="display: flex; justify-content: space-between; padding: 4px 0; border-bottom: 1px solid #333;">
                                    <div>
                                        <strong style="color: #fff;">${pos.symbol}</strong>
                                        <span style="color: #666; margin-left: 6px;">x${pos.quantity}</span>
                                        ${trailStatus}
                                    </div>
                                    <div style="text-align: right;">
                                        <span style="color: ${pnlColor};">$${pos.pnl.toFixed(2)} (${pos.pnl_pct >= 0 ? '+' : ''}${pos.pnl_pct.toFixed(1)}%)</span>
                                        <span style="color: #666; margin-left: 6px;">${Math.floor(pos.hold_seconds)}s</span>
                                    </div>
                                </div>
                            `;
                        });
                        listEl.innerHTML = html;
                    }
                }
            } catch (e) {
                console.log('Error loading scalp monitor details:', e);
            }
        }

        async function toggleScalpPaperMode(enabled) {
            try {
                const resp = await fetch(API_BASE_URL + `/api/scalp/paper/${enabled}`, { method: 'POST' });
                if (resp.ok) {
                    await loadScalpMonitorDetails();
                    console.log(`Paper mode ${enabled ? 'enabled' : 'DISABLED - LIVE TRADING'}`);
                }
            } catch (e) {
                console.error('Error toggling paper mode:', e);
            }
        }

        async function loadPositions() {
            try {
                const displayEl = document.getElementById('positionsDisplay');
                if (!displayEl) return;

                // Load scalp status in parallel
                loadScalpStatus();

                // Fetch ONLY from API (broker-aware endpoint)
                const apiData = await apiFetch('/api/account');
                if (!apiData || !apiData.positions) {
                    displayEl.innerHTML = '<tr><td colspan="9" class="empty-state">No broker connected</td></tr>';
                    return;
                }

                const positions = apiData.positions;

                if (positions.length > 0) {
                    let html = '';
                    positions.forEach(pos => {
                        const pnl = pos.unrealized_pnl || 0;
                        const pnlPct = pos.avg_cost ? ((pnl / (pos.avg_cost * Math.abs(pos.quantity))) * 100).toFixed(2) : 0;
                        const pnlClass = pnl >= 0 ? 'positive' : 'negative';
                        const side = pos.quantity > 0 ? 'LONG' : 'SHORT';
                        const sideClass = pos.quantity > 0 ? 'long' : 'short';
                        const isAiMonitored = scalpMonitoredSymbols.has(pos.symbol);

                        html += `
                            <tr class="clickable" onclick="setCurrentSymbol('${pos.symbol}')">
                                <td style="text-align: center;">
                                    <input type="checkbox"
                                           ${isAiMonitored ? 'checked' : ''}
                                           onclick="toggleAiTakeover('${pos.symbol}', this); event.stopPropagation();"
                                           title="Enable AI auto-exit"
                                           style="cursor: pointer; width: 16px; height: 16px;">
                                </td>
                                <td><strong>${pos.symbol}</strong></td>
                                <td><span class="pos-badge ${sideClass}">${side}</span></td>
                                <td>${Math.abs(pos.quantity)}</td>
                                <td>$${pos.avg_cost?.toFixed(2) || '0.00'}</td>
                                <td>$${((pos.market_value || 0) / Math.abs(pos.quantity)).toFixed(2)}</td>
                                <td class="${pnlClass}">$${pnl.toFixed(2)}</td>
                                <td class="${pnlClass}">${pnlPct}%</td>
                                <td><button class="action-btn" onclick="closePosition('${pos.symbol}', ${pos.quantity}); event.stopPropagation();">Close</button></td>
                            </tr>
                        `;
                    });
                    displayEl.innerHTML = html;
                    positionsCache = positions;
                } else {
                    displayEl.innerHTML = '<tr><td colspan="9" class="empty-state">No open positions</td></tr>';
                }
            } catch (error) {
                console.error('Error loading positions:', error);
            }
        }

        // Current orders tab state
        let currentOrdersTab = 'working';
        let ordersCache = { working: [], open: [], filled: [], closed: [] };

        // Switch orders tab
        function switchOrdersTab(tab) {
            currentOrdersTab = tab;

            // Update tab button styles
            ['working', 'open', 'filled', 'closed'].forEach(t => {
                const btn = document.getElementById('ordersTab' + t.charAt(0).toUpperCase() + t.slice(1));
                if (btn) {
                    if (t === tab) {
                        btn.style.background = '#2d2d2d';
                        btn.style.color = '#fff';
                    } else {
                        btn.style.background = '#1a1a1a';
                        btn.style.color = '#888';
                    }
                }
            });

            // Load orders for selected tab
            loadOrders();
        }

        async function loadOrders() {
            const displayEl = document.getElementById('ordersDisplay');
            if (!displayEl) return;

            try {
                // Check which broker is active and determine endpoint
                let endpoint;
                let statusFilter = null;

                if (activeBroker === 'schwab') {
                    // Schwab orders endpoint
                    endpoint = '/api/schwab/orders';

                    // For Schwab, we'll filter client-side
                    switch(currentOrdersTab) {
                        case 'working':
                        case 'open':
                            statusFilter = ['WORKING', 'PENDING_ACTIVATION', 'QUEUED', 'ACCEPTED'];
                            break;
                        case 'filled':
                            statusFilter = ['FILLED'];
                            break;
                        case 'closed':
                            statusFilter = ['CANCELED', 'EXPIRED', 'REJECTED', 'REPLACED'];
                            break;
                    }
                } else {
                    // Alpaca orders endpoint
                    switch(currentOrdersTab) {
                        case 'working':
                            endpoint = '/api/schwab/orders?status=open&limit=50';
                            statusFilter = ['new', 'accepted', 'pending_new', 'partially_filled'];
                            break;
                        case 'open':
                            endpoint = '/api/schwab/orders?status=open&limit=50';
                            statusFilter = ['new', 'accepted', 'pending_new'];
                            break;
                        case 'filled':
                            endpoint = '/api/schwab/orders?status=closed&limit=50';
                            statusFilter = ['filled'];
                            break;
                        case 'closed':
                            endpoint = '/api/schwab/orders?status=closed&limit=50';
                            statusFilter = ['canceled', 'expired', 'rejected', 'replaced'];
                            break;
                    }
                }

                const response = await fetch(API_BASE_URL + endpoint);
                const data = await response.json();

                let orders = data.orders || [];

                // Cache orders for optimistic updates
                if (endpoint.includes('status=open') || activeBroker === 'schwab') {
                    ordersCache.open = orders;
                } else {
                    ordersCache.closed = orders;
                }

                // Filter by specific status
                if (statusFilter) {
                    orders = orders.filter(o => statusFilter.includes(o.status?.toUpperCase()) || statusFilter.includes(o.status?.toLowerCase()));
                }

                renderOrdersTable(orders, displayEl);
            } catch (error) {
                console.error('Error loading orders:', error);
                displayEl.innerHTML = '<tr><td colspan="8" class="empty-state" style="color: #ef4444;">‚ùå Error loading orders</td></tr>';
            }
        }

        function renderOrdersTable(orders, displayEl) {
            if (orders.length > 0) {
                let html = '';
                orders.forEach(order => {
                    // Handle price - Schwab uses 'price', Alpaca uses 'limit_price'
                    const limitPrice = order.limit_price || order.price;
                    const stopPrice = order.stop_price || order.stopPrice;
                    let priceDisplay = 'MKT';
                    if (limitPrice && parseFloat(limitPrice) > 0) {
                        priceDisplay = `$${parseFloat(limitPrice).toFixed(2)}`;
                    } else if (stopPrice && parseFloat(stopPrice) > 0) {
                        priceDisplay = `STOP $${parseFloat(stopPrice).toFixed(2)}`;
                    }

                    const filledQty = order.filled_qty || order.filledQuantity || 0;
                    const orderQty = order.quantity || order.qty;
                    const qtyDisplay = filledQty > 0 ? `${filledQty}/${orderQty}` : orderQty;
                    const statusClass = order.status?.toLowerCase() === 'filled' ? 'positive' :
                                      order.status?.toLowerCase() === 'canceled' ? 'negative' : '';

                    // Get timestamp - Schwab uses 'entered_time', Alpaca uses 'submitted_at'
                    const orderTime = order.entered_time || order.enteredTime || order.submitted_at || order.created_at;
                    const timeDisplay = orderTime ? new Date(orderTime).toLocaleTimeString() : '--:--';

                    html += `
                        <tr data-order-id="${order.order_id || order.id}">
                            <td style="font-size: 11px;">${timeDisplay}</td>
                            <td><strong onclick="selectSymbol('${order.symbol}')" style="cursor: pointer; color: #00c9ff;">${order.symbol}</strong></td>
                            <td class="${order.action === 'BUY' || order.side === 'buy' ? 'positive' : 'negative'}">${order.action || order.side?.toUpperCase()}</td>
                            <td>${qtyDisplay}</td>
                            <td>${order.order_type || order.type}</td>
                            <td>${priceDisplay}</td>
                            <td class="${statusClass}">${order.status}</td>
                            <td>
                                ${['new', 'accepted', 'pending_new', 'partially_filled'].includes(order.status?.toLowerCase()) ?
                                    `<button class="action-btn" onclick="cancelOrderAlpaca('${order.order_id || order.id}')">Cancel</button>` :
                                    '<span style="color: #666;">-</span>'}
                            </td>
                        </tr>
                    `;
                });
                displayEl.innerHTML = html;
            } else {
                const tabName = currentOrdersTab.charAt(0).toUpperCase() + currentOrdersTab.slice(1);
                displayEl.innerHTML = `<tr><td colspan="8" class="empty-state">No ${tabName.toLowerCase()} orders</td></tr>`;
            }
        }

        async function cancelOrderAlpaca(orderId) {
            // INSTANT: Remove from UI immediately (optimistic update)
            const row = document.querySelector(`tr[data-order-id="${orderId}"]`);
            if (row) {
                row.style.opacity = '0.3';
                row.style.textDecoration = 'line-through';
            }

            // Remove from cache immediately
            ordersCache.open = ordersCache.open.filter(o => (o.order_id || o.id) !== orderId);

            // Show instant feedback
            showNotification('Cancelling order...', 'info');

            // Remove row from DOM after brief fade (don't wait for API)
            setTimeout(() => {
                if (row) row.remove();
            }, 200);

            // Determine cancel endpoint based on active broker
            const cancelEndpoint = activeBroker === 'schwab'
                ? `/api/schwab/orders/${orderId}`
                : `/api/schwab/orders/${orderId}`;

            // Fire API call in background
            fetch(API_BASE_URL + cancelEndpoint, { method: 'DELETE' })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showNotification('Order cancelled', 'success');
                        console.log(`‚úì Order ${orderId} cancelled`);
                    } else {
                        showNotification(`Cancel failed: ${data.detail || 'Error'}`, 'error');
                        loadOrders(); // Reload to restore if failed
                    }
                })
                .catch(error => {
                    console.error('Error cancelling order:', error);
                    showNotification('Cancel request failed', 'error');
                    loadOrders(); // Reload to restore if failed
                });
        }

        async function loadAccount() {
            try {
                // Fetch ONLY from API
                const accountData = await apiFetch('/api/account');
                if (!accountData || !accountData.summary) {
                    safeUpdate('accountNumber', '--');
                    safeUpdate('accountType', '--');
                    safeUpdate('equityValue', '--');
                    safeUpdate('buyingPower', '--');
                    safeUpdate('cashBalance', '--');
                    safeUpdate('marginUsed', '--');
                    safeUpdate('dayPL', '--');
                    safeUpdate('totalPL', '--');
                    safeUpdate('positionCount', '0');
                    return;
                }

                if (accountData.summary) {
                    const s = accountData.summary;

                    // Update account number and type
                    safeUpdate('accountNumber', s.account_id || 'DU1234567');
                    safeUpdate('accountType', s.account_type || 'Unknown');

                    // Update financial values
                    safeUpdate('equityValue', `$${(s.net_liquidation || 0).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`);
                    safeUpdate('buyingPower', `$${(s.buying_power || 0).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`);
                    safeUpdate('cashBalance', `$${(s.total_cash || 0).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`);
                    safeUpdate('marginUsed', `$${((s.net_liquidation - s.total_cash) || 0).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`);

                    // Fetch REAL daily P/L from Alpaca (equity - last_equity)
                    try {
                        const alpacaAcct = await apiFetch('/api/schwab/account');
                        const dayPL = alpacaAcct?.daily_pnl || (parseFloat(alpacaAcct?.equity || 0) - parseFloat(alpacaAcct?.last_equity || 0));
                        const dayPLEl = document.getElementById('dayPL');
                        if (dayPLEl) {
                            dayPLEl.textContent = `$${dayPL.toFixed(2)}`;
                            dayPLEl.className = dayPL >= 0 ? 'account-stat-value positive' : 'account-stat-value negative';
                        }
                    } catch (e) {
                        console.log('Day P/L fetch error:', e);
                    }

                    const totalPL = accountData.total_realized_pnl || 0;
                    const totalPLEl = document.getElementById('totalPL');
                    if (totalPLEl) {
                        totalPLEl.textContent = `$${totalPL.toFixed(2)}`;
                        totalPLEl.className = totalPL >= 0 ? 'account-stat-value positive' : 'account-stat-value negative';
                    }

                    safeUpdate('positionCount', accountData.positions?.length || 0);

                    // Handle day trades info for ALL accounts (PDT and non-PDT)
                    const dayTradesStat = document.getElementById('dayTradesStat');
                    const dayTradesInfo = document.getElementById('dayTradesInfo');
                    const accountWarnings = document.getElementById('accountWarnings');

                    // Always show day trades for Schwab accounts or PDT accounts
                    const showDayTrades = accountData.broker === 'schwab' || s.is_pdt;
                    const dayTradesRemaining = s.day_trades_remaining ?? (4 - (s.round_trips || 0));

                    if (showDayTrades && dayTradesRemaining !== null && dayTradesRemaining !== undefined) {
                        if (dayTradesStat) dayTradesStat.style.display = 'block';
                        safeUpdate('dayTradesRemaining', `${dayTradesRemaining}/4`);

                        if (dayTradesInfo) {
                            dayTradesInfo.style.display = 'block';
                            if (s.is_pdt) {
                                dayTradesInfo.innerHTML = `Pattern Day Trader Account: ${dayTradesRemaining} day trades remaining`;
                            } else {
                                dayTradesInfo.innerHTML = `Day Trades Used: ${s.round_trips || 0}/4 (${dayTradesRemaining} remaining before PDT)`;
                            }
                        }

                        // Show warning if running low
                        if (dayTradesRemaining <= 1 && accountWarnings) {
                            accountWarnings.style.display = 'block';
                            accountWarnings.style.background = '#7f1d1d';
                            accountWarnings.style.color = '#fca5a5';
                            accountWarnings.innerHTML = dayTradesRemaining === 0
                                ? '‚ö†Ô∏è DAY TRADE LIMIT REACHED - 1 more trade triggers PDT!'
                                : '‚ö†Ô∏è WARNING - Only 1 day trade remaining before PDT flag!';
                        } else if (accountWarnings) {
                            accountWarnings.style.display = 'none';
                        }
                    } else {
                        if (dayTradesStat) dayTradesStat.style.display = 'none';
                        if (dayTradesInfo) dayTradesInfo.style.display = 'none';
                    }

                    // Show account capability warnings
                    if (s.account_capabilities && accountWarnings) {
                        const caps = s.account_capabilities;
                        if (caps.includes('NO_SHORT_SELLING')) {
                            accountWarnings.style.display = 'block';
                            accountWarnings.style.background = '#1e3a8a';
                            accountWarnings.style.color = '#93c5fd';
                            accountWarnings.innerHTML = '‚ö†Ô∏è SHORT SELLING DISABLED for this account type';
                        }
                        if (caps.includes('T+2_SETTLEMENT')) {
                            if (dayTradesInfo) {
                                dayTradesInfo.style.display = 'block';
                                dayTradesInfo.innerHTML = 'Cash Account: T+2 settlement applies - avoid good faith violations';
                            }
                        }
                    }
                }
            } catch (error) {
                console.error('Error loading account:', error);
            }
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        //                     TRADING FUNCTIONS
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        function setQuantity(qty) {
            document.getElementById('orderQuantity').value = qty;
            calculateOrderCost();
        }

        window.setOrderPrice = function(priceType) {
            console.log('setOrderPrice called with:', priceType);

            const symbolEl = document.getElementById('orderSymbol');
            const priceEl = document.getElementById('orderPrice');
            const orderTypeEl = document.getElementById('orderType');

            if (!symbolEl || !priceEl || !orderTypeEl) {
                console.error('Order form elements not found');
                return;
            }

            const symbol = symbolEl.value;
            console.log('Current symbol:', symbol);

            if (!symbol || symbol.trim() === '') {
                alert('Please enter a symbol first');
                return;
            }

            // Get price from market data cache
            const marketData = marketDataCache[symbol];
            console.log('Market data for', symbol, ':', marketData);

            if (!marketData) {
                alert('No market data available for ' + symbol + '\n\nPlease wait for data to load.');
                return;
            }

            let price;
            if (priceType === 'bid') {
                price = marketData.bid;
            } else if (priceType === 'ask') {
                price = marketData.ask;
            } else if (priceType === 'last') {
                price = marketData.last;
            }

            console.log('Selected price:', price);

            if (!price || price <= 0) {
                alert(priceType.toUpperCase() + ' price not available for ' + symbol);
                return;
            }

            // Set order type to LIMIT
            orderTypeEl.value = 'LIMIT';

            // Set the price
            priceEl.value = price.toFixed(2);

            console.log('Price set to:', priceEl.value);

            // Update calculator
            calculateOrderCost();
        }

        function setAccountPercent(percent) {
            const symbol = document.getElementById('orderSymbol').value;
            const priceEl = document.getElementById('orderPrice');

            // Get account equity value
            let accountEquity = 100000; // Default value
            if (accountData && accountData.summary && accountData.summary.net_liquidation) {
                accountEquity = accountData.summary.net_liquidation;
            }

            // Get current price (try limit price first, then market data)
            let currentPrice = parseFloat(priceEl.value) || 0;

            // If no price in order form, try to get from market data cache
            if (currentPrice === 0 || priceEl.value === 'MARKET') {
                const data = marketDataCache[symbol];
                if (data && data.last) {
                    currentPrice = data.last;
                } else if (data && data.bid && data.ask) {
                    currentPrice = (data.bid + data.ask) / 2;
                }
            }

            if (currentPrice > 0) {
                // Calculate dollar amount based on percentage
                const dollarAmount = accountEquity * (percent / 100);

                // Calculate quantity (round down to whole shares)
                const quantity = Math.floor(dollarAmount / currentPrice);

                // Set the quantity
                document.getElementById('orderQuantity').value = quantity;

                // Update cost calculator
                calculateOrderCost();

                // Show confirmation
                console.log(`Account: $${accountEquity.toFixed(2)}, ${percent}% = $${dollarAmount.toFixed(2)}, Price: $${currentPrice.toFixed(2)}, Qty: ${quantity}`);
            } else {
                alert('Cannot calculate quantity: No price available for ' + symbol);
            }
        }

        function adjustPrice(amount) {
            const priceEl = document.getElementById('orderPrice');
            const currentPrice = parseFloat(priceEl.value) || 0;
            priceEl.value = (currentPrice + amount).toFixed(2);
        }

        function setOrderPrice(price, side) {
            document.getElementById('orderPrice').value = price.toFixed(2);
            // Optionally auto-focus quantity or submit
        }

        function handleOrderTypeChange() {
            const type = document.getElementById('orderType').value;
            const priceField = document.getElementById('orderPrice');

            if (type === 'MARKET') {
                priceField.disabled = true;
                priceField.value = 'MARKET';
            } else {
                priceField.disabled = false;
                if (priceField.value === 'MARKET' || priceField.value === '') {
                    const data = marketDataCache[currentSymbol];
                    if (data && data.bid && data.ask) {
                        priceField.value = ((data.bid + data.ask) / 2).toFixed(2);
                    } else {
                        // Clear field if no market data available
                        priceField.value = '';
                        priceField.placeholder = 'Enter limit price';
                    }
                }
            }
        }

        // Order Cost Calculator
        function calculateOrderCost() {
            try {
                const shares = parseInt(document.getElementById('orderQuantity')?.value) || 0;
                const price = parseFloat(document.getElementById('orderPrice')?.value) || 0;

                // Update shares display
                document.getElementById('calcShares').textContent = shares.toLocaleString();

                // Update price display
                document.getElementById('calcPrice').textContent = `$${price.toFixed(2)}`;

                // Calculate total cost (shares * price + commission)
                let cost = shares * price;
                const commission = Math.max(1, 0.005 * shares); // Min $1 or $0.005 per share
                cost += commission;

                // Update total display
                document.getElementById('calcTotal').textContent = `$${cost.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;

                return cost;
            } catch (error) {
                console.error('Error calculating order cost:', error);
                return 0;
            }
        }

        async function submitOrder(action) {
            const symbol = document.getElementById('orderSymbol').value;
            const quantity = document.getElementById('orderQuantity').value;
            const type = document.getElementById('orderType').value;
            const price = document.getElementById('orderPrice').value;
            const tif = document.getElementById('orderTIF').value;
            const extendedHours = document.getElementById('extendedHours').checked;
            const autoSubmit = document.getElementById('autoSubmitOrders').checked;

            // Validation - suppress alerts if auto-submit is enabled
            if (!symbol || symbol.trim() === '') {
                if (!autoSubmit) alert('Please enter a symbol');
                console.error('Validation error: No symbol entered');
                return;
            }

            if (!quantity || parseInt(quantity) <= 0) {
                if (!autoSubmit) alert('Please enter a valid quantity');
                console.error('Validation error: Invalid quantity');
                return;
            }

            let side, orderType;

            if (action === 'BUY_MARKET') {
                side = 'BUY';
                orderType = 'MARKET';
            } else if (action === 'SELL_MARKET') {
                side = 'SELL';
                orderType = 'MARKET';
            } else {
                side = action;
                orderType = type;
            }

            // Validate price for limit orders
            if (orderType === 'LIMIT' && (!price || isNaN(parseFloat(price)) || parseFloat(price) <= 0)) {
                if (!autoSubmit) alert('Please enter a valid limit price (not MARKET)');
                console.error('Validation error: Invalid limit price');
                return;
            }

            const orderDetails = `
ORDER DETAILS:
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
Side:     ${side}
Symbol:   ${symbol}
Quantity: ${quantity}
Type:     ${orderType}
Price:    ${orderType === 'MARKET' ? 'MARKET' : '$' + price}
TIF:      ${tif}
Extended: ${extendedHours ? 'YES (Pre/After Market)' : 'NO (Regular Hours)'}

Confirm order?`;

            // Check auto-submit setting - skip confirmation if enabled
            if (autoSubmit || window.confirm(orderDetails)) {
                try {
                    // Prepare order request
                    const orderRequest = {
                        symbol: symbol.trim().toUpperCase(),
                        action: side,
                        quantity: parseInt(quantity),
                        order_type: orderType,
                        limit_price: orderType !== 'MARKET' ? parseFloat(price) : null,
                        stop_price: null, // Add stop price support if needed
                        tif: tif,
                        extended_hours: extendedHours,
                        exchange: 'SMART'
                    };

                    // Route order to selected broker (Alpaca or Schwab)
                    const orderEndpoint = activeBroker === 'schwab'
                        ? '/api/schwab/place-order'
                        : '/api/schwab/place-order';

                    // Get selected Schwab account if applicable
                    const schwabAccountEl = document.getElementById('schwabAccountSelect');
                    const schwabAccount = schwabAccountEl ? schwabAccountEl.value : 'N/A';
                    const brokerDisplay = activeBroker === 'schwab' ? `Schwab (${schwabAccount})` : 'Alpaca';

                    console.log('='.repeat(50));
                    console.log(`[ORDER] Broker: ${brokerDisplay}`);
                    console.log(`[ORDER] Endpoint: ${orderEndpoint}`);
                    console.log(`[ORDER] Request:`, orderRequest);
                    console.log('='.repeat(50));

                    // Call API to place order
                    const response = await fetch(API_BASE_URL + orderEndpoint, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(orderRequest)
                    });

                    const data = await response.json();

                    if (response.ok && data.success) {
                        // Include broker and account in confirmation
                        const brokerInfo = data.broker || activeBroker;
                        const accountInfo = data.account || schwabAccount;

                        // Show alert only if auto-submit is disabled (for faster trading)
                        if (!autoSubmit) {
                            alert(`‚úì Order placed successfully!\n\nBroker: ${brokerInfo.toUpperCase()}${brokerInfo === 'schwab' ? ` (${accountInfo})` : ''}\nOrder ID: ${data.order_id}\nStatus: ${data.status}\n\n${data.message}`);
                        } else {
                            console.log(`‚úì [${brokerInfo.toUpperCase()}] Order ${data.order_id}: ${side} ${quantity} ${symbol} @ ${orderType === 'MARKET' ? 'MARKET' : '$' + price}`);
                        }

                        // Clear form (but keep symbol for momentum trading)
                        // document.getElementById('orderSymbol').value = ''; // KEEP SYMBOL
                        document.getElementById('orderQuantity').value = '';
                        // Update price to current market price for next order
                        const cachedData = marketDataCache[symbol];
                        if (cachedData && cachedData.bid && cachedData.ask) {
                            document.getElementById('orderPrice').value = ((cachedData.bid + cachedData.ask) / 2).toFixed(2);
                        }

                        // Refresh orders display
                        await loadOrders();
                        await loadAccount();
                    } else {
                        // Handle error response
                        const errorMsg = data.detail || data.message || 'Unknown error';
                        if (!autoSubmit) {
                            alert(`‚úó Failed to place order\n\n${errorMsg}`);
                        } else {
                            console.error('‚úó Order failed:', errorMsg);
                        }
                    }
                } catch (error) {
                    console.error('Order error:', error);
                    const brokerName = activeBroker === 'schwab' ? 'Schwab' : 'Alpaca';
                    if (!autoSubmit) {
                        alert(`‚úó Failed to place order\n\nError: ${error.message}\n\nMake sure ${brokerName} is connected.`);
                    } else {
                        console.error('‚úó Order failed:', error.message);
                    }
                }
            }
        }

        async function submitOrderAtPrice(side, priceType, event) {
            // Visual feedback - flash the button
            const btn = event?.target;
            if (btn) {
                btn.style.opacity = '0.5';
                btn.style.transform = 'scale(0.95)';
                setTimeout(() => {
                    btn.style.opacity = '1';
                    btn.style.transform = 'scale(1)';
                }, 150);
            }

            const symbol = document.getElementById('orderSymbol').value;
            const quantity = document.getElementById('orderQuantity').value;
            const autoSubmit = document.getElementById('autoSubmitOrders')?.checked || false;

            // Validation - suppress alerts if auto-submit is enabled
            if (!symbol || symbol.trim() === '') {
                showNotification('Please enter a symbol', 'error');
                console.error('Validation error: No symbol entered');
                return;
            }

            if (!quantity || parseInt(quantity) <= 0) {
                showNotification('Please enter a valid quantity', 'error');
                console.error('Validation error: Invalid quantity');
                return;
            }

            // Get price from market data cache
            const marketData = marketDataCache[symbol];
            if (!marketData) {
                showNotification('No market data for ' + symbol + ' - wait for data', 'warning');
                console.error('Validation error: No market data for', symbol);
                return;
            }

            let price;
            if (priceType === 'BID') {
                price = marketData.bid;
                if (!price || price <= 0) {
                    showNotification('Bid price not available', 'warning');
                    console.error('Validation error: Bid price not available');
                    return;
                }
            } else if (priceType === 'ASK') {
                price = marketData.ask;
                if (!price || price <= 0) {
                    showNotification('Ask price not available', 'warning');
                    console.error('Validation error: Ask price not available');
                    return;
                }
            }

            // Show immediate feedback
            showNotification(`${side} ${quantity} ${symbol} @ $${price.toFixed(2)} (${priceType})...`, 'info');

            // Set order type to LIMIT and fill in the price
            document.getElementById('orderType').value = 'LIMIT';
            document.getElementById('orderPrice').value = price.toFixed(2);

            // Submit the order using the regular submitOrder function
            await submitOrder(side);
        }

        async function closePosition(symbol, quantity) {
            const side = quantity > 0 ? 'SELL' : 'BUY';
            const qty = Math.abs(quantity);

            if (window.confirm(`Close position in ${symbol}?\n\n${side} ${qty} shares at MARKET`)) {
                try {
                    console.log('Closing position:', symbol, side, qty);

                    // Prepare market order to close position
                    const orderRequest = {
                        symbol: symbol,
                        action: side,
                        quantity: qty,
                        order_type: 'MARKET',
                        limit_price: null,
                        stop_price: null,
                        tif: 'DAY',
                        extended_hours: false,
                        exchange: 'SMART'
                    };

                    // Submit order to Alpaca
                    const response = await fetch(API_BASE_URL + '/api/schwab/place-order', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(orderRequest)
                    });

                    const data = await response.json();

                    if (response.ok && data.success) {
                        alert(`‚úì Position close order placed!\n\nOrder ID: ${data.order_id}\n${side} ${qty} ${symbol} @ MARKET`);
                        console.log(`‚úì Close order ${data.order_id} placed: ${side} ${qty} ${symbol}`);

                        // Refresh positions and orders
                        await loadPositions();
                        await loadOrders();
                        await loadAccount();
                    } else {
                        const errorMsg = data.detail || data.message || 'Unknown error';
                        alert(`‚úó Failed to close position\n\n${errorMsg}`);
                    }
                } catch (error) {
                    console.error('Close position error:', error);
                    alert(`‚úó Failed to close position\n\nError: ${error.message}\n\nMake sure broker is connected.`);
                }
            }
        }

        async function cancelOrder(orderId) {
            if (window.confirm('Cancel this order?')) {
                try {
                    console.log('Cancelling order:', orderId);

                    const response = await fetch(API_BASE_URL + '/api/schwab/cancel-order', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ order_id: orderId })
                    });

                    const data = await response.json();

                    if (response.ok && data.success) {
                        alert(`‚úì Order cancelled!\n\nOrder ID: ${orderId}\nStatus: ${data.status || 'Cancelled'}`);
                        console.log(`‚úì Order ${orderId} cancelled`);

                        // Refresh orders and account
                        await loadOrders();
                        await loadAccount();
                    } else {
                        const errorMsg = data.detail || data.message || 'Unknown error';
                        alert(`‚úó Failed to cancel order\n\n${errorMsg}`);
                    }
                } catch (error) {
                    console.error('Cancel order error:', error);
                    alert(`‚úó Failed to cancel order\n\nError: ${error.message}\n\nMake sure broker is connected.`);
                }
            }
        }

        async function cancelAllOrders() {
            const autoSubmit = document.getElementById('autoSubmitOrders')?.checked || false;

            // Cancellable order statuses
            const CANCELLABLE_STATUSES = ['WORKING', 'PENDING_ACTIVATION', 'QUEUED', 'ACCEPTED', 'PENDING', 'NEW', 'PENDING_NEW', 'PARTIALLY_FILLED'];

            try {
                // Fetch all current orders
                const response = await fetch(API_BASE_URL + '/api/schwab/orders');
                const data = await response.json();

                if (!data.orders || data.orders.length === 0) {
                    if (!autoSubmit) alert('No orders found');
                    console.log('No orders found');
                    return;
                }

                // Filter to only cancellable orders
                const cancellableOrders = data.orders.filter(order => {
                    const status = (order.status || '').toUpperCase();
                    return CANCELLABLE_STATUSES.includes(status);
                });

                if (cancellableOrders.length === 0) {
                    if (!autoSubmit) alert('No active orders to cancel.\n\nAll orders are already filled, cancelled, or rejected.');
                    console.log('No cancellable orders found');
                    return;
                }

                // Skip confirmation if auto-submit is enabled
                if (!autoSubmit && !window.confirm(`‚ö†Ô∏è CANCEL ${cancellableOrders.length} WORKING ORDERS?\n\nThis will cancel all active orders.\n\nAre you sure?`)) {
                    return;
                }

                console.log(`Cancelling ${cancellableOrders.length} active orders (skipping ${data.orders.length - cancellableOrders.length} non-cancellable)...`);
                let cancelled = 0;
                let failed = 0;

                // Cancel each cancellable order
                for (const order of cancellableOrders) {
                    try {
                        const cancelResponse = await fetch(API_BASE_URL + '/api/schwab/cancel-order', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ order_id: order.order_id })
                        });

                        const cancelData = await cancelResponse.json();

                        if (cancelResponse.ok && cancelData.success) {
                            cancelled++;
                            console.log(`‚úì Cancelled order ${order.order_id}`);
                        } else {
                            failed++;
                            console.error(`‚úó Failed to cancel order ${order.order_id}:`, cancelData.detail || cancelData.message);
                        }
                    } catch (error) {
                        failed++;
                        console.error(`‚úó Error cancelling order ${order.order_id}:`, error);
                    }
                }

                // Show results and refresh
                if (!autoSubmit) {
                    alert(`‚úì Cancel All Complete\n\nCancelled: ${cancelled}\nFailed: ${failed}`);
                } else {
                    console.log(`‚úì Cancel All Complete - Cancelled: ${cancelled}, Failed: ${failed}`);
                }
                await loadOrders();

            } catch (error) {
                console.error('Error cancelling all orders:', error);
                if (!autoSubmit) alert(`‚ùå Error: ${error.message}`);
            }
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        //                     WORKLIST MANAGEMENT (UNIFIED BACKEND)
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        let worklistData = [];
        let worklistLoading = false;  // Prevent duplicate calls
        let worklistLastLoad = 0;     // Debounce timestamp
        let worklistSortField = null;  // Current sort field
        let worklistSortAsc = true;    // Sort direction

        function sortWorklist(field) {
            // Toggle direction if same field, otherwise default to descending for numbers
            if (worklistSortField === field) {
                worklistSortAsc = !worklistSortAsc;
            } else {
                worklistSortField = field;
                // Default: descending for numbers (highest first), ascending for symbol
                worklistSortAsc = (field === 'symbol');
            }

            worklistData.sort((a, b) => {
                let valA = a[field];
                let valB = b[field];

                // Handle nulls/undefined
                if (valA === null || valA === undefined) valA = field === 'symbol' ? '' : -Infinity;
                if (valB === null || valB === undefined) valB = field === 'symbol' ? '' : -Infinity;

                // String comparison for symbol and text fields
                if (typeof valA === 'string' && typeof valB === 'string') {
                    return worklistSortAsc ? valA.localeCompare(valB) : valB.localeCompare(valA);
                }

                // Numeric comparison
                return worklistSortAsc ? valA - valB : valB - valA;
            });

            updateWorklistDisplay();
            showNotification(`Sorted by ${field} ${worklistSortAsc ? '‚Üë' : '‚Üì'}`, 'info');
        }

        async function loadWorklist() {
            // Debounce: skip if loaded within last 2 seconds or currently loading
            const now = Date.now();
            if (worklistLoading || (now - worklistLastLoad < 2000)) {
                console.log('[Worklist] Skipping duplicate call');
                return;
            }

            worklistLoading = true;
            worklistLastLoad = now;
            const startTime = performance.now();

            try {
                console.log('[Worklist] Fetching from API...');
                const response = await fetch(API_BASE_URL + '/api/worklist');
                const fetchTime = performance.now() - startTime;
                console.log(`[Worklist] Fetch completed in ${fetchTime.toFixed(0)}ms`);
                const data = await response.json();

                if (data.success && data.data) {
                    worklistData = data.data;

                    // UPDATE CENTRALIZED STORE for each symbol
                    worklistData.forEach(item => {
                        marketDataStore.update(item.symbol, {
                            last: item.price || item.current_price || 0,
                            bid: item.bid,
                            ask: item.ask,
                            volume: item.volume,
                            change: item.change,
                            change_percent: item.change_percent
                        });
                    });

                    // Preserve current sort order after refresh
                    if (worklistSortField) {
                        worklistData.sort((a, b) => {
                            let valA = a[worklistSortField];
                            let valB = b[worklistSortField];
                            if (valA === null || valA === undefined) valA = worklistSortField === 'symbol' ? '' : -Infinity;
                            if (valB === null || valB === undefined) valB = worklistSortField === 'symbol' ? '' : -Infinity;
                            if (typeof valA === 'string' && typeof valB === 'string') {
                                return worklistSortAsc ? valA.localeCompare(valB) : valB.localeCompare(valA);
                            }
                            return worklistSortAsc ? valA - valB : valB - valA;
                        });
                    }

                    updateWorklistDisplay();
                    updateWorklistStats();
                }
            } catch (error) {
                console.error('Failed to load worklist:', error);
            } finally {
                worklistLoading = false;
            }
        }

        // Asset status cache to avoid repeated API calls
        const assetStatusCache = {};

        async function loadAssetStatus() {
            if (!currentSymbol) return;

            try {
                // Check cache first (5 minute expiry)
                const cached = assetStatusCache[currentSymbol];
                if (cached && (Date.now() - cached.timestamp < 300000)) {
                    updateAssetStatusDisplay(cached.data);
                    return;
                }

                const response = await fetch(`${API_BASE_URL}/api/schwab/asset/${currentSymbol}/status`);
                const data = await response.json();

                if (data.success) {
                    // Cache the result
                    assetStatusCache[currentSymbol] = {
                        data: data,
                        timestamp: Date.now()
                    };
                    updateAssetStatusDisplay(data);
                }
            } catch (error) {
                console.error('Failed to load asset status:', error);
            }
        }

        function updateAssetStatusDisplay(data) {
            const shortableEl = document.getElementById('shortableIndicator');
            const borrowEl = document.getElementById('borrowIndicator');
            const marginEl = document.getElementById('marginIndicator');

            if (!shortableEl || !borrowEl || !marginEl) return;

            // Hide all first
            shortableEl.style.display = 'none';
            borrowEl.style.display = 'none';
            marginEl.style.display = 'none';

            // Check for halt - most critical indicator
            if (data.is_halted) {
                shortableEl.style.display = 'inline-block';
                shortableEl.textContent = 'HALTED';
                shortableEl.style.background = '#dc3545';
                shortableEl.style.color = '#fff';
                return; // Only show halt if halted
            }

            // Show borrow status
            if (data.borrow_status === 'ETB') {
                borrowEl.style.display = 'inline-block';
                borrowEl.textContent = 'ETB';
                borrowEl.style.background = '#28a745';
                borrowEl.style.color = '#fff';
            } else if (data.borrow_status === 'HTB') {
                borrowEl.style.display = 'inline-block';
                borrowEl.textContent = 'HTB';
                borrowEl.style.background = '#ff9800';
                borrowEl.style.color = '#fff';
            } else if (data.borrow_status === 'NOT_SHORTABLE' || !data.shortable) {
                borrowEl.style.display = 'inline-block';
                borrowEl.textContent = 'NO SHORT';
                borrowEl.style.background = '#dc3545';
                borrowEl.style.color = '#fff';
            }

            // Show marginable status
            if (data.marginable === false) {
                marginEl.style.display = 'inline-block';
                marginEl.textContent = 'NO MARGIN';
                marginEl.style.background = '#6c757d';
                marginEl.style.color = '#fff';
            }
        }

        // Get asset status for worklist (batch for efficiency)
        async function getAssetStatusBatch(symbols) {
            const results = {};

            for (const symbol of symbols) {
                // Check cache first
                const cached = assetStatusCache[symbol];
                if (cached && (Date.now() - cached.timestamp < 300000)) {
                    results[symbol] = cached.data;
                    continue;
                }

                try {
                    const response = await fetch(`${API_BASE_URL}/api/schwab/asset/${symbol}/status`);
                    if (!response.ok) {
                        // Cache empty result to avoid repeated 404s
                        assetStatusCache[symbol] = { data: {}, timestamp: Date.now() };
                        continue;
                    }
                    const data = await response.json();
                    if (data.success) {
                        assetStatusCache[symbol] = { data: data, timestamp: Date.now() };
                        results[symbol] = data;
                    }
                } catch (e) {
                    // Silent fail - don't block worklist display
                }
            }

            return results;
        }

        function updateWorklistDisplay(retryCount = 0) {
            const display = document.getElementById('watchlistDisplay');
            if (!display) {
                // Retry up to 5 times with delay if element not found (window might not be rendered yet)
                if (retryCount < 5 && worklistData.length > 0) {
                    console.log(`Worklist display element not found, retrying in 500ms (attempt ${retryCount + 1}/5)...`);
                    setTimeout(() => updateWorklistDisplay(retryCount + 1), 500);
                }
                return;
            }

            if (worklistData.length === 0) {
                display.innerHTML = '<div class="empty-state" style="padding: 20px; text-align: center;"><div style="font-size: 28px; margin-bottom: 8px;">üìã</div><div style="font-size: 15px;">No symbols in worklist</div><div style="font-size: 13px; color: #888; margin-top: 4px;">Use Scanner or Add Symbol</div></div>';
                return;
            }

            try {
                // Enhanced watchlist with color-coded technical metrics
                let html = `
                <table class="data-table" style="font-size: 14px; width: 100%;" id="worklistTable">
                    <thead>
                        <tr style="background: #1a1a1a;">
                            <th style="padding: 6px 6px; text-align: left; font-size: 12px; cursor: pointer;" onclick="sortWorklist('symbol')" title="Click to sort">SYM ‚áÖ</th>
                            <th style="padding: 6px 6px; text-align: right; font-size: 12px; cursor: pointer;" onclick="sortWorklist('price')" title="Click to sort">PRICE ‚áÖ</th>
                            <th style="padding: 6px 6px; text-align: center; font-size: 12px; cursor: pointer;" onclick="sortWorklist('change_percent')" title="Click to sort">CHG% ‚áÖ</th>
                            <th style="padding: 6px 6px; text-align: center; font-size: 12px;" title="Trading Halt Status">HALT</th>
                            <th style="padding: 6px 6px; text-align: center; font-size: 12px;" title="News Catalyst">CAT</th>
                            <th style="padding: 6px 6px; text-align: center; font-size: 12px; cursor: pointer;" onclick="sortWorklist('macd_signal')" title="Click to sort">MACD ‚áÖ</th>
                            <th style="padding: 6px 6px; text-align: center; font-size: 12px; cursor: pointer;" onclick="sortWorklist('rel_volume')" title="Click to sort">RVOL ‚áÖ</th>
                            <th style="padding: 6px 6px; text-align: center; font-size: 12px; cursor: pointer;" onclick="sortWorklist('vwap_extension')" title="Click to sort">VWAP ‚áÖ</th>
                            <th style="padding: 6px 6px; text-align: center; font-size: 12px; cursor: pointer;" onclick="sortWorklist('percent_from_hod')" title="Click to sort">HOD ‚áÖ</th>
                            <th style="padding: 6px 6px; text-align: center; font-size: 12px; cursor: pointer;" onclick="sortWorklist('entry_score')" title="Click to sort">SCORE ‚áÖ</th>
                            <th style="padding: 6px 6px; text-align: center; font-size: 12px;" title="Entry Status">GO</th>
                            <th style="padding: 6px 4px; text-align: center; font-size: 12px; width: 30px;" title="Remove">‚úï</th>
                        </tr>
                    </thead>
                    <tbody>`;

                for (const item of worklistData) {
                    const price = item.price ? `$${item.price.toFixed(2)}` : '-';
                    const changePct = item.change_percent !== undefined ? item.change_percent.toFixed(1) : '0.0';
                    const changeColor = (parseFloat(changePct) >= 0) ? '#22c55e' : '#ef4444';

                    // Direction arrow based on change
                    const dirArrow = parseFloat(changePct) > 0 ? '‚ñ≤' : parseFloat(changePct) < 0 ? '‚ñº' : '‚óÜ';
                    const arrowColor = parseFloat(changePct) > 0 ? '#22c55e' : parseFloat(changePct) < 0 ? '#ef4444' : '#666';

                    // HALT indicator with time
                    const isHalted = item.is_halted || false;
                    const haltColor = item.halt_color || '#666';
                    const haltTime = item.halt_time_str || '';
                    const haltType = item.halt_type || '';
                    let haltDisplay = '-';
                    if (isHalted) {
                        haltDisplay = `<span style="background: #ff00ff; color: #000; padding: 3px 6px; border-radius: 3px; font-size: 11px; font-weight: 700; animation: pulse 1s infinite;">${haltType} ${haltTime}</span>`;
                    }

                    // News flame indicator with freshness colors
                    // Red üî• = hot/fresh (< 1 hour), Orange üî• = medium (1-4 hours), Green üî• = older today
                    let newsFlame = '-';
                    if (item.has_news) {
                        // Check news age and catalyst type
                        const newsAge = item.news_age_hours || 0;  // Hours since news
                        // Check news catalyst (FDA/M&A/EARNINGS are always hot)
                        const newsCatalyst = item.news_catalyst_type || item.catalyst_type || 'NEWS';
                        const isHotCatalyst = ['FDA', 'M&A', 'EARNINGS', 'CLINICAL'].includes(newsCatalyst);

                        let flameColor = '#22c55e';  // Default green (older)
                        let flameTitle = `${newsCatalyst} - older news`;

                        if (newsAge < 1 || isHotCatalyst) {
                            flameColor = '#ef4444';  // Red - hot/breaking
                            flameTitle = `üî• ${newsCatalyst} - Breaking! (<1 hour)`;
                        } else if (newsAge < 4) {
                            flameColor = '#f59e0b';  // Orange - medium
                            flameTitle = `${newsCatalyst} - Recent (1-4 hours)`;
                        }

                        newsFlame = `<span style="color: ${flameColor}; font-size: 16px; text-shadow: 0 0 4px ${flameColor};" title="${flameTitle}">üî•</span>`;
                    }

                    // Technical metrics with colors
                    const catalystColor = item.catalyst_color || '#666';
                    const catalystText = item.catalyst_type || (item.has_news ? 'NEWS' : '-');

                    const macdColor = item.macd_color || '#666';
                    const macdText = item.macd_signal || '-';

                    const rvolColor = item.rel_volume_color || '#666';
                    const rvolText = item.rel_volume ? item.rel_volume.toFixed(1) + 'x' : '-';

                    const vwapColor = item.vwap_color || '#666';
                    const vwapExt = item.vwap_extension !== undefined ? (item.vwap_extension > 0 ? '+' : '') + item.vwap_extension.toFixed(1) + '%' : '-';

                    const hodColor = item.hod_color || '#666';
                    const hodText = item.percent_from_hod !== undefined ? item.percent_from_hod.toFixed(1) + '%' : '-';

                    const scoreColor = item.entry_color || '#666';
                    const scoreText = item.entry_score || 0;

                    const statusColor = item.status_color || '#ef4444';
                    const statusText = item.entry_status || 'WAIT';

                    // Row background highlight for halted stocks
                    const rowBg = isHalted ? 'background: rgba(255, 0, 255, 0.15);' : '';

                    html += `
                        <tr class="clickable" onclick="setCurrentSymbol('${item.symbol}')" style="cursor: pointer; border-bottom: 1px solid #252525; ${rowBg}">
                            <td style="padding: 8px 6px;"><span style="color: ${arrowColor}; font-size: 12px; margin-right: 4px;">${dirArrow}</span><strong style="color: #fff; font-size: 15px;">${item.symbol}</strong></td>
                            <td style="padding: 8px 6px; text-align: right; font-family: monospace; font-size: 14px; color: #ccc;">${price}</td>
                            <td style="padding: 8px 6px; text-align: center; font-family: monospace; font-size: 14px; color: ${changeColor}; font-weight: 600;">${changePct}%</td>
                            <td style="padding: 8px 6px; text-align: center;">${haltDisplay}</td>
                            <td style="padding: 8px 6px; text-align: center;">${newsFlame}<span style="color: ${catalystColor}; font-size: 11px; font-weight: 600; margin-left: 2px;">${catalystText !== '-' && catalystText !== 'NEWS' ? catalystText : ''}</span></td>
                            <td style="padding: 8px 6px; text-align: center;"><span style="color: ${macdColor}; font-size: 13px; font-weight: 600;">${macdText}</span></td>
                            <td style="padding: 8px 6px; text-align: center;"><span style="color: ${rvolColor}; font-size: 13px;">${rvolText}</span></td>
                            <td style="padding: 8px 6px; text-align: center;"><span style="color: ${vwapColor}; font-size: 13px;">${vwapExt}</span></td>
                            <td style="padding: 8px 6px; text-align: center;"><span style="color: ${hodColor}; font-size: 13px;">${hodText}</span></td>
                            <td style="padding: 8px 6px; text-align: center;"><span style="background: ${scoreColor}20; color: ${scoreColor}; padding: 4px 8px; border-radius: 3px; font-size: 13px; font-weight: 700;">${scoreText}</span></td>
                            <td style="padding: 8px 6px; text-align: center;"><span style="background: ${statusColor}; color: #000; padding: 4px 10px; border-radius: 3px; font-size: 12px; font-weight: 700;">${statusText}</span></td>
                            <td style="padding: 8px 4px; text-align: center;"><button onclick="event.stopPropagation(); removeFromWorklist('${item.symbol}')" style="background: transparent; border: none; color: #666; cursor: pointer; font-size: 14px; padding: 2px 6px;" title="Remove ${item.symbol}" onmouseover="this.style.color='#ef4444'" onmouseout="this.style.color='#666'">‚úï</button></td>
                        </tr>
                    `;
                }

                html += '</tbody></table>';
                display.innerHTML = html;
                console.log(`Worklist display updated with ${worklistData.length} symbols (enhanced view)`);
            } catch (error) {
                console.error('Error rendering worklist display:', error);
                display.innerHTML = '<div class="empty-state" style="padding: 20px; text-align: center; color: #ef4444;">Error loading worklist. Please refresh.</div>';
            }
        }

        function updateWorklistStats() {
            const total = worklistData.length;
            const live = worklistData.filter(w => w.has_live_data || w.price > 0).length;
            // Count all bullish/bearish prediction variants
            const bullish = worklistData.filter(w => {
                const p = w.prediction?.toUpperCase();
                return p === 'BUY' || p === 'UP' || p === 'BULLISH' || p === 'STRONG_BULLISH';
            }).length;
            const bearish = worklistData.filter(w => {
                const p = w.prediction?.toUpperCase();
                return p === 'SELL' || p === 'DOWN' || p === 'BEARISH' || p === 'STRONG_BEARISH';
            }).length;

            const safeUpdate = (id, value) => {
                const el = document.getElementById(id);
                if (el) el.textContent = value;
            };

            safeUpdate('statsTotal', total);
            safeUpdate('statsLive', live);
            safeUpdate('statsBullish', bullish);
            safeUpdate('statsBearish', bearish);
        }

        async function showAddSymbolDialog() {
            const symbol = window.prompt('Enter symbol to add to worklist:', '');
            if (!symbol) return;

            try {
                const response = await fetch(API_BASE_URL + '/api/worklist/add', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ symbol: symbol.toUpperCase(), exchange: 'SMART' })
                });

                const data = await response.json();
                if (data.success) {
                    await loadWorklist();
                    showNotification(`‚úì ${symbol.toUpperCase()} added`, 'success');
                } else {
                    showNotification('Failed: ' + (data.message || 'Unknown error'), 'error');
                }
            } catch (error) {
                console.error('Failed to add symbol:', error);
                showNotification('Failed to add symbol', 'error');
            }
        }

        async function removeFromWorklist(symbol) {
            if (!window.confirm(`Remove ${symbol} from worklist?`)) return;

            // IMMEDIATE UI UPDATE - remove from local data and re-render instantly
            const originalData = [...worklistData];
            worklistData = worklistData.filter(item => item.symbol !== symbol);
            updateWorklistDisplay();
            updateWorklistStats();
            showNotification(`Removing ${symbol}...`, 'info');

            try {
                const response = await fetch(API_BASE_URL + `/api/worklist/${symbol}`, {
                    method: 'DELETE'
                });

                const data = await response.json();
                if (data.success) {
                    showNotification(`${symbol} removed from worklist`, 'success');
                } else {
                    // Restore on failure
                    worklistData = originalData;
                    updateWorklistDisplay();
                    updateWorklistStats();
                    showNotification('Failed to remove symbol', 'error');
                }
            } catch (error) {
                console.error('Failed to remove symbol:', error);
                // Restore on error
                worklistData = originalData;
                updateWorklistDisplay();
                updateWorklistStats();
                showNotification('Failed to remove symbol', 'error');
            }
        }

        async function clearWorklist() {
            if (!window.confirm('‚ö†Ô∏è Clear entire worklist?\n\nThis will remove all symbols.')) return;

            // IMMEDIATE UI UPDATE - clear local data and re-render instantly
            const originalData = [...worklistData];
            const symbolCount = worklistData.length;
            worklistData = [];
            updateWorklistDisplay();
            updateWorklistStats();
            showNotification(`Clearing ${symbolCount} symbols...`, 'info');

            try {
                const response = await fetch(API_BASE_URL + '/api/worklist/clear', {
                    method: 'DELETE'
                });

                const data = await response.json();
                if (data.success) {
                    showNotification(`Worklist cleared (${symbolCount} symbols removed)`, 'success');
                } else {
                    // Restore on failure
                    worklistData = originalData;
                    updateWorklistDisplay();
                    updateWorklistStats();
                    showNotification('Failed to clear worklist', 'error');
                }
            } catch (error) {
                console.error('Failed to clear worklist:', error);
                // Restore on error
                worklistData = originalData;
                updateWorklistDisplay();
                updateWorklistStats();
                showNotification('Failed to clear worklist', 'error');
            }
        }

        async function showScannerDialog() {
            // Load scanner presets
            try {
                const response = await fetch(API_BASE_URL + '/api/scanner/ALPACA/presets');
                const data = await response.json();

                if (!data.success || !data.data) {
                    alert('Failed to load scanner presets');
                    return;
                }

                const presets = data.data;
                let options = presets.map(p => `<option value="${p.id}">${p.name} - ${p.description}</option>`).join('');

                const html = `
                    <div style="padding: 16px; background: #1a1a1a; border: 2px solid #007acc; border-radius: 4px; width: 400px;">
                        <h3 style="margin: 0 0 12px 0; color: #fff; font-size: 18px;">Market Scanner</h3>
                        <select id="scannerSelect" style="width: 100%; padding: 8px; background: #252525; color: #fff; border: 1px solid #404040; margin-bottom: 12px;">
                            ${options}
                        </select>
                        <div style="display: flex; gap: 8px; justify-content: flex-end;">
                            <button onclick="closeScannerDialog()" class="btn btn-secondary">Cancel</button>
                            <button onclick="runScanner()" class="btn btn-primary" style="background: #007acc;">Run Scanner</button>
                        </div>
                        <div id="scannerResults" style="margin-top: 12px; max-height: 300px; overflow-y: auto;"></div>
                    </div>
                `;

                const dialog = document.createElement('div');
                dialog.id = 'scannerDialog';
                dialog.style.cssText = 'position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 10000; box-shadow: 0 0 20px rgba(0,0,0,0.5);';
                dialog.innerHTML = html;
                document.body.appendChild(dialog);

                // Add backdrop
                const backdrop = document.createElement('div');
                backdrop.id = 'scannerBackdrop';
                backdrop.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 9999;';
                backdrop.onclick = closeScannerDialog;
                document.body.appendChild(backdrop);

            } catch (error) {
                console.error('Failed to load scanner presets:', error);
                alert('Failed to load scanner presets');
            }
        }

        function closeScannerDialog() {
            const dialog = document.getElementById('scannerDialog');
            const backdrop = document.getElementById('scannerBackdrop');
            if (dialog) dialog.remove();
            if (backdrop) backdrop.remove();
        }

        async function runScanner() {
            const select = document.getElementById('scannerSelect');
            const resultsDiv = document.getElementById('scannerResults');

            if (!select || !resultsDiv) return;

            const preset = select.value;
            resultsDiv.innerHTML = '<div style="text-align: center; padding: 20px; color: #888;">Scanning market...</div>';

            try {
                // Use Alpaca scanner API with correct parameters
                const response = await fetch(API_BASE_URL + '/api/scanner/ALPACA/scan', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        preset: preset,
                        scan_type: preset
                    })
                });

                const data = await response.json();

                console.log('Scanner response:', data);

                if (data.success && data.data && data.data.results) {
                    const results = data.data.results;
                    console.log('Scanner results:', results.length);

                    // Show scan info header
                    let html = `
                        <div style="margin-bottom: 8px; padding: 8px; background: #1a1a1a; border-radius: 4px;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <span style="font-size: 14px; color: #888;">Found <strong style="color: #22c55e;">${results.length}</strong> stocks meeting all criteria</span>
                                </div>
                                <button onclick="addAllScannerResults()" class="btn btn-primary" style="font-size: 14px; padding: 4px 12px; background: #007acc;">Add All to Worklist</button>
                            </div>
                        </div>
                        <table class="data-table" style="font-size: 13px;">
                            <thead>
                                <tr>
                                    <th style="padding: 4px;">#</th>
                                    <th style="padding: 4px;">Symbol</th>
                                    <th style="padding: 4px; text-align: right;">Price</th>
                                    <th style="padding: 4px; text-align: right;">Gap %</th>
                                    <th style="padding: 4px; text-align: right;">RVOL</th>
                                    <th style="padding: 4px; text-align: right;">Volume</th>
                                    <th style="padding: 4px; text-align: center;">Signal</th>
                                    <th style="padding: 4px; text-align: center;">
                                        <input type="checkbox" id="selectAllScanner" onchange="toggleAllScannerResults(this.checked)">
                                    </th>
                                </tr>
                            </thead>
                            <tbody>
                    `;

                    results.forEach((r, i) => {
                        const price = r.price ? r.price.toFixed(2) : 'N/A';
                        const gapPercent = r.gap_percent !== undefined ? r.gap_percent.toFixed(2) : (r.change_percent || 0).toFixed(2);
                        const rvol = r.relative_volume !== undefined ? r.relative_volume.toFixed(1) : '-';
                        const volume = r.volume ? (r.volume / 1000000).toFixed(2) : '0.00';
                        const changeClass = parseFloat(gapPercent) >= 0 ? 'positive' : 'negative';
                        const signal = r.signal || 'NEUTRAL';
                        const hasCatalyst = r.has_catalyst || false;
                        const catalystHeadline = r.catalyst_headline || '';

                        // Signal badge color
                        let signalColor = '#888';
                        if (signal.includes('LONG') || signal.includes('BULLISH') || signal.includes('UP')) signalColor = '#22c55e';
                        else if (signal.includes('SHORT') || signal.includes('BEARISH') || signal.includes('DOWN')) signalColor = '#ef4444';
                        else if (signal.includes('5/5') || signal.includes('NEWS')) signalColor = '#eab308';

                        // News catalyst indicator
                        const newsIcon = hasCatalyst ? '<span title="' + catalystHeadline.replace(/"/g, '&quot;') + '" style="cursor: help;">üì∞</span>' : '';

                        html += `
                            <tr>
                                <td style="padding: 4px;">${i + 1}</td>
                                <td style="padding: 4px;">
                                    <strong>${r.symbol || 'N/A'}</strong>
                                    ${newsIcon}
                                </td>
                                <td style="padding: 4px; text-align: right; font-family: monospace;">$${price}</td>
                                <td class="${changeClass}" style="padding: 4px; text-align: right; font-family: monospace;">${gapPercent}%</td>
                                <td style="padding: 4px; text-align: right; font-family: monospace; color: ${parseFloat(rvol) >= 2 ? '#22c55e' : '#888'};">${rvol}x</td>
                                <td style="padding: 4px; text-align: right; font-family: monospace;">${volume}M</td>
                                <td style="padding: 4px; text-align: center;">
                                    <span style="background: ${signalColor}; color: #000; padding: 1px 5px; border-radius: 2px; font-size: 10px; font-weight: 600;">
                                        ${signal.replace('5/5 PILLARS - ', '').trim()}
                                    </span>
                                </td>
                                <td style="padding: 4px; text-align: center;">
                                    <input type="checkbox" class="scanner-checkbox" value="${r.symbol}" checked>
                                </td>
                            </tr>
                            ${hasCatalyst ? `<tr><td colspan="8" style="padding: 2px 4px 6px 20px; font-size: 11px; color: #f59e0b; background: #1a1a1a;">üì∞ ${catalystHeadline.substring(0, 80)}${catalystHeadline.length > 80 ? '...' : ''}</td></tr>` : ''}
                        `;
                    });

                    html += '</tbody></table>';

                    if (results.length === 0) {
                        html = `<div style="text-align: center; padding: 20px; color: #888;">
                            <p>No stocks currently meet ALL ${preset === 'warrior' || preset === 'warrior_long' ? '5 Pillars' : 'criteria'}.</p>
                            <p style="font-size: 12px; margin-top: 10px;">Requirements: Price $2-$20, RVOL 2x+, Gap 4%+, Volume 500K+</p>
                        </div>`;
                    }

                    resultsDiv.innerHTML = html;
                } else {
                    console.error('Scanner failed - invalid response:', data);
                    resultsDiv.innerHTML = `<div style="text-align: center; padding: 20px; color: #ef4444;">
                        Scanner failed: ${data.message || data.detail || 'No results returned'}
                    </div>`;
                }
            } catch (error) {
                console.error('Scanner error:', error);
                resultsDiv.innerHTML = `<div style="text-align: center; padding: 20px; color: #ef4444;">
                    Scanner error: ${error.message}<br>
                    <small style="color: #888;">Check console for details</small>
                </div>`;
            }
        }

        function toggleAllScannerResults(checked) {
            document.querySelectorAll('.scanner-checkbox').forEach(cb => cb.checked = checked);
        }

        async function addAllScannerResults() {
            const checkboxes = document.querySelectorAll('.scanner-checkbox:checked');
            const symbols = Array.from(checkboxes).map(cb => cb.value);

            if (symbols.length === 0) {
                showNotification('No symbols selected', 'error');
                return;
            }

            try {
                const response = await fetch(API_BASE_URL + '/api/scanner/ALPACA/add-to-worklist', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ symbols })
                });

                const data = await response.json();
                if (data.success) {
                    await loadWorklist();
                    closeScannerDialog();
                    showNotification(`‚úì Added ${symbols.length} symbols`, 'success');
                } else {
                    showNotification('Failed to add symbols', 'error');
                }
            } catch (error) {
                console.error('Failed to add scanner results:', error);
                showNotification('Failed to add symbols', 'error');
            }
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        //                     AUTONOMOUS BOT CONTROL FUNCTIONS
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        let botStatusInterval = null;

        async function initBot() {
            try {
                // Get config from UI
                const watchlist = document.getElementById('botWatchlist').value.split(',').map(s => s.trim());
                const config = {
                    watchlist: watchlist,
                    max_position_size_usd: parseFloat(document.getElementById('botMaxPosition').value),
                    daily_loss_limit_usd: parseFloat(document.getElementById('botDailyLoss').value),
                    min_probability_threshold: parseFloat(document.getElementById('botMinProb').value) / 100,
                    max_positions: parseInt(document.getElementById('botMaxPositions').value)
                };

                const response = await fetch(API_BASE_URL + '/api/bot/init', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(config)
                });

                if (response.ok) {
                    const data = await response.json();
                    console.log('Bot initialized:', data);

                    // Update UI
                    document.getElementById('botStatusText').textContent = 'INITIALIZED';
                    document.getElementById('botStatusText').style.color = '#fbbf24';
                    document.getElementById('botStatusSubtext').textContent = 'Ready to start';

                    // Enable controls
                    document.getElementById('initBotBtn').disabled = true;
                    document.getElementById('startBotBtn').disabled = false;
                    document.getElementById('enableBotBtn').disabled = false;

                    // Start polling status
                    if (!botStatusInterval) {
                        botStatusInterval = setInterval(updateBotStatus, 2000);
                    }

                    alert('‚úì Bot initialized successfully!');
                } else {
                    const error = await response.json();
                    alert('‚úó Failed to initialize bot: ' + error.detail);
                }
            } catch (error) {
                console.error('Error initializing bot:', error);
                alert('‚úó Error initializing bot: ' + error.message);
            }
        }

        async function startAutonomousBot() {
            try {
                const response = await fetch(API_BASE_URL + '/api/bot/start', { method: 'POST' });

                if (response.ok) {
                    const data = await response.json();
                    console.log('Bot started:', data);

                    document.getElementById('botStatusText').textContent = 'RUNNING';
                    document.getElementById('botStatusText').style.color = '#22c55e';
                    document.getElementById('botStatusSubtext').textContent = data.enabled ? 'Trading enabled' : 'Trading disabled (enable first)';

                    document.getElementById('startBotBtn').disabled = true;
                    document.getElementById('stopBotBtn').disabled = false;

                    alert('‚úì Bot started successfully!');
                } else {
                    const error = await response.json();
                    alert('‚úó Failed to start bot: ' + error.detail);
                }
            } catch (error) {
                console.error('Error starting bot:', error);
                alert('‚úó Error starting bot: ' + error.message);
            }
        }

        async function stopAutonomousBot() {
            try {
                const response = await fetch(API_BASE_URL + '/api/bot/stop', { method: 'POST' });

                if (response.ok) {
                    const data = await response.json();
                    console.log('Bot stopped:', data);

                    document.getElementById('botStatusText').textContent = 'STOPPED';
                    document.getElementById('botStatusText').style.color = '#ef4444';
                    document.getElementById('botStatusSubtext').textContent = 'All positions closed';

                    document.getElementById('startBotBtn').disabled = false;
                    document.getElementById('stopBotBtn').disabled = true;

                    alert('‚úì Bot stopped successfully!');
                } else {
                    const error = await response.json();
                    alert('‚úó Failed to stop bot: ' + error.detail);
                }
            } catch (error) {
                console.error('Error stopping bot:', error);
                alert('‚úó Error stopping bot: ' + error.message);
            }
        }

        async function enableBot() {
            try {
                const response = await fetch(API_BASE_URL + '/api/bot/enable', { method: 'POST' });

                if (response.ok) {
                    const data = await response.json();
                    console.log('Bot enabled:', data);

                    document.getElementById('botStatusSubtext').textContent = 'Trading ENABLED';
                    document.getElementById('enableBotBtn').textContent = '‚úó DISABLE';
                    document.getElementById('enableBotBtn').onclick = disableBot;

                    alert('‚úì Trading enabled! Bot will now execute trades.');
                } else {
                    const error = await response.json();
                    alert('‚úó Failed to enable bot: ' + error.detail);
                }
            } catch (error) {
                console.error('Error enabling bot:', error);
                alert('‚úó Error: ' + error.message);
            }
        }

        async function disableBot() {
            try {
                const response = await fetch(API_BASE_URL + '/api/bot/disable', { method: 'POST' });

                if (response.ok) {
                    const data = await response.json();
                    console.log('Bot disabled:', data);

                    document.getElementById('botStatusSubtext').textContent = 'Trading DISABLED';
                    document.getElementById('enableBotBtn').textContent = '‚úì ENABLE';
                    document.getElementById('enableBotBtn').onclick = enableBot;

                    alert('‚úì Trading disabled. Bot will continue running but not execute trades.');
                } else {
                    const error = await response.json();
                    alert('‚úó Failed to disable bot: ' + error.detail);
                }
            } catch (error) {
                console.error('Error disabling bot:', error);
                alert('‚úó Error: ' + error.message);
            }
        }

        async function updateBotConfig() {
            try {
                const watchlist = document.getElementById('botWatchlist').value.split(',').map(s => s.trim());
                const config = {
                    watchlist: watchlist,
                    max_position_size_usd: parseFloat(document.getElementById('botMaxPosition').value),
                    daily_loss_limit_usd: parseFloat(document.getElementById('botDailyLoss').value),
                    min_probability_threshold: parseFloat(document.getElementById('botMinProb').value) / 100,
                    max_positions: parseInt(document.getElementById('botMaxPositions').value)
                };

                const response = await fetch(API_BASE_URL + '/api/bot/config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(config)
                });

                if (response.ok) {
                    const data = await response.json();
                    console.log('Config updated:', data);
                    alert('‚úì Configuration updated successfully!');
                } else {
                    const error = await response.json();
                    alert('‚úó Failed to update config: ' + error.detail);
                }
            } catch (error) {
                console.error('Error updating config:', error);
                alert('‚úó Error: ' + error.message);
            }
        }

        async function updateBotStatus() {
            try {
                const response = await fetch(API_BASE_URL + '/api/bot/status');
                if (!response.ok) return;

                const data = await response.json();

                // Update statistics
                if (data.total_signals_generated !== undefined) {
                    document.getElementById('botSignals').textContent = data.total_signals_generated;
                }
                if (data.total_trades_executed !== undefined) {
                    document.getElementById('botTrades').textContent = data.total_trades_executed;
                }
                if (data.trading_engine && data.trading_engine.open_positions !== undefined) {
                    document.getElementById('botPositions').textContent = data.trading_engine.open_positions;
                }
                // Fetch Daily P/L from primary broker (Schwab)
                try {
                    const acctResp = await fetch(API_BASE_URL + '/api/schwab/account');
                    if (acctResp.ok) {
                        const acct = await acctResp.json();
                        const dailyPnl = parseFloat(acct.daily_pl || 0);
                        const dailyPnlElem = document.getElementById('botDailyPnl');
                        dailyPnlElem.textContent = '$' + dailyPnl.toFixed(2);
                        dailyPnlElem.style.color = dailyPnl >= 0 ? '#22c55e' : '#ef4444';
                    }
                } catch (e) { console.log('Schwab account fetch failed:', e); }

                // Fetch Position P/L from Schwab
                try {
                    const posResp = await fetch(API_BASE_URL + '/api/schwab/positions');
                    if (posResp.ok) {
                        const data = await posResp.json();
                        const positions = data.positions || data || [];
                        let totalUnrealizedPl = 0;
                        if (Array.isArray(positions)) {
                            for (const pos of positions) {
                                totalUnrealizedPl += parseFloat(pos.unrealized_pl || pos.unrealized_pnl || 0);
                            }
                        }
                        const posPnlElem = document.getElementById('botPositionPnl');
                        posPnlElem.textContent = '$' + totalUnrealizedPl.toFixed(2);
                        posPnlElem.style.color = totalUnrealizedPl >= 0 ? '#22c55e' : '#ef4444';
                    }
                } catch (e) { console.log('Schwab positions fetch failed:', e); }

                // Update 3-5-7 risk management display
                if (data.trading_engine && data.trading_engine.weekly_pnl !== undefined) {
                    const weeklyPnl = data.trading_engine.weekly_pnl;
                    const weeklyElem = document.getElementById('botWeeklyPnl');
                    weeklyElem.textContent = '$' + weeklyPnl.toFixed(2);
                    weeklyElem.style.color = weeklyPnl >= 0 ? '#22c55e' : '#ef4444';
                }
                if (data.config && data.config.account_size && data.config.max_risk_per_trade_pct) {
                    const maxRiskPerTrade = (data.config.account_size * data.config.max_risk_per_trade_pct / 100).toFixed(2);
                    document.getElementById('botMaxRisk').textContent = '$' + maxRiskPerTrade;
                } else if (data.trading_engine && data.trading_engine.account_size && data.trading_engine.max_risk_per_trade_pct) {
                    const maxRiskPerTrade = (data.trading_engine.account_size * data.trading_engine.max_risk_per_trade_pct / 100).toFixed(2);
                    document.getElementById('botMaxRisk').textContent = '$' + maxRiskPerTrade;
                }

                // Update predictions display
                if (data.last_predictions && Object.keys(data.last_predictions).length > 0) {
                    const predictionsDiv = document.getElementById('botPredictionsDisplay');
                    let html = '';
                    for (const [symbol, pred] of Object.entries(data.last_predictions)) {
                        const prob = (pred.p_final * 100).toFixed(1);
                        const reliability = (pred.reliability * 100).toFixed(0);
                        const color = pred.p_final > 0.5 ? '#22c55e' : pred.p_final < 0.5 ? '#ef4444' : '#888';

                        html += `
                            <div style="padding: 4px; margin-bottom: 4px; background: #1a1a1a; border-left: 3px solid ${color};">
                                <div style="display: flex; justify-content: space-between;">
                                    <span style="font-weight: 700;">${symbol}</span>
                                    <span style="color: ${color};">${prob}%</span>
                                </div>
                                <div style="font-size: 12px; color: #888; margin-top: 2px;">
                                    Reliability: ${reliability}% | ${new Date(pred.timestamp * 1000).toLocaleTimeString()}
                                </div>
                            </div>
                        `;
                    }
                    predictionsDiv.innerHTML = html;
                }

                // Update positions display
                if (data.trading_engine && data.trading_engine.positions && Object.keys(data.trading_engine.positions).length > 0) {
                    const positionsDiv = document.getElementById('botPositionsDisplay');
                    let html = '';
                    for (const [symbol, pos] of Object.entries(data.trading_engine.positions)) {
                        const pnl = pos.unrealized_pnl || 0;
                        const pnlPct = pos.unrealized_pnl_pct || 0;
                        const pnlColor = pnl >= 0 ? '#22c55e' : '#ef4444';

                        html += `
                            <div style="padding: 4px; margin-bottom: 4px; background: #1a1a1a; border-left: 3px solid ${pnlColor};">
                                <div style="display: flex; justify-content: space-between;">
                                    <span style="font-weight: 700;">${symbol}</span>
                                    <span style="color: ${pnlColor};">${pnl >= 0 ? '+' : ''}${pnl.toFixed(2)}</span>
                                </div>
                                <div style="font-size: 12px; color: #888; margin-top: 2px;">
                                    ${pos.quantity} @ $${pos.entry_price.toFixed(2)} | ${pnlPct >= 0 ? '+' : ''}${pnlPct.toFixed(2)}%
                                </div>
                            </div>
                        `;
                    }
                    positionsDiv.innerHTML = html;
                } else if (data.initialized) {
                    document.getElementById('botPositionsDisplay').innerHTML = '<div class="empty-state" style="padding: 16px; font-size: 13px;">No positions</div>';
                }

            } catch (error) {
                console.error('Error updating bot status:', error);
            }
        }

        // Legacy function names for compatibility
        async function startBot() {
            return startAutonomousBot();
        }

        async function stopBot() {
            return stopAutonomousBot();
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        //                     TRADING PIPELINE FUNCTIONS
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        async function startPipeline() {
            try {
                const response = await fetch(API_BASE_URL + '/api/pipeline/start', { method: 'POST' });
                const data = await response.json();
                if (data.success) {
                    updatePipelineStatus(data.status);
                    alert('‚úì Trading Pipeline started!');
                } else {
                    alert('Pipeline: ' + (data.message || 'Already running'));
                }
            } catch (error) {
                console.error('Error starting pipeline:', error);
                alert('Error starting pipeline');
            }
        }

        async function stopPipeline() {
            try {
                const response = await fetch(API_BASE_URL + '/api/pipeline/stop', { method: 'POST' });
                const data = await response.json();
                if (data.success) {
                    updatePipelineStatus(data.status);
                    alert('‚úì Trading Pipeline stopped');
                }
            } catch (error) {
                console.error('Error stopping pipeline:', error);
            }
        }

        function updatePipelineStatus(status) {
            if (!status) return;

            // Update badge
            const badge = document.getElementById('pipelineStatusBadge');
            if (badge) {
                const isRunning = status.is_running;
                badge.innerHTML = `<span style="color: ${isRunning ? '#22c55e' : '#888'};">${isRunning ? 'RUNNING' : 'STOPPED'}</span>`;
            }

            // Update stats
            const stats = status.stats || {};
            const el = (id, val) => { const e = document.getElementById(id); if(e) e.textContent = val; };
            el('pipelineScanned', stats.stocks_scanned || 0);
            el('pipelineAdded', stats.stocks_added_to_watchlist || 0);
            el('pipelineAnalyzed', stats.stocks_analyzed || 0);
            el('pipelineExecuted', stats.trades_executed || 0);
        }

        async function updateTradingDashboard() {
            try {
                // Pipeline status
                const pipelineRes = await fetch(API_BASE_URL + '/api/pipeline/status');
                if (pipelineRes.ok) {
                    const pipeline = await pipelineRes.json();
                    updatePipelineStatus(pipeline);
                }

                // Coach status
                const coachRes = await fetch(API_BASE_URL + '/api/coach/window');
                if (coachRes.ok) {
                    const coach = await coachRes.json();
                    const coachBadge = document.getElementById('coachWindowBadge');
                    if (coachBadge) coachBadge.textContent = coach.window || 'UNKNOWN';
                    const coachStatus = document.getElementById('coachStatus');
                    if (coachStatus) coachStatus.textContent = coach.status || '';
                }

                // AI Trader status
                const traderRes = await fetch(API_BASE_URL + '/api/ai-trader/status');
                if (traderRes.ok) {
                    const trader = await traderRes.json();
                    const el = (id, val) => { const e = document.getElementById(id); if(e) e.textContent = val; };
                    el('aiTraderPending', trader.pending_opportunities || 0);
                    el('aiTraderToday', trader.today_trades || 0);
                    el('aiTraderMax', trader.max_daily_trades || 10);
                    const modeEl = document.getElementById('aiTraderMode');
                    if (modeEl) modeEl.textContent = trader.paper_mode ? 'PAPER' : 'LIVE';
                }

            } catch (error) {
                console.error('Error updating trading dashboard:', error);
            }
        }

        // Update trading dashboard every 15 seconds
        setInterval(updateTradingDashboard, 15000);

        async function getPrediction() {
            try {
                const response = await fetch(API_BASE_URL + '/api/ai/predict', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ symbol: currentSymbol })
                });
                const data = await response.json();

                const display = document.getElementById('aiPredictionDisplay');
                const signal = data.signal || 'NEUTRAL';
                const signalColor = signal === 'BUY' ? '#22c55e' : signal === 'SELL' ? '#ef4444' : '#888';

                display.innerHTML = `
                    <div style="padding: 16px; background: #252525; border: 1px solid #333; border-radius: 2px;">
                        <div style="text-align: center; margin-bottom: 12px;">
                            <div style="font-size: 28px; font-weight: 700; color: ${signalColor};">${signal}</div>
                            <div style="font-size: 13px; color: #888; margin-top: 4px;">CONFIDENCE: ${data.confidence || 0}%</div>
                        </div>
                        <div style="font-size: 14px; color: #aaa; line-height: 1.4;">
                            ${data.reason || 'No analysis available'}
                        </div>
                    </div>
                `;
            } catch (error) {
                console.error('Error getting prediction:', error);
                document.getElementById('aiPredictionDisplay').innerHTML = '<div class="empty-state">AI service unavailable</div>';
            }
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        //                     AI CONTROL PANEL FUNCTIONS
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        let currentTrainingId = null;
        let trainingCheckInterval = null;
        let currentBacktestId = null;
        let backtestCheckInterval = null;

        // Tab switching
        function switchAITab(tab) {
            // Hide all active tabs
            document.getElementById('aiTrainingTab').style.display = 'none';
            document.getElementById('aiPredictionsTab').style.display = 'none';
            document.getElementById('aiBacktestTab').style.display = 'none';
            document.getElementById('aiBotTab').style.display = 'none';
            const newsTab = document.getElementById('aiNewsTab');
            if (newsTab) newsTab.style.display = 'none';

            // Reset all tab buttons
            document.querySelectorAll('.ai-tab').forEach(btn => {
                btn.style.background = '#1a1a1a';
                btn.style.color = '#888';
            });

            // Show selected tab
            if (tab === 'training') {
                document.getElementById('aiTrainingTab').style.display = 'block';
                document.getElementById('aiTabTraining').style.background = '#2d2d2d';
                document.getElementById('aiTabTraining').style.color = '#fff';
            } else if (tab === 'predictions') {
                document.getElementById('aiPredictionsTab').style.display = 'block';
                document.getElementById('aiTabPredictions').style.background = '#2d2d2d';
                document.getElementById('aiTabPredictions').style.color = '#fff';
            } else if (tab === 'backtest') {
                document.getElementById('aiBacktestTab').style.display = 'block';
                document.getElementById('aiTabBacktest').style.background = '#2d2d2d';
                document.getElementById('aiTabBacktest').style.color = '#fff';
            } else if (tab === 'bot') {
                document.getElementById('aiBotTab').style.display = 'block';
                document.getElementById('aiTabBot').style.background = '#2d2d2d';
                document.getElementById('aiTabBot').style.color = '#fff';
                updateBotStatus();
                startBotStatusRefresh();
            } else if (tab === 'news') {
                document.getElementById('aiNewsTab').style.display = 'block';
                document.getElementById('aiTabNews').style.background = '#2d2d2d';
                document.getElementById('aiTabNews').style.color = '#fff';
                loadNewsSentiment();
                loadNewsTriggers();
            }
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        //                     BACKGROUND BRAIN FUNCTIONS
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        async function loadBrainStatus() {
            try {
                const response = await fetch(API_BASE_URL + '/api/schwab/ai/brain/status');
                const data = await response.json();

                if (data.success) {
                    const metrics = data.metrics || {};
                    const regime = data.market_regime || {};

                    // Update status badge
                    const badge = document.getElementById('brainStatusBadge');
                    if (data.running) {
                        badge.textContent = 'RUNNING';
                        badge.style.color = '#22c55e';
                        badge.style.background = 'rgba(34, 197, 94, 0.2)';
                    } else {
                        badge.textContent = 'STOPPED';
                        badge.style.color = '#ef4444';
                        badge.style.background = 'rgba(239, 68, 68, 0.2)';
                    }

                    // Update metrics
                    document.getElementById('brainCpuTarget').textContent = ((metrics.cpu_usage_target || 0.3) * 100).toFixed(0) + '%';
                    document.getElementById('brainActualCpu').textContent = ((metrics.actual_cpu_usage || 0) * 100).toFixed(0) + '%';
                    document.getElementById('brainRegime').textContent = (regime.regime || 'UNKNOWN').replace('_', ' ');

                    // Format uptime
                    const uptime = metrics.uptime_seconds || 0;
                    const hours = Math.floor(uptime / 3600);
                    const mins = Math.floor((uptime % 3600) / 60);
                    document.getElementById('brainUptime').textContent = hours > 0 ? hours + 'h ' + mins + 'm' : mins + 'm';

                    // Update detailed metrics
                    document.getElementById('brainTasksCompleted').textContent = metrics.tasks_completed || 0;
                    document.getElementById('brainTasksPending').textContent = metrics.tasks_pending || 0;
                    document.getElementById('brainPredictionsEval').textContent = metrics.predictions_evaluated || 0;
                    document.getElementById('brainAccuracy').textContent = ((metrics.prediction_accuracy || 0) * 100).toFixed(1) + '%';

                    // Update regime details
                    document.getElementById('brainRegimeName').textContent = regime.regime || 'UNKNOWN';
                    document.getElementById('brainRegimeConf').textContent = ((regime.confidence || 0) * 100).toFixed(0) + '%';
                    document.getElementById('brainRegimeTime').textContent = regime.detected_at ? new Date(regime.detected_at).toLocaleTimeString() : '--';

                    // Update slider
                    const cpuTarget = ((metrics.cpu_usage_target || 0.3) * 100).toFixed(0);
                    document.getElementById('brainCpuSlider').value = cpuTarget;
                    document.getElementById('brainCpuSliderValue').textContent = cpuTarget + '%';
                }
            } catch (error) {
                console.error('Error loading brain status:', error);
            }
        }

        async function startBackgroundBrain() {
            try {
                const cpuTarget = parseInt(document.getElementById('brainCpuSlider').value) / 100;
                const response = await fetch(API_BASE_URL + '/api/schwab/ai/brain/start', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ cpu_target: cpuTarget })
                });
                const data = await response.json();
                if (data.success) {
                    showNotification('Brain started with ' + (cpuTarget * 100) + '% CPU target', 'success');
                    loadBrainStatus();
                } else {
                    showNotification('Failed to start brain: ' + (data.error || 'Unknown error'), 'error');
                }
            } catch (error) {
                showNotification('Error starting brain: ' + error.message, 'error');
            }
        }

        async function stopBackgroundBrain() {
            try {
                const response = await fetch(API_BASE_URL + '/api/schwab/ai/brain/stop', { method: 'POST' });
                const data = await response.json();
                if (data.success) {
                    showNotification('Brain stopped', 'warning');
                    loadBrainStatus();
                } else {
                    showNotification('Failed to stop brain: ' + (data.error || 'Unknown error'), 'error');
                }
            } catch (error) {
                showNotification('Error stopping brain: ' + error.message, 'error');
            }
        }

        async function updateBrainCpuTarget(value) {
            document.getElementById('brainCpuSliderValue').textContent = value + '%';
            try {
                const response = await fetch(API_BASE_URL + '/api/schwab/ai/brain/cpu-target', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ cpu_target: parseInt(value) / 100 })
                });
                const data = await response.json();
                if (data.success) {
                    showNotification('CPU target set to ' + value + '%', 'success');
                    loadBrainStatus();
                }
            } catch (error) {
                console.error('Error updating CPU target:', error);
            }
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        //                     CIRCUIT BREAKER & SAFETY FUNCTIONS
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        async function loadCircuitBreakerStatus() {
            try {
                const response = await fetch(API_BASE_URL + '/api/schwab/ai/circuit-breaker/status');
                const data = await response.json();

                if (data.success) {
                    // Update level badge
                    const levelEl = document.getElementById('circuitBreakerLevel');
                    const level = data.level || 'NORMAL';
                    levelEl.textContent = level;

                    // Color based on level
                    const colors = {
                        'NORMAL': { bg: '#22c55e', text: '#fff' },
                        'WARNING': { bg: '#f59e0b', text: '#fff' },
                        'CAUTION': { bg: '#f97316', text: '#fff' },
                        'HALT': { bg: '#ef4444', text: '#fff' }
                    };
                    const color = colors[level] || colors['NORMAL'];
                    levelEl.style.background = color.bg;
                    levelEl.style.color = color.text;

                    // Update values
                    document.getElementById('cbStartingEquity').textContent = '$' + (data.starting_equity || 0).toLocaleString();
                    document.getElementById('cbCurrentEquity').textContent = '$' + (data.current_equity || 0).toLocaleString();
                    document.getElementById('cbTodayPnL').textContent = '$' + (data.pnl || 0).toFixed(2);
                    document.getElementById('cbDrawdown').textContent = ((data.drawdown_pct || 0) * 100).toFixed(2) + '%';

                    // Color P&L
                    const pnlEl = document.getElementById('cbTodayPnL');
                    pnlEl.style.color = (data.pnl || 0) >= 0 ? '#22c55e' : '#ef4444';
                }
            } catch (error) {
                console.error('Error loading circuit breaker status:', error);
            }
        }

        async function resetCircuitBreaker() {
            if (!confirm('Reset circuit breaker for today? This will reinitialize starting equity.')) return;
            try {
                const response = await fetch(API_BASE_URL + '/api/schwab/ai/circuit-breaker/reset', { method: 'POST' });
                const data = await response.json();
                if (data.success) {
                    showNotification('Circuit breaker reset', 'success');
                    loadCircuitBreakerStatus();
                } else {
                    showNotification('Failed to reset: ' + (data.error || 'Unknown error'), 'error');
                }
            } catch (error) {
                showNotification('Error resetting circuit breaker: ' + error.message, 'error');
            }
        }

        async function loadTradeJournal() {
            try {
                const response = await fetch(API_BASE_URL + '/api/schwab/ai/trade-journal?limit=20');
                const data = await response.json();

                const container = document.getElementById('tradeJournalList');
                if (data.success && data.entries && data.entries.length > 0) {
                    container.innerHTML = data.entries.map(entry => {
                        const actionColor = entry.action === 'BUY' ? '#22c55e' : '#ef4444';
                        return `
                            <div style="padding: 8px; background: #252525; border-radius: 4px; margin-bottom: 6px; border-left: 3px solid ${actionColor};">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                                    <span style="font-weight: 700; color: ${actionColor};">${entry.action} ${entry.symbol}</span>
                                    <span style="color: #666; font-size: 10px;">${new Date(entry.timestamp).toLocaleString()}</span>
                                </div>
                                <div style="color: #888; font-size: 10px;">
                                    <div><strong>Price:</strong> $${(entry.price || 0).toFixed(2)} | <strong>Confidence:</strong> ${entry.confidence_level || 'N/A'}</div>
                                    <div style="margin-top: 4px;"><strong>Thesis:</strong> ${(entry.thesis || 'No thesis').substring(0, 100)}...</div>
                                </div>
                            </div>
                        `;
                    }).join('');
                } else {
                    container.innerHTML = '<div style="padding: 15px; text-align: center; color: #666;">No journal entries yet</div>';
                }
            } catch (error) {
                console.error('Error loading trade journal:', error);
                document.getElementById('tradeJournalList').innerHTML = '<div style="padding: 15px; text-align: center; color: #ef4444;">Error loading journal</div>';
            }
        }

        async function loadSymbolMemory() {
            const symbol = document.getElementById('symbolMemorySearch').value.trim().toUpperCase();
            if (!symbol) {
                showNotification('Enter a symbol', 'warning');
                return;
            }

            try {
                const response = await fetch(API_BASE_URL + '/api/schwab/ai/symbol-memory/' + symbol);
                const data = await response.json();

                const container = document.getElementById('symbolMemoryInfo');
                if (data.success && data.memory) {
                    const mem = data.memory;
                    container.innerHTML = `
                        <div style="margin-bottom: 8px;">
                            <strong style="color: #007acc;">${symbol}</strong> - Trading History
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 6px;">
                            <div><strong>Total Trades:</strong> ${mem.total_trades || 0}</div>
                            <div><strong>Win Rate:</strong> ${((mem.win_rate || 0) * 100).toFixed(1)}%</div>
                            <div><strong>Avg P&L:</strong> $${(mem.avg_pnl || 0).toFixed(2)}</div>
                            <div><strong>Recommended Size:</strong> ${mem.recommended_size || 'N/A'}</div>
                        </div>
                        <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid #404040;">
                            <strong>Last Trade:</strong> ${mem.last_trade_date || 'Never'}
                        </div>
                    `;
                } else {
                    container.innerHTML = '<div style="color: #888;">No memory for ' + symbol + ' - no trades recorded yet</div>';
                }
            } catch (error) {
                console.error('Error loading symbol memory:', error);
                document.getElementById('symbolMemoryInfo').innerHTML = '<div style="color: #ef4444;">Error loading memory</div>';
            }
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        //                     MORPHIC AI FUNCTIONS
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        async function loadMorphicStatus() {
            try {
                const response = await fetch(API_BASE_URL + '/api/morphic/status');
                const data = await response.json();

                if (data.success && data.data) {
                    const state = data.data.state || data.data;
                    document.getElementById('morphicRegime').textContent = (state.regime || 'RANGE').toUpperCase().replace('_', ' ');
                    document.getElementById('morphicHealth').textContent = (state.model_health || 'HEALTHY').toUpperCase();
                    document.getElementById('morphicRisk').textContent = (state.risk_multiplier || 1.0).toFixed(1) + 'x';
                    document.getElementById('morphicStrategy').textContent = (state.active_strategy || 'BALANCED').toUpperCase();

                    // Update health color
                    const healthEl = document.getElementById('morphicHealth');
                    const healthBadge = document.getElementById('morphicStatusBadge');
                    if (state.model_health === 'healthy') {
                        healthEl.style.color = '#22c55e';
                        healthBadge.style.color = '#22c55e';
                        healthBadge.textContent = 'HEALTHY';
                    } else if (state.model_health === 'degraded') {
                        healthEl.style.color = '#f59e0b';
                        healthBadge.style.color = '#f59e0b';
                        healthBadge.textContent = 'DEGRADED';
                    } else if (state.model_health === 'critical') {
                        healthEl.style.color = '#ef4444';
                        healthBadge.style.color = '#ef4444';
                        healthBadge.textContent = 'CRITICAL';
                    }

                    // Update sliders
                    document.getElementById('morphicRiskSlider').value = state.risk_multiplier || 1.0;
                    document.getElementById('riskMultiplierValue').textContent = (state.risk_multiplier || 1.0).toFixed(1) + 'x';
                    document.getElementById('morphicConfSlider').value = (state.confidence_threshold || 0.65) * 100;
                    document.getElementById('confThresholdValue').textContent = ((state.confidence_threshold || 0.65) * 100).toFixed(0) + '%';
                    document.getElementById('morphicAutoAdapt').checked = state.auto_adapt_enabled !== false;
                }
            } catch (error) {
                console.error('Error loading morphic status:', error);
            }
        }

        async function toggleMorphicAutoAdapt() {
            const enabled = document.getElementById('morphicAutoAdapt').checked;
            try {
                await fetch(API_BASE_URL + '/api/morphic/settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ auto_adapt_enabled: enabled })
                });
                showNotification(`Auto-adapt ${enabled ? 'enabled' : 'disabled'}`, 'info');
            } catch (error) {
                console.error('Error toggling auto-adapt:', error);
            }
        }

        async function updateMorphicRisk(value) {
            document.getElementById('riskMultiplierValue').textContent = parseFloat(value).toFixed(1) + 'x';
            document.getElementById('morphicRisk').textContent = parseFloat(value).toFixed(1) + 'x';
            try {
                await fetch(API_BASE_URL + '/api/morphic/settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ risk_multiplier: parseFloat(value) })
                });
            } catch (error) {
                console.error('Error updating risk:', error);
            }
        }

        async function updateMorphicConfidence(value) {
            document.getElementById('confThresholdValue').textContent = value + '%';
            try {
                await fetch(API_BASE_URL + '/api/morphic/settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ confidence_threshold: parseFloat(value) / 100 })
                });
            } catch (error) {
                console.error('Error updating confidence:', error);
            }
        }

        async function morphicAnalyzeRegime() {
            const analysisDiv = document.getElementById('morphicAnalysis');
            analysisDiv.innerHTML = '<div style="color: #8b5cf6;">Analyzing market regime with Claude AI...</div>';

            try {
                const response = await fetch(API_BASE_URL + '/api/morphic/analyze-regime?symbol=' + (currentSymbol || 'SPY'), {
                    method: 'POST'
                });
                const data = await response.json();

                if (data.success && data.data) {
                    const r = data.data;
                    document.getElementById('morphicRegime').textContent = (r.current_regime || 'RANGE').toUpperCase().replace('_', ' ');

                    analysisDiv.innerHTML = `
                        <div style="margin-bottom: 8px;">
                            <span style="color: #8b5cf6; font-weight: 700;">Regime:</span>
                            <span style="color: #fff;">${r.current_regime?.toUpperCase().replace('_', ' ')}</span>
                            <span style="color: #666;">(${(r.confidence * 100).toFixed(0)}% confidence)</span>
                        </div>
                        <div style="margin-bottom: 8px;">
                            <span style="color: #3b82f6; font-weight: 700;">Trend:</span>
                            <span style="color: ${r.trend_strength > 0 ? '#22c55e' : r.trend_strength < 0 ? '#ef4444' : '#888'};">
                                ${r.trend_strength > 0 ? 'Bullish' : r.trend_strength < 0 ? 'Bearish' : 'Neutral'} (${(r.trend_strength * 100).toFixed(0)}%)
                            </span>
                        </div>
                        <div style="margin-bottom: 8px;">
                            <span style="color: #f97316; font-weight: 700;">Volatility:</span>
                            <span style="color: #fff;">${r.volatility_percentile?.toFixed(0) || 50}th percentile</span>
                        </div>
                        <div style="margin-top: 10px; padding-top: 8px; border-top: 1px solid #333;">
                            <div style="color: #22c55e; font-weight: 700; margin-bottom: 4px;">Claude Analysis:</div>
                            <div style="color: #ccc;">${r.claude_analysis || 'No analysis available'}</div>
                        </div>
                    `;
                    showNotification('Regime analysis complete', 'success');
                } else {
                    analysisDiv.innerHTML = '<div style="color: #ef4444;">Analysis failed: ' + (data.error || 'Unknown error') + '</div>';
                }
            } catch (error) {
                analysisDiv.innerHTML = '<div style="color: #ef4444;">Error: ' + error.message + '</div>';
            }
        }

        async function morphicDetectDrift() {
            const analysisDiv = document.getElementById('morphicAnalysis');
            analysisDiv.innerHTML = '<div style="color: #3b82f6;">Detecting model drift with Claude AI...</div>';

            try {
                const response = await fetch(API_BASE_URL + '/api/morphic/detect-drift', { method: 'POST' });
                const data = await response.json();

                if (data.success && data.data) {
                    const d = data.data;
                    const driftColor = d.drift_score > 0.5 ? '#ef4444' : d.drift_score > 0.2 ? '#f59e0b' : '#22c55e';

                    analysisDiv.innerHTML = `
                        <div style="margin-bottom: 8px;">
                            <span style="color: #3b82f6; font-weight: 700;">Drift Score:</span>
                            <span style="color: ${driftColor}; font-size: 16px; font-weight: 700;">${(d.drift_score * 100).toFixed(1)}%</span>
                        </div>
                        <div style="margin-bottom: 8px;">
                            <span style="color: #888;">Accuracy Change:</span>
                            <span style="color: ${d.accuracy_change >= 0 ? '#22c55e' : '#ef4444'};">
                                ${d.accuracy_change >= 0 ? '+' : ''}${(d.accuracy_change * 100).toFixed(1)}%
                            </span>
                        </div>
                        <div style="margin-bottom: 8px;">
                            <span style="color: #888;">Recommended Action:</span>
                            <span style="color: #f97316; font-weight: 600;">${d.recommended_action?.toUpperCase().replace('_', ' ') || 'NONE'}</span>
                        </div>
                        <div style="margin-top: 10px; padding-top: 8px; border-top: 1px solid #333;">
                            <div style="color: #22c55e; font-weight: 700; margin-bottom: 4px;">Claude Diagnosis:</div>
                            <div style="color: #ccc;">${d.claude_diagnosis || 'No diagnosis available'}</div>
                        </div>
                    `;

                    // Update health indicator
                    if (d.drift_score > 0.5) {
                        document.getElementById('morphicHealth').textContent = 'CRITICAL';
                        document.getElementById('morphicHealth').style.color = '#ef4444';
                    } else if (d.drift_score > 0.2) {
                        document.getElementById('morphicHealth').textContent = 'DEGRADED';
                        document.getElementById('morphicHealth').style.color = '#f59e0b';
                    }

                    showNotification('Drift detection complete', 'success');
                } else {
                    analysisDiv.innerHTML = '<div style="color: #ef4444;">Detection failed: ' + (data.error || 'Unknown error') + '</div>';
                }
            } catch (error) {
                analysisDiv.innerHTML = '<div style="color: #ef4444;">Error: ' + error.message + '</div>';
            }
        }

        async function morphicAutoRetrain() {
            const analysisDiv = document.getElementById('morphicAnalysis');
            analysisDiv.innerHTML = '<div style="color: #22c55e;">Starting auto-retrain with Claude AI optimization...</div>';
            showNotification('Auto-retraining started...', 'info');

            try {
                const response = await fetch(API_BASE_URL + '/api/morphic/auto-retrain?symbol=' + (currentSymbol || 'SPY') + '&reason=manual_trigger', {
                    method: 'POST'
                });
                const data = await response.json();

                if (data.success) {
                    analysisDiv.innerHTML = `
                        <div style="color: #22c55e; font-weight: 700; margin-bottom: 8px;">Retraining Complete!</div>
                        <div style="margin-bottom: 4px;">New Accuracy: <span style="color: #22c55e; font-weight: 700;">${((data.data?.new_accuracy || 0) * 100).toFixed(1)}%</span></div>
                        <div style="color: #888; font-size: 10px;">${JSON.stringify(data.data?.training_params || {})}</div>
                    `;
                    document.getElementById('morphicHealth').textContent = 'HEALTHY';
                    document.getElementById('morphicHealth').style.color = '#22c55e';
                    showNotification('Model retrained successfully!', 'success');
                } else {
                    analysisDiv.innerHTML = '<div style="color: #ef4444;">Retraining failed: ' + (data.error || data.data?.error || 'Unknown error') + '</div>';
                }
            } catch (error) {
                analysisDiv.innerHTML = '<div style="color: #ef4444;">Error: ' + error.message + '</div>';
            }
        }

        async function morphicValidateStrategy() {
            const analysisDiv = document.getElementById('morphicAnalysis');
            analysisDiv.innerHTML = '<div style="color: #f97316;">Validating strategy with backtest...</div>';

            try {
                const confThreshold = parseFloat(document.getElementById('morphicConfSlider').value) / 100;
                const response = await fetch(API_BASE_URL + '/api/morphic/validate-strategy', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        symbol: currentSymbol || 'SPY',
                        confidence_threshold: confThreshold,
                        prob_threshold: 0.60,
                        position_size: 5
                    })
                });
                const data = await response.json();

                if (data.success) {
                    const v = data.data?.validation || {};
                    const approvedColor = data.approved ? '#22c55e' : '#ef4444';

                    analysisDiv.innerHTML = `
                        <div style="margin-bottom: 8px;">
                            <span style="color: ${approvedColor}; font-size: 16px; font-weight: 700;">
                                ${data.approved ? '‚úÖ APPROVED' : '‚ùå REJECTED'}
                            </span>
                        </div>
                        <div style="margin-bottom: 4px;">Quality Score: <span style="color: #3b82f6;">${v.quality_score || 0}/100</span></div>
                        <div style="margin-bottom: 4px;">Risk Assessment: <span style="color: #f97316;">${v.risk_assessment || 'Unknown'}</span></div>
                        <div style="margin-top: 8px; color: #888; font-size: 10px;">
                            Strengths: ${(v.strengths || []).join(', ') || 'None identified'}<br>
                            Weaknesses: ${(v.weaknesses || []).join(', ') || 'None identified'}
                        </div>
                    `;
                    showNotification(`Strategy ${data.approved ? 'approved' : 'rejected'}`, data.approved ? 'success' : 'warning');
                } else {
                    analysisDiv.innerHTML = '<div style="color: #ef4444;">Validation failed: ' + (data.error || 'Unknown error') + '</div>';
                }
            } catch (error) {
                analysisDiv.innerHTML = '<div style="color: #ef4444;">Error: ' + error.message + '</div>';
            }
        }

        async function loadMorphicHistory() {
            try {
                const response = await fetch(API_BASE_URL + '/api/morphic/history/adaptations?limit=10');
                const data = await response.json();

                const historyDiv = document.getElementById('morphicHistory');
                if (data.success && data.data && data.data.length > 0) {
                    historyDiv.innerHTML = data.data.map(e => `
                        <div style="padding: 6px; background: #252525; border-radius: 3px; margin-bottom: 4px; display: flex; justify-content: space-between;">
                            <span style="color: #8b5cf6;">${e.action?.replace('_', ' ') || 'Unknown'}</span>
                            <span style="color: #666;">${e.trigger?.substring(0, 30) || ''}</span>
                        </div>
                    `).join('');
                } else {
                    historyDiv.innerHTML = '<div style="color: #666; text-align: center; padding: 10px;">No adaptations yet</div>';
                }
            } catch (error) {
                console.error('Error loading history:', error);
            }
        }

        async function startMorphicMonitoring() {
            try {
                await fetch(API_BASE_URL + '/api/morphic/monitoring/start', { method: 'POST' });
                showNotification('Morphic monitoring started', 'success');
            } catch (error) {
                showNotification('Failed to start monitoring', 'error');
            }
        }

        async function stopMorphicMonitoring() {
            try {
                await fetch(API_BASE_URL + '/api/morphic/monitoring/stop', { method: 'POST' });
                showNotification('Morphic monitoring stopped', 'info');
            } catch (error) {
                showNotification('Failed to stop monitoring', 'error');
            }
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        //                     NEWS & FUNDAMENTALS FUNCTIONS
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        async function loadNewsSentiment() {
            try {
                const response = await fetch(API_BASE_URL + '/api/news/sentiment');
                if (!response.ok) throw new Error('Failed to load sentiment');
                const data = await response.json();

                // Update sentiment display
                const sentimentEl = document.getElementById('sentimentScore');
                const sentiment = data.overall_sentiment || 'neutral';
                sentimentEl.textContent = sentiment.toUpperCase();
                sentimentEl.style.color = sentiment === 'bullish' ? '#22c55e' :
                                          sentiment === 'bearish' ? '#ef4444' : '#888';

                document.getElementById('bullishCount').textContent = data.bullish_count || 0;
                document.getElementById('bearishCount').textContent = data.bearish_count || 0;
                document.getElementById('highImpactCount').textContent = data.high_impact_count || 0;
            } catch (error) {
                console.error('Error loading sentiment:', error);
            }
        }

        async function loadNewsFeed() {
            try {
                const impact = document.getElementById('newsImpactFilter').value;
                let url = API_BASE_URL + '/api/news/fetch?limit=20';
                if (impact) url += '&impact=' + impact;

                const response = await fetch(url);
                if (!response.ok) throw new Error('Failed to load news');
                const data = await response.json();

                const container = document.getElementById('newsFeedList');
                if (data.news && data.news.length > 0) {
                    container.innerHTML = data.news.map(item => `
                        <div style="padding: 8px; background: #252525; border-radius: 4px; margin-bottom: 6px; border-left: 3px solid ${getImpactColor(item.impact)};">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 8px;">
                                <div style="flex: 1;">
                                    <div style="font-size: 11px; font-weight: 600; color: #fff; margin-bottom: 4px;">${item.headline}</div>
                                    <div style="font-size: 10px; color: #666;">${item.source} ‚Ä¢ ${new Date(item.published_at).toLocaleString()}</div>
                                </div>
                                <div style="text-align: right;">
                                    <span style="font-size: 9px; padding: 2px 6px; background: ${getSentimentBg(item.sentiment)}; color: #fff; border-radius: 3px;">
                                        ${item.sentiment.toUpperCase()}
                                    </span>
                                    <div style="font-size: 9px; color: #888; margin-top: 4px;">${item.symbols.join(', ')}</div>
                                </div>
                            </div>
                        </div>
                    `).join('');
                } else {
                    container.innerHTML = '<div style="padding: 20px; text-align: center; color: #666;">No news items found</div>';
                }

                // Also refresh sentiment
                loadNewsSentiment();
            } catch (error) {
                console.error('Error loading news feed:', error);
                document.getElementById('newsFeedList').innerHTML = '<div style="padding: 20px; text-align: center; color: #ef4444;">Error loading news</div>';
            }
        }

        // Timestamped News Log (4AM Scanner format)
        async function loadTimestampedNewsLog() {
            try {
                const response = await fetch(API_BASE_URL + '/api/news-log?limit=50');
                if (!response.ok) throw new Error('Failed to load news log');
                const data = await response.json();

                const container = document.getElementById('timestampedNewsLog');
                const countEl = document.getElementById('newsLogCount');

                if (data.news && data.news.length > 0) {
                    countEl.textContent = data.count + ' items';
                    container.innerHTML = data.news.map(item => {
                        const headline = item.headline ? item.headline.substring(0, 80) : '';
                        return `<div style="padding: 3px 0; border-bottom: 1px solid #222;">
                            <span style="color: #00d4ff; font-weight: 600;">$${item.symbol}</span>
                            <span style="color: #aaa;"> - ${headline}${headline.length >= 80 ? '...' : ''}</span>
                            <span style="color: #666; float: right;">${item.time_str}</span>
                        </div>`;
                    }).join('');
                } else {
                    countEl.textContent = '0 items';
                    container.innerHTML = '<div style="color: #666; text-align: center; padding: 20px;">No news logged yet. Start news monitor to capture breaking news.</div>';
                }
            } catch (error) {
                console.error('Error loading news log:', error);
                document.getElementById('timestampedNewsLog').innerHTML = '<div style="color: #ef4444;">Error loading news log</div>';
            }
        }

        // Auto-refresh news log every 30 seconds
        setInterval(loadTimestampedNewsLog, 30000);
        // Load immediately on page load

        // Breaking News Feed (scrollable list)
        async function refreshNewsTicker() {
            const feedEl = document.getElementById('newsTickerScroll');
            const countEl = document.getElementById('newsTickerCount');
            if (!feedEl) return;  // Elements don't exist yet, skip

            try {
                const response = await fetch(API_BASE_URL + '/api/news-log?limit=50');
                if (!response.ok) throw new Error('Failed to load news');
                const data = await response.json();

                if (data.news && data.news.length > 0) {
                    if (countEl) countEl.textContent = '(' + data.count + ')';

                    // Build scrollable list items
                    const items = data.news.map(item => {
                        const symbol = item.symbol || '???';
                        const headline = item.headline || 'No headline';
                        const timeStr = item.time_str || '';
                        const dateStr = item.date || '';

                        // SEC EDGAR search URL for the symbol
                        const secUrl = `https://www.sec.gov/cgi-bin/browse-edgar?action=getcompany&CIK=${symbol}&type=8-K&dateb=&owner=include&count=10`;

                        return `<div style="padding: 6px 8px; border-bottom: 1px solid #222; display: flex; gap: 8px; align-items: flex-start;">
                            <div style="min-width: 75px; color: #555; font-size: 10px; white-space: nowrap;">${dateStr}<br>${timeStr}</div>
                            <a href="${secUrl}" target="_blank" style="min-width: 50px; color: #00d4ff; font-weight: 600; text-decoration: none;" title="SEC filings for ${symbol}" onclick="event.stopPropagation(); setSymbol('${symbol}');">$${symbol}</a>
                            <div style="color: #aaa; flex: 1; line-height: 1.3;">${headline}</div>
                        </div>`;
                    });

                    feedEl.innerHTML = items.join('');
                } else {
                    if (countEl) countEl.textContent = '(0)';
                    feedEl.innerHTML = '<div style="padding: 20px; color: #666; text-align: center;">No news yet - Start news monitor to capture live updates</div>';
                }
            } catch (error) {
                // Silent fail - news feed is optional
                if (feedEl) feedEl.innerHTML = '<div style="padding: 20px; color: #666; text-align: center;">News feed unavailable</div>';
            }
        }

        // Toggle news feed panel
        function toggleNewsFeed() {
            const content = document.getElementById('newsFeedContent');
            const panel = document.getElementById('newsFeedPanel');
            if (content.style.display === 'none') {
                content.style.display = 'block';
                panel.style.maxHeight = '300px';
            } else {
                content.style.display = 'none';
                panel.style.maxHeight = '32px';
            }
        }

        // Drag news panel
        let isDraggingNews = false;
        let newsOffsetX, newsOffsetY;
        function startDragNewsPanel(e) {
            isDraggingNews = true;
            const panel = document.getElementById('newsFeedPanel');
            newsOffsetX = e.clientX - panel.offsetLeft;
            newsOffsetY = e.clientY - panel.offsetTop;
            document.addEventListener('mousemove', dragNewsPanel);
            document.addEventListener('mouseup', stopDragNewsPanel);
        }
        function dragNewsPanel(e) {
            if (!isDraggingNews) return;
            const panel = document.getElementById('newsFeedPanel');
            panel.style.left = (e.clientX - newsOffsetX) + 'px';
            panel.style.top = (e.clientY - newsOffsetY) + 'px';
        }
        function stopDragNewsPanel() {
            isDraggingNews = false;
            document.removeEventListener('mousemove', dragNewsPanel);
            document.removeEventListener('mouseup', stopDragNewsPanel);
        }

        // Refresh news feed every 15 seconds
        setInterval(refreshNewsTicker, 15000);
        // Load immediately
        refreshNewsTicker();
        loadTimestampedNewsLog();

        function filterNewsFeed() {
            loadNewsFeed();
        }

        function getImpactColor(impact) {
            const colors = {
                'critical': '#ef4444',
                'high': '#f59e0b',
                'medium': '#3b82f6',
                'low': '#666'
            };
            return colors[impact] || '#666';
        }

        function getSentimentBg(sentiment) {
            const colors = {
                'very_bullish': '#16a34a',
                'bullish': '#22c55e',
                'neutral': '#6b7280',
                'bearish': '#ef4444',
                'very_bearish': '#dc2626'
            };
            return colors[sentiment] || '#6b7280';
        }

        async function loadFundamentals() {
            const symbol = document.getElementById('fundamentalSymbol').value.toUpperCase();
            if (!symbol) return;

            try {
                const response = await fetch(API_BASE_URL + '/api/news/fundamentals/' + symbol + '/analysis');
                if (!response.ok) throw new Error('Failed to load fundamentals');
                const data = await response.json();

                document.getElementById('fundamentalsEmpty').style.display = 'none';
                document.getElementById('fundamentalsPanel').style.display = 'block';

                // Update ratings with colors
                const valuation = document.getElementById('fundValuation');
                valuation.textContent = (data.valuation_rating || 'N/A').replace('_', ' ').toUpperCase();
                valuation.style.color = data.valuation_rating?.includes('under') ? '#22c55e' :
                                        data.valuation_rating?.includes('over') ? '#ef4444' : '#888';

                const health = document.getElementById('fundHealth');
                health.textContent = (data.financial_health || 'N/A').toUpperCase();
                health.style.color = ['excellent', 'good'].includes(data.financial_health) ? '#22c55e' :
                                     ['poor', 'critical'].includes(data.financial_health) ? '#ef4444' : '#888';

                const growth = document.getElementById('fundGrowth');
                growth.textContent = (data.growth_outlook || 'N/A').replace('_', ' ').toUpperCase();
                growth.style.color = data.growth_outlook?.includes('growth') ? '#22c55e' :
                                     data.growth_outlook?.includes('declining') ? '#ef4444' : '#888';

                // Key metrics
                const metrics = data.key_metrics || {};
                document.getElementById('fundamentalMetrics').innerHTML = `
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 4px;">
                        <div>Market Cap: <span style="color: #fff;">${metrics.market_cap || 'N/A'}</span></div>
                        <div>P/E Ratio: <span style="color: #fff;">${metrics.pe_ratio?.toFixed(1) || 'N/A'}</span></div>
                        <div>PEG Ratio: <span style="color: #fff;">${metrics.peg_ratio?.toFixed(2) || 'N/A'}</span></div>
                        <div>Profit Margin: <span style="color: #fff;">${metrics.profit_margin || 'N/A'}</span></div>
                        <div>Revenue Growth: <span style="color: #fff;">${metrics.revenue_growth || 'N/A'}</span></div>
                        <div>Debt/Equity: <span style="color: #fff;">${metrics.debt_to_equity?.toFixed(2) || 'N/A'}</span></div>
                    </div>
                `;

                // Recommendation
                const recColor = data.recommendation === 'BULLISH' ? '#22c55e' :
                                 data.recommendation === 'BEARISH' ? '#ef4444' : '#888';
                document.getElementById('fundamentalRecommendation').innerHTML = `
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <span style="font-weight: 700; color: ${recColor};">${data.recommendation || 'NEUTRAL'}</span>
                        <span style="color: #888; font-size: 10px;">${data.recommendation_text || ''}</span>
                    </div>
                `;

            } catch (error) {
                console.error('Error loading fundamentals:', error);
                document.getElementById('fundamentalsEmpty').innerHTML = '<div style="color: #ef4444;">Error loading fundamentals</div>';
            }
        }

        async function loadEarningsCalendar() {
            try {
                const response = await fetch(API_BASE_URL + '/api/news/calendar/earnings');
                if (!response.ok) throw new Error('Failed to load earnings');
                const data = await response.json();

                const container = document.getElementById('earningsCalendar');
                if (data.events && data.events.length > 0) {
                    container.innerHTML = data.events.map(event => `
                        <div style="padding: 6px; background: #252525; border-radius: 3px; margin-bottom: 4px; display: flex; justify-content: space-between;">
                            <div>
                                <span style="font-weight: 600; color: #fff;">${event.symbol}</span>
                                <span style="color: #666; margin-left: 6px;">${event.company_name?.substring(0, 20) || ''}</span>
                            </div>
                            <div style="text-align: right;">
                                <span style="color: #f59e0b;">${new Date(event.report_date).toLocaleDateString()}</span>
                                <span style="color: #666; margin-left: 4px;">EPS Est: $${event.eps_estimate?.toFixed(2) || 'N/A'}</span>
                            </div>
                        </div>
                    `).join('');
                } else {
                    container.innerHTML = '<div style="padding: 8px; text-align: center; color: #666;">No upcoming earnings found</div>';
                }
            } catch (error) {
                console.error('Error loading earnings:', error);
            }
        }

        async function loadNewsTriggers() {
            try {
                const response = await fetch(API_BASE_URL + '/api/news/triggers');
                if (!response.ok) throw new Error('Failed to load triggers');
                const data = await response.json();

                const container = document.getElementById('newsTriggersList');
                if (data.triggers && data.triggers.length > 0) {
                    container.innerHTML = data.triggers.map(trigger => `
                        <div style="padding: 6px; background: #252525; border-radius: 3px; margin-bottom: 4px; display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <span style="color: ${trigger.enabled ? '#22c55e' : '#666'};">‚óè</span>
                                <span style="color: #fff; margin-left: 4px;">${trigger.name}</span>
                            </div>
                            <div style="display: flex; gap: 6px; align-items: center;">
                                <span style="font-size: 9px; color: #888;">${trigger.action.toUpperCase()}</span>
                                <button onclick="toggleNewsTrigger('${trigger.id}', ${!trigger.enabled})"
                                        style="padding: 2px 6px; background: ${trigger.enabled ? '#ef4444' : '#22c55e'}; border: none; color: #fff; font-size: 9px; border-radius: 2px; cursor: pointer;">
                                    ${trigger.enabled ? 'Disable' : 'Enable'}
                                </button>
                            </div>
                        </div>
                    `).join('');
                } else {
                    container.innerHTML = '<div style="padding: 8px; text-align: center; color: #666;">No triggers configured</div>';
                }
            } catch (error) {
                console.error('Error loading triggers:', error);
            }
        }

        async function toggleNewsTrigger(triggerId, enabled) {
            try {
                await fetch(API_BASE_URL + '/api/news/triggers/' + triggerId + '/enable?enabled=' + enabled, { method: 'PUT' });
                loadNewsTriggers();
            } catch (error) {
                console.error('Error toggling trigger:', error);
            }
        }

        async function startNewsMonitor() {
            try {
                const response = await fetch(API_BASE_URL + '/api/news/monitor/start', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ symbols: [], poll_interval: 30 })
                });
                const data = await response.json();
                document.getElementById('newsMonitorStatus').innerHTML = '<span style="color: #22c55e;">‚óè Monitoring</span>';
                showNotification('News monitor started', 'success');
            } catch (error) {
                console.error('Error starting monitor:', error);
                showNotification('Failed to start monitor', 'error');
            }
        }

        async function stopNewsMonitor() {
            try {
                await fetch(API_BASE_URL + '/api/news/monitor/stop', { method: 'POST' });
                document.getElementById('newsMonitorStatus').innerHTML = '<span style="color: #888;">‚ö™ Idle</span>';
                showNotification('News monitor stopped', 'info');
            } catch (error) {
                console.error('Error stopping monitor:', error);
            }
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        //                     STRATEGY LIBRARY FUNCTIONS
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        async function loadStrategyTemplates() {
            try {
                const response = await fetch(API_BASE_URL + '/api/strategies/templates');
                if (!response.ok) throw new Error('Failed to load templates');
                const data = await response.json();

                if (data.success && data.data) {
                    renderStrategyList(data.data, data.active_strategy);
                }
            } catch (error) {
                console.error('Error loading strategies:', error);
            }
        }

        function renderStrategyList(strategies, activeId) {
            const container = document.getElementById('strategyList');
            if (!container) return;

            const colors = {
                'momentum': '#22c55e',
                'mean_reversion': '#3b82f6',
                'breakout': '#f97316',
                'trend_following': '#8b5cf6',
                'gap_trading': '#ef4444',
                'vwap': '#06b6d4',
                'scalping': '#ec4899',
                'swing': '#a855f7',
                'custom': '#888'
            };

            const icons = {
                'momentum': 'üöÄ',
                'mean_reversion': 'üìà',
                'breakout': 'üí•',
                'trend_following': 'üåä',
                'gap_trading': 'üåÖ',
                'vwap': 'üß≤',
                'scalping': '‚ö°',
                'swing': 'üîÑ',
                'custom': '‚≠ê'
            };

            container.innerHTML = strategies.map(s => {
                const color = colors[s.strategy_type] || '#888';
                const icon = icons[s.strategy_type] || 'üìã';
                const isActive = s.id === activeId;

                return `
                    <div style="padding: 8px; background: #252525; border-left: 3px solid ${color}; border-radius: 3px; margin-bottom: 6px; cursor: pointer;" onclick="activateStrategy('${s.id}')">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <span style="color: ${color}; font-weight: 600; font-size: 12px;">${icon} ${s.name}</span>
                                ${isActive ? '<span style="margin-left: 8px; padding: 2px 6px; background: #22c55e; color: #000; font-size: 9px; border-radius: 2px;">ACTIVE</span>' : ''}
                            </div>
                            <span style="color: #666; font-size: 10px;">${s.strategy_type.toUpperCase().replace('_', ' ')}</span>
                        </div>
                        <div style="font-size: 10px; color: #888; margin-top: 4px;">${s.description?.substring(0, 50) || ''}${s.description?.length > 50 ? '...' : ''}</div>
                        <div style="display: flex; gap: 12px; margin-top: 4px; font-size: 9px; color: #666;">
                            <span>Win: ${s.performance?.win_rate ? (s.performance.win_rate * 100).toFixed(0) + '%' : '0%'}</span>
                            <span>PF: ${s.performance?.profit_factor?.toFixed(2) || '0.00'}</span>
                            <span>Trades: ${s.performance?.total_trades || 0}</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function activateStrategy(strategyId) {
            try {
                const response = await fetch(API_BASE_URL + '/api/strategies/activate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ strategy_id: strategyId, reason: 'manual' })
                });

                if (!response.ok) throw new Error('Failed to activate strategy');
                const data = await response.json();

                if (data.success) {
                    showNotification(`Activated strategy: ${strategyId}`, 'success');
                    loadStrategyTemplates();
                    loadActiveStrategy();
                }
            } catch (error) {
                showNotification('Failed to activate strategy', 'error');
            }
        }

        async function loadActiveStrategy() {
            try {
                const response = await fetch(API_BASE_URL + '/api/strategies/active');
                if (!response.ok) throw new Error('Failed to load active strategy');
                const data = await response.json();

                if (data.success && data.data) {
                    const s = data.data;
                    safeUpdate('activeStrategyName', s.name);
                    safeUpdate('strategyWinRate', s.performance?.win_rate ? (s.performance.win_rate * 100).toFixed(1) + '%' : '0.0%');
                    safeUpdate('strategyProfitFactor', s.performance?.profit_factor?.toFixed(2) || '0.00');
                }
            } catch (error) {
                console.error('Error loading active strategy:', error);
            }
        }

        async function evaluateCurrentStrategy() {
            try {
                const analysisDiv = document.getElementById('strategyAnalysis');
                if (analysisDiv) {
                    analysisDiv.innerHTML = '<div style="color: #f59e0b;">‚è≥ Evaluating strategy with Claude AI...</div>';
                }

                // Get active strategy first
                const activeResponse = await fetch(API_BASE_URL + '/api/strategies/active');
                const activeData = await activeResponse.json();

                if (!activeData.data) {
                    if (analysisDiv) {
                        analysisDiv.innerHTML = '<div style="color: #ef4444;">No active strategy to evaluate</div>';
                    }
                    return;
                }

                const response = await fetch(API_BASE_URL + '/api/strategies/evaluate/' + activeData.data.id + '?period_hours=24', {
                    method: 'POST'
                });

                if (!response.ok) throw new Error('Evaluation failed');
                const data = await response.json();

                if (data.success && data.data) {
                    const e = data.data;
                    if (analysisDiv) {
                        analysisDiv.innerHTML = `
                            <div style="color: #22c55e; font-weight: 600; margin-bottom: 8px;">üìä Strategy Evaluation Complete</div>
                            <div style="margin-bottom: 6px;">
                                <strong>Win Rate:</strong> ${e.win_rate}% | <strong>Profit Factor:</strong> ${e.profit_factor}
                            </div>
                            <div style="margin-bottom: 6px;">
                                <strong>Total Trades:</strong> ${e.total_trades} | <strong>Streak:</strong> ${e.streak > 0 ? '+' + e.streak : e.streak}
                            </div>
                            <div style="margin-bottom: 6px;">
                                <strong>Recommendation:</strong> <span style="color: ${e.recommendation === 'continue' ? '#22c55e' : '#f97316'};">${e.recommendation.toUpperCase()}</span>
                            </div>
                            <div style="border-top: 1px solid #404040; padding-top: 8px; margin-top: 8px;">
                                <strong>Claude Analysis:</strong><br>
                                ${e.claude_analysis || 'Analysis pending...'}
                            </div>
                        `;
                    }
                }
            } catch (error) {
                const analysisDiv = document.getElementById('strategyAnalysis');
                if (analysisDiv) {
                    analysisDiv.innerHTML = '<div style="color: #ef4444;">Evaluation failed: ' + error.message + '</div>';
                }
            }
        }

        async function getStrategyRecommendation() {
            try {
                const analysisDiv = document.getElementById('strategyAnalysis');
                if (analysisDiv) {
                    analysisDiv.innerHTML = '<div style="color: #8b5cf6;">ü§ñ Getting Claude AI recommendation...</div>';
                }

                // Get current regime from morphic
                let regime = 'range_bound';
                try {
                    const morphicResponse = await fetch(API_BASE_URL + '/api/morphic/regime');
                    const morphicData = await morphicResponse.json();
                    if (morphicData.success) {
                        regime = morphicData.regime;
                    }
                } catch (e) {}

                const response = await fetch(API_BASE_URL + '/api/strategies/recommend?regime=' + regime, {
                    method: 'POST'
                });

                if (!response.ok) throw new Error('Recommendation failed');
                const data = await response.json();

                if (data.success && data.data) {
                    const r = data.data;
                    if (analysisDiv) {
                        analysisDiv.innerHTML = `
                            <div style="color: #8b5cf6; font-weight: 600; margin-bottom: 8px;">ü§ñ Claude AI Recommendation</div>
                            <div style="margin-bottom: 6px;">
                                <strong>Current Regime:</strong> ${regime.replace('_', ' ').toUpperCase()}
                            </div>
                            <div style="margin-bottom: 6px;">
                                <strong>Keep Current:</strong> <span style="color: ${r.keep_current ? '#22c55e' : '#f97316'};">${r.keep_current ? 'YES' : 'NO'}</span>
                            </div>
                            ${r.recommended_strategy_id ? `<div style="margin-bottom: 6px;"><strong>Recommended:</strong> ${r.recommended_strategy_id}</div>` : ''}
                            <div style="margin-bottom: 6px;">
                                <strong>Confidence:</strong> ${(r.confidence * 100).toFixed(0)}%
                            </div>
                            <div style="border-top: 1px solid #404040; padding-top: 8px; margin-top: 8px;">
                                <strong>Reasoning:</strong><br>
                                ${r.reasoning || r.reason || 'No reasoning provided'}
                            </div>
                        `;
                    }
                }
            } catch (error) {
                const analysisDiv = document.getElementById('strategyAnalysis');
                if (analysisDiv) {
                    analysisDiv.innerHTML = '<div style="color: #ef4444;">Recommendation failed: ' + error.message + '</div>';
                }
            }
        }

        async function refineActiveStrategy() {
            try {
                const analysisDiv = document.getElementById('strategyAnalysis');
                if (analysisDiv) {
                    analysisDiv.innerHTML = '<div style="color: #22c55e;">üîß Refining strategy from winning patterns...</div>';
                }

                // Get active strategy
                const activeResponse = await fetch(API_BASE_URL + '/api/strategies/active');
                const activeData = await activeResponse.json();

                if (!activeData.data) {
                    if (analysisDiv) {
                        analysisDiv.innerHTML = '<div style="color: #ef4444;">No active strategy to refine</div>';
                    }
                    return;
                }

                const response = await fetch(API_BASE_URL + '/api/strategies/refine/' + activeData.data.id, {
                    method: 'POST'
                });

                if (!response.ok) throw new Error('Refinement failed');
                const data = await response.json();

                if (data.success && data.data) {
                    const r = data.data;
                    if (analysisDiv) {
                        analysisDiv.innerHTML = `
                            <div style="color: #22c55e; font-weight: 600; margin-bottom: 8px;">üîß Strategy Refinement Complete</div>
                            <div style="margin-bottom: 6px;">
                                <strong>Applied:</strong> <span style="color: ${r.applied ? '#22c55e' : '#f97316'};">${r.applied ? 'YES' : 'NO (low confidence)'}</span>
                            </div>
                            ${r.refinements?.pattern_insights ? `
                            <div style="margin-bottom: 6px;">
                                <strong>Pattern Insights:</strong><br>
                                ${r.refinements.pattern_insights.map(p => '‚Ä¢ ' + p).join('<br>')}
                            </div>
                            ` : ''}
                            ${r.refinements?.entry_refinements ? `
                            <div style="margin-bottom: 6px;">
                                <strong>Entry Refinements:</strong><br>
                                ${r.refinements.entry_refinements.map(e => '‚Ä¢ ' + e).join('<br>')}
                            </div>
                            ` : ''}
                        `;
                    }
                    showNotification('Strategy refined from winning patterns', 'success');
                }
            } catch (error) {
                const analysisDiv = document.getElementById('strategyAnalysis');
                if (analysisDiv) {
                    analysisDiv.innerHTML = '<div style="color: #ef4444;">Refinement failed: ' + error.message + '</div>';
                }
            }
        }

        async function feedTrainingData() {
            try {
                const response = await fetch(API_BASE_URL + '/api/strategies/feed-training', {
                    method: 'POST'
                });

                if (!response.ok) throw new Error('Feed failed');
                const data = await response.json();

                if (data.success) {
                    showNotification(`Fed ${data.data.patterns_saved || 0} winning patterns to training`, 'success');
                    const analysisDiv = document.getElementById('strategyAnalysis');
                    if (analysisDiv) {
                        analysisDiv.innerHTML = `
                            <div style="color: #f97316; font-weight: 600; margin-bottom: 8px;">üéØ Training Data Fed</div>
                            <div>Saved ${data.data.patterns_saved || 0} winning trade patterns for AI training.</div>
                            <div style="font-size: 10px; color: #888; margin-top: 8px;">File: ${data.data.file || 'N/A'}</div>
                        `;
                    }
                } else {
                    showNotification(data.data?.error || 'Not enough patterns', 'warning');
                }
            } catch (error) {
                showNotification('Failed to feed training data', 'error');
            }
        }

        async function loadSwitchHistory() {
            try {
                const response = await fetch(API_BASE_URL + '/api/strategies/switches?limit=10');
                if (!response.ok) throw new Error('Failed to load history');
                const data = await response.json();

                const container = document.getElementById('strategySwitchHistory');
                if (!container) return;

                if (data.success && data.data && data.data.length > 0) {
                    container.innerHTML = data.data.map(s => `
                        <div style="padding: 6px; background: #252525; border-radius: 3px; margin-bottom: 4px;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span style="color: #f97316;">${s.from_strategy} ‚Üí ${s.to_strategy}</span>
                                <span style="color: #666; font-size: 9px;">${new Date(s.timestamp).toLocaleString()}</span>
                            </div>
                            <div style="font-size: 9px; color: #888; margin-top: 2px;">${s.reason}</div>
                        </div>
                    `).join('');
                } else {
                    container.innerHTML = '<div style="padding: 6px; background: #252525; border-radius: 3px; color: #888;">No strategy switches recorded yet</div>';
                }
            } catch (error) {
                console.error('Error loading switch history:', error);
            }
        }

        async function startStrategyMonitor() {
            try {
                await fetch(API_BASE_URL + '/api/strategies/monitor/start', { method: 'POST' });
                showNotification('Strategy monitor started', 'success');
                const badge = document.getElementById('strategyMonitorBadge');
                if (badge) {
                    badge.textContent = 'MONITOR: ON';
                    badge.style.color = '#22c55e';
                }
            } catch (error) {
                showNotification('Failed to start monitor', 'error');
            }
        }

        async function stopStrategyMonitor() {
            try {
                await fetch(API_BASE_URL + '/api/strategies/monitor/stop', { method: 'POST' });
                showNotification('Strategy monitor stopped', 'info');
                const badge = document.getElementById('strategyMonitorBadge');
                if (badge) {
                    badge.textContent = 'MONITOR: OFF';
                    badge.style.color = '#888';
                }
            } catch (error) {
                showNotification('Failed to stop monitor', 'error');
            }
        }

        async function loadStrategyMonitorStatus() {
            try {
                const response = await fetch(API_BASE_URL + '/api/strategies/monitor/status');
                if (!response.ok) return;
                const data = await response.json();

                if (data.success && data.data) {
                    const badge = document.getElementById('strategyMonitorBadge');
                    if (badge) {
                        if (data.data.is_monitoring) {
                            badge.textContent = 'MONITOR: ON';
                            badge.style.color = '#22c55e';
                        } else {
                            badge.textContent = 'MONITOR: OFF';
                            badge.style.color = '#888';
                        }
                    }
                }
            } catch (error) {
                console.error('Error loading monitor status:', error);
            }
        }

        // TRAINING MODE FUNCTIONS
        function updateTrainingMode() {
            const mode = document.getElementById('trainMode').value;
            const singleInput = document.getElementById('singleSymbolInput');
            const multiInput = document.getElementById('multiSymbolInput');
            const timeValue = document.getElementById('trainTimeValue');

            if (mode === 'single') {
                singleInput.style.display = 'block';
                multiInput.style.display = 'none';
                timeValue.textContent = '~30 seconds';
            } else {
                singleInput.style.display = 'none';
                multiInput.style.display = 'block';
                if (mode === 'multi') timeValue.textContent = '~3 minutes';
                else if (mode === 'walkforward') timeValue.textContent = '~10 minutes';
                else if (mode === 'advanced') timeValue.textContent = '~15 minutes';
            }
        }

        // Advanced training function with multiple modes
        async function trainModelAdvanced() {
            const mode = document.getElementById('trainMode').value;
            const testSize = parseFloat(document.getElementById('trainTestSize').value) / 100;

            let endpoint, body;

            if (mode === 'single') {
                const symbol = document.getElementById('trainSymbol').value.toUpperCase();
                if (!symbol) {
                    alert('Please enter a training symbol');
                    return;
                }
                endpoint = '/api/ai/models/train';
                body = { symbol: symbol, test_size: testSize };
            } else {
                const symbolsStr = document.getElementById('trainSymbols').value;
                const symbols = symbolsStr.split(',').map(s => s.trim().toUpperCase()).filter(s => s);
                if (symbols.length === 0) {
                    alert('Please enter at least one symbol');
                    return;
                }

                if (mode === 'multi') {
                    endpoint = '/api/ai/train-multi';
                    body = { symbols: symbols, test_size: testSize };
                } else if (mode === 'walkforward') {
                    endpoint = '/api/ai/train-walkforward';
                    body = { symbols: symbols, train_months: 12, test_months: 3 };
                } else if (mode === 'advanced') {
                    endpoint = '/api/pipeline/train/advanced';
                    body = { symbols: symbols, model_type: 'lightgbm', optimize: true, n_trials: 30 };
                }
            }

            try {
                const btn = document.getElementById('trainModelBtn');
                btn.disabled = true;
                btn.textContent = '‚è≥ TRAINING...';

                document.getElementById('trainingStatus').style.display = 'block';
                document.getElementById('trainingMetrics').style.display = 'none';
                document.getElementById('trainingStatusText').textContent = 'Training in progress... This may take several minutes.';
                document.getElementById('trainingProgressBar').style.width = '50%';
                document.getElementById('trainingProgressText').textContent = 'Training...';

                const startTime = Date.now();

                const response = await fetch(API_BASE_URL + endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });

                const data = await response.json();
                const elapsedTime = ((Date.now() - startTime) / 1000).toFixed(1);
                console.log('Training result:', data);

                // Show results
                document.getElementById('trainingProgressBar').style.width = '100%';
                document.getElementById('trainingProgressText').textContent = '100%';

                if (data.success || data.metrics || data.accuracy) {
                    const metrics = data.data || data.metrics || data;
                    const accuracy = metrics.accuracy || metrics.metrics?.accuracy || 0;
                    const samples = metrics.samples || metrics.train_samples || '--';

                    document.getElementById('trainingStatusText').textContent = `Training completed in ${elapsedTime}s`;
                    document.getElementById('trainingMetrics').style.display = 'block';
                    document.getElementById('trainAccuracy').textContent = (accuracy * 100).toFixed(1) + '%';
                    document.getElementById('trainAccuracy').style.color = accuracy > 0.5 ? '#22c55e' : accuracy > 0.4 ? '#f59e0b' : '#ef4444';
                    document.getElementById('trainSamples').textContent = samples;
                } else {
                    document.getElementById('trainingStatusText').textContent = 'Training completed (check console for details)';
                }

                btn.disabled = false;
                btn.textContent = 'üöÄ START TRAINING';

            } catch (error) {
                console.error('Training error:', error);
                alert('Training error: ' + error.message);
                document.getElementById('trainModelBtn').disabled = false;
                document.getElementById('trainModelBtn').textContent = 'üöÄ START TRAINING';
            }
        }

        // Model status functions
        async function refreshModelStatus() {
            try {
                const response = await fetch(API_BASE_URL + '/api/ai/model-info');
                const data = await response.json();

                if (data.trained) {
                    document.getElementById('modelAccuracy').textContent = (data.accuracy * 100).toFixed(1) + '%';
                    document.getElementById('modelAccuracy').style.color = data.accuracy > 0.5 ? '#22c55e' : data.accuracy > 0.4 ? '#f59e0b' : '#ef4444';

                    const trainDate = new Date(data.training_date);
                    document.getElementById('modelTrainDate').textContent = trainDate.toLocaleDateString() + ' ' + trainDate.toLocaleTimeString();

                    if (data.top_features && data.top_features.length > 0) {
                        const featureNames = data.top_features.slice(0, 5).map(f => f.name).join(', ');
                        document.getElementById('topFeaturesList').textContent = featureNames;
                    }
                } else {
                    document.getElementById('modelAccuracy').textContent = '--';
                    document.getElementById('modelTrainDate').textContent = 'Not trained';
                    document.getElementById('topFeaturesList').textContent = 'Train a model first';
                }

                // Also fetch scheduler status
                refreshSchedulerStatus();
            } catch (error) {
                console.error('Error fetching model info:', error);
            }
        }

        async function refreshSchedulerStatus() {
            try {
                const response = await fetch(API_BASE_URL + '/api/pipeline/scheduler/status');
                const data = await response.json();

                if (data.success && data.data) {
                    const scheduler = data.data;
                    document.getElementById('pendingJobs').textContent = scheduler.pending_jobs || 0;

                    if (scheduler.next_scheduled) {
                        const nextTime = new Date(scheduler.next_scheduled);
                        document.getElementById('nextTrainTime').textContent = nextTime.toLocaleDateString() + ' ' + nextTime.toLocaleTimeString();
                    }
                }
            } catch (error) {
                console.error('Error fetching scheduler status:', error);
            }
        }

        // Regime detection
        async function detectRegime() {
            try {
                document.getElementById('regimeType').textContent = 'Detecting...';
                document.getElementById('regimeConfidence').textContent = 'Analyzing market data...';

                const response = await fetch(API_BASE_URL + '/api/pipeline/regime/detect');
                const data = await response.json();

                if (data.success && data.data) {
                    const regime = data.data;
                    const regimeNames = {
                        'bull_trend': 'üìà Bull Trend',
                        'bear_trend': 'üìâ Bear Trend',
                        'range_bound': '‚ÜîÔ∏è Range Bound',
                        'high_volatility': '‚ö° High Volatility',
                        'low_volatility': 'üò¥ Low Volatility',
                        'crisis': 'üö® Crisis',
                        'unknown': '‚ùì Unknown'
                    };

                    const regimeColors = {
                        'bull_trend': '#22c55e',
                        'bear_trend': '#ef4444',
                        'range_bound': '#f59e0b',
                        'high_volatility': '#ef4444',
                        'low_volatility': '#60a5fa',
                        'crisis': '#dc2626',
                        'unknown': '#666'
                    };

                    document.getElementById('regimeType').textContent = regimeNames[regime.regime] || regime.regime;
                    document.getElementById('regimeConfidence').textContent = `Confidence: ${(regime.confidence * 100).toFixed(1)}%`;
                    document.getElementById('regimeIndicator').style.background = regimeColors[regime.regime] || '#666';

                    // Show adjustments if available
                    const adjResponse = await fetch(API_BASE_URL + '/api/pipeline/regime/adjustments');
                    const adjData = await adjResponse.json();
                    if (adjData.success && adjData.data.adjustments) {
                        const adj = adjData.data.adjustments;
                        document.getElementById('regimeAdjustments').style.display = 'block';
                        document.getElementById('regimeAdjustmentsList').innerHTML = `
                            Position Size: ${(adj.position_size_multiplier * 100).toFixed(0)}%<br>
                            Confidence Threshold: ${adj.confidence_threshold > 0 ? '+' : ''}${(adj.confidence_threshold * 100).toFixed(0)}%
                        `;
                    }
                }
            } catch (error) {
                console.error('Error detecting regime:', error);
                document.getElementById('regimeType').textContent = 'Error';
                document.getElementById('regimeConfidence').textContent = error.message;
            }
        }

        // Drift detection
        async function checkDrift() {
            try {
                document.getElementById('driftSeverity').textContent = 'Checking...';
                document.getElementById('driftMessage').textContent = 'Analyzing data distributions...';

                const response = await fetch(API_BASE_URL + '/api/pipeline/drift/summary');
                const data = await response.json();

                if (data.success && data.data) {
                    const drift = data.data;

                    if (drift.message === 'No drift history') {
                        document.getElementById('driftSeverity').textContent = 'No Baseline';
                        document.getElementById('driftSeverity').style.color = '#888';
                        document.getElementById('driftIndicator').style.background = '#666';
                        document.getElementById('driftMessage').textContent = 'Set reference data first with training';
                    } else {
                        const severityColors = {
                            'none': '#22c55e',
                            'low': '#84cc16',
                            'medium': '#f59e0b',
                            'high': '#ef4444',
                            'critical': '#dc2626'
                        };

                        const shouldRetrain = drift.should_retrain?.[0] || false;
                        document.getElementById('driftSeverity').textContent = shouldRetrain ? 'Retrain Needed' : 'Stable';
                        document.getElementById('driftSeverity').style.color = shouldRetrain ? '#ef4444' : '#22c55e';
                        document.getElementById('driftIndicator').style.background = shouldRetrain ? '#ef4444' : '#22c55e';
                        document.getElementById('driftMessage').textContent = drift.should_retrain?.[1] || 'Model is stable';
                    }
                }
            } catch (error) {
                console.error('Error checking drift:', error);
                document.getElementById('driftSeverity').textContent = 'Error';
                document.getElementById('driftMessage').textContent = error.message;
            }
        }

        // TRAINING FUNCTIONS (legacy)
        async function trainModel() {
            const symbol = document.getElementById('trainSymbol').value.toUpperCase();
            const period = document.getElementById('trainPeriod').value;
            const testSize = parseFloat(document.getElementById('trainTestSize').value) / 100;

            if (!symbol) {
                alert('Please enter a training symbol');
                return;
            }

            try {
                // Disable button
                const btn = document.getElementById('trainModelBtn');
                btn.disabled = true;
                btn.textContent = '‚è≥ TRAINING...';

                // Show training status
                document.getElementById('trainingStatus').style.display = 'block';
                document.getElementById('trainingMetrics').style.display = 'none';

                const response = await fetch(API_BASE_URL + '/api/ai/models/train', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        symbol: symbol,
                        period: period,
                        test_size: testSize
                    })
                });

                const data = await response.json();
                console.log('Training started:', data);

                if (data.success && data.data.training_id) {
                    currentTrainingId = data.data.training_id;

                    // Start polling for progress
                    if (trainingCheckInterval) clearInterval(trainingCheckInterval);
                    trainingCheckInterval = setInterval(checkTrainingProgress, 1000);
                } else {
                    throw new Error('Failed to start training');
                }

            } catch (error) {
                console.error('Error starting training:', error);
                alert('Error starting training: ' + error.message);

                // Re-enable button
                const btn = document.getElementById('trainModelBtn');
                btn.disabled = false;
                btn.textContent = 'üöÄ START TRAINING';
            }
        }

        async function checkTrainingProgress() {
            if (!currentTrainingId) return;

            try {
                // Get training session status from server
                const response = await fetch(API_BASE_URL + '/api/ai/models/train/' + currentTrainingId + '/status');

                if (!response.ok) {
                    // Session might not exist yet, continue polling
                    return;
                }

                const data = await response.json();
                const session = data.session || {};

                // Update progress bar
                const progress = session.progress || 0;
                document.getElementById('trainingProgressBar').style.width = progress + '%';
                document.getElementById('trainingProgressText').textContent = progress + '%';

                // Update status text
                const statusText = session.status || 'training';
                document.getElementById('trainingStatusText').textContent = statusText.replace('_', ' ').toUpperCase();

                // Check if completed
                if (session.status === 'completed') {
                    clearInterval(trainingCheckInterval);
                    trainingCheckInterval = null;

                    // Show metrics
                    if (session.metrics) {
                        document.getElementById('trainAccuracy').textContent = (session.metrics.accuracy * 100).toFixed(2) + '%';
                        document.getElementById('trainSamples').textContent = session.metrics.samples || 0;
                        document.getElementById('trainingMetrics').style.display = 'block';
                    }

                    // Re-enable button
                    const btn = document.getElementById('trainModelBtn');
                    btn.disabled = false;
                    btn.textContent = 'üöÄ START TRAINING';

                    alert('‚úì Training completed!\n\nAccuracy: ' + (session.metrics.accuracy * 100).toFixed(2) + '%\nSamples: ' + session.metrics.samples);

                } else if (session.status === 'failed') {
                    clearInterval(trainingCheckInterval);
                    trainingCheckInterval = null;

                    document.getElementById('trainingStatusText').textContent = 'FAILED: ' + (session.error || 'Unknown error');

                    // Re-enable button
                    const btn = document.getElementById('trainModelBtn');
                    btn.disabled = false;
                    btn.textContent = 'üöÄ START TRAINING';

                    alert('‚úó Training failed: ' + (session.error || 'Unknown error'));
                }

            } catch (error) {
                console.error('Error checking training progress:', error);
            }
        }

        // PREDICTION FUNCTIONS
        async function predictWorklist() {
            const worklistDiv = document.getElementById('worklistPredictions');
            worklistDiv.innerHTML = '<div class="empty-state" style="padding: 20px;">Loading predictions...</div>';

            try {
                // Get worklist
                const worklistResponse = await fetch(API_BASE_URL + '/api/worklist');
                const worklistData = await worklistResponse.json();

                if (!worklistData.success || !worklistData.data.length) {
                    worklistDiv.innerHTML = '<div class="empty-state" style="padding: 20px;">Worklist is empty</div>';
                    return;
                }

                let html = '';

                // Get predictions for each symbol
                for (const item of worklistData.data) {
                    const symbol = item.symbol;

                    try {
                        const predResponse = await fetch(API_BASE_URL + '/api/ai/predict', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ symbol: symbol })
                        });

                        const predData = await predResponse.json();

                        // Determine color
                        let signalColor = '#888';
                        if (predData.signal && predData.signal.includes('BULLISH')) signalColor = '#22c55e';
                        else if (predData.signal && predData.signal.includes('BEARISH')) signalColor = '#ef4444';

                        html += `
                            <div style="padding: 8px; margin-bottom: 6px; background: #252525; border-radius: 3px; border-left: 3px solid ${signalColor};">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                                    <div style="font-size: 14px; font-weight: 700; color: #fff;">${symbol}</div>
                                    <div style="font-size: 13px; font-weight: 600; color: ${signalColor};">${predData.signal || 'NEUTRAL'}</div>
                                </div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 6px; font-size: 11px;">
                                    <div>
                                        <span style="color: #666;">Confidence:</span>
                                        <span style="color: #aaa; font-weight: 600;">${(predData.confidence * 100).toFixed(1)}%</span>
                                    </div>
                                    <div>
                                        <span style="color: #666;">Prob Up:</span>
                                        <span style="color: #aaa; font-weight: 600;">${(predData.prob_up * 100).toFixed(1)}%</span>
                                    </div>
                                </div>
                            </div>
                        `;

                    } catch (error) {
                        console.error('Error predicting', symbol, ':', error);
                        html += `
                            <div style="padding: 8px; margin-bottom: 6px; background: #252525; border-radius: 3px;">
                                <div style="font-size: 14px; font-weight: 700; color: #fff;">${symbol}</div>
                                <div style="font-size: 11px; color: #ef4444;">Prediction failed</div>
                            </div>
                        `;
                    }
                }

                worklistDiv.innerHTML = html;

            } catch (error) {
                console.error('Error getting worklist predictions:', error);
                worklistDiv.innerHTML = '<div class="empty-state" style="padding: 20px;">Error loading predictions</div>';
            }
        }

        async function predictSingle() {
            const symbol = document.getElementById('singlePredictSymbol').value.toUpperCase();

            if (!symbol) {
                alert('Please enter a symbol');
                return;
            }

            const resultDiv = document.getElementById('singlePredictionResult');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '<div style="padding: 12px; text-align: center; color: #888;">Loading...</div>';

            try {
                const response = await fetch(API_BASE_URL + '/api/ai/predict', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ symbol: symbol })
                });

                const data = await response.json();

                // Determine color
                let signalColor = '#888';
                if (data.signal && data.signal.includes('BULLISH')) signalColor = '#22c55e';
                else if (data.signal && data.signal.includes('BEARISH')) signalColor = '#ef4444';

                resultDiv.innerHTML = `
                    <div style="padding: 12px; background: #252525; border-radius: 4px; border-left: 4px solid ${signalColor};">
                        <div style="font-size: 18px; font-weight: 700; color: ${signalColor}; margin-bottom: 8px; text-align: center;">
                            ${data.signal || 'NEUTRAL'}
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 12px;">
                            <div style="text-align: center;">
                                <div style="font-size: 10px; color: #666; margin-bottom: 2px;">CONFIDENCE</div>
                                <div style="font-size: 20px; font-weight: 700; color: #fff;">${(data.confidence * 100).toFixed(1)}%</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 10px; color: #666; margin-bottom: 2px;">PROB UP</div>
                                <div style="font-size: 20px; font-weight: 700; color: #22c55e;">${(data.prob_up * 100).toFixed(1)}%</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 10px; color: #666; margin-bottom: 2px;">PROB DOWN</div>
                                <div style="font-size: 20px; font-weight: 700; color: #ef4444;">${(data.prob_down * 100).toFixed(1)}%</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 10px; color: #666; margin-bottom: 2px;">TIMESTAMP</div>
                                <div style="font-size: 11px; color: #aaa;">${new Date(data.timestamp).toLocaleTimeString()}</div>
                            </div>
                        </div>
                        ${data.signal_detail ? `<div style="margin-top: 8px; padding: 6px; background: #1a1a1a; border-radius: 3px; font-size: 11px; color: #888; text-align: center;">${data.signal_detail}</div>` : ''}
                    </div>
                `;

            } catch (error) {
                console.error('Error getting prediction:', error);
                resultDiv.innerHTML = '<div style="padding: 12px; color: #ef4444; text-align: center;">Prediction failed: ' + error.message + '</div>';
            }
        }

        // BACKTEST FUNCTIONS
        async function runBacktest() {
            const strategy = document.getElementById('backtestStrategy').value;
            const symbols = document.getElementById('backtestSymbols').value.split(',').map(s => s.trim().toUpperCase()).filter(s => s);
            const startDate = document.getElementById('backtestStartDate').value;
            const endDate = document.getElementById('backtestEndDate').value;
            const capital = parseFloat(document.getElementById('backtestCapital').value);
            const positionSize = parseFloat(document.getElementById('backtestPositionSize').value) / 100;

            if (!symbols.length || !startDate || !endDate) {
                alert('Please fill in all backtest parameters');
                return;
            }

            const btn = document.getElementById('runBacktestBtn');

            try {
                // Disable button
                btn.disabled = true;
                btn.textContent = '‚è≥ RUNNING BACKTEST...';

                // Show results section with loading state
                document.getElementById('backtestResults').style.display = 'block';
                document.getElementById('backtestMetrics').innerHTML = `
                    <div style="padding: 30px; text-align: center; color: #888; grid-column: span 2;">
                        <div style="font-size: 24px; margin-bottom: 10px;">‚è≥</div>
                        <div>Running backtest on ${symbols.length} symbol(s)...</div>
                        <div style="font-size: 11px; margin-top: 5px;">Using real historical data from Yahoo Finance</div>
                    </div>
                `;

                const response = await fetch(API_BASE_URL + '/api/backtest/run', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        strategy: strategy,
                        symbols: symbols,
                        start_date: startDate,
                        end_date: endDate,
                        initial_capital: capital,
                        position_size_pct: positionSize,
                        confidence_threshold: 0.15,
                        max_positions: 5,
                        holding_period: 5
                    })
                });

                const data = await response.json();
                console.log('Backtest result:', data);

                if (data.success && data.data) {
                    // Backend returns results directly - display them
                    displayBacktestResults(data.data);
                } else {
                    throw new Error(data.message || 'Backtest failed - check if AI model is trained');
                }

            } catch (error) {
                console.error('Error running backtest:', error);
                document.getElementById('backtestMetrics').innerHTML = `
                    <div style="padding: 20px; text-align: center; color: #ef4444; grid-column: span 2;">
                        <div style="font-size: 24px; margin-bottom: 10px;">‚ùå</div>
                        <div style="font-weight: 600;">Backtest Failed</div>
                        <div style="font-size: 12px; margin-top: 8px; color: #888;">${error.message}</div>
                        <div style="font-size: 11px; margin-top: 4px; color: #666;">Make sure the AI model is trained first (Training tab)</div>
                    </div>
                `;
            } finally {
                // Re-enable button
                btn.disabled = false;
                btn.textContent = 'üìä RUN BACKTEST';
            }
        }

        function displayBacktestResults(results) {
            // Results come directly from backtester.py with real Yahoo Finance data
            const r = results;

            // Calculate profit factor display
            const profitFactorDisplay = r.profit_factor >= 999 ? '‚àû' : r.profit_factor.toFixed(2);
            const profitFactorColor = r.profit_factor >= 1.5 ? '#22c55e' : (r.profit_factor >= 1 ? '#f59e0b' : '#ef4444');

            document.getElementById('backtestMetrics').innerHTML = `
                <div style="padding: 8px; background: #252525; border-radius: 3px; text-align: center;">
                    <div style="font-size: 10px; color: #666;">TOTAL RETURN</div>
                    <div style="font-size: 20px; font-weight: 700; color: ${r.total_return_percent >= 0 ? '#22c55e' : '#ef4444'};">
                        ${r.total_return_percent >= 0 ? '+' : ''}${r.total_return_percent.toFixed(2)}%
                    </div>
                    <div style="font-size: 10px; color: #888;">$${r.total_return.toLocaleString()}</div>
                </div>
                <div style="padding: 8px; background: #252525; border-radius: 3px; text-align: center;">
                    <div style="font-size: 10px; color: #666;">FINAL CAPITAL</div>
                    <div style="font-size: 20px; font-weight: 700; color: #60a5fa;">$${r.final_capital.toLocaleString()}</div>
                    <div style="font-size: 10px; color: #888;">from $${r.initial_capital.toLocaleString()}</div>
                </div>
                <div style="padding: 8px; background: #252525; border-radius: 3px; text-align: center;">
                    <div style="font-size: 10px; color: #666;">WIN RATE</div>
                    <div style="font-size: 20px; font-weight: 700; color: ${r.win_rate >= 50 ? '#22c55e' : '#ef4444'};">${r.win_rate.toFixed(1)}%</div>
                    <div style="font-size: 10px; color: #888;">${r.winning_trades}W / ${r.losing_trades}L</div>
                </div>
                <div style="padding: 8px; background: #252525; border-radius: 3px; text-align: center;">
                    <div style="font-size: 10px; color: #666;">PROFIT FACTOR</div>
                    <div style="font-size: 20px; font-weight: 700; color: ${profitFactorColor};">${profitFactorDisplay}</div>
                    <div style="font-size: 10px; color: #888;">gross profit/loss</div>
                </div>
                <div style="padding: 8px; background: #252525; border-radius: 3px; text-align: center;">
                    <div style="font-size: 10px; color: #666;">MAX DRAWDOWN</div>
                    <div style="font-size: 20px; font-weight: 700; color: #ef4444;">${r.max_drawdown_percent.toFixed(2)}%</div>
                    <div style="font-size: 10px; color: #888;">$${r.max_drawdown.toLocaleString()}</div>
                </div>
                <div style="padding: 8px; background: #252525; border-radius: 3px; text-align: center;">
                    <div style="font-size: 10px; color: #666;">SHARPE RATIO</div>
                    <div style="font-size: 20px; font-weight: 700; color: ${r.sharpe_ratio >= 1 ? '#22c55e' : '#f59e0b'};">${r.sharpe_ratio.toFixed(2)}</div>
                    <div style="font-size: 10px; color: #888;">risk-adjusted</div>
                </div>
                <div style="padding: 8px; background: #252525; border-radius: 3px; text-align: center;">
                    <div style="font-size: 10px; color: #666;">TOTAL TRADES</div>
                    <div style="font-size: 20px; font-weight: 700; color: #fff;">${r.total_trades}</div>
                    <div style="font-size: 10px; color: #888;">${r.start_date} to ${r.end_date}</div>
                </div>
                <div style="padding: 8px; background: #252525; border-radius: 3px; text-align: center;">
                    <div style="font-size: 10px; color: #666;">AVG TRADE P/L</div>
                    <div style="font-size: 20px; font-weight: 700; color: ${r.avg_trade_pnl >= 0 ? '#22c55e' : '#ef4444'};">$${r.avg_trade_pnl.toFixed(2)}</div>
                    <div style="font-size: 10px; color: #888;">W: $${r.avg_win.toFixed(0)} / L: $${r.avg_loss.toFixed(0)}</div>
                </div>
            `;

            // Show trade details if available
            if (r.trades && r.trades.length > 0) {
                let tradesHtml = '<div style="margin-top: 12px; padding: 10px; background: #1a1a1a; border: 1px solid #333; border-radius: 4px;">';
                tradesHtml += '<div style="font-size: 12px; color: #888; margin-bottom: 8px; font-weight: 700;">RECENT TRADES (Last 10)</div>';
                tradesHtml += '<div style="max-height: 200px; overflow-y: auto; font-size: 11px;">';

                const recentTrades = r.trades.slice(-10).reverse();
                for (const trade of recentTrades) {
                    const pnlColor = trade.pnl >= 0 ? '#22c55e' : '#ef4444';
                    const sideColor = trade.side === 'BUY' ? '#22c55e' : '#ef4444';
                    tradesHtml += `
                        <div style="padding: 6px; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <span style="font-weight: 600;">${trade.symbol}</span>
                                <span style="color: ${sideColor}; margin-left: 6px;">${trade.side}</span>
                                <span style="color: #666; margin-left: 6px;">${trade.quantity} shares</span>
                            </div>
                            <div style="text-align: right;">
                                <span style="color: ${pnlColor}; font-weight: 600;">$${trade.pnl.toFixed(2)}</span>
                                <span style="color: #888; margin-left: 4px;">(${trade.pnl_percent.toFixed(1)}%)</span>
                            </div>
                        </div>
                    `;
                }
                tradesHtml += '</div></div>';

                document.getElementById('backtestEquityCurve').innerHTML = tradesHtml;
            }

            // Show success notification
            showNotification(`Backtest complete: ${r.total_return_percent >= 0 ? '+' : ''}${r.total_return_percent.toFixed(2)}% return, ${r.win_rate.toFixed(1)}% win rate`,
                            r.total_return_percent >= 0 ? 'success' : 'warning');
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        //                     ENHANCED BACKTESTER FUNCTIONS
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        async function runEnhancedBacktest() {
            const symbols = document.getElementById('backtestSymbols').value.split(',').map(s => s.trim().toUpperCase()).filter(s => s);
            const startDate = document.getElementById('backtestStartDate').value;
            const endDate = document.getElementById('backtestEndDate').value;
            const capital = parseFloat(document.getElementById('backtestCapital').value);
            const positionSize = parseFloat(document.getElementById('backtestPositionSize').value) / 100;
            const stopLoss = parseFloat(document.getElementById('backtestStopLoss').value) / 100;
            const takeProfit = parseFloat(document.getElementById('backtestTakeProfit').value) / 100;
            const trailingStop = parseFloat(document.getElementById('backtestTrailingStop').value) / 100;
            const maxPositions = parseInt(document.getElementById('backtestMaxPositions').value);
            const includeSlippage = document.getElementById('backtestSlippage').checked;
            const eodLiquidation = document.getElementById('backtestEODLiquidation').checked;
            const runMonteCarlo = document.getElementById('backtestMonteCarlo').checked;

            if (!symbols.length || !startDate || !endDate) {
                alert('Please fill in all backtest parameters');
                return;
            }

            const btn = document.getElementById('runBacktestBtn');
            try {
                btn.disabled = true;
                btn.textContent = '‚è≥ RUNNING...';

                document.getElementById('backtestResults').style.display = 'block';
                document.getElementById('backtestMetrics').innerHTML = `
                    <div style="padding: 30px; text-align: center; color: #888; grid-column: span 4;">
                        <div style="font-size: 24px; margin-bottom: 10px;">‚è≥</div>
                        <div>Running enhanced backtest on ${symbols.length} symbol(s)...</div>
                        <div style="font-size: 11px; margin-top: 5px;">Slippage: ${includeSlippage ? 'ON' : 'OFF'} | EOD Liquidation: ${eodLiquidation ? 'ON' : 'OFF'} | Monte Carlo: ${runMonteCarlo ? '1000 sims' : 'OFF'}</div>
                    </div>
                `;

                const response = await fetch(API_BASE_URL + '/api/schwab/ai/backtest/run', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        symbols: symbols,
                        start_date: startDate,
                        end_date: endDate,
                        initial_capital: capital,
                        position_size_pct: positionSize,
                        stop_loss_pct: stopLoss,
                        take_profit_pct: takeProfit,
                        trailing_stop_pct: trailingStop,
                        max_positions: maxPositions,
                        include_slippage: includeSlippage,
                        eod_liquidation: eodLiquidation,
                        run_monte_carlo: runMonteCarlo,
                        monte_carlo_simulations: 1000
                    })
                });

                const data = await response.json();
                console.log('Enhanced backtest result:', data);

                if (data.success) {
                    displayEnhancedBacktestResults(data);
                } else {
                    throw new Error(data.error || 'Backtest failed');
                }
            } catch (error) {
                console.error('Error running enhanced backtest:', error);
                document.getElementById('backtestMetrics').innerHTML = `
                    <div style="padding: 20px; text-align: center; color: #ef4444; grid-column: span 4;">
                        <div style="font-size: 24px; margin-bottom: 10px;">‚ùå</div>
                        <div style="font-weight: 600;">Backtest Failed</div>
                        <div style="font-size: 12px; margin-top: 8px; color: #888;">${error.message}</div>
                    </div>
                `;
            } finally {
                btn.disabled = false;
                btn.textContent = 'üìä RUN BACKTEST';
            }
        }

        async function runQuickBacktest() {
            const symbols = document.getElementById('backtestSymbols').value.split(',').map(s => s.trim().toUpperCase()).filter(s => s);

            if (!symbols.length) {
                alert('Please enter at least one symbol');
                return;
            }

            const btn = document.getElementById('quickBacktestBtn');
            try {
                btn.disabled = true;
                btn.textContent = '‚è≥ RUNNING...';

                document.getElementById('backtestResults').style.display = 'block';
                document.getElementById('backtestMetrics').innerHTML = `
                    <div style="padding: 20px; text-align: center; color: #888; grid-column: span 4;">
                        <div style="font-size: 20px; margin-bottom: 8px;">‚ö°</div>
                        <div>Quick 30-day backtest...</div>
                    </div>
                `;

                const response = await fetch(API_BASE_URL + '/api/schwab/ai/backtest/quick', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ symbols: symbols, days: 30 })
                });

                const data = await response.json();
                if (data.success) {
                    displayEnhancedBacktestResults(data);
                } else {
                    throw new Error(data.error || 'Quick backtest failed');
                }
            } catch (error) {
                console.error('Error running quick backtest:', error);
                document.getElementById('backtestMetrics').innerHTML = `
                    <div style="padding: 20px; text-align: center; color: #ef4444; grid-column: span 4;">
                        ‚ùå ${error.message}
                    </div>
                `;
            } finally {
                btn.disabled = false;
                btn.textContent = '‚ö° QUICK (30 Days)';
            }
        }

        function displayEnhancedBacktestResults(data) {
            // Handle different response formats: data.data, data.result, data.results, or data directly
            const r = data.data || data.result || data.results || data;
            const summary = data.summary || r;

            // Handle both _pct and _percent naming conventions
            const totalReturn = summary.total_return_pct || r.total_return_pct || summary.total_return_percent || r.total_return_percent || 0;
            const finalCapital = r.final_capital || 0;
            const winRate = summary.win_rate || r.win_rate || 0;
            const maxDrawdown = summary.max_drawdown_pct || r.max_drawdown_pct || summary.max_drawdown_percent || r.max_drawdown_percent || 0;
            const sharpe = summary.sharpe_ratio || r.sharpe_ratio || 0;
            const profitFactor = summary.profit_factor || r.profit_factor || 0;
            const totalTrades = summary.total_trades || r.total_trades || 0;
            const slippageCost = r.total_slippage || r.total_slippage_cost || 0;
            const initialCapital = r.initial_capital || 10000;
            const winningTrades = r.winning_trades || 0;
            const losingTrades = r.losing_trades || 0;

            console.log('Parsed backtest results:', { totalReturn, finalCapital, winRate, maxDrawdown, totalTrades });

            const profitFactorDisplay = profitFactor >= 999 ? '‚àû' : profitFactor.toFixed(2);
            const profitFactorColor = profitFactor >= 1.5 ? '#22c55e' : (profitFactor >= 1 ? '#f59e0b' : '#ef4444');

            document.getElementById('backtestMetrics').innerHTML = `
                <div style="padding: 8px; background: #252525; border-radius: 3px; text-align: center;">
                    <div style="font-size: 10px; color: #666;">TOTAL RETURN</div>
                    <div style="font-size: 18px; font-weight: 700; color: ${totalReturn >= 0 ? '#22c55e' : '#ef4444'};">
                        ${totalReturn >= 0 ? '+' : ''}${totalReturn.toFixed(2)}%
                    </div>
                    <div style="font-size: 10px; color: #888;">$${(finalCapital - initialCapital).toLocaleString(undefined, {maximumFractionDigits: 0})}</div>
                </div>
                <div style="padding: 8px; background: #252525; border-radius: 3px; text-align: center;">
                    <div style="font-size: 10px; color: #666;">FINAL CAPITAL</div>
                    <div style="font-size: 18px; font-weight: 700; color: #60a5fa;">$${finalCapital.toLocaleString(undefined, {maximumFractionDigits: 0})}</div>
                    <div style="font-size: 10px; color: #888;">from $${initialCapital.toLocaleString()}</div>
                </div>
                <div style="padding: 8px; background: #252525; border-radius: 3px; text-align: center;">
                    <div style="font-size: 10px; color: #666;">WIN RATE</div>
                    <div style="font-size: 18px; font-weight: 700; color: ${winRate >= 50 ? '#22c55e' : '#f59e0b'};">${winRate.toFixed(1)}%</div>
                    <div style="font-size: 10px; color: #888;">${winningTrades}W / ${losingTrades}L</div>
                </div>
                <div style="padding: 8px; background: #252525; border-radius: 3px; text-align: center;">
                    <div style="font-size: 10px; color: #666;">MAX DRAWDOWN</div>
                    <div style="font-size: 18px; font-weight: 700; color: #ef4444;">${maxDrawdown.toFixed(2)}%</div>
                </div>
                <div style="padding: 8px; background: #252525; border-radius: 3px; text-align: center;">
                    <div style="font-size: 10px; color: #666;">SHARPE RATIO</div>
                    <div style="font-size: 18px; font-weight: 700; color: ${sharpe >= 1 ? '#22c55e' : '#f59e0b'};">${sharpe.toFixed(2)}</div>
                </div>
                <div style="padding: 8px; background: #252525; border-radius: 3px; text-align: center;">
                    <div style="font-size: 10px; color: #666;">PROFIT FACTOR</div>
                    <div style="font-size: 18px; font-weight: 700; color: ${profitFactorColor};">${profitFactorDisplay}</div>
                </div>
                <div style="padding: 8px; background: #252525; border-radius: 3px; text-align: center;">
                    <div style="font-size: 10px; color: #666;">TOTAL TRADES</div>
                    <div style="font-size: 18px; font-weight: 700; color: #fff;">${totalTrades}</div>
                </div>
                <div style="padding: 8px; background: #252525; border-radius: 3px; text-align: center;">
                    <div style="font-size: 10px; color: #666;">SLIPPAGE COST</div>
                    <div style="font-size: 18px; font-weight: 700; color: #f97316;">$${slippageCost.toFixed(2)}</div>
                </div>
            `;

            // Show exit reasons if available (API returns exits_by_reason)
            const exitReasons = r.exits_by_reason || r.exit_reasons;
            if (exitReasons) {
                const exitReasonsDiv = document.getElementById('backtestExitReasons');
                if (exitReasonsDiv) {
                    exitReasonsDiv.style.display = 'block';
                    exitReasonsDiv.innerHTML = `
                        <div style="font-size: 12px; color: #888; margin-bottom: 6px; font-weight: 600;">EXIT REASONS</div>
                        <div style="display: flex; flex-wrap: wrap; gap: 6px;">
                            ${Object.entries(exitReasons).map(([reason, count]) => `
                                <div style="padding: 4px 8px; background: #252525; border-radius: 3px; font-size: 11px;">
                                    <span style="color: #888;">${reason}:</span>
                                    <span style="color: #fff; font-weight: 600;">${count}</span>
                                </div>
                            `).join('')}
                        </div>
                    `;
                }
            }

            // Show Monte Carlo results if available
            if (data.monte_carlo) {
                const mc = data.monte_carlo;
                const mcDiv = document.getElementById('backtestMonteCarlo');
                mcDiv.style.display = 'block';
                mcDiv.innerHTML = `
                    <div style="padding: 10px; background: #1a1a2e; border: 1px solid #8b5cf6; border-radius: 4px;">
                        <div style="font-size: 12px; color: #8b5cf6; margin-bottom: 8px; font-weight: 600;">üé≤ MONTE CARLO ANALYSIS (${mc.simulations} simulations)</div>
                        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px;">
                            <div style="padding: 6px; background: #252525; border-radius: 3px; text-align: center;">
                                <div style="font-size: 10px; color: #666;">Profit Probability</div>
                                <div style="font-size: 14px; font-weight: 700; color: ${mc.probability_profit >= 50 ? '#22c55e' : '#ef4444'};">${mc.probability_profit.toFixed(1)}%</div>
                            </div>
                            <div style="padding: 6px; background: #252525; border-radius: 3px; text-align: center;">
                                <div style="font-size: 10px; color: #666;">Ruin Probability</div>
                                <div style="font-size: 14px; font-weight: 700; color: ${mc.probability_ruin <= 5 ? '#22c55e' : '#ef4444'};">${mc.probability_ruin.toFixed(1)}%</div>
                            </div>
                            <div style="padding: 6px; background: #252525; border-radius: 3px; text-align: center;">
                                <div style="font-size: 10px; color: #666;">Median Return</div>
                                <div style="font-size: 14px; font-weight: 700; color: ${mc.median_return >= 0 ? '#22c55e' : '#ef4444'};">${mc.median_return.toFixed(2)}%</div>
                            </div>
                            <div style="padding: 6px; background: #252525; border-radius: 3px; text-align: center;">
                                <div style="font-size: 10px; color: #666;">Worst Drawdown</div>
                                <div style="font-size: 14px; font-weight: 700; color: #ef4444;">${mc.worst_drawdown.toFixed(2)}%</div>
                            </div>
                        </div>
                        <div style="margin-top: 6px; font-size: 10px; color: #888; text-align: center;">
                            95% CI Return: ${mc.ci_95_return[0].toFixed(2)}% to ${mc.ci_95_return[1].toFixed(2)}%
                        </div>
                    </div>
                `;
            }

            showNotification(`Backtest complete: ${totalReturn >= 0 ? '+' : ''}${totalReturn.toFixed(2)}% return, ${winRate.toFixed(1)}% win rate`,
                            totalReturn >= 0 ? 'success' : 'warning');
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        //                     ENSEMBLE PREDICTOR FUNCTIONS
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        async function runEnsemblePrediction() {
            const symbol = document.getElementById('ensembleSymbol').value.trim().toUpperCase();
            if (!symbol) {
                alert('Please enter a symbol');
                return;
            }

            try {
                const response = await fetch(API_BASE_URL + '/api/schwab/ai/ensemble/predict/' + symbol);
                const data = await response.json();

                if (data.success) {
                    document.getElementById('ensembleResult').style.display = 'block';
                    document.getElementById('ensembleSymbolResult').textContent = data.symbol;

                    // Prediction badge
                    const predEl = document.getElementById('ensemblePrediction');
                    predEl.textContent = data.prediction;
                    predEl.style.background = data.prediction === 'BULLISH' ? '#22c55e' : '#ef4444';
                    predEl.style.color = '#fff';

                    // Confidence
                    const confPct = (data.confidence * 100).toFixed(0) + '%';
                    document.getElementById('ensembleConfidence').textContent = confPct;
                    document.getElementById('ensembleConfidence').style.color = data.confidence > 0.6 ? '#22c55e' : data.confidence > 0.4 ? '#f59e0b' : '#ef4444';

                    // Component scores
                    document.getElementById('ensembleLgbScore').textContent = (data.components.lgb.score * 100).toFixed(0) + '%';
                    document.getElementById('ensembleLgbWeight').textContent = (data.components.lgb.weight * 100).toFixed(0) + '% weight';

                    document.getElementById('ensembleHeurScore').textContent = (data.components.heuristic.score * 100).toFixed(0) + '%';
                    document.getElementById('ensembleHeurWeight').textContent = (data.components.heuristic.weight * 100).toFixed(0) + '% weight';

                    document.getElementById('ensembleMomScore').textContent = (data.components.momentum.score * 100).toFixed(0) + '%';
                    document.getElementById('ensembleMomWeight').textContent = (data.components.momentum.weight * 100).toFixed(0) + '% weight';

                    // Regime
                    document.getElementById('ensembleRegime').textContent = data.regime.type;

                    // Signals
                    const signalsHtml = data.signals.map(s => `<div style="padding: 4px 0; border-bottom: 1px solid #333;">‚Ä¢ ${s}</div>`).join('');
                    document.getElementById('ensembleSignals').innerHTML = signalsHtml;
                } else {
                    alert('Prediction failed: ' + (data.error || 'Unknown error'));
                }
            } catch (err) {
                console.error('Ensemble prediction error:', err);
                alert('Error: ' + err.message);
            }
        }

        async function runBatchEnsemble() {
            try {
                // Get symbols from watchlist
                const watchlistResponse = await fetch(API_BASE_URL + '/api/watchlist/default');
                const watchlistData = await watchlistResponse.json();
                const symbols = watchlistData.symbols || ['AAPL', 'MSFT', 'NVDA', 'TSLA', 'GOOGL'];

                const response = await fetch(API_BASE_URL + '/api/schwab/ai/ensemble/predict-batch', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ symbols: symbols.slice(0, 10) })
                });

                const data = await response.json();

                if (data.success) {
                    document.getElementById('batchEnsembleResults').style.display = 'block';

                    const html = data.predictions.map(p => {
                        if (p.error) {
                            return `<div style="padding: 8px; background: #252525; border-radius: 4px; margin-bottom: 4px; display: flex; justify-content: space-between;">
                                <span style="color: #888;">${p.symbol}</span>
                                <span style="color: #ef4444;">Error</span>
                            </div>`;
                        }

                        const color = p.prediction === 'BULLISH' ? '#22c55e' : '#ef4444';
                        return `<div style="padding: 8px; background: #252525; border-radius: 4px; margin-bottom: 4px; display: flex; justify-content: space-between; align-items: center;">
                            <span style="font-weight: 700; color: #fff;">${p.symbol}</span>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <span style="font-size: 10px; color: #666;">${p.regime}</span>
                                <span style="font-size: 11px; color: ${color};">${(p.confidence * 100).toFixed(0)}%</span>
                                <span style="padding: 2px 8px; border-radius: 3px; font-size: 10px; font-weight: 700; background: ${color}; color: #fff;">${p.prediction}</span>
                            </div>
                        </div>`;
                    }).join('');

                    document.getElementById('batchResultsContainer').innerHTML = html;
                }
            } catch (err) {
                console.error('Batch ensemble error:', err);
                alert('Error: ' + err.message);
            }
        }

        async function loadEnsemblePerformance() {
            try {
                const response = await fetch(API_BASE_URL + '/api/schwab/ai/ensemble/performance');
                const data = await response.json();

                if (data.success) {
                    document.getElementById('ensembleAccuracy').textContent = data.interpretation.accuracy;
                    document.getElementById('ensembleSampleSize').textContent = data.performance.total;
                }
            } catch (err) {
                console.error('Load ensemble performance error:', err);
            }
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        //                     RL AGENT FUNCTIONS
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        async function loadRLStatus() {
            try {
                const response = await fetch(API_BASE_URL + '/api/schwab/ai/rl/status');
                const data = await response.json();

                if (data.success) {
                    const s = data.status;
                    document.getElementById('rlPytorch').textContent = s.pytorch_available ? 'YES' : 'NO';
                    document.getElementById('rlPytorch').style.color = s.pytorch_available ? '#22c55e' : '#ef4444';
                    document.getElementById('rlEpisodes').textContent = s.episode || 0;
                    document.getElementById('rlEpsilon').textContent = (s.epsilon * 100).toFixed(1) + '%';
                }
            } catch (err) {
                console.error('Load RL status error:', err);
            }
        }

        async function runRLPrediction() {
            const symbol = document.getElementById('rlSymbol').value.trim().toUpperCase();
            if (!symbol) {
                alert('Please enter a symbol');
                return;
            }

            try {
                const response = await fetch(API_BASE_URL + '/api/schwab/ai/rl/predict/' + symbol);
                const data = await response.json();

                if (data.success) {
                    document.getElementById('rlResult').style.display = 'block';
                    document.getElementById('rlSymbolResult').textContent = data.symbol;
                    document.getElementById('rlPrice').textContent = '$' + data.current_price.toFixed(2);

                    // Action badge
                    const actionEl = document.getElementById('rlAction');
                    actionEl.textContent = data.action;
                    if (data.action === 'BUY') {
                        actionEl.style.background = '#22c55e';
                    } else if (data.action === 'SELL') {
                        actionEl.style.background = '#ef4444';
                    } else {
                        actionEl.style.background = '#666';
                    }
                    actionEl.style.color = '#fff';

                    // Probabilities
                    document.getElementById('rlProbHold').textContent = (data.probabilities.HOLD * 100).toFixed(0) + '%';
                    document.getElementById('rlProbBuy').textContent = (data.probabilities.BUY * 100).toFixed(0) + '%';
                    document.getElementById('rlProbSell').textContent = (data.probabilities.SELL * 100).toFixed(0) + '%';

                    // State features
                    const sf = data.state_features;
                    document.getElementById('rlStateFeatures').innerHTML =
                        `RSI: ${sf.rsi.toFixed(1)} | MACD: ${sf.macd.toFixed(4)} | Trend: ${(sf.trend * 100).toFixed(2)}% | Vol: ${(sf.volatility * 100).toFixed(1)}%`;
                } else {
                    alert('Prediction failed: ' + (data.error || 'Unknown error'));
                }
            } catch (err) {
                console.error('RL prediction error:', err);
                alert('Error: ' + err.message);
            }
        }

        async function trainRLAgent() {
            const symbolsStr = document.getElementById('rlTrainSymbols').value.trim();
            const episodes = parseInt(document.getElementById('rlTrainEpisodes').value) || 5;

            if (!symbolsStr) {
                alert('Please enter symbols');
                return;
            }

            const symbols = symbolsStr.split(',').map(s => s.trim().toUpperCase()).filter(s => s);

            document.getElementById('rlTrainBtn').disabled = true;
            document.getElementById('rlTrainBtn').textContent = 'Training...';
            document.getElementById('rlTrainStatus').style.display = 'block';
            document.getElementById('rlTrainStatus').innerHTML =
                '<span style="color: #f59e0b;">Training in progress... This may take a few minutes.</span>';

            try {
                const response = await fetch(API_BASE_URL + '/api/schwab/ai/rl/train', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ symbols, episodes, period: '1y' })
                });

                const data = await response.json();

                if (data.success) {
                    const summary = data.training_summary;
                    document.getElementById('rlTrainStatus').innerHTML =
                        `<span style="color: #22c55e;">Training complete!</span><br>` +
                        `Episodes: ${summary.total_episodes} | Avg Win Rate: ${(summary.avg_win_rate * 100).toFixed(1)}%<br>` +
                        `Total Trades: ${summary.total_trades} | Epsilon: ${(summary.epsilon_final * 100).toFixed(1)}%`;

                    // Refresh status
                    loadRLStatus();
                    showNotification('RL training complete!', 'success');
                } else {
                    document.getElementById('rlTrainStatus').innerHTML =
                        `<span style="color: #ef4444;">Training failed: ${data.error}</span>`;
                }
            } catch (err) {
                console.error('RL training error:', err);
                document.getElementById('rlTrainStatus').innerHTML =
                    `<span style="color: #ef4444;">Error: ${err.message}</span>`;
            }

            document.getElementById('rlTrainBtn').disabled = false;
            document.getElementById('rlTrainBtn').textContent = 'üöÄ Start Training';
        }

        async function resetRLAgent() {
            if (!confirm('Are you sure you want to reset the RL agent? All training will be lost!')) {
                return;
            }

            try {
                const response = await fetch(API_BASE_URL + '/api/schwab/ai/rl/reset', {
                    method: 'POST'
                });

                const data = await response.json();

                if (data.success) {
                    loadRLStatus();
                    showNotification('RL agent reset successfully', 'success');
                } else {
                    alert('Reset failed: ' + (data.error || 'Unknown error'));
                }
            } catch (err) {
                console.error('RL reset error:', err);
                alert('Error: ' + err.message);
            }
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        //                     RISK DASHBOARD FUNCTIONS
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        let riskWebSocket = null;

        async function loadRiskDashboard() {
            try {
                // Load full risk status
                const response = await fetch(API_BASE_URL + '/api/schwab/ai/portfolio-guard/status');
                const data = await response.json();

                if (data.success) {
                    updateRiskDisplay(data);
                }
            } catch (error) {
                console.error('Error loading risk dashboard:', error);
            }

            // Also load VAR details
            loadVARData();
        }

        async function loadVARData() {
            try {
                const response = await fetch(API_BASE_URL + '/api/schwab/ai/portfolio-guard/var');
                const data = await response.json();

                if (data.success && data.var) {
                    const v = data.var;
                    safeUpdate('var1Day95', `$${v.var_1day_95.toFixed(2)}`);
                    safeUpdate('var1Day95Pct', `${(v.var_pct_95 * 100).toFixed(2)}%`);
                    safeUpdate('var1Day99', `$${v.var_1day_99.toFixed(2)}`);
                    safeUpdate('var1Day99Pct', `${(v.var_pct_99 * 100).toFixed(2)}%`);
                    safeUpdate('var5Day95', `$${v.var_5day_95.toFixed(2)}`);
                    safeUpdate('var5Day95Pct', `${((v.var_5day_95 / (data.portfolio_value || 100000)) * 100).toFixed(2)}%`);
                    safeUpdate('varCVaR', `$${v.expected_shortfall.toFixed(2)}`);
                    safeUpdate('riskVar95', `$${v.var_1day_95.toFixed(0)}`);
                }
            } catch (error) {
                console.error('Error loading VAR data:', error);
            }
        }

        function updateRiskDisplay(data) {
            // Update risk level badge
            const badge = document.getElementById('riskLevelBadge');
            const banner = document.getElementById('riskStatusBanner');
            const level = data.risk_level || 'LOW';

            badge.textContent = level;
            const colors = {
                'LOW': { bg: '#22c55e', border: '#22c55e' },
                'MODERATE': { bg: '#f59e0b', border: '#f59e0b' },
                'HIGH': { bg: '#f97316', border: '#f97316' },
                'CRITICAL': { bg: '#ef4444', border: '#ef4444' }
            };
            const color = colors[level] || colors['LOW'];
            badge.style.background = color.bg;
            banner.style.borderColor = color.border;

            // Update summary metrics
            safeUpdate('riskVar95', `$${(data.var_95_dollars || 0).toFixed(0)}`);
            safeUpdate('riskDrawdown', `${((data.drawdown_pct || 0) * 100).toFixed(2)}%`);
            safeUpdate('riskMaxDD', `${((data.max_drawdown_pct || 0) * 100).toFixed(2)}%`);
            safeUpdate('riskEquity', `$${(data.equity || 0).toLocaleString(undefined, {maximumFractionDigits: 0})}`);

            // Update drawdown section
            if (data.drawdown) {
                const dd = data.drawdown;
                safeUpdate('ddPeakEquity', `$${(dd.peak_equity || 0).toLocaleString(undefined, {maximumFractionDigits: 0})}`);
                safeUpdate('ddCurrentEquity', `$${(dd.current_equity || 0).toLocaleString(undefined, {maximumFractionDigits: 0})}`);
                safeUpdate('ddDaysIn', dd.days_in_drawdown || 0);
                safeUpdate('ddRecoveryNeeded', `${((dd.recovery_needed_pct || 0) * 100).toFixed(2)}%`);

                const ddPct = (dd.drawdown_pct || 0) * 100;
                safeUpdate('ddProgressPct', `${ddPct.toFixed(2)}%`);
                const progressBar = document.getElementById('ddProgressBar');
                if (progressBar) {
                    progressBar.style.width = `${Math.min(ddPct / 15 * 100, 100)}%`;
                }
            }

            // Update concentration section
            if (data.concentration) {
                const c = data.concentration;
                safeUpdate('concLargestPos', `${((c.largest_position_pct || 0) * 100).toFixed(1)}%`);
                safeUpdate('concTop3', `${((c.top_3_concentration || 0) * 100).toFixed(1)}%`);
                safeUpdate('concSmallCap', `${((c.small_cap_exposure || 0) * 100).toFixed(1)}%`);
                safeUpdate('concDiversification', (c.diversification_ratio || 1).toFixed(2));
            }

            // Update risk flags
            const flagsDiv = document.getElementById('riskFlagsList');
            if (flagsDiv && data.risk_flags && data.risk_flags.length > 0) {
                flagsDiv.innerHTML = data.risk_flags.map(flag => `
                    <div style="padding: 6px 8px; background: rgba(239, 68, 68, 0.1); border: 1px solid #ef4444; border-radius: 3px; margin-bottom: 4px; color: #ef4444;">
                        ‚ö†Ô∏è ${flag}
                    </div>
                `).join('');
            } else if (flagsDiv) {
                flagsDiv.innerHTML = `
                    <div style="padding: 8px; background: #252525; border-radius: 4px; text-align: center; color: #22c55e;">
                        ‚úì No active risk flags
                    </div>
                `;
            }
        }

        function connectRiskWebSocket() {
            if (riskWebSocket && riskWebSocket.readyState === WebSocket.OPEN) {
                return;
            }

            const wsUrl = API_BASE_URL.replace('http', 'ws') + '/ws/realtime';
            riskWebSocket = new WebSocket(wsUrl);

            riskWebSocket.onopen = () => {
                console.log('Risk WebSocket connected');
                safeUpdate('riskWsStatus', 'Connected');
                document.getElementById('riskWsStatus').style.color = '#22c55e';

                // Subscribe to risk channel
                riskWebSocket.send(JSON.stringify({
                    action: 'subscribe',
                    channels: ['risk']
                }));
            };

            riskWebSocket.onmessage = (event) => {
                try {
                    const msg = JSON.parse(event.data);
                    if (msg.channel === 'risk') {
                        handleRiskUpdate(msg);
                    }
                } catch (e) {
                    console.error('Error parsing WebSocket message:', e);
                }
            };

            riskWebSocket.onclose = () => {
                console.log('Risk WebSocket disconnected');
                safeUpdate('riskWsStatus', 'Disconnected');
                document.getElementById('riskWsStatus').style.color = '#ef4444';
            };

            riskWebSocket.onerror = (error) => {
                console.error('Risk WebSocket error:', error);
            };
        }

        function handleRiskUpdate(msg) {
            if (msg.type === 'var') {
                safeUpdate('riskVar95', `$${msg.data.var_95_dollars.toFixed(0)}`);
            } else if (msg.type === 'drawdown') {
                safeUpdate('riskDrawdown', `${(msg.data.drawdown_pct * 100).toFixed(2)}%`);
                safeUpdate('riskMaxDD', `${(msg.data.max_drawdown_pct * 100).toFixed(2)}%`);
                if (msg.data.equity) {
                    safeUpdate('riskEquity', `$${msg.data.equity.toLocaleString(undefined, {maximumFractionDigits: 0})}`);
                }
            } else if (msg.type === 'circuit_breaker') {
                const badge = document.getElementById('riskLevelBadge');
                if (badge && !msg.data.can_trade) {
                    badge.textContent = 'HALTED';
                    badge.style.background = '#ef4444';
                }
            }
        }

        // Open AI Control Panel window
        function openAIControlPanel() {
            // Check if window already exists
            const existing = windows.find(w => w.id === 'aicontrol');
            if (existing) {
                existing.restore();
                existing.activate();
                return;
            }

            // Create new AI Control Panel window (centered, large size)
            createWindow('aicontrol', 'ü§ñ AI CONTROL PANEL', windowTemplates.aicontrol, 300, 100, 680, 600);
        }

        // Open AI Monitor window
        function openAIMonitor() {
            const existing = windows.find(w => w.id === 'aimonitor');
            if (existing) {
                existing.restore();
                existing.activate();
                return;
            }

            // Create compact AI Monitor window
            createWindow('aimonitor', 'üì° AI MONITOR', windowTemplates.aimonitor, 10, 10, 320, 280);
            // Initialize the monitor after DOM ready
            setTimeout(initAIMonitor, 100);
        }

        // Open Claude Chat window
        function openClaudeChatWindow() {
            const existing = windows.find(w => w.id === 'claudechat');
            if (existing) {
                existing.restore();
                existing.activate();
                // Refresh live status when reopening
                updateClaudeLiveStatus();
                return;
            }
            createWindow('claudechat', 'üí¨ CLAUDE AI CHAT', windowTemplates.claudechat, 1000, 100, 450, 550);
            // Initialize live monitoring after a brief delay to ensure DOM is ready
            setTimeout(initClaudeLiveMonitoring, 100);
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        //                     NEWS AUTO-TRADER PANEL
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        let newsTraderInterval = null;

        function openNewsTraderPanel() {
            const existing = windows.find(w => w.id === 'newstrader');
            if (existing) {
                existing.restore();
                existing.activate();
                return;
            }
            createWindow('newstrader', 'üì∞ BREAKING NEWS', windowTemplates.newsTrader, 100, 100, 420, 400);
            setTimeout(loadNewsFeedPanel, 100);
        }

        // Load news feed into the panel
        async function loadNewsFeedPanel() {
            try {
                // Use FinViz Elite for small cap momentum news with catalysts
                const response = await fetch('/api/news/finviz/elite/top-plays?limit=20');
                const data = await response.json();

                const feedEl = document.getElementById('newsFeedList');
                const countEl = document.getElementById('newsFeedCount');

                if (!feedEl) return;

                if (data.plays && data.plays.length > 0) {
                    // Calculate how long ago the scan was
                    const scanTime = data.scan_time ? new Date(data.scan_time) : new Date();
                    const now = new Date();
                    const minsAgo = Math.round((now - scanTime) / 60000);
                    const timeAgoStr = minsAgo < 1 ? 'just now' : minsAgo < 60 ? `${minsAgo}m ago` : `${Math.round(minsAgo/60)}h ago`;

                    if (countEl) countEl.textContent = `(${data.count}) ¬∑ ${timeAgoStr}`;

                    const items = data.plays.map(item => {
                        const symbol = item.symbol || '???';
                        const company = item.company || '';
                        const changePct = (item.change_pct || 0).toFixed(1);
                        const catalyst = item.catalyst_type || 'NEWS';
                        const score = (item.combined_score || 0).toFixed(0);
                        const headlines = item.news_headlines || [];
                        const headline = headlines[0] || company;
                        const secUrl = `https://www.sec.gov/cgi-bin/browse-edgar?action=getcompany&CIK=${symbol}&type=8-K&dateb=&owner=include&count=10`;

                        // Catalyst color
                        const catalystColor = catalyst === 'FDA' ? '#22c55e' :
                                              catalyst === 'EARNINGS' ? '#60a5fa' :
                                              catalyst === 'M&A' ? '#f59e0b' :
                                              catalyst === 'UPGRADE' ? '#22c55e' : '#888';
                        const changeColor = parseFloat(changePct) >= 0 ? '#22c55e' : '#ef4444';

                        // Format scan time as HH:MM
                        const timeStr = scanTime.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: false });

                        return `<div style="display: grid; grid-template-columns: 50px 55px 50px 1fr; gap: 8px; padding: 6px 10px; border-bottom: 1px solid #1a1a1a; align-items: center;" onmouseover="this.style.background='#151515'" onmouseout="this.style.background='transparent'">
                            <div style="color: #666; font-size: 11px;">${timeStr}</div>
                            <div style="text-align: center;">
                                <span style="color: ${changeColor}; font-weight: 700; font-size: 11px;">${changePct}%</span><br>
                                <span style="color: ${catalystColor}; font-size: 9px; font-weight: 600;">${catalyst}</span>
                            </div>
                            <a href="${secUrl}" target="_blank" onclick="event.stopPropagation(); setSymbol('${symbol}');" style="color: #00d4ff; font-weight: 700; text-decoration: none; font-size: 12px;" title="Click to load ${symbol} + view SEC filings">$${symbol}</a>
                            <div style="color: #ccc; line-height: 1.3; font-size: 11px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${headline}</div>
                        </div>`;
                    });

                    feedEl.innerHTML = items.join('');
                } else {
                    if (countEl) countEl.textContent = '(0)';
                    feedEl.innerHTML = '<div style="padding: 20px; color: #666; text-align: center;">No small cap movers with news. Market may be closed or FinViz API unavailable.</div>';
                }
            } catch (e) {
                console.error('Error loading news feed:', e);
                const feedEl = document.getElementById('newsFeedList');
                if (feedEl) feedEl.innerHTML = '<div style="padding: 20px; color: #666; text-align: center;">Error loading FinViz news feed</div>';
            }
        }

        // Auto-refresh news feed panel every 15 seconds
        setInterval(() => {
            if (document.getElementById('newsFeedList')) {
                loadNewsFeedPanel();
            }
        }, 15000);

        function initNewsTraderPanel() {
            updateNewsTraderStatus();
            // Poll every 3 seconds
            if (newsTraderInterval) clearInterval(newsTraderInterval);
            newsTraderInterval = setInterval(updateNewsTraderStatus, 3000);
        }

        async function updateNewsTraderStatus() {
            try {
                const response = await fetch('/api/scanner/news-trader/status');
                const data = await response.json();

                if (data.success) {
                    // Update status indicator
                    const statusDot = document.getElementById('newsTraderStatus');
                    const toggleBtn = document.getElementById('newsTraderToggle');
                    const modeDiv = document.getElementById('newsTraderMode');

                    if (statusDot) {
                        statusDot.style.background = data.is_running ? '#22c55e' : '#666';
                    }
                    if (toggleBtn) {
                        toggleBtn.textContent = data.is_running ? 'STOP' : 'START';
                        toggleBtn.style.background = data.is_running ? '#ef4444' : '#22c55e';
                    }
                    if (modeDiv) {
                        modeDiv.textContent = data.paper_mode ? 'PAPER' : 'LIVE';
                        modeDiv.style.background = data.paper_mode ? '#065f46' : '#7c2d12';
                        modeDiv.style.color = data.paper_mode ? '#10b981' : '#f97316';
                    }

                    // Update stats
                    const stats = data.stats || {};
                    updateElement('newsCount', stats.news_received || 0);
                    updateElement('candidateCount', stats.candidates_evaluated || 0);
                    updateElement('newsTradeCount', stats.trades_triggered || 0);
                    updateElement('filteredCount', stats.trades_filtered_out || 0);
                }

                // Also fetch candidates
                const candResponse = await fetch('/api/scanner/news-trader/candidates?limit=10');
                const candData = await candResponse.json();

                if (candData.success && candData.candidates) {
                    updateCandidateFeed(candData.candidates);
                }
            } catch (e) {
                console.error('News trader update error:', e);
            }
        }

        function updateElement(id, value) {
            const el = document.getElementById(id);
            if (el) el.textContent = value;
        }

        function updateCandidateFeed(candidates) {
            const feed = document.getElementById('newsCandidateFeed');
            if (!feed) return;

            if (candidates.length === 0) {
                feed.innerHTML = '<div style="padding: 8px; color: #666; text-align: center;">Waiting for news signals...</div>';
                return;
            }

            feed.innerHTML = candidates.map(c => {
                const passedColor = c.all_filters_passed ? '#22c55e' : '#ef4444';
                const passedText = c.all_filters_passed ? 'PASS' : 'FILTERED';
                const timeStr = new Date(c.news_detected_at).toLocaleTimeString();

                return `
                    <div style="padding: 6px 8px; border-bottom: 1px solid #222; background: ${c.all_filters_passed ? '#0a1a0a' : '#1a0a0a'};">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 3px;">
                            <span style="color: #60a5fa; font-weight: 600;">${c.symbol}</span>
                            <span style="color: ${passedColor}; font-size: 9px; font-weight: 600;">${passedText}</span>
                        </div>
                        <div style="color: #888; font-size: 9px; margin-bottom: 2px;">${(c.news_headline || '').substring(0, 60)}...</div>
                        <div style="display: flex; gap: 8px; font-size: 9px; color: #666;">
                            <span>Chronos: ${c.chronos_score ? (c.chronos_score * 100).toFixed(0) + '%' : '--'}</span>
                            <span>Qlib: ${c.qlib_score ? (c.qlib_score * 100).toFixed(0) + '%' : '--'}</span>
                            <span>Flow: ${c.order_flow_buy_pressure ? (c.order_flow_buy_pressure * 100).toFixed(0) + '%' : '--'}</span>
                            <span style="margin-left: auto;">${timeStr}</span>
                        </div>
                        ${c.rejection_reason ? `<div style="color: #f87171; font-size: 9px; margin-top: 2px;">‚ùå ${c.rejection_reason}</div>` : ''}
                    </div>
                `;
            }).join('');
        }

        async function toggleNewsTrader() {
            try {
                const response = await fetch('/api/scanner/news-trader/status');
                const data = await response.json();

                const endpoint = data.is_running ? '/api/scanner/news-trader/stop' : '/api/scanner/news-trader/start?paper_mode=true';
                await fetch(endpoint, { method: 'POST' });

                setTimeout(updateNewsTraderStatus, 500);
                showNotification(data.is_running ? 'News Trader stopped' : 'News Trader started (paper mode)', 'info');
            } catch (e) {
                showNotification('Error toggling news trader', 'error');
            }
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        //                     AI SIGNALS PANEL
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        function openAISignalsPanel() {
            const existing = windows.find(w => w.id === 'aisignals');
            if (existing) {
                existing.restore();
                existing.activate();
                return;
            }
            createWindow('aisignals', 'üìä AI SIGNALS', windowTemplates.aiSignals, 500, 100, 400, 350);
            setTimeout(refreshAISignals, 100);
        }

        async function refreshAISignals() {
            const table = document.getElementById('aiSignalsTable');
            if (!table) return;

            table.innerHTML = '<tr><td colspan="5" style="padding: 12px; text-align: center; color: #666;">Loading...</td></tr>';

            try {
                // Get watchlist symbols
                const wlResponse = await fetch('/api/worklist');
                const wlData = await wlResponse.json();

                // Extract symbols from data array
                const allSymbols = wlData.data ? wlData.data.map(s => s.symbol) : (wlData.symbols || []);
                if (!allSymbols || allSymbols.length === 0) {
                    table.innerHTML = '<tr><td colspan="5" style="padding: 12px; text-align: center; color: #666;">No symbols in watchlist</td></tr>';
                    return;
                }

                const symbols = allSymbols.slice(0, 10); // Limit to 10
                const rows = [];

                for (const sym of symbols) {
                    try {
                        // Get AI prediction
                        const predResponse = await fetch(`/api/stock/ai-prediction/${sym}`);
                        const predData = await predResponse.json();

                        // Get order flow
                        const flowResponse = await fetch(`/api/scanner/order-flow/${sym}`);
                        const flowData = await flowResponse.json();

                        // prob_up is already 0-100, buy_pressure is already 0-100
                        const chronosScore = predData.prob_up ? predData.prob_up.toFixed(0) : '--';
                        const qlibScore = predData.confidence ? predData.confidence.toFixed(0) : '--';
                        const flowScore = flowData.buy_pressure ? flowData.buy_pressure.toFixed(0) : '--';

                        // Determine overall signal
                        let signal = 'NEUTRAL';
                        let signalColor = '#888';

                        const chronosNum = parseFloat(chronosScore) || 50;
                        const qlibNum = parseFloat(qlibScore) || 50;
                        const flowNum = parseFloat(flowScore) || 50;

                        if (chronosNum >= 55 && qlibNum >= 52 && flowNum >= 55) {
                            signal = 'BUY';
                            signalColor = '#22c55e';
                        } else if (chronosNum < 45 || flowNum < 45) {
                            signal = 'AVOID';
                            signalColor = '#ef4444';
                        }

                        rows.push(`
                            <tr style="border-bottom: 1px solid #222;">
                                <td style="padding: 4px 6px; color: #60a5fa; font-weight: 600;">${sym}</td>
                                <td style="padding: 4px 6px; text-align: center; color: ${chronosNum >= 55 ? '#22c55e' : chronosNum < 45 ? '#ef4444' : '#888'};">${chronosScore}%</td>
                                <td style="padding: 4px 6px; text-align: center; color: ${qlibNum >= 52 ? '#22c55e' : qlibNum < 48 ? '#ef4444' : '#888'};">${qlibScore}%</td>
                                <td style="padding: 4px 6px; text-align: center; color: ${flowNum >= 55 ? '#22c55e' : flowNum < 45 ? '#ef4444' : '#888'};">${flowScore}%</td>
                                <td style="padding: 4px 6px; text-align: center; color: ${signalColor}; font-weight: 600;">${signal}</td>
                            </tr>
                        `);
                    } catch (e) {
                        rows.push(`
                            <tr style="border-bottom: 1px solid #222;">
                                <td style="padding: 4px 6px; color: #60a5fa;">${sym}</td>
                                <td colspan="4" style="padding: 4px 6px; text-align: center; color: #666;">Error loading</td>
                            </tr>
                        `);
                    }
                }

                table.innerHTML = rows.join('');
            } catch (e) {
                table.innerHTML = '<tr><td colspan="5" style="padding: 12px; text-align: center; color: #ef4444;">Error loading signals</td></tr>';
            }
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        //                     WARRIOR TRADING PANEL (Ross Cameron)
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        function openWarriorPanel() {
            const existing = windows.find(w => w.id === 'warrior');
            if (existing) {
                existing.restore();
                existing.activate();
                return;
            }
            createWindow('warrior', '‚öîÔ∏è WARRIOR TRADING', windowTemplates.warrior, 550, 80, 420, 450);
            setTimeout(refreshWarriorPanel, 100);
        }

        function switchWarriorTab(tab) {
            // Hide all tabs
            document.getElementById('warriorSignalsTab').style.display = 'none';
            document.getElementById('warriorPatternsTab').style.display = 'none';
            document.getElementById('warriorTapeTab').style.display = 'none';
            document.getElementById('warriorHaltsTab').style.display = 'none';

            // Reset all tab buttons
            document.querySelectorAll('.warrior-tab').forEach(btn => {
                btn.style.background = '#0a0a0a';
                btn.style.color = '#888';
            });

            // Show selected tab
            const tabElement = document.getElementById(`warrior${tab.charAt(0).toUpperCase() + tab.slice(1)}Tab`);
            if (tabElement) tabElement.style.display = 'block';

            // Highlight selected tab button
            const tabBtn = document.getElementById(`warriorTab${tab.charAt(0).toUpperCase() + tab.slice(1)}`);
            if (tabBtn) {
                tabBtn.style.background = '#1a1a1a';
                tabBtn.style.color = '#ef4444';
            }
        }

        async function refreshWarriorPanel() {
            const table = document.getElementById('warriorSignalsTable');
            if (!table) return;

            table.innerHTML = '<tr><td colspan="5" style="padding: 12px; text-align: center; color: #666;">Loading...</td></tr>';

            try {
                // Get watchlist symbols
                const wlResponse = await fetch('/api/worklist');
                const wlData = await wlResponse.json();

                const allSymbols = wlData.data ? wlData.data.map(s => s.symbol) : (wlData.symbols || []);
                if (!allSymbols || allSymbols.length === 0) {
                    table.innerHTML = '<tr><td colspan="5" style="padding: 12px; text-align: center; color: #666;">No symbols in watchlist</td></tr>';
                    return;
                }

                const symbols = allSymbols.slice(0, 15); // Limit to 15
                const rows = [];
                const patternRows = [];
                const tapeRows = [];
                const haltRows = [];

                // Batch analyze symbols
                const analyzeResponse = await fetch('/api/warrior/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ symbols: symbols })
                });
                const analyzeData = await analyzeResponse.json();

                if (analyzeData.signals) {
                    for (const signal of analyzeData.signals) {
                        const sym = signal.symbol;
                        const grade = signal.setup?.grade || 'C';
                        const confidence = signal.setup?.confidence || 0;
                        const pattern = signal.components?.pattern || '--';
                        const action = signal.action || 'WAIT';
                        const tapeSignal = signal.components?.tape || '--';
                        const haltWarning = signal.components?.halt_warning;

                        // Grade colors
                        const gradeColor = grade === 'A' ? '#22c55e' : grade === 'B' ? '#fbbf24' : '#ef4444';
                        const actionColor = action === 'BUY' ? '#22c55e' : action === 'WAIT' ? '#888' : '#ef4444';

                        rows.push(`
                            <tr style="border-bottom: 1px solid #222; cursor: pointer;" onclick="handleSymbolChange('${sym}')">
                                <td style="padding: 4px 6px; color: #60a5fa; font-weight: 600;">${sym}</td>
                                <td style="padding: 4px 6px; text-align: center;">
                                    <span style="color: ${gradeColor}; font-weight: 700; font-size: 12px;">${grade}</span>
                                </td>
                                <td style="padding: 4px 6px; text-align: center; color: #888;">${confidence.toFixed(0)}%</td>
                                <td style="padding: 4px 6px; text-align: center; color: ${pattern !== '--' ? '#a78bfa' : '#444'}; font-size: 9px;">${pattern.substring(0, 12)}</td>
                                <td style="padding: 4px 6px; text-align: center; color: ${actionColor}; font-weight: 600;">${action}</td>
                            </tr>
                        `);

                        // Patterns tab
                        if (pattern && pattern !== '--') {
                            patternRows.push(`
                                <div style="padding: 6px; margin-bottom: 4px; background: #1a1a1a; border-radius: 4px; border-left: 3px solid #a78bfa;">
                                    <div style="display: flex; justify-content: space-between;">
                                        <span style="color: #60a5fa; font-weight: 600;">${sym}</span>
                                        <span style="color: #a78bfa; font-size: 11px;">${pattern}</span>
                                    </div>
                                    <div style="color: #666; font-size: 9px; margin-top: 2px;">
                                        Entry: $${signal.trade?.entry?.toFixed(2) || '--'} | Stop: $${signal.trade?.stop?.toFixed(2) || '--'} | Target: $${signal.trade?.target?.toFixed(2) || '--'}
                                    </div>
                                </div>
                            `);
                        }

                        // Tape tab
                        if (tapeSignal && tapeSignal !== 'NO_SIGNAL' && tapeSignal !== '--') {
                            const tapeColor = tapeSignal.includes('BUY') || tapeSignal.includes('GREEN') ? '#22c55e' :
                                             tapeSignal.includes('SELL') || tapeSignal.includes('RED') ? '#ef4444' : '#fbbf24';
                            tapeRows.push(`
                                <div style="padding: 6px; margin-bottom: 4px; background: #1a1a1a; border-radius: 4px; border-left: 3px solid ${tapeColor};">
                                    <span style="color: #60a5fa; font-weight: 600;">${sym}</span>
                                    <span style="color: ${tapeColor}; margin-left: 8px; font-size: 10px;">${tapeSignal}</span>
                                </div>
                            `);
                        }

                        // Halts tab
                        if (haltWarning) {
                            haltRows.push(`
                                <div style="padding: 6px; margin-bottom: 4px; background: #1a0a0a; border-radius: 4px; border-left: 3px solid #ef4444;">
                                    <span style="color: #ef4444; font-weight: 600;">‚ö†Ô∏è ${sym}</span>
                                    <span style="color: #888; margin-left: 8px; font-size: 10px;">Near LULD Band</span>
                                </div>
                            `);
                        }
                    }
                }

                // Update signals table
                table.innerHTML = rows.length > 0 ? rows.join('') :
                    '<tr><td colspan="5" style="padding: 12px; text-align: center; color: #666;">No signals</td></tr>';

                // Update patterns tab
                const patternsContent = document.getElementById('warriorPatternsContent');
                if (patternsContent) {
                    patternsContent.innerHTML = patternRows.length > 0 ? patternRows.join('') :
                        '<div style="color: #666; text-align: center; padding: 20px;">No patterns detected</div>';
                }

                // Update tape tab
                const tapeContent = document.getElementById('warriorTapeContent');
                if (tapeContent) {
                    tapeContent.innerHTML = tapeRows.length > 0 ? tapeRows.join('') :
                        '<div style="color: #666; text-align: center; padding: 20px;">No tape signals</div>';
                }

                // Update halts tab
                const haltsContent = document.getElementById('warriorHaltsContent');
                if (haltsContent) {
                    haltsContent.innerHTML = haltRows.length > 0 ? haltRows.join('') :
                        '<div style="color: #666; text-align: center; padding: 20px;">No active halt warnings</div>';
                }

                // Also fetch active halts
                try {
                    const haltsResponse = await fetch('/api/warrior/halts');
                    const haltsData = await haltsResponse.json();
                    if (haltsData.halts && haltsData.halts.length > 0) {
                        const activeHaltRows = haltsData.halts.map(h => `
                            <div style="padding: 6px; margin-bottom: 4px; background: #2a0a0a; border-radius: 4px; border: 1px solid #ef4444;">
                                <div style="display: flex; justify-content: space-between;">
                                    <span style="color: #ef4444; font-weight: 700;">üõë ${h.symbol}</span>
                                    <span style="color: #fbbf24; font-size: 10px;">${h.halt_type || 'HALT'}</span>
                                </div>
                                <div style="color: #888; font-size: 9px; margin-top: 2px;">
                                    ${h.countdown ? `Countdown: ${h.countdown}s` : 'Active'}
                                </div>
                            </div>
                        `).join('');
                        if (haltsContent) {
                            haltsContent.innerHTML = activeHaltRows + (haltRows.length > 0 ? '<hr style="border-color: #333; margin: 8px 0;">' + haltRows.join('') : '');
                        }
                    }
                } catch (e) {
                    console.log('No halt data:', e);
                }

            } catch (e) {
                console.error('Error refreshing warrior panel:', e);
                table.innerHTML = '<tr><td colspan="5" style="padding: 12px; text-align: center; color: #ef4444;">Error loading signals</td></tr>';
            }
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        //                     LIGHTWEIGHT CHARTS
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        // Global chart state
        let lwChart = null;
        let lwCandleSeries = null;
        let lwVolumeSeries = null;
        let lwIndicatorSeries = {};
        let lwCurrentSymbol = 'AAPL';
        let lwCurrentTimeframe = '5m';
        let lwTradeMarkers = [];
        let lwMarkersPrimitive = null;  // v5 markers primitive

        // MACD series on main chart (not separate chart)
        let lwMacdLineSeries = null;
        let lwMacdSignalSeries = null;
        let lwMacdHistogramSeries = null;

        // Signal markers (EMA/MACD/VWAP crossovers)
        let lwSignalMarkersPrimitive = null;
        let lwSignalEvents = [];

        // Open AI Trade Chart window
        function openLWChart() {
            const existing = windows.find(w => w.id === 'lwchart');
            if (existing) {
                existing.restore();
                existing.activate();
                return;
            }
            createWindow('lwchart', 'üìà AI TRADE CHART', windowTemplates.lwchart, 100, 80, 800, 500);
            setTimeout(() => {
                initLWChart();
                loadLWChart();
            }, 100);
        }

        // Initialize Lightweight Chart
        function initLWChart() {
            const container = document.getElementById('lwchartContainer');
            if (!container || lwChart) return;

            // Check if LightweightCharts is available
            if (typeof LightweightCharts === 'undefined') {
                console.error('LightweightCharts library not loaded');
                container.innerHTML = '<div style="padding: 20px; color: #ef4444;">Error: Lightweight Charts library not loaded</div>';
                return;
            }

            lwChart = LightweightCharts.createChart(container, {
                layout: {
                    background: { color: '#0a0a0a' },
                    textColor: '#d1d4dc'
                },
                grid: {
                    vertLines: { color: '#1a1a1a' },
                    horzLines: { color: '#1a1a1a' }
                },
                crosshair: {
                    mode: LightweightCharts.CrosshairMode.Normal
                },
                rightPriceScale: {
                    borderColor: '#333'
                },
                timeScale: {
                    borderColor: '#333',
                    timeVisible: true,
                    secondsVisible: false
                }
            });

            lwCandleSeries = lwChart.addSeries(LightweightCharts.CandlestickSeries, {
                upColor: '#22c55e',
                downColor: '#ef4444',
                borderUpColor: '#22c55e',
                borderDownColor: '#ef4444',
                wickUpColor: '#22c55e',
                wickDownColor: '#ef4444'
            });

            // Volume as overlay - positioned above MACD area
            lwVolumeSeries = lwChart.addSeries(LightweightCharts.HistogramSeries, {
                priceFormat: { type: 'volume' },
                priceScaleId: 'volume'
            });
            lwChart.priceScale('volume').applyOptions({
                scaleMargins: { top: 0.70, bottom: 0.22 },  // Above MACD (70-78% area)
                visible: false
            });

            // Resize handler for main chart
            new ResizeObserver(() => {
                if (lwChart) lwChart.resize(container.offsetWidth, container.offsetHeight);
            }).observe(container);
        }

        // Volume as overlay on main chart (not separate)
        function toggleLWVolume() {
            const show = document.getElementById('lwShowVolume')?.checked;
            if (lwVolumeSeries) {
                lwVolumeSeries.applyOptions({ visible: show });
            }
        }

        // Jump to first trade marker
        async function jumpToTrades() {
            const status = document.getElementById('lwchartStatus');
            if (status) status.textContent = 'Loading trades...';

            // Force load trade markers
            await loadLWTradeMarkers();

            // If we have markers, scroll to the first one
            if (lwTradeMarkers && lwTradeMarkers.length > 0) {
                const firstTradeTime = lwTradeMarkers[0].time;
                if (lwChart) {
                    // Scroll to show first trade
                    lwChart.timeScale().scrollToRealTime();
                    setTimeout(() => {
                        lwChart.timeScale().scrollToPosition(-50, false);
                    }, 100);
                    status.textContent = `${lwTradeMarkers.length} markers loaded`;
                    status.style.color = '#22c55e';
                }
            } else {
                status.textContent = 'No trades for ' + lwCurrentSymbol;
                status.style.color = '#f59e0b';
            }
        }

        // Load chart data
        async function loadLWChart() {
            const symbolInput = document.getElementById('lwchartSymbol');
            const daysSelect = document.getElementById('lwchartDays');
            const status = document.getElementById('lwchartStatus');
            if (!symbolInput) return;

            lwCurrentSymbol = symbolInput.value.toUpperCase() || 'AAPL';
            const days = daysSelect ? parseInt(daysSelect.value) : 5;
            status.textContent = `Loading ${days} days...`;
            status.style.color = '#f59e0b';

            try {
                // Initialize chart if needed
                if (!lwChart) initLWChart();

                // Fetch OHLC data with days parameter
                const ohlcResp = await fetch(`/api/charts/ohlc/${lwCurrentSymbol}?timeframe=${lwCurrentTimeframe}&days=${days}`);
                const ohlcData = await ohlcResp.json();

                if (!ohlcData.success) {
                    throw new Error(ohlcData.error || 'Failed to load data');
                }

                // Reset markers primitive for new data
                lwMarkersPrimitive = null;

                // Set candlestick and volume data
                lwCandleSeries.setData(ohlcData.data);
                if (lwVolumeSeries) lwVolumeSeries.setData(ohlcData.volume);

                // Store the OHLC timestamps for marker alignment
                window.lwOhlcTimes = new Set(ohlcData.data.map(d => d.time));
                console.log('[AI Chart] OHLC loaded:', ohlcData.data.length, 'bars, time range:',
                    ohlcData.data[0]?.time, 'to', ohlcData.data[ohlcData.data.length-1]?.time);

                // Always try to load trade markers
                await loadLWTradeMarkers();

                // Refresh MACD if enabled - remove old series first
                if (document.getElementById('lwShowMACD')?.checked) {
                    // Remove existing MACD series to force reload
                    if (lwMacdHistogramSeries) {
                        lwChart.removeSeries(lwMacdHistogramSeries);
                        lwMacdHistogramSeries = null;
                    }
                    if (lwMacdLineSeries) {
                        lwChart.removeSeries(lwMacdLineSeries);
                        lwMacdLineSeries = null;
                    }
                    if (lwMacdSignalSeries) {
                        lwChart.removeSeries(lwMacdSignalSeries);
                        lwMacdSignalSeries = null;
                    }
                    await toggleLWMACD();
                }

                // Update window title
                const win = windows.find(w => w.id === 'lwchart');
                if (win && win.container) {
                    const header = win.container.querySelector('.window-header span');
                    if (header) header.textContent = `üìà AI CHART - ${lwCurrentSymbol}`;
                }

                status.textContent = `${ohlcData.count} bars`;
                status.style.color = '#22c55e';

            } catch (e) {
                console.error('Error loading LW chart:', e);
                status.textContent = 'Error: ' + e.message;
                status.style.color = '#ef4444';
            }
        }

        // Load trade markers
        async function loadLWTradeMarkers() {
            console.log('[AI Chart] loadLWTradeMarkers called for', lwCurrentSymbol, 'timeframe:', lwCurrentTimeframe);
            try {
                const resp = await fetch(`/api/charts/trades/${lwCurrentSymbol}?timeframe=${lwCurrentTimeframe}`);
                const data = await resp.json();
                console.log('[AI Chart] Trade API response:', data.success, 'markers:', data.markers?.length);

                if (data.success && data.markers && data.markers.length > 0) {
                    lwTradeMarkers = data.markers;

                    // Find the earliest trade timestamp to ensure OHLC covers it
                    const minTradeTime = Math.min(...data.markers.map(m => m.time));
                    const now = Math.floor(Date.now() / 1000);
                    const daysBack = Math.ceil((now - minTradeTime) / (60 * 60 * 24)) + 2;

                    // Use selected days or calculated days (whichever is greater)
                    const daysSelect = document.getElementById('lwchartDays');
                    const selectedDays = daysSelect ? parseInt(daysSelect.value) : 5;
                    const daysToFetch = Math.max(selectedDays, daysBack);
                    console.log(`[AI Chart] Trade data spans ${daysBack} days, user selected ${selectedDays}, fetching ${daysToFetch} days`);

                    // Show loading status
                    const status = document.getElementById('lwchartStatus');
                    if (status) {
                        status.textContent = `Loading ${data.summary.total_trades} trades (${daysToFetch} days)...`;
                        status.style.color = '#f59e0b';
                    }

                    // Re-fetch OHLC with enough history to cover trades (use days param)
                    const ohlcResp = await fetch(`/api/charts/ohlc/${lwCurrentSymbol}?timeframe=${lwCurrentTimeframe}&days=${daysToFetch}`);
                    const ohlcData = await ohlcResp.json();

                    if (ohlcData.success) {
                        // Reset markers primitive before setting new data
                        lwMarkersPrimitive = null;
                        lwCandleSeries.setData(ohlcData.data);
                        if (lwVolumeSeries) lwVolumeSeries.setData(ohlcData.volume);
                        // Update OHLC times after re-fetch
                        window.lwOhlcTimes = new Set(ohlcData.data.map(d => d.time));
                        document.getElementById('lwchartStatus').textContent = `${ohlcData.count} bars loaded`;
                        console.log('[AI Chart] Extended OHLC range:', ohlcData.data[0]?.time, 'to', ohlcData.data[ohlcData.data.length-1]?.time);
                    }

                    // Filter markers to only include timestamps that exist in OHLC data
                    const ohlcTimes = window.lwOhlcTimes || new Set();
                    const cleanMarkers = data.markers
                        .filter(m => ohlcTimes.has(m.time))  // Only markers with matching OHLC bars
                        .map(m => ({
                            time: m.time,
                            position: m.position,
                            color: m.color,
                            shape: m.shape,
                            text: m.text
                        }));

                    const skipped = data.markers.length - cleanMarkers.length;
                    console.log(`[AI Chart] ${cleanMarkers.length} markers match OHLC, ${skipped} skipped`);

                    if (cleanMarkers.length > 0) {
                        console.log('[AI Chart] Setting', cleanMarkers.length, 'markers');
                        console.log('[AI Chart] LightweightCharts exports:', Object.keys(LightweightCharts).filter(k => k.includes('arker')));

                        // v5 API: use createSeriesMarkers primitive
                        try {
                            if (lwMarkersPrimitive) {
                                lwMarkersPrimitive.setMarkers(cleanMarkers);
                                console.log('[AI Chart] Updated existing markers primitive');
                            } else if (typeof LightweightCharts.createSeriesMarkers === 'function') {
                                lwMarkersPrimitive = LightweightCharts.createSeriesMarkers(lwCandleSeries, cleanMarkers);
                                console.log('[AI Chart] Created new markers primitive');
                            } else {
                                console.error('[AI Chart] createSeriesMarkers not found!');
                            }
                        } catch (markerErr) {
                            console.error('[AI Chart] Marker error:', markerErr);
                        }
                    } else {
                        console.warn('[AI Chart] No markers match OHLC timestamps! Marker times:',
                            data.markers.slice(0,3).map(m => m.time));
                        // Clear markers
                        if (lwMarkersPrimitive) {
                            lwMarkersPrimitive.setMarkers([]);
                        } else if (lwCandleSeries?.setMarkers) {
                            lwCandleSeries.setMarkers([]);
                        }
                    }

                    // Scroll to first trade area
                    if (lwChart && cleanMarkers.length > 0) {
                        // Scroll to show trade markers (scroll back to start, then forward a bit)
                        lwChart.timeScale().scrollToRealTime();
                        setTimeout(() => lwChart.timeScale().scrollToPosition(-50, false), 100);
                    }

                    // Update summary with matched marker count
                    document.getElementById('lwTradeCount').textContent = `${data.summary.total_trades} (${cleanMarkers.length} visible)`;
                    document.getElementById('lwWinRate').textContent = data.summary.win_rate + '%';
                    document.getElementById('lwWinRate').style.color = data.summary.win_rate >= 50 ? '#22c55e' : '#ef4444';

                    const pnlEl = document.getElementById('lwTotalPnl');
                    pnlEl.textContent = (data.summary.total_pnl >= 0 ? '+' : '') + '$' + data.summary.total_pnl.toFixed(2);
                    pnlEl.style.color = data.summary.total_pnl >= 0 ? '#22c55e' : '#ef4444';
                } else {
                    // Clear markers using v5 API
                    if (lwMarkersPrimitive) lwMarkersPrimitive.setMarkers([]);
                    document.getElementById('lwTradeCount').textContent = '0';
                    document.getElementById('lwWinRate').textContent = '0%';
                    document.getElementById('lwTotalPnl').textContent = '$0.00';
                    // Show message that no trades found
                    const status = document.getElementById('lwchartStatus');
                    if (status) {
                        status.textContent = 'No trades for ' + lwCurrentSymbol;
                        status.style.color = '#888';
                    }
                }
            } catch (e) {
                console.error('Error loading trade markers:', e);
                const status = document.getElementById('lwchartStatus');
                if (status) {
                    status.textContent = 'Error loading trades: ' + e.message;
                    status.style.color = '#ef4444';
                }
            }
        }

        // Toggle trade markers
        function toggleLWTrades() {
            const show = document.getElementById('lwShowTrades')?.checked;
            if (show) {
                loadLWTradeMarkers();
            } else {
                // Clear markers using v5 API
                if (lwMarkersPrimitive) lwMarkersPrimitive.setMarkers([]);
            }
        }

        // Change timeframe
        function changeLWTimeframe(tf, btn) {
            lwCurrentTimeframe = tf;
            document.querySelectorAll('.lw-tf-btn').forEach(b => b.classList.remove('active'));
            if (btn) btn.classList.add('active');
            loadLWChart();
        }

        // Toggle indicator
        async function toggleLWIndicator(indicator) {
            // Map indicator to checkbox ID
            const checkboxIds = {
                'ema9': 'lwShowEMA9',
                'ema20': 'lwShowEMA20',
                'vwap': 'lwShowVWAP',
                'sma20': 'lwShowSMA20'
            };
            const checkbox = document.getElementById(checkboxIds[indicator] || 'lwShow' + indicator.toUpperCase());
            const show = checkbox?.checked;

            if (!show) {
                // Remove indicator
                if (lwIndicatorSeries[indicator]) {
                    lwChart.removeSeries(lwIndicatorSeries[indicator]);
                    delete lwIndicatorSeries[indicator];
                }
                return;
            }

            // Fetch indicator data with days
            const daysSelect = document.getElementById('lwchartDays');
            const days = daysSelect ? parseInt(daysSelect.value) : 5;

            try {
                const resp = await fetch(`/api/charts/indicators/${lwCurrentSymbol}?indicators=${indicator}&timeframe=${lwCurrentTimeframe}&days=${days}`);
                const data = await resp.json();

                if (data.success && data[indicator]) {
                    const colors = {
                        'sma20': '#3b82f6',
                        'ema9': '#f97316',
                        'ema20': '#3b82f6',
                        'vwap': '#a855f7'
                    };

                    if (indicator === 'rsi14') {
                        // RSI goes in separate pane
                        // For now just skip - requires more complex pane management
                        console.log('RSI pane not implemented yet');
                    } else {
                        // Add line series (v5 API)
                        lwIndicatorSeries[indicator] = lwChart.addSeries(LightweightCharts.LineSeries, {
                            color: colors[indicator] || '#888',
                            lineWidth: 1,
                            priceLineVisible: false,
                            lastValueVisible: false
                        });
                        lwIndicatorSeries[indicator].setData(data[indicator]);
                    }
                }
            } catch (e) {
                console.error('Error loading indicator:', e);
            }
        }

        // Toggle MACD - embedded in main chart below volume
        async function toggleLWMACD() {
            const checkbox = document.getElementById('lwShowMACD');
            const show = checkbox?.checked;

            if (!show) {
                // Remove MACD series from main chart
                if (lwMacdHistogramSeries) {
                    lwChart.removeSeries(lwMacdHistogramSeries);
                    lwMacdHistogramSeries = null;
                }
                if (lwMacdLineSeries) {
                    lwChart.removeSeries(lwMacdLineSeries);
                    lwMacdLineSeries = null;
                }
                if (lwMacdSignalSeries) {
                    lwChart.removeSeries(lwMacdSignalSeries);
                    lwMacdSignalSeries = null;
                }
                return;
            }

            if (!lwChart) {
                console.error('Main chart not initialized');
                return;
            }

            // Use same days as main chart
            const daysSelect = document.getElementById('lwchartDays');
            const days = daysSelect ? parseInt(daysSelect.value) : 5;

            try {
                // Fetch MACD data
                const resp = await fetch(`/api/charts/indicators/${lwCurrentSymbol}?indicators=macd&timeframe=${lwCurrentTimeframe}&days=${days}`);
                const data = await resp.json();

                if (!data.success || !data.macd) {
                    console.error('Failed to load MACD data');
                    return;
                }

                // Create MACD series on main chart with dedicated price scale
                if (!lwMacdHistogramSeries) {
                    // MACD Histogram - at bottom of chart
                    lwMacdHistogramSeries = lwChart.addSeries(LightweightCharts.HistogramSeries, {
                        priceScaleId: 'macd',
                        priceLineVisible: false,
                        lastValueVisible: false
                    });

                    // MACD Line (blue)
                    lwMacdLineSeries = lwChart.addSeries(LightweightCharts.LineSeries, {
                        priceScaleId: 'macd',
                        color: '#2563eb',
                        lineWidth: 1,
                        priceLineVisible: false,
                        lastValueVisible: false
                    });

                    // Signal Line (orange)
                    lwMacdSignalSeries = lwChart.addSeries(LightweightCharts.LineSeries, {
                        priceScaleId: 'macd',
                        color: '#f97316',
                        lineWidth: 1,
                        priceLineVisible: false,
                        lastValueVisible: false
                    });

                    // Configure MACD price scale - position at bottom below volume
                    lwChart.priceScale('macd').applyOptions({
                        scaleMargins: { top: 0.8, bottom: 0 },  // Bottom 20% of chart
                        borderVisible: false
                    });
                }

                // Prepare MACD data
                const macdLineData = data.macd.map(d => ({ time: d.time, value: d.macd }));
                const signalData = data.macd.map(d => ({ time: d.time, value: d.signal }));
                const histogramData = data.macd.map(d => ({
                    time: d.time,
                    value: d.histogram,
                    color: d.histogram >= 0 ? '#26a69a80' : '#ef535080'  // Semi-transparent
                }));

                // Set data
                lwMacdHistogramSeries.setData(histogramData);
                lwMacdLineSeries.setData(macdLineData);
                lwMacdSignalSeries.setData(signalData);

                console.log('[AI Chart] MACD embedded in main chart');

            } catch (e) {
                console.error('Error loading MACD:', e);
            }
        }

        // Toggle Signal markers (EMA/MACD/VWAP crossovers)
        async function toggleLWSignals() {
            const checkbox = document.getElementById('lwShowSignals');
            const show = checkbox?.checked;
            const signalBar = document.getElementById('lwSignalBar');

            if (!show) {
                // Hide signal bar and clear markers
                if (signalBar) signalBar.style.display = 'none';
                if (lwSignalMarkersPrimitive) {
                    lwSignalMarkersPrimitive.setMarkers([]);
                }
                return;
            }

            // Show signal bar
            if (signalBar) signalBar.style.display = 'block';

            if (!lwChart || !lwCandleSeries) {
                console.error('Chart not initialized');
                return;
            }

            // Use same days as main chart
            const daysSelect = document.getElementById('lwchartDays');
            const days = daysSelect ? parseInt(daysSelect.value) : 5;

            try {
                // Fetch signal events
                const eventsResp = await fetch(`/api/charts/signals/${lwCurrentSymbol}/events?timeframe=${lwCurrentTimeframe}&days=${days}`);
                const eventsData = await eventsResp.json();

                // Fetch current signal state
                const stateResp = await fetch(`/api/charts/signals/${lwCurrentSymbol}?timeframe=${lwCurrentTimeframe}&days=${days}`);
                const stateData = await stateResp.json();

                // Update signal status bar
                if (stateData.success && stateData.signals) {
                    const s = stateData.signals;

                    // Confluence score with color
                    const confEl = document.getElementById('lwConfluenceScore');
                    confEl.textContent = s.confluence_score + '%';
                    confEl.style.color = s.confluence_score >= 60 ? '#22c55e' : s.confluence_score >= 40 ? '#eab308' : '#ef4444';

                    // Signal bias
                    const biasEl = document.getElementById('lwSignalBias');
                    biasEl.textContent = s.signal_bias;
                    biasEl.style.color = s.signal_bias.includes('BUY') ? '#22c55e' : s.signal_bias.includes('SELL') ? '#ef4444' : '#888';

                    // EMA state
                    const emaEl = document.getElementById('lwEmaState');
                    emaEl.textContent = s.ema_bullish ? '9>20' : '9<20';
                    emaEl.style.color = s.ema_bullish ? '#22c55e' : '#ef4444';

                    // MACD state
                    const macdEl = document.getElementById('lwMacdState');
                    macdEl.textContent = s.macd_bullish ? 'Bull' : 'Bear';
                    macdEl.style.color = s.macd_bullish ? '#22c55e' : '#ef4444';

                    // VWAP state
                    const vwapEl = document.getElementById('lwVwapState');
                    vwapEl.textContent = s.price_above_vwap ? 'Above' : 'Below';
                    vwapEl.style.color = s.price_above_vwap ? '#22c55e' : '#ef4444';
                }

                // Add signal markers
                if (eventsData.success && eventsData.markers && eventsData.markers.length > 0) {
                    lwSignalEvents = eventsData.events;

                    // Filter markers to match OHLC timestamps
                    const ohlcTimes = window.lwOhlcTimes || new Set();
                    const cleanMarkers = eventsData.markers
                        .filter(m => ohlcTimes.has(m.time))
                        .map(m => ({
                            time: m.time,
                            position: m.position,
                            color: m.color,
                            shape: m.shape,
                            text: m.text,
                            size: m.size || 1
                        }));

                    console.log(`[AI Chart] ${cleanMarkers.length} signal markers loaded`);

                    // Create signal markers primitive
                    if (cleanMarkers.length > 0) {
                        if (lwSignalMarkersPrimitive) {
                            lwSignalMarkersPrimitive.setMarkers(cleanMarkers);
                        } else if (typeof LightweightCharts.createSeriesMarkers === 'function') {
                            lwSignalMarkersPrimitive = LightweightCharts.createSeriesMarkers(lwCandleSeries, cleanMarkers);
                        }
                    }
                }

            } catch (e) {
                console.error('Error loading signals:', e);
            }
        }

        // Open Equity Curve window
        function openEquityCurve() {
            const existing = windows.find(w => w.id === 'equitycurve');
            if (existing) {
                existing.restore();
                existing.activate();
                return;
            }
            createWindow('equitycurve', 'üí∞ EQUITY CURVE', windowTemplates.equitycurve, 150, 100, 600, 400);
            setTimeout(loadEquityCurve, 100);
        }

        // Load equity curve
        let eqChart = null;
        let eqAreaSeries = null;

        async function loadEquityCurve() {
            const container = document.getElementById('equityCurveContainer');
            if (!container) return;

            try {
                // Initialize chart if needed
                if (!eqChart) {
                    eqChart = LightweightCharts.createChart(container, {
                        layout: { background: { color: '#0a0a0a' }, textColor: '#d1d4dc' },
                        grid: { vertLines: { color: '#1a1a1a' }, horzLines: { color: '#1a1a1a' } },
                        rightPriceScale: { borderColor: '#333' },
                        timeScale: { borderColor: '#333', timeVisible: true }
                    });

                    eqAreaSeries = eqChart.addSeries(LightweightCharts.AreaSeries, {
                        lineColor: '#2563eb',
                        topColor: 'rgba(37, 99, 235, 0.4)',
                        bottomColor: 'rgba(37, 99, 235, 0.0)',
                        lineWidth: 2
                    });

                    new ResizeObserver(() => {
                        if (eqChart) eqChart.resize(container.offsetWidth, container.offsetHeight);
                    }).observe(container);
                }

                // Fetch equity curve data
                const resp = await fetch('/api/charts/equity-curve');
                const data = await resp.json();

                if (data.success) {
                    eqAreaSeries.setData(data.curve);

                    // Update stats
                    document.getElementById('eqInitial').textContent = '$' + data.initial_capital.toFixed(0);
                    document.getElementById('eqCurrent').textContent = '$' + data.final_equity.toFixed(2);
                    document.getElementById('eqCurrent').style.color = data.total_pnl >= 0 ? '#22c55e' : '#ef4444';

                    const pnlEl = document.getElementById('eqTotalPnl');
                    pnlEl.textContent = (data.total_pnl >= 0 ? '+' : '') + '$' + data.total_pnl.toFixed(2);
                    pnlEl.style.color = data.total_pnl >= 0 ? '#22c55e' : '#ef4444';

                    document.getElementById('eqMaxDD').textContent = '-' + data.max_drawdown_pct.toFixed(1) + '%';
                    document.getElementById('eqWinRate').textContent = data.win_rate.toFixed(1) + '%';
                }
            } catch (e) {
                console.error('Error loading equity curve:', e);
            }
        }

        // Open Backtest View window
        function openBacktestView() {
            const existing = windows.find(w => w.id === 'backtestview');
            if (existing) {
                existing.restore();
                existing.activate();
                return;
            }
            createWindow('backtestview', 'üî¨ BACKTEST VIEW', windowTemplates.backtestview, 200, 120, 700, 500);
            setTimeout(loadBacktestView, 100);
        }

        // Load backtest view
        async function loadBacktestView() {
            const status = document.getElementById('backtestStatus');
            const symbolInput = document.getElementById('backtestSymbol');
            const symbol = symbolInput?.value?.toUpperCase() || 'ALL';

            status.textContent = 'Loading...';
            status.style.color = '#f59e0b';

            try {
                const url = symbol === 'ALL' ? '/api/charts/backtest' : `/api/charts/backtest?symbol=${symbol}`;
                const resp = await fetch(url);
                const data = await resp.json();

                if (data.success) {
                    const r = data.report;

                    // Update summary stats
                    document.getElementById('btTotalTrades').textContent = r.total_trades;
                    document.getElementById('btWinners').textContent = r.winners;
                    document.getElementById('btLosers').textContent = r.losers;
                    document.getElementById('btWinRate').textContent = r.win_rate + '%';
                    document.getElementById('btWinRate').style.color = r.win_rate >= 50 ? '#22c55e' : '#ef4444';
                    document.getElementById('btAvgWin').textContent = '+$' + r.avg_win.toFixed(2);
                    document.getElementById('btAvgLoss').textContent = '$' + r.avg_loss.toFixed(2);

                    // Total P&L
                    const pnlEl = document.getElementById('btTotalPnl');
                    pnlEl.textContent = (r.total_pnl >= 0 ? '+' : '') + '$' + r.total_pnl.toFixed(2);
                    pnlEl.style.color = r.total_pnl >= 0 ? '#22c55e' : '#ef4444';

                    // Exit reason breakdown
                    const reasonsEl = document.getElementById('btExitReasons');
                    reasonsEl.innerHTML = Object.entries(r.by_exit_reason || {}).map(([reason, stats]) => {
                        const color = stats.pnl >= 0 ? '#22c55e' : '#ef4444';
                        return `<span style="padding: 2px 6px; background: #252525; border-radius: 3px;">
                            ${reason}: <b>${stats.count}</b> (<span style="color: ${color}">${stats.pnl >= 0 ? '+' : ''}$${stats.pnl.toFixed(2)}</span>)
                        </span>`;
                    }).join('');

                    // Trades table
                    const tbody = document.getElementById('btTradesBody');
                    tbody.innerHTML = data.trades.map(t => {
                        const pnlColor = (t.pnl || 0) >= 0 ? '#22c55e' : '#ef4444';
                        const entryTime = t.entry_time ? new Date(t.entry_time * 1000).toLocaleString() : '--';
                        return `<tr style="border-bottom: 1px solid #222;">
                            <td style="padding: 4px 8px; color: #60a5fa;">${t.symbol}</td>
                            <td style="padding: 4px 8px; text-align: right;">$${(t.entry_price || 0).toFixed(2)}</td>
                            <td style="padding: 4px 8px; text-align: right;">$${(t.exit_price || 0).toFixed(2)}</td>
                            <td style="padding: 4px 8px; color: #888;">${t.exit_reason || '--'}</td>
                            <td style="padding: 4px 8px; text-align: right; color: ${pnlColor};">${(t.pnl || 0) >= 0 ? '+' : ''}$${(t.pnl || 0).toFixed(2)}</td>
                            <td style="padding: 4px 8px; text-align: right; color: ${pnlColor};">${(t.pnl_percent || 0) >= 0 ? '+' : ''}${(t.pnl_percent || 0).toFixed(1)}%</td>
                        </tr>`;
                    }).join('');

                    status.textContent = `${data.trades.length} trades`;
                    status.style.color = '#22c55e';
                }
            } catch (e) {
                console.error('Error loading backtest:', e);
                status.textContent = 'Error';
                status.style.color = '#ef4444';
            }
        }

        // Open Scalp Monitor window
        function openScalpMonitor() {
            const existing = windows.find(w => w.id === 'scalpmonitor');
            if (existing) {
                existing.restore();
                existing.activate();
                loadScalpMonitorDetails();
                return;
            }
            createWindow('scalpmonitor', '‚ö° SCALP ASSISTANT', windowTemplates.scalpmonitor, 100, 100, 320, 480);
            // Load scalp status after window opens
            setTimeout(loadScalpMonitorDetails, 100);
        }

        // Open PDT Monitor window
        function openPDTMonitor() {
            const existing = windows.find(w => w.id === 'pdtmonitor');
            if (existing) {
                existing.restore();
                existing.activate();
                refreshPDTStatus();
                return;
            }
            createWindow('pdtmonitor', '‚öñÔ∏è PDT RULE MONITOR', windowTemplates.pdtmonitor, 100, 150, 380, 620);
            // Load PDT status after window opens
            setTimeout(refreshPDTStatus, 100);
        }

        // Refresh PDT status
        async function refreshPDTStatus() {
            try {
                const response = await fetch(API_BASE_URL + '/api/schwab/pdt-status');
                const data = await response.json();

                // Update status badge
                const badge = document.getElementById('pdtStatusBadge');
                const message = document.getElementById('pdtStatusMessage');
                const header = document.getElementById('pdtStatusHeader');

                if (badge) {
                    badge.textContent = data.status;
                    // Color based on warning level
                    const colors = {
                        'none': '#22c55e',      // Green - exempt
                        'low': '#22c55e',       // Green - OK
                        'medium': '#f59e0b',    // Yellow - caution
                        'high': '#f97316',      // Orange - warning
                        'critical': '#ef4444',  // Red - limit reached or flagged
                        'unknown': '#888'
                    };
                    badge.style.color = colors[data.warning_level] || '#888';

                    // Update header background for critical warnings
                    if (data.warning_level === 'critical') {
                        header.style.background = '#2d1b1b';
                        header.style.border = '1px solid #7f1d1d';
                    } else if (data.warning_level === 'high') {
                        header.style.background = '#2d2b1b';
                        header.style.border = '1px solid #7f6d1d';
                    } else {
                        header.style.background = '#1a1a1a';
                        header.style.border = 'none';
                    }
                }

                if (message) {
                    message.textContent = data.message;
                }

                // Update counters
                const used = document.getElementById('pdtDayTradesUsed');
                const remaining = document.getElementById('pdtDayTradesRemaining');

                if (used) {
                    used.textContent = data.day_trades_used || 0;
                    used.style.color = data.day_trades_used >= 3 ? '#ef4444' : data.day_trades_used >= 2 ? '#f59e0b' : '#22c55e';
                }

                if (remaining) {
                    remaining.textContent = data.day_trades_remaining || 0;
                    remaining.style.color = data.day_trades_remaining === 0 ? '#ef4444' : data.day_trades_remaining === 1 ? '#f59e0b' : '#22c55e';
                }

                // Update account info
                const equity = document.getElementById('pdtEquity');
                const exempt = document.getElementById('pdtExempt');

                if (equity) {
                    equity.textContent = '$' + (data.equity || 0).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                }

                if (exempt) {
                    exempt.textContent = data.is_exempt ? 'Yes (>$25k)' : 'No';
                    exempt.style.color = data.is_exempt ? '#22c55e' : '#f59e0b';
                }

                // Update recent day trades
                const recentTrades = document.getElementById('pdtRecentTrades');
                if (recentTrades && data.recent_day_trades) {
                    if (data.recent_day_trades.length === 0) {
                        recentTrades.innerHTML = '<div style="color: #666; text-align: center; padding: 10px;">No day trades in rolling 5-day window</div>';
                    } else {
                        let html = '';
                        for (const trade of data.recent_day_trades) {
                            html += `
                                <div style="display: flex; justify-content: space-between; padding: 4px 0; border-bottom: 1px solid #252525;">
                                    <span style="color: #fff; font-weight: 600;">${trade.symbol}</span>
                                    <span style="color: #888;">${trade.date}</span>
                                </div>
                            `;
                        }
                        recentTrades.innerHTML = html;
                    }
                }

                // Also update the account panel day trades info if visible
                const dayTradesInfo = document.getElementById('dayTradesInfo');
                const dayTradesRemaining = document.getElementById('dayTradesRemaining');
                if (dayTradesInfo && !data.is_exempt) {
                    dayTradesInfo.style.display = 'inline';
                    if (dayTradesRemaining) {
                        dayTradesRemaining.textContent = data.day_trades_remaining + '/3';
                        dayTradesRemaining.style.color = data.day_trades_remaining === 0 ? '#ef4444' : data.day_trades_remaining === 1 ? '#f59e0b' : '#22c55e';
                    }
                }

            } catch (error) {
                console.error('Error fetching PDT status:', error);
                const badge = document.getElementById('pdtStatusBadge');
                if (badge) {
                    badge.textContent = 'ERROR';
                    badge.style.color = '#888';
                }
            }
        }

        // Format markdown to HTML for Claude AI responses
        function formatMarkdown(text) {
            if (!text) return '';

            // Escape HTML first to prevent XSS
            let html = text
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;');

            // Convert markdown to HTML
            // Headers
            html = html.replace(/^### (.+)$/gm, '<h4 style="color: #60a5fa; margin: 12px 0 8px 0; font-size: 14px;">$1</h4>');
            html = html.replace(/^## (.+)$/gm, '<h3 style="color: #60a5fa; margin: 14px 0 8px 0; font-size: 15px;">$1</h3>');
            html = html.replace(/^# (.+)$/gm, '<h2 style="color: #60a5fa; margin: 16px 0 10px 0; font-size: 16px;">$1</h2>');

            // Bold and italic
            html = html.replace(/\*\*(.+?)\*\*/g, '<strong style="color: #fff;">$1</strong>');
            html = html.replace(/\*(.+?)\*/g, '<em>$1</em>');

            // Code blocks
            html = html.replace(/```(\w*)\n([\s\S]*?)```/g, '<pre style="background: #1a1a1a; padding: 10px; border-radius: 6px; overflow-x: auto; font-family: monospace; font-size: 12px; margin: 8px 0;">$2</pre>');

            // Inline code
            html = html.replace(/`([^`]+)`/g, '<code style="background: #1a1a1a; padding: 2px 6px; border-radius: 4px; font-family: monospace; font-size: 12px;">$1</code>');

            // Bullet points
            html = html.replace(/^- (.+)$/gm, '<div style="margin-left: 16px; margin-bottom: 4px;">‚Ä¢ $1</div>');
            html = html.replace(/^\* (.+)$/gm, '<div style="margin-left: 16px; margin-bottom: 4px;">‚Ä¢ $1</div>');

            // Numbered lists
            html = html.replace(/^(\d+)\. (.+)$/gm, '<div style="margin-left: 16px; margin-bottom: 4px;">$1. $2</div>');

            // Line breaks - convert double newlines to paragraph breaks
            html = html.replace(/\n\n/g, '</p><p style="margin: 10px 0;">');
            html = html.replace(/\n/g, '<br>');

            // Wrap in paragraph
            html = '<p style="margin: 0;">' + html + '</p>';

            return html;
        }

        // Send message to Claude
        async function sendClaudeMessage() {
            const input = document.getElementById('claudeChatInput');
            const messagesDiv = document.getElementById('claudeChatMessages');
            const query = input.value.trim();

            if (!query) return;

            // Add user message
            messagesDiv.innerHTML += `
                <div style="padding: 12px; background: #252525; border-radius: 8px; margin-bottom: 10px; margin-left: 40px;">
                    <div style="font-size: 11px; color: #888; margin-bottom: 4px;">You</div>
                    <div style="color: #e0e0e0; font-size: 14px;">${query}</div>
                </div>
            `;

            input.value = '';
            messagesDiv.scrollTop = messagesDiv.scrollHeight;

            // Add typing indicator
            const typingId = 'typing-' + Date.now();
            messagesDiv.innerHTML += `
                <div id="${typingId}" style="padding: 12px; background: #1e3a5f; border-radius: 8px; margin-bottom: 10px;">
                    <div style="font-size: 11px; color: #60a5fa; margin-bottom: 4px;">ü§ñ Claude AI</div>
                    <div style="color: #888; font-size: 14px;">Thinking...</div>
                </div>
            `;
            messagesDiv.scrollTop = messagesDiv.scrollHeight;

            try {
                // Use the new full conversational AI endpoint
                const response = await fetch(API_BASE_URL + '/api/schwab/ai/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: query,
                        session_id: 'default',
                        use_tools: true
                    })
                });

                const data = await response.json();
                const typingEl = document.getElementById(typingId);

                console.log('[CLAUDE] Response:', data);

                // Extract response from Claude Brain or conversational AI format
                let responseText = null;
                if (data.success && data.result) {
                    // Claude Brain format uses 'thought'
                    if (data.result.thought) {
                        responseText = data.result.thought;
                    }
                    // Conversational AI format uses 'response'
                    else if (data.result.response) {
                        responseText = data.result.response;
                    }
                } else if (data.result && data.result.response) {
                    responseText = data.result.response;
                } else if (data.response) {
                    responseText = data.response;
                } else if (data.error) {
                    responseText = `Error: ${data.error}`;
                }

                if (responseText) {
                    // Convert markdown to styled HTML for better display
                    const formattedResponse = formatMarkdown(responseText);
                    typingEl.innerHTML = `
                        <div style="font-size: 11px; color: #60a5fa; margin-bottom: 4px;">ü§ñ Claude AI</div>
                        <div style="color: #e0e0e0; font-size: 14px; line-height: 1.6;">${formattedResponse}</div>
                    `;
                } else {
                    console.error('[CLAUDE] No response found in:', data);
                    typingEl.innerHTML = `
                        <div style="font-size: 11px; color: #60a5fa; margin-bottom: 4px;">ü§ñ Claude AI</div>
                        <div style="color: #e0e0e0; font-size: 14px; line-height: 1.5;">I received your message but couldn't generate a response. Please try again.</div>
                    `;
                }
            } catch (error) {
                console.error('[CLAUDE] Error:', error);
                const typingEl = document.getElementById(typingId);
                typingEl.innerHTML = `
                    <div style="font-size: 11px; color: #ef4444; margin-bottom: 4px;">‚ö†Ô∏è Error</div>
                    <div style="color: #888; font-size: 14px;">Unable to reach Claude AI: ${error.message}</div>
                `;
            }

            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        // Claude quick actions
        async function claudeQuickAction(action) {
            const input = document.getElementById('claudeChatInput');
            const messagesDiv = document.getElementById('claudeChatMessages');
            const symbol = currentSymbol || 'SPY';

            switch(action) {
                case 'status':
                    // Show live system status directly
                    await showClaudeSystemStatus();
                    return;
                case 'train':
                    addClaudeMessage('user', 'Start model training');
                    addActivityLog('üöÄ Training request initiated');
                    await executeClaudeTraining();
                    return;
                case 'predict':
                    addClaudeMessage('user', `Get AI prediction for ${symbol}`);
                    addActivityLog(`üîÆ Prediction requested for ${symbol}`);
                    await executeClaudePrediction(symbol);
                    return;
                case 'regime':
                    addClaudeMessage('user', 'Check current market regime');
                    addActivityLog('üìà Regime detection running');
                    await executeClaudeRegimeCheck();
                    return;
                case 'drift':
                    addClaudeMessage('user', 'Check for data drift');
                    addActivityLog('üîç Drift check initiated');
                    await executeClaudeDriftCheck();
                    return;
                case 'analyze':
                    input.value = `Analyze ${symbol} - give me key support/resistance levels, trend direction, and trading recommendation`;
                    break;
                case 'sentiment':
                    input.value = `What's the current market sentiment? Any major news affecting ${symbol} or the broader market?`;
                    break;
                case 'strategy':
                    input.value = `What trading strategy would you recommend for ${symbol} in current market conditions?`;
                    break;
                case 'risk':
                    input.value = `Evaluate risk for trading ${symbol} right now. What's my risk/reward if I enter a position?`;
                    break;
            }

            if (input.value) {
                sendClaudeMessage();
            }
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        //               CLAUDE CHAT LIVE SYSTEM MONITORING
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        let claudeStatusInterval = null;

        // Add message to Claude chat
        function addClaudeMessage(type, content, isHtml = false) {
            const messagesDiv = document.getElementById('claudeChatMessages');
            if (!messagesDiv) return;

            const isUser = type === 'user';
            const bgColor = isUser ? '#252525' : '#1e3a5f';
            const marginLeft = isUser ? 'margin-left: 40px;' : '';
            const labelColor = isUser ? '#888' : '#60a5fa';
            const label = isUser ? 'You' : 'ü§ñ Claude AI';

            messagesDiv.innerHTML += `
                <div style="padding: 12px; background: ${bgColor}; border-radius: 8px; margin-bottom: 10px; ${marginLeft}">
                    <div style="font-size: 11px; color: ${labelColor}; margin-bottom: 4px;">${label}</div>
                    <div style="color: #e0e0e0; font-size: 14px; line-height: 1.5; ${isHtml ? '' : 'white-space: pre-wrap;'}">${content}</div>
                </div>
            `;
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        // Add entry to activity log
        function addActivityLog(message) {
            const logDiv = document.getElementById('activityLog');
            if (!logDiv) return;

            const time = new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            const entry = document.createElement('div');
            entry.style.cssText = 'color: #888; padding: 2px 0; border-bottom: 1px solid #1a1a1a;';
            entry.innerHTML = `<span style="color: #555; font-size: 10px;">${time}</span> ${message}`;

            // Keep only last 20 entries
            while (logDiv.children.length > 20) {
                logDiv.removeChild(logDiv.firstChild);
            }

            logDiv.appendChild(entry);
            logDiv.parentElement.scrollTop = logDiv.parentElement.scrollHeight;
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        //               AI MONITOR PANEL FUNCTIONS
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        let monitorLogEntries = [];
        let monitorFilter = 'all';
        let monitorWS = null;
        let monitorTradeCount = 0;
        let monitorTotalPnL = 0;

        // Add entry to AI Monitor log
        function addMonitorEntry(type, message, data = {}) {
            const time = new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            const entry = { type, message, data, time, timestamp: Date.now() };
            monitorLogEntries.unshift(entry);

            // Keep only last 200 entries
            if (monitorLogEntries.length > 200) {
                monitorLogEntries = monitorLogEntries.slice(0, 200);
            }

            renderMonitorLog();

            // Update timestamp
            const tsEl = document.getElementById('monTimestamp');
            if (tsEl) tsEl.textContent = time;
        }

        // Render the monitor log based on current filter
        function renderMonitorLog() {
            const logDiv = document.getElementById('aiMonitorLog');
            if (!logDiv) return;

            const filtered = monitorFilter === 'all'
                ? monitorLogEntries
                : monitorLogEntries.filter(e => e.type === monitorFilter);

            logDiv.innerHTML = filtered.slice(0, 50).map(entry => {
                let icon = 'üìù';
                let color = '#888';

                switch(entry.type) {
                    case 'trade':
                        icon = entry.data.side === 'buy' ? 'üü¢' : 'üî¥';
                        color = entry.data.side === 'buy' ? '#22c55e' : '#ef4444';
                        break;
                    case 'signal':
                        icon = '‚ö°';
                        color = '#60a5fa';
                        break;
                    case 'error':
                        icon = '‚ùå';
                        color = '#ef4444';
                        break;
                    case 'system':
                        icon = '‚öôÔ∏è';
                        color = '#888';
                        break;
                    case 'position':
                        icon = 'üìä';
                        color = '#fbbf24';
                        break;
                    case 'risk':
                        icon = '‚ö†Ô∏è';
                        color = '#f97316';
                        break;
                }

                return `<div style="padding: 3px 6px; border-bottom: 1px solid #1a1a1a; display: flex; gap: 6px; align-items: flex-start;">
                    <span style="color: #444; font-size: 9px; flex-shrink: 0;">${entry.time}</span>
                    <span>${icon}</span>
                    <span style="color: ${color}; flex: 1;">${entry.message}</span>
                </div>`;
            }).join('') || '<div style="padding: 6px; color: #666;">No entries matching filter</div>';
        }

        // Filter the monitor log
        function filterMonitorLog(filter) {
            monitorFilter = filter;

            // Update button styles
            document.querySelectorAll('.mon-filter').forEach(btn => {
                btn.style.background = '#252525';
                btn.style.color = '#888';
            });
            event.target.style.background = '#007acc';
            event.target.style.color = '#fff';

            renderMonitorLog();
        }

        // Clear the monitor log
        function clearMonitorLog() {
            monitorLogEntries = [];
            renderMonitorLog();
            addMonitorEntry('system', 'Log cleared');
        }

        // Update monitor status indicators
        function updateMonitorStatus(key, status) {
            const statusEl = document.getElementById(`mon${key}Status`);
            if (!statusEl) return;

            switch(status) {
                case 'running':
                case 'active':
                case 'ok':
                    statusEl.style.background = '#22c55e';
                    break;
                case 'warning':
                    statusEl.style.background = '#fbbf24';
                    break;
                case 'error':
                case 'stopped':
                    statusEl.style.background = '#ef4444';
                    break;
                default:
                    statusEl.style.background = '#666';
            }
        }

        // Connect to the realtime WebSocket for AI events
        function connectAIMonitorWS() {
            if (monitorWS && monitorWS.readyState === WebSocket.OPEN) return;

            try {
                monitorWS = new WebSocket(`ws://${window.location.host}/ws/realtime`);

                monitorWS.onopen = () => {
                    updateMonitorStatus('WS', 'active');
                    addMonitorEntry('system', 'Connected to AI event stream');

                    // Subscribe to channels
                    monitorWS.send(JSON.stringify({
                        action: 'subscribe',
                        channels: ['trading', 'ai', 'risk', 'system']
                    }));
                };

                monitorWS.onmessage = (event) => {
                    try {
                        const msg = JSON.parse(event.data);
                        handleMonitorMessage(msg);
                    } catch (e) {
                        console.error('Monitor WS parse error:', e);
                    }
                };

                monitorWS.onclose = () => {
                    updateMonitorStatus('WS', 'stopped');
                    addMonitorEntry('system', 'Disconnected from AI event stream');
                    // Reconnect after 5 seconds
                    setTimeout(connectAIMonitorWS, 5000);
                };

                monitorWS.onerror = (err) => {
                    updateMonitorStatus('WS', 'error');
                    addMonitorEntry('error', 'WebSocket connection error');
                };
            } catch (e) {
                addMonitorEntry('error', 'Failed to connect to AI monitor');
            }
        }

        // Handle incoming monitor messages
        function handleMonitorMessage(msg) {
            const type = msg.type || msg.channel;
            const data = msg.data || msg;

            switch(type) {
                case 'trade':
                    const side = data.side || 'unknown';
                    const symbol = data.symbol || '???';
                    const qty = data.qty || data.quantity || 0;
                    const price = data.price || data.avg_price || 0;
                    addMonitorEntry('trade', `${side.toUpperCase()} ${qty} ${symbol} @ $${parseFloat(price).toFixed(2)}`, { side });
                    monitorTradeCount++;
                    document.getElementById('monTrades').textContent = monitorTradeCount;
                    break;

                case 'position_update':
                    addMonitorEntry('position', `Position update: ${data.symbol} qty=${data.qty}`, data);
                    break;

                case 'prediction':
                case 'signal':
                    const action = data.signal || data.action || 'HOLD';
                    const conf = data.confidence ? ` (${(data.confidence * 100).toFixed(0)}%)` : '';
                    addMonitorEntry('signal', `${data.symbol}: ${action}${conf}`, data);
                    break;

                case 'bot_status':
                    updateMonitorStatus('Bot', data.running ? 'active' : 'stopped');
                    addMonitorEntry('system', `Bot ${data.running ? 'STARTED' : 'STOPPED'}`);
                    break;

                case 'brain_status':
                    updateMonitorStatus('Brain', data.running ? 'active' : 'stopped');
                    if (data.regime) {
                        document.getElementById('monRegime').textContent = data.regime;
                    }
                    break;

                case 'circuit_breaker':
                    const level = data.level || 'OK';
                    updateMonitorStatus('Circuit', level === 'OK' ? 'ok' : level === 'WARNING' ? 'warning' : 'error');
                    if (level !== 'OK') {
                        addMonitorEntry('risk', `Circuit breaker: ${level}`, data);
                    }
                    break;

                case 'drawdown':
                    const dd = data.drawdown_pct || 0;
                    const ddEl = document.getElementById('monDrawdown');
                    if (ddEl) {
                        ddEl.textContent = `${dd.toFixed(1)}%`;
                        ddEl.style.color = dd > 3 ? '#ef4444' : dd > 1 ? '#fbbf24' : '#22c55e';
                    }
                    break;

                case 'drift':
                    const driftEl = document.getElementById('monDrift');
                    if (driftEl) {
                        driftEl.textContent = data.detected ? 'DRIFT' : 'OK';
                        driftEl.style.color = data.detected ? '#ef4444' : '#22c55e';
                    }
                    if (data.detected) {
                        addMonitorEntry('risk', 'Data drift detected - consider retraining', data);
                    }
                    break;

                case 'error':
                    addMonitorEntry('error', data.message || 'Unknown error', data);
                    break;

                case 'connected':
                case 'subscribed':
                    // Ignore connection confirmations
                    break;

                default:
                    if (data.message) {
                        addMonitorEntry('system', data.message, data);
                    }
            }
        }

        // Initialize AI Monitor on window creation
        function initAIMonitor() {
            // Load initial status
            fetchMonitorStatus();

            // Connect WebSocket
            connectAIMonitorWS();

            // Periodic status refresh
            setInterval(fetchMonitorStatus, 30000);
        }

        // Fetch current system status for monitor
        async function fetchMonitorStatus() {
            try {
                // Get model status
                const modelResp = await fetch('/api/ai/model-info');
                const modelData = await modelResp.json();
                updateMonitorStatus('Model', modelData.trained ? 'active' : 'stopped');

                // Get brain status
                try {
                    const brainResp = await fetch('/api/brain/status');
                    const brainData = await brainResp.json();
                    if (brainData.success) {
                        updateMonitorStatus('Brain', brainData.data?.running ? 'active' : 'stopped');
                        if (brainData.data?.regime) {
                            document.getElementById('monRegime').textContent = brainData.data.regime;
                        }
                    }
                } catch (e) {}

                // Get account P&L
                try {
                    const acctResp = await fetch('/api/account');
                    const acctData = await acctResp.json();
                    if (acctData.success && acctData.data) {
                        const pnl = parseFloat(acctData.data.unrealized_pl || 0) + parseFloat(acctData.data.realized_pl || 0);
                        const pnlEl = document.getElementById('monPnL');
                        if (pnlEl) {
                            pnlEl.textContent = `$${pnl >= 0 ? '+' : ''}${pnl.toFixed(0)}`;
                            pnlEl.style.color = pnl >= 0 ? '#22c55e' : '#ef4444';
                        }
                    }
                } catch (e) {}

            } catch (e) {
                console.error('Monitor status fetch error:', e);
            }
        }

        // Update Claude chat live status panel
        async function updateClaudeLiveStatus() {
            try {
                // Update timestamp
                const timeEl = document.getElementById('claudeStatusTime');
                if (timeEl) {
                    timeEl.textContent = new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
                }

                // Fetch model info
                try {
                    const modelRes = await fetch(API_BASE_URL + '/api/ai/model-info');
                    const modelData = await modelRes.json();
                    const modelEl = document.getElementById('claudeModelStatus');
                    if (modelEl) {
                        if (modelData.trained) {
                            modelEl.textContent = `${(modelData.accuracy * 100).toFixed(1)}%`;
                            modelEl.style.color = modelData.accuracy > 0.55 ? '#22c55e' : '#f59e0b';
                        } else {
                            modelEl.textContent = 'Not Trained';
                            modelEl.style.color = '#ef4444';
                        }
                    }
                } catch (e) {
                    const modelEl = document.getElementById('claudeModelStatus');
                    if (modelEl) {
                        modelEl.textContent = '--';
                        modelEl.style.color = '#666';
                    }
                }

                // Fetch regime (if available)
                try {
                    const regimeRes = await fetch(API_BASE_URL + '/api/pipeline/regime/detect');
                    const regimeData = await regimeRes.json();
                    const regimeEl = document.getElementById('claudeRegimeStatus');
                    if (regimeEl && regimeData.success) {
                        const regime = regimeData.data.regime.toUpperCase();
                        regimeEl.textContent = regime;
                        regimeEl.style.color = regime === 'BULL' ? '#22c55e' : regime === 'BEAR' ? '#ef4444' : '#60a5fa';
                    }
                } catch (e) {
                    const regimeEl = document.getElementById('claudeRegimeStatus');
                    if (regimeEl) {
                        regimeEl.textContent = '--';
                        regimeEl.style.color = '#666';
                    }
                }

                // Fetch drift status (if available)
                try {
                    const driftRes = await fetch(API_BASE_URL + '/api/pipeline/drift/summary');
                    const driftData = await driftRes.json();
                    const driftEl = document.getElementById('claudeDriftStatus');
                    if (driftEl && driftData.success) {
                        const hasDrift = driftData.data.should_retrain?.[0] || false;
                        driftEl.textContent = hasDrift ? 'DRIFT!' : 'OK';
                        driftEl.style.color = hasDrift ? '#ef4444' : '#22c55e';
                    }
                } catch (e) {
                    const driftEl = document.getElementById('claudeDriftStatus');
                    if (driftEl) {
                        driftEl.textContent = 'N/A';
                        driftEl.style.color = '#666';
                    }
                }

            } catch (error) {
                console.error('Error updating Claude live status:', error);
            }
        }

        // Show comprehensive system status in chat
        async function showClaudeSystemStatus() {
            addActivityLog('üìä Fetching system status...');

            let statusHtml = '<div style="font-size: 13px;">';
            statusHtml += '<div style="font-weight: 700; color: #60a5fa; margin-bottom: 10px;">üìä SYSTEM STATUS REPORT</div>';

            // Model Status
            try {
                const modelRes = await fetch(API_BASE_URL + '/api/ai/model-info');
                const model = await modelRes.json();
                if (model.trained) {
                    statusHtml += `
                        <div style="background: #161b22; padding: 10px; border-radius: 6px; margin-bottom: 8px;">
                            <div style="color: #22c55e; font-weight: 600;">‚úÖ AI Model: TRAINED</div>
                            <div style="color: #888; font-size: 12px; margin-top: 4px;">
                                Accuracy: <span style="color: #fff;">${(model.accuracy * 100).toFixed(1)}%</span> ‚Ä¢
                                Features: <span style="color: #fff;">${model.num_features}</span> ‚Ä¢
                                Trained: <span style="color: #fff;">${model.training_date || 'Unknown'}</span>
                            </div>
                            <div style="color: #666; font-size: 11px; margin-top: 4px;">Top Features: ${model.top_features?.slice(0, 3).map(f => f.name).join(', ') || 'N/A'}</div>
                        </div>
                    `;
                } else {
                    statusHtml += `
                        <div style="background: #2d1b1b; padding: 10px; border-radius: 6px; margin-bottom: 8px;">
                            <div style="color: #ef4444; font-weight: 600;">‚ùå AI Model: NOT TRAINED</div>
                            <div style="color: #888; font-size: 12px; margin-top: 4px;">Click "Train Model" to start training</div>
                        </div>
                    `;
                }
            } catch (e) {
                statusHtml += `<div style="color: #666; margin-bottom: 8px;">Model status unavailable</div>`;
            }

            // Regime Status
            try {
                const regimeRes = await fetch(API_BASE_URL + '/api/pipeline/regime/detect');
                const regime = await regimeRes.json();
                if (regime.success) {
                    const r = regime.data;
                    const regimeColor = r.regime === 'bull' ? '#22c55e' : r.regime === 'bear' ? '#ef4444' : '#60a5fa';
                    statusHtml += `
                        <div style="background: #161b22; padding: 10px; border-radius: 6px; margin-bottom: 8px;">
                            <div style="color: ${regimeColor}; font-weight: 600;">üìà Market Regime: ${r.regime.toUpperCase()}</div>
                            <div style="color: #888; font-size: 12px; margin-top: 4px;">
                                Confidence: <span style="color: #fff;">${(r.confidence * 100).toFixed(0)}%</span>
                            </div>
                        </div>
                    `;
                }
            } catch (e) {
                statusHtml += `<div style="color: #666; margin-bottom: 8px;">Regime detection not available (advanced pipeline not loaded)</div>`;
            }

            // Connection Status
            try {
                const healthRes = await fetch(API_BASE_URL + '/api/health');
                const health = await healthRes.json();
                statusHtml += `
                    <div style="background: #161b22; padding: 10px; border-radius: 6px; margin-bottom: 8px;">
                        <div style="color: ${health.broker?.connected ? '#22c55e' : '#ef4444'}; font-weight: 600;">
                            ${health.broker?.connected ? '‚úÖ' : '‚ùå'} Broker: ${health.broker?.connected ? 'CONNECTED' : 'DISCONNECTED'}
                        </div>
                        <div style="color: #888; font-size: 12px; margin-top: 4px;">
                            Paper Trading: <span style="color: #fff;">${health.broker?.paper_trading ? 'Yes' : 'No'}</span>
                        </div>
                    </div>
                `;
            } catch (e) {
                statusHtml += `<div style="color: #ef4444; margin-bottom: 8px;">‚ùå API Server: NOT RESPONDING</div>`;
            }

            statusHtml += '</div>';
            addClaudeMessage('claude', statusHtml, true);
            addActivityLog('‚úÖ Status report complete');
        }

        // Execute training from Claude chat
        async function executeClaudeTraining() {
            const typingId = 'training-' + Date.now();
            const messagesDiv = document.getElementById('claudeChatMessages');

            messagesDiv.innerHTML += `
                <div id="${typingId}" style="padding: 12px; background: #1e3a5f; border-radius: 8px; margin-bottom: 10px;">
                    <div style="font-size: 11px; color: #60a5fa; margin-bottom: 4px;">ü§ñ Claude AI</div>
                    <div style="color: #f59e0b; font-size: 14px;">‚è≥ Starting multi-symbol training... This takes ~3 minutes.</div>
                </div>
            `;
            messagesDiv.scrollTop = messagesDiv.scrollHeight;

            try {
                const response = await fetch(API_BASE_URL + '/api/ai/train-multi', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        symbols: ['TSLA', 'NVDA', 'AMD', 'META', 'AAPL', 'GOOGL', 'MSFT', 'AMZN', 'PLTR', 'COIN'],
                        test_size: 0.2
                    })
                });

                const data = await response.json();
                const typingEl = document.getElementById(typingId);

                if (data.accuracy) {
                    addActivityLog(`‚úÖ Training complete: ${(data.accuracy * 100).toFixed(1)}% accuracy`);
                    typingEl.innerHTML = `
                        <div style="font-size: 11px; color: #60a5fa; margin-bottom: 4px;">ü§ñ Claude AI</div>
                        <div style="color: #e0e0e0; font-size: 14px; line-height: 1.6;">
                            <div style="color: #22c55e; font-weight: 600; margin-bottom: 8px;">‚úÖ Training Complete!</div>
                            <div style="background: #161b22; padding: 10px; border-radius: 6px;">
                                <div><b>Accuracy:</b> ${(data.accuracy * 100).toFixed(1)}%</div>
                                <div><b>Precision:</b> ${(data.precision * 100).toFixed(1)}%</div>
                                <div><b>Recall:</b> ${(data.recall * 100).toFixed(1)}%</div>
                                <div><b>F1 Score:</b> ${(data.f1 * 100).toFixed(1)}%</div>
                                <div style="margin-top: 6px; font-size: 12px; color: #888;">Training samples: ${data.train_samples || 'N/A'}</div>
                            </div>
                        </div>
                    `;
                    updateClaudeLiveStatus();
                } else {
                    addActivityLog('‚ö†Ô∏è Training returned unexpected response');
                    typingEl.innerHTML = `
                        <div style="font-size: 11px; color: #60a5fa; margin-bottom: 4px;">ü§ñ Claude AI</div>
                        <div style="color: #f59e0b; font-size: 14px;">Training completed but results format unexpected. Check AI Control Panel for details.</div>
                    `;
                }
            } catch (error) {
                addActivityLog('‚ùå Training failed: ' + error.message);
                const typingEl = document.getElementById(typingId);
                typingEl.innerHTML = `
                    <div style="font-size: 11px; color: #ef4444; margin-bottom: 4px;">‚ö†Ô∏è Error</div>
                    <div style="color: #888; font-size: 14px;">Training failed: ${error.message}</div>
                `;
            }
        }

        // Execute prediction from Claude chat
        async function executeClaudePrediction(symbol) {
            try {
                const response = await fetch(API_BASE_URL + '/api/ai/predict', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ symbol: symbol, timeframe: '1Day' })
                });

                const data = await response.json();

                if (data.signal) {
                    const signalColor = data.signal === 'BUY' ? '#22c55e' : data.signal === 'SELL' ? '#ef4444' : '#f59e0b';
                    addActivityLog(`‚úÖ Prediction: ${symbol} ‚Üí ${data.signal}`);

                    const html = `
                        <div style="font-size: 13px;">
                            <div style="font-weight: 700; color: #60a5fa; margin-bottom: 10px;">üîÆ AI PREDICTION: ${symbol}</div>
                            <div style="background: #161b22; padding: 12px; border-radius: 6px; border-left: 4px solid ${signalColor};">
                                <div style="font-size: 20px; font-weight: 700; color: ${signalColor}; margin-bottom: 8px;">${data.signal}</div>
                                <div style="color: #888; font-size: 12px;">
                                    <div>Confidence: <span style="color: #fff;">${(data.confidence * 100).toFixed(1)}%</span></div>
                                    <div>Current Price: <span style="color: #fff;">$${data.current_price?.toFixed(2) || 'N/A'}</span></div>
                                    <div>Expected Move: <span style="color: ${data.expected_return > 0 ? '#22c55e' : '#ef4444'};">${(data.expected_return * 100).toFixed(2)}%</span></div>
                                </div>
                            </div>
                        </div>
                    `;
                    addClaudeMessage('claude', html, true);
                } else {
                    addActivityLog(`‚ö†Ô∏è No prediction available for ${symbol}`);
                    addClaudeMessage('claude', `Unable to generate prediction for ${symbol}. Make sure the model is trained first.`);
                }
            } catch (error) {
                addActivityLog('‚ùå Prediction failed: ' + error.message);
                addClaudeMessage('claude', `Error getting prediction: ${error.message}`);
            }
        }

        // Execute regime check from Claude chat
        async function executeClaudeRegimeCheck() {
            try {
                const response = await fetch(API_BASE_URL + '/api/pipeline/regime/detect');
                const data = await response.json();

                if (data.success) {
                    const r = data.data;
                    const regimeColor = r.regime === 'bull' ? '#22c55e' : r.regime === 'bear' ? '#ef4444' : '#60a5fa';
                    addActivityLog(`‚úÖ Regime: ${r.regime.toUpperCase()} (${(r.confidence * 100).toFixed(0)}%)`);

                    const html = `
                        <div style="font-size: 13px;">
                            <div style="font-weight: 700; color: #60a5fa; margin-bottom: 10px;">üìà MARKET REGIME ANALYSIS</div>
                            <div style="background: #161b22; padding: 12px; border-radius: 6px; border-left: 4px solid ${regimeColor};">
                                <div style="font-size: 18px; font-weight: 700; color: ${regimeColor}; margin-bottom: 8px;">${r.regime.toUpperCase()} MARKET</div>
                                <div style="color: #888; font-size: 12px;">
                                    <div>Confidence: <span style="color: #fff;">${(r.confidence * 100).toFixed(0)}%</span></div>
                                    <div style="margin-top: 6px; color: #666;">
                                        ${r.regime === 'bull' ? 'üí° Strategy: Trend following, momentum plays' :
                                          r.regime === 'bear' ? 'üí° Strategy: Defensive, short opportunities' :
                                          'üí° Strategy: Range trading, mean reversion'}
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    addClaudeMessage('claude', html, true);
                } else {
                    throw new Error(data.message || 'Regime detection failed');
                }
            } catch (error) {
                addActivityLog('‚ö†Ô∏è Regime check unavailable');
                addClaudeMessage('claude', 'Regime detection not available. The advanced pipeline module may not be loaded.');
            }
        }

        // Execute drift check from Claude chat
        async function executeClaudeDriftCheck() {
            try {
                const response = await fetch(API_BASE_URL + '/api/pipeline/drift/summary');
                const data = await response.json();

                if (data.success) {
                    const d = data.data;
                    const hasDrift = d.should_retrain?.[0] || false;
                    addActivityLog(`‚úÖ Drift check: ${hasDrift ? 'DRIFT DETECTED' : 'No drift'}`);

                    const html = `
                        <div style="font-size: 13px;">
                            <div style="font-weight: 700; color: #60a5fa; margin-bottom: 10px;">üîç DATA DRIFT ANALYSIS</div>
                            <div style="background: #161b22; padding: 12px; border-radius: 6px; border-left: 4px solid ${hasDrift ? '#ef4444' : '#22c55e'};">
                                <div style="font-size: 16px; font-weight: 700; color: ${hasDrift ? '#ef4444' : '#22c55e'}; margin-bottom: 8px;">
                                    ${hasDrift ? '‚ö†Ô∏è DRIFT DETECTED - Retraining Recommended' : '‚úÖ NO SIGNIFICANT DRIFT'}
                                </div>
                                <div style="color: #888; font-size: 12px;">
                                    ${hasDrift ?
                                      'Market conditions have changed significantly since last training. Consider retraining the model.' :
                                      'Current market data is consistent with training data. Model should perform as expected.'}
                                </div>
                            </div>
                        </div>
                    `;
                    addClaudeMessage('claude', html, true);
                } else {
                    throw new Error(data.message || 'Drift check failed');
                }
            } catch (error) {
                addActivityLog('‚ö†Ô∏è Drift check unavailable');
                addClaudeMessage('claude', 'Drift detection not available. Set reference data first or ensure advanced pipeline is loaded.');
            }
        }

        // Initialize Claude chat live monitoring when window opens
        function initClaudeLiveMonitoring() {
            // Initial status update
            updateClaudeLiveStatus();
            addActivityLog('üì° System monitor initialized');

            // Set up auto-refresh every 30 seconds
            if (claudeStatusInterval) {
                clearInterval(claudeStatusInterval);
            }
            claudeStatusInterval = setInterval(updateClaudeLiveStatus, 30000);
        }

        // MODELS PERFORMANCE
        async function loadModelsPerformance() {
            const perfDiv = document.getElementById('modelsPerformance');
            if (!perfDiv) return; // Element not present in current view

            try {
                const response = await fetch(API_BASE_URL + '/api/ai/models/performance');
                if (!response.ok) {
                    perfDiv.innerHTML = '<div class="empty-state" style="padding: 20px; font-size: 13px;">No models available yet.<br>Train a model first!</div>';
                    return;
                }
                const data = await response.json();

                if (!data.success || !data.data || !data.data.length) {
                    perfDiv.innerHTML = '<div class="empty-state" style="padding: 20px; font-size: 13px;">No models available yet.<br>Train a model first!</div>';
                    return;
                }

                let html = '';
                for (const model of data.data) {
                    html += `
                        <div style="padding: 10px; margin-bottom: 8px; background: #252525; border-radius: 4px; border-left: 3px solid #60a5fa;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                                <div style="font-size: 14px; font-weight: 700; color: #fff;">${model.name}</div>
                                <div style="font-size: 11px; color: #888;">${model.type}</div>
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; font-size: 11px; margin-bottom: 6px;">
                                <div>
                                    <span style="color: #666;">Accuracy:</span>
                                    <span style="color: #22c55e; font-weight: 600;">${(model.accuracy * 100).toFixed(1)}%</span>
                                </div>
                                <div>
                                    <span style="color: #666;">Win Rate:</span>
                                    <span style="color: #22c55e; font-weight: 600;">${(model.win_rate * 100).toFixed(1)}%</span>
                                </div>
                                <div>
                                    <span style="color: #666;">Sharpe:</span>
                                    <span style="color: #60a5fa; font-weight: 600;">${model.sharpe_ratio.toFixed(2)}</span>
                                </div>
                            </div>
                            <div style="font-size: 10px; color: #666;">Trades: ${model.total_trades} (${model.profitable_trades} profitable) ‚Ä¢ Avg Profit: $${model.avg_profit.toFixed(2)}</div>
                        </div>
                    `;
                }

                perfDiv.innerHTML = html;

            } catch (error) {
                console.error('Error loading models performance:', error);
                if (perfDiv) perfDiv.innerHTML = '<div class="empty-state" style="padding: 20px; font-size: 13px;">No models available yet.<br>Train a model first!</div>';
            }
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        //                     CONNECTION MANAGEMENT
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        async function connectToSchwab() {
            try {
                const response = await fetch(API_BASE_URL + '/api/schwab/connect', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                const data = await response.json();

                if (data.status === 'connected' || data.connected) {
                    showNotification('‚úì Connected to Schwab', 'success');
                    checkStatus();
                } else {
                    showNotification('‚úó Failed to connect to Schwab', 'error');
                }
            } catch (error) {
                showNotification('‚úó Connection error: ' + error.message, 'error');
            }
        }

        async function checkStatus() {
            try {
                // Check Schwab status (primary broker)
                const schwabResponse = await fetch(API_BASE_URL + '/api/schwab/status');
                const schwabData = await schwabResponse.json();

                console.log('Schwab Status:', schwabData);

                const schwabDot = document.getElementById('schwabStatusTop');
                const schwabText = document.getElementById('schwabStatusText');
                const brokerText = document.getElementById('brokerStatusText');

                if (schwabData && schwabData.authenticated) {
                    if (schwabDot) schwabDot.classList.add('connected');
                    if (schwabText) schwabText.textContent = 'Connected';
                    if (brokerText) brokerText.textContent = 'Schwab';
                    apiAvailable = true;
                    console.log('‚úì Schwab indicator set to CONNECTED');
                } else {
                    if (schwabDot) schwabDot.classList.remove('connected');
                    if (schwabText) schwabText.textContent = 'Disconnected';
                    if (brokerText) brokerText.textContent = 'Disconnected';
                    console.log('‚úó Schwab indicator set to DISCONNECTED');
                }

                // Check AI/Claude status
                const healthResponse = await fetch(API_BASE_URL + '/health');
                const healthData = await healthResponse.json();

                console.log('Claude Available:', healthData.claude_available);

                const aiDot = document.getElementById('aiStatus');
                const aiText = document.getElementById('aiStatusText');

                if (healthData && healthData.claude_available) {
                    aiDot.classList.add('connected');
                    aiText.textContent = 'Online';
                    console.log('‚úì AI indicator set to ONLINE');
                } else {
                    aiDot.classList.remove('connected');
                    aiText.textContent = 'Offline';
                    console.log('‚úó AI indicator set to OFFLINE');
                }
            } catch (error) {
                console.error('Status check error:', error);
            }

            // Also check channel and streaming status
            await updateChannelStatus();
            await updateStreamingStatus();
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        //                     MULTI-CHANNEL & STREAMING STATUS
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        async function updateChannelStatus() {
            try {
                const response = await fetch(API_BASE_URL + '/api/data/channels/status');
                const data = await response.json();

                const dot = document.getElementById('channelStatus');
                const text = document.getElementById('channelStatusText');

                if (data.available && data.status) {
                    const channelCount = data.status.total_channels || 0;
                    dot.classList.add('connected');
                    text.textContent = `${channelCount}ch`;
                } else {
                    dot.classList.remove('connected');
                    text.textContent = 'N/A';
                }
            } catch (error) {
                console.error('Channel status error:', error);
                document.getElementById('channelStatus')?.classList.remove('connected');
                document.getElementById('channelStatusText').textContent = 'Err';
            }
        }

        async function updateStreamingStatus() {
            try {
                const response = await fetch(API_BASE_URL + '/api/streaming/status');
                const data = await response.json();

                const dot = document.getElementById('streamingStatus');
                const text = document.getElementById('streamingStatusText');

                if (data.available && data.status) {
                    const status = data.status;
                    if (status.running) {
                        dot.classList.add('connected');
                        text.textContent = `${status.subscription_count} subs`;
                    } else {
                        dot.classList.remove('connected');
                        text.textContent = 'Ready';
                    }
                } else {
                    dot.classList.remove('connected');
                    text.textContent = 'N/A';
                }
            } catch (error) {
                console.error('Streaming status error:', error);
                document.getElementById('streamingStatus')?.classList.remove('connected');
                document.getElementById('streamingStatusText').textContent = 'Err';
            }
        }

        function showChannelStatusModal() {
            document.getElementById('channelStatusModal').classList.add('show');
            refreshChannelStatus();
        }

        function closeChannelStatusModal() {
            document.getElementById('channelStatusModal').classList.remove('show');
        }

        async function refreshChannelStatus() {
            const container = document.getElementById('channelStatusDetails');
            container.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">Loading...</div>';

            try {
                const response = await fetch(API_BASE_URL + '/api/data/channels/status');
                const data = await response.json();

                if (!data.available) {
                    container.innerHTML = '<div style="text-align: center; padding: 20px; color: #ef4444;">Multi-channel data not available</div>';
                    return;
                }

                const status = data.status;
                const aggregate = data.aggregate;

                let html = `
                    <div style="margin-bottom: 15px; padding: 12px; background: #1a1a1a; border-radius: 4px;">
                        <div style="font-weight: 700; color: #007acc; margin-bottom: 8px;">üìä Aggregate Statistics</div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">
                            <div>
                                <div style="color: #888; font-size: 11px;">Total Requests</div>
                                <div style="font-size: 18px; font-weight: 700; color: #fff;">${aggregate.total_requests.toLocaleString()}</div>
                            </div>
                            <div>
                                <div style="color: #888; font-size: 11px;">Success Rate</div>
                                <div style="font-size: 18px; font-weight: 700; color: #22c55e;">${aggregate.success_rate.toFixed(1)}%</div>
                            </div>
                            <div>
                                <div style="color: #888; font-size: 11px;">Avg Latency</div>
                                <div style="font-size: 18px; font-weight: 700; color: #60a5fa;">${aggregate.avg_latency_ms.toFixed(0)}ms</div>
                            </div>
                        </div>
                    </div>

                    <div style="font-weight: 700; color: #007acc; margin-bottom: 10px;">üì° Channel Details</div>
                `;

                for (const [name, ch] of Object.entries(status.channels)) {
                    const successRate = ch.requests_total > 0 ? (ch.requests_success / ch.requests_total * 100).toFixed(1) : 0;
                    const statusColor = ch.active ? '#22c55e' : '#ef4444';

                    html += `
                        <div style="padding: 10px; background: #1a1a1a; border-radius: 4px; margin-bottom: 8px; border-left: 3px solid ${statusColor};">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                                <span style="font-weight: 700; text-transform: uppercase; color: #fff;">${name}</span>
                                <span style="padding: 2px 8px; background: ${statusColor}; border-radius: 10px; font-size: 10px;">${ch.active ? 'ACTIVE' : 'INACTIVE'}</span>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 8px; font-size: 11px;">
                                <div>
                                    <div style="color: #888;">Requests</div>
                                    <div style="color: #fff; font-weight: 600;">${ch.requests_total}</div>
                                </div>
                                <div>
                                    <div style="color: #888;">Success</div>
                                    <div style="color: #22c55e; font-weight: 600;">${successRate}%</div>
                                </div>
                                <div>
                                    <div style="color: #888;">Latency</div>
                                    <div style="color: #60a5fa; font-weight: 600;">${ch.avg_latency_ms.toFixed(0)}ms</div>
                                </div>
                                <div>
                                    <div style="color: #888;">Last Used</div>
                                    <div style="color: #aaa;">${ch.last_request ? new Date(ch.last_request).toLocaleTimeString() : 'Never'}</div>
                                </div>
                            </div>
                        </div>
                    `;
                }

                container.innerHTML = html;
            } catch (error) {
                container.innerHTML = `<div style="text-align: center; padding: 20px; color: #ef4444;">Error: ${error.message}</div>`;
            }
        }

        // Streaming Modal Functions
        function showStreamingModal() {
            document.getElementById('streamingModal').classList.add('show');
            refreshStreamingStatus();
        }

        function closeStreamingModal() {
            document.getElementById('streamingModal').classList.remove('show');
        }

        // =====================================================================
        // BROKER/ACCOUNT MODAL FUNCTIONS
        // =====================================================================

        let activeBroker = 'schwab';  // Current trading broker (Schwab primary)
        let schwabAccounts = [];

        async function loadSchwabAccounts() {
            try {
                const schwabResp = await fetch(API_BASE_URL + '/api/schwab/status');
                const schwabStatus = await schwabResp.json();

                if (schwabStatus.available && schwabStatus.authenticated) {
                    schwabAccounts = schwabStatus.accounts || [];
                    const select = document.getElementById('schwabAccountSelect');
                    if (select) {
                        select.innerHTML = '<option value="">Select account...</option>';
                        schwabAccounts.forEach(acc => {
                            const opt = document.createElement('option');
                            opt.value = acc.account_number;
                            opt.textContent = acc.account_number + (acc.selected ? ' (Selected)' : '');
                            if (acc.selected) opt.selected = true;
                            select.appendChild(opt);
                        });
                    }
                }
            } catch (e) {
                console.warn('Failed to load Schwab accounts:', e);
            }
        }

        function showBrokerModal() {
            document.getElementById('brokerModal').classList.add('show');
            refreshBrokerStatus();
        }

        function closeBrokerModal() {
            document.getElementById('brokerModal').classList.remove('show');
        }

        async function refreshBrokerStatus() {
            try {
                // Get health status for broker info
                const healthResp = await fetch(API_BASE_URL + '/api/health');
                const health = await healthResp.json();

                // Update data source status
                const dataSource = health.services.primary_data_source || 'alpaca';
                document.getElementById('dataSourceStatus').textContent = dataSource.charAt(0).toUpperCase() + dataSource.slice(1);
                document.getElementById('dataSourceStatus').style.color = dataSource === 'schwab' ? '#00ff00' : '#ffaa00';

                // Get Schwab status
                try {
                    const schwabResp = await fetch(API_BASE_URL + '/api/schwab/status');
                    const schwabStatus = await schwabResp.json();

                    if (schwabStatus.available && schwabStatus.authenticated) {
                        document.getElementById('schwabConnectionStatus').textContent =
                            `Connected (${schwabStatus.accounts_count} accounts)`;
                        document.getElementById('schwabConnectionStatus').style.color = '#00ff00';
                        document.getElementById('schwabStatus').style.backgroundColor = '#00ff00';

                        // Load accounts
                        schwabAccounts = schwabStatus.accounts || [];
                        const select = document.getElementById('schwabAccountSelect');
                        select.innerHTML = '<option value="">Select account...</option>';
                        schwabAccounts.forEach(acc => {
                            const opt = document.createElement('option');
                            opt.value = acc.account_number;
                            opt.textContent = acc.account_number + (acc.selected ? ' (Selected)' : '');
                            if (acc.selected) opt.selected = true;
                            select.appendChild(opt);
                        });
                    } else {
                        document.getElementById('schwabConnectionStatus').textContent = 'Not Authenticated';
                        document.getElementById('schwabConnectionStatus').style.color = '#ef4444';
                        document.getElementById('schwabStatus').style.backgroundColor = '#ef4444';
                    }
                } catch (e) {
                    document.getElementById('schwabConnectionStatus').textContent = 'Not Available';
                    document.getElementById('schwabConnectionStatus').style.color = '#888';
                }

                // Update broker button states
                updateBrokerButtons();

            } catch (error) {
                console.error('Error refreshing broker status:', error);
            }
        }

        async function selectBroker(broker) {
            activeBroker = broker;
            updateBrokerButtons();

            // Show/hide Schwab account section
            document.getElementById('schwabAccountSection').style.display =
                broker === 'schwab' ? 'block' : 'none';

            // Update top bar display
            document.getElementById('brokerStatusText').textContent =
                broker === 'schwab' ? 'Schwab' : 'Alpaca';

            // Store preference locally
            localStorage.setItem('activeBroker', broker);

            // Switch broker on the server side
            try {
                await fetch(API_BASE_URL + '/api/broker/switch/' + broker, { method: 'POST' });
                console.log('Switched active broker to:', broker);

                // Refresh all data with new broker
                await loadAccount();
                await loadPositions();
                await loadOrders();
                showNotification(`Switched to ${broker === 'schwab' ? 'Schwab/TOS' : 'Alpaca'}`, 'success');
            } catch (error) {
                console.error('Error switching broker:', error);
            }
        }

        function updateBrokerButtons() {
            const alpacaBtn = document.getElementById('brokerAlpacaBtn');
            const schwabBtn = document.getElementById('brokerSchwabBtn');

            if (activeBroker === 'alpaca') {
                alpacaBtn.style.border = '2px solid #00ff00';
                alpacaBtn.style.background = 'rgba(0, 255, 0, 0.1)';
                schwabBtn.style.border = '1px solid #333';
                schwabBtn.style.background = '';
            } else {
                schwabBtn.style.border = '2px solid #00ff00';
                schwabBtn.style.background = 'rgba(0, 255, 0, 0.1)';
                alpacaBtn.style.border = '1px solid #333';
                alpacaBtn.style.background = '';
            }
        }

        async function selectSchwabAccount() {
            const accountNumber = document.getElementById('schwabAccountSelect').value;
            if (!accountNumber) return;

            try {
                const response = await fetch(API_BASE_URL + '/api/schwab/accounts/select', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ account_number: accountNumber })
                });

                if (response.ok) {
                    // Get account info
                    const infoResp = await fetch(API_BASE_URL + '/api/schwab/account');
                    const info = await infoResp.json();

                    // Format currency helper
                    const fmtCurrency = (val) => '$' + (val || 0).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
                    const fmtPct = (val) => (val >= 0 ? '+' : '') + (val || 0).toFixed(2) + '%';

                    // Determine PDT warning color
                    const pdtColor = info.is_day_trader ? '#22c55e' : (info.round_trips >= 3 ? '#f59e0b' : '#888');
                    const pdtText = info.is_day_trader ? 'Yes (PDT)' : `No (${info.round_trips || 0}/4 trades)`;

                    // Daily P/L color
                    const plColor = (info.daily_pl || 0) >= 0 ? '#22c55e' : '#ef4444';

                    document.getElementById('schwabAccountInfo').innerHTML = `
                        <div style="margin-bottom: 10px; padding-bottom: 8px; border-bottom: 1px solid #333;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <span style="color: #888; font-size: 11px;">ACCOUNT</span><br>
                                    <strong style="font-size: 16px;">${info.account_number}</strong>
                                </div>
                                <div style="text-align: right;">
                                    <span style="color: #888; font-size: 11px;">TYPE</span><br>
                                    <strong style="color: #007acc;">${info.type || 'Unknown'}</strong>
                                </div>
                            </div>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 10px;">
                            <div>
                                <span style="color: #888; font-size: 11px;">ACCOUNT VALUE</span><br>
                                <strong style="font-size: 18px; color: #fff;">${fmtCurrency(info.market_value)}</strong>
                            </div>
                            <div>
                                <span style="color: #888; font-size: 11px;">DAILY P/L</span><br>
                                <strong style="font-size: 18px; color: ${plColor};">${fmtCurrency(info.daily_pl)} (${fmtPct(info.daily_pl_pct)})</strong>
                            </div>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 12px;">
                            <div style="padding: 6px; background: #252525; border-radius: 3px;">
                                <span style="color: #888;">Cash Balance</span><br>
                                <strong style="color: #22c55e;">${fmtCurrency(info.cash)}</strong>
                            </div>
                            <div style="padding: 6px; background: #252525; border-radius: 3px;">
                                <span style="color: #888;">Buying Power</span><br>
                                <strong>${fmtCurrency(info.buying_power)}</strong>
                            </div>
                            <div style="padding: 6px; background: #252525; border-radius: 3px;">
                                <span style="color: #888;">Settled Cash</span><br>
                                <strong>${fmtCurrency(info.cash_available_for_trading)}</strong>
                            </div>
                            <div style="padding: 6px; background: #252525; border-radius: 3px;">
                                <span style="color: #888;">Unsettled</span><br>
                                <strong style="color: #f59e0b;">${fmtCurrency(info.unsettled_cash)}</strong>
                            </div>
                            <div style="padding: 6px; background: #252525; border-radius: 3px;">
                                <span style="color: #888;">Day Trade BP</span><br>
                                <strong>${fmtCurrency(info.day_trading_buying_power)}</strong>
                            </div>
                            <div style="padding: 6px; background: #252525; border-radius: 3px;">
                                <span style="color: #888;">Day Trader</span><br>
                                <strong style="color: ${pdtColor};">${pdtText}</strong>
                            </div>
                        </div>

                        <div style="margin-top: 10px; padding-top: 8px; border-top: 1px solid #333; font-size: 11px; color: #666;">
                            Positions: ${info.positions_count || 0} | Long Value: ${fmtCurrency(info.long_market_value)} | Margin Req: ${fmtCurrency(info.maintenance_requirement)}
                        </div>
                    `;

                    // Update top bar
                    document.getElementById('brokerStatusText').textContent = `Schwab ${accountNumber.slice(-4)}`;
                } else {
                    alert('Failed to select account');
                }
            } catch (error) {
                console.error('Error selecting Schwab account:', error);
                alert('Error selecting account: ' + error.message);
            }
        }

        // Initialize broker state on page load
        async function initBrokerState() {
            const savedBroker = localStorage.getItem('activeBroker') || 'schwab';
            activeBroker = savedBroker;
            document.getElementById('brokerStatusText').textContent =
                savedBroker === 'schwab' ? 'Schwab' : 'Alpaca';

            // Sync broker state with server
            try {
                await fetch(API_BASE_URL + '/api/broker/switch/' + savedBroker, { method: 'POST' });
                console.log('Synced broker state with server:', savedBroker);
            } catch (e) {
                console.warn('Failed to sync broker state:', e);
            }

            // Show Schwab account section by default
            const schwabSection = document.getElementById('schwabAccountSection');
            if (schwabSection && savedBroker === 'schwab') {
                schwabSection.style.display = 'block';
            }

            // Check Schwab status on load
            fetch(API_BASE_URL + '/api/schwab/status')
                .then(r => r.json())
                .then(status => {
                    const schwabStatusEl = document.getElementById('schwabStatus');
                    const schwabStatusTopEl = document.getElementById('schwabStatusTop');
                    const schwabTextEl = document.getElementById('schwabStatusText');

                    if (status.available && status.authenticated) {
                        if (schwabStatusEl) {
                            schwabStatusEl.style.backgroundColor = '#00ff00';
                            schwabStatusEl.classList.add('connected');
                        }
                        if (schwabStatusTopEl) schwabStatusTopEl.classList.add('connected');
                        if (schwabTextEl) schwabTextEl.textContent = 'Connected';
                        // Load Schwab accounts into dropdown
                        loadSchwabAccounts();
                    } else {
                        if (schwabStatusEl) schwabStatusEl.style.backgroundColor = '#888';
                        if (schwabStatusTopEl) schwabStatusTopEl.classList.remove('connected');
                        if (schwabTextEl) schwabTextEl.textContent = 'Disconnected';
                    }
                })
                .catch(() => {
                    const schwabStatusEl = document.getElementById('schwabStatus');
                    if (schwabStatusEl) schwabStatusEl.style.backgroundColor = '#888';
                });
        }

        async function refreshStreamingStatus() {
            try {
                const response = await fetch(API_BASE_URL + '/api/streaming/status');
                const data = await response.json();

                if (!data.available) {
                    document.getElementById('streamModalStatusText').textContent = 'Not Available';
                    document.getElementById('streamModalStatusText').style.color = '#ef4444';
                    return;
                }

                const status = data.status;
                const stats = status.stats;

                // Update status text
                const statusText = document.getElementById('streamModalStatusText');
                if (status.running) {
                    statusText.textContent = 'Running';
                    statusText.style.color = '#22c55e';
                    document.getElementById('streamToggleBtn').textContent = '‚èπ Stop Stream';
                    document.getElementById('streamToggleBtn').classList.remove('btn-buy');
                    document.getElementById('streamToggleBtn').classList.add('btn-sell');
                } else {
                    statusText.textContent = 'Stopped';
                    statusText.style.color = '#ef4444';
                    document.getElementById('streamToggleBtn').textContent = '‚ñ∂ Start Stream';
                    document.getElementById('streamToggleBtn').classList.remove('btn-sell');
                    document.getElementById('streamToggleBtn').classList.add('btn-buy');
                }

                // Update stats
                document.getElementById('streamSubCount').textContent = status.subscription_count;
                document.getElementById('streamMsgCount').textContent = stats.messages_received.toLocaleString();
                document.getElementById('streamClientCount').textContent = status.connected_clients;

                // Update subscriptions list
                const subsContainer = document.getElementById('activeSubscriptions');
                if (Object.keys(status.subscriptions).length === 0) {
                    subsContainer.innerHTML = '<div style="color: #666; font-size: 12px;">No active subscriptions</div>';
                } else {
                    let html = '';
                    for (const [symbol, types] of Object.entries(status.subscriptions)) {
                        html += `<div style="display: flex; justify-content: space-between; padding: 4px 0; border-bottom: 1px solid #333;">
                            <span style="color: #fff; font-weight: 600;">${symbol}</span>
                            <span style="color: #888; font-size: 11px;">${types.join(', ')}</span>
                        </div>`;
                    }
                    subsContainer.innerHTML = html;
                }
            } catch (error) {
                console.error('Error refreshing streaming status:', error);
            }
        }

        async function subscribeToStream() {
            const symbolsInput = document.getElementById('streamSymbolsInput').value;
            if (!symbolsInput.trim()) {
                alert('Please enter symbols to subscribe');
                return;
            }

            const symbols = symbolsInput.split(',').map(s => s.trim().toUpperCase());
            const types = [];
            if (document.getElementById('streamQuotes').checked) types.push('quotes');
            if (document.getElementById('streamTrades').checked) types.push('trades');
            if (document.getElementById('streamBars').checked) types.push('bars');

            try {
                const response = await fetch(API_BASE_URL + '/api/streaming/subscribe', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ symbols, types })
                });
                const data = await response.json();

                if (data.success) {
                    showNotification(`Subscribed to ${symbols.join(', ')}`, 'success');
                    refreshStreamingStatus();
                    updateStreamingStatus();
                } else {
                    showNotification('Subscription failed', 'error');
                }
            } catch (error) {
                showNotification('Error: ' + error.message, 'error');
            }
        }

        async function unsubscribeAll() {
            try {
                // Get current subscriptions first
                const statusResponse = await fetch(API_BASE_URL + '/api/streaming/status');
                const statusData = await statusResponse.json();

                if (statusData.status && Object.keys(statusData.status.subscriptions).length > 0) {
                    const symbols = Object.keys(statusData.status.subscriptions);

                    const response = await fetch(API_BASE_URL + '/api/streaming/unsubscribe', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ symbols })
                    });

                    if (response.ok) {
                        showNotification('Unsubscribed from all symbols', 'info');
                        refreshStreamingStatus();
                        updateStreamingStatus();
                    }
                } else {
                    showNotification('No active subscriptions', 'info');
                }
            } catch (error) {
                showNotification('Error: ' + error.message, 'error');
            }
        }

        async function toggleStreaming() {
            try {
                const statusResponse = await fetch(API_BASE_URL + '/api/streaming/status');
                const statusData = await statusResponse.json();

                if (statusData.status && statusData.status.running) {
                    // Stop streaming
                    await fetch(API_BASE_URL + '/api/streaming/stop', { method: 'POST' });
                    showNotification('Streaming stopped', 'info');
                } else {
                    // Start streaming
                    await fetch(API_BASE_URL + '/api/streaming/start', { method: 'POST' });
                    showNotification('Streaming started', 'success');
                }

                refreshStreamingStatus();
                updateStreamingStatus();
            } catch (error) {
                showNotification('Error: ' + error.message, 'error');
            }
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        //                     WINDOW LAYOUT MANAGEMENT
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        function createWindow(id, title, content, x, y, width, height) {
            const win = new DraggableWindow(id, title, content, x, y, width, height);
            windows.push(win);
            return win;
        }

        function minimizeWindow(id) {
            windows.find(w => w.id === id)?.minimize();
        }

        function maximizeWindow(id) {
            windows.find(w => w.id === id)?.maximize();
        }

        function closeWindow(id) {
            windows.find(w => w.id === id)?.close();
        }

        function minimizeAll() {
            windows.forEach(w => w.minimize());
        }

        function restoreAll() {
            windows.forEach(w => w.restore());
        }

        function tileWindows() {
            const workspace = document.getElementById('workspace');
            const cols = Math.ceil(Math.sqrt(windows.length));
            const rows = Math.ceil(windows.length / cols);
            const width = Math.floor(workspace.clientWidth / cols);
            const height = Math.floor(workspace.clientHeight / rows);

            windows.forEach((win, i) => {
                win.x = (i % cols) * width;
                win.y = Math.floor(i / cols) * height;
                win.width = width - 4;
                win.height = height - 4;
                win.updatePosition();
                win.restore();
            });
        }

        function cascadeWindows() {
            windows.forEach((win, i) => {
                win.x = i * 35;
                win.y = i * 35;
                win.width = 600;
                win.height = 450;
                win.updatePosition();
                win.restore();
            });
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        //                     CONFIGURATION MANAGEMENT SYSTEM
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        function getAllConfigurations() {
            const configs = localStorage.getItem('dashboardConfigurations');
            return configs ? JSON.parse(configs) : {};
        }

        function saveAllConfigurations(configs) {
            localStorage.setItem('dashboardConfigurations', JSON.stringify(configs));
        }

        function showSaveConfigDialog() {
            document.getElementById('configNameInput').value = '';
            document.getElementById('saveConfigDialog').classList.add('show');

            const input = document.getElementById('configNameInput');
            input.focus();

            // Add Enter key handler
            input.onkeypress = function(e) {
                if (e.key === 'Enter') {
                    saveConfiguration();
                }
            };

            // Close the dropdown
            document.querySelectorAll('.dropdown').forEach(d => d.classList.remove('show'));
        }

        function closeSaveConfigDialog() {
            document.getElementById('saveConfigDialog').classList.remove('show');
        }

        function saveConfiguration() {
            const name = document.getElementById('configNameInput').value.trim();

            if (!name) {
                alert('Please enter a configuration name.');
                return;
            }

            const configs = getAllConfigurations();

            if (configs[name]) {
                if (!confirm(`Configuration "${name}" already exists. Overwrite it?`)) {
                    return;
                }
            }

            const layout = windows.map(w => ({
                id: w.id,
                title: w.title,
                x: w.x,
                y: w.y,
                width: w.width,
                height: w.height,
                minimized: w.minimized
            }));

            configs[name] = {
                windows: layout,
                watchlist: [...watchlist],
                timestamp: new Date().toISOString()
            };

            saveAllConfigurations(configs);
            closeSaveConfigDialog();
            updateSavedConfigsList();

            console.log(`‚úì Configuration "${name}" saved with ${layout.length} windows`);
            alert(`‚úì Configuration "${name}" saved successfully!`);
        }

        function setAsDefaultLayout() {
            // Save current window layout as the startup default
            const layout = windows.map(w => ({
                id: w.id,
                title: w.title,
                x: w.x,
                y: w.y,
                width: w.width,
                height: w.height,
                minimized: w.minimized
            }));

            const defaultConfig = {
                windows: layout,
                watchlist: [...watchlist],
                currentSymbol: currentSymbol,
                timestamp: new Date().toISOString()
            };

            // Save to localStorage as the startup default
            localStorage.setItem('startupDefaultLayout', JSON.stringify(defaultConfig));

            console.log(`‚úì Startup default set with ${layout.length} windows`);
            alert('‚úì Current layout saved as startup default!\n\nThis layout will load automatically when you open the dashboard.');
        }

        function loadStartupDefaultLayout() {
            const saved = localStorage.getItem('startupDefaultLayout');
            if (!saved) return false;

            try {
                const config = JSON.parse(saved);
                console.log('Loading startup default layout with', config.windows.length, 'windows');

                // Restore watchlist
                if (config.watchlist) {
                    watchlist = [...config.watchlist];
                    localStorage.setItem('watchlist', JSON.stringify(watchlist));
                }

                // Restore current symbol
                if (config.currentSymbol) {
                    currentSymbol = config.currentSymbol;
                }

                // Restore windows
                config.windows.forEach(w => {
                    // Handle chart templates specially - they need the function call
                    let template;
                    if (w.id.startsWith('chart')) {
                        const chartId = w.id.replace('chart', '');
                        template = windowTemplates.chart(chartId);
                    } else {
                        template = windowTemplates[w.id] || '';
                    }

                    createWindow(w.id, w.title, template, w.x, w.y, w.width, w.height);
                    if (w.minimized) {
                        const window = windows.find(win => win.id === w.id);
                        if (window) window.minimize();
                    }
                });

                // Initialize charts after windows are created
                setTimeout(() => {
                    windows.forEach(win => {
                        if (win.id.startsWith('chart')) {
                            const chartId = win.id.replace('chart', '');
                            initChart(chartId, currentSymbol);
                        }
                    });
                }, 500);

                return true;
            } catch (e) {
                console.error('Failed to load startup default layout:', e);
                return false;
            }
        }

        function loadConfiguration(name) {
            const configs = getAllConfigurations();
            const config = configs[name];

            if (!config) {
                alert(`Configuration "${name}" not found.`);
                return;
            }

            console.log(`Loading configuration: ${name}`);

            // Close all current windows
            windows.forEach(w => w.close());
            windows = [];

            // Restore watchlist
            if (config.watchlist) {
                watchlist = [...config.watchlist];
                localStorage.setItem('watchlist', JSON.stringify(watchlist));
            }

            // Restore windows
            config.windows.forEach(w => {
                // Handle chart templates specially - they need the function call
                let template;
                if (w.id.startsWith('chart')) {
                    const chartId = w.id.replace('chart', '');
                    template = windowTemplates.chart(chartId);
                } else {
                    template = windowTemplates[w.id] || '';
                }

                createWindow(w.id, w.title, template, w.x, w.y, w.width, w.height);
                if (w.minimized) {
                    const window = windows.find(win => win.id === w.id);
                    if (window) window.minimize();
                }
            });

            // Refresh data
            setTimeout(() => {
                loadPrice();
                loadLevel2();
                loadTimeSales();
                loadPositions();
                loadOrders();
                loadAccount();
                loadWorklist();

                // Initialize charts
                windows.forEach(win => {
                    if (win.id.startsWith('chart')) {
                        const chartId = win.id.replace('chart', '');
                        initChart(chartId, currentSymbol);
                    }
                });
            }, 1000);

            // Close dropdown
            document.querySelectorAll('.dropdown').forEach(d => d.classList.remove('show'));

            console.log(`‚úì Configuration "${name}" loaded`);
        }

        function deleteConfiguration(name) {
            if (!confirm(`Delete configuration "${name}"?`)) {
                return;
            }

            const configs = getAllConfigurations();
            delete configs[name];
            saveAllConfigurations(configs);
            updateSavedConfigsList();
            updateManageConfigsList();

            console.log(`‚úó Configuration "${name}" deleted`);
            alert(`‚úì Configuration "${name}" deleted.`);
        }

        function renameConfiguration(oldName) {
            const newName = prompt(`Rename configuration "${oldName}" to:`, oldName);

            if (!newName || newName === oldName) {
                return;
            }

            const configs = getAllConfigurations();

            if (configs[newName]) {
                alert(`Configuration "${newName}" already exists.`);
                return;
            }

            configs[newName] = configs[oldName];
            configs[newName].timestamp = new Date().toISOString();
            delete configs[oldName];

            saveAllConfigurations(configs);
            updateSavedConfigsList();
            updateManageConfigsList();

            console.log(`‚úì Configuration renamed: "${oldName}" ‚Üí "${newName}"`);
            alert(`‚úì Configuration renamed to "${newName}".`);
        }

        function updateSavedConfigsList() {
            const configs = getAllConfigurations();
            const configNames = Object.keys(configs).sort();
            const listDiv = document.getElementById('savedConfigsList');

            if (!listDiv) return;  // Element not in DOM yet

            if (configNames.length === 0) {
                listDiv.innerHTML = '<div style="padding: 10px; text-align: center; color: #666; font-size: 13px;">No saved configurations</div>';
                return;
            }

            let html = '';
            configNames.forEach(name => {
                const config = configs[name];
                const date = new Date(config.timestamp).toLocaleDateString();
                const windowCount = config.windows.length;

                html += `
                    <a href="#" onclick="event.preventDefault(); loadConfiguration('${name.replace(/'/g, "\\'")}')">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span>${name}</span>
                            <span style="font-size: 11px; color: #666;">${windowCount} windows</span>
                        </div>
                    </a>
                `;
            });

            listDiv.innerHTML = html;
        }

        function showManageConfigsDialog() {
            updateManageConfigsList();
            document.getElementById('manageConfigsDialog').classList.add('show');
            // Close the dropdown
            document.querySelectorAll('.dropdown').forEach(d => d.classList.remove('show'));
        }

        function closeManageConfigsDialog() {
            document.getElementById('manageConfigsDialog').classList.remove('show');
        }

        function updateManageConfigsList() {
            const configs = getAllConfigurations();
            const configNames = Object.keys(configs).sort();
            const listDiv = document.getElementById('manageConfigsList');
            const noConfigsMsg = document.getElementById('noConfigsMessage');

            if (configNames.length === 0) {
                listDiv.style.display = 'none';
                noConfigsMsg.style.display = 'block';
                return;
            }

            listDiv.style.display = 'block';
            noConfigsMsg.style.display = 'none';

            let html = '';
            configNames.forEach(name => {
                const config = configs[name];
                const date = new Date(config.timestamp).toLocaleString();
                const windowCount = config.windows.length;
                const watchlistCount = config.watchlist ? config.watchlist.length : 0;

                html += `
                    <div class="config-list-item">
                        <div>
                            <div class="config-list-item-name">${name}</div>
                            <div class="config-list-item-date">
                                ${date} ‚Ä¢ ${windowCount} windows ‚Ä¢ ${watchlistCount} symbols
                            </div>
                        </div>
                        <div class="config-list-item-actions">
                            <button class="config-btn-small config-btn-load" onclick="loadConfiguration('${name.replace(/'/g, "\\'")}'); closeManageConfigsDialog();">
                                üìÇ Load
                            </button>
                            <button class="config-btn-small config-btn-rename" onclick="renameConfiguration('${name.replace(/'/g, "\\'")}')">
                                ‚úèÔ∏è Rename
                            </button>
                            <button class="config-btn-small config-btn-delete" onclick="deleteConfiguration('${name.replace(/'/g, "\\'")}')">
                                üóëÔ∏è Delete
                            </button>
                        </div>
                    </div>
                `;
            });

            listDiv.innerHTML = html;
        }

        // Legacy function - kept for backward compatibility
        function saveAsCustomLayout() {
            showSaveConfigDialog();
        }

        function saveCurrentLayout() {
            showSaveConfigDialog();
        }

        // Open a new dashboard instance with isolated storage
        function openNewDashboardInstance() {
            const instanceId = 'dashboard_' + Date.now();
            const url = new URL(window.location.href);
            url.searchParams.set('instance', instanceId);
            window.open(url.toString(), '_blank', 'width=1600,height=900');
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        //                     MULTI-CHART MANAGEMENT
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        function getTimeframeName(interval) {
            const names = {
                '1': '1min',
                '5': '5min',
                '15': '15min',
                '30': '30min',
                '60': '1h',
                '240': '4h',
                'D': 'Daily',
                'W': 'Weekly',
                'M': 'Monthly'
            };
            return names[interval] || interval;
        }

        function addChart(templateName = 'default', customInterval = null, style = '1') {
            chartCounter++;
            const chartId = `chart${chartCounter}`;

            // Get template info for title
            const allTemplates = getAllChartTemplates();
            const template = allTemplates[templateName] || CHART_PRESETS['default'];
            const interval = customInterval || template.interval || '5';
            const timeframeName = getTimeframeName(interval);
            const title = `CHART ${chartCounter} - ${currentSymbol} (${template.name})`;

            // Calculate position (cascade new charts)
            const baseX = 300 + (chartCounter - 1) * 30;
            const baseY = 100 + (chartCounter - 1) * 30;

            // Create chart window
            const chartWindow = createWindow(
                chartId,
                title,
                windowTemplates.chart(chartCounter),
                baseX,
                baseY,
                700,
                500
            );

            // Initialize TradingView chart after a short delay
            setTimeout(() => {
                // If custom interval provided, create modified template
                if (customInterval) {
                    const modifiedTemplate = { ...template, interval: customInterval, style: style };
                    // Temporarily store in custom templates
                    const customKey = `custom_${chartCounter}`;
                    const customTemplates = getSavedChartTemplates();
                    customTemplates[customKey] = modifiedTemplate;
                    localStorage.setItem('customChartTemplates', JSON.stringify(customTemplates));
                    initChart(chartCounter.toString(), currentSymbol, customKey);
                } else {
                    initChart(chartCounter.toString(), currentSymbol, templateName);
                }
            }, 500);

            // Close dropdown
            document.querySelectorAll('.dropdown').forEach(d => d.classList.remove('show'));

            console.log(`‚úì Added chart ${chartCounter} with template "${template.name}" (${timeframeName})`);
        }

        // Add chart using the user's default template for that timeframe
        function addChartWithDefault(interval) {
            // Check if user has set a default template for this timeframe
            const defaultTemplate = getDefaultTemplateForTimeframe(interval);

            if (defaultTemplate) {
                // Use the user's custom default
                addChart(defaultTemplate);
            } else {
                // Find a built-in template that matches this interval, or use default
                let templateName = 'default';
                for (const [key, preset] of Object.entries(CHART_PRESETS)) {
                    if (preset.interval === interval) {
                        templateName = key;
                        break;
                    }
                }
                addChart(templateName, interval);
            }
        }

        function showAddChartDialog() {
            document.getElementById('chartSymbolPreview').textContent = currentSymbol;
            document.getElementById('chartTemplate').value = 'default';
            document.getElementById('chartTimeframe').value = '';
            updateTemplateDescription();
            document.getElementById('addChartDialog').classList.add('show');
            // Close the dropdown
            document.querySelectorAll('.dropdown').forEach(d => d.classList.remove('show'));
        }

        function closeAddChartDialog() {
            document.getElementById('addChartDialog').classList.remove('show');
        }

        function updateTemplateDescription() {
            const templateName = document.getElementById('chartTemplate').value;
            const allTemplates = getAllChartTemplates();
            const template = allTemplates[templateName] || CHART_PRESETS['default'];

            const detailsDiv = document.getElementById('templateDetails');
            if (detailsDiv) {
                const timeframeName = getTimeframeName(template.interval);
                const studiesText = template.studies.length > 0
                    ? template.studies.map(s => s.split('@')[0]).join(', ')
                    : 'No indicators';
                detailsDiv.textContent = `${template.description} on ${timeframeName} timeframe`;
            }
        }

        function createCustomChart() {
            const templateName = document.getElementById('chartTemplate').value;
            const customInterval = document.getElementById('chartTimeframe').value || null;
            const style = document.getElementById('chartStyle').value;

            addChart(templateName, customInterval, style);
            closeAddChartDialog();
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        //                     TRADINGVIEW DESKTOP INTEGRATION
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        /**
         * Open a symbol directly in TradingView Desktop with specific timeframe
         * TradingView Desktop uses the tradingview:// protocol
         */
        function openTVDesktop(symbol, interval = 'D') {
            // Build the TradingView Desktop URL
            const exchange = getExchangeForSymbol(symbol);
            const tvSymbol = `${exchange}:${symbol}`;

            // TradingView Desktop protocol URL
            const tvDesktopUrl = `tradingview://chart?symbol=${tvSymbol}&interval=${interval}`;

            // Also build web fallback URL
            const tvWebUrl = `https://www.tradingview.com/chart/?symbol=${tvSymbol}&interval=${interval}`;

            console.log(`Opening ${tvSymbol} (${interval}) in TradingView Desktop...`);

            // Try to open via protocol handler using window.location
            // This is the most reliable way to trigger desktop app protocols
            try {
                window.location.href = tvDesktopUrl;
                showNotification(`Opening ${symbol} (${getIntervalName(interval)}) in TradingView Desktop...`, 'info');
            } catch (e) {
                // Fallback to web
                console.log('Desktop protocol failed, opening web version...');
                window.open(tvWebUrl, '_blank');
            }

            // Close dropdown
            document.querySelectorAll('.dropdown').forEach(d => d.classList.remove('show'));
        }

        /**
         * Get the exchange prefix for a symbol (for TradingView)
         */
        function getExchangeForSymbol(symbol) {
            const sym = symbol.toUpperCase();

            // ETFs typically on AMEX/NYSE Arca
            const amexSymbols = ['SPY', 'QQQ', 'DIA', 'IWM', 'XLF', 'XLE', 'XLK', 'XLV', 'GLD', 'SLV', 'TLT', 'VXX', 'UVXY', 'SQQQ', 'TQQQ'];
            if (amexSymbols.includes(sym)) return 'AMEX';

            // Major NYSE stocks
            const nyseSymbols = ['JPM', 'BAC', 'WFC', 'C', 'GS', 'MS', 'V', 'MA', 'DIS', 'KO', 'PEP', 'WMT', 'HD', 'MCD', 'NKE', 'BA', 'CAT', 'GE', 'MMM', 'IBM', 'JNJ', 'PFE', 'MRK', 'UNH', 'CVX', 'XOM'];
            if (nyseSymbols.includes(sym)) return 'NYSE';

            // Default to NASDAQ for tech stocks
            return 'NASDAQ';
        }

        /**
         * Get human-readable interval name
         */
        function getIntervalName(interval) {
            const names = {
                '1': '1 Minute',
                '5': '5 Minutes',
                '15': '15 Minutes',
                '30': '30 Minutes',
                '60': '1 Hour',
                '240': '4 Hours',
                'D': 'Daily',
                'W': 'Weekly',
                'M': 'Monthly'
            };
            return names[interval] || interval;
        }

        /**
         * Open all watchlist symbols in TradingView Desktop
         */
        function openTVDesktopMulti() {
            const symbols = getCurrentWatchlistSymbols();

            if (symbols.length === 0) {
                showNotification('No symbols in watchlist to open.', 'warning');
                return;
            }

            if (symbols.length > 8) {
                if (!confirm(`This will open ${symbols.length} charts. TradingView Desktop works best with up to 8 charts.\n\nContinue with first 8 symbols?`)) {
                    return;
                }
                symbols.length = 8; // Limit to 8
            }

            // Open each symbol with a delay to prevent overwhelming
            symbols.forEach((symbol, index) => {
                setTimeout(() => {
                    openTVDesktop(symbol, 'D');
                }, index * 1000); // 1 second delay between each
            });

            showNotification(`Opening ${symbols.length} charts in TradingView Desktop...`, 'info');

            // Close dropdown
            document.querySelectorAll('.dropdown').forEach(d => d.classList.remove('show'));
        }

        /**
         * Get current watchlist symbols
         */
        function getCurrentWatchlistSymbols() {
            const watchlistBody = document.getElementById('watchlist-body');
            if (!watchlistBody) return [];

            const symbols = [];
            watchlistBody.querySelectorAll('tr').forEach(row => {
                const symbolCell = row.querySelector('td:first-child');
                if (symbolCell) {
                    const sym = symbolCell.textContent.trim();
                    if (sym && sym.length > 0 && sym.length <= 5) {
                        symbols.push(sym);
                    }
                }
            });
            return symbols;
        }

        /**
         * Show help dialog for TradingView Desktop integration
         */
        function showTVDesktopHelp() {
            const helpHtml = `
                <div style="text-align: left; line-height: 1.8;">
                    <h3 style="color: #2563eb; margin-bottom: 15px;">üñ•Ô∏è TradingView Desktop Integration</h3>

                    <p><strong>Why use TradingView Desktop?</strong></p>
                    <ul style="margin-left: 20px; margin-bottom: 15px;">
                        <li><span style="color: #22c55e;">‚úì</span> Unlimited indicators (no 2-indicator limit!)</li>
                        <li><span style="color: #22c55e;">‚úì</span> Your custom templates & saved layouts</li>
                        <li><span style="color: #22c55e;">‚úì</span> Multi-monitor support</li>
                        <li><span style="color: #22c55e;">‚úì</span> Faster performance</li>
                    </ul>

                    <p><strong>How to use:</strong></p>
                    <ol style="margin-left: 20px; margin-bottom: 15px;">
                        <li>Install TradingView Desktop (link below)</li>
                        <li>Set up your chart templates in TV Desktop</li>
                        <li>Click any timeframe in the TV DESKTOP menu</li>
                        <li>Chart opens with your saved template!</li>
                    </ol>

                    <p><strong>Pro Tips:</strong></p>
                    <ul style="margin-left: 20px; margin-bottom: 15px;">
                        <li>Create templates for each timeframe (1m Scalping, 5m Day Trading, etc.)</li>
                        <li>Right-click chart ‚Üí "Save chart layout as..." to save your setup</li>
                        <li>Use "Apply template" to quickly switch indicator sets</li>
                    </ul>

                    <div style="margin-top: 20px; padding: 15px; background: #1e3a5f; border-radius: 5px;">
                        <strong>üì• Download TradingView Desktop:</strong><br>
                        <a href="https://www.tradingview.com/desktop/" target="_blank"
                           style="color: #60a5fa; text-decoration: underline; font-size: 16px;">
                            www.tradingview.com/desktop
                        </a>
                    </div>
                </div>
            `;

            showGenericDialog('TradingView Desktop Help', helpHtml);

            // Close dropdown
            document.querySelectorAll('.dropdown').forEach(d => d.classList.remove('show'));
        }

        /**
         * Show a generic dialog with custom content
         */
        function showGenericDialog(title, contentHtml) {
            // Create overlay if it doesn't exist
            let overlay = document.getElementById('genericDialogOverlay');
            if (!overlay) {
                overlay = document.createElement('div');
                overlay.id = 'genericDialogOverlay';
                overlay.className = 'config-dialog-overlay';
                overlay.innerHTML = `
                    <div class="config-dialog" style="max-width: 550px;">
                        <div class="config-dialog-header" id="genericDialogTitle"></div>
                        <div class="config-dialog-body" id="genericDialogContent"></div>
                        <div class="config-dialog-footer">
                            <button class="action-btn" onclick="closeGenericDialog()">Close</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(overlay);
            }

            document.getElementById('genericDialogTitle').textContent = title;
            document.getElementById('genericDialogContent').innerHTML = contentHtml;
            overlay.classList.add('show');
        }

        function closeGenericDialog() {
            const overlay = document.getElementById('genericDialogOverlay');
            if (overlay) overlay.classList.remove('show');
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        //                     TV DESKTOP WATCHLIST SYNC
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        let tvSyncWatchlists = [];
        let tvSyncCurrentSymbols = [];

        async function showTVWatchlistSyncModal() {
            document.getElementById('tvSyncModal').classList.add('show');

            // Close dropdown
            document.querySelectorAll('.dropdown').forEach(d => d.classList.remove('show'));

            // Load watchlists
            await loadTVSyncWatchlists();
        }

        function closeTVSyncModal() {
            document.getElementById('tvSyncModal').classList.remove('show');
        }

        async function loadTVSyncWatchlists() {
            try {
                const response = await fetch(API_BASE_URL + '/api/tradingview/desktop/all-watchlists-export');
                const data = await response.json();

                if (data.success && data.watchlists) {
                    tvSyncWatchlists = data.watchlists;

                    const select = document.getElementById('tvSyncWatchlistSelect');
                    select.innerHTML = '';

                    data.watchlists.forEach((wl, index) => {
                        const option = document.createElement('option');
                        option.value = index;
                        option.textContent = `${wl.name} (${wl.symbol_count} symbols)`;
                        select.appendChild(option);
                    });

                    // Load first watchlist
                    if (data.watchlists.length > 0) {
                        loadTVSyncWatchlist();
                    }
                }
            } catch (error) {
                console.error('Error loading watchlists:', error);
                document.getElementById('tvSyncOutput').value = 'Error loading watchlists: ' + error.message;
            }
        }

        function loadTVSyncWatchlist() {
            const select = document.getElementById('tvSyncWatchlistSelect');
            const index = parseInt(select.value);

            if (isNaN(index) || !tvSyncWatchlists[index]) {
                return;
            }

            const wl = tvSyncWatchlists[index];
            tvSyncCurrentSymbols = wl.symbols || [];

            // Display TV-formatted output
            document.getElementById('tvSyncOutput').value = wl.tv_import_text || '';
        }

        async function copyTVSyncOutput() {
            const output = document.getElementById('tvSyncOutput');
            try {
                await navigator.clipboard.writeText(output.value);
                showNotification('Copied to clipboard! Paste in TradingView Desktop.', 'success');
            } catch (err) {
                // Fallback for older browsers
                output.select();
                document.execCommand('copy');
                showNotification('Copied to clipboard!', 'success');
            }
        }

        async function copyWatchlistToClipboard() {
            try {
                // Get current watchlist symbols from the API
                const response = await fetch(API_BASE_URL + '/api/tradingview/desktop/watchlist-export?format=txt');
                const data = await response.json();

                if (data.success && data.content) {
                    await navigator.clipboard.writeText(data.content);
                    showNotification(`Copied ${data.symbol_count} symbols to clipboard!`, 'success');
                } else {
                    showNotification('No symbols to copy', 'warning');
                }
            } catch (error) {
                showNotification('Error copying: ' + error.message, 'error');
            }

            // Close dropdown
            document.querySelectorAll('.dropdown').forEach(d => d.classList.remove('show'));
        }

        function openAllInTVDesktop() {
            if (tvSyncCurrentSymbols.length === 0) {
                showNotification('No symbols to open', 'warning');
                return;
            }

            const symbols = tvSyncCurrentSymbols.slice(0, 8); // Limit to 8

            if (tvSyncCurrentSymbols.length > 8) {
                if (!confirm(`Opening first 8 of ${tvSyncCurrentSymbols.length} symbols. Continue?`)) {
                    return;
                }
            }

            symbols.forEach((symbol, index) => {
                setTimeout(() => {
                    openTVDesktop(symbol, 'D');
                }, index * 1000);
            });

            showNotification(`Opening ${symbols.length} charts in TradingView Desktop...`, 'info');
        }

        function downloadTVWatchlistFile() {
            const output = document.getElementById('tvSyncOutput').value;
            if (!output) {
                showNotification('No symbols to download', 'warning');
                return;
            }

            const select = document.getElementById('tvSyncWatchlistSelect');
            const selectedIndex = parseInt(select.value);
            const watchlistName = tvSyncWatchlists[selectedIndex]?.name || 'watchlist';

            // Create and download file
            const blob = new Blob([output], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${watchlistName.replace(/[^a-z0-9]/gi, '_')}_tv.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            showNotification('Watchlist file downloaded!', 'success');
        }

        // Legacy function - redirect to new function
        async function openInTradingView(symbol) {
            openTVDesktop(symbol, 'D');
        }

        function copySymbolToClipboard() {
            const exchange = getExchangeForSymbol(currentSymbol);
            const fullSymbol = `${exchange}:${currentSymbol}`;

            navigator.clipboard.writeText(fullSymbol).then(() => {
                showNotification(`‚úì ${fullSymbol} copied to clipboard!`, 'success');
                console.log(`Copied ${fullSymbol} to clipboard`);
            }).catch(err => {
                // Fallback - just copy symbol without exchange
                navigator.clipboard.writeText(currentSymbol).then(() => {
                    showNotification(`‚úì ${currentSymbol} copied to clipboard!`, 'success');
                });
            });

            // Close dropdown
            document.querySelectorAll('.dropdown').forEach(d => d.classList.remove('show'));
        }

        function showWebhookInfo() {
            document.getElementById('webhookInfoDialog').classList.add('show');
            // Close the dropdown
            document.querySelectorAll('.dropdown').forEach(d => d.classList.remove('show'));
        }

        function closeWebhookInfoDialog() {
            document.getElementById('webhookInfoDialog').classList.remove('show');
        }

        function copyWebhookUrl() {
            const url = document.getElementById('webhookUrl').value;
            navigator.clipboard.writeText(url).then(() => {
                alert('‚úì Webhook URL copied to clipboard!');
            });
        }

        async function showWebhookLogs() {
            document.getElementById('webhookLogsDialog').classList.add('show');
            await refreshWebhookLogs();
            // Close the dropdown
            document.querySelectorAll('.dropdown').forEach(d => d.classList.remove('show'));
        }

        function closeWebhookLogsDialog() {
            document.getElementById('webhookLogsDialog').classList.remove('show');
        }

        async function refreshWebhookLogs() {
            try {
                const response = await fetch(API_BASE_URL + '/api/tradingview/webhook-logs');
                const data = await response.json();

                const logsList = document.getElementById('webhookLogsList');

                if (data.logs && data.logs.length > 0) {
                    let html = '';
                    data.logs.reverse().forEach(log => {
                        const timestamp = new Date(log.timestamp).toLocaleString();
                        const typeColor = log.type === 'incoming' ? '#22c55e' :
                                         log.type === 'error' ? '#ef4444' : '#60a5fa';

                        html += `
                            <div style="margin-bottom: 10px; padding: 10px; background: #1a1a1a; border-left: 3px solid ${typeColor}; border-radius: 3px;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                    <span style="color: ${typeColor}; font-weight: 700;">${log.type.toUpperCase()}</span>
                                    <span style="color: #666;">${timestamp}</span>
                                </div>
                                <pre style="margin: 0; color: #aaa; font-size: 11px; white-space: pre-wrap;">${JSON.stringify(log.data, null, 2)}</pre>
                            </div>
                        `;
                    });
                    logsList.innerHTML = html;
                } else {
                    logsList.innerHTML = '<div style="text-align: center; padding: 40px; color: #666;">No webhook activity yet.<br><small>Set up alerts in TradingView to see activity here.</small></div>';
                }
            } catch (error) {
                console.error('Error loading webhook logs:', error);
                document.getElementById('webhookLogsList').innerHTML = '<div style="text-align: center; padding: 40px; color: #ef4444;">Error loading logs</div>';
            }
        }

        async function clearWebhookLogs() {
            if (!confirm('Clear all webhook logs?')) {
                return;
            }

            try {
                await fetch(API_BASE_URL + '/api/tradingview/webhook-logs', {
                    method: 'DELETE'
                });
                alert('‚úì Webhook logs cleared');
                await refreshWebhookLogs();
            } catch (error) {
                console.error('Error clearing logs:', error);
                alert('Error clearing logs');
            }
        }

        async function testWebhook() {
            try {
                const response = await fetch(API_BASE_URL + '/api/tradingview/test-webhook', {
                    method: 'POST'
                });
                const data = await response.json();

                if (data.success) {
                    alert('‚úì Test webhook received successfully!\n\nCheck "View Webhook Logs" to see the test alert.');
                    console.log('Test webhook response:', data);
                } else {
                    alert('‚úó Test webhook failed');
                }
            } catch (error) {
                console.error('Error testing webhook:', error);
                alert('‚úó Error testing webhook: ' + error.message);
            }

            // Close dropdown
            document.querySelectorAll('.dropdown').forEach(d => d.classList.remove('show'));
        }

        function exportWatchlist() {
            // Export watchlist in TradingView format
            const tvWatchlist = watchlist.join(',');
            const blob = new Blob([tvWatchlist], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'tradingview_watchlist.txt';
            a.click();
            URL.revokeObjectURL(url);

            alert('‚úì Watchlist exported!\n\nYou can import this in TradingView Desktop.');
            console.log('Exported watchlist:', tvWatchlist);

            // Close dropdown
            document.querySelectorAll('.dropdown').forEach(d => d.classList.remove('show'));
        }

        function showSetupGuide() {
            // Open setup guide in new window
            window.open('TRADINGVIEW_SETUP_GUIDE.html', '_blank');

            // Close dropdown
            document.querySelectorAll('.dropdown').forEach(d => d.classList.remove('show'));
        }

        function openTradingViewSetupGuide() {
            window.open('TRADINGVIEW_SETUP_GUIDE.html', '_blank');
        }

        // Auto-submit setting functions
        function saveAutoSubmitSetting(enabled) {
            localStorage.setItem('autoSubmitOrders', enabled ? 'true' : 'false');
            console.log('Auto-submit orders:', enabled ? 'ENABLED' : 'DISABLED');
        }

        function loadAutoSubmitSetting() {
            const saved = localStorage.getItem('autoSubmitOrders');
            const checkbox = document.getElementById('autoSubmitOrders');
            if (checkbox && saved === 'true') {
                checkbox.checked = true;
            }
        }

        function loadLayout(name) {
            windows.forEach(w => w.close());
            windows = [];

            if (name === 'custom') {
                loadCustomLayout();
            }
            else if (name === 'default') loadDefaultLayout();
            else if (name === 'trading') loadTradingLayout();
            else if (name === 'analysis') loadAnalysisLayout();
            else if (name === 'scalping') loadScalpingLayout();

            setTimeout(() => {
                loadPrice();
                loadLevel2();
                loadTimeSales();
                loadPositions();
                loadOrders();
                loadAccount();
                loadWorklist();

                // Initialize any charts that were created
                windows.forEach(win => {
                    if (win.id.startsWith('chart')) {
                        const chartId = win.id.replace('chart', '');
                        initChart(chartId, currentSymbol);
                    }
                });
            }, 1000);
        }

        function loadDefaultLayout() {
            createWindow('watchlist', 'WATCHLIST', windowTemplates.watchlist, 10, 10, 250, 400);
            createWindow('account', 'ACCOUNT', windowTemplates.account, 10, 420, 250, 280);
            createWindow('quote', `QUOTE - ${currentSymbol}`, windowTemplates.quote, 270, 10, 450, 180);
            createWindow('level2', `LEVEL II - ${currentSymbol}`, windowTemplates.level2, 270, 200, 450, 500);
            createWindow('timesales', 'TIME & SALES', windowTemplates.timesales, 730, 10, 280, 400);
            createWindow('order', 'ORDER ENTRY', windowTemplates.order, 730, 420, 280, 280);
            createWindow('chart1', `CHART - ${currentSymbol}`, windowTemplates.chart('1'), 1020, 10, 600, 400);
            createWindow('positions', 'POSITIONS', windowTemplates.positions, 1020, 420, 600, 140);
            createWindow('orders', 'ORDERS', windowTemplates.orders, 1020, 570, 600, 150);
        }

        function loadTradingLayout() {
            createWindow('quote', `QUOTE - ${currentSymbol}`, windowTemplates.quote, 10, 10, 400, 120);
            createWindow('level2', `LEVEL II - ${currentSymbol}`, windowTemplates.level2, 10, 140, 400, 560);
            createWindow('timesales', 'TIME & SALES', windowTemplates.timesales, 420, 10, 280, 400);
            createWindow('order', 'ORDER ENTRY', windowTemplates.order, 420, 420, 280, 280);
            createWindow('chart1', `CHART - ${currentSymbol}`, windowTemplates.chart('1'), 710, 10, 600, 500);
            createWindow('positions', 'POSITIONS', windowTemplates.positions, 710, 520, 600, 90);
            createWindow('orders', 'ORDERS', windowTemplates.orders, 710, 620, 600, 100);
            createWindow('watchlist', 'WATCHLIST', windowTemplates.watchlist, 1320, 10, 280, 400);
            createWindow('account', 'ACCOUNT', windowTemplates.account, 1320, 420, 280, 280);
        }

        function loadAnalysisLayout() {
            createWindow('chart1', `CHART 1 - ${currentSymbol}`, windowTemplates.chart('1'), 10, 10, 800, 450);
            createWindow('chart2', `CHART 2 - ${currentSymbol}`, windowTemplates.chart('2'), 820, 10, 800, 450);
            createWindow('watchlist', 'WATCHLIST', windowTemplates.watchlist, 10, 470, 250, 400);
            createWindow('level2', `LEVEL II - ${currentSymbol}`, windowTemplates.level2, 270, 470, 400, 400);
            createWindow('timesales', 'TIME & SALES', windowTemplates.timesales, 680, 470, 300, 400);
            createWindow('ai', 'AI ANALYSIS', windowTemplates.ai, 990, 470, 360, 200);
            createWindow('bot', 'BOT CONTROL', windowTemplates.bot, 990, 680, 360, 190);
            createWindow('account', 'ACCOUNT', windowTemplates.account, 1360, 470, 260, 200);
            createWindow('order', 'ORDER ENTRY', windowTemplates.order, 1360, 680, 260, 190);
        }

        function loadScalpingLayout() {
            createWindow('quote', `QUOTE - ${currentSymbol}`, windowTemplates.quote, 10, 10, 300, 120);
            createWindow('level2', `LEVEL II - ${currentSymbol}`, windowTemplates.level2, 10, 140, 400, 560);
            createWindow('order', 'ORDER ENTRY', windowTemplates.order, 420, 10, 280, 350);
            createWindow('timesales', 'TIME & SALES', windowTemplates.timesales, 420, 370, 280, 330);
            createWindow('chart1', `CHART - ${currentSymbol}`, windowTemplates.chart('1'), 710, 10, 700, 500);
            createWindow('positions', 'POSITIONS', windowTemplates.positions, 710, 520, 700, 90);
            createWindow('orders', 'ORDERS', windowTemplates.orders, 710, 620, 700, 100);
            createWindow('watchlist', 'WATCHLIST', windowTemplates.watchlist, 1420, 10, 200, 400);
            createWindow('account', 'ACCOUNT', windowTemplates.account, 1420, 420, 200, 280);
        }

        function loadCustomLayout() {
            const savedLayout = localStorage.getItem('customLayout');
            if (savedLayout) {
                try {
                    const layout = JSON.parse(savedLayout);
                    console.log('Loading custom layout with', layout.length, 'windows');
                    layout.forEach(w => {
                        // Handle chart templates specially - they need the function call
                        let template;
                        if (w.id.startsWith('chart')) {
                            const chartId = w.id.replace('chart', '');
                            template = windowTemplates.chart(chartId);
                        } else {
                            template = windowTemplates[w.id] || '';
                        }

                        createWindow(w.id, w.title, template, w.x, w.y, w.width, w.height);
                        if (w.minimized) {
                            const window = windows.find(win => win.id === w.id);
                            if (window) window.minimize();
                        }
                    });

                    // Initialize charts after windows are created
                    setTimeout(() => {
                        windows.forEach(win => {
                            if (win.id.startsWith('chart')) {
                                const chartId = win.id.replace('chart', '');
                                initChart(chartId, currentSymbol);
                            }
                        });
                    }, 500);
                } catch (e) {
                    console.error('Failed to load custom layout:', e);
                    alert('Failed to load custom layout. Loading default instead.');
                    loadDefaultLayout();
                }
            } else {
                alert('No custom layout saved.\n\nArrange windows and click "üíæ Save as Custom" to create one.');
                loadDefaultLayout();
            }
        }

        function resetLayout() {
            if (confirm('Reset to default layout?')) {
                localStorage.removeItem('tradingLayout');
                loadLayout('default');
            }
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        //                     INITIALIZATION
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        // TradingView Chart Management
        let chartWidgets = {};
        let chartInstances = {};
        let chartCounter = 0; // Track number of charts created
        let chartLinkStatus = {}; // Track which charts are linked to current symbol
        let chartSymbols = {}; // Track each chart's current symbol
        let chartTemplates = {}; // Track which template each chart uses

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // CHART TEMPLATES - Predefined indicator sets for different trading styles
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        const CHART_PRESETS = {
            'default': {
                name: 'Default',
                interval: '5',
                style: '1', // Candles
                studies: ['MASimple@tv-basicstudies', 'RSI@tv-basicstudies'],
                description: 'SMA + RSI'
            },
            'scalping': {
                name: 'Scalping (1m)',
                interval: '1',
                style: '1',
                studies: [
                    'MAExp@tv-basicstudies',      // EMA
                    'VWAP@tv-basicstudies',       // VWAP
                    'MACDHistogram@tv-basicstudies' // MACD
                ],
                description: 'EMA + VWAP + MACD'
            },
            'daytrading': {
                name: 'Day Trading (5m)',
                interval: '5',
                style: '1',
                studies: [
                    'MAExp@tv-basicstudies',      // EMA 9/21
                    'VWAP@tv-basicstudies',       // VWAP
                    'RSI@tv-basicstudies',        // RSI
                    'Volume@tv-basicstudies'      // Volume
                ],
                description: 'EMA + VWAP + RSI + Vol'
            },
            'swing': {
                name: 'Swing (1H)',
                interval: '60',
                style: '1',
                studies: [
                    'MASimple@tv-basicstudies',   // SMA 20/50/200
                    'RSI@tv-basicstudies',        // RSI
                    'MACD@tv-basicstudies',       // MACD
                    'BB@tv-basicstudies'          // Bollinger Bands
                ],
                description: 'SMA + RSI + MACD + BB'
            },
            'momentum': {
                name: 'Momentum (15m)',
                interval: '15',
                style: '1',
                studies: [
                    'MAExp@tv-basicstudies',      // EMA
                    'RSI@tv-basicstudies',        // RSI
                    'MACDHistogram@tv-basicstudies', // MACD Histogram
                    'VWAP@tv-basicstudies'        // VWAP
                ],
                description: 'EMA + RSI + MACD + VWAP'
            },
            'volume': {
                name: 'Volume Profile',
                interval: '5',
                style: '1',
                studies: [
                    'VWAP@tv-basicstudies',       // VWAP
                    'Volume@tv-basicstudies',     // Volume
                    'MASimple@tv-basicstudies'    // SMA
                ],
                description: 'VWAP + Volume + SMA'
            },
            'clean': {
                name: 'Clean (No Indicators)',
                interval: '5',
                style: '1',
                studies: [],
                description: 'Price only'
            },
            'warrior': {
                name: 'Warrior Trading',
                interval: '1',
                style: '1',
                studies: [
                    'MAExp@tv-basicstudies',      // 9 EMA
                    'VWAP@tv-basicstudies',       // VWAP (key level)
                    'Volume@tv-basicstudies'      // Volume for confirmation
                ],
                description: '9 EMA + VWAP + Volume'
            }
        };

        // Available TradingView studies/indicators for user selection
        const AVAILABLE_STUDIES = {
            'MASimple@tv-basicstudies': { name: 'SMA (Simple Moving Average)', category: 'Moving Averages' },
            'MAExp@tv-basicstudies': { name: 'EMA (Exponential Moving Average)', category: 'Moving Averages' },
            'MAWeighted@tv-basicstudies': { name: 'WMA (Weighted Moving Average)', category: 'Moving Averages' },
            'VWAP@tv-basicstudies': { name: 'VWAP', category: 'Volume' },
            'Volume@tv-basicstudies': { name: 'Volume', category: 'Volume' },
            'RSI@tv-basicstudies': { name: 'RSI (Relative Strength Index)', category: 'Momentum' },
            'MACD@tv-basicstudies': { name: 'MACD', category: 'Momentum' },
            'MACDHistogram@tv-basicstudies': { name: 'MACD Histogram', category: 'Momentum' },
            'Stochastic@tv-basicstudies': { name: 'Stochastic', category: 'Momentum' },
            'BB@tv-basicstudies': { name: 'Bollinger Bands', category: 'Volatility' },
            'ATR@tv-basicstudies': { name: 'ATR (Average True Range)', category: 'Volatility' },
            'PSAR@tv-basicstudies': { name: 'Parabolic SAR', category: 'Trend' },
            'IchimokuCloud@tv-basicstudies': { name: 'Ichimoku Cloud', category: 'Trend' },
            'ADX@tv-basicstudies': { name: 'ADX', category: 'Trend' },
            'CCI@tv-basicstudies': { name: 'CCI (Commodity Channel Index)', category: 'Momentum' },
            'WilliamsR@tv-basicstudies': { name: 'Williams %R', category: 'Momentum' },
            'OBV@tv-basicstudies': { name: 'OBV (On Balance Volume)', category: 'Volume' },
            'MFI@tv-basicstudies': { name: 'MFI (Money Flow Index)', category: 'Volume' },
            'PivotPointsStandard@tv-basicstudies': { name: 'Pivot Points', category: 'Support/Resistance' }
        };

        // Get saved chart templates from localStorage
        function getSavedChartTemplates() {
            const saved = localStorage.getItem('customChartTemplates');
            return saved ? JSON.parse(saved) : {};
        }

        // Get timeframe default templates
        function getTimeframeDefaults() {
            const saved = localStorage.getItem('timeframeDefaultTemplates');
            return saved ? JSON.parse(saved) : {};
        }

        // Set a template as default for a timeframe
        function setTimeframeDefault(interval, templateName) {
            const defaults = getTimeframeDefaults();
            defaults[interval] = templateName;
            localStorage.setItem('timeframeDefaultTemplates', JSON.stringify(defaults));
            console.log(`Set "${templateName}" as default template for ${getTimeframeName(interval)} timeframe`);
        }

        // Get default template for a timeframe
        function getDefaultTemplateForTimeframe(interval) {
            const defaults = getTimeframeDefaults();
            return defaults[interval] || null;
        }

        // Save custom chart template
        function saveChartTemplate(name, config) {
            const templates = getSavedChartTemplates();
            templates[name] = config;
            localStorage.setItem('customChartTemplates', JSON.stringify(templates));
            console.log(`Saved custom template: ${name}`);
        }

        // Delete custom chart template
        function deleteChartTemplate(name) {
            const templates = getSavedChartTemplates();
            if (templates[name]) {
                delete templates[name];
                localStorage.setItem('customChartTemplates', JSON.stringify(templates));

                // Also remove from timeframe defaults if set
                const defaults = getTimeframeDefaults();
                for (const [interval, templateName] of Object.entries(defaults)) {
                    if (templateName === name) {
                        delete defaults[interval];
                    }
                }
                localStorage.setItem('timeframeDefaultTemplates', JSON.stringify(defaults));
                console.log(`Deleted custom template: ${name}`);
                return true;
            }
            return false;
        }

        // Get all available templates (built-in + custom)
        function getAllChartTemplates() {
            return { ...CHART_PRESETS, ...getSavedChartTemplates() };
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // CUSTOM TEMPLATE DIALOG FUNCTIONS
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        function showCreateTemplateDialog() {
            // Reset form
            document.getElementById('newTemplateName').value = '';
            document.getElementById('newTemplateTimeframe').value = '5';
            document.getElementById('newTemplateStyle').value = '1';
            document.getElementById('setAsTimeframeDefault').checked = false;

            // Populate indicator checkboxes
            const container = document.getElementById('indicatorCheckboxes');
            let html = '';

            // Group indicators by category
            const categories = {};
            for (const [key, info] of Object.entries(AVAILABLE_STUDIES)) {
                if (!categories[info.category]) categories[info.category] = [];
                categories[info.category].push({ key, ...info });
            }

            for (const [category, indicators] of Object.entries(categories)) {
                html += `<div style="margin-bottom: 10px;">
                    <div style="color: #60a5fa; font-size: 11px; font-weight: 600; margin-bottom: 5px; text-transform: uppercase;">${category}</div>`;
                for (const ind of indicators) {
                    html += `<label style="display: flex; align-items: center; gap: 8px; padding: 4px 0; cursor: pointer; color: #ccc;">
                        <input type="checkbox" class="indicator-checkbox" value="${ind.key}" style="width: 14px; height: 14px;">
                        <span style="font-size: 12px;">${ind.name}</span>
                    </label>`;
                }
                html += '</div>';
            }
            container.innerHTML = html;

            document.getElementById('createTemplateDialog').classList.add('show');
            document.querySelectorAll('.dropdown').forEach(d => d.classList.remove('show'));
        }

        function closeCreateTemplateDialog() {
            document.getElementById('createTemplateDialog').classList.remove('show');
        }

        function saveNewTemplate() {
            const name = document.getElementById('newTemplateName').value.trim();
            if (!name) {
                alert('Please enter a template name');
                return;
            }

            // Check for duplicate names (not allowed to override built-ins)
            if (CHART_PRESETS[name.toLowerCase().replace(/\s+/g, '')]) {
                alert('Cannot override built-in template. Choose a different name.');
                return;
            }

            const interval = document.getElementById('newTemplateTimeframe').value;
            const style = document.getElementById('newTemplateStyle').value;
            const setAsDefault = document.getElementById('setAsTimeframeDefault').checked;

            // Get selected indicators
            const checkboxes = document.querySelectorAll('.indicator-checkbox:checked');
            const studies = Array.from(checkboxes).map(cb => cb.value);

            // Create template key (sanitized name)
            const templateKey = 'custom_' + name.toLowerCase().replace(/[^a-z0-9]/g, '_');

            // Build description from selected indicators
            const studyNames = studies.map(s => {
                const info = AVAILABLE_STUDIES[s];
                return info ? info.name.split(' ')[0] : s.split('@')[0];
            });
            const description = studyNames.length > 0 ? studyNames.join(' + ') : 'No indicators';

            const config = {
                name: name,
                interval: interval,
                style: style,
                studies: studies,
                description: description,
                isCustom: true,
                createdAt: new Date().toISOString()
            };

            // Save the template
            saveChartTemplate(templateKey, config);

            // Set as timeframe default if checked
            if (setAsDefault) {
                setTimeframeDefault(interval, templateKey);
            }

            closeCreateTemplateDialog();
            alert(`Template "${name}" saved successfully!`);

            // Refresh manage dialog if open
            if (document.getElementById('manageTemplatesDialog').classList.contains('show')) {
                refreshManageTemplatesDialog();
            }
        }

        function showManageTemplatesDialog() {
            refreshManageTemplatesDialog();
            document.getElementById('manageTemplatesDialog').classList.add('show');
            document.querySelectorAll('.dropdown').forEach(d => d.classList.remove('show'));
        }

        function closeManageTemplatesDialog() {
            document.getElementById('manageTemplatesDialog').classList.remove('show');
        }

        // Refresh the template dropdown in a chart header
        function refreshChartTemplateDropdown(chartId) {
            const select = document.getElementById(`chart-template-${chartId}`);
            if (!select) return;

            const currentTemplate = chartTemplates[chartId] || 'default';
            const allTemplates = getAllChartTemplates();

            let html = '<optgroup label="Built-in Templates">';
            for (const [key, template] of Object.entries(CHART_PRESETS)) {
                const selected = key === currentTemplate ? 'selected' : '';
                html += `<option value="${key}" ${selected}>${template.name}</option>`;
            }
            html += '</optgroup>';

            // Add custom templates
            const customTemplates = getSavedChartTemplates();
            const customKeys = Object.keys(customTemplates).filter(k => k.startsWith('custom_') && !k.match(/^custom_\d+$/));
            if (customKeys.length > 0) {
                html += '<optgroup label="My Templates">';
                for (const key of customKeys) {
                    const template = customTemplates[key];
                    const selected = key === currentTemplate ? 'selected' : '';
                    html += `<option value="${key}" ${selected}>${template.name}</option>`;
                }
                html += '</optgroup>';
            }

            select.innerHTML = html;
        }

        // Initialize all chart template dropdowns
        function initAllChartTemplateDropdowns() {
            for (const chartId of Object.keys(chartTemplates)) {
                refreshChartTemplateDropdown(chartId);
            }
        }

        function refreshManageTemplatesDialog() {
            // Populate timeframe defaults
            const defaultsContainer = document.getElementById('timeframeDefaultsList');
            const defaults = getTimeframeDefaults();
            const allTemplates = getAllChartTemplates();

            const timeframes = ['1', '5', '15', '30', '60', '240', 'D', 'W'];
            let defaultsHtml = '';

            for (const tf of timeframes) {
                const templateKey = defaults[tf];
                const template = templateKey ? allTemplates[templateKey] : null;
                const templateName = template ? template.name : '(Built-in default)';
                const tfName = getTimeframeName(tf);

                defaultsHtml += `<div style="display: flex; justify-content: space-between; align-items: center; padding: 6px 0; border-bottom: 1px solid #333;">
                    <span style="color: #888; font-size: 12px;">${tfName}:</span>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <span style="color: ${template ? '#22c55e' : '#666'}; font-size: 12px;">${templateName}</span>
                        ${template ? `<button onclick="clearTimeframeDefault('${tf}')" style="background: #ef4444; color: #fff; border: none; padding: 2px 6px; border-radius: 3px; font-size: 10px; cursor: pointer;">Clear</button>` : ''}
                    </div>
                </div>`;
            }
            defaultsContainer.innerHTML = defaultsHtml || '<div style="color: #666; font-size: 12px;">No custom defaults set</div>';

            // Populate custom templates
            const templatesContainer = document.getElementById('customTemplatesList');
            const customTemplates = getSavedChartTemplates();
            let templatesHtml = '';

            for (const [key, template] of Object.entries(customTemplates)) {
                if (key.startsWith('custom_') && !key.match(/^custom_\d+$/)) { // Skip temp custom templates
                    const tfName = getTimeframeName(template.interval);
                    templatesHtml += `<div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; background: #252525; border-radius: 4px; margin-bottom: 6px;">
                        <div>
                            <div style="color: #fff; font-weight: 600; font-size: 13px;">${template.name}</div>
                            <div style="color: #888; font-size: 11px;">${tfName} - ${template.description}</div>
                        </div>
                        <div style="display: flex; gap: 5px;">
                            <button onclick="setTemplateAsDefault('${key}')" style="background: #3b82f6; color: #fff; border: none; padding: 4px 8px; border-radius: 3px; font-size: 11px; cursor: pointer;">Set Default</button>
                            <button onclick="confirmDeleteTemplate('${key}', '${template.name}')" style="background: #ef4444; color: #fff; border: none; padding: 4px 8px; border-radius: 3px; font-size: 11px; cursor: pointer;">Delete</button>
                        </div>
                    </div>`;
                }
            }
            templatesContainer.innerHTML = templatesHtml || '<div style="color: #666; font-size: 12px; text-align: center; padding: 20px;">No custom templates yet. Click "+ New Template" to create one.</div>';
        }

        function setTemplateAsDefault(templateKey) {
            const template = getAllChartTemplates()[templateKey];
            if (template) {
                setTimeframeDefault(template.interval, templateKey);
                refreshManageTemplatesDialog();
                alert(`"${template.name}" set as default for ${getTimeframeName(template.interval)} timeframe`);
            }
        }

        function clearTimeframeDefault(interval) {
            const defaults = getTimeframeDefaults();
            delete defaults[interval];
            localStorage.setItem('timeframeDefaultTemplates', JSON.stringify(defaults));
            refreshManageTemplatesDialog();
        }

        function confirmDeleteTemplate(key, name) {
            if (confirm(`Delete template "${name}"? This cannot be undone.`)) {
                deleteChartTemplate(key);
                refreshManageTemplatesDialog();
            }
        }

        // Toggle chart link status
        function toggleChartLink(chartId) {
            const btn = document.getElementById(`chart-link-${chartId}`);
            const symbolInput = document.getElementById(`chart-symbol-${chartId}`);
            const symbolDisplay = document.getElementById(`chart-symbol-display-${chartId}`);

            if (!btn) return;

            const isLinked = chartLinkStatus[chartId] !== false; // Default to linked

            if (isLinked) {
                // Unlink the chart
                chartLinkStatus[chartId] = false;
                btn.classList.remove('linked');
                btn.classList.add('unlinked');
                btn.innerHTML = 'üîì';
                btn.title = 'Click to link to selected symbol';
                if (symbolInput) {
                    symbolInput.style.display = 'inline-block';
                    symbolInput.value = chartSymbols[chartId] || currentSymbol;
                    symbolInput.focus();
                    symbolInput.select();
                }
                if (symbolDisplay) symbolDisplay.style.display = 'none';
                console.log(`Chart ${chartId} unlinked - now independent`);
            } else {
                // Link the chart
                chartLinkStatus[chartId] = true;
                btn.classList.remove('unlinked');
                btn.classList.add('linked');
                btn.innerHTML = 'üîó';
                btn.title = 'Click to unlink from selected symbol';
                if (symbolInput) symbolInput.style.display = 'none';
                if (symbolDisplay) symbolDisplay.style.display = 'inline';
                // Update to current symbol
                setChartSymbol(chartId, currentSymbol);
                console.log(`Chart ${chartId} linked - synced to ${currentSymbol}`);
            }
        }

        // Set a specific chart's symbol
        function setChartSymbol(chartId, symbol) {
            symbol = symbol.toUpperCase().trim();
            if (!symbol) return;

            chartSymbols[chartId] = symbol;

            // Update display
            const displaySpan = document.getElementById(`chart-symbol-display-${chartId}`);
            if (displaySpan) {
                displaySpan.textContent = symbol;
            }

            // Update the chart
            updateChart(`chart${chartId}`, symbol);
        }

        // Check if a chart is linked
        function isChartLinked(chartId) {
            return chartLinkStatus[chartId] !== false; // Default to linked
        }

        // Initialize chart with optional template/preset
        function initChart(id, symbol, templateName = 'default') {
            const containerId = `chart-${id}`;
            const container = document.getElementById(containerId);
            if (!container) {
                console.log(`Chart container ${containerId} not found`);
                return;
            }

            // Check if TradingView is available
            if (typeof TradingView === 'undefined') {
                console.error('TradingView library not loaded');
                container.innerHTML = `<div class="empty-state" style="padding: 20px; text-align: center;">
                    <div style="font-size: 16px; color: #ef4444; margin-bottom: 10px;">‚ö†Ô∏è TradingView Not Available</div>
                    <div style="font-size: 13px; color: #888;">
                        The TradingView charting library failed to load.<br>
                        <small>Check your internet connection or browser console for errors.</small>
                    </div>
                </div>`;
                return;
            }

            // Get template configuration
            const allTemplates = getAllChartTemplates();
            const template = allTemplates[templateName] || CHART_PRESETS['default'];
            const interval = template.interval || '5';
            const style = template.style || '1';
            const studies = template.studies || ['MASimple@tv-basicstudies', 'RSI@tv-basicstudies'];

            console.log(`Initializing chart ${id} for ${symbol} with template "${templateName}" (${interval})`);

            // Track the symbol and template for this chart
            chartSymbols[id] = symbol;
            chartTemplates[id] = templateName;

            // Update symbol display in header
            const displaySpan = document.getElementById(`chart-symbol-display-${id}`);
            if (displaySpan) {
                displaySpan.textContent = symbol;
            }

            // Update template selector in header (populate with all templates)
            refreshChartTemplateDropdown(id);

            try {
                // Clear container and clean up old widget
                container.innerHTML = '';

                if (chartWidgets[id]) {
                    try {
                        chartWidgets[id].remove();
                    } catch (e) {
                        // Ignore removal errors - container is already cleared
                    }
                    delete chartWidgets[id];
                    delete chartInstances[id];
                }

                // Create new widget with template settings
                chartWidgets[id] = new TradingView.widget({
                    "width": "100%",
                    "height": "100%",
                    "symbol": `NASDAQ:${symbol}`,
                    "interval": interval,
                    "timezone": "America/New_York",
                    "theme": "dark",
                    "style": style,
                    "locale": "en",
                    "toolbar_bg": "#1a1a1a",
                    "enable_publishing": false,
                    "hide_side_toolbar": false,
                    "allow_symbol_change": true,
                    "container_id": containerId,
                    "studies": studies,
                    "backgroundColor": "#1a1a1a",
                    "gridColor": "#2a2a2a",
                    "hide_legend": false,
                    "save_image": false,
                    "onChartReady": function() {
                        chartInstances[id] = chartWidgets[id].chart();
                        console.log(`Chart ${id} ready for ${symbol} (${template.name}, ${interval})`);
                    }
                });
            } catch (e) {
                console.error('TradingView init error:', e);
                container.innerHTML = '<div class="empty-state">TradingView Desktop connection required</div>';
            }
        }

        // Change chart template
        function changeChartTemplate(chartId, templateName) {
            const symbol = chartSymbols[chartId] || currentSymbol;
            chartTemplates[chartId] = templateName;
            console.log(`Changing chart ${chartId} to template "${templateName}"`);
            initChart(chartId, symbol, templateName);
        }

        // Get template options HTML for select dropdown
        function getChartTemplateOptionsHTML(selectedTemplate = 'default') {
            const allTemplates = getAllChartTemplates();
            let html = '';
            for (const [key, template] of Object.entries(allTemplates)) {
                const selected = key === selectedTemplate ? 'selected' : '';
                html += `<option value="${key}" ${selected}>${template.name}</option>`;
            }
            return html;
        }

        function updateChart(winId, symbol) {
            // Extract chart ID from window ID (e.g., 'chart1' -> '1')
            const chartId = winId.replace('chart', '');

            // Preserve the current template
            const currentTemplate = chartTemplates[chartId] || 'default';

            if (chartInstances[chartId]) {
                try {
                    // Use the chart instance to change symbol
                    chartInstances[chartId].setSymbol(`NASDAQ:${symbol}`, function() {
                        console.log(`Chart ${chartId} updated to ${symbol}`);
                    });
                    // Update tracked symbol
                    chartSymbols[chartId] = symbol;
                    // Update symbol display
                    const displaySpan = document.getElementById(`chart-symbol-display-${chartId}`);
                    if (displaySpan) displaySpan.textContent = symbol;
                } catch (e) {
                    console.log('Chart update error, reinitializing:', e);
                    initChart(chartId, symbol, currentTemplate);
                }
            } else if (chartWidgets[chartId]) {
                // Widget exists but no chart instance yet - reinit
                console.log(`No chart instance for ${chartId}, reinitializing`);
                initChart(chartId, symbol, currentTemplate);
            } else {
                // No widget at all - initialize
                console.log(`Creating chart ${chartId} for ${symbol}`);
                initChart(chartId, symbol, currentTemplate);
            }
        }

        // Function to load AI-Only layout (full screen AI Control Panel)
        function loadAIOnlyLayout() {
            // Hide menu bar and make workspace full height
            const menuBar = document.querySelector('.menu-bar');
            if (menuBar) menuBar.style.display = 'none';

            // Get viewport dimensions
            const viewportWidth = window.innerWidth - 20;
            const viewportHeight = window.innerHeight - 60;

            // Create maximized AI Control Panel
            createWindow('aicontrol', 'ü§ñ AI CONTROL PANEL', windowTemplates.aicontrol, 10, 10, viewportWidth, viewportHeight);

            // Make it non-closable and remove resize
            setTimeout(() => {
                const win = windows.find(w => w.id === 'aicontrol');
                if (win && win.element) {
                    const closeBtn = win.element.querySelector('.window-close');
                    if (closeBtn) closeBtn.style.display = 'none';
                }
            }, 100);
        }

        window.addEventListener('load', async () => {
            console.log('%cüöÄ Morpheus Trading Bot - Professional Platform', 'color: #007acc; font-size: 18px; font-weight: bold;');

            // Check for URL parameters
            const urlParams = new URLSearchParams(window.location.search);
            const panelMode = urlParams.get('panel');

            // Start unified price refresh system
            startUnifiedRefresh();
            console.log('[SYNC] Unified refresh system started (updates every 2 seconds)');

            // Initialize configuration system
            updateSavedConfigsList();

            // Load saved watchlist
            const savedWatchlist = localStorage.getItem('watchlist');
            if (savedWatchlist) {
                watchlist = JSON.parse(savedWatchlist);
            }

            // Load auto-submit orders setting
            loadAutoSubmitSetting();

            // Check if AI-only mode requested via URL parameter
            if (panelMode === 'ai') {
                console.log('ü§ñ Loading AI-Only mode...');
                loadAIOnlyLayout();

                // Still need to subscribe and initialize broker
                const subscribePromises = watchlist.map(symbol => subscribeToSymbol(symbol));
                subscribePromises.push(subscribeToSymbol(currentSymbol));
                await Promise.all(subscribePromises);

                await initBrokerState();

                // Start data updates
                setInterval(() => { loadPrice(); }, 5000);
                setInterval(() => { loadPositions(); loadAccount(); }, 15000);

                return; // Skip normal layout loading
            }

            // Priority: 1. Startup Default Layout (user's saved preference)
            //           2. Custom Layout (legacy)
            //           3. Old Trading Layout (migrate)
            //           4. Built-in Default Layout
            const startupDefault = localStorage.getItem('startupDefaultLayout');
            const customLayout = localStorage.getItem('customLayout');
            const oldSavedLayout = localStorage.getItem('tradingLayout');

            if (startupDefault) {
                console.log('Loading startup default layout...');
                if (!loadStartupDefaultLayout()) {
                    console.log('Fallback to built-in default...');
                    loadLayout('default');
                }
            } else if (customLayout) {
                console.log('Loading custom layout...');
                loadLayout('custom');
            } else if (oldSavedLayout) {
                console.log('Loading old saved layout (migrating to custom)...');
                // Migrate old layout to custom
                try {
                    localStorage.setItem('customLayout', oldSavedLayout);
                    localStorage.removeItem('tradingLayout');
                    loadLayout('custom');
                } catch (e) {
                    console.error('Failed to migrate layout:', e);
                    loadLayout('default');
                }
            } else {
                // Load built-in default layout if no saved layout
                console.log('Loading built-in default layout...');
                loadLayout('default');
            }

            // Subscribe to all watchlist symbols IN PARALLEL (was sequential - caused 29s delay!)
            console.log('üìä Subscribing to market data...');
            let t0 = performance.now();
            const subscribePromises = watchlist.map(symbol => subscribeToSymbol(symbol));
            subscribePromises.push(subscribeToSymbol(currentSymbol));
            await Promise.all(subscribePromises);
            console.log(`‚úì Subscribed to ${watchlist.length + 1} symbols in ${(performance.now()-t0).toFixed(0)}ms`);

            // Start status check
            checkStatus();
            setInterval(checkStatus, 30000);  // Every 30 seconds to prevent resource exhaustion

            // Initialize broker state FIRST (Schwab)
            // Must complete before data loading starts
            t0 = performance.now();
            await initBrokerState();
            console.log(`‚úì Broker state initialized in ${(performance.now()-t0).toFixed(0)}ms`);

            // Load trading accounts for account selector
            await loadTradingAccounts();
            console.log(`‚úì Trading accounts loaded`);

            // Now load initial data IN PARALLEL (was sequential)
            t0 = performance.now();
            await Promise.all([
                loadAccount(),
                loadPositions(),
                loadOrders()
            ]);
            console.log(`‚úì Account/Positions/Orders loaded in ${(performance.now()-t0).toFixed(0)}ms`);

            // Start data updates (every 5 seconds to prevent resource exhaustion)
            setInterval(() => {
                loadPrice();
            }, 5000);

            // Check Polygon stream status on startup
            checkPolygonStream().then(active => {
                console.log(`Polygon stream: ${active ? 'ACTIVE' : 'inactive'}`);
            });

            // Level 2 refresh (every 2 seconds)
            setInterval(() => {
                loadLevel2();
            }, 2000);

            // Time & Sales - fast refresh for real-time tape (every 50ms)
            setInterval(() => {
                loadTimeSales();
            }, 50);

            // Periodically re-check Polygon stream status
            setInterval(checkPolygonStream, 30000);

            // Slower updates for account data (every 15 seconds)
            setInterval(() => {
                loadPositions();
                loadAccount();
            }, 15000);

            // Worklist refresh (every 30 seconds - it's mostly static)
            setInterval(() => {
                loadWorklist();
            }, 30000);

            // Initialize order form price field based on selected order type
            handleOrderTypeChange();

            console.log('%c‚úì Platform Ready', 'color: #22c55e; font-weight: bold;');
            console.log('%cüí° Click symbols in watchlist ‚Ä¢ Click Level 2 prices to fill orders ‚Ä¢ Drag & resize windows', 'color: #888; font-size: 15px;');

            // Initialize Sterling-style keyboard shortcuts
            initSterlingHotkeys();
        });

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        //                     CONFIGURABLE HOTKEY SYSTEM (STERLING-STYLE)
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        let sterlingHotkeysEnabled = true;

        // Default hotkey configuration
        // Format: 'KEY' or 'SHIFT+KEY' or 'CTRL+KEY' or 'ALT+KEY' or 'CTRL+SHIFT+KEY'
        const defaultHotkeyConfig = {
            // Orders (recommend using modifiers for safety)
            buyAsk: 'SHIFT+B',
            buyBid: '',
            buyMarket: 'SHIFT+M',
            sellBid: 'SHIFT+S',
            sellAsk: '',
            sellMarket: 'SHIFT+N',
            sellShort: '',
            // Position Sells (sell current position)
            sellAllAsk: 'CTRL+A',
            sellAllBid: 'CTRL+B',
            sellHalfAsk: 'CTRL+H',
            sellQuarterAsk: 'CTRL+Q',
            // Quantities - key bindings (no modifier needed - safe)
            qty1Key: '1',
            qty2Key: '2',
            qty3Key: '3',
            qty4Key: '4',
            qty5Key: '5',
            // Quantities - share amounts (editable)
            qty1Shares: 100,
            qty2Shares: 200,
            qty3Shares: 500,
            qty4Shares: 1000,
            qty5Shares: 2000,
            // Price adjustments
            priceUp1: '+',
            priceDown1: '-',
            priceUp5: '',
            priceDown5: '',
            setBid: '',
            setAsk: '',
            // Management
            cancelAll: 'SHIFT+X',
            flatten: 'SHIFT+F',
            flattenAll: 'CTRL+SHIFT+F',
            reverse: 'SHIFT+R',
            help: '?'
        };

        // Current hotkey configuration (loaded from localStorage or defaults)
        let hotkeyConfig = { ...defaultHotkeyConfig };

        // Parse hotkey combo string like "SHIFT+B" or "CTRL+SHIFT+1" into parts
        function parseHotkeyCombo(combo) {
            if (!combo || typeof combo !== 'string') return { key: '', shift: false, ctrl: false, alt: false };
            const parts = combo.toUpperCase().split('+');
            const key = parts[parts.length - 1]; // Last part is always the key
            return {
                key: key,
                shift: parts.includes('SHIFT'),
                ctrl: parts.includes('CTRL'),
                alt: parts.includes('ALT')
            };
        }

        // Check if keyboard event matches a hotkey combo
        function matchesHotkey(event, combo) {
            if (!combo) return false;
            const parsed = parseHotkeyCombo(combo);
            if (!parsed.key) return false;

            const pressedKey = event.key.toUpperCase();
            // Handle special keys
            const keyMatches = pressedKey === parsed.key ||
                              (parsed.key === '!' && event.key === '!' && event.shiftKey) ||
                              (parsed.key === '+' && (event.key === '+' || event.key === '=')) ||
                              (parsed.key === '-' && event.key === '-');

            return keyMatches &&
                   event.shiftKey === parsed.shift &&
                   event.ctrlKey === parsed.ctrl &&
                   event.altKey === parsed.alt;
        }

        // Format hotkey combo for display
        function formatHotkeyCombo(combo) {
            if (!combo) return '';
            return combo.toUpperCase();
        }

        // Build hotkey combo string from parts
        function buildHotkeyCombo(key, shift, ctrl, alt) {
            if (!key) return '';
            let parts = [];
            if (ctrl) parts.push('CTRL');
            if (shift) parts.push('SHIFT');
            if (alt) parts.push('ALT');
            parts.push(key.toUpperCase());
            return parts.join('+');
        }

        function initSterlingHotkeys() {
            // Load saved hotkey config
            loadHotkeyConfig();
            // Add keyboard event listener
            document.addEventListener('keydown', handleSterlingHotkey);
            console.log('[STERLING] Hotkeys initialized. Press ? for help or Tools > Hotkey Settings to configure.');
        }

        function loadHotkeyConfig() {
            const saved = localStorage.getItem('sterlingHotkeyConfig');
            if (saved) {
                try {
                    hotkeyConfig = { ...defaultHotkeyConfig, ...JSON.parse(saved) };
                    console.log('[HOTKEYS] Loaded custom configuration');
                } catch (e) {
                    console.error('[HOTKEYS] Error loading config, using defaults');
                    hotkeyConfig = { ...defaultHotkeyConfig };
                }
            }
        }

        function saveHotkeyConfig() {
            localStorage.setItem('sterlingHotkeyConfig', JSON.stringify(hotkeyConfig));
            showNotification('Hotkey configuration saved', 'success');
            console.log('[HOTKEYS] Configuration saved');
        }

        function resetHotkeysToDefault() {
            if (confirm('Reset all hotkeys to default settings?')) {
                hotkeyConfig = { ...defaultHotkeyConfig };
                localStorage.removeItem('sterlingHotkeyConfig');
                updateHotkeyPanelUI();
                showNotification('Hotkeys reset to defaults', 'info');
            }
        }

        function updateHotkeyBinding(action, key) {
            hotkeyConfig[action] = key.toUpperCase();
            console.log(`[HOTKEYS] ${action} = ${key.toUpperCase()}`);
        }

        // Update hotkey combo from modifier dropdown + key input
        function updateHotkeyCombo(action) {
            const modSelect = document.getElementById(`hk_${action}_mod`);
            const keyInput = document.getElementById(`hk_${action}_key`);
            if (!modSelect || !keyInput) return;

            const modifier = modSelect.value;
            const key = keyInput.value.toUpperCase();

            if (!key) {
                hotkeyConfig[action] = '';
            } else if (modifier) {
                hotkeyConfig[action] = `${modifier}+${key}`;
            } else {
                hotkeyConfig[action] = key;
            }
            console.log(`[HOTKEYS] ${action} = ${hotkeyConfig[action]}`);
        }

        function toggleHotkeysEnabled(enabled) {
            sterlingHotkeysEnabled = enabled;
            const statusText = document.getElementById('hotkeysStatusText');
            if (statusText) {
                statusText.textContent = enabled ? 'ENABLED' : 'DISABLED';
                statusText.style.color = enabled ? '#00cc00' : '#cc0000';
            }
            showNotification(enabled ? 'Hotkeys enabled' : 'Hotkeys disabled', 'info');
        }

        function handleSterlingHotkey(e) {
            if (!sterlingHotkeysEnabled) return;

            // Don't trigger if typing in an input field
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') {
                return;
            }

            // ESC always cancels (hardcoded - no modifier needed)
            if (e.key === 'Escape') {
                cancelAllOrders();
                showHotkeyFeedback('CANCEL ALL');
                e.preventDefault();
                return;
            }

            // Check against configured hotkeys using matchesHotkey (supports modifiers)
            // Quantity presets (with configurable share amounts)
            if (matchesHotkey(e, hotkeyConfig.qty1Key)) {
                const shares = hotkeyConfig.qty1Shares || 100;
                setQuantity(shares); showHotkeyFeedback('QTY: ' + shares); e.preventDefault();
            }
            else if (matchesHotkey(e, hotkeyConfig.qty2Key)) {
                const shares = hotkeyConfig.qty2Shares || 200;
                setQuantity(shares); showHotkeyFeedback('QTY: ' + shares); e.preventDefault();
            }
            else if (matchesHotkey(e, hotkeyConfig.qty3Key)) {
                const shares = hotkeyConfig.qty3Shares || 500;
                setQuantity(shares); showHotkeyFeedback('QTY: ' + shares); e.preventDefault();
            }
            else if (matchesHotkey(e, hotkeyConfig.qty4Key)) {
                const shares = hotkeyConfig.qty4Shares || 1000;
                setQuantity(shares); showHotkeyFeedback('QTY: ' + shares); e.preventDefault();
            }
            else if (matchesHotkey(e, hotkeyConfig.qty5Key)) {
                const shares = hotkeyConfig.qty5Shares || 2000;
                setQuantity(shares); showHotkeyFeedback('QTY: ' + shares); e.preventDefault();
            }
            // Order actions
            else if (matchesHotkey(e, hotkeyConfig.buyAsk)) {
                submitOrderAtPrice('BUY', 'ASK', e);
                showHotkeyFeedback('BUY @ ASK');
                e.preventDefault();
            }
            else if (matchesHotkey(e, hotkeyConfig.buyBid)) {
                submitOrderAtPrice('BUY', 'BID', e);
                showHotkeyFeedback('BUY @ BID');
                e.preventDefault();
            }
            else if (matchesHotkey(e, hotkeyConfig.buyMarket)) {
                submitOrder('BUY_MARKET');
                showHotkeyFeedback('BUY MARKET');
                e.preventDefault();
            }
            else if (matchesHotkey(e, hotkeyConfig.sellBid)) {
                submitOrderAtPrice('SELL', 'BID', e);
                showHotkeyFeedback('SELL @ BID');
                e.preventDefault();
            }
            else if (matchesHotkey(e, hotkeyConfig.sellAsk)) {
                submitOrderAtPrice('SELL', 'ASK', e);
                showHotkeyFeedback('SELL @ ASK');
                e.preventDefault();
            }
            else if (matchesHotkey(e, hotkeyConfig.sellMarket)) {
                submitOrder('SELL_MARKET');
                showHotkeyFeedback('SELL MARKET');
                e.preventDefault();
            }
            else if (matchesHotkey(e, hotkeyConfig.sellShort)) {
                submitOrder('SELL_SHORT');
                showHotkeyFeedback('SELL SHORT');
                e.preventDefault();
            }
            // Position Sells (sell all or partial position)
            else if (matchesHotkey(e, hotkeyConfig.sellAllAsk)) {
                sellPositionAtPrice(1.0, 'ASK');
                showHotkeyFeedback('SELL ALL @ ASK');
                e.preventDefault();
            }
            else if (matchesHotkey(e, hotkeyConfig.sellAllBid)) {
                sellPositionAtPrice(1.0, 'BID');
                showHotkeyFeedback('SELL ALL @ BID');
                e.preventDefault();
            }
            else if (matchesHotkey(e, hotkeyConfig.sellHalfAsk)) {
                sellPositionAtPrice(0.5, 'ASK');
                showHotkeyFeedback('SELL 1/2 @ ASK');
                e.preventDefault();
            }
            else if (matchesHotkey(e, hotkeyConfig.sellQuarterAsk)) {
                sellPositionAtPrice(0.25, 'ASK');
                showHotkeyFeedback('SELL 1/4 @ ASK');
                e.preventDefault();
            }
            // Price adjustments
            else if (matchesHotkey(e, hotkeyConfig.priceUp1)) {
                adjustPrice(0.01);
                showHotkeyFeedback('PRICE +0.01');
                e.preventDefault();
            }
            else if (matchesHotkey(e, hotkeyConfig.priceDown1)) {
                adjustPrice(-0.01);
                showHotkeyFeedback('PRICE -0.01');
                e.preventDefault();
            }
            else if (matchesHotkey(e, hotkeyConfig.priceUp5)) {
                adjustPrice(0.05);
                showHotkeyFeedback('PRICE +0.05');
                e.preventDefault();
            }
            else if (matchesHotkey(e, hotkeyConfig.priceDown5)) {
                adjustPrice(-0.05);
                showHotkeyFeedback('PRICE -0.05');
                e.preventDefault();
            }
            else if (matchesHotkey(e, hotkeyConfig.setBid)) {
                setOrderPrice('bid');
                showHotkeyFeedback('SET BID PRICE');
                e.preventDefault();
            }
            else if (matchesHotkey(e, hotkeyConfig.setAsk)) {
                setOrderPrice('ask');
                showHotkeyFeedback('SET ASK PRICE');
                e.preventDefault();
            }
            // Management
            else if (matchesHotkey(e, hotkeyConfig.cancelAll)) {
                cancelAllOrders();
                showHotkeyFeedback('CANCEL ALL');
                e.preventDefault();
            }
            else if (matchesHotkey(e, hotkeyConfig.flatten)) {
                flattenPosition();
                showHotkeyFeedback('FLATTEN');
                e.preventDefault();
            }
            else if (matchesHotkey(e, hotkeyConfig.flattenAll)) {
                flattenAllPositions();
                showHotkeyFeedback('FLATTEN ALL');
                e.preventDefault();
            }
            else if (matchesHotkey(e, hotkeyConfig.reverse)) {
                reversePosition();
                showHotkeyFeedback('REVERSE');
                e.preventDefault();
            }
            else if (matchesHotkey(e, hotkeyConfig.help)) {
                showHotkeyHelp();
                e.preventDefault();
            }
        }

        function showHotkeyFeedback(message) {
            // Remove existing feedback
            const existing = document.getElementById('hotkeyFeedback');
            if (existing) existing.remove();

            // Create feedback element
            const feedback = document.createElement('div');
            feedback.id = 'hotkeyFeedback';
            feedback.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: linear-gradient(180deg, #003366 0%, #001a33 100%);
                border: 2px solid #00aaff;
                color: #00aaff;
                padding: 20px 40px;
                font-size: 24px;
                font-weight: 700;
                font-family: 'Consolas', monospace;
                border-radius: 4px;
                z-index: 999999;
                box-shadow: 0 0 30px rgba(0, 170, 255, 0.5);
                text-shadow: 0 0 10px rgba(0, 170, 255, 0.5);
                animation: hotkeyPulse 0.3s ease-out;
            `;
            feedback.textContent = message;
            document.body.appendChild(feedback);

            // Remove after 500ms
            setTimeout(() => feedback.remove(), 500);
        }

        function showHotkeyHelp() {
            // Build dynamic help based on current config
            let help = 'CUSTOM HOTKEYS\n==============\n';
            const bindings = [
                ['Buy @ Ask', hotkeyConfig.buyAsk],
                ['Buy @ Bid', hotkeyConfig.buyBid],
                ['Buy Market', hotkeyConfig.buyMarket],
                ['Sell @ Bid', hotkeyConfig.sellBid],
                ['Sell @ Ask', hotkeyConfig.sellAsk],
                ['Sell Market', hotkeyConfig.sellMarket],
                ['Qty 100', hotkeyConfig.qty100],
                ['Qty 200', hotkeyConfig.qty200],
                ['Qty 500', hotkeyConfig.qty500],
                ['Qty 1K', hotkeyConfig.qty1000],
                ['Qty 2K', hotkeyConfig.qty2000],
                ['Flatten', hotkeyConfig.flatten],
                ['Cancel All', hotkeyConfig.cancelAll],
                ['ESC', 'Cancel All (fixed)']
            ];
            bindings.forEach(([action, key]) => {
                if (key) help += `${key.padEnd(8)} ${action}\n`;
            });
            help += '\nTools > Hotkey Settings to customize.';
            alert(help);
        }

        function flattenPosition() {
            fetch(`${API_BASE_URL}/api/positions`)
                .then(r => r.json())
                .then(data => {
                    const positions = data.positions || [];
                    const pos = positions.find(p => p.symbol === currentSymbol);
                    if (pos && pos.quantity > 0) {
                        setQuantity(Math.abs(pos.quantity));
                        setTimeout(() => submitOrder('SELL_MARKET'), 100);
                    } else if (pos && pos.quantity < 0) {
                        setQuantity(Math.abs(pos.quantity));
                        setTimeout(() => submitOrder('BUY_MARKET'), 100);
                    } else {
                        showNotification('No position in ' + currentSymbol, 'warning');
                    }
                });
        }

        function flattenAllPositions() {
            if (confirm('Flatten ALL positions? This will close every open position.')) {
                fetch(`${API_BASE_URL}/api/positions`)
                    .then(r => r.json())
                    .then(data => {
                        const positions = data.positions || [];
                        positions.forEach(pos => {
                            if (pos.quantity !== 0) {
                                const side = pos.quantity > 0 ? 'SELL' : 'BUY';
                                const qty = Math.abs(pos.quantity);
                                // Submit market order to close
                                fetch(`${API_BASE_URL}/api/order`, {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({
                                        symbol: pos.symbol,
                                        side: side,
                                        quantity: qty,
                                        order_type: 'MARKET'
                                    })
                                });
                            }
                        });
                        showNotification('Flattening all positions...', 'warning');
                    });
            }
        }

        // Sell a fraction of position at specified price type (ASK or BID)
        function sellPositionAtPrice(fraction, priceType) {
            fetch(`${API_BASE_URL}/api/positions`)
                .then(r => r.json())
                .then(data => {
                    const positions = data.positions || [];
                    const pos = positions.find(p => p.symbol === currentSymbol);
                    if (!pos || pos.quantity <= 0) {
                        showNotification('No long position in ' + currentSymbol, 'warning');
                        return;
                    }

                    // Calculate shares to sell (round down to whole shares)
                    const sharesToSell = Math.floor(Math.abs(pos.quantity) * fraction);
                    if (sharesToSell <= 0) {
                        showNotification('Position too small to sell ' + (fraction * 100) + '%', 'warning');
                        return;
                    }

                    // Get current market data for price
                    const marketData = marketDataCache[currentSymbol];
                    if (!marketData) {
                        showNotification('No market data for ' + currentSymbol, 'error');
                        return;
                    }

                    const price = priceType === 'ASK' ? marketData.ask : marketData.bid;
                    if (!price || price <= 0) {
                        showNotification('Invalid ' + priceType + ' price', 'error');
                        return;
                    }

                    // Submit limit order at bid/ask
                    fetch(`${API_BASE_URL}/api/order`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            symbol: currentSymbol,
                            side: 'SELL',
                            quantity: sharesToSell,
                            order_type: 'LIMIT',
                            price: price
                        })
                    })
                    .then(r => r.json())
                    .then(result => {
                        if (result.success || result.order_id) {
                            const pctLabel = fraction === 1 ? 'ALL' : (fraction * 100) + '%';
                            showNotification(`SELL ${pctLabel} (${sharesToSell} shares) @ ${priceType} $${price.toFixed(2)}`, 'success');
                        } else {
                            showNotification('Order failed: ' + (result.error || 'Unknown error'), 'error');
                        }
                    })
                    .catch(err => {
                        showNotification('Order error: ' + err.message, 'error');
                    });
                })
                .catch(err => {
                    showNotification('Failed to get positions: ' + err.message, 'error');
                });
        }

        function reversePosition() {
            fetch(`${API_BASE_URL}/api/positions`)
                .then(r => r.json())
                .then(data => {
                    const positions = data.positions || [];
                    const pos = positions.find(p => p.symbol === currentSymbol);
                    if (pos && pos.quantity !== 0) {
                        // Double the quantity to reverse
                        const reverseSide = pos.quantity > 0 ? 'SELL' : 'BUY';
                        const reverseQty = Math.abs(pos.quantity) * 2;
                        setQuantity(reverseQty);
                        if (reverseSide === 'SELL') {
                            setTimeout(() => submitOrder('SELL_MARKET'), 100);
                        } else {
                            setTimeout(() => submitOrder('BUY_MARKET'), 100);
                        }
                    } else {
                        showNotification('No position to reverse in ' + currentSymbol, 'warning');
                    }
                });
        }

        // Hotkey Panel Functions
        function openHotkeyPanel() {
            const existing = windows.find(w => w.id === 'hotkeys');
            if (existing) {
                existing.restore();
                existing.activate();
                updateHotkeyPanelUI();
                return;
            }
            createWindow('hotkeys', '‚å®Ô∏è HOTKEY SETTINGS', windowTemplates.hotkeys, 200, 100, 380, 450);
            setTimeout(updateHotkeyPanelUI, 100);
        }

        function updateHotkeyPanelUI() {
            // List of hotkeys that use modifier+key combo UI
            const comboKeys = ['buyAsk', 'buyBid', 'buyMarket', 'sellBid', 'sellAsk', 'sellMarket', 'sellShort',
                              'sellAllAsk', 'sellAllBid', 'sellHalfAsk', 'sellQuarterAsk',
                              'cancelAll', 'flatten', 'flattenAll', 'reverse', 'help'];

            Object.keys(hotkeyConfig).forEach(key => {
                // Check if this is a combo key (has _mod and _key inputs)
                const modSelect = document.getElementById('hk_' + key + '_mod');
                const keyInput = document.getElementById('hk_' + key + '_key');

                if (modSelect && keyInput) {
                    // Parse the combo string (e.g., "SHIFT+B" -> mod="SHIFT", key="B")
                    const parsed = parseHotkeyCombo(hotkeyConfig[key]);
                    let modValue = '';
                    if (parsed.ctrl && parsed.shift) modValue = 'CTRL+SHIFT';
                    else if (parsed.ctrl) modValue = 'CTRL';
                    else if (parsed.shift) modValue = 'SHIFT';
                    else if (parsed.alt) modValue = 'ALT';

                    modSelect.value = modValue;
                    keyInput.value = parsed.key || '';
                } else {
                    // Simple input (qty keys, price keys, etc.)
                    const input = document.getElementById('hk_' + key);
                    if (input) {
                        input.value = hotkeyConfig[key];
                    }
                }
            });

            // Update enabled checkbox
            const enabledCb = document.getElementById('hotkeysEnabled');
            if (enabledCb) enabledCb.checked = sterlingHotkeysEnabled;
            const statusText = document.getElementById('hotkeysStatusText');
            if (statusText) {
                statusText.textContent = sterlingHotkeysEnabled ? 'ENABLED' : 'DISABLED';
                statusText.style.color = sterlingHotkeysEnabled ? '#00cc00' : '#cc0000';
            }
        }

        function switchHotkeyTab(tab) {
            // Hide all panels
            ['orders', 'qty', 'price', 'mgmt'].forEach(t => {
                const panel = document.getElementById('hkPanel' + t.charAt(0).toUpperCase() + t.slice(1));
                const tabBtn = document.getElementById('hkTab' + t.charAt(0).toUpperCase() + t.slice(1));
                if (panel) panel.style.display = 'none';
                if (tabBtn) tabBtn.classList.remove('active');
            });
            // Show selected panel
            const selectedPanel = document.getElementById('hkPanel' + tab.charAt(0).toUpperCase() + tab.slice(1));
            const selectedTab = document.getElementById('hkTab' + tab.charAt(0).toUpperCase() + tab.slice(1));
            if (selectedPanel) selectedPanel.style.display = 'block';
            if (selectedTab) selectedTab.classList.add('active');
        }

        // Add hotkey animation style
        const hotkeyStyle = document.createElement('style');
        hotkeyStyle.textContent = `
            @keyframes hotkeyPulse {
                0% { transform: translate(-50%, -50%) scale(0.8); opacity: 0; }
                50% { transform: translate(-50%, -50%) scale(1.1); }
                100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
            }
        `;
        document.head.appendChild(hotkeyStyle);

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        //                     BOT TRADING CONTROL FUNCTIONS
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        let botStatusRefreshInterval = null;

        async function startBot() {
            try {
                // Try to start bot
                let response = await fetch(`${API_BASE_URL}/api/bot/start`, { method: 'POST' });
                let data = await response.json();

                // If bot not initialized, initialize it first
                if (!response.ok && data.detail && data.detail.includes('not initialized')) {
                    console.log('Bot not initialized, initializing now...');

                    // Initialize bot
                    const initResponse = await fetch(`${API_BASE_URL}/api/bot/init`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' }
                    });

                    if (!initResponse.ok) {
                        alert('‚ùå Failed to initialize bot. Check broker connection.');
                        return;
                    }

                    // Try starting again
                    response = await fetch(`${API_BASE_URL}/api/bot/start`, { method: 'POST' });
                    data = await response.json();
                }

                if (response.ok) {
                    alert('‚úÖ Bot Started Successfully!\n\nNow click "‚úÖ ENABLE TRADING" to activate trading.');
                    await updateBotStatus();
                } else {
                    alert('‚ùå Failed to start bot: ' + (data.detail || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error starting bot:', error);
                alert('‚ùå Error starting bot: ' + error.message);
            }
        }

        async function stopBot() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/bot/stop`, { method: 'POST' });
                const data = await response.json();
                if (response.ok) {
                    alert('‚èπÔ∏è Bot Stopped');
                    await updateBotStatus();
                } else {
                    alert('‚ùå Failed to stop bot: ' + data.detail);
                }
            } catch (error) {
                console.error('Error stopping bot:', error);
                alert('‚ùå Error stopping bot');
            }
        }

        async function enableBotTrading() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/bot/enable`, { method: 'POST' });
                const data = await response.json();
                if (response.ok) {
                    alert('‚úÖ Trading Enabled');
                    await updateBotStatus();
                } else {
                    alert('‚ùå Failed to enable trading: ' + data.detail);
                }
            } catch (error) {
                console.error('Error enabling trading:', error);
                alert('‚ùå Error enabling trading');
            }
        }

        async function disableBotTrading() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/bot/disable`, { method: 'POST' });
                const data = await response.json();
                if (response.ok) {
                    alert('‚è∏Ô∏è Trading Paused');
                    await updateBotStatus();
                } else {
                    alert('‚ùå Failed to pause trading: ' + data.detail);
                }
            } catch (error) {
                console.error('Error pausing trading:', error);
                alert('‚ùå Error pausing trading');
            }
        }

        async function updateBotStatus() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/bot/status`);
                if (!response.ok) return;
                const data = await response.json();

                const indicator = document.getElementById('botStatusIndicator');
                if (indicator) {
                    const dot = indicator.querySelector('div');
                    const text = indicator.querySelector('span');
                    if (data.running && data.enabled) {
                        dot.style.background = '#22c55e';
                        text.style.color = '#22c55e';
                        text.textContent = 'TRADING';
                    } else if (data.running) {
                        dot.style.background = '#f59e0b';
                        text.style.color = '#f59e0b';
                        text.textContent = 'MONITORING';
                    } else {
                        dot.style.background = '#ef4444';
                        text.style.color = '#ef4444';
                        text.textContent = 'STOPPED';
                    }
                }

                const runningEl = document.getElementById('botRunning');
                if (runningEl) {
                    runningEl.textContent = data.running ? 'TRUE' : 'FALSE';
                    runningEl.style.color = data.running ? '#22c55e' : '#ef4444';
                }

                const enabledEl = document.getElementById('botEnabled');
                if (enabledEl) {
                    enabledEl.textContent = data.enabled ? 'TRUE' : 'FALSE';
                    enabledEl.style.color = data.enabled ? '#22c55e' : '#ef4444';
                }

                if (document.getElementById('botSignals')) document.getElementById('botSignals').textContent = data.total_signals_generated || 0;
                if (document.getElementById('botTrades')) document.getElementById('botTrades').textContent = data.total_trades_executed || 0;
                if (document.getElementById('botPositions')) document.getElementById('botPositions').textContent = data.trading_engine?.open_positions || 0;

                const pnlEl = document.getElementById('botPnL');
                if (pnlEl && data.trading_engine) {
                    const pnl = data.trading_engine.daily_pnl || 0;
                    pnlEl.textContent = `$${pnl.toFixed(2)}`;
                    pnlEl.style.color = pnl > 0 ? '#22c55e' : pnl < 0 ? '#ef4444' : '#888';
                }

                if (data.trading_engine) {
                    if (document.getElementById('botDailyLimit')) document.getElementById('botDailyLimit').textContent = `$${data.trading_engine.daily_loss_limit || 500}`;
                    if (document.getElementById('botWeeklyLimit')) document.getElementById('botWeeklyLimit').textContent = `$${data.trading_engine.weekly_loss_limit?.toFixed(0) || 3500}`;
                }

                // Fetch and display shared WORKLIST (not bot's internal watchlist)
                const worklistEl = document.getElementById('botWorklist');
                const countEl = document.getElementById('worklistCount');
                if (worklistEl) {
                    try {
                        const worklistResponse = await fetch(`${API_BASE_URL}/api/worklist`);
                        if (worklistResponse.ok) {
                            const worklistData = await worklistResponse.json();
                            const symbols = worklistData.data.map(item => item.symbol);
                            worklistEl.textContent = symbols.length > 0 ? symbols.join(', ') : 'Empty - Add symbols from scanner';
                            if (countEl) {
                                countEl.textContent = `${symbols.length} symbols`;
                                countEl.style.color = symbols.length > 0 ? '#4ade80' : '#666';
                            }
                        }
                    } catch (err) {
                        console.log('Could not fetch worklist:', err);
                    }
                }

                const positionsEl = document.getElementById('botOpenPositions');
                if (positionsEl && data.trading_engine?.positions) {
                    const positions = data.trading_engine.positions;
                    if (Object.keys(positions).length === 0) {
                        positionsEl.innerHTML = '<div class="empty-state" style="padding: 20px; font-size: 12px;">No open positions</div>';
                    } else {
                        let html = '<div style="display: flex; flex-direction: column; gap: 6px;">';
                        for (const [symbol, pos] of Object.entries(positions)) {
                            const pnl = pos.unrealized_pnl || 0;
                            const pnlColor = pnl > 0 ? '#22c55e' : pnl < 0 ? '#ef4444' : '#888';
                            html += `<div style="padding: 8px; background: #252525; border-radius: 3px; border-left: 3px solid ${pnlColor};"><div style="display: flex; justify-content: space-between; margin-bottom: 4px;"><span style="font-weight: 600; color: #fff;">${symbol}</span><span style="color: ${pnlColor}; font-weight: 600;">$${pnl.toFixed(2)}</span></div><div style="display: flex; justify-content: space-between; font-size: 10px; color: #888;"><span>${pos.shares} shares @ $${pos.entry_price?.toFixed(2)}</span><span>Stop: $${pos.stop_loss?.toFixed(2)}</span></div></div>`;
                        }
                        html += '</div>';
                        positionsEl.innerHTML = html;
                    }
                }
            } catch (error) {
                console.error('Error updating bot status:', error);
            }
        }

        function startBotStatusRefresh() {
            if (botStatusRefreshInterval) clearInterval(botStatusRefreshInterval);
            botStatusRefreshInterval = setInterval(updateBotStatus, 5000);
        }

        function stopBotStatusRefresh() {
            if (botStatusRefreshInterval) {
                clearInterval(botStatusRefreshInterval);
                botStatusRefreshInterval = null;
            }
        }

        // Load a single symbol from worklist (for training/predictions)
        async function loadWorklistSymbol(inputId) {
            try {
                const response = await fetch(`${API_BASE_URL}/api/worklist`);
                if (!response.ok) throw new Error('Failed to fetch worklist');

                const data = await response.json();
                if (!data.data || !Array.isArray(data.data)) {
                    console.error('Worklist data format error:', data);
                    return;
                }
                const symbols = data.data.map(item => item.symbol);

                if (symbols.length === 0) {
                    alert('‚ö†Ô∏è Worklist is empty!\n\nAdd symbols from scanner first.');
                    return;
                }

                // Create a custom dropdown dialog
                const inputEl = document.getElementById(inputId);
                const rect = inputEl.getBoundingClientRect();

                // Create dropdown container
                const dropdown = document.createElement('div');
                dropdown.id = 'worklistDropdown';
                dropdown.style.cssText = `
                    position: fixed;
                    top: ${rect.bottom + 5}px;
                    left: ${rect.left}px;
                    width: ${rect.width}px;
                    max-height: 300px;
                    overflow-y: auto;
                    background: #252525;
                    border: 2px solid #007acc;
                    border-radius: 4px;
                    z-index: 10000;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.5);
                `;

                // Add title
                dropdown.innerHTML = `
                    <div style="padding: 8px; background: #007acc; color: white; font-weight: 600; font-size: 12px; position: sticky; top: 0;">
                        üìã Select from Worklist (${symbols.length} symbols)
                    </div>
                `;

                // Add symbol options
                symbols.forEach((symbol, idx) => {
                    const option = document.createElement('div');
                    option.style.cssText = `
                        padding: 10px;
                        cursor: pointer;
                        border-bottom: 1px solid #333;
                        color: #fff;
                        font-size: 14px;
                        font-weight: 600;
                    `;
                    option.textContent = symbol;
                    option.onmouseover = () => option.style.background = '#007acc';
                    option.onmouseout = () => option.style.background = 'transparent';
                    option.onclick = () => {
                        inputEl.value = symbol;
                        document.body.removeChild(dropdown);
                    };
                    dropdown.appendChild(option);
                });

                // Close on click outside
                const closeDropdown = (e) => {
                    if (!dropdown.contains(e.target) && e.target !== inputEl) {
                        document.body.removeChild(dropdown);
                        document.removeEventListener('click', closeDropdown);
                    }
                };

                setTimeout(() => document.addEventListener('click', closeDropdown), 100);

                document.body.appendChild(dropdown);

            } catch (error) {
                console.error('Error loading worklist symbol:', error);
                alert('‚ùå Failed to load worklist');
            }
        }

        // Load all symbols from worklist (for backtesting)
        async function loadWorklistSymbols(inputId) {
            try {
                const response = await fetch(`${API_BASE_URL}/api/worklist`);
                if (!response.ok) throw new Error('Failed to fetch worklist');

                const data = await response.json();
                if (!data.data || !Array.isArray(data.data)) {
                    console.error('Worklist data format error:', data);
                    alert('‚ùå Failed to load worklist - invalid data format');
                    return;
                }
                const symbols = data.data.map(item => item.symbol);

                if (symbols.length === 0) {
                    alert('‚ö†Ô∏è Worklist is empty!\n\nAdd symbols from scanner first.');
                    return;
                }

                const inputEl = document.getElementById(inputId);
                if (inputEl) {
                    inputEl.value = symbols.join(',');
                    alert(`‚úÖ Loaded ${symbols.length} symbols from worklist!\n\n${symbols.slice(0, 10).join(', ')}${symbols.length > 10 ? '...' : ''}`);
                }
            } catch (error) {
                console.error('Error loading worklist symbols:', error);
                alert('‚ùå Failed to load worklist');
            }
        }

        // Add scanner results to shared WORKLIST
        async function syncWorklistWithScanner() {
            try {
                console.log('Adding scanner symbols to WORKLIST...');

                // Fetch scanner results
                const response = await fetch(`${API_BASE_URL}/api/scanner/results`);
                if (!response.ok) {
                    throw new Error(`Scanner API returned ${response.status}`);
                }

                const data = await response.json();
                console.log('Scanner data:', data);

                if (!data.symbols || data.symbols.length === 0) {
                    alert('‚ö†Ô∏è No symbols found in scanner. Run a scan first.');
                    return;
                }

                // Extract unique symbols from scanner (momentum stocks)
                const scannerSymbols = [...new Set(data.symbols.map(s => s.symbol))];
                console.log(`Found ${scannerSymbols.length} symbols in scanner`);

                // Get current worklist to avoid duplicates
                const worklistResponse = await fetch(`${API_BASE_URL}/api/worklist`);
                const worklistData = await worklistResponse.json();
                const existingSymbols = new Set(worklistData.data.map(item => item.symbol));

                // Filter out symbols already in worklist
                const newSymbols = scannerSymbols.filter(s => !existingSymbols.has(s));

                if (newSymbols.length === 0) {
                    alert(`‚úÖ All ${scannerSymbols.length} scanner symbols already in worklist!\n\nNo new symbols to add.`);
                    return;
                }

                // Add new symbols to worklist
                let addedCount = 0;
                const errors = [];

                for (const symbol of newSymbols) {
                    try {
                        const addResponse = await fetch(`${API_BASE_URL}/api/worklist/add`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ symbol: symbol })
                        });

                        if (addResponse.ok) {
                            addedCount++;
                        } else {
                            errors.push(symbol);
                        }
                    } catch (err) {
                        errors.push(symbol);
                    }
                }

                // Refresh bot status to show updated worklist
                await updateBotStatus();

                // Show results
                const totalInWorklist = existingSymbols.size + addedCount;
                let message = `‚úÖ Worklist updated!\n\n`;
                message += `‚Ä¢ Added: ${addedCount} new symbols\n`;
                message += `‚Ä¢ Already had: ${existingSymbols.size} symbols\n`;
                message += `‚Ä¢ Total in worklist: ${totalInWorklist}\n\n`;

                if (addedCount > 0) {
                    message += `New momentum stocks:\n${newSymbols.slice(0, 10).join(', ')}${newSymbols.length > 10 ? '...' : ''}`;
                }

                if (errors.length > 0) {
                    message += `\n\n‚ö†Ô∏è Failed to add: ${errors.join(', ')}`;
                }

                alert(message);

            } catch (error) {
                console.error('Error syncing worklist:', error);
                alert(`‚ùå Failed to sync: ${error.message}`);
            }
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        //                     SCANNER PANEL FUNCTIONS
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        let currentScanResults = [];

        function openScannerPanel() {
            document.getElementById('scannerModal').classList.add('show');
            refreshScannerPanel();
        }

        function closeScannerPanel() {
            document.getElementById('scannerModal').classList.remove('show');
        }

        async function refreshScannerPanel() {
            await loadScannerInfo();
            await loadScannerPresets();
            await loadWorkingList();
        }

        async function loadScannerInfo() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/scanner/info`);
                const data = await response.json();

                const statusEl = document.getElementById('scannerStatusInfo');
                if (data.status === 'active') {
                    statusEl.innerHTML = `
                        <span style="color: #22c55e;">Active</span> |
                        AI: ${data.ai_available ? '<span style="color: #22c55e;">Ready</span>' : '<span style="color: #ef4444;">Offline</span>'} |
                        ${data.presets_count} presets |
                        ${data.universe_size} stocks
                    `;
                } else {
                    statusEl.innerHTML = '<span style="color: #ef4444;">Scanner unavailable</span>';
                }
            } catch (error) {
                console.error('Error loading scanner info:', error);
                document.getElementById('scannerStatusInfo').innerHTML = '<span style="color: #ef4444;">Error loading status</span>';
            }
        }

        async function loadScannerPresets() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/scanner/presets`);
                const data = await response.json();

                const container = document.getElementById('scannerPresetsList');
                if (data.presets && data.presets.length > 0) {
                    container.innerHTML = data.presets.map(preset => `
                        <div style="padding: 10px; background: #252525; border-radius: 4px; border: 1px solid #333; cursor: pointer;"
                             onclick="runPresetScan('${preset.id}')"
                             onmouseover="this.style.borderColor='#059669'"
                             onmouseout="this.style.borderColor='#333'">
                            <div style="font-weight: 600; color: #fff; margin-bottom: 4px;">${preset.name}</div>
                            <div style="font-size: 11px; color: #888;">${preset.description}</div>
                            <div style="font-size: 10px; color: #666; margin-top: 4px;">
                                ${preset.last_run ? 'Last: ' + new Date(preset.last_run).toLocaleTimeString() : 'Never run'} |
                                ${preset.results_count} results
                            </div>
                        </div>
                    `).join('');
                } else {
                    container.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">No presets available</div>';
                }
            } catch (error) {
                console.error('Error loading presets:', error);
            }
        }

        async function loadWorkingList() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/watchlist-ai/working-list`);
                const data = await response.json();

                document.getElementById('workingListCount').textContent = `${data.count} symbols`;

                const container = document.getElementById('workingListContainer');
                if (data.symbols && data.symbols.length > 0) {
                    container.innerHTML = data.symbols.map(item => `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; background: #252525; border-radius: 4px; margin-bottom: 4px;">
                            <div>
                                <span style="font-weight: 600; color: #fff;">${item.symbol}</span>
                                <span style="font-size: 11px; color: #888; margin-left: 8px;">${item.reason || ''}</span>
                            </div>
                            <div style="display: flex; gap: 8px; align-items: center;">
                                <span style="font-size: 11px; color: ${item.ai_score > 70 ? '#22c55e' : item.ai_score > 50 ? '#f59e0b' : '#888'};">
                                    Score: ${item.ai_score?.toFixed(0) || 50}
                                </span>
                                <button onclick="removeFromWorkingList('${item.symbol}')"
                                        style="background: #7f1d1d; border: none; color: #fff; padding: 2px 6px; border-radius: 2px; cursor: pointer; font-size: 10px;">
                                    ‚úï
                                </button>
                            </div>
                        </div>
                    `).join('');
                } else {
                    container.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">Working list is empty. Run a scan or add symbols manually.</div>';
                }
            } catch (error) {
                console.error('Error loading working list:', error);
            }
        }

        async function runPresetScan(presetId) {
            try {
                showNotification(`Running ${presetId} scan...`, 'info');

                const response = await fetch(`${API_BASE_URL}/api/scanner/run/${presetId}?max_results=20`, {
                    method: 'POST'
                });
                const data = await response.json();

                if (data.status === 'success') {
                    currentScanResults = data.results || [];
                    displayScanResults(data.results, presetId);
                    showNotification(`Found ${data.count} stocks`, 'success');
                    await loadScannerPresets(); // Refresh preset stats
                } else {
                    showNotification('Scan failed', 'error');
                }
            } catch (error) {
                console.error('Error running scan:', error);
                showNotification('Scan error: ' + error.message, 'error');
            }
        }

        async function runQuickScan(scanType) {
            try {
                showNotification(`Running ${scanType} scan...`, 'info');

                const response = await fetch(`${API_BASE_URL}/api/scanner/quick-scan/${scanType}?limit=15`);
                const data = await response.json();

                currentScanResults = data.stocks || [];
                displayQuickScanResults(data.stocks, scanType);
                showNotification(`Found ${data.count} stocks`, 'success');
            } catch (error) {
                console.error('Error running quick scan:', error);
                showNotification('Quick scan error: ' + error.message, 'error');
            }
        }

        function displayScanResults(results, presetId) {
            const container = document.getElementById('scanResultsContainer');

            if (!results || results.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">No stocks matched the criteria. Try different scan settings or wait for market hours.</div>';
                return;
            }

            container.innerHTML = results.map(r => `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; background: #252525; border-radius: 4px; margin-bottom: 4px;">
                    <div style="flex: 1;">
                        <span style="font-weight: 600; color: #fff;">${r.symbol}</span>
                        <span style="font-size: 11px; margin-left: 8px; color: ${r.change_percent >= 0 ? '#22c55e' : '#ef4444'};">
                            ${r.change_percent >= 0 ? '+' : ''}${r.change_percent?.toFixed(1) || 0}%
                        </span>
                    </div>
                    <div style="flex: 1; text-align: center;">
                        <span style="font-size: 11px; color: #888;">$${r.price?.toFixed(2) || 0}</span>
                        <span style="font-size: 10px; color: #666; margin-left: 8px;">Vol: ${r.volume_ratio?.toFixed(1) || 1}x</span>
                    </div>
                    <div style="flex: 1; text-align: right;">
                        <span style="font-size: 11px; color: #60a5fa;">Score: ${r.score?.toFixed(0) || 50}</span>
                        <button onclick="addSingleToWorkingList('${r.symbol}', '${presetId}')"
                                style="background: #059669; border: none; color: #fff; padding: 2px 6px; border-radius: 2px; cursor: pointer; font-size: 10px; margin-left: 8px;">
                            ‚ûï
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function displayQuickScanResults(stocks, scanType) {
            const container = document.getElementById('scanResultsContainer');

            if (!stocks || stocks.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">No stocks found. Market may be closed or criteria too strict.</div>';
                return;
            }

            container.innerHTML = stocks.map(s => `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; background: #252525; border-radius: 4px; margin-bottom: 4px;">
                    <div style="flex: 1;">
                        <span style="font-weight: 600; color: #fff;">${s.symbol}</span>
                        <span style="font-size: 11px; margin-left: 8px; color: ${s.change >= 0 ? '#22c55e' : '#ef4444'};">
                            ${s.change >= 0 ? '+' : ''}${s.change?.toFixed(1) || 0}%
                        </span>
                    </div>
                    <div style="flex: 1; text-align: center;">
                        <span style="font-size: 11px; color: #888;">$${s.price?.toFixed(2) || 0}</span>
                        <span style="font-size: 10px; color: #666; margin-left: 8px;">Vol: ${s.volume_ratio?.toFixed(1) || 1}x</span>
                    </div>
                    <div style="flex: 1; text-align: right;">
                        <span style="font-size: 11px; color: #60a5fa;">Score: ${s.score?.toFixed(0) || 50}</span>
                        <button onclick="addSingleToWorkingList('${s.symbol}', '${scanType}')"
                                style="background: #059669; border: none; color: #fff; padding: 2px 6px; border-radius: 2px; cursor: pointer; font-size: 10px; margin-left: 8px;">
                            ‚ûï
                        </button>
                    </div>
                </div>
            `).join('');
        }

        async function addSingleToWorkingList(symbol, reason) {
            try {
                const response = await fetch(`${API_BASE_URL}/api/watchlist-ai/add`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ symbol: symbol, reason: `Scanner: ${reason}` })
                });

                const data = await response.json();
                if (data.status === 'success') {
                    showNotification(`Added ${symbol} to working list`, 'success');
                    await loadWorkingList();
                } else {
                    showNotification(`Failed to add ${symbol}`, 'error');
                }
            } catch (error) {
                console.error('Error adding to working list:', error);
            }
        }

        async function addAllToWorkingList() {
            if (!currentScanResults || currentScanResults.length === 0) {
                showNotification('No scan results to add', 'warning');
                return;
            }

            let added = 0;
            for (const result of currentScanResults) {
                const symbol = result.symbol;
                try {
                    const response = await fetch(`${API_BASE_URL}/api/watchlist-ai/add`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ symbol: symbol, reason: 'Bulk add from scanner' })
                    });
                    if (response.ok) added++;
                } catch (e) { /* ignore individual failures */ }
            }

            showNotification(`Added ${added} symbols to working list`, 'success');
            await loadWorkingList();
        }

        async function addSymbolToWorkingList() {
            const input = document.getElementById('manualAddSymbol');
            const symbol = input.value.trim().toUpperCase();

            if (!symbol) {
                showNotification('Enter a symbol', 'warning');
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/api/watchlist-ai/add`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ symbol: symbol, reason: 'Manual add' })
                });

                const data = await response.json();
                if (data.status === 'success') {
                    showNotification(`Added ${symbol} to working list`, 'success');
                    input.value = '';
                    await loadWorkingList();
                } else {
                    showNotification(`Failed to add ${symbol}`, 'error');
                }
            } catch (error) {
                console.error('Error adding symbol:', error);
            }
        }

        async function removeFromWorkingList(symbol) {
            try {
                const response = await fetch(`${API_BASE_URL}/api/watchlist-ai/remove/${symbol}`, {
                    method: 'DELETE'
                });

                const data = await response.json();
                if (data.status === 'success') {
                    showNotification(`Removed ${symbol}`, 'success');
                    await loadWorkingList();
                }
            } catch (error) {
                console.error('Error removing symbol:', error);
            }
        }

        async function syncWorkingListToWatchlist() {
            try {
                showNotification('Syncing to platform watchlist...', 'info');

                const response = await fetch(`${API_BASE_URL}/api/watchlist-ai/sync?watchlist_name=AI_Working_List`, {
                    method: 'POST'
                });

                const data = await response.json();
                if (data.status === 'success') {
                    showNotification(`Synced ${data.count} symbols to watchlist`, 'success');
                } else {
                    showNotification('Sync failed', 'error');
                }
            } catch (error) {
                console.error('Error syncing:', error);
            }
        }

        async function trainWorkingList() {
            try {
                showNotification('Training AI models on working list...', 'info');

                const response = await fetch(`${API_BASE_URL}/api/watchlist-ai/train`, {
                    method: 'POST'
                });

                const data = await response.json();
                showNotification(`Training complete: ${data.trained || 0} models trained`, 'success');
            } catch (error) {
                console.error('Error training:', error);
                showNotification('Training error: ' + error.message, 'error');
            }
        }

    </script>
</body>
</html>
