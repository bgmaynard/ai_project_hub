# Claude Code Session Continuation - December 5, 2025

## CRITICAL: Read This First

This document brings the next Claude instance up to speed on the current state of the Alpaca Trading Bot project.

---

## Project Overview

**Location:** `C:\ai_project_hub\store\code\IBKR_Algo_BOT_V2`
**Broker:** Alpaca (Paper Trading)
**Server:** FastAPI on port 9100
**Strategy:** Small Cap Momentum Trading (Warrior Trading style)

---

## What Was Done This Session (December 5, 2025)

### 1. LIMIT Order Strategy Overhaul

**User Request:** Make all orders LIMIT orders to prevent getting stuck after hours, buy/sell on ASK for momentum, emergency sell on BID.

**Implementation in `alpaca_integration.py` - `place_smart_order()`:**

```python
def place_smart_order(self, symbol: str, quantity: int, side: str,
                      limit_price: float = None, emergency: bool = False) -> Dict:
    """
    SMART ORDER - MOMENTUM STRATEGY with extended hours support.

    ORDER STRATEGY:
    ===============
    1. ALL orders are LIMIT orders by default (never get stuck after hours)
    2. ALL orders have extended_hours=True (trade any session)
    3. BUY orders: Use ASK price (ride momentum)
    4. SELL orders: Use ASK price normally (ride momentum for better exit)
    5. EMERGENCY SELL: Use BID price (get out NOW)
    6. Market orders ONLY for emergency exits during regular hours
    """
```

**Key Points:**
- ALL orders are LIMIT with `extended_hours=True`
- BUY = ASK price (hit the ask to get filled fast)
- SELL normal = ASK price (ride momentum up)
- SELL emergency = BID price (or market during regular hours)

### 2. End-of-Day (EOD) Liquidation

**User Request:** Close all positions before market close to avoid overnight gap risk on small caps.

**Implementation in `bot_manager.py`:**

**Config (lines 109-115):**
```python
eod_liquidation_enabled: bool = True    # Enable EOD closing
eod_liquidation_time: str = "15:45"     # 15 min before close
no_new_entries_after: str = "15:30"     # Stop new entries 30 min before close
friday_early_close: bool = True         # Earlier on Fridays
friday_liquidation_time: str = "15:30"  # Friday liquidation time
```

**Helper Methods (lines 837-930):**
- `_get_current_et_time()` - Get Eastern timezone time
- `_is_eod_liquidation_time()` - Check if time to liquidate
- `_should_block_new_entries()` - Check if too late for new entries
- `_liquidate_all_positions(connector, reason)` - Liquidate all positions

**Integration (lines 1479-1492 and 1627-1636):**
- EOD liquidation check at start of each trading cycle
- Block new entries after 3:30 PM ET
- Liquidate all positions at 3:45 PM ET (3:30 PM on Fridays)

### 3. Rate Limiting Bug Fix

**Problem:** `pending_orders_count` never decremented, causing exits to get blocked forever.

**Fix in `bot_manager.py` - `_can_place_order()` (lines 781-814):**
```python
def _can_place_order(self, symbol: str) -> bool:
    # CRITICAL: Check ACTUAL open orders from Alpaca, not stale counter
    open_orders = self.connector.get_orders(status="open", limit=50)
    actual_pending = sum(1 for o in open_orders if o.get("symbol") == symbol)

    if actual_pending != self.pending_orders_count.get(symbol, 0):
        self.pending_orders_count[symbol] = actual_pending

    if actual_pending >= self.config.max_orders_per_symbol:
        return False
```

---

## Current System State

### Account
- **Equity:** $138,070.27
- **Buying Power:** $274,774.54
- **Today's P/L:** +$4,290 (11 trades)

### Current Positions (4)
| Symbol | Qty | Avg Cost | P/L |
|--------|-----|----------|-----|
| ADTX | 100 | $3.13 | -$16 |
| CCM | 100 | $3.98 | +$1 |
| JFBR | 100 | $1.61 | +$6 |
| JSPR | 100 | $1.75 | -$7 |

### Bot Status
- **Status:** Stopped (after hours)
- **Server:** Running on port 9100

---

## Key Files Modified This Session

1. **`alpaca_integration.py`** - Complete rewrite of `place_smart_order()` for momentum strategy
2. **`bot_manager.py`** - Multiple changes:
   - Added EOD liquidation config (lines 109-115)
   - Added EOD helper methods (lines 837-930)
   - Integrated EOD check into trading loop (lines 1479-1492, 1627-1636)
   - Fixed rate limiting bug (lines 781-814)
   - Updated exit orders to use emergency flag (lines 1501-1507)
   - Updated entry orders to use smart order (lines 1667-1672)

---

## Architecture Overview

### Data Flow
```
Schwab Market Data (ONLY source for trading)
         |
         v
   market_data_bus.py (centralized bus)
         |
         v
   alpaca_integration.py (place_smart_order)
         |
         v
   Alpaca API (order execution)
```

### Key Modules
- `alpaca_dashboard_api.py` - FastAPI server (port 9100)
- `bot_manager.py` - Trading logic, BotManager class
- `alpaca_integration.py` - AlpacaConnector class
- `market_data_bus.py` - Centralized Schwab data
- `ai/position_sync.py` - Position synchronization

---

## Starting the System

```bash
cd C:\ai_project_hub\store\code\IBKR_Algo_BOT_V2
python alpaca_dashboard_api.py
```

Or use PowerShell:
```powershell
powershell -Command "Start-Process python -ArgumentList 'alpaca_dashboard_api.py' -WorkingDirectory 'C:\ai_project_hub\store\code\IBKR_Algo_BOT_V2' -WindowStyle Hidden"
```

### API Endpoints
- Health: `GET http://localhost:9100/health`
- Account: `GET http://localhost:9100/api/account`
- Bot Status: `GET http://localhost:9100/api/bot/status`
- Start Bot: `POST http://localhost:9100/api/bot/start`
- Stop Bot: `POST http://localhost:9100/api/bot/stop`

---

## Trading Strategy (Small Cap Momentum)

### Entry Rules
- Confidence threshold: 20%
- Position size: 100 shares
- Max positions: 8
- Max daily trades: 15
- No entries after 3:30 PM ET

### Exit Rules
- Initial stop loss: 4%
- Trailing stop: 2.5% (tightens to 1% after 1.5% gain)
- Take profit: 6%
- EOD liquidation: 3:45 PM ET (3:30 PM Fridays)

### Order Strategy
- ALL orders: LIMIT with extended_hours=True
- BUY: ASK price
- SELL normal: ASK price
- SELL emergency: BID price (or market during regular hours)

---

## Known Issues / Watch Points

1. **Schwab Token:** May need refresh - check `schwab_token.json`
2. **Rate Limiting:** Fixed but monitor for edge cases
3. **Position Sync:** Background sync runs every 5 seconds via `ai/position_sync.py`

---

## Files to Read First

If you need to understand the system:
1. `bot_manager.py` - Main trading logic
2. `alpaca_integration.py` - Broker connection
3. `market_data_bus.py` - Data source
4. `alpaca_dashboard_api.py` - API server

---

## Git Branch

Current branch: `feat/unified-claude-chatgpt-2025-10-31`
Main branch: `main`

---

## Next Steps (User's Strategy)

The user is doing small cap momentum trading (Warrior Trading style). Key priorities:
1. Avoid overnight positions (EOD liquidation - DONE)
2. Use LIMIT orders to avoid getting stuck (DONE)
3. Fast execution for momentum (buy/sell on ASK - DONE)
4. Emergency exits during slippage (BID/market - DONE)

---

## Commands for Quick Status Check

```powershell
# Check health
Invoke-RestMethod -Uri 'http://localhost:9100/health' -Method Get

# Check account
Invoke-RestMethod -Uri 'http://localhost:9100/api/account' -Method Get | ConvertTo-Json -Depth 5

# Check bot status
Invoke-RestMethod -Uri 'http://localhost:9100/api/bot/status' -Method Get | ConvertTo-Json -Depth 5

# Start bot
Invoke-RestMethod -Uri 'http://localhost:9100/api/bot/start' -Method Post

# Stop bot
Invoke-RestMethod -Uri 'http://localhost:9100/api/bot/stop' -Method Post
```

---

*Document created: December 5, 2025*
*Last updated: After EOD liquidation implementation*
