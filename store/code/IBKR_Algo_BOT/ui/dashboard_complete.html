<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IBKR Trading Bot - Complete Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .status-pills {
            display: flex;
            gap: 10px;
        }

        .status-pill {
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 12px;
            text-transform: uppercase;
        }

        .status-connected { background: #10b981; color: white; }
        .status-disconnected { background: #ef4444; color: white; }
        .status-connecting { background: #f59e0b; color: white; }
        .status-degraded { background: #f97316; color: white; }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .tab {
            background: white;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .tab:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        .tab.active {
            background: #667eea;
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .card h2 {
            color: #333;
            margin-bottom: 15px;
            font-size: 18px;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .grid-2 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #333;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e5e7eb;
            border-radius: 5px;
            font-size: 14px;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            font-weight: bold;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .btn-primary { background: #667eea; color: white; }
        .btn-primary:hover { background: #5568d3; }
        .btn-success { background: #10b981; color: white; }
        .btn-success:hover { background: #059669; }
        .btn-danger { background: #ef4444; color: white; }
        .btn-danger:hover { background: #dc2626; }
        .btn-warning { background: #f59e0b; color: white; }
        .btn-warning:hover { background: #d97706; }

        .symbol-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: #f9fafb;
            border-radius: 5px;
            border-left: 4px solid #667eea;
            margin-bottom: 10px;
        }

        .symbol-ticker {
            font-weight: bold;
            font-size: 18px;
            color: #333;
        }

        .quick-add {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }

        .quick-add-chip {
            padding: 8px 12px;
            background: #e0e7ff;
            color: #667eea;
            border-radius: 20px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .quick-add-chip:hover {
            background: #667eea;
            color: white;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-value {
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 14px;
            opacity: 0.9;
        }

        .message {
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            border-left: 4px solid;
        }

        .message-error {
            background: #fee2e2;
            color: #991b1b;
            border-color: #ef4444;
        }

        .message-success {
            background: #d1fae5;
            color: #065f46;
            border-color: #10b981;
        }

        .message-info {
            background: #dbeafe;
            color: #1e40af;
            border-color: #3b82f6;
        }

        .connection-info {
            background: #f3f4f6;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 15px;
        }

        .connection-info-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .connection-info-label {
            font-weight: 600;
            color: #6b7280;
        }

        .connection-info-value {
            color: #111827;
            font-family: monospace;
        }

        .position-table {
            width: 100%;
            border-collapse: collapse;
        }

        .position-table th,
        .position-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }

        .position-table th {
            background: #f9fafb;
            font-weight: 600;
            color: #374151;
        }

        .position-table tr:hover {
            background: #f9fafb;
        }

        .profit-positive { color: #10b981; font-weight: bold; }
        .profit-negative { color: #ef4444; font-weight: bold; }

        .ai-prediction {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
        }

        .prediction-value {
            font-size: 48px;
            font-weight: bold;
            margin: 10px 0;
        }

        .confidence-bar {
            height: 8px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 10px;
        }

        .confidence-fill {
            height: 100%;
            background: white;
            transition: width 0.3s;
        }

        .log-entry {
            font-family: monospace;
            font-size: 12px;
            padding: 8px;
            background: #1f2937;
            color: #10b981;
            border-radius: 4px;
            margin-bottom: 5px;
        }

        .log-container {
            max-height: 400px;
            overflow-y: auto;
            background: #111827;
            padding: 10px;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div>
                <h1>ü§ñ IBKR Trading Bot Dashboard</h1>
                <p style="color: #6b7280; font-size: 14px; margin-top: 5px;">Real-time trading with AI predictions</p>
            </div>
            <div class="status-pills">
                <div id="ibkrStatus" class="status-pill status-connecting">IBKR: ...</div>
                <div id="aiStatus" class="status-pill status-connecting">AI: ...</div>
            </div>
        </div>

        <!-- Stats -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="symbolCount">0</div>
                <div class="stat-label">Symbols Tracked</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="positionCount">0</div>
                <div class="stat-label">Open Positions</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="totalPnL">$0.00</div>
                <div class="stat-label">Total P&L</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="clientId">-</div>
                <div class="stat-label">Client ID</div>
            </div>
        </div>

        <!-- Message Area -->
        <div id="messageArea"></div>

        <!-- Tabs -->
        <div class="tabs">
            <div class="tab active" onclick="switchTab('dashboard')">üìä Dashboard</div>
            <div class="tab" onclick="switchTab('worklist')">üìã Worklist</div>
            <div class="tab" onclick="switchTab('trade')">üí∞ Trade</div>
            <div class="tab" onclick="switchTab('positions')">üìà Positions</div>
            <div class="tab" onclick="switchTab('ai')">ü§ñ AI Predictions</div>
            <div class="tab" onclick="switchTab('diagnostics')">üîß Diagnostics</div>
        </div>

        <!-- Dashboard Tab -->
        <div id="tab-dashboard" class="tab-content active">
            <div class="card">
                <h2>üìä System Status</h2>
                <div class="connection-info" id="connectionInfo">
                    <div class="connection-info-row">
                        <span class="connection-info-label">Status:</span>
                        <span class="connection-info-value" id="connStatus">Loading...</span>
                    </div>
                    <div class="connection-info-row">
                        <span class="connection-info-label">TWS Host:</span>
                        <span class="connection-info-value" id="connHost">-</span>
                    </div>
                    <div class="connection-info-row">
                        <span class="connection-info-label">TWS Port:</span>
                        <span class="connection-info-value" id="connPort">-</span>
                    </div>
                    <div class="connection-info-row">
                        <span class="connection-info-label">Mode:</span>
                        <span class="connection-info-value" id="connMode">-</span>
                    </div>
                </div>
                <button class="btn btn-primary" onclick="reconnectIBKR()">üîÑ Reconnect IBKR</button>
                <button class="btn btn-success" onclick="testConnection()">‚úÖ Test Connection</button>
            </div>

            <div class="card">
                <h2>üìù Recent Activity Log</h2>
                <div class="log-container" id="activityLog">
                    <div class="log-entry">[INFO] Dashboard loaded</div>
                </div>
            </div>
        </div>

        <!-- Worklist Tab -->
        <div id="tab-worklist" class="tab-content">
            <div class="card">
                <h2>‚ûï Add Symbols to Worklist</h2>
                
                <div class="quick-add">
                    <div class="quick-add-chip" onclick="quickAddSymbol('AAPL')">AAPL</div>
                    <div class="quick-add-chip" onclick="quickAddSymbol('MSFT')">MSFT</div>
                    <div class="quick-add-chip" onclick="quickAddSymbol('GOOGL')">GOOGL</div>
                    <div class="quick-add-chip" onclick="quickAddSymbol('TSLA')">TSLA</div>
                    <div class="quick-add-chip" onclick="quickAddSymbol('NVDA')">NVDA</div>
                    <div class="quick-add-chip" onclick="quickAddSymbol('SPY')">SPY</div>
                    <div class="quick-add-chip" onclick="quickAddSymbol('QQQ')">QQQ</div>
                </div>

                <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                    <input type="text" id="symbolInput" placeholder="Symbol (e.g., AAPL)" style="flex: 1; padding: 10px; border: 2px solid #e5e7eb; border-radius: 5px;">
                    <button class="btn btn-primary" onclick="addSymbol()">Add Symbol</button>
                </div>
            </div>

            <div class="card">
                <h2>üìã Active Symbols</h2>
                <div id="symbolList"></div>
            </div>
        </div>

        <!-- Trade Tab -->
        <div id="tab-trade" class="tab-content">
            <div class="card">
                <h2>üí∞ Place Order</h2>
                <div class="grid-2">
                    <div>
                        <div class="form-group">
                            <label>Symbol</label>
                            <input type="text" id="tradeSymbol" placeholder="AAPL">
                        </div>
                        <div class="form-group">
                            <label>Action</label>
                            <select id="tradeAction">
                                <option value="BUY">BUY</option>
                                <option value="SELL">SELL</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Quantity</label>
                            <input type="number" id="tradeQty" value="100" min="1">
                        </div>
                    </div>
                    <div>
                        <div class="form-group">
                            <label>Order Type</label>
                            <select id="tradeOrderType">
                                <option value="MKT">Market</option>
                                <option value="LMT">Limit</option>
                                <option value="STP">Stop</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Limit Price (if applicable)</label>
                            <input type="number" id="tradeLimitPrice" step="0.01" placeholder="0.00">
                        </div>
                        <div class="form-group">
                            <label>Time in Force</label>
                            <select id="tradeTIF">
                                <option value="DAY">Day</option>
                                <option value="GTC">Good Till Cancel</option>
                                <option value="IOC">Immediate or Cancel</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div style="margin-top: 20px; display: flex; gap: 10px;">
                    <button class="btn btn-warning" onclick="previewOrder()">üëÅÔ∏è Preview Order</button>
                    <button class="btn btn-success" onclick="placeOrder()">‚úÖ Place Order</button>
                </div>
                <div id="orderPreview" style="margin-top: 20px;"></div>
            </div>
        </div>

        <!-- Positions Tab -->
        <div id="tab-positions" class="tab-content">
            <div class="card">
                <h2>üìà Current Positions</h2>
                <button class="btn btn-primary" onclick="refreshPositions()" style="margin-bottom: 15px;">üîÑ Refresh</button>
                <table class="position-table" id="positionsTable">
                    <thead>
                        <tr>
                            <th>Symbol</th>
                            <th>Quantity</th>
                            <th>Avg Cost</th>
                            <th>Current Price</th>
                            <th>P&L</th>
                            <th>P&L %</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="positionsBody">
                        <tr>
                            <td colspan="7" style="text-align: center; color: #6b7280;">No positions loaded</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- AI Predictions Tab -->
        <div id="tab-ai" class="tab-content">
            <div class="card">
                <h2>ü§ñ Get AI Prediction</h2>
                <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                    <input type="text" id="aiSymbol" placeholder="Symbol (e.g., AAPL)" style="flex: 1; padding: 10px; border: 2px solid #e5e7eb; border-radius: 5px;">
                    <button class="btn btn-primary" onclick="getPrediction()">üîÆ Get Prediction</button>
                </div>
                
                <div id="predictionResult"></div>
            </div>

            <div class="card">
                <h2>üìä Prediction History</h2>
                <div id="predictionHistory">
                    <p style="color: #6b7280; text-align: center;">No predictions yet</p>
                </div>
            </div>
        </div>

        <!-- Diagnostics Tab -->
        <div id="tab-diagnostics" class="tab-content">
            <div class="card">
                <h2>üîß Connection Diagnostics</h2>
                <button class="btn btn-primary" onclick="runDiagnostics()" style="margin-bottom: 15px;">‚ñ∂Ô∏è Run Diagnostics</button>
                <div id="diagnosticsResult"></div>
            </div>

            <div class="card">
                <h2>üìã API Endpoints</h2>
                <ul style="list-style: none; padding: 0;">
                    <li style="padding: 8px; border-bottom: 1px solid #e5e7eb;">
                        <strong>GET /health</strong> - Health check
                    </li>
                    <li style="padding: 8px; border-bottom: 1px solid #e5e7eb;">
                        <strong>GET /api/status</strong> - System status
                    </li>
                    <li style="padding: 8px; border-bottom: 1px solid #e5e7eb;">
                        <strong>POST /api/tws/connect</strong> - Connect to IBKR
                    </li>
                    <li style="padding: 8px; border-bottom: 1px solid #e5e7eb;">
                        <strong>POST /api/order/preview</strong> - Preview order (requires API key)
                    </li>
                    <li style="padding: 8px;">
                        <strong>POST /api/ai/predict</strong> - Get AI prediction
                    </li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://127.0.0.1:9101';
        const API_KEY = localStorage.getItem('ibkr_api_key') || '';
        let worklist = [];
        let currentTab = 'dashboard';

        // Tab switching
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(`tab-${tabName}`).classList.add('active');
            currentTab = tabName;
            
            // Load data for specific tabs
            if (tabName === 'positions') refreshPositions();
        }

        // Show message
        function showMessage(text, type = 'info') {
            const messageArea = document.getElementById('messageArea');
            const className = `message message-${type}`;
            
            messageArea.innerHTML = `<div class="${className}">${text}</div>`;
            
            setTimeout(() => {
                messageArea.innerHTML = '';
            }, 5000);
            
            addLog(`[${type.toUpperCase()}] ${text}`);
        }

        // Add log entry
        function addLog(text) {
            const logContainer = document.getElementById('activityLog');
            const timestamp = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.textContent = `[${timestamp}] ${text}`;
            logContainer.insertBefore(entry, logContainer.firstChild);
            
            // Keep only last 50 entries
            while (logContainer.children.length > 50) {
                logContainer.removeChild(logContainer.lastChild);
            }
        }

        // Check connection status
        async function checkStatus() {
            try {
                const response = await fetch(`${API_BASE}/api/status`);
                const data = await response.json();
                
                // Update status pills
                const ibkrStatus = document.getElementById('ibkrStatus');
                const aiStatus = document.getElementById('aiStatus');
                
                if (data.ib_connection || data.state === 'CONNECTED') {
                    ibkrStatus.className = 'status-pill status-connected';
                    ibkrStatus.textContent = 'IBKR: CONNECTED';
                } else {
                    ibkrStatus.className = 'status-pill status-disconnected';
                    ibkrStatus.textContent = 'IBKR: DISCONNECTED';
                }
                
                if (data.ai_connection) {
                    aiStatus.className = 'status-pill status-connected';
                    aiStatus.textContent = 'AI: READY';
                } else {
                    aiStatus.className = 'status-pill status-disconnected';
                    aiStatus.textContent = 'AI: OFFLINE';
                }
                
                // Update connection info
                document.getElementById('connStatus').textContent = data.state || 'UNKNOWN';
                document.getElementById('connHost').textContent = data.host || '-';
                document.getElementById('connPort').textContent = data.port || '-';
                document.getElementById('connMode').textContent = data.mode || '-';
                document.getElementById('clientId').textContent = data.current_client_id || '-';
                
            } catch (error) {
                document.getElementById('ibkrStatus').className = 'status-pill status-disconnected';
                document.getElementById('ibkrStatus').textContent = 'IBKR: ERROR';
                addLog(`[ERROR] Status check failed: ${error.message}`);
            }
        }

        // Reconnect IBKR
        async function reconnectIBKR() {
            showMessage('Attempting to reconnect to IBKR...', 'info');
            try {
                const response = await fetch(`${API_BASE}/api/tws/connect`, {
                    method: 'POST'
                });
                const data = await response.json();
                
                if (data.success) {
                    showMessage('Successfully reconnected to IBKR!', 'success');
                } else {
                    showMessage('Failed to reconnect to IBKR', 'error');
                }
                
                checkStatus();
            } catch (error) {
                showMessage(`Reconnection failed: ${error.message}`, 'error');
            }
        }

        // Test connection
        async function testConnection() {
            try {
                const response = await fetch(`${API_BASE}/api/tws/ping`);
                const data = await response.json();
                
                if (data.connected) {
                    showMessage('Connection test successful!', 'success');
                } else {
                    showMessage('Connection test failed', 'error');
                }
            } catch (error) {
                showMessage(`Test failed: ${error.message}`, 'error');
            }
        }

        // Worklist functions
        function loadWorklist() {
            const stored = localStorage.getItem('ibkr_worklist');
            if (stored) {
                worklist = JSON.parse(stored);
            }
            renderWorklist();
        }

        function saveWorklist() {
            localStorage.setItem('ibkr_worklist', JSON.stringify(worklist));
            renderWorklist();
        }

        function addSymbol() {
            const input = document.getElementById('symbolInput');
            const symbol = input.value.trim().toUpperCase();
            
            if (!symbol) {
                showMessage('Please enter a symbol', 'error');
                return;
            }
            
            if (worklist.includes(symbol)) {
                showMessage(`${symbol} is already in the worklist`, 'error');
                return;
            }
            
            worklist.push(symbol);
            saveWorklist();
            input.value = '';
            showMessage(`${symbol} added to worklist`, 'success');
        }

        function quickAddSymbol(symbol) {
            document.getElementById('symbolInput').value = symbol;
            addSymbol();
        }

        function removeSymbol(symbol) {
            worklist = worklist.filter(s => s !== symbol);
            saveWorklist();
            showMessage(`${symbol} removed from worklist`, 'success');
        }

        function renderWorklist() {
            const listElement = document.getElementById('symbolList');
            document.getElementById('symbolCount').textContent = worklist.length;
            
            if (worklist.length === 0) {
                listElement.innerHTML = '<p style="color: #6b7280; text-align: center;">No symbols in worklist</p>';
                return;
            }
            
            listElement.innerHTML = worklist.map(symbol => `
                <div class="symbol-item">
                    <div>
                        <span class="symbol-ticker">${symbol}</span>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-success" onclick="tradeFromWorklist('${symbol}')">Trade</button>
                        <button class="btn btn-primary" onclick="predictFromWorklist('${symbol}')">AI Predict</button>
                        <button class="btn btn-danger" onclick="removeSymbol('${symbol}')">Remove</button>
                    </div>
                </div>
            `).join('');
        }

        function tradeFromWorklist(symbol) {
            switchTab('trade');
            document.getElementById('tradeSymbol').value = symbol;
        }

        function predictFromWorklist(symbol) {
            switchTab('ai');
            document.getElementById('aiSymbol').value = symbol;
            getPrediction();
        }

        // Trading functions
        async function previewOrder() {
            const symbol = document.getElementById('tradeSymbol').value;
            const action = document.getElementById('tradeAction').value;
            const qty = document.getElementById('tradeQty').value;
            const orderType = document.getElementById('tradeOrderType').value;
            const limitPrice = document.getElementById('tradeLimitPrice').value;
            const tif = document.getElementById('tradeTIF').value;
            
            if (!symbol || !qty) {
                showMessage('Please fill in all required fields', 'error');
                return;
            }
            
            const orderData = {
                symbol: symbol.toUpperCase(),
                action: action,
                quantity: parseInt(qty),
                orderType: orderType,
                limitPrice: limitPrice ? parseFloat(limitPrice) : null,
                timeInForce: tif
            };
            
            try {
                const headers = {'Content-Type': 'application/json'};
                if (API_KEY) headers['X-API-Key'] = API_KEY;
                
                const response = await fetch(`${API_BASE}/api/order/preview`, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify(orderData)
                });
                
                const data = await response.json();
                
                document.getElementById('orderPreview').innerHTML = `
                    <div style="background: #f3f4f6; padding: 15px; border-radius: 5px;">
                        <h3 style="margin-bottom: 10px;">Order Preview</h3>
                        <p><strong>Symbol:</strong> ${orderData.symbol}</p>
                        <p><strong>Action:</strong> ${orderData.action}</p>
                        <p><strong>Quantity:</strong> ${orderData.quantity}</p>
                        <p><strong>Order Type:</strong> ${orderData.orderType}</p>
                        ${orderData.limitPrice ? `<p><strong>Limit Price:</strong> $${orderData.limitPrice}</p>` : ''}
                        <p><strong>Time in Force:</strong> ${orderData.timeInForce}</p>
                    </div>
                `;
                
                showMessage('Order preview generated', 'success');
            } catch (error) {
                showMessage(`Preview failed: ${error.message}`, 'error');
            }
        }

        async function placeOrder() {
            showMessage('Order placement coming soon - preview first!', 'info');
        }

        // Positions
        async function refreshPositions() {
            showMessage('Position tracking coming soon', 'info');
            // TODO: Implement positions endpoint
        }

        // AI Predictions
        async function getPrediction() {
            const symbol = document.getElementById('aiSymbol').value.trim().toUpperCase();
            
            if (!symbol) {
                showMessage('Please enter a symbol', 'error');
                return;
            }
            
            showMessage(`Getting AI prediction for ${symbol}...`, 'info');
            
            try {
                const response = await fetch(`${API_BASE}/api/ai/predict`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({symbol: symbol})
                });
                
                const data = await response.json();
                
                const predictionDiv = document.getElementById('predictionResult');
                predictionDiv.innerHTML = `
                    <div class="ai-prediction">
                        <h3>${symbol} Prediction</h3>
                        <div class="prediction-value">${data.prob_up ? (data.prob_up * 100).toFixed(1) : 'N/A'}%</div>
                        <p>Probability of upward movement</p>
                        <div class="confidence-bar">
                            <div class="confidence-fill" style="width: ${data.confidence ? data.confidence * 100 : 0}%"></div>
                        </div>
                        <p style="margin-top: 10px; opacity: 0.9;">Confidence: ${data.confidence ? (data.confidence * 100).toFixed(1) : 'N/A'}%</p>
                        <p style="font-size: 12px; opacity: 0.8; margin-top: 10px;">${data.timestamp || new Date().toISOString()}</p>
                    </div>
                `;
                
                showMessage(`Prediction generated for ${symbol}`, 'success');
            } catch (error) {
                showMessage(`Prediction failed: ${error.message}`, 'error');
            }
        }

        // Diagnostics
        async function runDiagnostics() {
            showMessage('Running diagnostics...', 'info');
            
            try {
                const response = await fetch(`${API_BASE}/api/debug/ibkr`);
                const data = await response.json();
                
                const resultDiv = document.getElementById('diagnosticsResult');
                resultDiv.innerHTML = `
                    <div style="background: #f3f4f6; padding: 15px; border-radius: 5px;">
                        <h3>Environment Variables</h3>
                        ${Object.entries(data.environment).map(([key, val]) => `
                            <p><strong>${key}:</strong> ${val.set ? val.value : '<span style="color: #ef4444;">NOT SET</span>'}</p>
                        `).join('')}
                        
                        <h3 style="margin-top: 20px;">Socket Test</h3>
                        <p><strong>Host:</strong> ${data.socket_test.host}</p>
                        <p><strong>Port:</strong> ${data.socket_test.port}</p>
                        <p><strong>Success:</strong> ${data.socket_test.success ? '‚úÖ YES' : '‚ùå NO'}</p>
                        ${data.socket_test.error ? `<p style="color: #ef4444;"><strong>Error:</strong> ${data.socket_test.error}</p>` : ''}
                        
                        <h3 style="margin-top: 20px;">Adapter Status</h3>
                        <p><strong>State:</strong> ${data.adapter_status.state || 'UNKNOWN'}</p>
                        <p><strong>Client ID:</strong> ${data.adapter_status.current_client_id || '-'}</p>
                        ${data.adapter_status.last_error ? `<p style="color: #ef4444;"><strong>Last Error:</strong> ${data.adapter_status.last_error}</p>` : ''}
                        
                        <h3 style="margin-top: 20px;">Troubleshooting Steps</h3>
                        <ol style="margin-left: 20px;">
                            ${data.troubleshooting.map(step => `<li>${step}</li>`).join('')}
                        </ol>
                    </div>
                `;
                
                showMessage('Diagnostics complete', 'success');
            } catch (error) {
                showMessage(`Diagnostics failed: ${error.message}`, 'error');
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadWorklist();
            checkStatus();
            setInterval(checkStatus, 5000); // Check every 5 seconds
            
            addLog('[INFO] Dashboard initialized');
            
            // Prompt for API key if not set
            if (!API_KEY) {
                const key = prompt('Enter your API key (from .env LOCAL_API_KEY):');
                if (key) {
                    localStorage.setItem('ibkr_api_key', key);
                    location.reload();
                }
            }
        });
    </script>
</body>
</html>
