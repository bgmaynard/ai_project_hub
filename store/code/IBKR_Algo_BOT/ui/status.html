<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>AI Bot · Status</title>
<style>
  :root { --ok:#2ecc71; --bad:#e74c3c; --warn:#f39c12; --fg:#222; --muted:#666; --bg:#fafafa; }
  body { font-family: system-ui, Segoe UI, Roboto, sans-serif; background: var(--bg); color: var(--fg); margin:0; }
  .wrap { max-width: 860px; margin: 40px auto; padding: 0 20px; }
  .card { background:#fff; border-radius:16px; box-shadow: 0 6px 22px rgba(0,0,0,.06); padding: 20px; margin: 16px 0; }
  .row { display:flex; gap:12px; align-items:center; flex-wrap: wrap; }
  .pill { padding:6px 10px; border-radius:999px; font-weight:600; }
  .ok{ background: var(--ok); color:#fff;}
  .bad{ background: var(--bad); color:#fff;}
  .warn{ background: var(--warn); color:#fff;}
  .muted{ color: var(--muted); }
  h1 { font-size: 24px; margin: 0 0 8px; }
  h2 { font-size: 16px; margin: 0 0 10px; color: var(--muted); font-weight: 600; letter-spacing: .02em;}
  pre { background: #f4f4f4; padding: 10px; border-radius: 10px; overflow:auto; }
  .grid { display:grid; grid-template-columns: repeat(auto-fit,minmax(220px,1fr)); gap:12px; }
  .kv { background:#fff; border-radius:12px; padding:12px; box-shadow: 0 2px 10px rgba(0,0,0,.04); }
  .k { font-size:12px; color:var(--muted); text-transform:uppercase; letter-spacing:.06em; }
  .v { font-size:16px; margin-top:4px; }
  footer { text-align:center; color: var(--muted); font-size: 12px; padding: 24px 0; }
  a { color: inherit; }
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>AI Bot · Status</h1>
    <div class="row">
      <span id="conn" class="pill">checking…</span>
      <span id="mode" class="pill warn">mode?</span>
      <span id="auth" class="pill warn">auth?</span>
    </div>
    <div class="grid" style="margin-top:12px">
      <div class="kv"><div class="k">Version</div><div class="v" id="version">—</div></div>
      <div class="kv"><div class="k">Host</div><div class="v" id="host">—</div></div>
      <div class="kv"><div class="k">Port</div><div class="v" id="port">—</div></div>
      <div class="kv"><div class="k">TWS</div><div class="v" id="tws">—</div></div>
      <div class="kv"><div class="k">Updated</div><div class="v" id="updated">—</div></div>
    </div>
  </div>

  <div class="card">
    <h2>Raw</h2>
    <pre id="raw">loading…</pre>
  </div>

  <footer>
    <a href="/docs">Open API Docs</a> · <a href="/health">Health JSON</a>
  </footer>
</div>

<script>
const $ = (id)=>document.getElementById(id);
const fmtTs = ts => new Date(ts*1000).toLocaleString();

async function refresh() {
  try {
    const [ping, info] = await Promise.all([
      fetch('/api/tws/ping').then(r=>r.json()),
      fetch('/api/info').then(r=>r.json()),
    ]);

    // Connection pill
    const conn = $('conn');
    if (ping.connected) { conn.className='pill ok'; conn.textContent='TWS: CONNECTED'; }
    else { conn.className='pill bad'; conn.textContent='TWS: DISCONNECTED'; }

    // Mode & Auth pills
    const mode = $('mode');
    mode.className = 'pill ' + (info.features.offlineMode ? 'warn' : 'ok');
    mode.textContent = info.features.offlineMode ? 'OFFLINE' : 'LIVE';

    const auth = $('auth');
    let authText = info.features.ordersRequireApiKey ? 'API KEY REQUIRED' : 'NO API KEY';
    auth.className = 'pill ' + (info.features.ordersRequireApiKey ? 'warn' : 'ok');
    auth.textContent = authText;

    // KV fields
    $('version').textContent = info.version ?? '—';
    $('host').textContent = info.env?.host ?? '—';
    $('port').textContent = info.env?.port ?? '—';
    const tHost = info.env?.tws?.host ?? '—';
    const tPort = info.env?.tws?.port ?? '—';
    const tCid  = info.env?.tws?.clientId ?? '—';
    $('tws').textContent = `${tHost}:${tPort} (clientId ${tCid})`;
    $('updated').textContent = fmtTs(info.ts);

    $('raw').textContent = JSON.stringify({ ping, info }, null, 2);
  } catch (e) {
    $('conn').className='pill bad';
    $('conn').textContent='ERROR';
    $('raw').textContent = String(e);
  }
}
refresh();
setInterval(refresh, 3000);
</script>
</body>
</html>
