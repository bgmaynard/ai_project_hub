# store/code/IBKR_Algo_BOT/dashboard_api.py
import os, asyncio
from fastapi import FastAPI, Request, Header, HTTPException
from fastapi.responses import JSONResponse, RedirectResponse, FileResponse
from fastapi.staticfiles import StaticFiles

# NEW: import adapter
from store.code.IBKR_Algo_BOT.bridge.ib_adapter import IBAdapter, IBConfig


X_API_KEY = os.getenv("LOCAL_API_KEY") or os.getenv("X_API_KEY") or "changeme_strong"
HOST = os.getenv("API_HOST", "127.0.0.1")
PORT = int(os.getenv("API_PORT", "9101"))

TWS_HOST = os.getenv("TWS_HOST", "127.0.0.1")
TWS_PORT = int(os.getenv("TWS_PORT", "7497"))
TWS_CLIENT_ID = int(os.getenv("TWS_CLIENT_ID", "1101"))

app = FastAPI(title="AI Project Hub API", version=os.getenv("VERSION", "dev"))

# Static UI mount
ui_dir = os.path.abspath(os.path.join(os.path.dirname(__file__), "ui"))
app.mount("/ui", StaticFiles(directory=ui_dir), name="ui")

# NEW: global adapter instance
cfg = IBConfig(
    host=TWS_HOST, port=TWS_PORT, client_id=TWS_CLIENT_ID,
    heartbeat_sec=float(os.getenv("IB_HEARTBEAT_SEC", "2.5")),
    backoff_base=float(os.getenv("IB_BACKOFF_BASE", "1.0")),
    backoff_factor=float(os.getenv("IB_BACKOFF_FACTOR", "2.0")),
    backoff_max=float(os.getenv("IB_BACKOFF_MAX", "30.0")),
    jitter_ratio=float(os.getenv("IB_JITTER_RATIO", "0.15")),
    max_fail_streak=int(os.getenv("IB_MAX_FAIL_STREAK", "10")),
)
ib_adapter = IBAdapter(cfg)

# Optional: resubscribe hook for quotes/streams later
async def _resubscribe_all():
    # TODO: re-issue any market data subscriptions here
    return
ib_adapter.set_resubscribe_hook(_resubscribe_all)

# --- Startup / Shutdown -------------------------------------------------------
@app.on_event("startup")
async def _on_startup():
    # kick off watchdog
    await ib_adapter.start()

@app.on_event("shutdown")
async def _on_shutdown():
    await ib_adapter.stop()

# --- Helpers ------------------------------------------------------------------
def require_api_key(api_key: str | None):
    if not X_API_KEY:
        return
    if not api_key or api_key != X_API_KEY:
        raise HTTPException(status_code=401, detail="Invalid or missing X-API-Key")

# --- Routes -------------------------------------------------------------------
@app.get("/")
async def root():
    return RedirectResponse(url="/ui/status.html")

@app.get("/health")
async def health():
    return {"ok": True, "service": "ai-bot-connection", "features": {"orderGuard": True, "watchdog": True}}

@app.get("/api/info")
async def api_info():
    return {
        "version": app.version,
        "statusRoutes": ["/api/status", "/api/tws/ping"],
        "orderGuard": True,
        "host": HOST, "port": PORT
    }

@app.get("/api/status")
async def api_status():
    return {
        "service": "ai-bot-connection",
        "ibkr": ib_adapter.get_status()
    }

@app.get("/api/tws/ping")
async def tws_ping():
    return {"connected": ib_adapter.is_connected(), "state": ib_adapter.state}

# ---- Protected order routes (examples) --------------------------------------
@app.post("/api/order/preview")
async def order_preview(request: Request, x_api_key: str | None = Header(default=None, convert_underscores=False)):
    require_api_key(x_api_key)
    # Ensure we’re connected before preview
    await ib_adapter.ensure_connected()
    # ... existing preview logic ...
    return JSONResponse({"ok": True, "note": "preview stub"})

@app.post("/api/order/buy")
async def order_buy(request: Request, x_api_key: str | None = Header(default=None, convert_underscores=False)):
    require_api_key(x_api_key)
    await ib_adapter.ensure_connected()
    # ... existing buy logic ...
    return JSONResponse({"ok": True, "note": "buy stub"})
