"""AI Stock Prediction Engine"""
import pandas as pd
import numpy as np
from datetime import datetime
from typing import Dict, Any
import yfinance as yf
from sklearn.ensemble import RandomForestClassifier
from sklearn.preprocessing import StandardScaler
import ta

class StockPredictor:
    def __init__(self):
        self.model = RandomForestClassifier(n_estimators=100, max_depth=10, random_state=42)
        self.scaler = StandardScaler()
        self.is_trained = False
        self.feature_names = []
        
    def get_technical_indicators(self, df):
        df['rsi'] = ta.momentum.RSIIndicator(df['Close'], window=14).rsi()
        macd = ta.trend.MACD(df['Close'])
        df['macd'] = macd.macd()
        df['macd_signal'] = macd.macd_signal()
        df['macd_diff'] = macd.macd_diff()
        bollinger = ta.volatility.BollingerBands(df['Close'])
        df['bb_high'] = bollinger.bollinger_hband()
        df['bb_low'] = bollinger.bollinger_lband()
        df['bb_mid'] = bollinger.bollinger_mavg()
        df['bb_width'] = (df['bb_high'] - df['bb_low']) / df['bb_mid']
        df['sma_20'] = ta.trend.SMAIndicator(df['Close'], window=20).sma_indicator()
        df['sma_50'] = ta.trend.SMAIndicator(df['Close'], window=50).sma_indicator()
        df['ema_12'] = ta.trend.EMAIndicator(df['Close'], window=12).ema_indicator()
        df['volume_sma'] = df['Volume'].rolling(window=20).mean()
        df['volume_ratio'] = df['Volume'] / df['volume_sma']
        df['returns'] = df['Close'].pct_change()
        df['returns_5d'] = df['Close'].pct_change(periods=5)
        df['momentum'] = ta.momentum.ROCIndicator(df['Close'], window=10).roc()
        return df
    
    def prepare_features(self, df):
        df = self.get_technical_indicators(df)
        df['target'] = (df['Close'].shift(-1) > df['Close']).astype(int)
        df = df.dropna()
        self.feature_names = ['rsi','macd','macd_signal','macd_diff','bb_width','sma_20','sma_50','ema_12','volume_ratio','returns','returns_5d','momentum']
        return df
    
    def train(self, symbol, period="2y"):
        print(f"Training model for {symbol}...")
        ticker = yf.Ticker(symbol)
        df = ticker.history(period=period)
        if df.empty:
            raise ValueError(f"No data for {symbol}")
        df = self.prepare_features(df)
        X = df[self.feature_names]
        y = df['target']
        X_scaled = self.scaler.fit_transform(X)
        self.model.fit(X_scaled, y)
        self.is_trained = True
        accuracy = self.model.score(X_scaled, y)
        print(f"Training accuracy: {accuracy:.2%}")
        return accuracy
    
    def predict(self, symbol):
        if not self.is_trained:
            self.train(symbol)
        try:
            ticker = yf.Ticker(symbol)
            df = ticker.history(period="3mo")
            if df.empty:
                return {"symbol":symbol,"error":"No data","prob_up":0.5,"confidence":0.0}
            df = self.prepare_features(df)
            latest = df[self.feature_names].iloc[-1:].values
            latest_scaled = self.scaler.transform(latest)
            prediction = self.model.predict(latest_scaled)[0]
            probabilities = self.model.predict_proba(latest_scaled)[0]
            prob_up = probabilities[1] if len(probabilities) > 1 else 0.5
            confidence = max(probabilities)
            current_price = df['Close'].iloc[-1]
            previous_close = df['Close'].iloc[-2] if len(df) > 1 else current_price
            price_change = ((current_price - previous_close) / previous_close) * 100
            rsi = df['rsi'].iloc[-1]
            macd_diff = df['macd_diff'].iloc[-1]
            signal = "BULLISH" if prediction == 1 else "BEARISH"
            if rsi < 30:
                signal_detail = "Oversold - potential bounce"
            elif rsi > 70:
                signal_detail = "Overbought - potential pullback"
            elif macd_diff > 0:
                signal_detail = "Positive momentum"
            else:
                signal_detail = "Negative momentum"
            return {
                "symbol":symbol,"prediction":int(prediction),"prob_up":float(prob_up),
                "prob_down":float(1-prob_up),"confidence":float(confidence),"signal":signal,
                "signal_detail":signal_detail,"current_price":float(current_price),
                "price_change_pct":float(price_change),
                "technical_indicators":{"rsi":float(rsi),"macd_diff":float(macd_diff),"bb_width":float(df['bb_width'].iloc[-1])},
                "timestamp":datetime.utcnow().isoformat()
            }
        except Exception as e:
            return {"symbol":symbol,"error":str(e),"prob_up":0.5,"confidence":0.0}

_predictor = None
def get_predictor():
    global _predictor
    if _predictor is None:
        _predictor = StockPredictor()
    return _predictor
